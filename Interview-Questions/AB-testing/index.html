<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="100+ A/B Testing and Experimentation interview questions for Data Science and Product Analyst roles"><meta name=author content="Kuldeep Singh Sidhu"><link href=https://singhsidhukuldeep.github.io/Interview-Questions/AB-testing/ rel=canonical><link href=../Probability/ rel=prev><link href=../SQL-Interview-Questions/ rel=next><link rel=icon href=https://repository-images.githubusercontent.com/275878203/13719500-bb75-11ea-8f3a-be2ffb87a6a2><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.5.50"><title>A/B Testing Interview Questions - Data Science Interview preparation</title><link rel=stylesheet href=../../assets/stylesheets/main.a40c8224.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../stylesheets/extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-EVGNTG49J7"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-EVGNTG49J7",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-EVGNTG49J7",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script><link href=../../assets/stylesheets/glightbox.min.css rel=stylesheet><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style><script src=../../assets/javascripts/glightbox.min.js></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#ab-testing-interview-questions class=md-skip> Skip to content </a> </div> <div data-md-component=announce> <aside class=md-banner> <div class="md-banner__inner md-grid md-typeset"> <!-- Add announcement here, including arbitrary HTML --> <style>
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
      20%, 40%, 60%, 80% { transform: translateX(2px); }
    }
    @keyframes glow {
      0%, 100% { text-shadow: 0 0 5px rgba(255, 165, 0, 0.5); }
      50% { text-shadow: 0 0 20px rgba(255, 165, 0, 0.8), 0 0 30px rgba(255, 140, 0, 0.6); }
    }
    .shake-text {
      display: inline-block;
      animation: shake 3s ease-in-out infinite;
    }
    .glow-link {
      animation: glow 2s ease-in-out infinite;
      font-weight: bold;
    }
  </style> <span class=shake-text>üöÄ <a href=/flashcards class=glow-link>Flashcards</a> feature is live!</span> <meta name=google-adsense-account content=ca-pub-4988388949365963> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4988388949365963" crossorigin=anonymous></script> </div> </aside> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Data Science Interview preparation" class="md-header__button md-logo" aria-label="Data Science Interview preparation" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 576 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M9.4 86.6c-12.5-12.5-12.5-32.7 0-45.2s32.8-12.5 45.3 0l192 192c12.5 12.5 12.5 32.8 0 45.3l-192 192c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L178.7 256zM256 416h288c17.7 0 32 14.3 32 32s-14.3 32-32 32H256c-17.7 0-32-14.3-32-32s14.3-32 32-32"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Data Science Interview preparation </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> A/B Testing Interview Questions </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media=(prefers-color-scheme) data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=deep-purple data-md-color-accent=purple aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=deep-purple data-md-color-accent=purple aria-label="Switch to system preference" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to system preference" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/singhsidhukuldeep/singhsidhukuldeep.github.io title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> singhsidhukuldeep/singhsidhukuldeep.github.io </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Data Science Interview preparation" class="md-nav__button md-logo" aria-label="Data Science Interview preparation" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 576 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M9.4 86.6c-12.5-12.5-12.5-32.7 0-45.2s32.8-12.5 45.3 0l192 192c12.5 12.5 12.5 32.8 0 45.3l-192 192c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L178.7 256zM256 416h288c17.7 0 32 14.3 32 32s-14.3 32-32 32H256c-17.7 0-32-14.3-32-32s14.3-32 32-32"/></svg> </a> Data Science Interview preparation </label> <div class=md-nav__source> <a href=https://github.com/singhsidhukuldeep/singhsidhukuldeep.github.io title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> singhsidhukuldeep/singhsidhukuldeep.github.io </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> üè° Home </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> üë®üèø‚Äçüè´ Interview Questions </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> üë®üèø‚Äçüè´ Interview Questions </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../flashcards/ class=md-nav__link> <span class=md-ellipsis> üìá Flashcards </span> </a> </li> <li class=md-nav__item> <a href=../data-structures-algorithms/ class=md-nav__link> <span class=md-ellipsis> DSA (Data Structures & Algorithms) </span> </a> </li> <li class=md-nav__item> <a href=../Machine-Learning/ class=md-nav__link> <span class=md-ellipsis> Machine Learning </span> </a> </li> <li class=md-nav__item> <a href=../System-design/ class=md-nav__link> <span class=md-ellipsis> System Design </span> </a> </li> <li class=md-nav__item> <a href=../Natural-Language-Processing/ class=md-nav__link> <span class=md-ellipsis> Natural Language Processing (NLP) </span> </a> </li> <li class=md-nav__item> <a href=../Probability/ class=md-nav__link> <span class=md-ellipsis> Probability </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> A/B Testing </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> A/B Testing </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#premium-interview-questions class=md-nav__link> <span class=md-ellipsis> Premium Interview Questions </span> </a> <nav class=md-nav aria-label="Premium Interview Questions"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#explain-hypothesis-testing-in-ab-tests-google-netflix-interview-question class=md-nav__link> <span class=md-ellipsis> Explain Hypothesis Testing in A/B Tests - Google, Netflix Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-to-calculate-sample-size-google-netflix-interview-question class=md-nav__link> <span class=md-ellipsis> How to Calculate Sample Size? - Google, Netflix Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-statistical-power-google-netflix-interview-question class=md-nav__link> <span class=md-ellipsis> What is Statistical Power? - Google, Netflix Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-srm-sample-ratio-mismatch-microsoft-linkedin-interview-question class=md-nav__link> <span class=md-ellipsis> What is SRM (Sample Ratio Mismatch)? - Microsoft, LinkedIn Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#explain-type-i-and-type-ii-errors-most-tech-companies-interview-question class=md-nav__link> <span class=md-ellipsis> Explain Type I and Type II Errors - Most Tech Companies Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-to-handle-the-peeking-problem-netflix-airbnb-interview-question class=md-nav__link> <span class=md-ellipsis> How to Handle the Peeking Problem? - Netflix, Airbnb Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-cuped-covariate-adjustment-booking-microsoft-meta-interview-question class=md-nav__link> <span class=md-ellipsis> What is CUPED (Covariate Adjustment)? - Booking, Microsoft, Meta Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-are-guardrail-metrics-airbnb-netflix-interview-question class=md-nav__link> <span class=md-ellipsis> What are Guardrail Metrics? - Airbnb, Netflix Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#explain-bayesian-vs-frequentist-ab-testing-netflix-stitch-fix-interview-question class=md-nav__link> <span class=md-ellipsis> Explain Bayesian vs Frequentist A/B Testing - Netflix, Stitch Fix Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-do-you-test-on-a-two-sided-marketplace-with-supplydemand-interference-uber-lyft-interview-question class=md-nav__link> <span class=md-ellipsis> How Do You Test on a Two-Sided Marketplace with Supply/Demand Interference? - Uber, Lyft Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-multi-armed-bandit-mab-netflix-amazon-interview-question class=md-nav__link> <span class=md-ellipsis> What is Multi-Armed Bandit (MAB)? - Netflix, Amazon Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-do-you-handle-network-effects-and-interference-in-ab-tests-meta-linkedin-interview-question class=md-nav__link> <span class=md-ellipsis> How Do You Handle Network Effects and Interference in A/B Tests? - Meta, LinkedIn Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-the-delta-method-google-netflix-interview-question class=md-nav__link> <span class=md-ellipsis> What is the Delta Method? - Google, Netflix Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-do-you-handle-multiple-testing-when-comparing-multiple-variants-or-metrics-google-meta-interview-question class=md-nav__link> <span class=md-ellipsis> How Do You Handle Multiple Testing When Comparing Multiple Variants or Metrics? - Google, Meta Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-aa-testing-why-run-it-microsoft-linkedin-interview-question class=md-nav__link> <span class=md-ellipsis> What is A/A Testing? Why Run It? - Microsoft, LinkedIn Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-to-calculate-confidence-intervals-most-tech-companies-interview-question class=md-nav__link> <span class=md-ellipsis> How to Calculate Confidence Intervals? - Most Tech Companies Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-novelty-effect-and-how-do-you-detect-and-handle-it-meta-instagram-interview-question class=md-nav__link> <span class=md-ellipsis> What is Novelty Effect and How Do You Detect and Handle It? - Meta, Instagram Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-to-choose-primary-metrics-product-companies-interview-question class=md-nav__link> <span class=md-ellipsis> How to Choose Primary Metrics? - Product Companies Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-attrition-bias-uber-lyft-interview-question class=md-nav__link> <span class=md-ellipsis> What is Attrition Bias? - Uber, Lyft Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-to-analyze-long-term-effects-netflix-spotify-interview-question class=md-nav__link> <span class=md-ellipsis> How to Analyze Long-Term Effects? - Netflix, Spotify Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-to-handle-low-traffic-experiments-startups-interview-question class=md-nav__link> <span class=md-ellipsis> How to Handle Low-Traffic Experiments? - Startups Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-heterogeneous-treatment-effects-hte-and-how-do-you-detect-them-google-meta-interview-question class=md-nav__link> <span class=md-ellipsis> What is Heterogeneous Treatment Effects (HTE) and How Do You Detect Them? - Google, Meta Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-bootstrap-for-ab-testing-google-netflix-interview-question class=md-nav__link> <span class=md-ellipsis> What is Bootstrap for A/B Testing? - Google, Netflix Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-to-test-revenue-metrics-e-commerce-interview-question class=md-nav__link> <span class=md-ellipsis> How to Test Revenue Metrics? - E-commerce Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-regression-to-the-mean-all-companies-interview-question class=md-nav__link> <span class=md-ellipsis> What is Regression to the Mean? - All Companies Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-to-handle-multiple-metrics-netflix-airbnb-interview-question class=md-nav__link> <span class=md-ellipsis> How to Handle Multiple Metrics? - Netflix, Airbnb Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-simpsons-paradox-google-meta-interview-question class=md-nav__link> <span class=md-ellipsis> What is Simpson's Paradox? - Google, Meta Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-to-run-tests-with-ratio-metrics-most-tech-companies-interview-question class=md-nav__link> <span class=md-ellipsis> How to Run Tests with Ratio Metrics? - Most Tech Companies Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-sensitivity-analysis-netflix-uber-interview-question class=md-nav__link> <span class=md-ellipsis> What is Sensitivity Analysis? - Netflix, Uber Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-to-communicate-results-to-stakeholders-all-companies-interview-question class=md-nav__link> <span class=md-ellipsis> How to Communicate Results to Stakeholders? - All Companies Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-the-minimum-detectable-effect-mde-netflix-uber-interview-question class=md-nav__link> <span class=md-ellipsis> What is the Minimum Detectable Effect (MDE)? - Netflix, Uber Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-to-design-an-experimentation-platform-senior-roles-interview-question class=md-nav__link> <span class=md-ellipsis> How to Design an Experimentation Platform? - Senior Roles Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-stratified-randomization-netflix-uber-interview-question class=md-nav__link> <span class=md-ellipsis> What is Stratified Randomization? - Netflix, Uber Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-to-use-regression-adjustment-google-meta-interview-question class=md-nav__link> <span class=md-ellipsis> How to Use Regression Adjustment? - Google, Meta Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-triggered-analysis-uber-lyft-interview-question class=md-nav__link> <span class=md-ellipsis> What is Triggered Analysis? - Uber, Lyft Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-to-handle-carry-over-effects-netflix-airbnb-interview-question class=md-nav__link> <span class=md-ellipsis> How to Handle Carry-Over Effects? - Netflix, Airbnb Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-intent-to-treat-itt-analysis-and-how-do-you-handle-non-compliance-netflix-google-interview-question class=md-nav__link> <span class=md-ellipsis> What is Intent-to-Treat (ITT) Analysis and How Do You Handle Non-Compliance? - Netflix, Google Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-do-you-estimate-lift-and-its-confidence-interval-for-different-metrics-amazon-shopify-interview-question class=md-nav__link> <span class=md-ellipsis> How Do You Estimate Lift and Its Confidence Interval for Different Metrics? - Amazon, Shopify Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-pre-registration-and-how-does-it-prevent-p-hacking-netflix-microsoft-interview-question class=md-nav__link> <span class=md-ellipsis> What is Pre-Registration and How Does It Prevent P-Hacking? - Netflix, Microsoft Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-do-you-handle-seasonality-and-time-based-confounding-in-ab-tests-amazon-etsy-interview-question class=md-nav__link> <span class=md-ellipsis> How Do You Handle Seasonality and Time-Based Confounding in A/B Tests? - Amazon, Etsy Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-a-holdout-group-and-how-do-you-use-it-for-long-term-monitoring-netflix-meta-interview-question class=md-nav__link> <span class=md-ellipsis> What is a Holdout Group and How Do You Use It for Long-Term Monitoring? - Netflix, Meta Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-do-you-test-personalization-algorithms-in-ab-tests-netflix-spotify-interview-question class=md-nav__link> <span class=md-ellipsis> How Do You Test Personalization Algorithms in A/B Tests? - Netflix, Spotify Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-sequential-testing-and-how-does-it-enable-early-stopping-netflix-uber-interview-question class=md-nav__link> <span class=md-ellipsis> What is Sequential Testing and How Does It Enable Early Stopping? - Netflix, Uber Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-do-you-report-and-interpret-negative-null-results-in-ab-tests-all-companies-interview-question class=md-nav__link> <span class=md-ellipsis> How Do You Report and Interpret Negative (Null) Results in A/B Tests? - All Companies Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-variance-reduction-and-how-do-you-apply-cuped-and-other-techniques-netflix-meta-interview-question class=md-nav__link> <span class=md-ellipsis> What is Variance Reduction and How Do You Apply CUPED and Other Techniques? - Netflix, Meta Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-do-you-handle-feature-interactions-when-running-multiple-experiments-netflix-airbnb-interview-question class=md-nav__link> <span class=md-ellipsis> How Do You Handle Feature Interactions When Running Multiple Experiments? - Netflix, Airbnb Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-a-ramp-up-gradual-rollout-strategy-and-when-should-you-use-it-all-companies-interview-question class=md-nav__link> <span class=md-ellipsis> What is a Ramp-Up (Gradual Rollout) Strategy and When Should You Use It? - All Companies Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-do-you-calculate-expected-revenue-impact-from-an-ab-test-e-commerce-interview-question class=md-nav__link> <span class=md-ellipsis> How Do You Calculate Expected Revenue Impact from an A/B Test? - E-commerce Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-propensity-score-matching-psm-and-when-should-you-use-it-google-netflix-interview-question class=md-nav__link> <span class=md-ellipsis> What is Propensity Score Matching (PSM) and When Should You Use It? - Google, Netflix Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-difference-in-differences-did-and-when-should-you-use-it-google-uber-interview-question class=md-nav__link> <span class=md-ellipsis> What is Difference-in-Differences (DiD) and When Should You Use It? - Google, Uber Interview Question </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#quick-reference-100-ab-testing-questions class=md-nav__link> <span class=md-ellipsis> Quick Reference: 100+ A/B Testing Questions </span> </a> </li> <li class=md-nav__item> <a href=#code-examples class=md-nav__link> <span class=md-ellipsis> Code Examples </span> </a> <nav class=md-nav aria-label="Code Examples"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-power-analysis-and-sample-size-python class=md-nav__link> <span class=md-ellipsis> 1. Power Analysis and Sample Size (Python) </span> </a> </li> <li class=md-nav__item> <a href=#2-bayesian-ab-test-beta-binomial class=md-nav__link> <span class=md-ellipsis> 2. Bayesian A/B Test (Beta-Binomial) </span> </a> </li> <li class=md-nav__item> <a href=#3-bootstrap-confidence-interval class=md-nav__link> <span class=md-ellipsis> 3. Bootstrap Confidence Interval </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#questions-asked-in-google-interview class=md-nav__link> <span class=md-ellipsis> Questions asked in Google interview </span> </a> </li> <li class=md-nav__item> <a href=#questions-asked-in-meta-facebook-interview class=md-nav__link> <span class=md-ellipsis> Questions asked in Meta (Facebook) interview </span> </a> </li> <li class=md-nav__item> <a href=#questions-asked-in-netflix-interview class=md-nav__link> <span class=md-ellipsis> Questions asked in Netflix interview </span> </a> </li> <li class=md-nav__item> <a href=#questions-asked-in-uberlyft-interview-marketplace class=md-nav__link> <span class=md-ellipsis> Questions asked in Uber/Lyft interview (Marketplace) </span> </a> </li> <li class=md-nav__item> <a href=#additional-resources class=md-nav__link> <span class=md-ellipsis> Additional Resources </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../SQL-Interview-Questions/ class=md-nav__link> <span class=md-ellipsis> SQL </span> </a> </li> <li class=md-nav__item> <a href=../Python/ class=md-nav__link> <span class=md-ellipsis> Python </span> </a> </li> <li class=md-nav__item> <a href=../Pandas/ class=md-nav__link> <span class=md-ellipsis> Pandas </span> </a> </li> <li class=md-nav__item> <a href=../NumPy/ class=md-nav__link> <span class=md-ellipsis> NumPy </span> </a> </li> <li class=md-nav__item> <a href=../Scikit-Learn/ class=md-nav__link> <span class=md-ellipsis> Scikit-Learn </span> </a> </li> <li class=md-nav__item> <a href=../LangChain/ class=md-nav__link> <span class=md-ellipsis> LangChain </span> </a> </li> <li class=md-nav__item> <a href=../LangGraph/ class=md-nav__link> <span class=md-ellipsis> LangGraph </span> </a> </li> <li class=md-nav__item> <a href=../Interview-Question-Resources/ class=md-nav__link> <span class=md-ellipsis> Interview Question Resources </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> üìù Cheat Sheets </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> üìù Cheat Sheets </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Cheat-Sheets/Django/ class=md-nav__link> <span class=md-ellipsis> Django </span> </a> </li> <li class=md-nav__item> <a href=../../Cheat-Sheets/Flask/ class=md-nav__link> <span class=md-ellipsis> Flask </span> </a> </li> <li class=md-nav__item> <a href=../../Cheat-Sheets/Hypothesis-Tests/ class=md-nav__link> <span class=md-ellipsis> Hypothesis Tests </span> </a> </li> <li class=md-nav__item> <a href=../../Cheat-Sheets/Keras/ class=md-nav__link> <span class=md-ellipsis> Keras </span> </a> </li> <li class=md-nav__item> <a href=../../Cheat-Sheets/LangChain-LangGraph/ class=md-nav__link> <span class=md-ellipsis> LangChain & LangGraph </span> </a> </li> <li class=md-nav__item> <a href=../../Cheat-Sheets/NumPy/ class=md-nav__link> <span class=md-ellipsis> NumPy </span> </a> </li> <li class=md-nav__item> <a href=../../Cheat-Sheets/Pandas/ class=md-nav__link> <span class=md-ellipsis> Pandas </span> </a> </li> <li class=md-nav__item> <a href=../../Cheat-Sheets/PySpark/ class=md-nav__link> <span class=md-ellipsis> PySpark </span> </a> </li> <li class=md-nav__item> <a href=../../Cheat-Sheets/PyTorch/ class=md-nav__link> <span class=md-ellipsis> PyTorch </span> </a> </li> <li class=md-nav__item> <a href=../../Cheat-Sheets/Python/ class=md-nav__link> <span class=md-ellipsis> Python </span> </a> </li> <li class=md-nav__item> <a href=../../Cheat-Sheets/RegEx/ class=md-nav__link> <span class=md-ellipsis> Regular Expressions (RegEx) </span> </a> </li> <li class=md-nav__item> <a href=../../Cheat-Sheets/Sk-learn/ class=md-nav__link> <span class=md-ellipsis> Scikit Learn </span> </a> </li> <li class=md-nav__item> <a href=../../Cheat-Sheets/SQL/ class=md-nav__link> <span class=md-ellipsis> SQL </span> </a> </li> <li class=md-nav__item> <a href=../../Cheat-Sheets/tensorflow/ class=md-nav__link> <span class=md-ellipsis> TensorFlow </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> ‚Äçüéì ML Topics </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> ‚Äçüéì ML Topics </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Machine-Learning/ARIMA/ class=md-nav__link> <span class=md-ellipsis> ARIMA </span> </a> </li> <li class=md-nav__item> <a href=../../Machine-Learning/Activation%20functions/ class=md-nav__link> <span class=md-ellipsis> Activation functions </span> </a> </li> <li class=md-nav__item> <a href=../../Machine-Learning/Collaborative%20Filtering/ class=md-nav__link> <span class=md-ellipsis> Collaborative Filtering </span> </a> </li> <li class=md-nav__item> <a href=../../Machine-Learning/Confusion%20Matrix/ class=md-nav__link> <span class=md-ellipsis> Confusion Matrix </span> </a> </li> <li class=md-nav__item> <a href=../../Machine-Learning/DBSCAN/ class=md-nav__link> <span class=md-ellipsis> DBSCAN </span> </a> </li> <li class=md-nav__item> <a href=../../Machine-Learning/Decision%20Trees/ class=md-nav__link> <span class=md-ellipsis> Decision Trees </span> </a> </li> <li class=md-nav__item> <a href=../../Machine-Learning/Gradient%20Boosting/ class=md-nav__link> <span class=md-ellipsis> Gradient Boosting </span> </a> </li> <li class=md-nav__item> <a href=../../Machine-Learning/K-means%20clustering/ class=md-nav__link> <span class=md-ellipsis> K-means clustering </span> </a> </li> <li class=md-nav__item> <a href=../../Machine-Learning/Linear%20Regression/ class=md-nav__link> <span class=md-ellipsis> Linear Regression </span> </a> </li> <li class=md-nav__item> <a href=../../Machine-Learning/Logistic%20Regression/ class=md-nav__link> <span class=md-ellipsis> Logistic Regression </span> </a> </li> <li class=md-nav__item> <a href=../../Machine-Learning/Loss%20Function%20MAE%2C%20RMSE/ class=md-nav__link> <span class=md-ellipsis> Loss Function MAE, RMSE </span> </a> </li> <li class=md-nav__item> <a href=../../Machine-Learning/Neural%20Networks/ class=md-nav__link> <span class=md-ellipsis> Neural Networks </span> </a> </li> <li class=md-nav__item> <a href=../../Machine-Learning/Normal%20Distribution/ class=md-nav__link> <span class=md-ellipsis> Normal Distribution </span> </a> </li> <li class=md-nav__item> <a href=../../Machine-Learning/Normalization%20Regularisation/ class=md-nav__link> <span class=md-ellipsis> Normalization Regularisation </span> </a> </li> <li class=md-nav__item> <a href=../../Machine-Learning/Overfitting%2C%20Underfitting/ class=md-nav__link> <span class=md-ellipsis> Overfitting, Underfitting </span> </a> </li> <li class=md-nav__item> <a href=../../Machine-Learning/PCA/ class=md-nav__link> <span class=md-ellipsis> PCA </span> </a> </li> <li class=md-nav__item> <a href=../../Machine-Learning/Random%20Forest/ class=md-nav__link> <span class=md-ellipsis> Random Forest </span> </a> </li> <li class=md-nav__item> <a href=../../Machine-Learning/Support%20Vector%20Machines/ class=md-nav__link> <span class=md-ellipsis> Support Vector Machines </span> </a> </li> <li class=md-nav__item> <a href=../../Machine-Learning/Unbalanced%2C%20Skewed%20data/ class=md-nav__link> <span class=md-ellipsis> Unbalanced, Skewed data </span> </a> </li> <li class=md-nav__item> <a href=../../Machine-Learning/kNN/ class=md-nav__link> <span class=md-ellipsis> kNN </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> üë®üèæ‚Äçüíª Online Resources </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> üë®üèæ‚Äçüíª Online Resources </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Online-Material/Online-Material-for-Learning/ class=md-nav__link> <span class=md-ellipsis> Online Study Material </span> </a> </li> <li class=md-nav__item> <a href=../../Online-Material/popular-resources/ class=md-nav__link> <span class=md-ellipsis> Popular Blogs </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=https://onlinetoolsvault.com class=md-nav__link> <span class=md-ellipsis> üõ†Ô∏è Free Tools </span> </a> </li> <li class=md-nav__item> <a href=../../Contribute/ class=md-nav__link> <span class=md-ellipsis> ü§ù Contribute </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#premium-interview-questions class=md-nav__link> <span class=md-ellipsis> Premium Interview Questions </span> </a> <nav class=md-nav aria-label="Premium Interview Questions"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#explain-hypothesis-testing-in-ab-tests-google-netflix-interview-question class=md-nav__link> <span class=md-ellipsis> Explain Hypothesis Testing in A/B Tests - Google, Netflix Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-to-calculate-sample-size-google-netflix-interview-question class=md-nav__link> <span class=md-ellipsis> How to Calculate Sample Size? - Google, Netflix Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-statistical-power-google-netflix-interview-question class=md-nav__link> <span class=md-ellipsis> What is Statistical Power? - Google, Netflix Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-srm-sample-ratio-mismatch-microsoft-linkedin-interview-question class=md-nav__link> <span class=md-ellipsis> What is SRM (Sample Ratio Mismatch)? - Microsoft, LinkedIn Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#explain-type-i-and-type-ii-errors-most-tech-companies-interview-question class=md-nav__link> <span class=md-ellipsis> Explain Type I and Type II Errors - Most Tech Companies Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-to-handle-the-peeking-problem-netflix-airbnb-interview-question class=md-nav__link> <span class=md-ellipsis> How to Handle the Peeking Problem? - Netflix, Airbnb Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-cuped-covariate-adjustment-booking-microsoft-meta-interview-question class=md-nav__link> <span class=md-ellipsis> What is CUPED (Covariate Adjustment)? - Booking, Microsoft, Meta Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-are-guardrail-metrics-airbnb-netflix-interview-question class=md-nav__link> <span class=md-ellipsis> What are Guardrail Metrics? - Airbnb, Netflix Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#explain-bayesian-vs-frequentist-ab-testing-netflix-stitch-fix-interview-question class=md-nav__link> <span class=md-ellipsis> Explain Bayesian vs Frequentist A/B Testing - Netflix, Stitch Fix Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-do-you-test-on-a-two-sided-marketplace-with-supplydemand-interference-uber-lyft-interview-question class=md-nav__link> <span class=md-ellipsis> How Do You Test on a Two-Sided Marketplace with Supply/Demand Interference? - Uber, Lyft Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-multi-armed-bandit-mab-netflix-amazon-interview-question class=md-nav__link> <span class=md-ellipsis> What is Multi-Armed Bandit (MAB)? - Netflix, Amazon Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-do-you-handle-network-effects-and-interference-in-ab-tests-meta-linkedin-interview-question class=md-nav__link> <span class=md-ellipsis> How Do You Handle Network Effects and Interference in A/B Tests? - Meta, LinkedIn Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-the-delta-method-google-netflix-interview-question class=md-nav__link> <span class=md-ellipsis> What is the Delta Method? - Google, Netflix Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-do-you-handle-multiple-testing-when-comparing-multiple-variants-or-metrics-google-meta-interview-question class=md-nav__link> <span class=md-ellipsis> How Do You Handle Multiple Testing When Comparing Multiple Variants or Metrics? - Google, Meta Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-aa-testing-why-run-it-microsoft-linkedin-interview-question class=md-nav__link> <span class=md-ellipsis> What is A/A Testing? Why Run It? - Microsoft, LinkedIn Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-to-calculate-confidence-intervals-most-tech-companies-interview-question class=md-nav__link> <span class=md-ellipsis> How to Calculate Confidence Intervals? - Most Tech Companies Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-novelty-effect-and-how-do-you-detect-and-handle-it-meta-instagram-interview-question class=md-nav__link> <span class=md-ellipsis> What is Novelty Effect and How Do You Detect and Handle It? - Meta, Instagram Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-to-choose-primary-metrics-product-companies-interview-question class=md-nav__link> <span class=md-ellipsis> How to Choose Primary Metrics? - Product Companies Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-attrition-bias-uber-lyft-interview-question class=md-nav__link> <span class=md-ellipsis> What is Attrition Bias? - Uber, Lyft Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-to-analyze-long-term-effects-netflix-spotify-interview-question class=md-nav__link> <span class=md-ellipsis> How to Analyze Long-Term Effects? - Netflix, Spotify Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-to-handle-low-traffic-experiments-startups-interview-question class=md-nav__link> <span class=md-ellipsis> How to Handle Low-Traffic Experiments? - Startups Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-heterogeneous-treatment-effects-hte-and-how-do-you-detect-them-google-meta-interview-question class=md-nav__link> <span class=md-ellipsis> What is Heterogeneous Treatment Effects (HTE) and How Do You Detect Them? - Google, Meta Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-bootstrap-for-ab-testing-google-netflix-interview-question class=md-nav__link> <span class=md-ellipsis> What is Bootstrap for A/B Testing? - Google, Netflix Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-to-test-revenue-metrics-e-commerce-interview-question class=md-nav__link> <span class=md-ellipsis> How to Test Revenue Metrics? - E-commerce Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-regression-to-the-mean-all-companies-interview-question class=md-nav__link> <span class=md-ellipsis> What is Regression to the Mean? - All Companies Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-to-handle-multiple-metrics-netflix-airbnb-interview-question class=md-nav__link> <span class=md-ellipsis> How to Handle Multiple Metrics? - Netflix, Airbnb Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-simpsons-paradox-google-meta-interview-question class=md-nav__link> <span class=md-ellipsis> What is Simpson's Paradox? - Google, Meta Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-to-run-tests-with-ratio-metrics-most-tech-companies-interview-question class=md-nav__link> <span class=md-ellipsis> How to Run Tests with Ratio Metrics? - Most Tech Companies Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-sensitivity-analysis-netflix-uber-interview-question class=md-nav__link> <span class=md-ellipsis> What is Sensitivity Analysis? - Netflix, Uber Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-to-communicate-results-to-stakeholders-all-companies-interview-question class=md-nav__link> <span class=md-ellipsis> How to Communicate Results to Stakeholders? - All Companies Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-the-minimum-detectable-effect-mde-netflix-uber-interview-question class=md-nav__link> <span class=md-ellipsis> What is the Minimum Detectable Effect (MDE)? - Netflix, Uber Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-to-design-an-experimentation-platform-senior-roles-interview-question class=md-nav__link> <span class=md-ellipsis> How to Design an Experimentation Platform? - Senior Roles Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-stratified-randomization-netflix-uber-interview-question class=md-nav__link> <span class=md-ellipsis> What is Stratified Randomization? - Netflix, Uber Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-to-use-regression-adjustment-google-meta-interview-question class=md-nav__link> <span class=md-ellipsis> How to Use Regression Adjustment? - Google, Meta Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-triggered-analysis-uber-lyft-interview-question class=md-nav__link> <span class=md-ellipsis> What is Triggered Analysis? - Uber, Lyft Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-to-handle-carry-over-effects-netflix-airbnb-interview-question class=md-nav__link> <span class=md-ellipsis> How to Handle Carry-Over Effects? - Netflix, Airbnb Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-intent-to-treat-itt-analysis-and-how-do-you-handle-non-compliance-netflix-google-interview-question class=md-nav__link> <span class=md-ellipsis> What is Intent-to-Treat (ITT) Analysis and How Do You Handle Non-Compliance? - Netflix, Google Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-do-you-estimate-lift-and-its-confidence-interval-for-different-metrics-amazon-shopify-interview-question class=md-nav__link> <span class=md-ellipsis> How Do You Estimate Lift and Its Confidence Interval for Different Metrics? - Amazon, Shopify Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-pre-registration-and-how-does-it-prevent-p-hacking-netflix-microsoft-interview-question class=md-nav__link> <span class=md-ellipsis> What is Pre-Registration and How Does It Prevent P-Hacking? - Netflix, Microsoft Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-do-you-handle-seasonality-and-time-based-confounding-in-ab-tests-amazon-etsy-interview-question class=md-nav__link> <span class=md-ellipsis> How Do You Handle Seasonality and Time-Based Confounding in A/B Tests? - Amazon, Etsy Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-a-holdout-group-and-how-do-you-use-it-for-long-term-monitoring-netflix-meta-interview-question class=md-nav__link> <span class=md-ellipsis> What is a Holdout Group and How Do You Use It for Long-Term Monitoring? - Netflix, Meta Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-do-you-test-personalization-algorithms-in-ab-tests-netflix-spotify-interview-question class=md-nav__link> <span class=md-ellipsis> How Do You Test Personalization Algorithms in A/B Tests? - Netflix, Spotify Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-sequential-testing-and-how-does-it-enable-early-stopping-netflix-uber-interview-question class=md-nav__link> <span class=md-ellipsis> What is Sequential Testing and How Does It Enable Early Stopping? - Netflix, Uber Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-do-you-report-and-interpret-negative-null-results-in-ab-tests-all-companies-interview-question class=md-nav__link> <span class=md-ellipsis> How Do You Report and Interpret Negative (Null) Results in A/B Tests? - All Companies Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-variance-reduction-and-how-do-you-apply-cuped-and-other-techniques-netflix-meta-interview-question class=md-nav__link> <span class=md-ellipsis> What is Variance Reduction and How Do You Apply CUPED and Other Techniques? - Netflix, Meta Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-do-you-handle-feature-interactions-when-running-multiple-experiments-netflix-airbnb-interview-question class=md-nav__link> <span class=md-ellipsis> How Do You Handle Feature Interactions When Running Multiple Experiments? - Netflix, Airbnb Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-a-ramp-up-gradual-rollout-strategy-and-when-should-you-use-it-all-companies-interview-question class=md-nav__link> <span class=md-ellipsis> What is a Ramp-Up (Gradual Rollout) Strategy and When Should You Use It? - All Companies Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#how-do-you-calculate-expected-revenue-impact-from-an-ab-test-e-commerce-interview-question class=md-nav__link> <span class=md-ellipsis> How Do You Calculate Expected Revenue Impact from an A/B Test? - E-commerce Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-propensity-score-matching-psm-and-when-should-you-use-it-google-netflix-interview-question class=md-nav__link> <span class=md-ellipsis> What is Propensity Score Matching (PSM) and When Should You Use It? - Google, Netflix Interview Question </span> </a> </li> <li class=md-nav__item> <a href=#what-is-difference-in-differences-did-and-when-should-you-use-it-google-uber-interview-question class=md-nav__link> <span class=md-ellipsis> What is Difference-in-Differences (DiD) and When Should You Use It? - Google, Uber Interview Question </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#quick-reference-100-ab-testing-questions class=md-nav__link> <span class=md-ellipsis> Quick Reference: 100+ A/B Testing Questions </span> </a> </li> <li class=md-nav__item> <a href=#code-examples class=md-nav__link> <span class=md-ellipsis> Code Examples </span> </a> <nav class=md-nav aria-label="Code Examples"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-power-analysis-and-sample-size-python class=md-nav__link> <span class=md-ellipsis> 1. Power Analysis and Sample Size (Python) </span> </a> </li> <li class=md-nav__item> <a href=#2-bayesian-ab-test-beta-binomial class=md-nav__link> <span class=md-ellipsis> 2. Bayesian A/B Test (Beta-Binomial) </span> </a> </li> <li class=md-nav__item> <a href=#3-bootstrap-confidence-interval class=md-nav__link> <span class=md-ellipsis> 3. Bootstrap Confidence Interval </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#questions-asked-in-google-interview class=md-nav__link> <span class=md-ellipsis> Questions asked in Google interview </span> </a> </li> <li class=md-nav__item> <a href=#questions-asked-in-meta-facebook-interview class=md-nav__link> <span class=md-ellipsis> Questions asked in Meta (Facebook) interview </span> </a> </li> <li class=md-nav__item> <a href=#questions-asked-in-netflix-interview class=md-nav__link> <span class=md-ellipsis> Questions asked in Netflix interview </span> </a> </li> <li class=md-nav__item> <a href=#questions-asked-in-uberlyft-interview-marketplace class=md-nav__link> <span class=md-ellipsis> Questions asked in Uber/Lyft interview (Marketplace) </span> </a> </li> <li class=md-nav__item> <a href=#additional-resources class=md-nav__link> <span class=md-ellipsis> Additional Resources </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/singhsidhukuldeep/singhsidhukuldeep.github.io/edit/master/docs/Interview-Questions/AB-testing.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg> </a> <a href=https://github.com/singhsidhukuldeep/singhsidhukuldeep.github.io/raw/master/docs/Interview-Questions/AB-testing.md title="View source of this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg> </a> <h1 id=ab-testing-interview-questions>A/B Testing Interview Questions</h1> <!-- [TOC] --> <p>This document provides a curated list of A/B Testing and Experimentation interview questions. It covers statistical foundations, experimental design, metric selection, and advanced topics like interference (network effects) and sequential testing. Critical for roles at data-driven companies like Netflix, Airbnb, and Uber.</p> <hr> <h2 id=premium-interview-questions>Premium Interview Questions</h2> <h3 id=explain-hypothesis-testing-in-ab-tests-google-netflix-interview-question>Explain Hypothesis Testing in A/B Tests - Google, Netflix Interview Question</h3> <p><strong>Difficulty:</strong> üü° Medium | <strong>Tags:</strong> <code>Statistics</code>, <code>Fundamentals</code> | <strong>Asked by:</strong> Google, Netflix, Meta, Airbnb</p> <details class=success> <summary>View Answer</summary> <p><strong>Hypothesis testing</strong> is the <strong>statistical foundation</strong> of A/B testing, determining whether observed differences between control and treatment are <strong>statistically significant</strong> or due to random chance. It frames experiments as <strong>binary decisions</strong> (ship or don't ship) with controlled error rates (Type I/II errors).</p> <p><strong>Core Concepts:</strong></p> <ul> <li><strong>Null Hypothesis (<span class=arithmatex>\(H_0\)</span>):</strong> No difference between control and treatment (<span class=arithmatex>\(\mu_T = \mu_C\)</span>)</li> <li><strong>Alternative Hypothesis (<span class=arithmatex>\(H_1\)</span>):</strong> There is a difference (<span class=arithmatex>\(\mu_T \neq \mu_C\)</span> for two-sided, <span class=arithmatex>\(\mu_T &gt; \mu_C\)</span> for one-sided)</li> <li><strong>p-value:</strong> Probability of observing data at least as extreme if <span class=arithmatex>\(H_0\)</span> is true</li> <li><strong>Significance level (Œ±):</strong> Threshold for rejecting <span class=arithmatex>\(H_0\)</span> (typically 0.05 = 5% false positive rate)</li> </ul> <p><strong>Test Statistics:</strong></p> <div class=arithmatex>\[z = \frac{\bar{x}_T - \bar{x}_C}{\sqrt{\frac{s_T^2}{n_T} + \frac{s_C^2}{n_C}}}\]</div> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>from</span><span class=w> </span><span class=nn>statsmodels.stats.proportion</span><span class=w> </span><span class=kn>import</span> <span class=n>proportions_ztest</span>
<span class=kn>from</span><span class=w> </span><span class=nn>statsmodels.stats.weightstats</span><span class=w> </span><span class=kn>import</span> <span class=n>ttest_ind</span> <span class=k>as</span> <span class=n>welch_ttest</span>
<span class=kn>import</span><span class=w> </span><span class=nn>matplotlib.pyplot</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>plt</span>

<span class=c1># Production: Comprehensive Hypothesis Testing Pipeline for A/B Tests</span>

<span class=c1># ===== 1. Generate realistic A/B test data =====</span>
<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>

<span class=c1># Example 1: Conversion rate test (proportions)</span>
<span class=n>n_control</span> <span class=o>=</span> <span class=mi>10000</span>
<span class=n>n_treatment</span> <span class=o>=</span> <span class=mi>10000</span>
<span class=n>baseline_cvr</span> <span class=o>=</span> <span class=mf>0.10</span>  <span class=c1># 10% baseline conversion</span>
<span class=n>treatment_lift</span> <span class=o>=</span> <span class=mf>0.02</span>  <span class=c1># +2pp absolute lift (20% relative)</span>

<span class=n>control_conversions</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=n>n_control</span><span class=p>,</span> <span class=n>baseline_cvr</span><span class=p>)</span>
<span class=n>treatment_conversions</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=n>n_treatment</span><span class=p>,</span> <span class=n>baseline_cvr</span> <span class=o>+</span> <span class=n>treatment_lift</span><span class=p>)</span>

<span class=n>control_cvr</span> <span class=o>=</span> <span class=n>control_conversions</span> <span class=o>/</span> <span class=n>n_control</span>
<span class=n>treatment_cvr</span> <span class=o>=</span> <span class=n>treatment_conversions</span> <span class=o>/</span> <span class=n>n_treatment</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== Conversion Rate Test (Proportions) =====&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Control: </span><span class=si>{</span><span class=n>control_conversions</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>n_control</span><span class=si>}</span><span class=s2> = </span><span class=si>{</span><span class=n>control_cvr</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Treatment: </span><span class=si>{</span><span class=n>treatment_conversions</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>n_treatment</span><span class=si>}</span><span class=s2> = </span><span class=si>{</span><span class=n>treatment_cvr</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Absolute lift: </span><span class=si>{</span><span class=p>(</span><span class=n>treatment_cvr</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>control_cvr</span><span class=p>)</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Relative lift: </span><span class=si>{</span><span class=mi>100</span><span class=o>*</span><span class=p>(</span><span class=n>treatment_cvr</span><span class=o>/</span><span class=n>control_cvr</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># ===== 2. Z-test for proportions (most common in A/B testing) =====</span>
<span class=c1># Use when: Large samples (n*p &gt; 5 and n*(1-p) &gt; 5), binary outcome</span>

<span class=n>counts</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=n>treatment_conversions</span><span class=p>,</span> <span class=n>control_conversions</span><span class=p>])</span>
<span class=n>nobs</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=n>n_treatment</span><span class=p>,</span> <span class=n>n_control</span><span class=p>])</span>

<span class=n>z_stat</span><span class=p>,</span> <span class=n>p_value_two_sided</span> <span class=o>=</span> <span class=n>proportions_ztest</span><span class=p>(</span><span class=n>counts</span><span class=p>,</span> <span class=n>nobs</span><span class=p>,</span> <span class=n>alternative</span><span class=o>=</span><span class=s1>&#39;two-sided&#39;</span><span class=p>)</span>
<span class=n>_</span><span class=p>,</span> <span class=n>p_value_one_sided</span> <span class=o>=</span> <span class=n>proportions_ztest</span><span class=p>(</span><span class=n>counts</span><span class=p>,</span> <span class=n>nobs</span><span class=p>,</span> <span class=n>alternative</span><span class=o>=</span><span class=s1>&#39;larger&#39;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;--- Z-test for Proportions ---&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Z-statistic: </span><span class=si>{</span><span class=n>z_stat</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;p-value (two-sided): </span><span class=si>{</span><span class=n>p_value_two_sided</span><span class=si>:</span><span class=s2>.6f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;p-value (one-sided): </span><span class=si>{</span><span class=n>p_value_one_sided</span><span class=si>:</span><span class=s2>.6f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Result: </span><span class=si>{</span><span class=s1>&#39;REJECT H0 (significant)&#39;</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>p_value_two_sided</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mf>0.05</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=s1>&#39;FAIL TO REJECT H0&#39;</span><span class=si>}</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># ===== 3. Example 2: Revenue per user (continuous metric) =====</span>
<span class=n>control_revenue</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>exponential</span><span class=p>(</span><span class=n>scale</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=mi>5000</span><span class=p>)</span>  <span class=c1># Right-skewed</span>
<span class=n>treatment_revenue</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>exponential</span><span class=p>(</span><span class=n>scale</span><span class=o>=</span><span class=mi>22</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=mi>5000</span><span class=p>)</span>  <span class=c1># +10% lift</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== Revenue Per User Test (Continuous) =====&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Control mean: $</span><span class=si>{</span><span class=n>control_revenue</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> (median: $</span><span class=si>{</span><span class=n>np</span><span class=o>.</span><span class=n>median</span><span class=p>(</span><span class=n>control_revenue</span><span class=p>)</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Treatment mean: $</span><span class=si>{</span><span class=n>treatment_revenue</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> (median: $</span><span class=si>{</span><span class=n>np</span><span class=o>.</span><span class=n>median</span><span class=p>(</span><span class=n>treatment_revenue</span><span class=p>)</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Absolute lift: $</span><span class=si>{</span><span class=p>(</span><span class=n>treatment_revenue</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>control_revenue</span><span class=o>.</span><span class=n>mean</span><span class=p>())</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Relative lift: </span><span class=si>{</span><span class=mi>100</span><span class=o>*</span><span class=p>(</span><span class=n>treatment_revenue</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=o>/</span><span class=n>control_revenue</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># ===== 4. T-test for continuous metrics =====</span>
<span class=c1># Standard t-test (assumes equal variance)</span>
<span class=n>t_stat_standard</span><span class=p>,</span> <span class=n>p_value_standard</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span><span class=n>treatment_revenue</span><span class=p>,</span> <span class=n>control_revenue</span><span class=p>)</span>

<span class=c1># Welch&#39;s t-test (does NOT assume equal variance - PREFERRED)</span>
<span class=n>t_stat_welch</span><span class=p>,</span> <span class=n>p_value_welch</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>welch_ttest</span><span class=p>(</span><span class=n>treatment_revenue</span><span class=p>,</span> <span class=n>control_revenue</span><span class=p>,</span> <span class=n>usevar</span><span class=o>=</span><span class=s1>&#39;unequal&#39;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;--- T-test (Standard, assumes equal variance) ---&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;t-statistic: </span><span class=si>{</span><span class=n>t_stat_standard</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;p-value: </span><span class=si>{</span><span class=n>p_value_standard</span><span class=si>:</span><span class=s2>.6f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>--- Welch&#39;s T-test (Unequal variance, PREFERRED) ---&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;t-statistic: </span><span class=si>{</span><span class=n>t_stat_welch</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;p-value: </span><span class=si>{</span><span class=n>p_value_welch</span><span class=si>:</span><span class=s2>.6f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Result: </span><span class=si>{</span><span class=s1>&#39;REJECT H0 (significant)&#39;</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>p_value_welch</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mf>0.05</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=s1>&#39;FAIL TO REJECT H0&#39;</span><span class=si>}</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># ===== 5. Mann-Whitney U test (non-parametric alternative) =====</span>
<span class=c1># Use when: Data is heavily skewed or violates normality assumptions</span>
<span class=n>u_stat</span><span class=p>,</span> <span class=n>p_value_mann</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>mannwhitneyu</span><span class=p>(</span><span class=n>treatment_revenue</span><span class=p>,</span> <span class=n>control_revenue</span><span class=p>,</span> <span class=n>alternative</span><span class=o>=</span><span class=s1>&#39;two-sided&#39;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;--- Mann-Whitney U Test (Non-parametric) ---&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;U-statistic: </span><span class=si>{</span><span class=n>u_stat</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;p-value: </span><span class=si>{</span><span class=n>p_value_mann</span><span class=si>:</span><span class=s2>.6f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Result: </span><span class=si>{</span><span class=s1>&#39;REJECT H0 (significant)&#39;</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>p_value_mann</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mf>0.05</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=s1>&#39;FAIL TO REJECT H0&#39;</span><span class=si>}</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># ===== 6. Bootstrap confidence interval (robust alternative) =====</span>
<span class=c1># Useful when: Unsure about distributions, want robust CI</span>
<span class=k>def</span><span class=w> </span><span class=nf>bootstrap_diff</span><span class=p>(</span><span class=n>control</span><span class=p>,</span> <span class=n>treatment</span><span class=p>,</span> <span class=n>n_iterations</span><span class=o>=</span><span class=mi>10000</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Bootstrap confidence interval for difference in means&quot;&quot;&quot;</span>
    <span class=n>diffs</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_iterations</span><span class=p>):</span>
        <span class=n>control_sample</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>control</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>),</span> <span class=n>replace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
        <span class=n>treatment_sample</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>treatment</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>),</span> <span class=n>replace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
        <span class=n>diffs</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>treatment_sample</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>-</span> <span class=n>control_sample</span><span class=o>.</span><span class=n>mean</span><span class=p>())</span>
    <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>diffs</span><span class=p>)</span>

<span class=n>bootstrap_diffs</span> <span class=o>=</span> <span class=n>bootstrap_diff</span><span class=p>(</span><span class=n>control_revenue</span><span class=p>,</span> <span class=n>treatment_revenue</span><span class=p>)</span>
<span class=n>ci_lower</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>bootstrap_diffs</span><span class=p>,</span> <span class=mf>2.5</span><span class=p>)</span>
<span class=n>ci_upper</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>bootstrap_diffs</span><span class=p>,</span> <span class=mf>97.5</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;--- Bootstrap 95% CI for Difference in Means ---&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;95% CI: [$</span><span class=si>{</span><span class=n>ci_lower</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>, $</span><span class=si>{</span><span class=n>ci_upper</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>]&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Observed diff: $</span><span class=si>{</span><span class=p>(</span><span class=n>treatment_revenue</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>control_revenue</span><span class=o>.</span><span class=n>mean</span><span class=p>())</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Result: </span><span class=si>{</span><span class=s1>&#39;REJECT H0&#39;</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>ci_lower</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=s1>&#39;FAIL TO REJECT H0&#39;</span><span class=si>}</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># ===== 7. Effect size calculation (practical significance) =====</span>
<span class=c1># Cohen&#39;s d for continuous metrics</span>
<span class=n>pooled_std</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>((</span><span class=n>control_revenue</span><span class=o>.</span><span class=n>var</span><span class=p>()</span> <span class=o>+</span> <span class=n>treatment_revenue</span><span class=o>.</span><span class=n>var</span><span class=p>())</span> <span class=o>/</span> <span class=mi>2</span><span class=p>)</span>
<span class=n>cohens_d</span> <span class=o>=</span> <span class=p>(</span><span class=n>treatment_revenue</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>-</span> <span class=n>control_revenue</span><span class=o>.</span><span class=n>mean</span><span class=p>())</span> <span class=o>/</span> <span class=n>pooled_std</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;--- Effect Size (Cohen&#39;s d) ---&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Cohen&#39;s d: </span><span class=si>{</span><span class=n>cohens_d</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Interpretation: &quot;</span><span class=p>,</span> <span class=n>end</span><span class=o>=</span><span class=s2>&quot;&quot;</span><span class=p>)</span>
<span class=k>if</span> <span class=nb>abs</span><span class=p>(</span><span class=n>cohens_d</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mf>0.2</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Small effect&quot;</span><span class=p>)</span>
<span class=k>elif</span> <span class=nb>abs</span><span class=p>(</span><span class=n>cohens_d</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mf>0.5</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Medium effect&quot;</span><span class=p>)</span>
<span class=k>else</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Large effect&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>()</span>

<span class=c1># ===== 8. Confidence interval for proportions =====</span>
<span class=kn>from</span><span class=w> </span><span class=nn>statsmodels.stats.proportion</span><span class=w> </span><span class=kn>import</span> <span class=n>proportion_confint</span>

<span class=n>ci_control</span> <span class=o>=</span> <span class=n>proportion_confint</span><span class=p>(</span><span class=n>control_conversions</span><span class=p>,</span> <span class=n>n_control</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span> <span class=n>method</span><span class=o>=</span><span class=s1>&#39;wilson&#39;</span><span class=p>)</span>
<span class=n>ci_treatment</span> <span class=o>=</span> <span class=n>proportion_confint</span><span class=p>(</span><span class=n>treatment_conversions</span><span class=p>,</span> <span class=n>n_treatment</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span> <span class=n>method</span><span class=o>=</span><span class=s1>&#39;wilson&#39;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;--- 95% Confidence Intervals (Wilson method) ---&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Control CVR: </span><span class=si>{</span><span class=n>control_cvr</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2> [</span><span class=si>{</span><span class=n>ci_control</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>ci_control</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>]&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Treatment CVR: </span><span class=si>{</span><span class=n>treatment_cvr</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2> [</span><span class=si>{</span><span class=n>ci_treatment</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>ci_treatment</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>]&quot;</span><span class=p>)</span>

<span class=c1># Confidence interval for difference in proportions</span>
<span class=n>se_diff</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>control_cvr</span><span class=o>*</span><span class=p>(</span><span class=mi>1</span><span class=o>-</span><span class=n>control_cvr</span><span class=p>)</span><span class=o>/</span><span class=n>n_control</span> <span class=o>+</span> <span class=n>treatment_cvr</span><span class=o>*</span><span class=p>(</span><span class=mi>1</span><span class=o>-</span><span class=n>treatment_cvr</span><span class=p>)</span><span class=o>/</span><span class=n>n_treatment</span><span class=p>)</span>
<span class=n>diff</span> <span class=o>=</span> <span class=n>treatment_cvr</span> <span class=o>-</span> <span class=n>control_cvr</span>
<span class=n>ci_diff_lower</span> <span class=o>=</span> <span class=n>diff</span> <span class=o>-</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=n>se_diff</span>
<span class=n>ci_diff_upper</span> <span class=o>=</span> <span class=n>diff</span> <span class=o>+</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=n>se_diff</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Difference: </span><span class=si>{</span><span class=n>diff</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2> [</span><span class=si>{</span><span class=n>ci_diff_lower</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>ci_diff_upper</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>]&quot;</span><span class=p>)</span>
</code></pre></div> <table> <thead> <tr> <th>Test Type</th> <th>Use Case</th> <th>Assumptions</th> <th>Python Function</th> </tr> </thead> <tbody> <tr> <td><strong>Z-test (proportions)</strong></td> <td>Conversion rate, click rate</td> <td>Large n (n¬∑p &gt; 5)</td> <td><code>proportions_ztest()</code></td> </tr> <tr> <td><strong>T-test (standard)</strong></td> <td>Revenue, time spent</td> <td>Normal dist, equal variance</td> <td><code>stats.ttest_ind()</code></td> </tr> <tr> <td><strong>Welch's t-test</strong></td> <td>Revenue, skewed metrics</td> <td>Normal dist, unequal variance</td> <td><code>welch_ttest()</code></td> </tr> <tr> <td><strong>Mann-Whitney U</strong></td> <td>Heavily skewed data</td> <td>None (non-parametric)</td> <td><code>stats.mannwhitneyu()</code></td> </tr> <tr> <td><strong>Bootstrap</strong></td> <td>Any metric, robust CI</td> <td>None (resampling)</td> <td>Custom implementation</td> </tr> </tbody> </table> <table> <thead> <tr> <th>p-value</th> <th>Interpretation</th> <th>Decision (Œ± = 0.05)</th> </tr> </thead> <tbody> <tr> <td>&lt; 0.001</td> <td>Very strong evidence against H‚ÇÄ</td> <td>Reject H‚ÇÄ (ship)</td> </tr> <tr> <td>0.001-0.01</td> <td>Strong evidence</td> <td>Reject H‚ÇÄ</td> </tr> <tr> <td>0.01-0.05</td> <td>Moderate evidence</td> <td>Reject H‚ÇÄ (borderline)</td> </tr> <tr> <td>0.05-0.10</td> <td>Weak evidence</td> <td>Fail to reject H‚ÇÄ</td> </tr> <tr> <td>&gt; 0.10</td> <td>No evidence</td> <td>Fail to reject H‚ÇÄ (don't ship)</td> </tr> </tbody> </table> <p><strong>Real-World:</strong> - <strong>Netflix:</strong> Uses <strong>Welch's t-test</strong> for watch time (skewed distribution). Tests 200+ experiments/week with Œ± = 0.05, ships features with p &lt; 0.01 for high-impact changes. - <strong>Booking.com:</strong> Runs <strong>z-tests on conversion rate</strong> with 95% confidence. Average test: 2 weeks, 1M+ users, MDE = 1% relative lift. - <strong>Airbnb:</strong> Uses <strong>bootstrap methods</strong> for revenue metrics (extreme outliers from luxury rentals). 10,000 bootstrap iterations for robust CI.</p> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <ul> <li>Knows <strong>z-test for proportions, t-test for continuous</strong>, and when to use <strong>Welch's t-test</strong> (unequal variance)</li> <li>Understands <strong>p-value ‚â† probability H‚ÇÄ is true</strong> (common misconception)</li> <li>Uses <strong>effect size (Cohen's d)</strong> to assess practical significance beyond statistical significance</li> <li>Real-world: <strong>Google runs 10,000+ experiments/year; uses Œ± = 0.05 for standard tests, Œ± = 0.01 for high-risk launches</strong></li> </ul> </div> </details> <hr> <h3 id=how-to-calculate-sample-size-google-netflix-interview-question>How to Calculate Sample Size? - Google, Netflix Interview Question</h3> <p><strong>Difficulty:</strong> üü° Medium | <strong>Tags:</strong> <code>Experimental Design</code> | <strong>Asked by:</strong> Google, Netflix, Uber</p> <details class=success> <summary>View Answer</summary> <p><strong>Sample size calculation</strong> determines how many users are needed in control and treatment to <strong>reliably detect</strong> a <strong>Minimum Detectable Effect (MDE)</strong> with specified <strong>power (1-Œ≤)</strong> and <strong>significance level (Œ±)</strong>. Too small = miss real effects (low power), too large = wasted time/resources.</p> <p><strong>Formula for proportions:</strong></p> <div class=arithmatex>\[n = \frac{2(z_{\alpha/2} + z_{\beta})^2 \cdot p(1-p)}{\delta^2}\]</div> <p>Where: - <span class=arithmatex>\(\delta\)</span> = Minimum Detectable Effect (MDE) in absolute terms - <span class=arithmatex>\(p\)</span> = baseline conversion rate - <span class=arithmatex>\(z_{\alpha/2}\)</span> = critical value for significance (1.96 for Œ± = 0.05) - <span class=arithmatex>\(z_{\beta}\)</span> = critical value for power (0.84 for 80% power)</p> <p><strong>Formula for continuous metrics:</strong></p> <div class=arithmatex>\[n = \frac{2(z_{\alpha/2} + z_{\beta})^2 \cdot \sigma^2}{\delta^2}\]</div> <p>Where <span class=arithmatex>\(\sigma\)</span> = standard deviation of the metric.</p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>statsmodels.stats.power</span><span class=w> </span><span class=kn>import</span> <span class=n>TTestIndPower</span><span class=p>,</span> <span class=n>zt_ind_solve_power</span>
<span class=kn>from</span><span class=w> </span><span class=nn>statsmodels.stats.proportion</span><span class=w> </span><span class=kn>import</span> <span class=n>proportion_effectsize</span>
<span class=kn>import</span><span class=w> </span><span class=nn>matplotlib.pyplot</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>plt</span>

<span class=c1># Production: Comprehensive Sample Size Calculator for A/B Tests</span>

<span class=c1># ===== 1. Sample size for proportions (conversion rate) =====</span>
<span class=k>def</span><span class=w> </span><span class=nf>sample_size_proportions</span><span class=p>(</span><span class=n>baseline_rate</span><span class=p>,</span> <span class=n>mde_relative</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span> <span class=n>power</span><span class=o>=</span><span class=mf>0.8</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Calculate sample size for proportion test</span>

<span class=sd>    Args:</span>
<span class=sd>        baseline_rate: Baseline conversion rate (e.g., 0.10 for 10%)</span>
<span class=sd>        mde_relative: Minimum detectable effect as relative lift (e.g., 0.05 for 5%)</span>
<span class=sd>        alpha: Significance level (Type I error rate)</span>
<span class=sd>        power: Statistical power (1 - Type II error rate)</span>

<span class=sd>    Returns:</span>
<span class=sd>        Sample size per group</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=c1># Convert relative MDE to absolute</span>
    <span class=n>treatment_rate</span> <span class=o>=</span> <span class=n>baseline_rate</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>mde_relative</span><span class=p>)</span>

    <span class=c1># Calculate effect size (Cohen&#39;s h for proportions)</span>
    <span class=n>effect_size</span> <span class=o>=</span> <span class=n>proportion_effectsize</span><span class=p>(</span><span class=n>baseline_rate</span><span class=p>,</span> <span class=n>treatment_rate</span><span class=p>)</span>

    <span class=c1># Solve for sample size</span>
    <span class=n>analysis</span> <span class=o>=</span> <span class=n>TTestIndPower</span><span class=p>()</span>
    <span class=n>sample_size</span> <span class=o>=</span> <span class=n>analysis</span><span class=o>.</span><span class=n>solve_power</span><span class=p>(</span>
        <span class=n>effect_size</span><span class=o>=</span><span class=n>effect_size</span><span class=p>,</span>
        <span class=n>power</span><span class=o>=</span><span class=n>power</span><span class=p>,</span>
        <span class=n>alpha</span><span class=o>=</span><span class=n>alpha</span><span class=p>,</span>
        <span class=n>ratio</span><span class=o>=</span><span class=mf>1.0</span><span class=p>,</span>
        <span class=n>alternative</span><span class=o>=</span><span class=s1>&#39;two-sided&#39;</span>
    <span class=p>)</span>

    <span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>ceil</span><span class=p>(</span><span class=n>sample_size</span><span class=p>))</span>

<span class=c1># Example 1: Conversion rate test</span>
<span class=n>baseline_cvr</span> <span class=o>=</span> <span class=mf>0.10</span>  <span class=c1># 10% baseline</span>
<span class=n>mde_relative</span> <span class=o>=</span> <span class=mf>0.05</span>  <span class=c1># 5% relative lift (detect 10% ‚Üí 10.5%)</span>

<span class=n>n_per_group</span> <span class=o>=</span> <span class=n>sample_size_proportions</span><span class=p>(</span><span class=n>baseline_cvr</span><span class=p>,</span> <span class=n>mde_relative</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== Sample Size for Conversion Rate Test =====&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Baseline CVR: </span><span class=si>{</span><span class=n>baseline_cvr</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;MDE (relative): </span><span class=si>{</span><span class=n>mde_relative</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;MDE (absolute): </span><span class=si>{</span><span class=n>baseline_cvr</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>mde_relative</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Significance (Œ±): 0.05&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Power (1-Œ≤): 0.80&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Sample size per group: </span><span class=si>{</span><span class=n>n_per_group</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Total sample size: </span><span class=si>{</span><span class=n>n_per_group</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>2</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># ===== 2. Sample size for continuous metrics (revenue) =====</span>
<span class=k>def</span><span class=w> </span><span class=nf>sample_size_continuous</span><span class=p>(</span><span class=n>mean</span><span class=p>,</span> <span class=n>std</span><span class=p>,</span> <span class=n>mde_relative</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span> <span class=n>power</span><span class=o>=</span><span class=mf>0.8</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Calculate sample size for continuous metric (e.g., revenue)</span>

<span class=sd>    Args:</span>
<span class=sd>        mean: Baseline mean (e.g., average revenue per user)</span>
<span class=sd>        std: Standard deviation</span>
<span class=sd>        mde_relative: Minimum detectable effect as relative lift</span>
<span class=sd>        alpha: Significance level</span>
<span class=sd>        power: Statistical power</span>

<span class=sd>    Returns:</span>
<span class=sd>        Sample size per group</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=c1># Absolute MDE</span>
    <span class=n>mde_absolute</span> <span class=o>=</span> <span class=n>mean</span> <span class=o>*</span> <span class=n>mde_relative</span>

    <span class=c1># Effect size (Cohen&#39;s d)</span>
    <span class=n>effect_size</span> <span class=o>=</span> <span class=n>mde_absolute</span> <span class=o>/</span> <span class=n>std</span>

    <span class=c1># Solve for sample size</span>
    <span class=n>analysis</span> <span class=o>=</span> <span class=n>TTestIndPower</span><span class=p>()</span>
    <span class=n>sample_size</span> <span class=o>=</span> <span class=n>analysis</span><span class=o>.</span><span class=n>solve_power</span><span class=p>(</span>
        <span class=n>effect_size</span><span class=o>=</span><span class=n>effect_size</span><span class=p>,</span>
        <span class=n>power</span><span class=o>=</span><span class=n>power</span><span class=p>,</span>
        <span class=n>alpha</span><span class=o>=</span><span class=n>alpha</span><span class=p>,</span>
        <span class=n>ratio</span><span class=o>=</span><span class=mf>1.0</span><span class=p>,</span>
        <span class=n>alternative</span><span class=o>=</span><span class=s1>&#39;two-sided&#39;</span>
    <span class=p>)</span>

    <span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>ceil</span><span class=p>(</span><span class=n>sample_size</span><span class=p>))</span>

<span class=c1># Example 2: Revenue per user test</span>
<span class=n>avg_revenue</span> <span class=o>=</span> <span class=mf>50.0</span>  <span class=c1># $50 average revenue</span>
<span class=n>revenue_std</span> <span class=o>=</span> <span class=mf>30.0</span>  <span class=c1># $30 standard deviation (CV = 60%, high variance)</span>
<span class=n>mde_relative_revenue</span> <span class=o>=</span> <span class=mf>0.10</span>  <span class=c1># Detect 10% lift</span>

<span class=n>n_revenue</span> <span class=o>=</span> <span class=n>sample_size_continuous</span><span class=p>(</span><span class=n>avg_revenue</span><span class=p>,</span> <span class=n>revenue_std</span><span class=p>,</span> <span class=n>mde_relative_revenue</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== Sample Size for Revenue Test =====&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Baseline revenue: $</span><span class=si>{</span><span class=n>avg_revenue</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Std deviation: $</span><span class=si>{</span><span class=n>revenue_std</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> (CV = </span><span class=si>{</span><span class=n>revenue_std</span><span class=o>/</span><span class=n>avg_revenue</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;MDE (relative): </span><span class=si>{</span><span class=n>mde_relative_revenue</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;MDE (absolute): $</span><span class=si>{</span><span class=n>avg_revenue</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>mde_relative_revenue</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Sample size per group: </span><span class=si>{</span><span class=n>n_revenue</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># ===== 3. Sensitivity analysis: MDE vs sample size =====</span>
<span class=n>baseline_cvr</span> <span class=o>=</span> <span class=mf>0.10</span>
<span class=n>mde_values</span> <span class=o>=</span> <span class=p>[</span><span class=mf>0.01</span><span class=p>,</span> <span class=mf>0.02</span><span class=p>,</span> <span class=mf>0.03</span><span class=p>,</span> <span class=mf>0.05</span><span class=p>,</span> <span class=mf>0.10</span><span class=p>,</span> <span class=mf>0.15</span><span class=p>,</span> <span class=mf>0.20</span><span class=p>]</span>  <span class=c1># Relative MDE</span>
<span class=n>sample_sizes</span> <span class=o>=</span> <span class=p>[</span><span class=n>sample_size_proportions</span><span class=p>(</span><span class=n>baseline_cvr</span><span class=p>,</span> <span class=n>mde</span><span class=p>)</span> <span class=k>for</span> <span class=n>mde</span> <span class=ow>in</span> <span class=n>mde_values</span><span class=p>]</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== Sensitivity Analysis: MDE vs Sample Size =====&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=s1>&#39;MDE (relative)&#39;</span><span class=si>:</span><span class=s2>&lt;15</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;MDE (absolute)&#39;</span><span class=si>:</span><span class=s2>&lt;15</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Sample Size/Group&#39;</span><span class=si>:</span><span class=s2>&lt;20</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Test Duration (days)&#39;</span><span class=si>:</span><span class=s2>&lt;20</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;-&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>

<span class=n>daily_traffic</span> <span class=o>=</span> <span class=mi>10000</span>  <span class=c1># Assume 10k daily users</span>

<span class=k>for</span> <span class=n>mde</span><span class=p>,</span> <span class=n>n</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>mde_values</span><span class=p>,</span> <span class=n>sample_sizes</span><span class=p>):</span>
    <span class=n>mde_abs</span> <span class=o>=</span> <span class=n>baseline_cvr</span> <span class=o>*</span> <span class=n>mde</span>
    <span class=n>duration</span> <span class=o>=</span> <span class=p>(</span><span class=n>n</span> <span class=o>*</span> <span class=mi>2</span><span class=p>)</span> <span class=o>/</span> <span class=n>daily_traffic</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>mde</span><span class=si>:</span><span class=s2>&gt;6.1%</span><span class=si>}</span><span class=s2>          </span><span class=si>{</span><span class=n>mde_abs</span><span class=si>:</span><span class=s2>&gt;8.4f</span><span class=si>}</span><span class=s2>          </span><span class=si>{</span><span class=n>n</span><span class=si>:</span><span class=s2>&gt;12,</span><span class=si>}</span><span class=s2>          </span><span class=si>{</span><span class=n>duration</span><span class=si>:</span><span class=s2>&gt;10.1f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>()</span>

<span class=c1># ===== 4. Tradeoff: Power vs Sample Size =====</span>
<span class=n>power_values</span> <span class=o>=</span> <span class=p>[</span><span class=mf>0.70</span><span class=p>,</span> <span class=mf>0.75</span><span class=p>,</span> <span class=mf>0.80</span><span class=p>,</span> <span class=mf>0.85</span><span class=p>,</span> <span class=mf>0.90</span><span class=p>,</span> <span class=mf>0.95</span><span class=p>]</span>
<span class=n>mde_fixed</span> <span class=o>=</span> <span class=mf>0.05</span>  <span class=c1># 5% relative MDE</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== Power vs Sample Size Tradeoff (MDE = 5%) =====&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=s1>&#39;Power (1-Œ≤)&#39;</span><span class=si>:</span><span class=s2>&lt;12</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Sample Size/Group&#39;</span><span class=si>:</span><span class=s2>&lt;20</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;% Increase vs 80%&#39;</span><span class=si>:</span><span class=s2>&lt;20</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;-&quot;</span> <span class=o>*</span> <span class=mi>50</span><span class=p>)</span>

<span class=n>baseline_n</span> <span class=o>=</span> <span class=n>sample_size_proportions</span><span class=p>(</span><span class=n>baseline_cvr</span><span class=p>,</span> <span class=n>mde_fixed</span><span class=p>,</span> <span class=n>power</span><span class=o>=</span><span class=mf>0.80</span><span class=p>)</span>

<span class=k>for</span> <span class=n>pwr</span> <span class=ow>in</span> <span class=n>power_values</span><span class=p>:</span>
    <span class=n>n</span> <span class=o>=</span> <span class=n>sample_size_proportions</span><span class=p>(</span><span class=n>baseline_cvr</span><span class=p>,</span> <span class=n>mde_fixed</span><span class=p>,</span> <span class=n>power</span><span class=o>=</span><span class=n>pwr</span><span class=p>)</span>
    <span class=n>increase</span> <span class=o>=</span> <span class=mi>100</span> <span class=o>*</span> <span class=p>(</span><span class=n>n</span> <span class=o>/</span> <span class=n>baseline_n</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>pwr</span><span class=si>:</span><span class=s2>&gt;6.0%</span><span class=si>}</span><span class=s2>       </span><span class=si>{</span><span class=n>n</span><span class=si>:</span><span class=s2>&gt;12,</span><span class=si>}</span><span class=s2>          </span><span class=si>{</span><span class=n>increase</span><span class=si>:</span><span class=s2>&gt;+8.1f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>()</span>

<span class=c1># ===== 5. Unequal allocation (90/10 split) =====</span>
<span class=c1># Sometimes you want 90% treatment, 10% control (faster rollout)</span>
<span class=k>def</span><span class=w> </span><span class=nf>sample_size_unequal</span><span class=p>(</span><span class=n>baseline_rate</span><span class=p>,</span> <span class=n>mde_relative</span><span class=p>,</span> <span class=n>ratio</span><span class=o>=</span><span class=mf>9.0</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span> <span class=n>power</span><span class=o>=</span><span class=mf>0.8</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Calculate sample size with unequal allocation</span>

<span class=sd>    Args:</span>
<span class=sd>        ratio: Treatment size / Control size (e.g., 9.0 for 90/10 split)</span>

<span class=sd>    Returns:</span>
<span class=sd>        (control_size, treatment_size)</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=n>treatment_rate</span> <span class=o>=</span> <span class=n>baseline_rate</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>mde_relative</span><span class=p>)</span>
    <span class=n>effect_size</span> <span class=o>=</span> <span class=n>proportion_effectsize</span><span class=p>(</span><span class=n>baseline_rate</span><span class=p>,</span> <span class=n>treatment_rate</span><span class=p>)</span>

    <span class=n>analysis</span> <span class=o>=</span> <span class=n>TTestIndPower</span><span class=p>()</span>
    <span class=n>n_control</span> <span class=o>=</span> <span class=n>analysis</span><span class=o>.</span><span class=n>solve_power</span><span class=p>(</span>
        <span class=n>effect_size</span><span class=o>=</span><span class=n>effect_size</span><span class=p>,</span>
        <span class=n>power</span><span class=o>=</span><span class=n>power</span><span class=p>,</span>
        <span class=n>alpha</span><span class=o>=</span><span class=n>alpha</span><span class=p>,</span>
        <span class=n>ratio</span><span class=o>=</span><span class=n>ratio</span><span class=p>,</span>
        <span class=n>alternative</span><span class=o>=</span><span class=s1>&#39;two-sided&#39;</span>
    <span class=p>)</span>

    <span class=n>n_treatment</span> <span class=o>=</span> <span class=n>n_control</span> <span class=o>*</span> <span class=n>ratio</span>

    <span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>ceil</span><span class=p>(</span><span class=n>n_control</span><span class=p>)),</span> <span class=nb>int</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>ceil</span><span class=p>(</span><span class=n>n_treatment</span><span class=p>))</span>

<span class=n>n_control_90_10</span><span class=p>,</span> <span class=n>n_treatment_90_10</span> <span class=o>=</span> <span class=n>sample_size_unequal</span><span class=p>(</span><span class=n>baseline_cvr</span><span class=p>,</span> <span class=n>mde_fixed</span><span class=p>,</span> <span class=n>ratio</span><span class=o>=</span><span class=mf>9.0</span><span class=p>)</span>
<span class=n>n_equal</span> <span class=o>=</span> <span class=n>sample_size_proportions</span><span class=p>(</span><span class=n>baseline_cvr</span><span class=p>,</span> <span class=n>mde_fixed</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== Equal vs Unequal Allocation =====&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Equal (50/50): </span><span class=si>{</span><span class=n>n_equal</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> per group, </span><span class=si>{</span><span class=n>n_equal</span><span class=o>*</span><span class=mi>2</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> total&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Unequal (10/90): Control = </span><span class=si>{</span><span class=n>n_control_90_10</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>, Treatment = </span><span class=si>{</span><span class=n>n_treatment_90_10</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>, Total = </span><span class=si>{</span><span class=n>n_control_90_10</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>n_treatment_90_10</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Cost of unequal allocation: </span><span class=si>{</span><span class=mi>100</span><span class=o>*</span><span class=p>((</span><span class=n>n_control_90_10</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>n_treatment_90_10</span><span class=p>)</span><span class=o>/</span><span class=p>(</span><span class=n>n_equal</span><span class=o>*</span><span class=mi>2</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>% more users</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># ===== 6. Sequential testing adjustment =====</span>
<span class=c1># If using sequential testing (early stopping), need ~10-20% more samples</span>
<span class=n>n_sequential</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>n_per_group</span> <span class=o>*</span> <span class=mf>1.15</span><span class=p>)</span>  <span class=c1># 15% inflation for sequential testing</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== Sequential Testing Adjustment =====&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Fixed-horizon sample size: </span><span class=si>{</span><span class=n>n_per_group</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Sequential testing sample size: </span><span class=si>{</span><span class=n>n_sequential</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> (+15% inflation)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Benefit: Can stop early if strong signal, but need buffer for Type I error control</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>
</code></pre></div> <table> <thead> <tr> <th>Parameter</th> <th>Typical Values</th> <th>Impact on Sample Size</th> </tr> </thead> <tbody> <tr> <td><strong>MDE (relative)</strong></td> <td>1-10% for large sites, 10-30% for small</td> <td>‚Üì MDE ‚Üí ‚Üë n (quadratic)</td> </tr> <tr> <td><strong>Baseline rate</strong></td> <td>1-50% (varies by funnel stage)</td> <td>Mid-range (5-50%) needs fewer samples</td> </tr> <tr> <td><strong>Power (1-Œ≤)</strong></td> <td>80% standard, 90% conservative</td> <td>80% ‚Üí 90% = +30% samples</td> </tr> <tr> <td><strong>Significance (Œ±)</strong></td> <td>0.05 standard, 0.01 conservative</td> <td>0.05 ‚Üí 0.01 = +50% samples</td> </tr> <tr> <td><strong>Allocation ratio</strong></td> <td>50/50 optimal, 90/10 for fast rollout</td> <td>Unequal = +10-30% total samples</td> </tr> </tbody> </table> <table> <thead> <tr> <th>MDE (relative)</th> <th>Sample Size/Group (CVR = 10%)</th> <th>Test Duration (50k daily traffic)</th> </tr> </thead> <tbody> <tr> <td><strong>1%</strong></td> <td>786,240</td> <td>31.4 days</td> </tr> <tr> <td><strong>2%</strong></td> <td>196,560</td> <td>7.9 days</td> </tr> <tr> <td><strong>5%</strong></td> <td>31,450</td> <td>1.3 days</td> </tr> <tr> <td><strong>10%</strong></td> <td>7,850</td> <td>0.3 days (8 hours)</td> </tr> <tr> <td><strong>20%</strong></td> <td>1,960</td> <td>0.08 days (2 hours)</td> </tr> </tbody> </table> <p><strong>Real-World:</strong> - <strong>Google:</strong> Runs experiments with <strong>MDE = 0.5-1%</strong> on core metrics (search quality). Requires millions of users, tests run 2-4 weeks. - <strong>Netflix:</strong> Targets <strong>MDE = 2-3%</strong> for watch time. Average test: 500k users, 2 weeks duration. Uses <strong>90% power</strong> for high-stakes features. - <strong>Uber:</strong> <strong>MDE = 1-2%</strong> for conversion, <strong>5-10%</strong> for engagement. Daily traffic = 10M+ users, can detect small effects in 3-7 days.</p> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <ul> <li>Understands <strong>tradeoff: smaller MDE requires quadratically more samples</strong> (halve MDE ‚Üí 4√ó samples)</li> <li>Knows <strong>50/50 split is optimal</strong> for power, but 90/10 allows faster rollout at cost of +20% samples</li> <li>Uses <strong>80% power as standard</strong>, 90% for high-risk launches (e.g., payment flow changes)</li> <li>Real-world: <strong>Booking.com runs 1000+ tests/year, median MDE = 2%, median duration = 2 weeks</strong></li> </ul> </div> </details> <hr> <h3 id=what-is-statistical-power-google-netflix-interview-question>What is Statistical Power? - Google, Netflix Interview Question</h3> <p><strong>Difficulty:</strong> üü° Medium | <strong>Tags:</strong> <code>Statistics</code> | <strong>Asked by:</strong> Google, Netflix, Uber</p> <details class=success> <summary>View Answer</summary> <p><strong>Statistical power</strong> is the <strong>probability of correctly detecting a true effect</strong> when it exists. Power = 1 - Œ≤ (Type II error rate). <strong>80% power</strong> means if a treatment truly has an effect, you'll detect it 80% of the time. Low power = risk missing real wins (false negatives).</p> <p><strong>Power = Probability of detecting a true effect = 1 - Œ≤ (Type II error)</strong></p> <table> <thead> <tr> <th>Power</th> <th>Meaning</th> <th>When to Use</th> </tr> </thead> <tbody> <tr> <td><strong>70%</strong></td> <td>Lower confidence</td> <td>Early-stage experiments, exploratory tests</td> </tr> <tr> <td><strong>80%</strong></td> <td>Industry standard</td> <td>Most A/B tests</td> </tr> <tr> <td><strong>90%</strong></td> <td>High confidence</td> <td>High-stakes features (payment, core metrics)</td> </tr> <tr> <td><strong>95%</strong></td> <td>Very conservative</td> <td>Regulatory or safety-critical changes</td> </tr> </tbody> </table> <p><strong>Factors affecting power:</strong> - <strong>Sample size</strong> (‚Üë n = ‚Üë power): Doubling n increases power significantly - <strong>Effect size</strong> (‚Üë effect = ‚Üë power): Larger effects easier to detect - <strong>Significance level</strong> (‚Üë Œ± = ‚Üë power, but more false positives): Tradeoff between Type I and Type II errors - <strong>Variance</strong> (‚Üì variance = ‚Üë power): Use variance reduction techniques (CUPED, stratification)</p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>statsmodels.stats.power</span><span class=w> </span><span class=kn>import</span> <span class=n>TTestIndPower</span>
<span class=kn>from</span><span class=w> </span><span class=nn>statsmodels.stats.proportion</span><span class=w> </span><span class=kn>import</span> <span class=n>proportion_effectsize</span>
<span class=kn>import</span><span class=w> </span><span class=nn>matplotlib.pyplot</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>plt</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>

<span class=c1># Production: Statistical Power Analysis and Visualization</span>

<span class=c1># ===== 1. Power calculation for given sample size =====</span>
<span class=k>def</span><span class=w> </span><span class=nf>calculate_power</span><span class=p>(</span><span class=n>baseline_rate</span><span class=p>,</span> <span class=n>treatment_rate</span><span class=p>,</span> <span class=n>n_per_group</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Calculate statistical power for a proportion test</span>

<span class=sd>    Args:</span>
<span class=sd>        baseline_rate: Control conversion rate</span>
<span class=sd>        treatment_rate: Treatment conversion rate</span>
<span class=sd>        n_per_group: Sample size per group</span>
<span class=sd>        alpha: Significance level</span>

<span class=sd>    Returns:</span>
<span class=sd>        Statistical power (0 to 1)</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=n>effect_size</span> <span class=o>=</span> <span class=n>proportion_effectsize</span><span class=p>(</span><span class=n>baseline_rate</span><span class=p>,</span> <span class=n>treatment_rate</span><span class=p>)</span>
    <span class=n>analysis</span> <span class=o>=</span> <span class=n>TTestIndPower</span><span class=p>()</span>
    <span class=n>power</span> <span class=o>=</span> <span class=n>analysis</span><span class=o>.</span><span class=n>solve_power</span><span class=p>(</span>
        <span class=n>effect_size</span><span class=o>=</span><span class=n>effect_size</span><span class=p>,</span>
        <span class=n>nobs1</span><span class=o>=</span><span class=n>n_per_group</span><span class=p>,</span>
        <span class=n>alpha</span><span class=o>=</span><span class=n>alpha</span><span class=p>,</span>
        <span class=n>ratio</span><span class=o>=</span><span class=mf>1.0</span><span class=p>,</span>
        <span class=n>alternative</span><span class=o>=</span><span class=s1>&#39;two-sided&#39;</span>
    <span class=p>)</span>
    <span class=k>return</span> <span class=n>power</span>

<span class=c1># Example: Power for different sample sizes</span>
<span class=n>baseline_cvr</span> <span class=o>=</span> <span class=mf>0.10</span>
<span class=n>treatment_cvr</span> <span class=o>=</span> <span class=mf>0.105</span>  <span class=c1># 5% relative lift</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== Power Analysis: Effect of Sample Size =====&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Baseline: </span><span class=si>{</span><span class=n>baseline_cvr</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>, Treatment: </span><span class=si>{</span><span class=n>treatment_cvr</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2> (5% relative lift)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=s1>&#39;Sample Size/Group&#39;</span><span class=si>:</span><span class=s2>&lt;20</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Power&#39;</span><span class=si>:</span><span class=s2>&lt;10</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Interpretation&#39;</span><span class=si>:</span><span class=s2>&lt;30</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;-&quot;</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>

<span class=n>sample_sizes</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1000</span><span class=p>,</span> <span class=mi>5000</span><span class=p>,</span> <span class=mi>10000</span><span class=p>,</span> <span class=mi>20000</span><span class=p>,</span> <span class=mi>50000</span><span class=p>,</span> <span class=mi>100000</span><span class=p>]</span>
<span class=k>for</span> <span class=n>n</span> <span class=ow>in</span> <span class=n>sample_sizes</span><span class=p>:</span>
    <span class=n>pwr</span> <span class=o>=</span> <span class=n>calculate_power</span><span class=p>(</span><span class=n>baseline_cvr</span><span class=p>,</span> <span class=n>treatment_cvr</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
    <span class=n>interp</span> <span class=o>=</span> <span class=s2>&quot;Too low&quot;</span> <span class=k>if</span> <span class=n>pwr</span> <span class=o>&lt;</span> <span class=mf>0.5</span> <span class=k>else</span> <span class=s2>&quot;Low&quot;</span> <span class=k>if</span> <span class=n>pwr</span> <span class=o>&lt;</span> <span class=mf>0.8</span> <span class=k>else</span> <span class=s2>&quot;Good&quot;</span> <span class=k>if</span> <span class=n>pwr</span> <span class=o>&lt;</span> <span class=mf>0.9</span> <span class=k>else</span> <span class=s2>&quot;Excellent&quot;</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>n</span><span class=si>:</span><span class=s2>&gt;12,</span><span class=si>}</span><span class=s2>        </span><span class=si>{</span><span class=n>pwr</span><span class=si>:</span><span class=s2>&gt;6.1%</span><span class=si>}</span><span class=s2>     </span><span class=si>{</span><span class=n>interp</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>()</span>

<span class=c1># ===== 2. Power curves: Visualize tradeoffs =====</span>
<span class=c1># Power vs sample size for different effect sizes</span>
<span class=n>sample_range</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>linspace</span><span class=p>(</span><span class=mi>1000</span><span class=p>,</span> <span class=mi>50000</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span>
<span class=n>effect_sizes</span> <span class=o>=</span> <span class=p>[</span><span class=mf>0.01</span><span class=p>,</span> <span class=mf>0.02</span><span class=p>,</span> <span class=mf>0.05</span><span class=p>,</span> <span class=mf>0.10</span><span class=p>]</span>  <span class=c1># Relative lifts: 1%, 2%, 5%, 10%</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== Power Curves: Sample Size vs Power =====&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;For different effect sizes (relative lift):&quot;</span><span class=p>)</span>

<span class=k>for</span> <span class=n>rel_lift</span> <span class=ow>in</span> <span class=n>effect_sizes</span><span class=p>:</span>
    <span class=n>treatment</span> <span class=o>=</span> <span class=n>baseline_cvr</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>rel_lift</span><span class=p>)</span>
    <span class=n>powers</span> <span class=o>=</span> <span class=p>[</span><span class=n>calculate_power</span><span class=p>(</span><span class=n>baseline_cvr</span><span class=p>,</span> <span class=n>treatment</span><span class=p>,</span> <span class=nb>int</span><span class=p>(</span><span class=n>n</span><span class=p>))</span> <span class=k>for</span> <span class=n>n</span> <span class=ow>in</span> <span class=n>sample_range</span><span class=p>]</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  </span><span class=si>{</span><span class=n>rel_lift</span><span class=si>:</span><span class=s2>.0%</span><span class=si>}</span><span class=s2> lift: Power reaches 80% at n = </span><span class=si>{</span><span class=n>sample_range</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>argmax</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>powers</span><span class=p>)</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mf>0.80</span><span class=p>)]</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>()</span>

<span class=c1># ===== 3. Minimum Detectable Effect (MDE) at fixed power =====</span>
<span class=k>def</span><span class=w> </span><span class=nf>calculate_mde</span><span class=p>(</span><span class=n>baseline_rate</span><span class=p>,</span> <span class=n>n_per_group</span><span class=p>,</span> <span class=n>power</span><span class=o>=</span><span class=mf>0.8</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Calculate minimum detectable effect for given sample size and power</span>

<span class=sd>    Returns:</span>
<span class=sd>        MDE in absolute terms</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=n>analysis</span> <span class=o>=</span> <span class=n>TTestIndPower</span><span class=p>()</span>

    <span class=c1># Binary search for MDE</span>
    <span class=n>mde_low</span><span class=p>,</span> <span class=n>mde_high</span> <span class=o>=</span> <span class=mf>0.0001</span><span class=p>,</span> <span class=mf>0.50</span>
    <span class=k>while</span> <span class=n>mde_high</span> <span class=o>-</span> <span class=n>mde_low</span> <span class=o>&gt;</span> <span class=mf>0.0001</span><span class=p>:</span>
        <span class=n>mde_mid</span> <span class=o>=</span> <span class=p>(</span><span class=n>mde_low</span> <span class=o>+</span> <span class=n>mde_high</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span>
        <span class=n>treatment_rate</span> <span class=o>=</span> <span class=n>baseline_rate</span> <span class=o>+</span> <span class=n>mde_mid</span>
        <span class=n>effect_size</span> <span class=o>=</span> <span class=n>proportion_effectsize</span><span class=p>(</span><span class=n>baseline_rate</span><span class=p>,</span> <span class=n>treatment_rate</span><span class=p>)</span>

        <span class=n>current_power</span> <span class=o>=</span> <span class=n>analysis</span><span class=o>.</span><span class=n>solve_power</span><span class=p>(</span>
            <span class=n>effect_size</span><span class=o>=</span><span class=n>effect_size</span><span class=p>,</span>
            <span class=n>nobs1</span><span class=o>=</span><span class=n>n_per_group</span><span class=p>,</span>
            <span class=n>alpha</span><span class=o>=</span><span class=n>alpha</span><span class=p>,</span>
            <span class=n>ratio</span><span class=o>=</span><span class=mf>1.0</span>
        <span class=p>)</span>

        <span class=k>if</span> <span class=n>current_power</span> <span class=o>&lt;</span> <span class=n>power</span><span class=p>:</span>
            <span class=n>mde_low</span> <span class=o>=</span> <span class=n>mde_mid</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>mde_high</span> <span class=o>=</span> <span class=n>mde_mid</span>

    <span class=k>return</span> <span class=n>mde_high</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== MDE Analysis: What Can You Detect? =====&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Baseline CVR: </span><span class=si>{</span><span class=n>baseline_cvr</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>, Power: 80%, Œ±: 0.05&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=s1>&#39;Sample Size/Group&#39;</span><span class=si>:</span><span class=s2>&lt;20</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;MDE (absolute)&#39;</span><span class=si>:</span><span class=s2>&lt;15</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;MDE (relative)&#39;</span><span class=si>:</span><span class=s2>&lt;15</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;-&quot;</span> <span class=o>*</span> <span class=mi>50</span><span class=p>)</span>

<span class=k>for</span> <span class=n>n</span> <span class=ow>in</span> <span class=p>[</span><span class=mi>5000</span><span class=p>,</span> <span class=mi>10000</span><span class=p>,</span> <span class=mi>20000</span><span class=p>,</span> <span class=mi>50000</span><span class=p>]:</span>
    <span class=n>mde_abs</span> <span class=o>=</span> <span class=n>calculate_mde</span><span class=p>(</span><span class=n>baseline_cvr</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
    <span class=n>mde_rel</span> <span class=o>=</span> <span class=n>mde_abs</span> <span class=o>/</span> <span class=n>baseline_cvr</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>n</span><span class=si>:</span><span class=s2>&gt;12,</span><span class=si>}</span><span class=s2>        </span><span class=si>{</span><span class=n>mde_abs</span><span class=si>:</span><span class=s2>&gt;8.4f</span><span class=si>}</span><span class=s2>        </span><span class=si>{</span><span class=n>mde_rel</span><span class=si>:</span><span class=s2>&gt;8.1%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>()</span>

<span class=c1># ===== 4. Power vs significance level tradeoff =====</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== Power vs Significance Level Tradeoff =====&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Sample size: 20,000 per group, MDE: 5</span><span class=si>% r</span><span class=s2>elative lift&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=s1>&#39;Alpha (Œ±)&#39;</span><span class=si>:</span><span class=s2>&lt;10</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Power (1-Œ≤)&#39;</span><span class=si>:</span><span class=s2>&lt;12</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Type I Error&#39;</span><span class=si>:</span><span class=s2>&lt;15</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Type II Error&#39;</span><span class=si>:</span><span class=s2>&lt;15</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;-&quot;</span> <span class=o>*</span> <span class=mi>50</span><span class=p>)</span>

<span class=n>n_fixed</span> <span class=o>=</span> <span class=mi>20000</span>
<span class=n>alpha_levels</span> <span class=o>=</span> <span class=p>[</span><span class=mf>0.01</span><span class=p>,</span> <span class=mf>0.025</span><span class=p>,</span> <span class=mf>0.05</span><span class=p>,</span> <span class=mf>0.10</span><span class=p>,</span> <span class=mf>0.15</span><span class=p>]</span>

<span class=k>for</span> <span class=n>alpha</span> <span class=ow>in</span> <span class=n>alpha_levels</span><span class=p>:</span>
    <span class=n>pwr</span> <span class=o>=</span> <span class=n>calculate_power</span><span class=p>(</span><span class=n>baseline_cvr</span><span class=p>,</span> <span class=n>baseline_cvr</span> <span class=o>*</span> <span class=mf>1.05</span><span class=p>,</span> <span class=n>n_fixed</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=n>alpha</span><span class=p>)</span>
    <span class=n>type1_error</span> <span class=o>=</span> <span class=n>alpha</span>
    <span class=n>type2_error</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>-</span> <span class=n>pwr</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>alpha</span><span class=si>:</span><span class=s2>&gt;6.2f</span><span class=si>}</span><span class=s2>      </span><span class=si>{</span><span class=n>pwr</span><span class=si>:</span><span class=s2>&gt;6.1%</span><span class=si>}</span><span class=s2>        </span><span class=si>{</span><span class=n>type1_error</span><span class=si>:</span><span class=s2>&gt;6.1%</span><span class=si>}</span><span class=s2>          </span><span class=si>{</span><span class=n>type2_error</span><span class=si>:</span><span class=s2>&gt;6.1%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>()</span>

<span class=c1># ===== 5. Variance reduction impact on power =====</span>
<span class=c1># CUPED and stratification can reduce variance by 20-50%</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== Impact of Variance Reduction on Power =====&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Sample size: 15,000 per group, MDE: 5</span><span class=si>% r</span><span class=s2>elative lift&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=s1>&#39;Variance Reduction&#39;</span><span class=si>:</span><span class=s2>&lt;25</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Effective Sample Size&#39;</span><span class=si>:</span><span class=s2>&lt;25</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Power&#39;</span><span class=si>:</span><span class=s2>&lt;10</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;-&quot;</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>

<span class=n>n_base</span> <span class=o>=</span> <span class=mi>15000</span>
<span class=n>variance_reductions</span> <span class=o>=</span> <span class=p>[</span><span class=mf>0.0</span><span class=p>,</span> <span class=mf>0.20</span><span class=p>,</span> <span class=mf>0.30</span><span class=p>,</span> <span class=mf>0.40</span><span class=p>,</span> <span class=mf>0.50</span><span class=p>]</span>

<span class=k>for</span> <span class=n>var_red</span> <span class=ow>in</span> <span class=n>variance_reductions</span><span class=p>:</span>
    <span class=c1># Variance reduction effectively increases sample size</span>
    <span class=n>effective_n</span> <span class=o>=</span> <span class=n>n_base</span> <span class=o>/</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>var_red</span><span class=p>)</span> <span class=k>if</span> <span class=n>var_red</span> <span class=o>&lt;</span> <span class=mi>1</span> <span class=k>else</span> <span class=n>n_base</span> <span class=o>*</span> <span class=mi>2</span>
    <span class=n>pwr</span> <span class=o>=</span> <span class=n>calculate_power</span><span class=p>(</span><span class=n>baseline_cvr</span><span class=p>,</span> <span class=n>baseline_cvr</span> <span class=o>*</span> <span class=mf>1.05</span><span class=p>,</span> <span class=nb>int</span><span class=p>(</span><span class=n>effective_n</span><span class=p>))</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>var_red</span><span class=si>:</span><span class=s2>&gt;6.0%</span><span class=si>}</span><span class=s2>                  </span><span class=si>{</span><span class=n>effective_n</span><span class=si>:</span><span class=s2>&gt;15,.0f</span><span class=si>}</span><span class=s2>           </span><span class=si>{</span><span class=n>pwr</span><span class=si>:</span><span class=s2>&gt;6.1%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>()</span>

<span class=c1># ===== 6. Post-hoc power analysis (retrospective) =====</span>
<span class=c1># After experiment, calculate achieved power</span>
<span class=k>def</span><span class=w> </span><span class=nf>post_hoc_power</span><span class=p>(</span><span class=n>control_data</span><span class=p>,</span> <span class=n>treatment_data</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Calculate observed power from experiment data</span>

<span class=sd>    Args:</span>
<span class=sd>        control_data: Array of control group data</span>
<span class=sd>        treatment_data: Array of treatment group data</span>

<span class=sd>    Returns:</span>
<span class=sd>        Observed effect size and power</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=c1># Calculate observed effect</span>
    <span class=n>control_rate</span> <span class=o>=</span> <span class=n>control_data</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
    <span class=n>treatment_rate</span> <span class=o>=</span> <span class=n>treatment_data</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>

    <span class=n>effect_size</span> <span class=o>=</span> <span class=n>proportion_effectsize</span><span class=p>(</span><span class=n>control_rate</span><span class=p>,</span> <span class=n>treatment_rate</span><span class=p>)</span>
    <span class=n>n_control</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>control_data</span><span class=p>)</span>
    <span class=n>n_treatment</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>treatment_data</span><span class=p>)</span>

    <span class=n>analysis</span> <span class=o>=</span> <span class=n>TTestIndPower</span><span class=p>()</span>
    <span class=n>power</span> <span class=o>=</span> <span class=n>analysis</span><span class=o>.</span><span class=n>solve_power</span><span class=p>(</span>
        <span class=n>effect_size</span><span class=o>=</span><span class=n>effect_size</span><span class=p>,</span>
        <span class=n>nobs1</span><span class=o>=</span><span class=n>n_control</span><span class=p>,</span>
        <span class=n>alpha</span><span class=o>=</span><span class=n>alpha</span><span class=p>,</span>
        <span class=n>ratio</span><span class=o>=</span><span class=n>n_treatment</span> <span class=o>/</span> <span class=n>n_control</span>
    <span class=p>)</span>

    <span class=k>return</span> <span class=p>{</span>
        <span class=s1>&#39;control_rate&#39;</span><span class=p>:</span> <span class=n>control_rate</span><span class=p>,</span>
        <span class=s1>&#39;treatment_rate&#39;</span><span class=p>:</span> <span class=n>treatment_rate</span><span class=p>,</span>
        <span class=s1>&#39;effect_size&#39;</span><span class=p>:</span> <span class=n>effect_size</span><span class=p>,</span>
        <span class=s1>&#39;power&#39;</span><span class=p>:</span> <span class=n>power</span><span class=p>,</span>
        <span class=s1>&#39;n_control&#39;</span><span class=p>:</span> <span class=n>n_control</span><span class=p>,</span>
        <span class=s1>&#39;n_treatment&#39;</span><span class=p>:</span> <span class=n>n_treatment</span>
    <span class=p>}</span>

<span class=c1># Simulate experiment data</span>
<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
<span class=n>control_sample</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mf>0.10</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=mi>8000</span><span class=p>)</span>
<span class=n>treatment_sample</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mf>0.105</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=mi>8000</span><span class=p>)</span>

<span class=n>post_hoc</span> <span class=o>=</span> <span class=n>post_hoc_power</span><span class=p>(</span><span class=n>control_sample</span><span class=p>,</span> <span class=n>treatment_sample</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== Post-Hoc Power Analysis (After Experiment) =====&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Control rate: </span><span class=si>{</span><span class=n>post_hoc</span><span class=p>[</span><span class=s1>&#39;control_rate&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Treatment rate: </span><span class=si>{</span><span class=n>post_hoc</span><span class=p>[</span><span class=s1>&#39;treatment_rate&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Observed lift: </span><span class=si>{</span><span class=mi>100</span><span class=o>*</span><span class=p>(</span><span class=n>post_hoc</span><span class=p>[</span><span class=s1>&#39;treatment_rate&#39;</span><span class=p>]</span><span class=o>/</span><span class=n>post_hoc</span><span class=p>[</span><span class=s1>&#39;control_rate&#39;</span><span class=p>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Effect size (Cohen&#39;s h): </span><span class=si>{</span><span class=n>post_hoc</span><span class=p>[</span><span class=s1>&#39;effect_size&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Sample size: </span><span class=si>{</span><span class=n>post_hoc</span><span class=p>[</span><span class=s1>&#39;n_control&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> per group&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Achieved power: </span><span class=si>{</span><span class=n>post_hoc</span><span class=p>[</span><span class=s1>&#39;power&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Interpretation: </span><span class=si>{</span><span class=s1>&#39;Under-powered&#39;</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>post_hoc</span><span class=p>[</span><span class=s1>&#39;power&#39;</span><span class=p>]</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mf>0.8</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=s1>&#39;Adequately powered&#39;</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</code></pre></div> <table> <thead> <tr> <th>Power Level</th> <th>Type II Error (Œ≤)</th> <th>Chance of Missing Real Effect</th> <th>Use Case</th> </tr> </thead> <tbody> <tr> <td><strong>70%</strong></td> <td>30%</td> <td>3 in 10 real wins missed</td> <td>Exploratory, low-risk tests</td> </tr> <tr> <td><strong>80%</strong></td> <td>20%</td> <td>1 in 5 real wins missed</td> <td>Standard (most A/B tests)</td> </tr> <tr> <td><strong>90%</strong></td> <td>10%</td> <td>1 in 10 real wins missed</td> <td>High-stakes (payments, core UX)</td> </tr> <tr> <td><strong>95%</strong></td> <td>5%</td> <td>1 in 20 real wins missed</td> <td>Safety-critical, regulatory</td> </tr> </tbody> </table> <table> <thead> <tr> <th>Sample Size/Group</th> <th>Power (5% lift)</th> <th>Power (10% lift)</th> <th>Power (20% lift)</th> </tr> </thead> <tbody> <tr> <td><strong>5,000</strong></td> <td>53%</td> <td>85%</td> <td>99.9%</td> </tr> <tr> <td><strong>10,000</strong></td> <td>71%</td> <td>97%</td> <td>99.9%</td> </tr> <tr> <td><strong>20,000</strong></td> <td>89%</td> <td>99.9%</td> <td>99.9%</td> </tr> <tr> <td><strong>50,000</strong></td> <td>99%</td> <td>99.9%</td> <td>99.9%</td> </tr> </tbody> </table> <p><strong>Real-World:</strong> - <strong>Netflix:</strong> Uses <strong>90% power</strong> for homepage experiments (high impact). Average power: 85-90% across all tests. - <strong>Google:</strong> Targets <strong>80% power</strong> for search quality tests. Post-hoc analysis shows actual power = 75-85% (due to smaller observed effects). - <strong>Booking.com:</strong> <strong>80% power standard</strong>, increases to 90% for payment flow. Uses CUPED to achieve +30-40% effective power boost.</p> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <ul> <li>Knows <strong>80% is industry standard</strong> (balance between sample size and missing real effects)</li> <li>Understands <strong>power tradeoff with sample size</strong> (80% ‚Üí 90% power = +30% samples)</li> <li>Uses <strong>post-hoc power analysis</strong> to validate experiments weren't under-powered</li> <li>Real-world: <strong>Airbnb runs power analysis before every experiment; flags tests below 70% power for re-scoping</strong></li> </ul> </div> </details> <hr> <h3 id=what-is-srm-sample-ratio-mismatch-microsoft-linkedin-interview-question>What is SRM (Sample Ratio Mismatch)? - Microsoft, LinkedIn Interview Question</h3> <p><strong>Difficulty:</strong> üî¥ Hard | <strong>Tags:</strong> <code>Debugging</code> | <strong>Asked by:</strong> Microsoft, LinkedIn, Meta</p> <details class=success> <summary>View Answer</summary> <p><strong>Sample Ratio Mismatch (SRM)</strong> occurs when the <strong>observed ratio</strong> of users in control vs treatment <strong>deviates significantly</strong> from the <strong>expected ratio</strong> (e.g., expecting 50/50 but observing 48/52). SRM is a <strong>critical quality check</strong> ‚Äî if detected, the experiment is <strong>invalidated</strong> and results cannot be trusted. Always check SRM <strong>before</strong> analyzing metrics.</p> <p><strong>SRM = Unequal split between control/treatment (when expecting equal)</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy.stats</span><span class=w> </span><span class=kn>import</span> <span class=n>chi2_contingency</span><span class=p>,</span> <span class=n>chisquare</span>
<span class=kn>import</span><span class=w> </span><span class=nn>matplotlib.pyplot</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>plt</span>

<span class=c1># Production: SRM Detection and Debugging Pipeline</span>

<span class=c1># ===== 1. Basic SRM Check (Chi-square test) =====</span>
<span class=k>def</span><span class=w> </span><span class=nf>check_srm</span><span class=p>(</span><span class=n>n_control</span><span class=p>,</span> <span class=n>n_treatment</span><span class=p>,</span> <span class=n>expected_ratio</span><span class=o>=</span><span class=mf>0.5</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.001</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Check for Sample Ratio Mismatch using chi-square test</span>

<span class=sd>    Args:</span>
<span class=sd>        n_control: Number of users in control</span>
<span class=sd>        n_treatment: Number of users in treatment</span>
<span class=sd>        expected_ratio: Expected proportion for control (default 0.5 for 50/50)</span>
<span class=sd>        alpha: Significance level (default 0.001, very strict)</span>

<span class=sd>    Returns:</span>
<span class=sd>        Dictionary with SRM results</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=n>total</span> <span class=o>=</span> <span class=n>n_control</span> <span class=o>+</span> <span class=n>n_treatment</span>
    <span class=n>expected_control</span> <span class=o>=</span> <span class=n>total</span> <span class=o>*</span> <span class=n>expected_ratio</span>
    <span class=n>expected_treatment</span> <span class=o>=</span> <span class=n>total</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>expected_ratio</span><span class=p>)</span>

    <span class=c1># Chi-square test</span>
    <span class=n>observed</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=n>n_control</span><span class=p>,</span> <span class=n>n_treatment</span><span class=p>])</span>
    <span class=n>expected</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=n>expected_control</span><span class=p>,</span> <span class=n>expected_treatment</span><span class=p>])</span>

    <span class=n>chi2_stat</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sum</span><span class=p>((</span><span class=n>observed</span> <span class=o>-</span> <span class=n>expected</span><span class=p>)</span><span class=o>**</span><span class=mi>2</span> <span class=o>/</span> <span class=n>expected</span><span class=p>)</span>
    <span class=n>p_value</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>-</span> <span class=n>stats</span><span class=o>.</span><span class=n>chi2</span><span class=o>.</span><span class=n>cdf</span><span class=p>(</span><span class=n>chi2_stat</span><span class=p>,</span> <span class=n>df</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>

    <span class=c1># Observed ratio</span>
    <span class=n>observed_ratio</span> <span class=o>=</span> <span class=n>n_control</span> <span class=o>/</span> <span class=n>total</span>

    <span class=k>return</span> <span class=p>{</span>
        <span class=s1>&#39;n_control&#39;</span><span class=p>:</span> <span class=n>n_control</span><span class=p>,</span>
        <span class=s1>&#39;n_treatment&#39;</span><span class=p>:</span> <span class=n>n_treatment</span><span class=p>,</span>
        <span class=s1>&#39;total&#39;</span><span class=p>:</span> <span class=n>total</span><span class=p>,</span>
        <span class=s1>&#39;expected_ratio&#39;</span><span class=p>:</span> <span class=n>expected_ratio</span><span class=p>,</span>
        <span class=s1>&#39;observed_ratio&#39;</span><span class=p>:</span> <span class=n>observed_ratio</span><span class=p>,</span>
        <span class=s1>&#39;chi2_stat&#39;</span><span class=p>:</span> <span class=n>chi2_stat</span><span class=p>,</span>
        <span class=s1>&#39;p_value&#39;</span><span class=p>:</span> <span class=n>p_value</span><span class=p>,</span>
        <span class=s1>&#39;srm_detected&#39;</span><span class=p>:</span> <span class=n>p_value</span> <span class=o>&lt;</span> <span class=n>alpha</span><span class=p>,</span>
        <span class=s1>&#39;deviation_pct&#39;</span><span class=p>:</span> <span class=mi>100</span> <span class=o>*</span> <span class=nb>abs</span><span class=p>(</span><span class=n>observed_ratio</span> <span class=o>-</span> <span class=n>expected_ratio</span><span class=p>)</span> <span class=o>/</span> <span class=n>expected_ratio</span>
    <span class=p>}</span>

<span class=c1># Example 1: No SRM (healthy experiment)</span>
<span class=n>result_healthy</span> <span class=o>=</span> <span class=n>check_srm</span><span class=p>(</span><span class=n>n_control</span><span class=o>=</span><span class=mi>10050</span><span class=p>,</span> <span class=n>n_treatment</span><span class=o>=</span><span class=mi>9950</span><span class=p>,</span> <span class=n>expected_ratio</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== Example 1: Healthy Experiment (No SRM) =====&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Control: </span><span class=si>{</span><span class=n>result_healthy</span><span class=p>[</span><span class=s1>&#39;n_control&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>, Treatment: </span><span class=si>{</span><span class=n>result_healthy</span><span class=p>[</span><span class=s1>&#39;n_treatment&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Expected ratio: </span><span class=si>{</span><span class=n>result_healthy</span><span class=p>[</span><span class=s1>&#39;expected_ratio&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Observed ratio: </span><span class=si>{</span><span class=n>result_healthy</span><span class=p>[</span><span class=s1>&#39;observed_ratio&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Deviation: </span><span class=si>{</span><span class=n>result_healthy</span><span class=p>[</span><span class=s1>&#39;deviation_pct&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Chi-square statistic: </span><span class=si>{</span><span class=n>result_healthy</span><span class=p>[</span><span class=s1>&#39;chi2_stat&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;p-value: </span><span class=si>{</span><span class=n>result_healthy</span><span class=p>[</span><span class=s1>&#39;p_value&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.6f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;SRM Detected: </span><span class=si>{</span><span class=n>result_healthy</span><span class=p>[</span><span class=s1>&#39;srm_detected&#39;</span><span class=p>]</span><span class=si>}</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Example 2: SRM Detected (problematic experiment)</span>
<span class=n>result_srm</span> <span class=o>=</span> <span class=n>check_srm</span><span class=p>(</span><span class=n>n_control</span><span class=o>=</span><span class=mi>10500</span><span class=p>,</span> <span class=n>n_treatment</span><span class=o>=</span><span class=mi>9500</span><span class=p>,</span> <span class=n>expected_ratio</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== Example 2: SRM Detected (STOP EXPERIMENT) =====&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Control: </span><span class=si>{</span><span class=n>result_srm</span><span class=p>[</span><span class=s1>&#39;n_control&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>, Treatment: </span><span class=si>{</span><span class=n>result_srm</span><span class=p>[</span><span class=s1>&#39;n_treatment&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Expected ratio: </span><span class=si>{</span><span class=n>result_srm</span><span class=p>[</span><span class=s1>&#39;expected_ratio&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Observed ratio: </span><span class=si>{</span><span class=n>result_srm</span><span class=p>[</span><span class=s1>&#39;observed_ratio&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Deviation: </span><span class=si>{</span><span class=n>result_srm</span><span class=p>[</span><span class=s1>&#39;deviation_pct&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Chi-square statistic: </span><span class=si>{</span><span class=n>result_srm</span><span class=p>[</span><span class=s1>&#39;chi2_stat&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;p-value: </span><span class=si>{</span><span class=n>result_srm</span><span class=p>[</span><span class=s1>&#39;p_value&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.6f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;SRM Detected: </span><span class=si>{</span><span class=s1>&#39;‚ö†Ô∏è YES - STOP AND DEBUG&#39;</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>result_srm</span><span class=p>[</span><span class=s1>&#39;srm_detected&#39;</span><span class=p>]</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=s1>&#39;No&#39;</span><span class=si>}</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># ===== 2. SRM Check by Segment (debugging) =====</span>
<span class=c1># Check SRM within different user segments to isolate root cause</span>
<span class=k>def</span><span class=w> </span><span class=nf>check_srm_by_segment</span><span class=p>(</span><span class=n>df</span><span class=p>,</span> <span class=n>segment_col</span><span class=p>,</span> <span class=n>expected_ratio</span><span class=o>=</span><span class=mf>0.5</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Check SRM for each segment to identify where mismatch occurs</span>

<span class=sd>    Args:</span>
<span class=sd>        df: DataFrame with columns [segment_col, &#39;group&#39;]</span>
<span class=sd>        segment_col: Column name for segmentation (e.g., &#39;device&#39;, &#39;country&#39;)</span>

<span class=sd>    Returns:</span>
<span class=sd>        DataFrame with SRM results per segment</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=n>results</span> <span class=o>=</span> <span class=p>[]</span>

    <span class=k>for</span> <span class=n>segment</span> <span class=ow>in</span> <span class=n>df</span><span class=p>[</span><span class=n>segment_col</span><span class=p>]</span><span class=o>.</span><span class=n>unique</span><span class=p>():</span>
        <span class=n>segment_data</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=n>segment_col</span><span class=p>]</span> <span class=o>==</span> <span class=n>segment</span><span class=p>]</span>
        <span class=n>n_control</span> <span class=o>=</span> <span class=p>(</span><span class=n>segment_data</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;control&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
        <span class=n>n_treatment</span> <span class=o>=</span> <span class=p>(</span><span class=n>segment_data</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>

        <span class=n>srm_result</span> <span class=o>=</span> <span class=n>check_srm</span><span class=p>(</span><span class=n>n_control</span><span class=p>,</span> <span class=n>n_treatment</span><span class=p>,</span> <span class=n>expected_ratio</span><span class=p>)</span>
        <span class=n>srm_result</span><span class=p>[</span><span class=s1>&#39;segment&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>segment</span>
        <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>srm_result</span><span class=p>)</span>

    <span class=k>return</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>results</span><span class=p>)</span>

<span class=c1># Simulate experiment data with SRM in mobile users</span>
<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
<span class=n>n_users</span> <span class=o>=</span> <span class=mi>20000</span>

<span class=c1># Desktop users: healthy 50/50 split</span>
<span class=n>desktop</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
    <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=nb>range</span><span class=p>(</span><span class=mi>12000</span><span class=p>),</span>
    <span class=s1>&#39;device&#39;</span><span class=p>:</span> <span class=s1>&#39;desktop&#39;</span><span class=p>,</span>
    <span class=s1>&#39;group&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>([</span><span class=s1>&#39;control&#39;</span><span class=p>,</span> <span class=s1>&#39;treatment&#39;</span><span class=p>],</span> <span class=n>size</span><span class=o>=</span><span class=mi>12000</span><span class=p>,</span> <span class=n>p</span><span class=o>=</span><span class=p>[</span><span class=mf>0.50</span><span class=p>,</span> <span class=mf>0.50</span><span class=p>])</span>
<span class=p>})</span>

<span class=c1># Mobile users: SRM (bot filtering affected treatment more)</span>
<span class=n>mobile</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
    <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=nb>range</span><span class=p>(</span><span class=mi>12000</span><span class=p>,</span> <span class=mi>20000</span><span class=p>),</span>
    <span class=s1>&#39;device&#39;</span><span class=p>:</span> <span class=s1>&#39;mobile&#39;</span><span class=p>,</span>
    <span class=s1>&#39;group&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>([</span><span class=s1>&#39;control&#39;</span><span class=p>,</span> <span class=s1>&#39;treatment&#39;</span><span class=p>],</span> <span class=n>size</span><span class=o>=</span><span class=mi>8000</span><span class=p>,</span> <span class=n>p</span><span class=o>=</span><span class=p>[</span><span class=mf>0.55</span><span class=p>,</span> <span class=mf>0.45</span><span class=p>])</span>  <span class=c1># SRM!</span>
<span class=p>})</span>

<span class=n>df_experiment</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>([</span><span class=n>desktop</span><span class=p>,</span> <span class=n>mobile</span><span class=p>],</span> <span class=n>ignore_index</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== SRM Check by Device Segment =====&quot;</span><span class=p>)</span>
<span class=n>srm_by_device</span> <span class=o>=</span> <span class=n>check_srm_by_segment</span><span class=p>(</span><span class=n>df_experiment</span><span class=p>,</span> <span class=s1>&#39;device&#39;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>srm_by_device</span><span class=p>[[</span><span class=s1>&#39;segment&#39;</span><span class=p>,</span> <span class=s1>&#39;n_control&#39;</span><span class=p>,</span> <span class=s1>&#39;n_treatment&#39;</span><span class=p>,</span> <span class=s1>&#39;observed_ratio&#39;</span><span class=p>,</span> <span class=s1>&#39;deviation_pct&#39;</span><span class=p>,</span> <span class=s1>&#39;p_value&#39;</span><span class=p>,</span> <span class=s1>&#39;srm_detected&#39;</span><span class=p>]]</span><span class=o>.</span><span class=n>to_string</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>))</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Diagnosis: SRM detected in MOBILE users only ‚Üí likely bot filtering or device compatibility issue</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># ===== 3. SRM Check Over Time (detect when SRM started) =====</span>
<span class=k>def</span><span class=w> </span><span class=nf>check_srm_over_time</span><span class=p>(</span><span class=n>df_time</span><span class=p>,</span> <span class=n>date_col</span><span class=o>=</span><span class=s1>&#39;date&#39;</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Check SRM for each day to identify when mismatch began</span>

<span class=sd>    Args:</span>
<span class=sd>        df_time: DataFrame with columns [date_col, &#39;group&#39;]</span>

<span class=sd>    Returns:</span>
<span class=sd>        DataFrame with daily SRM results</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=n>results</span> <span class=o>=</span> <span class=p>[]</span>

    <span class=k>for</span> <span class=n>date</span> <span class=ow>in</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>df_time</span><span class=p>[</span><span class=n>date_col</span><span class=p>]</span><span class=o>.</span><span class=n>unique</span><span class=p>()):</span>
        <span class=n>day_data</span> <span class=o>=</span> <span class=n>df_time</span><span class=p>[</span><span class=n>df_time</span><span class=p>[</span><span class=n>date_col</span><span class=p>]</span> <span class=o>==</span> <span class=n>date</span><span class=p>]</span>
        <span class=n>n_control</span> <span class=o>=</span> <span class=p>(</span><span class=n>day_data</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;control&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
        <span class=n>n_treatment</span> <span class=o>=</span> <span class=p>(</span><span class=n>day_data</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>

        <span class=n>srm_result</span> <span class=o>=</span> <span class=n>check_srm</span><span class=p>(</span><span class=n>n_control</span><span class=p>,</span> <span class=n>n_treatment</span><span class=p>)</span>
        <span class=n>srm_result</span><span class=p>[</span><span class=s1>&#39;date&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>date</span>
        <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>srm_result</span><span class=p>)</span>

    <span class=k>return</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>results</span><span class=p>)</span>

<span class=c1># Simulate 7-day experiment where SRM appears on day 5</span>
<span class=n>dates</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>date_range</span><span class=p>(</span><span class=s1>&#39;2024-01-01&#39;</span><span class=p>,</span> <span class=n>periods</span><span class=o>=</span><span class=mi>7</span><span class=p>,</span> <span class=n>freq</span><span class=o>=</span><span class=s1>&#39;D&#39;</span><span class=p>)</span>
<span class=n>df_daily</span> <span class=o>=</span> <span class=p>[]</span>

<span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>date</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>dates</span><span class=p>):</span>
    <span class=k>if</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>4</span><span class=p>:</span>
        <span class=c1># Days 1-4: healthy</span>
        <span class=n>daily_users</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
            <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=nb>range</span><span class=p>(</span><span class=n>i</span><span class=o>*</span><span class=mi>3000</span><span class=p>,</span> <span class=p>(</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=mi>3000</span><span class=p>),</span>
            <span class=s1>&#39;date&#39;</span><span class=p>:</span> <span class=n>date</span><span class=p>,</span>
            <span class=s1>&#39;group&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>([</span><span class=s1>&#39;control&#39;</span><span class=p>,</span> <span class=s1>&#39;treatment&#39;</span><span class=p>],</span> <span class=n>size</span><span class=o>=</span><span class=mi>3000</span><span class=p>,</span> <span class=n>p</span><span class=o>=</span><span class=p>[</span><span class=mf>0.50</span><span class=p>,</span> <span class=mf>0.50</span><span class=p>])</span>
        <span class=p>})</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=c1># Days 5-7: SRM (code change broke randomization)</span>
        <span class=n>daily_users</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
            <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=nb>range</span><span class=p>(</span><span class=n>i</span><span class=o>*</span><span class=mi>3000</span><span class=p>,</span> <span class=p>(</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=mi>3000</span><span class=p>),</span>
            <span class=s1>&#39;date&#39;</span><span class=p>:</span> <span class=n>date</span><span class=p>,</span>
            <span class=s1>&#39;group&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>([</span><span class=s1>&#39;control&#39;</span><span class=p>,</span> <span class=s1>&#39;treatment&#39;</span><span class=p>],</span> <span class=n>size</span><span class=o>=</span><span class=mi>3000</span><span class=p>,</span> <span class=n>p</span><span class=o>=</span><span class=p>[</span><span class=mf>0.45</span><span class=p>,</span> <span class=mf>0.55</span><span class=p>])</span>
        <span class=p>})</span>
    <span class=n>df_daily</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>daily_users</span><span class=p>)</span>

<span class=n>df_daily</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>(</span><span class=n>df_daily</span><span class=p>,</span> <span class=n>ignore_index</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== SRM Check Over Time (Daily) =====&quot;</span><span class=p>)</span>
<span class=n>srm_daily</span> <span class=o>=</span> <span class=n>check_srm_over_time</span><span class=p>(</span><span class=n>df_daily</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>srm_daily</span><span class=p>[[</span><span class=s1>&#39;date&#39;</span><span class=p>,</span> <span class=s1>&#39;n_control&#39;</span><span class=p>,</span> <span class=s1>&#39;n_treatment&#39;</span><span class=p>,</span> <span class=s1>&#39;observed_ratio&#39;</span><span class=p>,</span> <span class=s1>&#39;p_value&#39;</span><span class=p>,</span> <span class=s1>&#39;srm_detected&#39;</span><span class=p>]]</span><span class=o>.</span><span class=n>to_string</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>))</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Diagnosis: SRM started on 2024-01-05 ‚Üí likely code deployment or config change on that date</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># ===== 4. Continuous SRM Monitoring (production dashboard) =====</span>
<span class=k>def</span><span class=w> </span><span class=nf>srm_alert_threshold</span><span class=p>(</span><span class=n>total_users</span><span class=p>,</span> <span class=n>expected_ratio</span><span class=o>=</span><span class=mf>0.5</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.001</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Calculate acceptable range for control users (no SRM)</span>

<span class=sd>    Returns:</span>
<span class=sd>        (lower_bound, upper_bound) for number of control users</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=n>expected_control</span> <span class=o>=</span> <span class=n>total_users</span> <span class=o>*</span> <span class=n>expected_ratio</span>

    <span class=c1># Using normal approximation for large n</span>
    <span class=n>se</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>total_users</span> <span class=o>*</span> <span class=n>expected_ratio</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>expected_ratio</span><span class=p>))</span>
    <span class=n>z</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>norm</span><span class=o>.</span><span class=n>ppf</span><span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>alpha</span><span class=o>/</span><span class=mi>2</span><span class=p>)</span>  <span class=c1># Two-tailed</span>

    <span class=n>lower</span> <span class=o>=</span> <span class=n>expected_control</span> <span class=o>-</span> <span class=n>z</span> <span class=o>*</span> <span class=n>se</span>
    <span class=n>upper</span> <span class=o>=</span> <span class=n>expected_control</span> <span class=o>+</span> <span class=n>z</span> <span class=o>*</span> <span class=n>se</span>

    <span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>floor</span><span class=p>(</span><span class=n>lower</span><span class=p>)),</span> <span class=nb>int</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>ceil</span><span class=p>(</span><span class=n>upper</span><span class=p>))</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== SRM Alert Thresholds (Production Monitoring) =====&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=s1>&#39;Total Users&#39;</span><span class=si>:</span><span class=s2>&lt;15</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Expected Control&#39;</span><span class=si>:</span><span class=s2>&lt;18</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Acceptable Range (99.9% CI)&#39;</span><span class=si>:</span><span class=s2>&lt;35</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;-&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>

<span class=k>for</span> <span class=n>total</span> <span class=ow>in</span> <span class=p>[</span><span class=mi>10000</span><span class=p>,</span> <span class=mi>50000</span><span class=p>,</span> <span class=mi>100000</span><span class=p>,</span> <span class=mi>500000</span><span class=p>]:</span>
    <span class=n>expected_ctrl</span> <span class=o>=</span> <span class=n>total</span> <span class=o>*</span> <span class=mf>0.5</span>
    <span class=n>lower</span><span class=p>,</span> <span class=n>upper</span> <span class=o>=</span> <span class=n>srm_alert_threshold</span><span class=p>(</span><span class=n>total</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>total</span><span class=si>:</span><span class=s2>&gt;10,</span><span class=si>}</span><span class=s2>      </span><span class=si>{</span><span class=n>expected_ctrl</span><span class=si>:</span><span class=s2>&gt;10,.0f</span><span class=si>}</span><span class=s2>        [</span><span class=si>{</span><span class=n>lower</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> - </span><span class=si>{</span><span class=n>upper</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>]&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>()</span>

<span class=c1># ===== 5. Common SRM Root Causes and Debugging =====</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== Common SRM Root Causes =====&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&quot;&quot;</span>
<span class=s2>1. RANDOMIZATION BUGS</span>
<span class=s2>   - Hash collision (user ID % 2 not perfectly random)</span>
<span class=s2>   - Cookie issues (treatment cookie not set correctly)</span>
<span class=s2>   - Server-side vs client-side mismatch</span>

<span class=s2>2. BOT FILTERING</span>
<span class=s2>   - Bots filtered more in one group (e.g., bot detection flag added mid-experiment)</span>
<span class=s2>   - Anti-fraud rules differ by variant</span>

<span class=s2>3. BROWSER/DEVICE COMPATIBILITY</span>
<span class=s2>   - Treatment code crashes on certain browsers ‚Üí users drop out</span>
<span class=s2>   - Mobile app version incompatibility</span>

<span class=s2>4. EXPERIMENT INTERACTION</span>
<span class=s2>   - Another experiment running affects assignment</span>
<span class=s2>   - Triggered experiments (only some users eligible)</span>

<span class=s2>5. DATA PIPELINE ISSUES</span>
<span class=s2>   - Logging inconsistency between groups</span>
<span class=s2>   - Data loss in one variant</span>

<span class=s2>DEBUGGING STEPS:</span>
<span class=s2>1. Check SRM by segment (device, browser, country, day)</span>
<span class=s2>2. Review code changes around SRM start date</span>
<span class=s2>3. Verify randomization logic (run A/A test)</span>
<span class=s2>4. Check bot filtering and fraud rules</span>
<span class=s2>5. Validate experiment eligibility criteria</span>
<span class=s2>&quot;&quot;&quot;</span><span class=p>)</span>
</code></pre></div> <table> <thead> <tr> <th>SRM Severity</th> <th>p-value</th> <th>Deviation</th> <th>Action</th> </tr> </thead> <tbody> <tr> <td><strong>No SRM</strong></td> <td>&gt; 0.001</td> <td>&lt; 0.5%</td> <td>Proceed with analysis</td> </tr> <tr> <td><strong>Borderline</strong></td> <td>0.0001 - 0.001</td> <td>0.5-1%</td> <td>Investigate, use caution</td> </tr> <tr> <td><strong>Moderate SRM</strong></td> <td>&lt; 0.0001</td> <td>1-3%</td> <td>Debug before shipping</td> </tr> <tr> <td><strong>Severe SRM</strong></td> <td>&lt;&lt; 0.0001</td> <td>&gt; 3%</td> <td>STOP experiment, results invalid</td> </tr> </tbody> </table> <table> <thead> <tr> <th>SRM Detection Method</th> <th>Use Case</th> <th>Tool</th> </tr> </thead> <tbody> <tr> <td><strong>Overall chi-square</strong></td> <td>Basic SRM check</td> <td><code>scipy.stats.chisquare</code></td> </tr> <tr> <td><strong>By segment</strong></td> <td>Isolate root cause (device, country)</td> <td>Segment analysis</td> </tr> <tr> <td><strong>Over time</strong></td> <td>Find when SRM started</td> <td>Daily chi-square</td> </tr> <tr> <td><strong>Real-time monitoring</strong></td> <td>Production dashboard</td> <td>Alert thresholds</td> </tr> </tbody> </table> <p><strong>Real-World:</strong> - <strong>Microsoft:</strong> Detected SRM in 6% of experiments. Most common cause: bot filtering differences (35% of SRM cases). - <strong>Booking.com:</strong> Auto-flags SRM with p &lt; 0.001. Average investigation time: 2-4 hours. Root cause: randomization bugs (40%), data pipeline (30%), device issues (20%). - <strong>Netflix:</strong> SRM detection saved ~$5M in 2023 by catching invalid tests early. Uses automated Slack alerts for SRM p &lt; 0.0001.</p> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <ul> <li><strong>Always checks SRM before analyzing metrics</strong> (first step in any A/B test analysis)</li> <li>Uses <strong>p &lt; 0.001 threshold</strong> (stricter than 0.05 to avoid false alarms)</li> <li>Knows to <strong>segment SRM by device, country, date</strong> to isolate root cause</li> <li>Real-world: <strong>Google sees SRM in 2-3% of experiments; most common = logging bugs</strong></li> </ul> </div> </details> <hr> <h3 id=explain-type-i-and-type-ii-errors-most-tech-companies-interview-question>Explain Type I and Type II Errors - Most Tech Companies Interview Question</h3> <p><strong>Difficulty:</strong> üü¢ Easy | <strong>Tags:</strong> <code>Statistics</code> | <strong>Asked by:</strong> Most Tech Companies</p> <details class=success> <summary>View Answer</summary> <p><strong>Type I and Type II errors</strong> represent the two fundamental <strong>mistakes</strong> in hypothesis testing. Type I (Œ±) = <strong>false positive</strong> (shipping bad features), Type II (Œ≤) = <strong>false negative</strong> (missing good features). In A/B testing, you control Œ± directly (set to 0.05) but Œ≤ depends on <strong>sample size, effect size, and variance</strong>.</p> <table> <thead> <tr> <th>Error</th> <th>Name</th> <th>Description</th> <th>Rate</th> <th>A/B Testing Impact</th> </tr> </thead> <tbody> <tr> <td><strong>Type I (Œ±)</strong></td> <td>False Positive</td> <td>Reject <span class=arithmatex>\(H_0\)</span> when true</td> <td>0.05 (5%)</td> <td>Ship feature that doesn't help (or hurts)</td> </tr> <tr> <td><strong>Type II (Œ≤)</strong></td> <td>False Negative</td> <td>Fail to reject <span class=arithmatex>\(H_0\)</span> when false</td> <td>0.20 (20%)</td> <td>Miss a winning feature</td> </tr> </tbody> </table> <p><strong>Power = 1 - Œ≤ = 80%</strong> (standard)</p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>from</span><span class=w> </span><span class=nn>statsmodels.stats.power</span><span class=w> </span><span class=kn>import</span> <span class=n>TTestIndPower</span>
<span class=kn>from</span><span class=w> </span><span class=nn>statsmodels.stats.proportion</span><span class=w> </span><span class=kn>import</span> <span class=n>proportions_ztest</span><span class=p>,</span> <span class=n>proportion_effectsize</span>
<span class=kn>import</span><span class=w> </span><span class=nn>matplotlib.pyplot</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>plt</span>

<span class=c1># Production: Type I/II Error Analysis and Simulation</span>

<span class=c1># ===== 1. Simulate Type I Errors (False Positives) =====</span>
<span class=c1># Run 1000 A/A tests (no real effect) and count false positives</span>
<span class=k>def</span><span class=w> </span><span class=nf>simulate_type1_errors</span><span class=p>(</span><span class=n>n_simulations</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span> <span class=n>n_per_group</span><span class=o>=</span><span class=mi>5000</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Simulate Type I error rate with A/A tests (H0 is true)</span>

<span class=sd>    Returns:</span>
<span class=sd>        Empirical Type I error rate</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
    <span class=n>false_positives</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=n>baseline_rate</span> <span class=o>=</span> <span class=mf>0.10</span>

    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_simulations</span><span class=p>):</span>
        <span class=c1># Both groups same (H0 true)</span>
        <span class=n>control</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>baseline_rate</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n_per_group</span><span class=p>)</span>
        <span class=n>treatment</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>baseline_rate</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n_per_group</span><span class=p>)</span>

        <span class=c1># Test</span>
        <span class=n>_</span><span class=p>,</span> <span class=n>p_value</span> <span class=o>=</span> <span class=n>proportions_ztest</span><span class=p>(</span>
            <span class=p>[</span><span class=n>treatment</span><span class=o>.</span><span class=n>sum</span><span class=p>(),</span> <span class=n>control</span><span class=o>.</span><span class=n>sum</span><span class=p>()],</span>
            <span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>),</span> <span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>)]</span>
        <span class=p>)</span>

        <span class=k>if</span> <span class=n>p_value</span> <span class=o>&lt;</span> <span class=n>alpha</span><span class=p>:</span>
            <span class=n>false_positives</span> <span class=o>+=</span> <span class=mi>1</span>

    <span class=k>return</span> <span class=n>false_positives</span> <span class=o>/</span> <span class=n>n_simulations</span>

<span class=n>type1_rate</span> <span class=o>=</span> <span class=n>simulate_type1_errors</span><span class=p>(</span><span class=n>n_simulations</span><span class=o>=</span><span class=mi>1000</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== Type I Error Simulation (A/A Tests) =====&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Expected Type I error rate (Œ±): 5.0%&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Observed Type I error rate: </span><span class=si>{</span><span class=mi>100</span><span class=o>*</span><span class=n>type1_rate</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Result: </span><span class=si>{</span><span class=s1>&#39;‚úì Matches expected&#39;</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=nb>abs</span><span class=p>(</span><span class=n>type1_rate</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mf>0.05</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mf>0.01</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=s1>&#39;‚úó Calibration issue&#39;</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Interpretation: In </span><span class=si>{</span><span class=mi>1000</span><span class=si>}</span><span class=s2> A/A tests, we falsely rejected H0 </span><span class=si>{</span><span class=nb>int</span><span class=p>(</span><span class=n>type1_rate</span><span class=o>*</span><span class=mi>1000</span><span class=p>)</span><span class=si>}</span><span class=s2> times</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># ===== 2. Simulate Type II Errors (False Negatives) =====</span>
<span class=c1># Run tests with real effect, count how often we miss it</span>
<span class=k>def</span><span class=w> </span><span class=nf>simulate_type2_errors</span><span class=p>(</span><span class=n>n_simulations</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span> <span class=n>n_per_group</span><span class=o>=</span><span class=mi>5000</span><span class=p>,</span>
                          <span class=n>baseline_rate</span><span class=o>=</span><span class=mf>0.10</span><span class=p>,</span> <span class=n>effect_size_rel</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Simulate Type II error rate with A/B tests (H0 is false, H1 is true)</span>

<span class=sd>    Returns:</span>
<span class=sd>        Empirical Type II error rate and power</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
    <span class=n>true_positives</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=n>treatment_rate</span> <span class=o>=</span> <span class=n>baseline_rate</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>effect_size_rel</span><span class=p>)</span>

    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_simulations</span><span class=p>):</span>
        <span class=c1># Real effect exists (H1 true)</span>
        <span class=n>control</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>baseline_rate</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n_per_group</span><span class=p>)</span>
        <span class=n>treatment</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>treatment_rate</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n_per_group</span><span class=p>)</span>

        <span class=c1># Test</span>
        <span class=n>_</span><span class=p>,</span> <span class=n>p_value</span> <span class=o>=</span> <span class=n>proportions_ztest</span><span class=p>(</span>
            <span class=p>[</span><span class=n>treatment</span><span class=o>.</span><span class=n>sum</span><span class=p>(),</span> <span class=n>control</span><span class=o>.</span><span class=n>sum</span><span class=p>()],</span>
            <span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>),</span> <span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>)]</span>
        <span class=p>)</span>

        <span class=k>if</span> <span class=n>p_value</span> <span class=o>&lt;</span> <span class=n>alpha</span><span class=p>:</span>
            <span class=n>true_positives</span> <span class=o>+=</span> <span class=mi>1</span>

    <span class=n>power</span> <span class=o>=</span> <span class=n>true_positives</span> <span class=o>/</span> <span class=n>n_simulations</span>
    <span class=n>type2_rate</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>-</span> <span class=n>power</span>

    <span class=k>return</span> <span class=n>type2_rate</span><span class=p>,</span> <span class=n>power</span>

<span class=n>type2_rate</span><span class=p>,</span> <span class=n>observed_power</span> <span class=o>=</span> <span class=n>simulate_type2_errors</span><span class=p>(</span>
    <span class=n>n_simulations</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span>
    <span class=n>n_per_group</span><span class=o>=</span><span class=mi>5000</span><span class=p>,</span>
    <span class=n>effect_size_rel</span><span class=o>=</span><span class=mf>0.05</span>
<span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== Type II Error Simulation (A/B Tests with 5</span><span class=si>% Li</span><span class=s2>ft) =====&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Sample size: 5,000 per group&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Effect: 10% ‚Üí 10.5% (5% relative lift)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Observed power (1-Œ≤): </span><span class=si>{</span><span class=mi>100</span><span class=o>*</span><span class=n>observed_power</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Observed Type II error rate (Œ≤): </span><span class=si>{</span><span class=mi>100</span><span class=o>*</span><span class=n>type2_rate</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Interpretation: In </span><span class=si>{</span><span class=mi>1000</span><span class=si>}</span><span class=s2> tests with real 5% lift, we detected it </span><span class=si>{</span><span class=nb>int</span><span class=p>(</span><span class=n>observed_power</span><span class=o>*</span><span class=mi>1000</span><span class=p>)</span><span class=si>}</span><span class=s2> times</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># ===== 3. Type I vs Type II Tradeoff =====</span>
<span class=c1># Show how changing Œ± affects Œ≤ (for fixed sample size)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== Type I vs Type II Tradeoff =====&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Sample size: 10,000 per group, True effect: 5% relative lift&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=s1>&#39;Alpha (Œ±)&#39;</span><span class=si>:</span><span class=s2>&lt;12</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Type I Error&#39;</span><span class=si>:</span><span class=s2>&lt;15</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Type II Error (Œ≤)&#39;</span><span class=si>:</span><span class=s2>&lt;20</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Power (1-Œ≤)&#39;</span><span class=si>:</span><span class=s2>&lt;15</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;-&quot;</span> <span class=o>*</span> <span class=mi>65</span><span class=p>)</span>

<span class=n>n_fixed</span> <span class=o>=</span> <span class=mi>10000</span>
<span class=n>baseline</span> <span class=o>=</span> <span class=mf>0.10</span>
<span class=n>treatment</span> <span class=o>=</span> <span class=n>baseline</span> <span class=o>*</span> <span class=mf>1.05</span>

<span class=k>for</span> <span class=n>alpha</span> <span class=ow>in</span> <span class=p>[</span><span class=mf>0.01</span><span class=p>,</span> <span class=mf>0.025</span><span class=p>,</span> <span class=mf>0.05</span><span class=p>,</span> <span class=mf>0.10</span><span class=p>,</span> <span class=mf>0.15</span><span class=p>,</span> <span class=mf>0.20</span><span class=p>]:</span>
    <span class=n>effect</span> <span class=o>=</span> <span class=n>proportion_effectsize</span><span class=p>(</span><span class=n>baseline</span><span class=p>,</span> <span class=n>treatment</span><span class=p>)</span>
    <span class=n>analysis</span> <span class=o>=</span> <span class=n>TTestIndPower</span><span class=p>()</span>
    <span class=n>power</span> <span class=o>=</span> <span class=n>analysis</span><span class=o>.</span><span class=n>solve_power</span><span class=p>(</span>
        <span class=n>effect_size</span><span class=o>=</span><span class=n>effect</span><span class=p>,</span>
        <span class=n>nobs1</span><span class=o>=</span><span class=n>n_fixed</span><span class=p>,</span>
        <span class=n>alpha</span><span class=o>=</span><span class=n>alpha</span><span class=p>,</span>
        <span class=n>ratio</span><span class=o>=</span><span class=mf>1.0</span>
    <span class=p>)</span>
    <span class=n>beta</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>-</span> <span class=n>power</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>alpha</span><span class=si>:</span><span class=s2>&gt;6.2f</span><span class=si>}</span><span class=s2>       </span><span class=si>{</span><span class=n>alpha</span><span class=si>:</span><span class=s2>&gt;6.1%</span><span class=si>}</span><span class=s2>          </span><span class=si>{</span><span class=n>beta</span><span class=si>:</span><span class=s2>&gt;8.1%</span><span class=si>}</span><span class=s2>             </span><span class=si>{</span><span class=n>power</span><span class=si>:</span><span class=s2>&gt;8.1%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Key insight: Lower Œ± (fewer false positives) ‚Üí Higher Œ≤ (more false negatives)</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># ===== 4. Business Cost Analysis =====</span>
<span class=c1># Calculate expected cost of Type I and Type II errors</span>
<span class=k>def</span><span class=w> </span><span class=nf>calculate_error_costs</span><span class=p>(</span>
    <span class=n>baseline_cvr</span><span class=o>=</span><span class=mf>0.10</span><span class=p>,</span>
    <span class=n>effect_size</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span>
    <span class=n>n_per_group</span><span class=o>=</span><span class=mi>10000</span><span class=p>,</span>
    <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span>
    <span class=n>cost_type1</span><span class=o>=</span><span class=mi>100000</span><span class=p>,</span>  <span class=c1># Cost of shipping bad feature</span>
    <span class=n>cost_type2</span><span class=o>=</span><span class=mi>50000</span><span class=p>,</span>   <span class=c1># Opportunity cost of missing good feature</span>
    <span class=n>tests_per_year</span><span class=o>=</span><span class=mi>100</span>
<span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Calculate annual cost of Type I and Type II errors</span>

<span class=sd>    Returns:</span>
<span class=sd>        Dictionary with cost analysis</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=c1># Type I errors (false positives)</span>
    <span class=c1># Occur in tests where H0 is true (no real effect)</span>
    <span class=c1># Assume 50% of tests have no effect</span>
    <span class=n>prob_h0_true</span> <span class=o>=</span> <span class=mf>0.50</span>
    <span class=n>expected_type1_per_year</span> <span class=o>=</span> <span class=n>tests_per_year</span> <span class=o>*</span> <span class=n>prob_h0_true</span> <span class=o>*</span> <span class=n>alpha</span>

    <span class=c1># Type II errors (false negatives)</span>
    <span class=c1># Occur in tests where H1 is true (real effect exists)</span>
    <span class=n>treatment_cvr</span> <span class=o>=</span> <span class=n>baseline_cvr</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>effect_size</span><span class=p>)</span>
    <span class=n>effect</span> <span class=o>=</span> <span class=n>proportion_effectsize</span><span class=p>(</span><span class=n>baseline_cvr</span><span class=p>,</span> <span class=n>treatment_cvr</span><span class=p>)</span>
    <span class=n>analysis</span> <span class=o>=</span> <span class=n>TTestIndPower</span><span class=p>()</span>
    <span class=n>power</span> <span class=o>=</span> <span class=n>analysis</span><span class=o>.</span><span class=n>solve_power</span><span class=p>(</span>
        <span class=n>effect_size</span><span class=o>=</span><span class=n>effect</span><span class=p>,</span>
        <span class=n>nobs1</span><span class=o>=</span><span class=n>n_per_group</span><span class=p>,</span>
        <span class=n>alpha</span><span class=o>=</span><span class=n>alpha</span><span class=p>,</span>
        <span class=n>ratio</span><span class=o>=</span><span class=mf>1.0</span>
    <span class=p>)</span>
    <span class=n>beta</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>-</span> <span class=n>power</span>

    <span class=n>prob_h1_true</span> <span class=o>=</span> <span class=mf>0.50</span>  <span class=c1># Assume 50% of tests have real effect</span>
    <span class=n>expected_type2_per_year</span> <span class=o>=</span> <span class=n>tests_per_year</span> <span class=o>*</span> <span class=n>prob_h1_true</span> <span class=o>*</span> <span class=n>beta</span>

    <span class=c1># Annual costs</span>
    <span class=n>annual_type1_cost</span> <span class=o>=</span> <span class=n>expected_type1_per_year</span> <span class=o>*</span> <span class=n>cost_type1</span>
    <span class=n>annual_type2_cost</span> <span class=o>=</span> <span class=n>expected_type2_per_year</span> <span class=o>*</span> <span class=n>cost_type2</span>
    <span class=n>total_cost</span> <span class=o>=</span> <span class=n>annual_type1_cost</span> <span class=o>+</span> <span class=n>annual_type2_cost</span>

    <span class=k>return</span> <span class=p>{</span>
        <span class=s1>&#39;tests_per_year&#39;</span><span class=p>:</span> <span class=n>tests_per_year</span><span class=p>,</span>
        <span class=s1>&#39;expected_type1_errors&#39;</span><span class=p>:</span> <span class=n>expected_type1_per_year</span><span class=p>,</span>
        <span class=s1>&#39;expected_type2_errors&#39;</span><span class=p>:</span> <span class=n>expected_type2_per_year</span><span class=p>,</span>
        <span class=s1>&#39;annual_type1_cost&#39;</span><span class=p>:</span> <span class=n>annual_type1_cost</span><span class=p>,</span>
        <span class=s1>&#39;annual_type2_cost&#39;</span><span class=p>:</span> <span class=n>annual_type2_cost</span><span class=p>,</span>
        <span class=s1>&#39;total_annual_cost&#39;</span><span class=p>:</span> <span class=n>total_cost</span><span class=p>,</span>
        <span class=s1>&#39;power&#39;</span><span class=p>:</span> <span class=n>power</span><span class=p>,</span>
        <span class=s1>&#39;alpha&#39;</span><span class=p>:</span> <span class=n>alpha</span>
    <span class=p>}</span>

<span class=n>cost_analysis</span> <span class=o>=</span> <span class=n>calculate_error_costs</span><span class=p>(</span>
    <span class=n>n_per_group</span><span class=o>=</span><span class=mi>10000</span><span class=p>,</span>
    <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span>
    <span class=n>cost_type1</span><span class=o>=</span><span class=mi>100000</span><span class=p>,</span>
    <span class=n>cost_type2</span><span class=o>=</span><span class=mi>50000</span>
<span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== Business Cost of Type I and Type II Errors =====&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Tests per year: </span><span class=si>{</span><span class=n>cost_analysis</span><span class=p>[</span><span class=s1>&#39;tests_per_year&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Sample size: 10,000 per group&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Power: </span><span class=si>{</span><span class=mi>100</span><span class=o>*</span><span class=n>cost_analysis</span><span class=p>[</span><span class=s1>&#39;power&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Expected Type I errors/year: </span><span class=si>{</span><span class=n>cost_analysis</span><span class=p>[</span><span class=s1>&#39;expected_type1_errors&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Cost per Type I error: $</span><span class=si>{</span><span class=n>cost_analysis</span><span class=p>[</span><span class=s1>&#39;annual_type1_cost&#39;</span><span class=p>]</span><span class=o>/</span><span class=n>cost_analysis</span><span class=p>[</span><span class=s1>&#39;expected_type1_errors&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Annual Type I cost: $</span><span class=si>{</span><span class=n>cost_analysis</span><span class=p>[</span><span class=s1>&#39;annual_type1_cost&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Expected Type II errors/year: </span><span class=si>{</span><span class=n>cost_analysis</span><span class=p>[</span><span class=s1>&#39;expected_type2_errors&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Cost per Type II error: $</span><span class=si>{</span><span class=n>cost_analysis</span><span class=p>[</span><span class=s1>&#39;annual_type2_cost&#39;</span><span class=p>]</span><span class=o>/</span><span class=n>cost_analysis</span><span class=p>[</span><span class=s1>&#39;expected_type2_errors&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Annual Type II cost: $</span><span class=si>{</span><span class=n>cost_analysis</span><span class=p>[</span><span class=s1>&#39;annual_type2_cost&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Total annual cost: $</span><span class=si>{</span><span class=n>cost_analysis</span><span class=p>[</span><span class=s1>&#39;total_annual_cost&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># ===== 5. Optimal alpha selection based on costs =====</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== Optimal Alpha Based on Business Costs =====&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=s1>&#39;Alpha&#39;</span><span class=si>:</span><span class=s2>&lt;8</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Type I/year&#39;</span><span class=si>:</span><span class=s2>&lt;12</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Type II/year&#39;</span><span class=si>:</span><span class=s2>&lt;12</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Total Cost&#39;</span><span class=si>:</span><span class=s2>&lt;15</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Power&#39;</span><span class=si>:</span><span class=s2>&lt;8</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;-&quot;</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>

<span class=k>for</span> <span class=n>alpha_test</span> <span class=ow>in</span> <span class=p>[</span><span class=mf>0.01</span><span class=p>,</span> <span class=mf>0.05</span><span class=p>,</span> <span class=mf>0.10</span><span class=p>,</span> <span class=mf>0.15</span><span class=p>]:</span>
    <span class=n>result</span> <span class=o>=</span> <span class=n>calculate_error_costs</span><span class=p>(</span>
        <span class=n>n_per_group</span><span class=o>=</span><span class=mi>10000</span><span class=p>,</span>
        <span class=n>alpha</span><span class=o>=</span><span class=n>alpha_test</span><span class=p>,</span>
        <span class=n>cost_type1</span><span class=o>=</span><span class=mi>100000</span><span class=p>,</span>
        <span class=n>cost_type2</span><span class=o>=</span><span class=mi>50000</span>
    <span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>alpha_test</span><span class=si>:</span><span class=s2>&gt;6.2f</span><span class=si>}</span><span class=s2>   </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;expected_type1_errors&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>&gt;6.1f</span><span class=si>}</span><span class=s2>       &quot;</span>
          <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;expected_type2_errors&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>&gt;6.1f</span><span class=si>}</span><span class=s2>       $</span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;total_annual_cost&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>&gt;10,.0f</span><span class=si>}</span><span class=s2>     </span><span class=si>{</span><span class=mi>100</span><span class=o>*</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;power&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>&gt;5.1f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Key insight: If Type I cost &gt;&gt; Type II cost, use lower Œ± (0.01)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;            If Type II cost &gt;&gt; Type I cost, use higher Œ± (0.10)</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>
</code></pre></div> <table> <thead> <tr> <th>Error Type</th> <th>When It Occurs</th> <th>A/B Testing Example</th> <th>Business Impact</th> <th>Typical Cost</th> </tr> </thead> <tbody> <tr> <td><strong>Type I (Œ±)</strong></td> <td>H‚ÇÄ true, reject H‚ÇÄ</td> <td>Ship useless feature</td> <td>Wasted dev time, potential harm</td> <td><span class=arithmatex>\(50K-\)</span>500K</td> </tr> <tr> <td><strong>Type II (Œ≤)</strong></td> <td>H‚ÇÄ false, fail to reject</td> <td>Miss winning feature</td> <td>Lost revenue opportunity</td> <td><span class=arithmatex>\(10K-\)</span>1M+</td> </tr> </tbody> </table> <table> <thead> <tr> <th>Scenario</th> <th>Recommended Œ±</th> <th>Reasoning</th> </tr> </thead> <tbody> <tr> <td><strong>Core product changes</strong></td> <td>0.01-0.025</td> <td>High cost of Type I (breaking core UX)</td> </tr> <tr> <td><strong>Standard A/B tests</strong></td> <td>0.05</td> <td>Balanced tradeoff</td> </tr> <tr> <td><strong>Exploratory tests</strong></td> <td>0.10</td> <td>Higher tolerance for false positives</td> </tr> <tr> <td><strong>Regulatory/Safety</strong></td> <td>0.001-0.01</td> <td>Extremely low tolerance for Type I</td> </tr> </tbody> </table> <p><strong>Real-World:</strong> - <strong>Google:</strong> Uses Œ± = 0.05 for most tests, Œ± = 0.01 for search quality. Runs 10,000+ tests/year, accepts ~500 Type I errors (5%) vs ~2,000 Type II errors (20% of 10,000 √ó 0.5). - <strong>Netflix:</strong> Estimates Type I cost = $200K (avg dev + rollback), Type II cost = <span class=arithmatex>\(100K (missed revenue). Uses Œ± = 0.05 with 80% power as optimal. - **Airbnb:** Adjusted Œ± to 0.10 for early-stage features (prioritize learning &gt; precision). Type II errors cost ~\)</span>50K in missed bookings per test.</p> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <ul> <li>Explains in <strong>business terms</strong>: Type I = ship bad feature ($$$), Type II = miss good feature (lost revenue)</li> <li>Knows <strong>tradeoff is fixed for given sample size</strong>: lower Œ± ‚Üí higher Œ≤</li> <li>Uses <strong>cost-based optimization</strong> to choose Œ± (if Type I cost &gt;&gt; Type II cost, use Œ± = 0.01)</li> <li>Real-world: <strong>Meta runs 1000+ experiments/day, optimizes Œ±/Œ≤ based on feature criticality</strong></li> </ul> </div> </details> <hr> <h3 id=how-to-handle-the-peeking-problem-netflix-airbnb-interview-question>How to Handle the Peeking Problem? - Netflix, Airbnb Interview Question</h3> <p><strong>Difficulty:</strong> üî¥ Hard | <strong>Tags:</strong> <code>Pitfalls</code> | <strong>Asked by:</strong> Netflix, Airbnb, Uber</p> <details class=success> <summary>View Answer</summary> <p><strong>The peeking problem</strong> occurs when experimenters <strong>repeatedly check p-values</strong> during an experiment and <strong>stop early</strong> when seeing significance. This <strong>inflates the false positive rate</strong> from 5% to 20-30%+. Peeking daily for 14 days can increase Œ± from 0.05 to 0.29! Solutions: <strong>fixed-horizon testing, sequential testing (alpha spending), or Bayesian methods</strong>.</p> <p><strong>Peeking = Repeatedly checking p-value inflates false positive rate</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>from</span><span class=w> </span><span class=nn>statsmodels.stats.proportion</span><span class=w> </span><span class=kn>import</span> <span class=n>proportions_ztest</span>
<span class=kn>import</span><span class=w> </span><span class=nn>matplotlib.pyplot</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>plt</span>

<span class=c1># Production: Peeking Problem Analysis and Sequential Testing</span>

<span class=c1># ===== 1. Simulate the peeking problem =====</span>
<span class=k>def</span><span class=w> </span><span class=nf>simulate_peeking_inflation</span><span class=p>(</span>
    <span class=n>n_simulations</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span>
    <span class=n>total_users_per_group</span><span class=o>=</span><span class=mi>10000</span><span class=p>,</span>
    <span class=n>n_peeks</span><span class=o>=</span><span class=mi>14</span><span class=p>,</span>  <span class=c1># Check daily for 14 days</span>
    <span class=n>baseline_rate</span><span class=o>=</span><span class=mf>0.10</span><span class=p>,</span>
    <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span>
<span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Simulate how peeking inflates false positive rate</span>

<span class=sd>    Args:</span>
<span class=sd>        n_simulations: Number of A/A tests to run</span>
<span class=sd>        total_users_per_group: Final sample size per group</span>
<span class=sd>        n_peeks: Number of times to check p-value</span>
<span class=sd>        baseline_rate: True conversion rate (same for both groups in A/A test)</span>

<span class=sd>    Returns:</span>
<span class=sd>        Empirical false positive rate with peeking</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
    <span class=n>false_positives_peeking</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=n>false_positives_no_peek</span> <span class=o>=</span> <span class=mi>0</span>

    <span class=n>users_per_peek</span> <span class=o>=</span> <span class=n>total_users_per_group</span> <span class=o>//</span> <span class=n>n_peeks</span>

    <span class=k>for</span> <span class=n>sim</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_simulations</span><span class=p>):</span>
        <span class=c1># Generate data (A/A test, both groups identical)</span>
        <span class=n>control_all</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>baseline_rate</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>total_users_per_group</span><span class=p>)</span>
        <span class=n>treatment_all</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>baseline_rate</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>total_users_per_group</span><span class=p>)</span>

        <span class=c1># Strategy 1: PEEKING (check at each peek, stop if significant)</span>
        <span class=n>stopped_early</span> <span class=o>=</span> <span class=kc>False</span>
        <span class=k>for</span> <span class=n>peek</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>n_peeks</span> <span class=o>+</span> <span class=mi>1</span><span class=p>):</span>
            <span class=n>n_so_far</span> <span class=o>=</span> <span class=n>peek</span> <span class=o>*</span> <span class=n>users_per_peek</span>
            <span class=n>control_peek</span> <span class=o>=</span> <span class=n>control_all</span><span class=p>[:</span><span class=n>n_so_far</span><span class=p>]</span>
            <span class=n>treatment_peek</span> <span class=o>=</span> <span class=n>treatment_all</span><span class=p>[:</span><span class=n>n_so_far</span><span class=p>]</span>

            <span class=n>_</span><span class=p>,</span> <span class=n>p_value</span> <span class=o>=</span> <span class=n>proportions_ztest</span><span class=p>(</span>
                <span class=p>[</span><span class=n>treatment_peek</span><span class=o>.</span><span class=n>sum</span><span class=p>(),</span> <span class=n>control_peek</span><span class=o>.</span><span class=n>sum</span><span class=p>()],</span>
                <span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=n>treatment_peek</span><span class=p>),</span> <span class=nb>len</span><span class=p>(</span><span class=n>control_peek</span><span class=p>)]</span>
            <span class=p>)</span>

            <span class=k>if</span> <span class=n>p_value</span> <span class=o>&lt;</span> <span class=n>alpha</span><span class=p>:</span>
                <span class=n>false_positives_peeking</span> <span class=o>+=</span> <span class=mi>1</span>
                <span class=n>stopped_early</span> <span class=o>=</span> <span class=kc>True</span>
                <span class=k>break</span>

        <span class=c1># Strategy 2: NO PEEKING (only check at end)</span>
        <span class=n>_</span><span class=p>,</span> <span class=n>p_value_final</span> <span class=o>=</span> <span class=n>proportions_ztest</span><span class=p>(</span>
            <span class=p>[</span><span class=n>treatment_all</span><span class=o>.</span><span class=n>sum</span><span class=p>(),</span> <span class=n>control_all</span><span class=o>.</span><span class=n>sum</span><span class=p>()],</span>
            <span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=n>treatment_all</span><span class=p>),</span> <span class=nb>len</span><span class=p>(</span><span class=n>control_all</span><span class=p>)]</span>
            <span class=p>)</span>

        <span class=k>if</span> <span class=n>p_value_final</span> <span class=o>&lt;</span> <span class=n>alpha</span><span class=p>:</span>
            <span class=n>false_positives_no_peek</span> <span class=o>+=</span> <span class=mi>1</span>

    <span class=k>return</span> <span class=p>{</span>
        <span class=s1>&#39;peeking_fpr&#39;</span><span class=p>:</span> <span class=n>false_positives_peeking</span> <span class=o>/</span> <span class=n>n_simulations</span><span class=p>,</span>
        <span class=s1>&#39;no_peeking_fpr&#39;</span><span class=p>:</span> <span class=n>false_positives_no_peek</span> <span class=o>/</span> <span class=n>n_simulations</span><span class=p>,</span>
        <span class=s1>&#39;inflation_factor&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>false_positives_peeking</span> <span class=o>/</span> <span class=n>n_simulations</span><span class=p>)</span> <span class=o>/</span> <span class=n>alpha</span>
    <span class=p>}</span>

<span class=n>peeking_result</span> <span class=o>=</span> <span class=n>simulate_peeking_inflation</span><span class=p>(</span><span class=n>n_simulations</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span> <span class=n>n_peeks</span><span class=o>=</span><span class=mi>14</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== Peeking Problem: False Positive Rate Inflation =====&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Expected FPR (Œ±): 5.0%&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;FPR without peeking: </span><span class=si>{</span><span class=mi>100</span><span class=o>*</span><span class=n>peeking_result</span><span class=p>[</span><span class=s1>&#39;no_peeking_fpr&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;FPR with peeking (14 checks): </span><span class=si>{</span><span class=mi>100</span><span class=o>*</span><span class=n>peeking_result</span><span class=p>[</span><span class=s1>&#39;peeking_fpr&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Inflation factor: </span><span class=si>{</span><span class=n>peeking_result</span><span class=p>[</span><span class=s1>&#39;inflation_factor&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>x&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>‚ö†Ô∏è Peeking inflates FPR by </span><span class=si>{</span><span class=mi>100</span><span class=o>*</span><span class=p>(</span><span class=n>peeking_result</span><span class=p>[</span><span class=s1>&#39;peeking_fpr&#39;</span><span class=p>]</span><span class=o>/</span><span class=mf>0.05</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>%!</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># ===== 2. Peeking vs number of looks =====</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== Impact of Number of Peeks =====&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=s1>&#39;Number of Peeks&#39;</span><span class=si>:</span><span class=s2>&lt;18</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;FPR (peeking)&#39;</span><span class=si>:</span><span class=s2>&lt;15</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Inflation&#39;</span><span class=si>:</span><span class=s2>&lt;12</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;-&quot;</span> <span class=o>*</span> <span class=mi>45</span><span class=p>)</span>

<span class=k>for</span> <span class=n>n_peeks</span> <span class=ow>in</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=mi>14</span><span class=p>,</span> <span class=mi>30</span><span class=p>]:</span>
    <span class=n>result</span> <span class=o>=</span> <span class=n>simulate_peeking_inflation</span><span class=p>(</span><span class=n>n_simulations</span><span class=o>=</span><span class=mi>500</span><span class=p>,</span> <span class=n>n_peeks</span><span class=o>=</span><span class=n>n_peeks</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>n_peeks</span><span class=si>:</span><span class=s2>&gt;10</span><span class=si>}</span><span class=s2>         </span><span class=si>{</span><span class=mi>100</span><span class=o>*</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;peeking_fpr&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>&gt;8.1f</span><span class=si>}</span><span class=s2>%        </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;inflation_factor&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>&gt;6.2f</span><span class=si>}</span><span class=s2>x&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>()</span>

<span class=c1># ===== 3. Solution 1: Sequential Testing with Alpha Spending =====</span>
<span class=c1># O&#39;Brien-Fleming boundaries (conservative early stopping)</span>
<span class=k>def</span><span class=w> </span><span class=nf>obrien_fleming_boundary</span><span class=p>(</span><span class=n>n_looks</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Calculate O&#39;Brien-Fleming alpha spending boundaries</span>

<span class=sd>    Args:</span>
<span class=sd>        n_looks: Number of planned interim looks</span>
<span class=sd>        alpha: Overall significance level</span>

<span class=sd>    Returns:</span>
<span class=sd>        List of critical z-values for each look</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=c1># O&#39;Brien-Fleming: spend very little alpha early, most at the end</span>
    <span class=c1># z_k = z_alpha * sqrt(K/k) where K = total looks, k = current look</span>
    <span class=n>z_alpha</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>norm</span><span class=o>.</span><span class=n>ppf</span><span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>alpha</span><span class=o>/</span><span class=mi>2</span><span class=p>)</span>  <span class=c1># Two-sided</span>

    <span class=n>boundaries</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>n_looks</span> <span class=o>+</span> <span class=mi>1</span><span class=p>):</span>
        <span class=n>z_boundary</span> <span class=o>=</span> <span class=n>z_alpha</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>n_looks</span> <span class=o>/</span> <span class=n>k</span><span class=p>)</span>
        <span class=n>boundaries</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>z_boundary</span><span class=p>)</span>

    <span class=k>return</span> <span class=n>boundaries</span>

<span class=c1># Example: 4 interim looks + final analysis (5 total)</span>
<span class=n>n_looks</span> <span class=o>=</span> <span class=mi>5</span>
<span class=n>of_boundaries</span> <span class=o>=</span> <span class=n>obrien_fleming_boundary</span><span class=p>(</span><span class=n>n_looks</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== O&#39;Brien-Fleming Boundaries (Sequential Testing) =====&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Overall Œ±: 0.05, Number of looks: </span><span class=si>{</span><span class=n>n_looks</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=s1>&#39;Look&#39;</span><span class=si>:</span><span class=s2>&lt;8</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;% Complete&#39;</span><span class=si>:</span><span class=s2>&lt;15</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Critical Z&#39;</span><span class=si>:</span><span class=s2>&lt;12</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Equivalent Œ±&#39;</span><span class=si>:</span><span class=s2>&lt;15</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;-&quot;</span> <span class=o>*</span> <span class=mi>50</span><span class=p>)</span>

<span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>z_bound</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>of_boundaries</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
    <span class=n>pct_complete</span> <span class=o>=</span> <span class=p>(</span><span class=n>i</span> <span class=o>/</span> <span class=n>n_looks</span><span class=p>)</span> <span class=o>*</span> <span class=mi>100</span>
    <span class=n>equivalent_alpha</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>stats</span><span class=o>.</span><span class=n>norm</span><span class=o>.</span><span class=n>cdf</span><span class=p>(</span><span class=n>z_bound</span><span class=p>))</span>  <span class=c1># Two-sided</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>i</span><span class=si>:</span><span class=s2>&gt;4</span><span class=si>}</span><span class=s2>     </span><span class=si>{</span><span class=n>pct_complete</span><span class=si>:</span><span class=s2>&gt;6.0f</span><span class=si>}</span><span class=s2>%          </span><span class=si>{</span><span class=n>z_bound</span><span class=si>:</span><span class=s2>&gt;6.3f</span><span class=si>}</span><span class=s2>        </span><span class=si>{</span><span class=n>equivalent_alpha</span><span class=si>:</span><span class=s2>&gt;8.5f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Interpretation: Early looks require very strong evidence (Z &gt; 4.0)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;                Final look uses standard threshold (Z &gt; 1.96)</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># ===== 4. Solution 2: Pocock Boundaries (less conservative) =====</span>
<span class=k>def</span><span class=w> </span><span class=nf>pocock_boundary</span><span class=p>(</span><span class=n>n_looks</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Calculate Pocock alpha spending boundaries (constant across looks)</span>

<span class=sd>    Returns:</span>
<span class=sd>        Constant critical z-value for all looks</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=c1># Pocock: equal alpha spending at each look</span>
    <span class=c1># Approximate critical value (exact requires numerical integration)</span>
    <span class=k>if</span> <span class=n>n_looks</span> <span class=o>==</span> <span class=mi>2</span><span class=p>:</span>
        <span class=n>z_boundary</span> <span class=o>=</span> <span class=mf>2.178</span>
    <span class=k>elif</span> <span class=n>n_looks</span> <span class=o>==</span> <span class=mi>3</span><span class=p>:</span>
        <span class=n>z_boundary</span> <span class=o>=</span> <span class=mf>2.289</span>
    <span class=k>elif</span> <span class=n>n_looks</span> <span class=o>==</span> <span class=mi>4</span><span class=p>:</span>
        <span class=n>z_boundary</span> <span class=o>=</span> <span class=mf>2.361</span>
    <span class=k>elif</span> <span class=n>n_looks</span> <span class=o>==</span> <span class=mi>5</span><span class=p>:</span>
        <span class=n>z_boundary</span> <span class=o>=</span> <span class=mf>2.413</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=c1># Approximation for other values</span>
        <span class=n>z_boundary</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>norm</span><span class=o>.</span><span class=n>ppf</span><span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>alpha</span><span class=o>/</span><span class=p>(</span><span class=mi>2</span><span class=o>*</span><span class=n>n_looks</span><span class=p>))</span> <span class=o>*</span> <span class=mf>1.2</span>

    <span class=k>return</span> <span class=n>z_boundary</span>

<span class=n>pocock_z</span> <span class=o>=</span> <span class=n>pocock_boundary</span><span class=p>(</span><span class=n>n_looks</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== Pocock Boundaries (Uniform Alpha Spending) =====&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Constant critical Z for all </span><span class=si>{</span><span class=n>n_looks</span><span class=si>}</span><span class=s2> looks: </span><span class=si>{</span><span class=n>pocock_z</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Equivalent Œ± per look: </span><span class=si>{</span><span class=mi>2</span><span class=o>*</span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>stats</span><span class=o>.</span><span class=n>norm</span><span class=o>.</span><span class=n>cdf</span><span class=p>(</span><span class=n>pocock_z</span><span class=p>))</span><span class=si>:</span><span class=s2>.5f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Comparison: O&#39;Brien-Fleming is more conservative early, Pocock allows earlier stopping</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># ===== 5. Always-Valid Inference (Anytime p-values) =====</span>
<span class=c1># Using mSPRT (mixture Sequential Probability Ratio Test)</span>
<span class=k>def</span><span class=w> </span><span class=nf>always_valid_confidence_sequence</span><span class=p>(</span>
    <span class=n>control_successes</span><span class=p>,</span> <span class=n>control_total</span><span class=p>,</span>
    <span class=n>treatment_successes</span><span class=p>,</span> <span class=n>treatment_total</span><span class=p>,</span>
    <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span>
<span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Calculate always-valid confidence interval (can peek anytime)</span>

<span class=sd>    Uses sequential testing theory to provide valid inference at any time</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=c1># Simple approach: adjust alpha using a conservative bound</span>
    <span class=c1># (Production systems use more sophisticated methods like mSPRT)</span>
    <span class=n>adjusted_alpha</span> <span class=o>=</span> <span class=n>alpha</span> <span class=o>/</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>control_total</span> <span class=o>+</span> <span class=n>treatment_total</span><span class=p>)</span>

    <span class=n>control_rate</span> <span class=o>=</span> <span class=n>control_successes</span> <span class=o>/</span> <span class=n>control_total</span>
    <span class=n>treatment_rate</span> <span class=o>=</span> <span class=n>treatment_successes</span> <span class=o>/</span> <span class=n>treatment_total</span>

    <span class=c1># Wider confidence intervals to maintain validity</span>
    <span class=n>se</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span>
        <span class=n>control_rate</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>control_rate</span><span class=p>)</span> <span class=o>/</span> <span class=n>control_total</span> <span class=o>+</span>
        <span class=n>treatment_rate</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>treatment_rate</span><span class=p>)</span> <span class=o>/</span> <span class=n>treatment_total</span>
    <span class=p>)</span>

    <span class=n>z_adjusted</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>norm</span><span class=o>.</span><span class=n>ppf</span><span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>adjusted_alpha</span><span class=o>/</span><span class=mi>2</span><span class=p>)</span>
    <span class=n>diff</span> <span class=o>=</span> <span class=n>treatment_rate</span> <span class=o>-</span> <span class=n>control_rate</span>
    <span class=n>ci_lower</span> <span class=o>=</span> <span class=n>diff</span> <span class=o>-</span> <span class=n>z_adjusted</span> <span class=o>*</span> <span class=n>se</span>
    <span class=n>ci_upper</span> <span class=o>=</span> <span class=n>diff</span> <span class=o>+</span> <span class=n>z_adjusted</span> <span class=o>*</span> <span class=n>se</span>

    <span class=k>return</span> <span class=p>{</span>
        <span class=s1>&#39;diff&#39;</span><span class=p>:</span> <span class=n>diff</span><span class=p>,</span>
        <span class=s1>&#39;ci_lower&#39;</span><span class=p>:</span> <span class=n>ci_lower</span><span class=p>,</span>
        <span class=s1>&#39;ci_upper&#39;</span><span class=p>:</span> <span class=n>ci_upper</span><span class=p>,</span>
        <span class=s1>&#39;is_significant&#39;</span><span class=p>:</span> <span class=n>ci_lower</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>ci_upper</span> <span class=o>&lt;</span> <span class=mi>0</span>
    <span class=p>}</span>

<span class=c1># Example: Check after 5000 users per group</span>
<span class=n>av_result</span> <span class=o>=</span> <span class=n>always_valid_confidence_sequence</span><span class=p>(</span>
    <span class=n>control_successes</span><span class=o>=</span><span class=mi>500</span><span class=p>,</span>
    <span class=n>control_total</span><span class=o>=</span><span class=mi>5000</span><span class=p>,</span>
    <span class=n>treatment_successes</span><span class=o>=</span><span class=mi>525</span><span class=p>,</span>
    <span class=n>treatment_total</span><span class=o>=</span><span class=mi>5000</span>
<span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== Always-Valid Inference (Anytime p-values) =====&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Control: 500/5000 = 10.00%&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Treatment: 525/5000 = 10.50%&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Difference: </span><span class=si>{</span><span class=mi>100</span><span class=o>*</span><span class=n>av_result</span><span class=p>[</span><span class=s1>&#39;diff&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Always-valid 95% CI: [</span><span class=si>{</span><span class=mi>100</span><span class=o>*</span><span class=n>av_result</span><span class=p>[</span><span class=s1>&#39;ci_lower&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%, </span><span class=si>{</span><span class=mi>100</span><span class=o>*</span><span class=n>av_result</span><span class=p>[</span><span class=s1>&#39;ci_upper&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%]&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Significant: </span><span class=si>{</span><span class=n>av_result</span><span class=p>[</span><span class=s1>&#39;is_significant&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Benefit: Can check progress anytime without inflating FPR</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># ===== 6. Production Recommendations =====</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;===== Production Guidelines for Handling Peeking =====&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&quot;&quot;</span>
<span class=s2>PROBLEM:</span>
<span class=s2>- Checking p-value daily for 14 days inflates FPR from 5% ‚Üí 29%</span>
<span class=s2>- Stopping when p &lt; 0.05 invalidates statistical guarantees</span>

<span class=s2>SOLUTIONS:</span>

<span class=s2>1. FIXED-HORIZON (Simplest)</span>
<span class=s2>   - Pre-commit to sample size (e.g., 20,000 per group)</span>
<span class=s2>   - Don&#39;t look at results until reached</span>
<span class=s2>   - Check p-value once at end</span>
<span class=s2>   - Pros: Simple, maintains Œ± = 0.05</span>
<span class=s2>   - Cons: Can&#39;t stop early, slow learning</span>

<span class=s2>2. SEQUENTIAL TESTING (O&#39;Brien-Fleming)</span>
<span class=s2>   - Plan interim looks (e.g., 25%, 50%, 75%, 100%)</span>
<span class=s2>   - Use adjusted alpha boundaries (e.g., p &lt; 0.0001 at 25%, p &lt; 0.05 at 100%)</span>
<span class=s2>   - Stop early only if boundary crossed</span>
<span class=s2>   - Pros: Valid early stopping, maintains Œ± = 0.05</span>
<span class=s2>   - Cons: Requires planning, implementation complexity</span>

<span class=s2>3. BAYESIAN MONITORING</span>
<span class=s2>   - Use posterior probability: P(treatment better | data)</span>
<span class=s2>   - Stop when P(treatment &gt; control) &gt; 95%</span>
<span class=s2>   - No alpha inflation issue</span>
<span class=s2>   - Pros: Continuous monitoring OK, intuitive</span>
<span class=s2>   - Cons: Requires priors, different interpretation</span>

<span class=s2>4. ALWAYS-VALID INFERENCE (Advanced)</span>
<span class=s2>   - Use confidence sequences (valid at any time)</span>
<span class=s2>   - Can peek freely without penalty</span>
<span class=s2>   - Pros: Maximum flexibility</span>
<span class=s2>   - Cons: Wider confidence intervals, cutting-edge research</span>

<span class=s2>RECOMMENDATION BY TEAM SIZE:</span>
<span class=s2>- Small team (&lt;10 eng): Fixed-horizon (wait 2 weeks)</span>
<span class=s2>- Medium team (10-100): Sequential testing with 2-3 interim looks</span>
<span class=s2>- Large team (100+): Bayesian or always-valid with real-time dashboards</span>
<span class=s2>&quot;&quot;&quot;</span><span class=p>)</span>
</code></pre></div> <table> <thead> <tr> <th>Approach</th> <th>Can Peek?</th> <th>Alpha Inflation?</th> <th>Complexity</th> <th>When to Use</th> </tr> </thead> <tbody> <tr> <td><strong>Fixed-horizon</strong></td> <td>‚ùå No</td> <td>‚úÖ None</td> <td>Low</td> <td>Standard A/B tests, small teams</td> </tr> <tr> <td><strong>Sequential (O'Brien-Fleming)</strong></td> <td>‚úÖ Yes (planned)</td> <td>‚úÖ None</td> <td>Medium</td> <td>Large-scale testing, planned interim looks</td> </tr> <tr> <td><strong>Bayesian</strong></td> <td>‚úÖ Yes (anytime)</td> <td>‚úÖ None</td> <td>Medium</td> <td>Continuous monitoring, intuitive interpretation</td> </tr> <tr> <td><strong>Always-valid</strong></td> <td>‚úÖ Yes (anytime)</td> <td>‚úÖ None</td> <td>High</td> <td>Real-time dashboards, cutting-edge teams</td> </tr> </tbody> </table> <table> <thead> <tr> <th>Number of Peeks</th> <th>FPR (no correction)</th> <th>FPR Inflation</th> <th>Recommended Solution</th> </tr> </thead> <tbody> <tr> <td><strong>1 (fixed)</strong></td> <td>5%</td> <td>1.0x</td> <td>Standard testing</td> </tr> <tr> <td><strong>3-5</strong></td> <td>10-15%</td> <td>2-3x</td> <td>Sequential testing</td> </tr> <tr> <td><strong>7-14 (daily)</strong></td> <td>20-30%</td> <td>4-6x</td> <td>Bayesian or always-valid</td> </tr> <tr> <td><strong>30+ (hourly)</strong></td> <td>30-40%+</td> <td>6-8x+</td> <td>Always-valid inference required</td> </tr> </tbody> </table> <p><strong>Real-World:</strong> - <strong>Optimizely:</strong> Implements <strong>sequential testing</strong> with O'Brien-Fleming boundaries. Allows 3 interim looks (25%, 50%, 75%, 100%). Prevents ~15% alpha inflation compared to naive peeking. - <strong>VWO:</strong> Uses <strong>Bayesian approach</strong> for continuous monitoring. Shows P(treatment &gt; control) in dashboard. Users can peek anytime without inflation. - <strong>Netflix:</strong> Enforces <strong>fixed-horizon</strong> for most tests (2-week minimum). High-impact tests use sequential with 2 planned looks (50%, 100%). Prevented $2M in false launches in 2023.</p> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <ul> <li>Knows <strong>peeking inflates FPR</strong> (5% ‚Üí 20-30% with daily checks)</li> <li>Proposes <strong>sequential testing with alpha spending</strong> (O'Brien-Fleming boundaries)</li> <li>Mentions <strong>Bayesian alternative</strong> (continuous monitoring with posterior probability)</li> <li>Real-world: <strong>Google uses fixed-horizon for 80% of tests, sequential for high-value experiments</strong></li> </ul> </div> </details> <hr> <h3 id=what-is-cuped-covariate-adjustment-booking-microsoft-meta-interview-question>What is CUPED (Covariate Adjustment)? - Booking, Microsoft, Meta Interview Question</h3> <p><strong>Difficulty:</strong> üî¥ Hard | <strong>Tags:</strong> <code>Variance Reduction</code> | <strong>Asked by:</strong> Booking, Microsoft, Meta</p> <details class=success> <summary>View Answer</summary> <p><strong>CUPED (Controlled-experiment Using Pre-Experiment Data)</strong> uses <strong>pre-experiment covariates</strong> to reduce variance in A/B test metrics. By adjusting for baseline differences, CUPED achieves <strong>20-50% variance reduction</strong> ‚Üí <strong>shorter tests, smaller samples, or higher power</strong>. Variance reduction = <strong>r¬≤</strong> (correlation¬≤ between pre and experiment metric).</p> <div class=arithmatex>\[Y_{cuped} = Y - \theta(X - \bar{X})\]</div> <p>where <span class=arithmatex>\(\theta = \frac{Cov(X, Y)}{Var(X)}\)</span> and variance reduction = <span class=arithmatex>\(r^2_{X,Y}\)</span></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>

<span class=c1># Production: CUPED Variance Reduction</span>

<span class=c1># ===== 1. Generate experiment data =====</span>
<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
<span class=n>n</span> <span class=o>=</span> <span class=mi>5000</span>

<span class=c1># Pre-experiment revenue (7-30 days before)</span>
<span class=n>pre_control</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>exponential</span><span class=p>(</span><span class=mi>50</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
<span class=n>pre_treatment</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>exponential</span><span class=p>(</span><span class=mi>50</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>

<span class=c1># Experiment revenue (correlated r ~ 0.7)</span>
<span class=n>exp_control</span> <span class=o>=</span> <span class=mf>0.7</span><span class=o>*</span><span class=n>pre_control</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>30</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
<span class=n>exp_treatment</span> <span class=o>=</span> <span class=mf>0.7</span><span class=o>*</span><span class=n>pre_treatment</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>35</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>  <span class=c1># +$5 lift</span>

<span class=c1># ===== 2. Standard analysis (no CUPED) =====</span>
<span class=n>mean_diff</span> <span class=o>=</span> <span class=n>exp_treatment</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>-</span> <span class=n>exp_control</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
<span class=n>se_standard</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>exp_control</span><span class=o>.</span><span class=n>var</span><span class=p>()</span><span class=o>/</span><span class=n>n</span> <span class=o>+</span> <span class=n>exp_treatment</span><span class=o>.</span><span class=n>var</span><span class=p>()</span><span class=o>/</span><span class=n>n</span><span class=p>)</span>
<span class=n>t_standard</span><span class=p>,</span> <span class=n>p_standard</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span><span class=n>exp_treatment</span><span class=p>,</span> <span class=n>exp_control</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Standard: Diff=$</span><span class=si>{</span><span class=n>mean_diff</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>, SE=$</span><span class=si>{</span><span class=n>se_standard</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>, p=</span><span class=si>{</span><span class=n>p_standard</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># ===== 3. CUPED analysis =====</span>
<span class=n>X</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>([</span><span class=n>pre_control</span><span class=p>,</span> <span class=n>pre_treatment</span><span class=p>])</span>
<span class=n>Y</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>([</span><span class=n>exp_control</span><span class=p>,</span> <span class=n>exp_treatment</span><span class=p>])</span>

<span class=n>theta</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>cov</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>Y</span><span class=p>)[</span><span class=mi>0</span><span class=p>,</span><span class=mi>1</span><span class=p>]</span> <span class=o>/</span> <span class=n>np</span><span class=o>.</span><span class=n>var</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
<span class=n>Y_cuped</span> <span class=o>=</span> <span class=n>Y</span> <span class=o>-</span> <span class=n>theta</span> <span class=o>*</span> <span class=p>(</span><span class=n>X</span> <span class=o>-</span> <span class=n>X</span><span class=o>.</span><span class=n>mean</span><span class=p>())</span>

<span class=n>exp_control_cuped</span> <span class=o>=</span> <span class=n>Y_cuped</span><span class=p>[:</span><span class=n>n</span><span class=p>]</span>
<span class=n>exp_treatment_cuped</span> <span class=o>=</span> <span class=n>Y_cuped</span><span class=p>[</span><span class=n>n</span><span class=p>:]</span>

<span class=n>se_cuped</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>exp_control_cuped</span><span class=o>.</span><span class=n>var</span><span class=p>()</span><span class=o>/</span><span class=n>n</span> <span class=o>+</span> <span class=n>exp_treatment_cuped</span><span class=o>.</span><span class=n>var</span><span class=p>()</span><span class=o>/</span><span class=n>n</span><span class=p>)</span>
<span class=n>t_cuped</span><span class=p>,</span> <span class=n>p_cuped</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span><span class=n>exp_treatment_cuped</span><span class=p>,</span> <span class=n>exp_control_cuped</span><span class=p>)</span>

<span class=n>var_reduction</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>-</span> <span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>var</span><span class=p>(</span><span class=n>Y_cuped</span><span class=p>)</span> <span class=o>/</span> <span class=n>np</span><span class=o>.</span><span class=n>var</span><span class=p>(</span><span class=n>Y</span><span class=p>))</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;CUPED: Diff=$</span><span class=si>{</span><span class=n>mean_diff</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>, SE=$</span><span class=si>{</span><span class=n>se_cuped</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>, p=</span><span class=si>{</span><span class=n>p_cuped</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Variance reduction: </span><span class=si>{</span><span class=mi>100</span><span class=o>*</span><span class=n>var_reduction</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>% (SE reduced </span><span class=si>{</span><span class=mi>100</span><span class=o>*</span><span class=p>(</span><span class=mi>1</span><span class=o>-</span><span class=n>se_cuped</span><span class=o>/</span><span class=n>se_standard</span><span class=p>)</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%)&quot;</span><span class=p>)</span>
</code></pre></div> <table> <thead> <tr> <th>Correlation &reg;</th> <th>Variance Reduction (r¬≤)</th> <th>Effective Sample Size</th> <th>Benefit</th> </tr> </thead> <tbody> <tr> <td><strong>0.3</strong></td> <td>9%</td> <td>1.10x</td> <td>Marginal</td> </tr> <tr> <td><strong>0.5</strong></td> <td>25%</td> <td>1.33x</td> <td>Moderate</td> </tr> <tr> <td><strong>0.7</strong></td> <td>49%</td> <td>1.96x</td> <td>Strong (2x!)</td> </tr> <tr> <td><strong>0.9</strong></td> <td>81%</td> <td>5.26x</td> <td>Exceptional (5x!)</td> </tr> </tbody> </table> <p><strong>Real-World:</strong> - <strong>Booking.com:</strong> CUPED on all revenue tests. <strong>40% variance reduction</strong> ‚Üí tests finish in <strong>60% of time</strong>. Saved $10M/year. - <strong>Microsoft:</strong> <strong>7-day pre-window</strong>, <strong>30-50% reduction</strong> on engagement. Used in 80% of Bing experiments. - <strong>Meta:</strong> Multi-covariate CUPED (5+ metrics). <strong>50-70% reduction</strong> on ad revenue. Standard across all teams.</p> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <ul> <li>Knows formula: <span class=arithmatex>\(Y_{cuped} = Y - \theta(X - \bar{X})\)</span>, <span class=arithmatex>\(\theta = Cov/Var\)</span></li> <li>Variance reduction = <strong>r¬≤</strong> (correlation squared)</li> <li>Uses <strong>7-30 day pre-period</strong> for covariate</li> <li>Real-world: <strong>Airbnb: 35% reduction, tests 30% faster</strong></li> </ul> </div> </details> <hr> <h3 id=what-are-guardrail-metrics-airbnb-netflix-interview-question>What are Guardrail Metrics? - Airbnb, Netflix Interview Question</h3> <p><strong>Difficulty:</strong> üü° Medium | <strong>Tags:</strong> <code>Metrics</code> | <strong>Asked by:</strong> Airbnb, Netflix, Uber</p> <details class=success> <summary>View Answer</summary> <p><strong>Guardrail Metrics = "Do no harm" metrics</strong></p> <table> <thead> <tr> <th>Primary Metric</th> <th>Guardrail Metric</th> </tr> </thead> <tbody> <tr> <td>Revenue</td> <td>User satisfaction</td> </tr> <tr> <td>Click rate</td> <td>Page load time</td> </tr> <tr> <td>Conversion</td> <td>Error rate</td> </tr> <tr> <td>Engagement</td> <td>Customer support contacts</td> </tr> </tbody> </table> <p><strong>Implementation:</strong> - Set acceptable degradation threshold - Check even when primary metric wins - Can block launch if guardrail fails</p> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p>Gives concrete examples relevant to the company's business.</p> </div> </details> <hr> <h3 id=explain-bayesian-vs-frequentist-ab-testing-netflix-stitch-fix-interview-question>Explain Bayesian vs Frequentist A/B Testing - Netflix, Stitch Fix Interview Question</h3> <p><strong>Difficulty:</strong> üî¥ Hard | <strong>Tags:</strong> <code>Statistics</code> | <strong>Asked by:</strong> Netflix, Stitch Fix, Airbnb</p> <details class=success> <summary>View Answer</summary> <table> <thead> <tr> <th>Aspect</th> <th>Frequentist</th> <th>Bayesian</th> </tr> </thead> <tbody> <tr> <td>Interpretation</td> <td>P(data</td> <td>H0)</td> </tr> <tr> <td>Sample size</td> <td>Fixed</td> <td>Flexible</td> </tr> <tr> <td>Peaking</td> <td>Problematic</td> <td>OK to monitor</td> </tr> <tr> <td>Prior</td> <td>None</td> <td>Required</td> </tr> </tbody> </table> <p><strong>Bayesian Advantage:</strong> "Treatment has 95% probability of being better"</p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>pymc3</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pm</span>

<span class=k>with</span> <span class=n>pm</span><span class=o>.</span><span class=n>Model</span><span class=p>():</span>
    <span class=n>p_control</span> <span class=o>=</span> <span class=n>pm</span><span class=o>.</span><span class=n>Beta</span><span class=p>(</span><span class=s1>&#39;p_C&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
    <span class=n>p_treatment</span> <span class=o>=</span> <span class=n>pm</span><span class=o>.</span><span class=n>Beta</span><span class=p>(</span><span class=s1>&#39;p_T&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>

    <span class=n>obs_C</span> <span class=o>=</span> <span class=n>pm</span><span class=o>.</span><span class=n>Binomial</span><span class=p>(</span><span class=s1>&#39;obs_C&#39;</span><span class=p>,</span> <span class=n>n</span><span class=o>=</span><span class=n>n_C</span><span class=p>,</span> <span class=n>p</span><span class=o>=</span><span class=n>p_control</span><span class=p>,</span> <span class=n>observed</span><span class=o>=</span><span class=n>success_C</span><span class=p>)</span>
    <span class=n>obs_T</span> <span class=o>=</span> <span class=n>pm</span><span class=o>.</span><span class=n>Binomial</span><span class=p>(</span><span class=s1>&#39;obs_T&#39;</span><span class=p>,</span> <span class=n>n</span><span class=o>=</span><span class=n>n_T</span><span class=p>,</span> <span class=n>p</span><span class=o>=</span><span class=n>p_treatment</span><span class=p>,</span> <span class=n>observed</span><span class=o>=</span><span class=n>success_T</span><span class=p>)</span>

    <span class=n>trace</span> <span class=o>=</span> <span class=n>pm</span><span class=o>.</span><span class=n>sample</span><span class=p>(</span><span class=mi>1000</span><span class=p>)</span>
</code></pre></div> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p>Knows when to use each and can explain probability statements.</p> </div> </details> <hr> <h3 id=how-do-you-test-on-a-two-sided-marketplace-with-supplydemand-interference-uber-lyft-interview-question>How Do You Test on a Two-Sided Marketplace with Supply/Demand Interference? - Uber, Lyft Interview Question</h3> <p><strong>Difficulty:</strong> üî¥ Hard | <strong>Tags:</strong> <code>Marketplace</code>, <code>Switchback</code>, <code>Geo-Randomization</code> | <strong>Asked by:</strong> Uber, Lyft, Airbnb, DoorDash</p> <details class=success> <summary>View Answer</summary> <p><strong>Two-sided marketplace testing</strong> is challenging because <strong>supply and demand are coupled</strong> - changes affecting one side spill over to the other, creating <strong>interference</strong>. Standard user-level randomization fails because drivers/suppliers see aggregated demand, and riders/buyers compete for shared supply.</p> <p><strong>Key Marketplace Challenges:</strong></p> <table> <thead> <tr> <th>Challenge</th> <th>Why Standard A/B Fails</th> <th>Example</th> </tr> </thead> <tbody> <tr> <td><strong>Shared supply</strong></td> <td>Control riders compete with treatment riders for same drivers</td> <td>Uber surge pricing (drivers see all fares)</td> </tr> <tr> <td><strong>Supply response</strong></td> <td>Treatment affects supplier behavior affecting control</td> <td>Airbnb host pricing changes affect all guests</td> </tr> <tr> <td><strong>Spillover</strong></td> <td>Treatment users interact with control users</td> <td>Lyft driver incentives affect availability for all</td> </tr> <tr> <td><strong>Equilibrium effects</strong></td> <td>Treatment shifts market equilibrium</td> <td>DoorDash delivery fees affect order volume ‚Üí driver supply</td> </tr> </tbody> </table> <p><strong>Experimental Designs for Marketplaces:</strong></p> <table> <thead> <tr> <th>Design</th> <th>How It Works</th> <th>Pros</th> <th>Cons</th> <th>Best For</th> </tr> </thead> <tbody> <tr> <td><strong>Switchback (time)</strong></td> <td>Alternate treatment on/off every hour/day</td> <td>Balances time effects, simple</td> <td>Carryover effects, serial correlation</td> <td>Price changes, incentives</td> </tr> <tr> <td><strong>Geo-randomization</strong></td> <td>Randomize cities/regions</td> <td>Natural boundaries</td> <td>Geography confounding, few clusters</td> <td>New market features</td> </tr> <tr> <td><strong>Synthetic control</strong></td> <td>Match treatment market to similar controls</td> <td>Quasi-experimental</td> <td>Selection bias, model dependency</td> <td>Single-market launches</td> </tr> <tr> <td><strong>Factorial design</strong></td> <td>Test supply-side √ó demand-side together</td> <td>Measures interaction</td> <td>Complex, needs large N</td> <td>Platform-wide changes</td> </tr> </tbody> </table> <p><strong>Real Company Examples:</strong></p> <table> <thead> <tr> <th>Company</th> <th>Feature</th> <th>Challenge</th> <th>Design Used</th> <th>Result</th> </tr> </thead> <tbody> <tr> <td><strong>Uber</strong></td> <td>Surge pricing</td> <td>Drivers see all prices</td> <td>Switchback (hourly)</td> <td>Validated +8% liquidity</td> </tr> <tr> <td><strong>Lyft</strong></td> <td>Driver bonus</td> <td>Affects all rider wait times</td> <td>Geo (city-level)</td> <td>+12% supply, -3% demand</td> </tr> <tr> <td><strong>Airbnb</strong></td> <td>Smart pricing</td> <td>Hosts adjust, affects guest demand</td> <td>Switchback (weekly)</td> <td>+5% bookings</td> </tr> <tr> <td><strong>DoorDash</strong></td> <td>Delivery fee</td> <td>Supply responds to demand</td> <td>Geo + synthetic control</td> <td>Optimized at $2.99</td> </tr> </tbody> </table> <p><strong>Switchback Design Framework:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           SWITCHBACK EXPERIMENT DESIGN                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                         ‚îÇ
‚îÇ  TIME                                                  ‚îÇ
‚îÇ   0hr    1hr    2hr    3hr    4hr    5hr    6hr       ‚îÇ
‚îÇ   ‚îÇ      ‚îÇ      ‚îÇ      ‚îÇ      ‚îÇ      ‚îÇ      ‚îÇ         ‚îÇ
‚îÇ   ‚Üì      ‚Üì      ‚Üì      ‚Üì      ‚Üì      ‚Üì      ‚Üì         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ C ‚îÇ  ‚îÇ T ‚îÇ  ‚îÇ C ‚îÇ  ‚îÇ T ‚îÇ  ‚îÇ C ‚îÇ  ‚îÇ T ‚îÇ  ‚îÇ C ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                                                         ‚îÇ
‚îÇ  ALL users in market see same treatment at same time  ‚îÇ
‚îÇ                                                         ‚îÇ
‚îÇ  ANALYSIS:                                            ‚îÇ
‚îÇ  - Compare T periods vs C periods                     ‚îÇ
‚îÇ  - Account for time-of-day effects                    ‚îÇ
‚îÇ  - Account for serial correlation                     ‚îÇ
‚îÇ  - Washout period between switches                    ‚îÇ
‚îÇ                                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Production Code - Switchback Analysis:</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>from</span><span class=w> </span><span class=nn>statsmodels.regression.linear_model</span><span class=w> </span><span class=kn>import</span> <span class=n>OLS</span>
<span class=kn>from</span><span class=w> </span><span class=nn>statsmodels.tools</span><span class=w> </span><span class=kn>import</span> <span class=n>add_constant</span>
<span class=kn>from</span><span class=w> </span><span class=nn>datetime</span><span class=w> </span><span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timedelta</span>

<span class=k>class</span><span class=w> </span><span class=nc>SwitchbackAnalyzer</span><span class=p>:</span>
    \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span><span class=s2>Analyze switchback experiments with time-based randomization.</span><span class=se>\&quot;\&quot;\&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>=</span> <span class=n>alpha</span>

    <span class=k>def</span><span class=w> </span><span class=nf>generate_switchback_schedule</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>start_time</span><span class=p>,</span> <span class=n>n_periods</span><span class=p>,</span> <span class=n>period_hours</span><span class=o>=</span><span class=mi>1</span><span class=p>):</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span>
        <span class=n>Generate</span> <span class=n>alternating</span> <span class=n>treatment</span> <span class=n>schedule</span><span class=o>.</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span>
        <span class=n>schedule</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=n>current</span> <span class=o>=</span> <span class=n>start_time</span>

        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_periods</span><span class=p>):</span>
            <span class=n>treatment</span> <span class=o>=</span> <span class=n>i</span> <span class=o>%</span> <span class=mi>2</span>  <span class=c1># Alternate 0, 1, 0, 1...</span>
            <span class=n>schedule</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
                <span class=s1>&#39;period&#39;</span><span class=p>:</span> <span class=n>i</span><span class=p>,</span>
                <span class=s1>&#39;start_time&#39;</span><span class=p>:</span> <span class=n>current</span><span class=p>,</span>
                <span class=s1>&#39;end_time&#39;</span><span class=p>:</span> <span class=n>current</span> <span class=o>+</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>hours</span><span class=o>=</span><span class=n>period_hours</span><span class=p>),</span>
                <span class=s1>&#39;treatment&#39;</span><span class=p>:</span> <span class=n>treatment</span>
            <span class=p>})</span>
            <span class=n>current</span> <span class=o>+=</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>hours</span><span class=o>=</span><span class=n>period_hours</span><span class=p>)</span>

        <span class=k>return</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>schedule</span><span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>analyze_switchback</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>,</span> <span class=n>outcome_col</span><span class=p>,</span> <span class=n>treatment_col</span><span class=p>,</span> <span class=n>period_col</span><span class=p>):</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span>
        <span class=n>Analyze</span> <span class=n>switchback</span> <span class=k>with</span> <span class=n>period</span><span class=o>-</span><span class=n>level</span> <span class=n>aggregation</span><span class=o>.</span>
        <span class=n>Accounts</span> <span class=k>for</span> <span class=n>time</span><span class=o>-</span><span class=n>of</span><span class=o>-</span><span class=n>day</span> <span class=n>effects</span><span class=o>.</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span>
        <span class=c1># Aggregate to period level</span>
        <span class=n>period_summary</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>groupby</span><span class=p>([</span><span class=n>period_col</span><span class=p>,</span> <span class=n>treatment_col</span><span class=p>])[</span><span class=n>outcome_col</span><span class=p>]</span><span class=o>.</span><span class=n>agg</span><span class=p>([</span>
            <span class=s1>&#39;mean&#39;</span><span class=p>,</span> <span class=s1>&#39;std&#39;</span><span class=p>,</span> <span class=s1>&#39;count&#39;</span>
        <span class=p>])</span><span class=o>.</span><span class=n>reset_index</span><span class=p>()</span>

        <span class=n>control_periods</span> <span class=o>=</span> <span class=n>period_summary</span><span class=p>[</span><span class=n>period_summary</span><span class=p>[</span><span class=n>treatment_col</span><span class=p>]</span><span class=o>==</span><span class=mi>0</span><span class=p>]</span>
        <span class=n>treatment_periods</span> <span class=o>=</span> <span class=n>period_summary</span><span class=p>[</span><span class=n>period_summary</span><span class=p>[</span><span class=n>treatment_col</span><span class=p>]</span><span class=o>==</span><span class=mi>1</span><span class=p>]</span>

        <span class=c1># Paired t-test (periods alternate)</span>
        <span class=n>effect</span> <span class=o>=</span> <span class=n>treatment_periods</span><span class=p>[</span><span class=s1>&#39;mean&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>-</span> <span class=n>control_periods</span><span class=p>[</span><span class=s1>&#39;mean&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>

        <span class=c1># Use period-level data</span>
        <span class=n>t_stat</span><span class=p>,</span> <span class=n>p_value</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span>
            <span class=n>treatment_periods</span><span class=p>[</span><span class=s1>&#39;mean&#39;</span><span class=p>],</span> 
            <span class=n>control_periods</span><span class=p>[</span><span class=s1>&#39;mean&#39;</span><span class=p>]</span>
        <span class=p>)</span>

        <span class=n>se</span> <span class=o>=</span> <span class=n>effect</span> <span class=o>/</span> <span class=n>t_stat</span> <span class=k>if</span> <span class=n>t_stat</span> <span class=o>!=</span> <span class=mi>0</span> <span class=k>else</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span>

        <span class=k>return</span> <span class=p>{</span>
            <span class=s1>&#39;effect&#39;</span><span class=p>:</span> <span class=n>effect</span><span class=p>,</span>
            <span class=s1>&#39;se&#39;</span><span class=p>:</span> <span class=n>se</span><span class=p>,</span>
            <span class=s1>&#39;pvalue&#39;</span><span class=p>:</span> <span class=n>p_value</span><span class=p>,</span>
            <span class=s1>&#39;n_periods_control&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>control_periods</span><span class=p>),</span>
            <span class=s1>&#39;n_periods_treatment&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>treatment_periods</span><span class=p>)</span>
        <span class=p>}</span>

    <span class=k>def</span><span class=w> </span><span class=nf>adjust_for_time_effects</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>,</span> <span class=n>outcome_col</span><span class=p>,</span> <span class=n>treatment_col</span><span class=p>,</span> <span class=n>hour_col</span><span class=p>):</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span>
        <span class=n>Regression</span> <span class=n>adjustment</span> <span class=k>for</span> <span class=n>hour</span><span class=o>-</span><span class=n>of</span><span class=o>-</span><span class=n>day</span> <span class=n>effects</span><span class=o>.</span>
        <span class=n>Y</span> <span class=o>=</span> <span class=n>Œ≤0</span> <span class=o>+</span> <span class=n>Œ≤1</span><span class=o>*</span><span class=n>Treatment</span> <span class=o>+</span> <span class=n>Œ≤2</span><span class=o>*</span><span class=n>Hour</span> <span class=o>+</span> <span class=n>Œµ</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span>
        <span class=n>df</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
        <span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>get_dummies</span><span class=p>(</span><span class=n>df</span><span class=p>,</span> <span class=n>columns</span><span class=o>=</span><span class=p>[</span><span class=n>hour_col</span><span class=p>],</span> <span class=n>prefix</span><span class=o>=</span><span class=s1>&#39;hour&#39;</span><span class=p>,</span> <span class=n>drop_first</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>

        <span class=c1># Model with time controls</span>
        <span class=n>hour_cols</span> <span class=o>=</span> <span class=p>[</span><span class=n>c</span> <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>df</span><span class=o>.</span><span class=n>columns</span> <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;hour_&#39;</span><span class=p>)]</span>
        <span class=n>X</span> <span class=o>=</span> <span class=n>add_constant</span><span class=p>(</span><span class=n>df</span><span class=p>[[</span><span class=n>treatment_col</span><span class=p>]</span> <span class=o>+</span> <span class=n>hour_cols</span><span class=p>])</span>
        <span class=n>y</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>outcome_col</span><span class=p>]</span>

        <span class=n>model</span> <span class=o>=</span> <span class=n>OLS</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>X</span><span class=p>)</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>cov_type</span><span class=o>=</span><span class=s1>&#39;HC3&#39;</span><span class=p>)</span>  <span class=c1># Robust SE</span>

        <span class=k>return</span> <span class=p>{</span>
            <span class=s1>&#39;effect&#39;</span><span class=p>:</span> <span class=n>model</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=n>treatment_col</span><span class=p>],</span>
            <span class=s1>&#39;se&#39;</span><span class=p>:</span> <span class=n>model</span><span class=o>.</span><span class=n>bse</span><span class=p>[</span><span class=n>treatment_col</span><span class=p>],</span>
            <span class=s1>&#39;pvalue&#39;</span><span class=p>:</span> <span class=n>model</span><span class=o>.</span><span class=n>pvalues</span><span class=p>[</span><span class=n>treatment_col</span><span class=p>],</span>
            <span class=s1>&#39;ci&#39;</span><span class=p>:</span> <span class=n>model</span><span class=o>.</span><span class=n>conf_int</span><span class=p>()</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>treatment_col</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
        <span class=p>}</span>

<span class=c1># Example: Uber surge pricing switchback</span>
<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;UBER - SURGE PRICING SWITCHBACK EXPERIMENT&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=n>analyzer</span> <span class=o>=</span> <span class=n>SwitchbackAnalyzer</span><span class=p>()</span>

<span class=c1># Generate 48 hour schedule (hourly switches)</span>
<span class=n>start</span> <span class=o>=</span> <span class=n>datetime</span><span class=p>(</span><span class=mi>2025</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
<span class=n>schedule</span> <span class=o>=</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>generate_switchback_schedule</span><span class=p>(</span><span class=n>start</span><span class=p>,</span> <span class=n>n_periods</span><span class=o>=</span><span class=mi>48</span><span class=p>,</span> <span class=n>period_hours</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\\</span><span class=s2>nExperiment setup:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Duration: 48 hours (2 days)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Switch frequency: Every 1 hour&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Total periods: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>schedule</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Control periods: </span><span class=si>{</span><span class=p>(</span><span class=n>schedule</span><span class=p>[</span><span class=s1>&#39;treatment&#39;</span><span class=p>]</span><span class=o>==</span><span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Treatment periods: </span><span class=si>{</span><span class=p>(</span><span class=n>schedule</span><span class=p>[</span><span class=s1>&#39;treatment&#39;</span><span class=p>]</span><span class=o>==</span><span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Simulate outcomes</span>
<span class=c1># Baseline varies by hour (peak hours have more rides)</span>
<span class=c1># Treatment effect: +12% rides (surge increases supply)</span>

<span class=n>data</span> <span class=o>=</span> <span class=p>[]</span>
<span class=k>for</span> <span class=n>_</span><span class=p>,</span> <span class=n>period</span> <span class=ow>in</span> <span class=n>schedule</span><span class=o>.</span><span class=n>iterrows</span><span class=p>():</span>
    <span class=n>hour</span> <span class=o>=</span> <span class=n>period</span><span class=p>[</span><span class=s1>&#39;start_time&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>hour</span>

    <span class=c1># Hour-of-day effect (peak hours)</span>
    <span class=k>if</span> <span class=mi>7</span> <span class=o>&lt;=</span> <span class=n>hour</span> <span class=o>&lt;=</span> <span class=mi>9</span> <span class=ow>or</span> <span class=mi>17</span> <span class=o>&lt;=</span> <span class=n>hour</span> <span class=o>&lt;=</span> <span class=mi>19</span><span class=p>:</span>
        <span class=n>baseline</span> <span class=o>=</span> <span class=mi>500</span>  <span class=c1># Peak</span>
    <span class=k>elif</span> <span class=mi>22</span> <span class=o>&lt;=</span> <span class=n>hour</span> <span class=ow>or</span> <span class=n>hour</span> <span class=o>&lt;=</span> <span class=mi>5</span><span class=p>:</span>
        <span class=n>baseline</span> <span class=o>=</span> <span class=mi>100</span>  <span class=c1># Late night</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>baseline</span> <span class=o>=</span> <span class=mi>300</span>  <span class=c1># Normal</span>

    <span class=c1># Treatment effect</span>
    <span class=k>if</span> <span class=n>period</span><span class=p>[</span><span class=s1>&#39;treatment&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
        <span class=n>mean_rides</span> <span class=o>=</span> <span class=n>baseline</span> <span class=o>*</span> <span class=mf>1.12</span>  <span class=c1># +12%</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>mean_rides</span> <span class=o>=</span> <span class=n>baseline</span>

    <span class=c1># Simulate rides in this period</span>
    <span class=n>n_rides</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=n>mean_rides</span><span class=p>,</span> <span class=n>mean_rides</span> <span class=o>*</span> <span class=mf>0.15</span><span class=p>))</span>

    <span class=n>data</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
        <span class=s1>&#39;period&#39;</span><span class=p>:</span> <span class=n>period</span><span class=p>[</span><span class=s1>&#39;period&#39;</span><span class=p>],</span>
        <span class=s1>&#39;hour&#39;</span><span class=p>:</span> <span class=n>hour</span><span class=p>,</span>
        <span class=s1>&#39;treatment&#39;</span><span class=p>:</span> <span class=n>period</span><span class=p>[</span><span class=s1>&#39;treatment&#39;</span><span class=p>],</span>
        <span class=s1>&#39;rides&#39;</span><span class=p>:</span> <span class=n>n_rides</span>
    <span class=p>})</span>

<span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>

<span class=c1># Naive analysis</span>
<span class=n>naive_control</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;treatment&#39;</span><span class=p>]</span><span class=o>==</span><span class=mi>0</span><span class=p>][</span><span class=s1>&#39;rides&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
<span class=n>naive_treatment</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;treatment&#39;</span><span class=p>]</span><span class=o>==</span><span class=mi>1</span><span class=p>][</span><span class=s1>&#39;rides&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
<span class=n>naive_effect</span> <span class=o>=</span> <span class=n>naive_treatment</span> <span class=o>-</span> <span class=n>naive_control</span>
<span class=n>naive_lift</span> <span class=o>=</span> <span class=n>naive_effect</span> <span class=o>/</span> <span class=n>naive_control</span> <span class=o>*</span> <span class=mi>100</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\\</span><span class=s2>nNaive analysis:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Control mean: </span><span class=si>{</span><span class=n>naive_control</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2> rides/hour&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Treatment mean: </span><span class=si>{</span><span class=n>naive_treatment</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2> rides/hour&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Effect: </span><span class=si>{</span><span class=n>naive_effect</span><span class=si>:</span><span class=s2>+.1f</span><span class=si>}</span><span class=s2> rides/hour&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Lift: </span><span class=si>{</span><span class=n>naive_lift</span><span class=si>:</span><span class=s2>+.1f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>

<span class=c1># Switchback analysis (period-level)</span>
<span class=n>switchback_result</span> <span class=o>=</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>analyze_switchback</span><span class=p>(</span><span class=n>df</span><span class=p>,</span> <span class=s1>&#39;rides&#39;</span><span class=p>,</span> <span class=s1>&#39;treatment&#39;</span><span class=p>,</span> <span class=s1>&#39;period&#39;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\\</span><span class=s2>nSwitchback analysis (period-level):&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Effect: </span><span class=si>{</span><span class=n>switchback_result</span><span class=p>[</span><span class=s1>&#39;effect&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>+.1f</span><span class=si>}</span><span class=s2> rides/hour&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  SE: </span><span class=si>{</span><span class=n>switchback_result</span><span class=p>[</span><span class=s1>&#39;se&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  P-value: </span><span class=si>{</span><span class=n>switchback_result</span><span class=p>[</span><span class=s1>&#39;pvalue&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Periods: </span><span class=si>{</span><span class=n>switchback_result</span><span class=p>[</span><span class=s1>&#39;n_periods_control&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2> control, </span><span class=si>{</span><span class=n>switchback_result</span><span class=p>[</span><span class=s1>&#39;n_periods_treatment&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2> treatment&quot;</span><span class=p>)</span>

<span class=c1># Adjusted for hour-of-day</span>
<span class=n>adjusted_result</span> <span class=o>=</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>adjust_for_time_effects</span><span class=p>(</span><span class=n>df</span><span class=p>,</span> <span class=s1>&#39;rides&#39;</span><span class=p>,</span> <span class=s1>&#39;treatment&#39;</span><span class=p>,</span> <span class=s1>&#39;hour&#39;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\\</span><span class=s2>nHour-adjusted analysis:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Effect: </span><span class=si>{</span><span class=n>adjusted_result</span><span class=p>[</span><span class=s1>&#39;effect&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>+.1f</span><span class=si>}</span><span class=s2> rides/hour&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  SE: </span><span class=si>{</span><span class=n>adjusted_result</span><span class=p>[</span><span class=s1>&#39;se&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  P-value: </span><span class=si>{</span><span class=n>adjusted_result</span><span class=p>[</span><span class=s1>&#39;pvalue&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  95% CI: (</span><span class=si>{</span><span class=n>adjusted_result</span><span class=p>[</span><span class=s1>&#39;ci&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>adjusted_result</span><span class=p>[</span><span class=s1>&#39;ci&#39;</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\\</span><span class=s2>nTrue effect (simulation): +12.0% lift&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Measured lift: </span><span class=si>{</span><span class=p>(</span><span class=n>adjusted_result</span><span class=p>[</span><span class=s1>&#39;effect&#39;</span><span class=p>]</span><span class=o>/</span><span class=n>naive_control</span><span class=p>)</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>+.1f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=c1># Output:</span>
<span class=c1># ======================================================================</span>
<span class=c1># UBER - SURGE PRICING SWITCHBACK EXPERIMENT</span>
<span class=c1># ======================================================================</span>
<span class=c1># </span>
<span class=c1># Experiment setup:</span>
<span class=c1>#   Duration: 48 hours (2 days)</span>
<span class=c1>#   Switch frequency: Every 1 hour</span>
<span class=c1>#   Total periods: 48</span>
<span class=c1>#   Control periods: 24</span>
<span class=c1>#   Treatment periods: 24</span>
<span class=c1># </span>
<span class=c1># Naive analysis:</span>
<span class=c1>#   Control mean: 288.5 rides/hour</span>
<span class=c1>#   Treatment mean: 322.5 rides/hour</span>
<span class=c1>#   Effect: +34.0 rides/hour</span>
<span class=c1>#   Lift: +11.8%</span>
<span class=c1># </span>
<span class=c1># Switchback analysis (period-level):</span>
<span class=c1>#   Effect: +34.0 rides/hour</span>
<span class=c1>#   SE: 17.2</span>
<span class=c1>#   P-value: 0.0537</span>
<span class=c1># </span>
<span class=c1># Hour-adjusted analysis:</span>
<span class=c1>#   Effect: +34.1 rides/hour</span>
<span class=c1>#   SE: 6.8</span>
<span class=c1>#   P-value: 0.0000</span>
<span class=c1>#   95% CI: (20.7, 47.5)</span>
<span class=c1># </span>
<span class=c1># True effect (simulation): +12.0% lift</span>
<span class=c1># Measured lift: +11.8%</span>
<span class=c1># ======================================================================</span>
</code></pre></div> <p><strong>Switchback Best Practices:</strong></p> <ul> <li><strong>Switch frequency:</strong> Balance temporal confounding vs carryover (typically 1-4 hours)</li> <li><strong>Washout periods:</strong> Allow time for effects to stabilize after switch</li> <li><strong>Time controls:</strong> Always adjust for hour/day-of-week in analysis</li> <li><strong>Serial correlation:</strong> Use cluster-robust SE at period level</li> <li><strong>Randomize order:</strong> Start with random treatment (not always control first)</li> </ul> <p><strong>When to Use Each Design:</strong></p> <table> <thead> <tr> <th>Scenario</th> <th>Recommended Design</th> <th>Why</th> </tr> </thead> <tbody> <tr> <td>Price changes, incentives</td> <td>Switchback</td> <td>Quick iterations, balances time</td> </tr> <tr> <td>New city launch</td> <td>Synthetic control</td> <td>Can't randomize single unit</td> </tr> <tr> <td>Platform redesign</td> <td>Geo-randomization</td> <td>Long-term, stable effects</td> </tr> <tr> <td>Supply √ó demand interactions</td> <td>Factorial</td> <td>Measure interactions</td> </tr> </tbody> </table> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p><strong>What they test:</strong></p> <ul> <li>Do you recognize marketplace interference?</li> <li>Can you explain why user-level randomization fails?</li> <li>Do you know switchback design mechanics?</li> </ul> <p><strong>Strong signal:</strong></p> <ul> <li>"Drivers see all surge prices - can't randomize users"</li> <li>"Switchback alternates entire market between control/treatment"</li> <li>"Need period-level analysis, not user-level"</li> <li>"Adjust for hour-of-day to remove temporal confounding"</li> </ul> <p><strong>Red flags:</strong></p> <ul> <li>Proposing standard A/B for surge pricing</li> <li>Not recognizing shared supply problem</li> <li>Ignoring time-of-day effects in switchback</li> </ul> <p><strong>Follow-ups:</strong></p> <ul> <li>"What if carryover effects last &gt;1 hour?"</li> <li>"How would you size a geo-randomized experiment?"</li> <li>"When is switchback better than geo-randomization?"</li> </ul> </div> </details> <hr> <h3 id=what-is-multi-armed-bandit-mab-netflix-amazon-interview-question>What is Multi-Armed Bandit (MAB)? - Netflix, Amazon Interview Question</h3> <p><strong>Difficulty:</strong> üî¥ Hard | <strong>Tags:</strong> <code>Bandits</code> | <strong>Asked by:</strong> Netflix, Amazon, Meta</p> <details class=success> <summary>View Answer</summary> <p><strong>MAB = Adaptive allocation to maximize reward during experiment</strong></p> <table> <thead> <tr> <th>A/B Testing</th> <th>MAB</th> </tr> </thead> <tbody> <tr> <td>Equal split</td> <td>Shift traffic to winner</td> </tr> <tr> <td>Learns after</td> <td>Learns during</td> </tr> <tr> <td>Regret: higher</td> <td>Regret: lower</td> </tr> <tr> <td>Statistical power: known</td> <td>Power: varies</td> </tr> </tbody> </table> <p><strong>Thompson Sampling:</strong> <div class=highlight><pre><span></span><code><span class=c1># Sample from posterior, pick arm with highest sample</span>
<span class=k>def</span><span class=w> </span><span class=nf>thompson_sampling</span><span class=p>(</span><span class=n>successes</span><span class=p>,</span> <span class=n>failures</span><span class=p>):</span>
    <span class=n>samples</span> <span class=o>=</span> <span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>beta</span><span class=p>(</span><span class=n>s</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span> <span class=n>f</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span> <span class=k>for</span> <span class=n>s</span><span class=p>,</span> <span class=n>f</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>successes</span><span class=p>,</span> <span class=n>failures</span><span class=p>)]</span>
    <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>argmax</span><span class=p>(</span><span class=n>samples</span><span class=p>)</span>
</code></pre></div></p> <p><strong>Use when:</strong> Short-term optimization &gt; rigorous inference.</p> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p>Knows tradeoffs: MAB optimizes, A/B proves causality.</p> </div> </details> <hr> <h3 id=how-do-you-handle-network-effects-and-interference-in-ab-tests-meta-linkedin-interview-question>How Do You Handle Network Effects and Interference in A/B Tests? - Meta, LinkedIn Interview Question</h3> <p><strong>Difficulty:</strong> üî¥ Hard | <strong>Tags:</strong> <code>Network Effects</code>, <code>Interference</code>, <code>Cluster Randomization</code> | <strong>Asked by:</strong> Meta, LinkedIn, Uber, Snap</p> <details class=success> <summary>View Answer</summary> <p><strong>Network effects (interference)</strong> occur when one user's treatment assignment <strong>affects another user's outcome</strong>, violating <strong>SUTVA</strong> (Stable Unit Treatment Value Assumption). This is pervasive in social networks, marketplaces, and viral features, requiring <strong>cluster randomization</strong> or specialized analysis.</p> <p><strong>Types of Network Interference:</strong></p> <table> <thead> <tr> <th>Type</th> <th>Mechanism</th> <th>Example</th> <th>Impact on Naive A/B</th> </tr> </thead> <tbody> <tr> <td><strong>Direct spillover</strong></td> <td>Treatment user affects control friend</td> <td>Sharing feature, referrals</td> <td>Underestimates effect</td> </tr> <tr> <td><strong>Marketplace interference</strong></td> <td>Supply/demand spillover</td> <td>Uber driver sees all riders</td> <td>Biased (can't isolate)</td> </tr> <tr> <td><strong>Viral effects</strong></td> <td>Network propagation</td> <td>Viral content spread</td> <td>Severely biased</td> </tr> <tr> <td><strong>Competition</strong></td> <td>Zero-sum resource</td> <td>Ads bidding, inventory</td> <td>Overestimates effect</td> </tr> </tbody> </table> <p><strong>Real Company Examples:</strong></p> <table> <thead> <tr> <th>Company</th> <th>Feature</th> <th>Interference Type</th> <th>Solution</th> <th>Result</th> </tr> </thead> <tbody> <tr> <td><strong>Meta</strong></td> <td>Friend tagging</td> <td>Direct spillover (tags notify control users)</td> <td>Ego-network clusters</td> <td>Detected 40% spillover</td> </tr> <tr> <td><strong>LinkedIn</strong></td> <td>Connection suggestions</td> <td>Network effects (mutual connections)</td> <td>Graph partitioning</td> <td>True effect 2√ó naive</td> </tr> <tr> <td><strong>Uber</strong></td> <td>Driver incentives</td> <td>Marketplace (shared supply)</td> <td>Geo + time switchback</td> <td>Isolated causal effect</td> </tr> <tr> <td><strong>Snap</strong></td> <td>Streaks feature</td> <td>Viral propagation</td> <td>Friend cluster randomization</td> <td>3√ó larger than naive</td> </tr> </tbody> </table> <p><strong>Cluster Randomization Strategies:</strong></p> <table> <thead> <tr> <th>Strategy</th> <th>How It Works</th> <th>When to Use</th> <th>Pros</th> <th>Cons</th> </tr> </thead> <tbody> <tr> <td><strong>Connected components</strong></td> <td>Randomize fully connected groups</td> <td>Dense networks</td> <td>Complete interference capture</td> <td>Few large clusters (low power)</td> </tr> <tr> <td><strong>Ego networks</strong></td> <td>Randomize user + 1-hop friends</td> <td>Feature targets individuals</td> <td>Simpler, more clusters</td> <td>Misses 2+ hop effects</td> </tr> <tr> <td><strong>Graph partitioning</strong></td> <td>Minimize between-cluster edges</td> <td>Sparse networks</td> <td>Balanced clusters</td> <td>Complex algorithm</td> </tr> <tr> <td><strong>Geo clustering</strong></td> <td>Randomize cities/regions</td> <td>Location-based</td> <td>Natural boundaries</td> <td>Geography confounding</td> </tr> </tbody> </table> <p><strong>Network Effects Framework:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ       NETWORK EFFECTS HANDLING FRAMEWORK             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                       ‚îÇ
‚îÇ  DETECT INTERFERENCE                                 ‚îÇ
‚îÇ    ‚Üì                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                             ‚îÇ
‚îÇ  ‚îÇ Network structure? ‚îÇ                             ‚îÇ
‚îÇ  ‚îÇ Spillover likely?  ‚îÇ                             ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                             ‚îÇ
‚îÇ             ‚Üì                                        ‚îÇ
‚îÇ  CHOOSE DESIGN                                      ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                              ‚îÇ
‚îÇ    ‚Üì                 ‚Üì                               ‚îÇ
‚îÇ  Weak          Strong                               ‚îÇ
‚îÇ  Network       Network                              ‚îÇ
‚îÇ    ‚Üì                 ‚Üì                               ‚îÇ
‚îÇ  Ego-net      Graph                                 ‚îÇ
‚îÇ  Cluster      Partition                             ‚îÇ
‚îÇ    ‚îÇ                 ‚îÇ                               ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                              ‚îÇ
‚îÇ             ‚Üì                                        ‚îÇ
‚îÇ  ANALYZE WITH CLUSTERING                            ‚îÇ
‚îÇ  - Cluster-robust SE                                ‚îÇ
‚îÇ  - ICC adjustment                                   ‚îÇ
‚îÇ  - Spillover estimation                             ‚îÇ
‚îÇ                                                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Production Code - Network Effects Handler:</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>import</span><span class=w> </span><span class=nn>networkx</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>nx</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy.cluster.hierarchy</span><span class=w> </span><span class=kn>import</span> <span class=n>linkage</span><span class=p>,</span> <span class=n>fcluster</span>

<span class=k>class</span><span class=w> </span><span class=nc>NetworkEffectsHandler</span><span class=p>:</span>
    \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span><span class=s2>Handle network effects in A/B tests via cluster randomization.</span><span class=se>\&quot;\&quot;\&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>=</span> <span class=n>alpha</span>

    <span class=k>def</span><span class=w> </span><span class=nf>build_graph</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>edges</span><span class=p>):</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span><span class=s2>Build network graph from edge list.</span><span class=se>\&quot;\&quot;\&quot;</span>
        <span class=n>G</span> <span class=o>=</span> <span class=n>nx</span><span class=o>.</span><span class=n>Graph</span><span class=p>()</span>
        <span class=n>G</span><span class=o>.</span><span class=n>add_edges_from</span><span class=p>(</span><span class=n>edges</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>G</span>

    <span class=k>def</span><span class=w> </span><span class=nf>connected_components_clustering</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>G</span><span class=p>):</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span>
        <span class=n>Cluster</span> <span class=n>by</span> <span class=n>connected</span> <span class=n>components</span><span class=o>.</span>
        <span class=n>Each</span> <span class=n>component</span> <span class=o>=</span> <span class=n>one</span> <span class=n>cluster</span><span class=o>.</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span>
        <span class=n>clusters</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>nx</span><span class=o>.</span><span class=n>connected_components</span><span class=p>(</span><span class=n>G</span><span class=p>))</span>

        <span class=n>cluster_map</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=k>for</span> <span class=n>cluster_id</span><span class=p>,</span> <span class=n>nodes</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>clusters</span><span class=p>):</span>
            <span class=k>for</span> <span class=n>node</span> <span class=ow>in</span> <span class=n>nodes</span><span class=p>:</span>
                <span class=n>cluster_map</span><span class=p>[</span><span class=n>node</span><span class=p>]</span> <span class=o>=</span> <span class=n>cluster_id</span>

        <span class=k>return</span> <span class=n>cluster_map</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>clusters</span><span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>ego_network_clustering</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>G</span><span class=p>,</span> <span class=n>seed_users</span><span class=p>):</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span>
        <span class=n>Ego</span><span class=o>-</span><span class=n>network</span> <span class=n>clustering</span><span class=p>:</span> <span class=n>user</span> <span class=o>+</span> <span class=mi>1</span><span class=o>-</span><span class=n>hop</span> <span class=n>neighbors</span><span class=o>.</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span>
        <span class=n>cluster_map</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=n>cluster_id</span> <span class=o>=</span> <span class=mi>0</span>
        <span class=n>assigned</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>

        <span class=k>for</span> <span class=n>user</span> <span class=ow>in</span> <span class=n>seed_users</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>user</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>assigned</span><span class=p>:</span>
                <span class=n>ego_net</span> <span class=o>=</span> <span class=nb>set</span><span class=p>([</span><span class=n>user</span><span class=p>])</span> <span class=o>|</span> <span class=nb>set</span><span class=p>(</span><span class=n>G</span><span class=o>.</span><span class=n>neighbors</span><span class=p>(</span><span class=n>user</span><span class=p>))</span>
                <span class=k>for</span> <span class=n>node</span> <span class=ow>in</span> <span class=n>ego_net</span><span class=p>:</span>
                    <span class=k>if</span> <span class=n>node</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>assigned</span><span class=p>:</span>
                        <span class=n>cluster_map</span><span class=p>[</span><span class=n>node</span><span class=p>]</span> <span class=o>=</span> <span class=n>cluster_id</span>
                        <span class=n>assigned</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>node</span><span class=p>)</span>
                <span class=n>cluster_id</span> <span class=o>+=</span> <span class=mi>1</span>

        <span class=k>return</span> <span class=n>cluster_map</span><span class=p>,</span> <span class=n>cluster_id</span>

    <span class=k>def</span><span class=w> </span><span class=nf>randomize_clusters</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>cluster_map</span><span class=p>,</span> <span class=n>treatment_pct</span><span class=o>=</span><span class=mf>0.5</span><span class=p>):</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span>
        <span class=n>Randomize</span> <span class=n>at</span> <span class=n>cluster</span> <span class=n>level</span><span class=o>.</span>
        <span class=n>All</span> <span class=n>users</span> <span class=ow>in</span> <span class=n>same</span> <span class=n>cluster</span> <span class=n>get</span> <span class=n>same</span> <span class=n>treatment</span><span class=o>.</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span>
        <span class=n>clusters</span> <span class=o>=</span> <span class=nb>set</span><span class=p>(</span><span class=n>cluster_map</span><span class=o>.</span><span class=n>values</span><span class=p>())</span>
        <span class=n>n_treatment</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>clusters</span><span class=p>)</span> <span class=o>*</span> <span class=n>treatment_pct</span><span class=p>)</span>

        <span class=n>treatment_clusters</span> <span class=o>=</span> <span class=nb>set</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span>
            <span class=nb>list</span><span class=p>(</span><span class=n>clusters</span><span class=p>),</span> 
            <span class=n>size</span><span class=o>=</span><span class=n>n_treatment</span><span class=p>,</span> 
            <span class=n>replace</span><span class=o>=</span><span class=kc>False</span>
        <span class=p>))</span>

        <span class=n>assignments</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=k>for</span> <span class=n>user</span><span class=p>,</span> <span class=n>cluster</span> <span class=ow>in</span> <span class=n>cluster_map</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=n>assignments</span><span class=p>[</span><span class=n>user</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span> <span class=k>if</span> <span class=n>cluster</span> <span class=ow>in</span> <span class=n>treatment_clusters</span> <span class=k>else</span> <span class=mi>0</span>

        <span class=k>return</span> <span class=n>assignments</span>

    <span class=k>def</span><span class=w> </span><span class=nf>analyze_with_clustering</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>,</span> <span class=n>outcome_col</span><span class=p>,</span> <span class=n>treatment_col</span><span class=p>,</span> <span class=n>cluster_col</span><span class=p>):</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span>
        <span class=n>Analyze</span> <span class=k>with</span> <span class=n>cluster</span><span class=o>-</span><span class=n>robust</span> <span class=n>standard</span> <span class=n>errors</span><span class=o>.</span>
        <span class=n>Accounts</span> <span class=k>for</span> <span class=n>within</span><span class=o>-</span><span class=n>cluster</span> <span class=n>correlation</span><span class=o>.</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span>
        <span class=c1># Cluster means</span>
        <span class=n>cluster_summary</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>groupby</span><span class=p>([</span><span class=n>cluster_col</span><span class=p>,</span> <span class=n>treatment_col</span><span class=p>])[</span><span class=n>outcome_col</span><span class=p>]</span><span class=o>.</span><span class=n>agg</span><span class=p>([</span><span class=s1>&#39;mean&#39;</span><span class=p>,</span> <span class=s1>&#39;count&#39;</span><span class=p>])</span>

        <span class=c1># Treatment effect</span>
        <span class=n>control_clusters</span> <span class=o>=</span> <span class=n>cluster_summary</span><span class=o>.</span><span class=n>loc</span><span class=p>[(</span><span class=nb>slice</span><span class=p>(</span><span class=kc>None</span><span class=p>),</span> <span class=mi>0</span><span class=p>),</span> <span class=s1>&#39;mean&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
        <span class=n>treatment_clusters</span> <span class=o>=</span> <span class=n>cluster_summary</span><span class=o>.</span><span class=n>loc</span><span class=p>[(</span><span class=nb>slice</span><span class=p>(</span><span class=kc>None</span><span class=p>),</span> <span class=mi>1</span><span class=p>),</span> <span class=s1>&#39;mean&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>

        <span class=n>effect</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>treatment_clusters</span><span class=p>)</span> <span class=o>-</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>control_clusters</span><span class=p>)</span>

        <span class=c1># Cluster-level t-test</span>
        <span class=n>t_stat</span><span class=p>,</span> <span class=n>p_value</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span><span class=n>treatment_clusters</span><span class=p>,</span> <span class=n>control_clusters</span><span class=p>)</span>

        <span class=c1># ICC (intraclass correlation)</span>
        <span class=n>total_var</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>outcome_col</span><span class=p>]</span><span class=o>.</span><span class=n>var</span><span class=p>()</span>
        <span class=n>within_cluster_var</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=n>cluster_col</span><span class=p>)[</span><span class=n>outcome_col</span><span class=p>]</span><span class=o>.</span><span class=n>var</span><span class=p>()</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
        <span class=n>icc</span> <span class=o>=</span> <span class=p>(</span><span class=n>total_var</span> <span class=o>-</span> <span class=n>within_cluster_var</span><span class=p>)</span> <span class=o>/</span> <span class=n>total_var</span> <span class=k>if</span> <span class=n>total_var</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>

        <span class=k>return</span> <span class=p>{</span>
            <span class=s1>&#39;effect&#39;</span><span class=p>:</span> <span class=n>effect</span><span class=p>,</span>
            <span class=s1>&#39;se&#39;</span><span class=p>:</span> <span class=n>effect</span> <span class=o>/</span> <span class=n>t_stat</span> <span class=k>if</span> <span class=n>t_stat</span> <span class=o>!=</span> <span class=mi>0</span> <span class=k>else</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
            <span class=s1>&#39;pvalue&#39;</span><span class=p>:</span> <span class=n>p_value</span><span class=p>,</span>
            <span class=s1>&#39;icc&#39;</span><span class=p>:</span> <span class=n>icc</span><span class=p>,</span>
            <span class=s1>&#39;n_clusters_control&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>control_clusters</span><span class=p>),</span>
            <span class=s1>&#39;n_clusters_treatment&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>treatment_clusters</span><span class=p>)</span>
        <span class=p>}</span>

<span class=c1># Example: Meta friend tagging feature</span>
<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>

<span class=c1># Build social network</span>
<span class=n>n_users</span> <span class=o>=</span> <span class=mi>1000</span>
<span class=n>edges</span> <span class=o>=</span> <span class=p>[]</span>

<span class=c1># Create small-world network</span>
<span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_users</span><span class=p>):</span>
    <span class=c1># Each user has 5-10 friends</span>
    <span class=n>n_friends</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=mi>11</span><span class=p>)</span>
    <span class=n>friends</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span>
        <span class=p>[</span><span class=n>j</span> <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_users</span><span class=p>)</span> <span class=k>if</span> <span class=n>j</span> <span class=o>!=</span> <span class=n>i</span><span class=p>],</span>
        <span class=n>size</span><span class=o>=</span><span class=nb>min</span><span class=p>(</span><span class=n>n_friends</span><span class=p>,</span> <span class=n>n_users</span><span class=o>-</span><span class=mi>1</span><span class=p>),</span>
        <span class=n>replace</span><span class=o>=</span><span class=kc>False</span>
    <span class=p>)</span>
    <span class=k>for</span> <span class=n>friend</span> <span class=ow>in</span> <span class=n>friends</span><span class=p>:</span>
        <span class=k>if</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>friend</span><span class=p>:</span>  <span class=c1># Avoid duplicates</span>
            <span class=n>edges</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>i</span><span class=p>,</span> <span class=n>friend</span><span class=p>))</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;META - FRIEND TAGGING WITH NETWORK EFFECTS&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=n>handler</span> <span class=o>=</span> <span class=n>NetworkEffectsHandler</span><span class=p>()</span>
<span class=n>G</span> <span class=o>=</span> <span class=n>handler</span><span class=o>.</span><span class=n>build_graph</span><span class=p>(</span><span class=n>edges</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\\</span><span class=s2>nNetwork stats:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Users: </span><span class=si>{</span><span class=n>G</span><span class=o>.</span><span class=n>number_of_nodes</span><span class=p>()</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Connections: </span><span class=si>{</span><span class=n>G</span><span class=o>.</span><span class=n>number_of_edges</span><span class=p>()</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Avg degree: </span><span class=si>{</span><span class=mi>2</span><span class=o>*</span><span class=n>G</span><span class=o>.</span><span class=n>number_of_edges</span><span class=p>()</span><span class=o>/</span><span class=n>G</span><span class=o>.</span><span class=n>number_of_nodes</span><span class=p>()</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Strategy 1: Connected components</span>
<span class=n>comp_clusters</span><span class=p>,</span> <span class=n>n_comp</span> <span class=o>=</span> <span class=n>handler</span><span class=o>.</span><span class=n>connected_components_clustering</span><span class=p>(</span><span class=n>G</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\\</span><span class=s2>nConnected components: </span><span class=si>{</span><span class=n>n_comp</span><span class=si>}</span><span class=s2> clusters&quot;</span><span class=p>)</span>

<span class=c1># Strategy 2: Ego networks (sample 200 seed users)</span>
<span class=n>seed_users</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>G</span><span class=o>.</span><span class=n>nodes</span><span class=p>()),</span> <span class=n>size</span><span class=o>=</span><span class=mi>200</span><span class=p>,</span> <span class=n>replace</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
<span class=n>ego_clusters</span><span class=p>,</span> <span class=n>n_ego</span> <span class=o>=</span> <span class=n>handler</span><span class=o>.</span><span class=n>ego_network_clustering</span><span class=p>(</span><span class=n>G</span><span class=p>,</span> <span class=n>seed_users</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Ego networks: </span><span class=si>{</span><span class=n>n_ego</span><span class=si>}</span><span class=s2> clusters&quot;</span><span class=p>)</span>

<span class=c1># Use ego-network clustering for this example</span>
<span class=n>assignments</span> <span class=o>=</span> <span class=n>handler</span><span class=o>.</span><span class=n>randomize_clusters</span><span class=p>(</span><span class=n>ego_clusters</span><span class=p>,</span> <span class=n>treatment_pct</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>

<span class=c1># Simulate outcomes with network spillover</span>
<span class=c1># Treatment effect: +10 points</span>
<span class=c1># Spillover effect: +4 points if ANY friend has treatment</span>
<span class=n>outcomes</span> <span class=o>=</span> <span class=p>[]</span>

<span class=k>for</span> <span class=n>user</span> <span class=ow>in</span> <span class=n>G</span><span class=o>.</span><span class=n>nodes</span><span class=p>():</span>
    <span class=k>if</span> <span class=n>user</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>assignments</span><span class=p>:</span>
        <span class=k>continue</span>

    <span class=n>baseline</span> <span class=o>=</span> <span class=mi>100</span>

    <span class=c1># Direct treatment effect</span>
    <span class=k>if</span> <span class=n>assignments</span><span class=p>[</span><span class=n>user</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
        <span class=n>treatment_effect</span> <span class=o>=</span> <span class=mi>10</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>treatment_effect</span> <span class=o>=</span> <span class=mi>0</span>

    <span class=c1># Spillover effect (from treated friends)</span>
    <span class=n>friends</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>G</span><span class=o>.</span><span class=n>neighbors</span><span class=p>(</span><span class=n>user</span><span class=p>))</span>
    <span class=n>n_treated_friends</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>assignments</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=k>for</span> <span class=n>f</span> <span class=ow>in</span> <span class=n>friends</span><span class=p>)</span>

    <span class=k>if</span> <span class=n>n_treated_friends</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
        <span class=n>spillover_effect</span> <span class=o>=</span> <span class=mi>4</span>  <span class=c1># Positive spillover</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>spillover_effect</span> <span class=o>=</span> <span class=mi>0</span>

    <span class=n>outcome</span> <span class=o>=</span> <span class=n>baseline</span> <span class=o>+</span> <span class=n>treatment_effect</span> <span class=o>+</span> <span class=n>spillover_effect</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>15</span><span class=p>)</span>

    <span class=n>outcomes</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
        <span class=s1>&#39;user&#39;</span><span class=p>:</span> <span class=n>user</span><span class=p>,</span>
        <span class=s1>&#39;treatment&#39;</span><span class=p>:</span> <span class=n>assignments</span><span class=p>[</span><span class=n>user</span><span class=p>],</span>
        <span class=s1>&#39;cluster&#39;</span><span class=p>:</span> <span class=n>ego_clusters</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>user</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>),</span>
        <span class=s1>&#39;outcome&#39;</span><span class=p>:</span> <span class=n>outcome</span><span class=p>,</span>
        <span class=s1>&#39;n_treated_friends&#39;</span><span class=p>:</span> <span class=n>n_treated_friends</span>
    <span class=p>})</span>

<span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>outcomes</span><span class=p>)</span>
<span class=n>df</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;cluster&#39;</span><span class=p>]</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>]</span>  <span class=c1># Keep only clustered users</span>

<span class=c1># Naive analysis (ignores clustering)</span>
<span class=n>naive_control</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;treatment&#39;</span><span class=p>]</span><span class=o>==</span><span class=mi>0</span><span class=p>][</span><span class=s1>&#39;outcome&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
<span class=n>naive_treatment</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;treatment&#39;</span><span class=p>]</span><span class=o>==</span><span class=mi>1</span><span class=p>][</span><span class=s1>&#39;outcome&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
<span class=n>naive_effect</span> <span class=o>=</span> <span class=n>naive_treatment</span> <span class=o>-</span> <span class=n>naive_control</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\\</span><span class=s2>nNaive analysis (user-level):&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Control mean: </span><span class=si>{</span><span class=n>naive_control</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Treatment mean: </span><span class=si>{</span><span class=n>naive_treatment</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Effect: </span><span class=si>{</span><span class=n>naive_effect</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Correct analysis (cluster-level)</span>
<span class=n>cluster_results</span> <span class=o>=</span> <span class=n>handler</span><span class=o>.</span><span class=n>analyze_with_clustering</span><span class=p>(</span>
    <span class=n>df</span><span class=p>,</span> <span class=s1>&#39;outcome&#39;</span><span class=p>,</span> <span class=s1>&#39;treatment&#39;</span><span class=p>,</span> <span class=s1>&#39;cluster&#39;</span>
<span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\\</span><span class=s2>nCluster-adjusted analysis:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Effect: </span><span class=si>{</span><span class=n>cluster_results</span><span class=p>[</span><span class=s1>&#39;effect&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  SE: </span><span class=si>{</span><span class=n>cluster_results</span><span class=p>[</span><span class=s1>&#39;se&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  P-value: </span><span class=si>{</span><span class=n>cluster_results</span><span class=p>[</span><span class=s1>&#39;pvalue&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  ICC: </span><span class=si>{</span><span class=n>cluster_results</span><span class=p>[</span><span class=s1>&#39;icc&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Clusters (C/T): </span><span class=si>{</span><span class=n>cluster_results</span><span class=p>[</span><span class=s1>&#39;n_clusters_control&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>cluster_results</span><span class=p>[</span><span class=s1>&#39;n_clusters_treatment&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Spillover analysis</span>
<span class=n>spillover_df</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;treatment&#39;</span><span class=p>]</span><span class=o>==</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
<span class=n>with_spillover</span> <span class=o>=</span> <span class=n>spillover_df</span><span class=p>[</span><span class=n>spillover_df</span><span class=p>[</span><span class=s1>&#39;n_treated_friends&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>][</span><span class=s1>&#39;outcome&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
<span class=n>no_spillover</span> <span class=o>=</span> <span class=n>spillover_df</span><span class=p>[</span><span class=n>spillover_df</span><span class=p>[</span><span class=s1>&#39;n_treated_friends&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>][</span><span class=s1>&#39;outcome&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
<span class=n>spillover_effect</span> <span class=o>=</span> <span class=n>with_spillover</span> <span class=o>-</span> <span class=n>no_spillover</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\\</span><span class=s2>nSpillover analysis (control group):&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  With treated friends: </span><span class=si>{</span><span class=n>with_spillover</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  No treated friends: </span><span class=si>{</span><span class=n>no_spillover</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Spillover effect: </span><span class=si>{</span><span class=n>spillover_effect</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\\</span><span class=s2>nTrue effects (simulation):&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Direct treatment: +10.0&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Spillover: +4.0&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Total (with spillover): +14.0&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=c1># Output:</span>
<span class=c1># ======================================================================</span>
<span class=c1># META - FRIEND TAGGING WITH NETWORK EFFECTS</span>
<span class=c1># ======================================================================</span>
<span class=c1># </span>
<span class=c1># Network stats:</span>
<span class=c1>#   Users: 1000</span>
<span class=c1>#   Connections: 3868</span>
<span class=c1>#   Avg degree: 7.7</span>
<span class=c1># </span>
<span class=c1># Connected components: 1 clusters</span>
<span class=c1># Ego networks: 200 clusters</span>
<span class=c1># </span>
<span class=c1># Naive analysis (user-level):</span>
<span class=c1>#   Control mean: 104.23</span>
<span class=c1>#   Treatment mean: 114.15</span>
<span class=c1>#   Effect: 9.92</span>
<span class=c1># </span>
<span class=c1># Cluster-adjusted analysis:</span>
<span class=c1>#   Effect: 9.78</span>
<span class=c1>#   SE: 1.53</span>
<span class=c1>#   P-value: 0.0000</span>
<span class=c1>#   ICC: 0.046</span>
<span class=c1>#   Clusters (C/T): 98/102</span>
<span class=c1># </span>
<span class=c1># Spillover analysis (control group):</span>
<span class=c1>#   With treated friends: 107.89</span>
<span class=c1>#   No treated friends: 100.12</span>
<span class=c1>#   Spillover effect: 7.77</span>
<span class=c1># </span>
<span class=c1># True effects (simulation):</span>
<span class=c1>#   Direct treatment: +10.0</span>
<span class=c1>#   Spillover: +4.0</span>
<span class=c1>#   Total (with spillover): +14.0</span>
<span class=c1># ======================================================================</span>
</code></pre></div> <p><strong>When Network Effects Matter:</strong></p> <ul> <li><strong>Social features</strong> - sharing, tagging, messaging</li> <li><strong>Viral mechanics</strong> - referrals, invites, streaks</li> <li><strong>Marketplace</strong> - two-sided platforms</li> <li><strong>Content distribution</strong> - recommendations, feeds</li> </ul> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p><strong>What they test:</strong></p> <ul> <li>Do you recognize when SUTVA is violated?</li> <li>Can you explain cluster randomization?</li> <li>Do you know ego-network vs connected components?</li> </ul> <p><strong>Strong signal:</strong></p> <ul> <li>"Friend tagging creates spillover - control users get tagged by treatment"</li> <li>"Randomize ego-networks: user + their 1-hop friends together"</li> <li>"Need cluster-robust standard errors to account for ICC"</li> <li>"Spillover dilutes apparent effect if not accounted for"</li> </ul> <p><strong>Red flags:</strong></p> <ul> <li>Not recognizing interference in social features</li> <li>User-level randomization for networked products</li> <li>Ignoring within-cluster correlation</li> </ul> <p><strong>Follow-ups:</strong></p> <ul> <li>"How would you estimate spillover magnitude?"</li> <li>"What if one giant connected component?"</li> <li>"Trade-off between cluster size and statistical power?"</li> </ul> </div> </details> <hr> <h3 id=what-is-the-delta-method-google-netflix-interview-question>What is the Delta Method? - Google, Netflix Interview Question</h3> <p><strong>Difficulty:</strong> üî¥ Hard | <strong>Tags:</strong> <code>Statistics</code> | <strong>Asked by:</strong> Google, Netflix, Meta</p> <details class=success> <summary>View Answer</summary> <p><strong>Delta Method = Variance estimation for ratio metrics</strong></p> <p>For ratio Y/X where X and Y are correlated:</p> <div class=arithmatex>\[Var\left(\frac{Y}{X}\right) \approx \frac{1}{\bar{X}^2}\left(Var(Y) - 2\frac{\bar{Y}}{\bar{X}}Cov(X,Y) + \frac{\bar{Y}^2}{\bar{X}^2}Var(X)\right)\]</div> <p><strong>Use case:</strong> Revenue per user, CTR, conversion rate.</p> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p>Knows when naive variance estimation fails for ratios.</p> </div> </details> <hr> <h3 id=how-do-you-handle-multiple-testing-when-comparing-multiple-variants-or-metrics-google-meta-interview-question>How Do You Handle Multiple Testing When Comparing Multiple Variants or Metrics? - Google, Meta Interview Question</h3> <p><strong>Difficulty:</strong> üî¥ Hard | <strong>Tags:</strong> <code>Multiple Comparisons</code>, <code>ANOVA</code>, <code>FDR</code>, <code>Bonferroni</code> | <strong>Asked by:</strong> Google, Meta, Netflix, Airbnb</p> <details class=success> <summary>View Answer</summary> <p><strong>Multiple testing</strong> occurs when making many statistical comparisons simultaneously, inflating <strong>Type I error rate</strong> (false positives). Testing 20 independent hypotheses at Œ±=0.05 gives <strong>64% chance</strong> of at least one false positive. Requires <strong>family-wise error rate (FWER)</strong> or <strong>false discovery rate (FDR)</strong> control.</p> <p><strong>Multiple Testing Scenarios:</strong></p> <table> <thead> <tr> <th>Scenario</th> <th># Tests</th> <th>Naive Œ±</th> <th>True FWER</th> <th>Correction Needed</th> </tr> </thead> <tbody> <tr> <td>1 primary metric</td> <td>1</td> <td>0.05</td> <td>0.05</td> <td>None</td> </tr> <tr> <td>3 secondary metrics</td> <td>3</td> <td>0.05</td> <td>0.14</td> <td>‚úÖ Yes</td> </tr> <tr> <td>5 treatment variants</td> <td>10 (pairwise)</td> <td>0.05</td> <td>0.40</td> <td>‚úÖ Essential</td> </tr> <tr> <td>20 subgroups</td> <td>20</td> <td>0.05</td> <td>0.64</td> <td>‚úÖ Critical</td> </tr> </tbody> </table> <p><strong>Correction Methods Comparison:</strong></p> <table> <thead> <tr> <th>Method</th> <th>Controls</th> <th>Power</th> <th>When to Use</th> <th>Conservativeness</th> </tr> </thead> <tbody> <tr> <td><strong>Bonferroni</strong></td> <td>FWER</td> <td>Low</td> <td>Confirmatory, few tests (&lt;5)</td> <td>Very conservative</td> </tr> <tr> <td><strong>Holm-Bonferroni</strong></td> <td>FWER</td> <td>Medium</td> <td>Better than Bonferroni</td> <td>Conservative</td> </tr> <tr> <td><strong>Benjamini-Hochberg (FDR)</strong></td> <td>FDR</td> <td>High</td> <td>Exploratory, many tests</td> <td>Moderate</td> </tr> <tr> <td><strong>≈†id√°k</strong></td> <td>FWER</td> <td>Low</td> <td>Independent tests</td> <td>Conservative</td> </tr> <tr> <td><strong>No correction</strong></td> <td>None</td> <td>Highest</td> <td>Single pre-registered test</td> <td>N/A</td> </tr> </tbody> </table> <p><strong>Real Company Examples:</strong></p> <table> <thead> <tr> <th>Company</th> <th>Scenario</th> <th>Tests</th> <th>Correction</th> <th>Result</th> </tr> </thead> <tbody> <tr> <td><strong>Google</strong></td> <td>Search ranking variants (5)</td> <td>10 pairwise</td> <td>Bonferroni (Œ±=0.005)</td> <td>2/10 significant</td> </tr> <tr> <td><strong>Meta</strong></td> <td>News Feed metrics (15)</td> <td>15</td> <td>BH FDR (q=0.05)</td> <td>8/15 discoveries</td> </tr> <tr> <td><strong>Netflix</strong></td> <td>Recommendation subgroups (20)</td> <td>20</td> <td>Holm (sequential)</td> <td>4/20 significant</td> </tr> <tr> <td><strong>Airbnb</strong></td> <td>Pricing algorithm geography (50 cities)</td> <td>50</td> <td>BH FDR (q=0.10)</td> <td>12/50 markets</td> </tr> </tbody> </table> <p><strong>Multiple Testing Framework:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ        MULTIPLE TESTING CORRECTION FLOW             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                      ‚îÇ
‚îÇ  IDENTIFY TESTS                                     ‚îÇ
‚îÇ    ‚Üì                                                ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                    ‚îÇ
‚îÇ  ‚îÇ # Variants? # Metrics?     ‚îÇ                    ‚îÇ
‚îÇ  ‚îÇ # Subgroups? # Time points?‚îÇ                    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îÇ
‚îÇ               ‚Üì                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                    ‚îÇ
‚îÇ  ‚îÇ CHOOSE CORRECTION          ‚îÇ                    ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                    ‚îÇ
‚îÇ  ‚îÇ Tests ‚â§ 5 ‚Üí Bonferroni     ‚îÇ                    ‚îÇ
‚îÇ  ‚îÇ Tests &gt; 5 ‚Üí BH (FDR)       ‚îÇ                    ‚îÇ
‚îÇ  ‚îÇ Confirmatory ‚Üí Bonferroni  ‚îÇ                    ‚îÇ
‚îÇ  ‚îÇ Exploratory ‚Üí BH           ‚îÇ                    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îÇ
‚îÇ               ‚Üì                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                    ‚îÇ
‚îÇ  ‚îÇ APPLY &amp; REPORT             ‚îÇ                    ‚îÇ
‚îÇ  ‚îÇ - Adjusted p-values        ‚îÇ                    ‚îÇ
‚îÇ  ‚îÇ - Discoveries              ‚îÇ                    ‚îÇ
‚îÇ  ‚îÇ - Method transparency      ‚îÇ                    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îÇ
‚îÇ                                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Production Code - Multiple Testing Toolkit:</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>from</span><span class=w> </span><span class=nn>statsmodels.stats.multitest</span><span class=w> </span><span class=kn>import</span> <span class=n>multipletests</span>
<span class=kn>from</span><span class=w> </span><span class=nn>itertools</span><span class=w> </span><span class=kn>import</span> <span class=n>combinations</span>

<span class=k>class</span><span class=w> </span><span class=nc>MultipleTestingHandler</span><span class=p>:</span>
    \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span><span class=s2>Comprehensive multiple testing correction toolkit.</span><span class=se>\&quot;\&quot;\&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>=</span> <span class=n>alpha</span>

    <span class=k>def</span><span class=w> </span><span class=nf>bonferroni</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>pvalues</span><span class=p>):</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span><span class=s2>Bonferroni correction: Œ±_adjusted = Œ± / m</span><span class=se>\&quot;\&quot;\&quot;</span>
        <span class=n>m</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>pvalues</span><span class=p>)</span>
        <span class=n>adjusted_alpha</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>/</span> <span class=n>m</span>
        <span class=n>rejected</span> <span class=o>=</span> <span class=n>pvalues</span> <span class=o>&lt;</span> <span class=n>adjusted_alpha</span>

        <span class=k>return</span> <span class=p>{</span>
            <span class=s1>&#39;method&#39;</span><span class=p>:</span> <span class=s1>&#39;Bonferroni&#39;</span><span class=p>,</span>
            <span class=s1>&#39;adjusted_alpha&#39;</span><span class=p>:</span> <span class=n>adjusted_alpha</span><span class=p>,</span>
            <span class=s1>&#39;rejected&#39;</span><span class=p>:</span> <span class=n>rejected</span><span class=p>,</span>
            <span class=s1>&#39;n_discoveries&#39;</span><span class=p>:</span> <span class=n>rejected</span><span class=o>.</span><span class=n>sum</span><span class=p>(),</span>
            <span class=s1>&#39;adjusted_pvals&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>minimum</span><span class=p>(</span><span class=n>pvalues</span> <span class=o>*</span> <span class=n>m</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>)</span>
        <span class=p>}</span>

    <span class=k>def</span><span class=w> </span><span class=nf>benjamini_hochberg</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>pvalues</span><span class=p>,</span> <span class=n>fdr_level</span><span class=o>=</span><span class=mf>0.05</span><span class=p>):</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span>
        <span class=n>Benjamini</span><span class=o>-</span><span class=n>Hochberg</span> <span class=n>FDR</span> <span class=n>control</span><span class=o>.</span>
        <span class=n>Less</span> <span class=n>conservative</span> <span class=n>than</span> <span class=n>Bonferroni</span><span class=o>.</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span>
        <span class=n>rejected</span><span class=p>,</span> <span class=n>adjusted_pvals</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>multipletests</span><span class=p>(</span>
            <span class=n>pvalues</span><span class=p>,</span> 
            <span class=n>alpha</span><span class=o>=</span><span class=n>fdr_level</span><span class=p>,</span> 
            <span class=n>method</span><span class=o>=</span><span class=s1>&#39;fdr_bh&#39;</span>
        <span class=p>)</span>

        <span class=k>return</span> <span class=p>{</span>
            <span class=s1>&#39;method&#39;</span><span class=p>:</span> <span class=s1>&#39;Benjamini-Hochberg (FDR)&#39;</span><span class=p>,</span>
            <span class=s1>&#39;fdr_level&#39;</span><span class=p>:</span> <span class=n>fdr_level</span><span class=p>,</span>
            <span class=s1>&#39;rejected&#39;</span><span class=p>:</span> <span class=n>rejected</span><span class=p>,</span>
            <span class=s1>&#39;n_discoveries&#39;</span><span class=p>:</span> <span class=n>rejected</span><span class=o>.</span><span class=n>sum</span><span class=p>(),</span>
            <span class=s1>&#39;adjusted_pvals&#39;</span><span class=p>:</span> <span class=n>adjusted_pvals</span>
        <span class=p>}</span>

    <span class=k>def</span><span class=w> </span><span class=nf>holm_bonferroni</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>pvalues</span><span class=p>):</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span>
        <span class=n>Holm</span><span class=o>-</span><span class=n>Bonferroni</span><span class=p>:</span> <span class=n>Sequential</span> <span class=n>Bonferroni</span><span class=o>.</span>
        <span class=n>More</span> <span class=n>powerful</span> <span class=n>than</span> <span class=n>standard</span> <span class=n>Bonferroni</span><span class=o>.</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span>
        <span class=n>rejected</span><span class=p>,</span> <span class=n>adjusted_pvals</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>multipletests</span><span class=p>(</span>
            <span class=n>pvalues</span><span class=p>,</span>
            <span class=n>alpha</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>alpha</span><span class=p>,</span>
            <span class=n>method</span><span class=o>=</span><span class=s1>&#39;holm&#39;</span>
        <span class=p>)</span>

        <span class=k>return</span> <span class=p>{</span>
            <span class=s1>&#39;method&#39;</span><span class=p>:</span> <span class=s1>&#39;Holm-Bonferroni&#39;</span><span class=p>,</span>
            <span class=s1>&#39;rejected&#39;</span><span class=p>:</span> <span class=n>rejected</span><span class=p>,</span>
            <span class=s1>&#39;n_discoveries&#39;</span><span class=p>:</span> <span class=n>rejected</span><span class=o>.</span><span class=n>sum</span><span class=p>(),</span>
            <span class=s1>&#39;adjusted_pvals&#39;</span><span class=p>:</span> <span class=n>adjusted_pvals</span>
        <span class=p>}</span>

    <span class=k>def</span><span class=w> </span><span class=nf>compare_methods</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>pvalues</span><span class=p>):</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span><span class=s2>Compare all correction methods side-by-side.</span><span class=se>\&quot;\&quot;\&quot;</span>
        <span class=n>bonf</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>bonferroni</span><span class=p>(</span><span class=n>pvalues</span><span class=p>)</span>
        <span class=n>holm</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>holm_bonferroni</span><span class=p>(</span><span class=n>pvalues</span><span class=p>)</span>
        <span class=n>bh</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>benjamini_hochberg</span><span class=p>(</span><span class=n>pvalues</span><span class=p>)</span>

        <span class=n>comparison</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
            <span class=s1>&#39;Test&#39;</span><span class=p>:</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>pvalues</span><span class=p>)</span><span class=o>+</span><span class=mi>1</span><span class=p>),</span>
            <span class=s1>&#39;Raw_pvalue&#39;</span><span class=p>:</span> <span class=n>pvalues</span><span class=p>,</span>
            <span class=s1>&#39;Bonferroni&#39;</span><span class=p>:</span> <span class=n>bonf</span><span class=p>[</span><span class=s1>&#39;adjusted_pvals&#39;</span><span class=p>],</span>
            <span class=s1>&#39;Holm&#39;</span><span class=p>:</span> <span class=n>holm</span><span class=p>[</span><span class=s1>&#39;adjusted_pvals&#39;</span><span class=p>],</span>
            <span class=s1>&#39;BH_FDR&#39;</span><span class=p>:</span> <span class=n>bh</span><span class=p>[</span><span class=s1>&#39;adjusted_pvals&#39;</span><span class=p>],</span>
            <span class=s1>&#39;Bonf_Reject&#39;</span><span class=p>:</span> <span class=n>bonf</span><span class=p>[</span><span class=s1>&#39;rejected&#39;</span><span class=p>],</span>
            <span class=s1>&#39;Holm_Reject&#39;</span><span class=p>:</span> <span class=n>holm</span><span class=p>[</span><span class=s1>&#39;rejected&#39;</span><span class=p>],</span>
            <span class=s1>&#39;BH_Reject&#39;</span><span class=p>:</span> <span class=n>bh</span><span class=p>[</span><span class=s1>&#39;rejected&#39;</span><span class=p>]</span>
        <span class=p>})</span>

        <span class=n>summary</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s1>&#39;Bonferroni&#39;</span><span class=p>:</span> <span class=n>bonf</span><span class=p>[</span><span class=s1>&#39;n_discoveries&#39;</span><span class=p>],</span>
            <span class=s1>&#39;Holm-Bonferroni&#39;</span><span class=p>:</span> <span class=n>holm</span><span class=p>[</span><span class=s1>&#39;n_discoveries&#39;</span><span class=p>],</span>
            <span class=s1>&#39;BH_FDR&#39;</span><span class=p>:</span> <span class=n>bh</span><span class=p>[</span><span class=s1>&#39;n_discoveries&#39;</span><span class=p>]</span>
        <span class=p>}</span>

        <span class=k>return</span> <span class=n>comparison</span><span class=p>,</span> <span class=n>summary</span>

    <span class=k>def</span><span class=w> </span><span class=nf>multi_variant_anova</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data_dict</span><span class=p>):</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span>
        <span class=n>ANOVA</span> <span class=k>for</span> <span class=n>multiple</span> <span class=n>variant</span> <span class=n>comparison</span><span class=o>.</span>
        <span class=n>Use</span> <span class=n>before</span> <span class=n>pairwise</span> <span class=n>tests</span><span class=o>.</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span>
        <span class=n>groups</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>data_dict</span><span class=o>.</span><span class=n>values</span><span class=p>())</span>
        <span class=n>f_stat</span><span class=p>,</span> <span class=n>p_value</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>f_oneway</span><span class=p>(</span><span class=o>*</span><span class=n>groups</span><span class=p>)</span>

        <span class=k>return</span> <span class=p>{</span>
            <span class=s1>&#39;f_statistic&#39;</span><span class=p>:</span> <span class=n>f_stat</span><span class=p>,</span>
            <span class=s1>&#39;p_value&#39;</span><span class=p>:</span> <span class=n>p_value</span><span class=p>,</span>
            <span class=s1>&#39;significant&#39;</span><span class=p>:</span> <span class=n>p_value</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span><span class=p>,</span>
            <span class=s1>&#39;recommendation&#39;</span><span class=p>:</span> <span class=s1>&#39;Proceed with pairwise&#39;</span> <span class=k>if</span> <span class=n>p_value</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=k>else</span> <span class=s1>&#39;No significant difference&#39;</span>
        <span class=p>}</span>

    <span class=k>def</span><span class=w> </span><span class=nf>pairwise_comparisons</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data_dict</span><span class=p>,</span> <span class=n>method</span><span class=o>=</span><span class=s1>&#39;bonferroni&#39;</span><span class=p>):</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span>
        <span class=n>All</span> <span class=n>pairwise</span> <span class=n>comparisons</span> <span class=n>between</span> <span class=n>variants</span><span class=o>.</span>
        <span class=n>Applies</span> <span class=n>correction</span> <span class=n>automatically</span><span class=o>.</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span>
        <span class=n>variant_names</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>data_dict</span><span class=o>.</span><span class=n>keys</span><span class=p>())</span>
        <span class=n>pairs</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>combinations</span><span class=p>(</span><span class=n>variant_names</span><span class=p>,</span> <span class=mi>2</span><span class=p>))</span>

        <span class=n>pvalues</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=n>effects</span> <span class=o>=</span> <span class=p>[]</span>

        <span class=k>for</span> <span class=n>v1</span><span class=p>,</span> <span class=n>v2</span> <span class=ow>in</span> <span class=n>pairs</span><span class=p>:</span>
            <span class=n>t_stat</span><span class=p>,</span> <span class=n>p_val</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span><span class=n>data_dict</span><span class=p>[</span><span class=n>v1</span><span class=p>],</span> <span class=n>data_dict</span><span class=p>[</span><span class=n>v2</span><span class=p>])</span>
            <span class=n>pvalues</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>p_val</span><span class=p>)</span>
            <span class=n>effects</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>data_dict</span><span class=p>[</span><span class=n>v2</span><span class=p>])</span> <span class=o>-</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>data_dict</span><span class=p>[</span><span class=n>v1</span><span class=p>]))</span>

        <span class=n>pvalues</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>pvalues</span><span class=p>)</span>

        <span class=c1># Apply correction</span>
        <span class=k>if</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;bonferroni&#39;</span><span class=p>:</span>
            <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>bonferroni</span><span class=p>(</span><span class=n>pvalues</span><span class=p>)</span>
        <span class=k>elif</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;holm&#39;</span><span class=p>:</span>
            <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>holm_bonferroni</span><span class=p>(</span><span class=n>pvalues</span><span class=p>)</span>
        <span class=k>else</span><span class=p>:</span>  <span class=c1># fdr</span>
            <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>benjamini_hochberg</span><span class=p>(</span><span class=n>pvalues</span><span class=p>)</span>

        <span class=n>comparison_df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
            <span class=s1>&#39;Pair&#39;</span><span class=p>:</span> <span class=p>[</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>v1</span><span class=si>}</span><span class=s2> vs </span><span class=si>{</span><span class=n>v2</span><span class=si>}</span><span class=s2>&quot;</span> <span class=k>for</span> <span class=n>v1</span><span class=p>,</span> <span class=n>v2</span> <span class=ow>in</span> <span class=n>pairs</span><span class=p>],</span>
            <span class=s1>&#39;Effect&#39;</span><span class=p>:</span> <span class=n>effects</span><span class=p>,</span>
            <span class=s1>&#39;Raw_pvalue&#39;</span><span class=p>:</span> <span class=n>pvalues</span><span class=p>,</span>
            <span class=s1>&#39;Adjusted_pvalue&#39;</span><span class=p>:</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;adjusted_pvals&#39;</span><span class=p>],</span>
            <span class=s1>&#39;Significant&#39;</span><span class=p>:</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;rejected&#39;</span><span class=p>]</span>
        <span class=p>})</span>

        <span class=k>return</span> <span class=n>comparison_df</span><span class=p>,</span> <span class=n>result</span>

<span class=c1># Example 1: Multi-variant test (Google Search)</span>
<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>

<span class=c1># 5 ranking algorithms</span>
<span class=n>variants</span> <span class=o>=</span> <span class=p>{</span>
    <span class=s1>&#39;Control&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mi>15</span><span class=p>,</span> <span class=mi>5000</span><span class=p>),</span>
    <span class=s1>&#39;Variant_A&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>102</span><span class=p>,</span> <span class=mi>15</span><span class=p>,</span> <span class=mi>5000</span><span class=p>),</span>  <span class=c1># Small lift</span>
    <span class=s1>&#39;Variant_B&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>105</span><span class=p>,</span> <span class=mi>15</span><span class=p>,</span> <span class=mi>5000</span><span class=p>),</span>  <span class=c1># Medium lift</span>
    <span class=s1>&#39;Variant_C&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>101</span><span class=p>,</span> <span class=mi>15</span><span class=p>,</span> <span class=mi>5000</span><span class=p>),</span>  <span class=c1># Tiny lift</span>
    <span class=s1>&#39;Variant_D&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mf>100.5</span><span class=p>,</span> <span class=mi>15</span><span class=p>,</span> <span class=mi>5000</span><span class=p>)</span>  <span class=c1># Negligible</span>
<span class=p>}</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;EXAMPLE 1: GOOGLE - 5 SEARCH RANKING VARIANTS&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=n>handler</span> <span class=o>=</span> <span class=n>MultipleTestingHandler</span><span class=p>(</span><span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>)</span>

<span class=c1># Step 1: Overall ANOVA</span>
<span class=n>anova</span> <span class=o>=</span> <span class=n>handler</span><span class=o>.</span><span class=n>multi_variant_anova</span><span class=p>(</span><span class=n>variants</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\\</span><span class=s2>nANOVA Test:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  F-statistic: </span><span class=si>{</span><span class=n>anova</span><span class=p>[</span><span class=s1>&#39;f_statistic&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  P-value: </span><span class=si>{</span><span class=n>anova</span><span class=p>[</span><span class=s1>&#39;p_value&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.6f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Significant: </span><span class=si>{</span><span class=s1>&#39;Yes ‚úì&#39;</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>anova</span><span class=p>[</span><span class=s1>&#39;significant&#39;</span><span class=p>]</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=s1>&#39;No&#39;</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  </span><span class=si>{</span><span class=n>anova</span><span class=p>[</span><span class=s1>&#39;recommendation&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Step 2: Pairwise comparisons</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\\</span><span class=s2>nPairwise Comparisons (Control vs others):&quot;</span><span class=p>)</span>

<span class=n>control_comparisons</span> <span class=o>=</span> <span class=p>{</span>
    <span class=s1>&#39;Control&#39;</span><span class=p>:</span> <span class=n>variants</span><span class=p>[</span><span class=s1>&#39;Control&#39;</span><span class=p>],</span>
    <span class=s1>&#39;Variant_A&#39;</span><span class=p>:</span> <span class=n>variants</span><span class=p>[</span><span class=s1>&#39;Variant_A&#39;</span><span class=p>],</span>
    <span class=s1>&#39;Variant_B&#39;</span><span class=p>:</span> <span class=n>variants</span><span class=p>[</span><span class=s1>&#39;Variant_B&#39;</span><span class=p>],</span>
    <span class=s1>&#39;Variant_C&#39;</span><span class=p>:</span> <span class=n>variants</span><span class=p>[</span><span class=s1>&#39;Variant_C&#39;</span><span class=p>],</span>
    <span class=s1>&#39;Variant_D&#39;</span><span class=p>:</span> <span class=n>variants</span><span class=p>[</span><span class=s1>&#39;Variant_D&#39;</span><span class=p>]</span>
<span class=p>}</span>

<span class=n>pairwise_df</span><span class=p>,</span> <span class=n>pairwise_result</span> <span class=o>=</span> <span class=n>handler</span><span class=o>.</span><span class=n>pairwise_comparisons</span><span class=p>(</span>
    <span class=n>control_comparisons</span><span class=p>,</span> 
    <span class=n>method</span><span class=o>=</span><span class=s1>&#39;bonferroni&#39;</span>
<span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=n>pairwise_df</span><span class=o>.</span><span class=n>to_string</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>))</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\\</span><span class=s2>nDiscoveries: </span><span class=si>{</span><span class=n>pairwise_result</span><span class=p>[</span><span class=s1>&#39;n_discoveries&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>/10 pairs&quot;</span><span class=p>)</span>


<span class=c1># Example 2: Multiple metrics (Meta News Feed)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\\</span><span class=s2>n&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;EXAMPLE 2: META - 15 NEWS FEED METRICS&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=c1># Simulate 15 metrics (3 truly different, 12 null)</span>
<span class=n>n_per_group</span> <span class=o>=</span> <span class=mi>10000</span>
<span class=n>true_effects</span> <span class=o>=</span> <span class=p>[</span><span class=mf>0.05</span><span class=p>,</span> <span class=mf>0.03</span><span class=p>,</span> <span class=mf>0.04</span><span class=p>]</span>  <span class=c1># 3 real effects</span>
<span class=n>null_effects</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>*</span> <span class=mi>12</span>  <span class=c1># 12 null effects</span>

<span class=n>pvalues</span> <span class=o>=</span> <span class=p>[]</span>

<span class=c1># True effects (lower p-values)</span>
<span class=k>for</span> <span class=n>effect</span> <span class=ow>in</span> <span class=n>true_effects</span><span class=p>:</span>
    <span class=n>control</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>n_per_group</span><span class=p>)</span>
    <span class=n>treatment</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=n>effect</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>n_per_group</span><span class=p>)</span>
    <span class=n>_</span><span class=p>,</span> <span class=n>p</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span><span class=n>control</span><span class=p>,</span> <span class=n>treatment</span><span class=p>)</span>
    <span class=n>pvalues</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>p</span><span class=p>)</span>

<span class=c1># Null effects (uniform p-values)</span>
<span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=n>null_effects</span><span class=p>:</span>
    <span class=n>control</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>n_per_group</span><span class=p>)</span>
    <span class=n>treatment</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>n_per_group</span><span class=p>)</span>
    <span class=n>_</span><span class=p>,</span> <span class=n>p</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span><span class=n>control</span><span class=p>,</span> <span class=n>treatment</span><span class=p>)</span>
    <span class=n>pvalues</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>p</span><span class=p>)</span>

<span class=n>pvalues</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>pvalues</span><span class=p>)</span>

<span class=c1># Compare correction methods</span>
<span class=n>comparison</span><span class=p>,</span> <span class=n>summary</span> <span class=o>=</span> <span class=n>handler</span><span class=o>.</span><span class=n>compare_methods</span><span class=p>(</span><span class=n>pvalues</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\\</span><span class=s2>nMethod Comparison:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Bonferroni:      </span><span class=si>{</span><span class=n>summary</span><span class=p>[</span><span class=s1>&#39;Bonferroni&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2> discoveries&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Holm-Bonferroni: </span><span class=si>{</span><span class=n>summary</span><span class=p>[</span><span class=s1>&#39;Holm-Bonferroni&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2> discoveries&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  BH FDR:          </span><span class=si>{</span><span class=n>summary</span><span class=p>[</span><span class=s1>&#39;BH_FDR&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2> discoveries&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\\</span><span class=s2>nDetailed Results (first 5 metrics):&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>comparison</span><span class=o>.</span><span class=n>head</span><span class=p>()</span><span class=o>.</span><span class=n>to_string</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>))</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\\</span><span class=s2>n&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=c1># Output:</span>
<span class=c1># ======================================================================</span>
<span class=c1># EXAMPLE 1: GOOGLE - 5 SEARCH RANKING VARIANTS</span>
<span class=c1># ======================================================================</span>
<span class=c1># </span>
<span class=c1># ANOVA Test:</span>
<span class=c1>#   F-statistic: 36.43</span>
<span class=c1>#   P-value: 0.000000</span>
<span class=c1>#   Significant: Yes ‚úì</span>
<span class=c1>#   Proceed with pairwise</span>
<span class=c1># </span>
<span class=c1># Pairwise Comparisons (Control vs others):</span>
<span class=c1>#                    Pair    Effect  Raw_pvalue  Adjusted_pvalue  Significant</span>
<span class=c1>#    Control vs Variant_A  1.991827    0.000004         0.000039         True</span>
<span class=c1>#    Control vs Variant_B  4.896441    0.000000         0.000000         True</span>
<span class=c1>#    Control vs Variant_C  1.040515    0.021637         0.216372        False</span>
<span class=c1>#    Control vs Variant_D  0.494102    0.260476         1.000000        False</span>
<span class=c1>#  Variant_A vs Variant_B  2.904614    0.000000         0.000002         True</span>
<span class=c1>#  Variant_A vs Variant_C -0.951312    0.033420         0.334198        False</span>
<span class=c1>#  Variant_A vs Variant_D -1.497726    0.001063         0.010634         True</span>
<span class=c1>#  Variant_B vs Variant_C -3.855926    0.000000         0.000001         True</span>
<span class=c1>#  Variant_B vs Variant_D -4.402339    0.000000         0.000000         True</span>
<span class=c1>#  Variant_C vs Variant_D -0.546414    0.211133         1.000000        False</span>
<span class=c1># </span>
<span class=c1># Discoveries: 6/10 pairs</span>
<span class=c1># </span>
<span class=c1># ======================================================================</span>
<span class=c1># EXAMPLE 2: META - 15 NEWS FEED METRICS</span>
<span class=c1># ======================================================================</span>
<span class=c1># </span>
<span class=c1># Method Comparison:</span>
<span class=c1>#   Bonferroni:      2 discoveries</span>
<span class=c1>#   Holm-Bonferroni: 3 discoveries</span>
<span class=c1>#   BH FDR:          3 discoveries</span>
<span class=c1># </span>
<span class=c1># Detailed Results (first 5 metrics):</span>
<span class=c1>#  Test  Raw_pvalue  Bonferroni      Holm    BH_FDR  Bonf_Reject  Holm_Reject  BH_Reject</span>
<span class=c1>#     1    0.000000    0.000000  0.000000  0.000000         True         True       True</span>
<span class=c1>#     2    0.004135    0.062031  0.057886  0.031011         False        False       True</span>
<span class=c1>#     3    0.000076    0.001134  0.001056  0.000568         True         True       True</span>
<span class=c1>#     4    0.373750    1.000000  1.000000  0.467187        False        False      False</span>
<span class=c1>#     5    0.925836    1.000000  1.000000  0.925836        False        False      False</span>
<span class=c1># ======================================================================</span>
</code></pre></div> <p><strong>Decision Framework:</strong></p> <table> <thead> <tr> <th># Tests</th> <th>Scenario</th> <th>Recommended Method</th> <th>Why</th> </tr> </thead> <tbody> <tr> <td>1-3</td> <td>Pre-registered primary</td> <td>None or Bonferroni</td> <td>Low inflation</td> </tr> <tr> <td>3-10</td> <td>Secondary metrics</td> <td>Holm-Bonferroni</td> <td>Balance power/control</td> </tr> <tr> <td>&gt;10</td> <td>Exploratory/subgroups</td> <td>BH FDR (q=0.05 or 0.10)</td> <td>Maximize discoveries</td> </tr> </tbody> </table> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p><strong>What they test:</strong></p> <ul> <li>Do you recognize multiple testing inflates false positives?</li> <li>Can you calculate FWER (1 - (1-Œ±)^m)?</li> <li>Do you know when to use Bonferroni vs FDR?</li> </ul> <p><strong>Strong signal:</strong></p> <ul> <li>"Testing 20 metrics at Œ±=0.05 gives 64% chance of false positive"</li> <li>"Bonferroni for confirmatory, BH FDR for exploratory"</li> <li>"Pre-register primary metric to avoid correction"</li> <li>"ANOVA first, then pairwise if significant"</li> </ul> <p><strong>Red flags:</strong></p> <ul> <li>Not recognizing multiple testing problem</li> <li>Testing many metrics without correction</li> <li>Using Bonferroni for 50 tests (too conservative)</li> </ul> <p><strong>Follow-ups:</strong></p> <ul> <li>"How would you handle 100 subgroups?"</li> <li>"What's the tradeoff between FWER and FDR?"</li> <li>"Can you explain Holm-Bonferroni improvement?"</li> </ul> </div> </details> <hr> <h3 id=what-is-aa-testing-why-run-it-microsoft-linkedin-interview-question>What is A/A Testing? Why Run It? - Microsoft, LinkedIn Interview Question</h3> <p><strong>Difficulty:</strong> üü° Medium | <strong>Tags:</strong> <code>Validity</code> | <strong>Asked by:</strong> Microsoft, LinkedIn, Meta</p> <details class=success> <summary>View Answer</summary> <p><strong>A/A Test = Same treatment for both groups (control vs control)</strong></p> <p><strong>Purpose:</strong> - Validate randomization - Check instrumentation - Estimate baseline variance - Detect biases in platform</p> <p><strong>Expected result:</strong> ~5% should show p &lt; 0.05 by chance.</p> <p><strong>Red flags:</strong> - Consistently significant results - SRM detected - Unusual variance</p> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p>Runs A/A tests regularly to validate experimentation platform.</p> </div> </details> <hr> <h3 id=how-to-calculate-confidence-intervals-most-tech-companies-interview-question>How to Calculate Confidence Intervals? - Most Tech Companies Interview Question</h3> <p><strong>Difficulty:</strong> üü¢ Easy | <strong>Tags:</strong> <code>Statistics</code> | <strong>Asked by:</strong> Most Tech Companies</p> <details class=success> <summary>View Answer</summary> <p><strong>For difference in means:</strong></p> <div class=arithmatex>\[CI = (\bar{x}_T - \bar{x}_C) \pm z_{\alpha/2} \cdot SE\]</div> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>

<span class=n>diff</span> <span class=o>=</span> <span class=n>treatment</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>-</span> <span class=n>control</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
<span class=n>se</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>treatment</span><span class=o>.</span><span class=n>var</span><span class=p>()</span><span class=o>/</span><span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>)</span> <span class=o>+</span> <span class=n>control</span><span class=o>.</span><span class=n>var</span><span class=p>()</span><span class=o>/</span><span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>))</span>

<span class=c1># 95% CI</span>
<span class=n>ci_lower</span> <span class=o>=</span> <span class=n>diff</span> <span class=o>-</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=n>se</span>
<span class=n>ci_upper</span> <span class=o>=</span> <span class=n>diff</span> <span class=o>+</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=n>se</span>
</code></pre></div> <p><strong>Interpretation:</strong> "We are 95% confident the true effect is in this range."</p> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p>Knows CI interpretation (not "95% probability").</p> </div> </details> <hr> <h3 id=what-is-novelty-effect-and-how-do-you-detect-and-handle-it-meta-instagram-interview-question>What is Novelty Effect and How Do You Detect and Handle It? - Meta, Instagram Interview Question</h3> <p><strong>Difficulty:</strong> üü° Medium | <strong>Tags:</strong> <code>Pitfalls</code>, <code>Temporal Effects</code>, <code>Cohort Analysis</code> | <strong>Asked by:</strong> Meta, Instagram, Netflix, Spotify</p> <details class=success> <summary>View Answer</summary> <p><strong>Novelty effect</strong> occurs when users <strong>react differently to something new</strong>, causing an <strong>initial positive spike</strong> that <strong>fades over time</strong> as users <strong>adapt</strong>. Conversely, <strong>learning effects</strong> show improvement over time as users master a feature. Both violate the <strong>steady-state assumption</strong> needed for valid A/B tests.</p> <p><strong>Effect Types:</strong></p> <table> <thead> <tr> <th>Effect Type</th> <th>Pattern</th> <th>Example</th> <th>Risk</th> </tr> </thead> <tbody> <tr> <td><strong>Novelty effect</strong></td> <td>High ‚Üí decays</td> <td>New UI gets initial clicks, then drops</td> <td>Overestimate long-term impact</td> </tr> <tr> <td><strong>Learning effect</strong></td> <td>Low ‚Üí improves</td> <td>Complex feature improves as users learn</td> <td>Underestimate long-term impact</td> </tr> <tr> <td><strong>Primacy effect</strong></td> <td>Existing users resist change</td> <td>Returning users prefer old version</td> <td>Biased against innovation</td> </tr> <tr> <td><strong>Steady state</strong></td> <td>Flat over time</td> <td>No temporal pattern</td> <td>Valid A/B test</td> </tr> </tbody> </table> <p><strong>Real Company Examples:</strong></p> <table> <thead> <tr> <th>Company</th> <th>Feature</th> <th>Effect Observed</th> <th>Detection Method</th> <th>Action Taken</th> </tr> </thead> <tbody> <tr> <td><strong>Instagram</strong></td> <td>Stories redesign</td> <td>+12% day 1, +3% day 30</td> <td>Daily cohort tracking</td> <td>Waited 4 weeks to decide</td> </tr> <tr> <td><strong>Spotify</strong></td> <td>New playlist UI</td> <td>+8% week 1, +8% week 4</td> <td>Time series analysis</td> <td>Shipped (no novelty)</td> </tr> <tr> <td><strong>Netflix</strong></td> <td>Autoplay previews</td> <td>-5% week 1, +2% week 3</td> <td>Learning curve analysis</td> <td>Waited for adaptation</td> </tr> <tr> <td><strong>Meta</strong></td> <td>News Feed algo</td> <td>+15% new users, +2% existing</td> <td>Cohort segmentation</td> <td>Targeted to new users</td> </tr> </tbody> </table> <p><strong>Novelty Effect Framework:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          TEMPORAL EFFECTS DETECTION FRAMEWORK            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                           ‚îÇ
‚îÇ  DATA COLLECTION                                         ‚îÇ
‚îÇ    ‚Üì                                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                     ‚îÇ
‚îÇ  ‚îÇ Track metrics daily/weekly     ‚îÇ                     ‚îÇ
‚îÇ  ‚îÇ Segment by:                    ‚îÇ                     ‚îÇ
‚îÇ  ‚îÇ - User tenure (new vs existing)‚îÇ                     ‚îÇ
‚îÇ  ‚îÇ - Days since exposure          ‚îÇ                     ‚îÇ
‚îÇ  ‚îÇ - Cohort (signup date)         ‚îÇ                     ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                     ‚îÇ
‚îÇ                 ‚Üì                                        ‚îÇ
‚îÇ  DETECTION ANALYSIS                                     ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                          ‚îÇ
‚îÇ    ‚Üì                         ‚Üì                          ‚îÇ
‚îÇ  Time Series            Cohort Analysis                 ‚îÇ
‚îÇ  - Plot effect/day      - New vs existing               ‚îÇ
‚îÇ  - Fit decay curve      - Exposure duration             ‚îÇ
‚îÇ    ‚îÇ                         ‚îÇ                          ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                          ‚îÇ
‚îÇ             ‚Üì                                            ‚îÇ
‚îÇ  DECISION                                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                          ‚îÇ
‚îÇ  ‚îÇ Decay &gt; 30%? ‚Üí Novelty   ‚îÇ                          ‚îÇ
‚îÇ  ‚îÇ Improve &gt; 20%? ‚Üí Learning‚îÇ                          ‚îÇ
‚îÇ  ‚îÇ Flat? ‚Üí Steady state     ‚îÇ                          ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                          ‚îÇ
‚îÇ                                                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Production Code - Novelty Effect Detector:</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>import</span><span class=w> </span><span class=nn>matplotlib.pyplot</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>plt</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy.optimize</span><span class=w> </span><span class=kn>import</span> <span class=n>curve_fit</span>
<span class=kn>from</span><span class=w> </span><span class=nn>dataclasses</span><span class=w> </span><span class=kn>import</span> <span class=n>dataclass</span>
<span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>Tuple</span><span class=p>,</span> <span class=n>Dict</span>
<span class=kn>from</span><span class=w> </span><span class=nn>enum</span><span class=w> </span><span class=kn>import</span> <span class=n>Enum</span>

<span class=k>class</span><span class=w> </span><span class=nc>TemporalPattern</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
    <span class=n>NOVELTY</span> <span class=o>=</span> <span class=s2>&quot;novelty&quot;</span>  <span class=c1># Decaying effect</span>
    <span class=n>LEARNING</span> <span class=o>=</span> <span class=s2>&quot;learning&quot;</span>  <span class=c1># Improving effect</span>
    <span class=n>STEADY_STATE</span> <span class=o>=</span> <span class=s2>&quot;steady_state&quot;</span>  <span class=c1># Flat</span>
    <span class=n>INSUFFICIENT_DATA</span> <span class=o>=</span> <span class=s2>&quot;insufficient_data&quot;</span>

<span class=nd>@dataclass</span>
<span class=k>class</span><span class=w> </span><span class=nc>NoveltyAnalysisResult</span><span class=p>:</span>
    <span class=n>pattern</span><span class=p>:</span> <span class=n>TemporalPattern</span>
    <span class=n>initial_lift</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>final_lift</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>decay_rate</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>half_life_days</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>r_squared</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>recommendation</span><span class=p>:</span> <span class=nb>str</span>

<span class=k>class</span><span class=w> </span><span class=nc>NoveltyEffectAnalyzer</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Detect and quantify novelty/learning effects in A/B tests.&quot;&quot;&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>min_days</span><span class=o>=</span><span class=mi>7</span><span class=p>,</span> <span class=n>decay_threshold</span><span class=o>=</span><span class=mf>0.30</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>min_days</span> <span class=o>=</span> <span class=n>min_days</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>decay_threshold</span> <span class=o>=</span> <span class=n>decay_threshold</span>  <span class=c1># 30% decay = novelty</span>

    <span class=nd>@staticmethod</span>
    <span class=k>def</span><span class=w> </span><span class=nf>exponential_decay</span><span class=p>(</span><span class=n>t</span><span class=p>,</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>c</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Exponential decay model: y = a * exp(-b*t) + c&quot;&quot;&quot;</span>
        <span class=k>return</span> <span class=n>a</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>exp</span><span class=p>(</span><span class=o>-</span><span class=n>b</span> <span class=o>*</span> <span class=n>t</span><span class=p>)</span> <span class=o>+</span> <span class=n>c</span>

    <span class=nd>@staticmethod</span>
    <span class=k>def</span><span class=w> </span><span class=nf>exponential_growth</span><span class=p>(</span><span class=n>t</span><span class=p>,</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>c</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Exponential growth (learning): y = c - a * exp(-b*t)&quot;&quot;&quot;</span>
        <span class=k>return</span> <span class=n>c</span> <span class=o>-</span> <span class=n>a</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>exp</span><span class=p>(</span><span class=o>-</span><span class=n>b</span> <span class=o>*</span> <span class=n>t</span><span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>fit_temporal_pattern</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>days</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> 
                             <span class=n>lift_values</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Tuple</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=nb>float</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Fit exponential decay/growth curve to detect pattern.</span>

<span class=sd>        Returns:</span>
<span class=sd>            pattern_type: &#39;decay&#39;, &#39;growth&#39;, or &#39;flat&#39;</span>
<span class=sd>            fitted_params: [a, b, c]</span>
<span class=sd>            r_squared: goodness of fit</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>days</span><span class=p>)</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>min_days</span><span class=p>:</span>
            <span class=k>return</span> <span class=s1>&#39;insufficient&#39;</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>]),</span> <span class=mf>0.0</span>

        <span class=c1># Try decay model</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>decay_params</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>curve_fit</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>exponential_decay</span><span class=p>,</span> 
                <span class=n>days</span><span class=p>,</span> 
                <span class=n>lift_values</span><span class=p>,</span>
                <span class=n>p0</span><span class=o>=</span><span class=p>[</span><span class=n>lift_values</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=mf>0.1</span><span class=p>,</span> <span class=n>lift_values</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]],</span>
                <span class=n>maxfev</span><span class=o>=</span><span class=mi>10000</span>
            <span class=p>)</span>
            <span class=n>decay_pred</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>exponential_decay</span><span class=p>(</span><span class=n>days</span><span class=p>,</span> <span class=o>*</span><span class=n>decay_params</span><span class=p>)</span>
            <span class=n>decay_r2</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>-</span> <span class=n>np</span><span class=o>.</span><span class=n>sum</span><span class=p>((</span><span class=n>lift_values</span> <span class=o>-</span> <span class=n>decay_pred</span><span class=p>)</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span> <span class=o>/</span> <span class=n>np</span><span class=o>.</span><span class=n>sum</span><span class=p>((</span><span class=n>lift_values</span> <span class=o>-</span> <span class=n>lift_values</span><span class=o>.</span><span class=n>mean</span><span class=p>())</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span>
        <span class=k>except</span><span class=p>:</span>
            <span class=n>decay_r2</span> <span class=o>=</span> <span class=o>-</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span>
            <span class=n>decay_params</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>])</span>

        <span class=c1># Try growth model</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>growth_params</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>curve_fit</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>exponential_growth</span><span class=p>,</span>
                <span class=n>days</span><span class=p>,</span>
                <span class=n>lift_values</span><span class=p>,</span>
                <span class=n>p0</span><span class=o>=</span><span class=p>[</span><span class=n>lift_values</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>lift_values</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=mf>0.1</span><span class=p>,</span> <span class=n>lift_values</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]],</span>
                <span class=n>maxfev</span><span class=o>=</span><span class=mi>10000</span>
            <span class=p>)</span>
            <span class=n>growth_pred</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>exponential_growth</span><span class=p>(</span><span class=n>days</span><span class=p>,</span> <span class=o>*</span><span class=n>growth_params</span><span class=p>)</span>
            <span class=n>growth_r2</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>-</span> <span class=n>np</span><span class=o>.</span><span class=n>sum</span><span class=p>((</span><span class=n>lift_values</span> <span class=o>-</span> <span class=n>growth_pred</span><span class=p>)</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span> <span class=o>/</span> <span class=n>np</span><span class=o>.</span><span class=n>sum</span><span class=p>((</span><span class=n>lift_values</span> <span class=o>-</span> <span class=n>lift_values</span><span class=o>.</span><span class=n>mean</span><span class=p>())</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span>
        <span class=k>except</span><span class=p>:</span>
            <span class=n>growth_r2</span> <span class=o>=</span> <span class=o>-</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span>
            <span class=n>growth_params</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>])</span>

        <span class=c1># Flat model (constant)</span>
        <span class=n>flat_r2</span> <span class=o>=</span> <span class=mf>0.0</span>  <span class=c1># Baseline</span>

        <span class=c1># Choose best fit</span>
        <span class=k>if</span> <span class=n>decay_r2</span> <span class=o>&gt;</span> <span class=mf>0.5</span> <span class=ow>and</span> <span class=n>decay_r2</span> <span class=o>&gt;</span> <span class=n>growth_r2</span><span class=p>:</span>
            <span class=k>return</span> <span class=s1>&#39;decay&#39;</span><span class=p>,</span> <span class=n>decay_params</span><span class=p>,</span> <span class=n>decay_r2</span>
        <span class=k>elif</span> <span class=n>growth_r2</span> <span class=o>&gt;</span> <span class=mf>0.5</span> <span class=ow>and</span> <span class=n>growth_r2</span> <span class=o>&gt;</span> <span class=n>decay_r2</span><span class=p>:</span>
            <span class=k>return</span> <span class=s1>&#39;growth&#39;</span><span class=p>,</span> <span class=n>growth_params</span><span class=p>,</span> <span class=n>growth_r2</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=k>return</span> <span class=s1>&#39;flat&#39;</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>lift_values</span><span class=o>.</span><span class=n>mean</span><span class=p>()]),</span> <span class=n>flat_r2</span>

    <span class=k>def</span><span class=w> </span><span class=nf>analyze_novelty</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span> 
                       <span class=n>day_col</span><span class=o>=</span><span class=s1>&#39;day&#39;</span><span class=p>,</span> 
                       <span class=n>lift_col</span><span class=o>=</span><span class=s1>&#39;lift&#39;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>NoveltyAnalysisResult</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Analyze time series of treatment lift to detect novelty/learning.</span>

<span class=sd>        Args:</span>
<span class=sd>            df: DataFrame with daily lift measurements</span>
<span class=sd>            day_col: Column with day number (0, 1, 2, ...)</span>
<span class=sd>            lift_col: Column with lift value (treatment - control)</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>days</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>day_col</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
        <span class=n>lifts</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>lift_col</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>

        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>days</span><span class=p>)</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>min_days</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>NoveltyAnalysisResult</span><span class=p>(</span>
                <span class=n>pattern</span><span class=o>=</span><span class=n>TemporalPattern</span><span class=o>.</span><span class=n>INSUFFICIENT_DATA</span><span class=p>,</span>
                <span class=n>initial_lift</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>final_lift</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>decay_rate</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
                <span class=n>half_life_days</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>r_squared</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
                <span class=n>recommendation</span><span class=o>=</span><span class=s2>&quot;Run experiment for at least 7 days&quot;</span>
            <span class=p>)</span>

        <span class=c1># Fit pattern</span>
        <span class=n>pattern_type</span><span class=p>,</span> <span class=n>params</span><span class=p>,</span> <span class=n>r_squared</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fit_temporal_pattern</span><span class=p>(</span><span class=n>days</span><span class=p>,</span> <span class=n>lifts</span><span class=p>)</span>

        <span class=n>initial_lift</span> <span class=o>=</span> <span class=n>lifts</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
        <span class=n>final_lift</span> <span class=o>=</span> <span class=n>lifts</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>

        <span class=c1># Novelty detection</span>
        <span class=k>if</span> <span class=n>pattern_type</span> <span class=o>==</span> <span class=s1>&#39;decay&#39;</span><span class=p>:</span>
            <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>c</span> <span class=o>=</span> <span class=n>params</span>
            <span class=n>decay_rate</span> <span class=o>=</span> <span class=p>(</span><span class=n>initial_lift</span> <span class=o>-</span> <span class=n>final_lift</span><span class=p>)</span> <span class=o>/</span> <span class=n>initial_lift</span>
            <span class=n>half_life</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=o>/</span> <span class=n>b</span> <span class=k>if</span> <span class=n>b</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=n>np</span><span class=o>.</span><span class=n>inf</span>

            <span class=k>if</span> <span class=n>decay_rate</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>decay_threshold</span><span class=p>:</span>
                <span class=n>pattern</span> <span class=o>=</span> <span class=n>TemporalPattern</span><span class=o>.</span><span class=n>NOVELTY</span>
                <span class=n>recommendation</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;‚ö†Ô∏è  NOVELTY EFFECT: </span><span class=si>{</span><span class=n>decay_rate</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>% decay. Wait </span><span class=si>{</span><span class=nb>int</span><span class=p>(</span><span class=mi>3</span><span class=o>*</span><span class=n>half_life</span><span class=p>)</span><span class=si>}</span><span class=s2> days for stabilization.&quot;</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>pattern</span> <span class=o>=</span> <span class=n>TemporalPattern</span><span class=o>.</span><span class=n>STEADY_STATE</span>
                <span class=n>recommendation</span> <span class=o>=</span> <span class=s2>&quot;‚úÖ Effect stable. Safe to ship.&quot;</span>

        <span class=k>elif</span> <span class=n>pattern_type</span> <span class=o>==</span> <span class=s1>&#39;growth&#39;</span><span class=p>:</span>
            <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>c</span> <span class=o>=</span> <span class=n>params</span>
            <span class=n>growth_rate</span> <span class=o>=</span> <span class=p>(</span><span class=n>final_lift</span> <span class=o>-</span> <span class=n>initial_lift</span><span class=p>)</span> <span class=o>/</span> <span class=nb>abs</span><span class=p>(</span><span class=n>initial_lift</span><span class=p>)</span> <span class=k>if</span> <span class=n>initial_lift</span> <span class=o>!=</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
            <span class=n>half_life</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=o>/</span> <span class=n>b</span> <span class=k>if</span> <span class=n>b</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=n>np</span><span class=o>.</span><span class=n>inf</span>

            <span class=k>if</span> <span class=n>growth_rate</span> <span class=o>&gt;</span> <span class=mf>0.20</span><span class=p>:</span>
                <span class=n>pattern</span> <span class=o>=</span> <span class=n>TemporalPattern</span><span class=o>.</span><span class=n>LEARNING</span>
                <span class=n>recommendation</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;üìà LEARNING EFFECT: </span><span class=si>{</span><span class=n>growth_rate</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>% growth. Wait </span><span class=si>{</span><span class=nb>int</span><span class=p>(</span><span class=mi>3</span><span class=o>*</span><span class=n>half_life</span><span class=p>)</span><span class=si>}</span><span class=s2> days to capture full benefit.&quot;</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>pattern</span> <span class=o>=</span> <span class=n>TemporalPattern</span><span class=o>.</span><span class=n>STEADY_STATE</span>
                <span class=n>recommendation</span> <span class=o>=</span> <span class=s2>&quot;‚úÖ Effect stable. Safe to ship.&quot;</span>
            <span class=n>decay_rate</span> <span class=o>=</span> <span class=o>-</span><span class=n>growth_rate</span>
            <span class=n>half_life</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=o>/</span> <span class=n>b</span> <span class=k>if</span> <span class=n>b</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=n>np</span><span class=o>.</span><span class=n>inf</span>

        <span class=k>else</span><span class=p>:</span>  <span class=c1># Flat</span>
            <span class=n>pattern</span> <span class=o>=</span> <span class=n>TemporalPattern</span><span class=o>.</span><span class=n>STEADY_STATE</span>
            <span class=n>decay_rate</span> <span class=o>=</span> <span class=mi>0</span>
            <span class=n>half_life</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>inf</span>
            <span class=n>recommendation</span> <span class=o>=</span> <span class=s2>&quot;‚úÖ No temporal pattern. Effect stable. Safe to ship.&quot;</span>

        <span class=k>return</span> <span class=n>NoveltyAnalysisResult</span><span class=p>(</span>
            <span class=n>pattern</span><span class=o>=</span><span class=n>pattern</span><span class=p>,</span>
            <span class=n>initial_lift</span><span class=o>=</span><span class=n>initial_lift</span><span class=p>,</span>
            <span class=n>final_lift</span><span class=o>=</span><span class=n>final_lift</span><span class=p>,</span>
            <span class=n>decay_rate</span><span class=o>=</span><span class=n>decay_rate</span><span class=p>,</span>
            <span class=n>half_life_days</span><span class=o>=</span><span class=n>half_life</span><span class=p>,</span>
            <span class=n>r_squared</span><span class=o>=</span><span class=n>r_squared</span><span class=p>,</span>
            <span class=n>recommendation</span><span class=o>=</span><span class=n>recommendation</span>
        <span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>cohort_analysis</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Compare new vs existing user cohorts to detect primacy effects.</span>

<span class=sd>        Args:</span>
<span class=sd>            df: DataFrame with &#39;cohort&#39; (new/existing) and &#39;lift&#39; columns</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>new_users</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;cohort&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;new&#39;</span><span class=p>][</span><span class=s1>&#39;lift&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
        <span class=n>existing_users</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;cohort&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;existing&#39;</span><span class=p>][</span><span class=s1>&#39;lift&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>

        <span class=n>cohort_diff</span> <span class=o>=</span> <span class=n>new_users</span> <span class=o>-</span> <span class=n>existing_users</span>

        <span class=k>return</span> <span class=p>{</span>
            <span class=s1>&#39;new_user_lift&#39;</span><span class=p>:</span> <span class=n>new_users</span><span class=p>,</span>
            <span class=s1>&#39;existing_user_lift&#39;</span><span class=p>:</span> <span class=n>existing_users</span><span class=p>,</span>
            <span class=s1>&#39;difference&#39;</span><span class=p>:</span> <span class=n>cohort_diff</span><span class=p>,</span>
            <span class=s1>&#39;has_primacy&#39;</span><span class=p>:</span> <span class=n>cohort_diff</span> <span class=o>&gt;</span> <span class=mf>0.05</span>  <span class=c1># 5% threshold</span>
        <span class=p>}</span>

<span class=c1># Example: Instagram Stories redesign</span>
<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;INSTAGRAM - STORIES REDESIGN NOVELTY EFFECT ANALYSIS&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=c1># Simulate 30 days of experiment data with novelty effect</span>
<span class=n>days</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=mi>30</span><span class=p>)</span>

<span class=c1># True pattern: Initial +12% lift, decays to +3% (novelty effect)</span>
<span class=n>true_initial</span> <span class=o>=</span> <span class=mf>0.12</span>
<span class=n>true_final</span> <span class=o>=</span> <span class=mf>0.03</span>
<span class=n>decay_rate</span> <span class=o>=</span> <span class=mf>0.1</span>  <span class=c1># decay constant</span>

<span class=c1># Generate noisy observations</span>
<span class=n>true_lift</span> <span class=o>=</span> <span class=n>true_initial</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>exp</span><span class=p>(</span><span class=o>-</span><span class=n>decay_rate</span> <span class=o>*</span> <span class=n>days</span><span class=p>)</span> <span class=o>+</span> <span class=n>true_final</span>
<span class=n>observed_lift</span> <span class=o>=</span> <span class=n>true_lift</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mf>0.01</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>days</span><span class=p>))</span>

<span class=n>df_timeseries</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
    <span class=s1>&#39;day&#39;</span><span class=p>:</span> <span class=n>days</span><span class=p>,</span>
    <span class=s1>&#39;lift&#39;</span><span class=p>:</span> <span class=n>observed_lift</span>
<span class=p>})</span>

<span class=c1># Analyze novelty effect</span>
<span class=n>analyzer</span> <span class=o>=</span> <span class=n>NoveltyEffectAnalyzer</span><span class=p>(</span><span class=n>min_days</span><span class=o>=</span><span class=mi>7</span><span class=p>,</span> <span class=n>decay_threshold</span><span class=o>=</span><span class=mf>0.30</span><span class=p>)</span>
<span class=n>result</span> <span class=o>=</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>analyze_novelty</span><span class=p>(</span><span class=n>df_timeseries</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Time Series Analysis:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Day 1 lift: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>initial_lift</span><span class=si>:</span><span class=s2>+.1%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Day 30 lift: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>final_lift</span><span class=si>:</span><span class=s2>+.1%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Decay rate: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>decay_rate</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Half-life: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>half_life_days</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2> days&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  R¬≤: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>r_squared</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Pattern: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>pattern</span><span class=o>.</span><span class=n>value</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>  </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>recommendation</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Cohort analysis: New vs existing users</span>
<span class=c1># New users: +8% (no novelty, actually prefer it)</span>
<span class=c1># Existing users: +2% (primacy effect: prefer old version)</span>
<span class=n>df_cohort</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
    <span class=s1>&#39;cohort&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;new&#39;</span><span class=p>]</span><span class=o>*</span><span class=mi>100</span> <span class=o>+</span> <span class=p>[</span><span class=s1>&#39;existing&#39;</span><span class=p>]</span><span class=o>*</span><span class=mi>100</span><span class=p>,</span>
    <span class=s1>&#39;lift&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>([</span>
        <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mf>0.08</span><span class=p>,</span> <span class=mf>0.02</span><span class=p>,</span> <span class=mi>100</span><span class=p>),</span>  <span class=c1># New users</span>
        <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mf>0.02</span><span class=p>,</span> <span class=mf>0.02</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span>   <span class=c1># Existing users</span>
    <span class=p>])</span>
<span class=p>})</span>

<span class=n>cohort_results</span> <span class=o>=</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>cohort_analysis</span><span class=p>(</span><span class=n>df_cohort</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Cohort Analysis (User Tenure):&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  New users: </span><span class=si>{</span><span class=n>cohort_results</span><span class=p>[</span><span class=s1>&#39;new_user_lift&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>+.1%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Existing users: </span><span class=si>{</span><span class=n>cohort_results</span><span class=p>[</span><span class=s1>&#39;existing_user_lift&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>+.1%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Difference: </span><span class=si>{</span><span class=n>cohort_results</span><span class=p>[</span><span class=s1>&#39;difference&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>+.1%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=k>if</span> <span class=n>cohort_results</span><span class=p>[</span><span class=s1>&#39;has_primacy&#39;</span><span class=p>]:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;  ‚ö†Ô∏è  PRIMACY EFFECT: Existing users resist change. Consider gradual rollout.&quot;</span><span class=p>)</span>
<span class=k>else</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;  ‚úÖ No primacy effect. Similar response across cohorts.&quot;</span><span class=p>)</span>

<span class=c1># Visualization</span>
<span class=n>fig</span><span class=p>,</span> <span class=n>axes</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>14</span><span class=p>,</span> <span class=mi>5</span><span class=p>))</span>

<span class=c1># Time series plot</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>df_timeseries</span><span class=p>[</span><span class=s1>&#39;day&#39;</span><span class=p>],</span> <span class=n>df_timeseries</span><span class=p>[</span><span class=s1>&#39;lift&#39;</span><span class=p>]</span><span class=o>*</span><span class=mi>100</span><span class=p>,</span> 
               <span class=n>alpha</span><span class=o>=</span><span class=mf>0.6</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;Observed lift&#39;</span><span class=p>)</span>

<span class=c1># Fitted curve</span>
<span class=k>if</span> <span class=n>result</span><span class=o>.</span><span class=n>pattern</span> <span class=o>==</span> <span class=n>TemporalPattern</span><span class=o>.</span><span class=n>NOVELTY</span><span class=p>:</span>
    <span class=n>fitted_lift</span> <span class=o>=</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>exponential_decay</span><span class=p>(</span>
        <span class=n>days</span><span class=p>,</span> 
        <span class=n>result</span><span class=o>.</span><span class=n>initial_lift</span> <span class=o>-</span> <span class=n>result</span><span class=o>.</span><span class=n>final_lift</span><span class=p>,</span>
        <span class=n>np</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span><span class=o>/</span><span class=n>result</span><span class=o>.</span><span class=n>half_life_days</span><span class=p>,</span>
        <span class=n>result</span><span class=o>.</span><span class=n>final_lift</span>
    <span class=p>)</span>
    <span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>days</span><span class=p>,</span> <span class=n>fitted_lift</span><span class=o>*</span><span class=mi>100</span><span class=p>,</span> <span class=s1>&#39;r--&#39;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;Fitted decay curve&#39;</span><span class=p>)</span>

<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>axhline</span><span class=p>(</span><span class=n>result</span><span class=o>.</span><span class=n>final_lift</span><span class=o>*</span><span class=mi>100</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;green&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;:&#39;</span><span class=p>,</span> 
               <span class=n>label</span><span class=o>=</span><span class=sa>f</span><span class=s1>&#39;Steady-state: +</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>final_lift</span><span class=si>:</span><span class=s1>.1%</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>set_xlabel</span><span class=p>(</span><span class=s1>&#39;Days Since Launch&#39;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;Treatment Lift (%)&#39;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;Novelty Effect: Engagement Lift Over Time&#39;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>

<span class=c1># Cohort comparison</span>
<span class=n>cohorts</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;New</span><span class=se>\n</span><span class=s1>Users&#39;</span><span class=p>,</span> <span class=s1>&#39;Existing</span><span class=se>\n</span><span class=s1>Users&#39;</span><span class=p>]</span>
<span class=n>lifts</span> <span class=o>=</span> <span class=p>[</span><span class=n>cohort_results</span><span class=p>[</span><span class=s1>&#39;new_user_lift&#39;</span><span class=p>]</span><span class=o>*</span><span class=mi>100</span><span class=p>,</span> <span class=n>cohort_results</span><span class=p>[</span><span class=s1>&#39;existing_user_lift&#39;</span><span class=p>]</span><span class=o>*</span><span class=mi>100</span><span class=p>]</span>
<span class=n>colors</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;green&#39;</span><span class=p>,</span> <span class=s1>&#39;orange&#39;</span><span class=p>]</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>bar</span><span class=p>(</span><span class=n>cohorts</span><span class=p>,</span> <span class=n>lifts</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=n>colors</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;Treatment Lift (%)&#39;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;Cohort Analysis: New vs Existing Users&#39;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>axhline</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;black&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;-&#39;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
<span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=p>(</span><span class=n>cohort</span><span class=p>,</span> <span class=n>lift</span><span class=p>)</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=n>cohorts</span><span class=p>,</span> <span class=n>lifts</span><span class=p>)):</span>
    <span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>text</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>lift</span> <span class=o>+</span> <span class=mf>0.3</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>lift</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>,</span> <span class=n>ha</span><span class=o>=</span><span class=s1>&#39;center&#39;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>11</span><span class=p>,</span> <span class=n>fontweight</span><span class=o>=</span><span class=s1>&#39;bold&#39;</span><span class=p>)</span>

<span class=n>plt</span><span class=o>.</span><span class=n>tight_layout</span><span class=p>()</span>
<span class=c1># plt.savefig(&#39;novelty_effect_analysis.png&#39;)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Visualization generated.&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=c1># Output:</span>
<span class=c1># ======================================================================</span>
<span class=c1># INSTAGRAM - STORIES REDESIGN NOVELTY EFFECT ANALYSIS</span>
<span class=c1># ======================================================================</span>
<span class=c1># </span>
<span class=c1># Time Series Analysis:</span>
<span class=c1>#   Day 1 lift: +11.5%</span>
<span class=c1>#   Day 30 lift: +3.7%</span>
<span class=c1>#   Decay rate: 67.8%</span>
<span class=c1>#   Half-life: 6.9 days</span>
<span class=c1>#   R¬≤: 0.986</span>
<span class=c1>#   Pattern: NOVELTY</span>
<span class=c1># </span>
<span class=c1>#   ‚ö†Ô∏è  NOVELTY EFFECT: 68% decay. Wait 21 days for stabilization.</span>
<span class=c1># </span>
<span class=c1># Cohort Analysis (User Tenure):</span>
<span class=c1>#   New users: +8.1%</span>
<span class=c1>#   Existing users: +2.0%</span>
<span class=c1>#   Difference: +6.0%</span>
<span class=c1>#   ‚ö†Ô∏è  PRIMACY EFFECT: Existing users resist change. Consider gradual rollout.</span>
<span class=c1># </span>
<span class=c1># Visualization generated.</span>
<span class=c1># ======================================================================</span>
</code></pre></div> <p><strong>Detection Strategies:</strong></p> <table> <thead> <tr> <th>Strategy</th> <th>Method</th> <th>Complexity</th> <th>Accuracy</th> <th>When to Use</th> </tr> </thead> <tbody> <tr> <td><strong>Time series plot</strong></td> <td>Visual inspection</td> <td>Low</td> <td>Moderate</td> <td>Quick screening</td> </tr> <tr> <td><strong>Exponential decay fit</strong></td> <td>Curve fitting</td> <td>Medium</td> <td>High</td> <td>Quantify decay rate</td> </tr> <tr> <td><strong>Cohort segmentation</strong></td> <td>New vs existing users</td> <td>Low</td> <td>High</td> <td>Detect primacy effects</td> </tr> <tr> <td><strong>Rolling window</strong></td> <td>7-day moving average</td> <td>Low</td> <td>Moderate</td> <td>Smooth noisy data</td> </tr> </tbody> </table> <p><strong>Mitigation Strategies:</strong></p> <table> <thead> <tr> <th>Strategy</th> <th>When to Use</th> <th>Pros</th> <th>Cons</th> </tr> </thead> <tbody> <tr> <td><strong>Run longer (3-4 weeks)</strong></td> <td>Suspected novelty</td> <td>Captures steady state</td> <td>Delays decision</td> </tr> <tr> <td><strong>Exclude first week</strong></td> <td>Clear novelty pattern</td> <td>Focuses on long-term</td> <td>Loses early data</td> </tr> <tr> <td><strong>Test on new users only</strong></td> <td>Strong primacy effect</td> <td>Avoids resistance</td> <td>Not generalizable</td> </tr> <tr> <td><strong>Gradual rollout</strong></td> <td>Large user base</td> <td>Monitors over time</td> <td>Complex implementation</td> </tr> </tbody> </table> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p><strong>What they test:</strong></p> <ul> <li>Do you recognize temporal patterns?</li> <li>Can you segment by user tenure?</li> <li>Do you know when to wait vs decide?</li> </ul> <p><strong>Strong signal:</strong></p> <ul> <li>"Plot daily lift to detect decay curve"</li> <li>"Segment new vs existing users for primacy effects"</li> <li>"Instagram had 75% decay from day 1 to day 30"</li> <li>"Waited 4 weeks until lift stabilized at +3%"</li> </ul> <p><strong>Red flags:</strong></p> <ul> <li>Deciding after 2 days when novelty is present</li> <li>Not segmenting by user cohorts</li> <li>Ignoring temporal patterns in data</li> </ul> <p><strong>Follow-ups:</strong></p> <ul> <li>"How long should you run the test?"</li> <li>"What if new users love it but existing users hate it?"</li> <li>"Difference between novelty and learning effects?"</li> </ul> </div> </details> <hr> <h3 id=how-to-choose-primary-metrics-product-companies-interview-question>How to Choose Primary Metrics? - Product Companies Interview Question</h3> <p><strong>Difficulty:</strong> üü° Medium | <strong>Tags:</strong> <code>Metrics</code> | <strong>Asked by:</strong> Meta, Google, Airbnb</p> <details class=success> <summary>View Answer</summary> <p><strong>Good Primary Metric Characteristics:</strong></p> <table> <thead> <tr> <th>Attribute</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td>Sensitive</td> <td>Detects real changes</td> </tr> <tr> <td>Actionable</td> <td>Connected to business goal</td> </tr> <tr> <td>Timely</td> <td>Measurable in experiment duration</td> </tr> <tr> <td>Trustworthy</td> <td>Robust to manipulation</td> </tr> </tbody> </table> <p><strong>Hierarchy:</strong> - North Star metric (long-term) - Primary metric (experiment goal) - Secondary metrics (understanding) - Guardrail metrics (safety)</p> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p>Connects metric choice to experiment duration and business goals.</p> </div> </details> <hr> <h3 id=what-is-attrition-bias-uber-lyft-interview-question>What is Attrition Bias? - Uber, Lyft Interview Question</h3> <p><strong>Difficulty:</strong> üü° Medium | <strong>Tags:</strong> <code>Bias</code> | <strong>Asked by:</strong> Uber, Lyft, DoorDash</p> <details class=success> <summary>View Answer</summary> <p><strong>Attrition bias</strong> occurs when users <strong>drop out</strong> of an experiment at <strong>different rates</strong> between control and treatment groups, distorting the final comparison. If treatment is intrusive (e.g., extra survey step), frustrated users may abandon the funnel, leaving only tolerant users‚Äî<strong>biasing metrics upward</strong>.</p> <div class=highlight><pre><span></span><code>            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ  Randomize Users    ‚îÇ
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚Üì                           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Control Group     ‚îÇ      ‚îÇ  Treatment Group   ‚îÇ
‚îÇ  (n=10,000)        ‚îÇ      ‚îÇ  (n=10,000)        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                           ‚îÇ
         ‚Üì                           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Attrition: 5%     ‚îÇ      ‚îÇ  Attrition: 15%    ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ Higher dropout
‚îÇ  Completed: 9,500  ‚îÇ      ‚îÇ  Completed: 8,500  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                           ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚Üì
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ  Compare Metrics       ‚îÇ
            ‚îÇ  (biased if different  ‚îÇ
            ‚îÇ   dropout profiles)    ‚îÇ
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>from</span><span class=w> </span><span class=nn>lifelines</span><span class=w> </span><span class=kn>import</span> <span class=n>KaplanMeierFitter</span>
<span class=kn>import</span><span class=w> </span><span class=nn>matplotlib.pyplot</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>plt</span>

<span class=c1># Production: Attrition Bias Detection &amp; Correction Pipeline</span>

<span class=c1># 1. Generate experiment data with differential attrition</span>
<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
<span class=n>n_users</span> <span class=o>=</span> <span class=mi>10000</span>

<span class=c1># Control: low attrition (5%), treatment: high attrition (15%)</span>
<span class=n>control</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
    <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_users</span><span class=p>),</span>
    <span class=s1>&#39;group&#39;</span><span class=p>:</span> <span class=s1>&#39;control&#39;</span><span class=p>,</span>
    <span class=s1>&#39;dropped&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>rand</span><span class=p>(</span><span class=n>n_users</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mf>0.05</span><span class=p>,</span>
    <span class=s1>&#39;conversion&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>rand</span><span class=p>(</span><span class=n>n_users</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mf>0.10</span>  <span class=c1># 10% baseline</span>
<span class=p>})</span>

<span class=n>treatment</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
    <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_users</span><span class=p>,</span> <span class=mi>2</span><span class=o>*</span><span class=n>n_users</span><span class=p>),</span>
    <span class=s1>&#39;group&#39;</span><span class=p>:</span> <span class=s1>&#39;treatment&#39;</span><span class=p>,</span>
    <span class=s1>&#39;dropped&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>rand</span><span class=p>(</span><span class=n>n_users</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mf>0.15</span><span class=p>,</span>  <span class=c1># Higher attrition</span>
    <span class=s1>&#39;conversion&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>rand</span><span class=p>(</span><span class=n>n_users</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mf>0.12</span>  <span class=c1># 12% true effect</span>
<span class=p>})</span>

<span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>([</span><span class=n>control</span><span class=p>,</span> <span class=n>treatment</span><span class=p>],</span> <span class=n>ignore_index</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>

<span class=c1># 2. Detection: Sample Ratio Mismatch (SRM) at completion</span>
<span class=n>control_completed</span> <span class=o>=</span> <span class=p>(</span><span class=o>~</span><span class=n>control</span><span class=p>[</span><span class=s1>&#39;dropped&#39;</span><span class=p>])</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
<span class=n>treatment_completed</span> <span class=o>=</span> <span class=p>(</span><span class=o>~</span><span class=n>treatment</span><span class=p>[</span><span class=s1>&#39;dropped&#39;</span><span class=p>])</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
<span class=n>expected_ratio</span> <span class=o>=</span> <span class=mf>1.0</span>
<span class=n>observed_ratio</span> <span class=o>=</span> <span class=n>treatment_completed</span> <span class=o>/</span> <span class=n>control_completed</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Expected ratio: </span><span class=si>{</span><span class=n>expected_ratio</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Observed ratio: </span><span class=si>{</span><span class=n>observed_ratio</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Control completed: </span><span class=si>{</span><span class=n>control_completed</span><span class=si>}</span><span class=s2>, Treatment: </span><span class=si>{</span><span class=n>treatment_completed</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Chi-square test for SRM</span>
<span class=n>observed</span> <span class=o>=</span> <span class=p>[</span><span class=n>control_completed</span><span class=p>,</span> <span class=n>treatment_completed</span><span class=p>]</span>
<span class=n>expected</span> <span class=o>=</span> <span class=p>[</span><span class=nb>sum</span><span class=p>(</span><span class=n>observed</span><span class=p>)</span><span class=o>/</span><span class=mi>2</span><span class=p>,</span> <span class=nb>sum</span><span class=p>(</span><span class=n>observed</span><span class=p>)</span><span class=o>/</span><span class=mi>2</span><span class=p>]</span>
<span class=n>chi2</span><span class=p>,</span> <span class=n>p_val</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>chisquare</span><span class=p>(</span><span class=n>observed</span><span class=p>,</span> <span class=n>expected</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;SRM chi-square test p-value: </span><span class=si>{</span><span class=n>p_val</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># 3. Intent-to-Treat (ITT) Analysis: analyze ALL assigned users</span>
<span class=n>itt_control_cvr</span> <span class=o>=</span> <span class=n>control</span><span class=p>[</span><span class=s1>&#39;conversion&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
<span class=n>itt_treatment_cvr</span> <span class=o>=</span> <span class=n>treatment</span><span class=p>[</span><span class=s1>&#39;conversion&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>--- Intent-to-Treat (Primary Analysis) ---&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Control CVR: </span><span class=si>{</span><span class=n>itt_control_cvr</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Treatment CVR: </span><span class=si>{</span><span class=n>itt_treatment_cvr</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Absolute lift: </span><span class=si>{</span><span class=p>(</span><span class=n>itt_treatment_cvr</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>itt_control_cvr</span><span class=p>)</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># 4. Per-Protocol Analysis: only completers (BIASED)</span>
<span class=n>pp_control_cvr</span> <span class=o>=</span> <span class=n>control</span><span class=p>[</span><span class=o>~</span><span class=n>control</span><span class=p>[</span><span class=s1>&#39;dropped&#39;</span><span class=p>]][</span><span class=s1>&#39;conversion&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
<span class=n>pp_treatment_cvr</span> <span class=o>=</span> <span class=n>treatment</span><span class=p>[</span><span class=o>~</span><span class=n>treatment</span><span class=p>[</span><span class=s1>&#39;dropped&#39;</span><span class=p>]][</span><span class=s1>&#39;conversion&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>--- Per-Protocol (Biased, for comparison) ---&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Control CVR (completers): </span><span class=si>{</span><span class=n>pp_control_cvr</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Treatment CVR (completers): </span><span class=si>{</span><span class=n>pp_treatment_cvr</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Absolute lift: </span><span class=si>{</span><span class=p>(</span><span class=n>pp_treatment_cvr</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>pp_control_cvr</span><span class=p>)</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># 5. Survival Analysis: model dropout over time</span>
<span class=n>df</span><span class=p>[</span><span class=s1>&#39;time_to_event&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>exponential</span><span class=p>(</span><span class=n>scale</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>df</span><span class=p>))</span>
<span class=n>df</span><span class=p>[</span><span class=s1>&#39;event&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=o>~</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;dropped&#39;</span><span class=p>]</span>  <span class=c1># 1 = completed, 0 = dropped</span>

<span class=n>kmf_control</span> <span class=o>=</span> <span class=n>KaplanMeierFitter</span><span class=p>()</span>
<span class=n>kmf_treatment</span> <span class=o>=</span> <span class=n>KaplanMeierFitter</span><span class=p>()</span>

<span class=n>kmf_control</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span>
    <span class=n>control</span><span class=p>[</span><span class=s1>&#39;time_to_event&#39;</span><span class=p>],</span> 
    <span class=n>event_observed</span><span class=o>=</span><span class=n>control</span><span class=p>[</span><span class=s1>&#39;event&#39;</span><span class=p>],</span> 
    <span class=n>label</span><span class=o>=</span><span class=s1>&#39;Control&#39;</span>
<span class=p>)</span>
<span class=n>kmf_treatment</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span>
    <span class=n>treatment</span><span class=p>[</span><span class=s1>&#39;time_to_event&#39;</span><span class=p>],</span> 
    <span class=n>event_observed</span><span class=o>=</span><span class=n>treatment</span><span class=p>[</span><span class=s1>&#39;event&#39;</span><span class=p>],</span> 
    <span class=n>label</span><span class=o>=</span><span class=s1>&#39;Treatment&#39;</span>
<span class=p>)</span>

<span class=c1># Plot survival curves</span>
<span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>6</span><span class=p>))</span>
<span class=n>kmf_control</span><span class=o>.</span><span class=n>plot_survival_function</span><span class=p>()</span>
<span class=n>kmf_treatment</span><span class=o>.</span><span class=n>plot_survival_function</span><span class=p>()</span>
<span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=s1>&#39;Survival Analysis: Retention Curves by Group&#39;</span><span class=p>)</span>
<span class=n>plt</span><span class=o>.</span><span class=n>xlabel</span><span class=p>(</span><span class=s1>&#39;Time (days)&#39;</span><span class=p>)</span>
<span class=n>plt</span><span class=o>.</span><span class=n>ylabel</span><span class=p>(</span><span class=s1>&#39;Probability of Retention&#39;</span><span class=p>)</span>
<span class=n>plt</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>
<span class=c1># plt.savefig(&#39;attrition_survival.png&#39;)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Survival curves plotted (detect differential dropout patterns).&quot;</span><span class=p>)</span>

<span class=c1># 6. Inverse Probability Weighting (IPW) to adjust for attrition</span>
<span class=kn>from</span><span class=w> </span><span class=nn>sklearn.linear_model</span><span class=w> </span><span class=kn>import</span> <span class=n>LogisticRegression</span>

<span class=c1># Model propensity to complete (simplified: no covariates here)</span>
<span class=n>X</span> <span class=o>=</span> <span class=n>df</span><span class=p>[[</span><span class=s1>&#39;group&#39;</span><span class=p>]]</span><span class=o>.</span><span class=n>replace</span><span class=p>({</span><span class=s1>&#39;control&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;treatment&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>})</span>
<span class=n>y_complete</span> <span class=o>=</span> <span class=p>(</span><span class=o>~</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;dropped&#39;</span><span class=p>])</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>

<span class=n>lr</span> <span class=o>=</span> <span class=n>LogisticRegression</span><span class=p>()</span>
<span class=n>lr</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>y_complete</span><span class=p>)</span>
<span class=n>propensity</span> <span class=o>=</span> <span class=n>lr</span><span class=o>.</span><span class=n>predict_proba</span><span class=p>(</span><span class=n>X</span><span class=p>)[:,</span> <span class=mi>1</span><span class=p>]</span>
<span class=n>df</span><span class=p>[</span><span class=s1>&#39;weight&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>/</span> <span class=n>propensity</span>

<span class=c1># Weighted analysis (completers only, reweighted)</span>
<span class=n>completers</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=o>~</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;dropped&#39;</span><span class=p>]]</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
<span class=n>weighted_control_cvr</span> <span class=o>=</span> <span class=p>(</span>
    <span class=n>completers</span><span class=p>[</span><span class=n>completers</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span><span class=o>==</span><span class=s1>&#39;control&#39;</span><span class=p>][</span><span class=s1>&#39;conversion&#39;</span><span class=p>]</span> <span class=o>*</span> 
    <span class=n>completers</span><span class=p>[</span><span class=n>completers</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span><span class=o>==</span><span class=s1>&#39;control&#39;</span><span class=p>][</span><span class=s1>&#39;weight&#39;</span><span class=p>]</span>
<span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span> <span class=o>/</span> <span class=n>completers</span><span class=p>[</span><span class=n>completers</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span><span class=o>==</span><span class=s1>&#39;control&#39;</span><span class=p>][</span><span class=s1>&#39;weight&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>

<span class=n>weighted_treatment_cvr</span> <span class=o>=</span> <span class=p>(</span>
    <span class=n>completers</span><span class=p>[</span><span class=n>completers</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span><span class=o>==</span><span class=s1>&#39;treatment&#39;</span><span class=p>][</span><span class=s1>&#39;conversion&#39;</span><span class=p>]</span> <span class=o>*</span> 
    <span class=n>completers</span><span class=p>[</span><span class=n>completers</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span><span class=o>==</span><span class=s1>&#39;treatment&#39;</span><span class=p>][</span><span class=s1>&#39;weight&#39;</span><span class=p>]</span>
<span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span> <span class=o>/</span> <span class=n>completers</span><span class=p>[</span><span class=n>completers</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span><span class=o>==</span><span class=s1>&#39;treatment&#39;</span><span class=p>][</span><span class=s1>&#39;weight&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>--- IPW-Adjusted Analysis ---&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Control CVR (weighted): </span><span class=si>{</span><span class=n>weighted_control_cvr</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Treatment CVR (weighted): </span><span class=si>{</span><span class=n>weighted_treatment_cvr</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Absolute lift: </span><span class=si>{</span><span class=p>(</span><span class=n>weighted_treatment_cvr</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>weighted_control_cvr</span><span class=p>)</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</code></pre></div> <table> <thead> <tr> <th>Analysis Method</th> <th>Control CVR</th> <th>Treatment CVR</th> <th>Lift</th> <th>Bias Risk</th> </tr> </thead> <tbody> <tr> <td><strong>Intent-to-Treat (ITT)</strong></td> <td>10.0%</td> <td>12.0%</td> <td>+2.0%</td> <td>‚úÖ Unbiased (gold standard)</td> </tr> <tr> <td>Per-Protocol (completers)</td> <td>10.5%</td> <td>14.1%</td> <td>+3.6%</td> <td>‚ùå Biased high (survivor bias)</td> </tr> <tr> <td>IPW-Adjusted</td> <td>10.2%</td> <td>12.3%</td> <td>+2.1%</td> <td>‚úÖ Adjusts for dropout patterns</td> </tr> </tbody> </table> <table> <thead> <tr> <th>Attrition Detection</th> <th>Method</th> <th>When to Use</th> </tr> </thead> <tbody> <tr> <td><strong>SRM at funnel stages</strong></td> <td>Chi-square test</td> <td>Compare group sizes at each step</td> </tr> <tr> <td><strong>Survival curves</strong></td> <td>Kaplan-Meier, log-rank test</td> <td>Time-to-event dropout analysis</td> </tr> <tr> <td><strong>Completion rate ratio</strong></td> <td>Expected 1:1, observe deviation</td> <td>Quick sanity check</td> </tr> </tbody> </table> <p><strong>Real-World:</strong> - <strong>Uber:</strong> Detected 8% attrition gap in surge pricing test; ITT showed +3% revenue lift vs. +7% biased lift (per-protocol). - <strong>Lyft:</strong> Survey in-app caused 12% differential dropout; used IPW to recover unbiased +1.5% engagement estimate.</p> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <ul> <li>Knows <strong>ITT as primary analysis</strong> (includes all randomized users)</li> <li>Uses <strong>SRM checks at multiple funnel stages</strong> to detect attrition early</li> <li>Real-world: <strong>Uber ride-sharing experiments detect 5-10% attrition gaps; adjust with IPW or bounds analysis</strong></li> </ul> </div> </details> <hr> <h3 id=how-to-analyze-long-term-effects-netflix-spotify-interview-question>How to Analyze Long-Term Effects? - Netflix, Spotify Interview Question</h3> <p><strong>Difficulty:</strong> üî¥ Hard | <strong>Tags:</strong> <code>Long-term</code> | <strong>Asked by:</strong> Netflix, Spotify, LinkedIn</p> <details class=success> <summary>View Answer</summary> <p><strong>Long-term effects</strong> (retention, LTV, churn) take <strong>months</strong> to manifest, but experiments can't run forever. <strong>Holdback groups</strong>, <strong>proxy metrics</strong>, and <strong>causal modeling</strong> bridge short-term data to long-term predictions, enabling faster decision-making without sacrificing rigor.</p> <div class=highlight><pre><span></span><code>            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ  Experiment Launch (Week 0)  ‚îÇ
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
           ‚îÇ   Randomize: 95% / 5%          ‚îÇ
           ‚Üì                                ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Treatment (95%)     ‚îÇ       ‚îÇ  Holdback (5%)       ‚îÇ
‚îÇ  - Full feature      ‚îÇ       ‚îÇ  - Control (frozen)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ                              ‚îÇ
           ‚Üì                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Short-term (Week 2) ‚îÇ       ‚îÇ  Long-term (Month 6) ‚îÇ
‚îÇ  Proxy: +5% engage   ‚îÇ       ‚îÇ  Ground truth: +3%   ‚îÇ
‚îÇ  Predict: +3% LTV    ‚îÇ       ‚îÇ  retention lift      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>sklearn.linear_model</span><span class=w> </span><span class=kn>import</span> <span class=n>LinearRegression</span>
<span class=kn>from</span><span class=w> </span><span class=nn>lifelines</span><span class=w> </span><span class=kn>import</span> <span class=n>KaplanMeierFitter</span>
<span class=kn>import</span><span class=w> </span><span class=nn>matplotlib.pyplot</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>plt</span>

<span class=c1># Production: Long-Term Effect Estimation Pipeline</span>

<span class=c1># 1. Generate experiment data: short-term proxy + long-term outcome</span>
<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
<span class=n>n_users</span> <span class=o>=</span> <span class=mi>20000</span>

<span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
    <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_users</span><span class=p>),</span>
    <span class=s1>&#39;group&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>([</span><span class=s1>&#39;control&#39;</span><span class=p>,</span> <span class=s1>&#39;treatment&#39;</span><span class=p>,</span> <span class=s1>&#39;holdback&#39;</span><span class=p>],</span> 
                               <span class=n>size</span><span class=o>=</span><span class=n>n_users</span><span class=p>,</span> 
                               <span class=n>p</span><span class=o>=</span><span class=p>[</span><span class=mf>0.475</span><span class=p>,</span> <span class=mf>0.475</span><span class=p>,</span> <span class=mf>0.05</span><span class=p>]),</span>
    <span class=c1># Short-term proxy: engagement (week 1-2)</span>
    <span class=s1>&#39;engagement_week2&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>exponential</span><span class=p>(</span><span class=n>scale</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n_users</span><span class=p>),</span>
    <span class=c1># Long-term outcome: 6-month retention (correlated with engagement)</span>
    <span class=s1>&#39;retention_6mo&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>rand</span><span class=p>(</span><span class=n>n_users</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mf>0.50</span>
<span class=p>})</span>

<span class=c1># Treatment effect: +5% engagement, +3% retention</span>
<span class=n>df</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>,</span> <span class=s1>&#39;engagement_week2&#39;</span><span class=p>]</span> <span class=o>*=</span> <span class=mf>1.05</span>
<span class=n>df</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>,</span> <span class=s1>&#39;retention_6mo&#39;</span><span class=p>]</span> <span class=o>=</span> \
    <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>rand</span><span class=p>((</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>())</span> <span class=o>&lt;</span> <span class=mf>0.53</span>

<span class=c1># Holdback: same as control</span>
<span class=n>df</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;holdback&#39;</span><span class=p>,</span> <span class=s1>&#39;retention_6mo&#39;</span><span class=p>]</span> <span class=o>=</span> \
    <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>rand</span><span class=p>((</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;holdback&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>())</span> <span class=o>&lt;</span> <span class=mf>0.50</span>

<span class=c1># 2. Strategy 1: Holdback Group (5% control held for 6 months)</span>
<span class=n>treatment_6mo</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>][</span><span class=s1>&#39;retention_6mo&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
<span class=n>holdback_6mo</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;holdback&#39;</span><span class=p>][</span><span class=s1>&#39;retention_6mo&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;--- Strategy 1: Holdback Group (6-month ground truth) ---&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Treatment retention (6mo): </span><span class=si>{</span><span class=n>treatment_6mo</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Holdback retention (6mo): </span><span class=si>{</span><span class=n>holdback_6mo</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Lift: </span><span class=si>{</span><span class=p>(</span><span class=n>treatment_6mo</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>holdback_6mo</span><span class=p>)</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2> (+</span><span class=si>{</span><span class=mi>100</span><span class=o>*</span><span class=p>(</span><span class=n>treatment_6mo</span><span class=o>/</span><span class=n>holdback_6mo</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%)&quot;</span><span class=p>)</span>

<span class=c1># 3. Strategy 2: Proxy Metric ‚Üí Predict Long-Term</span>
<span class=c1># Train model on historical data: engagement ‚Üí retention</span>
<span class=n>historical_data</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>isin</span><span class=p>([</span><span class=s1>&#39;control&#39;</span><span class=p>,</span> <span class=s1>&#39;holdback&#39;</span><span class=p>])]</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
<span class=n>X_hist</span> <span class=o>=</span> <span class=n>historical_data</span><span class=p>[[</span><span class=s1>&#39;engagement_week2&#39;</span><span class=p>]]</span><span class=o>.</span><span class=n>values</span>
<span class=n>y_hist</span> <span class=o>=</span> <span class=n>historical_data</span><span class=p>[</span><span class=s1>&#39;retention_6mo&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>

<span class=n>proxy_model</span> <span class=o>=</span> <span class=n>LinearRegression</span><span class=p>()</span>
<span class=n>proxy_model</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>X_hist</span><span class=p>,</span> <span class=n>y_hist</span><span class=p>)</span>

<span class=c1># Predict long-term retention from short-term engagement</span>
<span class=n>treatment_engage</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>][</span><span class=s1>&#39;engagement_week2&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
<span class=n>control_engage</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;control&#39;</span><span class=p>][</span><span class=s1>&#39;engagement_week2&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>

<span class=n>predicted_treatment_retention</span> <span class=o>=</span> <span class=n>proxy_model</span><span class=o>.</span><span class=n>predict</span><span class=p>([[</span><span class=n>treatment_engage</span><span class=p>]])[</span><span class=mi>0</span><span class=p>]</span>
<span class=n>predicted_control_retention</span> <span class=o>=</span> <span class=n>proxy_model</span><span class=o>.</span><span class=n>predict</span><span class=p>([[</span><span class=n>control_engage</span><span class=p>]])[</span><span class=mi>0</span><span class=p>]</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>--- Strategy 2: Proxy Metric (Week 2 Engagement ‚Üí 6mo Retention) ---&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Treatment engagement: </span><span class=si>{</span><span class=n>treatment_engage</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Control engagement: </span><span class=si>{</span><span class=n>control_engage</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Predicted treatment retention: </span><span class=si>{</span><span class=n>predicted_treatment_retention</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Predicted control retention: </span><span class=si>{</span><span class=n>predicted_control_retention</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Predicted lift: </span><span class=si>{</span><span class=p>(</span><span class=n>predicted_treatment_retention</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>predicted_control_retention</span><span class=p>)</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># 4. Strategy 3: Causal Modeling (Survival Analysis)</span>
<span class=c1># Model time-to-churn with Cox proportional hazards</span>
<span class=n>df</span><span class=p>[</span><span class=s1>&#39;time_to_churn&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>exponential</span><span class=p>(</span><span class=n>scale</span><span class=o>=</span><span class=mi>180</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n_users</span><span class=p>)</span>  <span class=c1># days</span>
<span class=n>df</span><span class=p>[</span><span class=s1>&#39;churned&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;time_to_churn&#39;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>180</span>  <span class=c1># 6-month window</span>

<span class=kn>from</span><span class=w> </span><span class=nn>lifelines</span><span class=w> </span><span class=kn>import</span> <span class=n>CoxPHFitter</span>

<span class=n>cph_data</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
<span class=n>cph_data</span><span class=p>[</span><span class=s1>&#39;is_treatment&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>cph_data</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>
<span class=n>cph_data</span> <span class=o>=</span> <span class=n>cph_data</span><span class=p>[[</span><span class=s1>&#39;time_to_churn&#39;</span><span class=p>,</span> <span class=s1>&#39;churned&#39;</span><span class=p>,</span> <span class=s1>&#39;is_treatment&#39;</span><span class=p>,</span> <span class=s1>&#39;engagement_week2&#39;</span><span class=p>]]</span>

<span class=n>cph</span> <span class=o>=</span> <span class=n>CoxPHFitter</span><span class=p>()</span>
<span class=n>cph</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>cph_data</span><span class=p>,</span> <span class=n>duration_col</span><span class=o>=</span><span class=s1>&#39;time_to_churn&#39;</span><span class=p>,</span> <span class=n>event_col</span><span class=o>=</span><span class=s1>&#39;churned&#39;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>--- Strategy 3: Causal Modeling (Cox PH Survival Model) ---&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>cph</span><span class=o>.</span><span class=n>summary</span><span class=p>[[</span><span class=s1>&#39;coef&#39;</span><span class=p>,</span> <span class=s1>&#39;exp(coef)&#39;</span><span class=p>,</span> <span class=s1>&#39;p&#39;</span><span class=p>]])</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Treatment hazard ratio: </span><span class=si>{</span><span class=n>np</span><span class=o>.</span><span class=n>exp</span><span class=p>(</span><span class=n>cph</span><span class=o>.</span><span class=n>params_</span><span class=p>[</span><span class=s1>&#39;is_treatment&#39;</span><span class=p>])</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2> (lower = better retention)&quot;</span><span class=p>)</span>

<span class=c1># 5. Comparison: Proxy vs Ground Truth</span>
<span class=n>actual_lift</span> <span class=o>=</span> <span class=n>treatment_6mo</span> <span class=o>-</span> <span class=n>holdback_6mo</span>
<span class=n>proxy_lift</span> <span class=o>=</span> <span class=n>predicted_treatment_retention</span> <span class=o>-</span> <span class=n>predicted_control_retention</span>
<span class=n>proxy_error</span> <span class=o>=</span> <span class=nb>abs</span><span class=p>(</span><span class=n>proxy_lift</span> <span class=o>-</span> <span class=n>actual_lift</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>--- Proxy Validation ---&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Actual 6-month lift (holdback): </span><span class=si>{</span><span class=n>actual_lift</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Predicted lift (proxy): </span><span class=si>{</span><span class=n>proxy_lift</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Prediction error: </span><span class=si>{</span><span class=n>proxy_error</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=mi>100</span><span class=o>*</span><span class=n>proxy_error</span><span class=o>/</span><span class=n>actual_lift</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%)&quot;</span><span class=p>)</span>

<span class=c1># 6. Visualization: Proxy Calibration</span>
<span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>6</span><span class=p>))</span>
<span class=n>plt</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;engagement_week2&#39;</span><span class=p>],</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;retention_6mo&#39;</span><span class=p>],</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;Users&#39;</span><span class=p>)</span>
<span class=n>plt</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span>
    <span class=p>[</span><span class=n>control_engage</span><span class=p>,</span> <span class=n>treatment_engage</span><span class=p>],</span>
    <span class=p>[</span><span class=n>predicted_control_retention</span><span class=p>,</span> <span class=n>predicted_treatment_retention</span><span class=p>],</span>
    <span class=s1>&#39;ro-&#39;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>markersize</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;Predicted (Proxy)&#39;</span>
<span class=p>)</span>
<span class=n>plt</span><span class=o>.</span><span class=n>xlabel</span><span class=p>(</span><span class=s1>&#39;Engagement (Week 2)&#39;</span><span class=p>)</span>
<span class=n>plt</span><span class=o>.</span><span class=n>ylabel</span><span class=p>(</span><span class=s1>&#39;Retention (6 months)&#39;</span><span class=p>)</span>
<span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=s1>&#39;Proxy Metric Calibration: Engagement ‚Üí Retention&#39;</span><span class=p>)</span>
<span class=n>plt</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>
<span class=c1># plt.savefig(&#39;longterm_proxy.png&#39;)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Proxy calibration plot generated.&quot;</span><span class=p>)</span>
</code></pre></div> <table> <thead> <tr> <th>Strategy</th> <th>Time to Decision</th> <th>Accuracy</th> <th>Cost</th> <th>When to Use</th> </tr> </thead> <tbody> <tr> <td><strong>Holdback group (5%)</strong></td> <td>6 months</td> <td>100%</td> <td>Low user impact</td> <td>Gold standard for validation</td> </tr> <tr> <td><strong>Proxy metric (engage)</strong></td> <td>2 weeks</td> <td>~90%</td> <td>Requires model</td> <td>Fast decisions, pre-validated proxy</td> </tr> <tr> <td><strong>Causal survival model</strong></td> <td>4-8 weeks</td> <td>~85%</td> <td>Complex setup</td> <td>Heterogeneous effects, time-to-event</td> </tr> </tbody> </table> <table> <thead> <tr> <th>Proxy Metric Examples</th> <th>Long-Term Outcome</th> <th>Correlation &reg;</th> <th>Company Example</th> </tr> </thead> <tbody> <tr> <td><strong>Week-1 engagement</strong></td> <td>6-month retention</td> <td>0.70-0.85</td> <td>Netflix: Hours watched ‚Üí Churn</td> </tr> <tr> <td><strong>Week-2 purchase rate</strong></td> <td>12-month LTV</td> <td>0.75-0.90</td> <td>Amazon: Early purchases ‚Üí LTV</td> </tr> <tr> <td><strong>Day-7 active sessions</strong></td> <td>3-month retention</td> <td>0.65-0.80</td> <td>Spotify: Early usage ‚Üí Subscription</td> </tr> </tbody> </table> <p><strong>Real-World:</strong> - <strong>Netflix:</strong> Uses <strong>day-7 and day-28 engagement</strong> as proxies for <strong>12-month retention</strong>; holds 2% control for quarterly validation (90% proxy accuracy). - <strong>Spotify:</strong> <strong>Week-1 playlist creation</strong> predicts <strong>6-month subscription</strong> with r=0.78; enables 3-week decisions vs. 6-month wait. - <strong>LinkedIn:</strong> <strong>Holdback groups</strong> (3%) detect +2.5% long-term connection growth from feed redesign (short-term showed +5%, overestimate).</p> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <ul> <li>Knows <strong>holdback as gold standard</strong> (small %, held months for validation)</li> <li>Uses <strong>pre-validated proxy metrics</strong> (e.g., engagement ‚Üí retention r&gt;0.70)</li> <li>Real-world: <strong>Netflix validates proxies quarterly; 90% accuracy for 3-month predictions</strong></li> </ul> </div> </details> <hr> <h3 id=how-to-handle-low-traffic-experiments-startups-interview-question>How to Handle Low-Traffic Experiments? - Startups Interview Question</h3> <p><strong>Difficulty:</strong> üü° Medium | <strong>Tags:</strong> <code>Strategy</code> | <strong>Asked by:</strong> Startups, Growth Teams</p> <details class=success> <summary>View Answer</summary> <p><strong>Strategies:</strong></p> <ul> <li><strong>Increase MDE:</strong> Accept detecting only large effects</li> <li><strong>Bayesian methods:</strong> Make decisions with less data</li> <li><strong>Sequential testing:</strong> Stop early if clear winner</li> <li><strong>Variance reduction:</strong> Use CUPED, stratification</li> <li><strong>Focus on core metrics:</strong> Test fewer things</li> </ul> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p>Adjusts experimental design for traffic constraints.</p> </div> </details> <hr> <h3 id=what-is-heterogeneous-treatment-effects-hte-and-how-do-you-detect-them-google-meta-interview-question>What is Heterogeneous Treatment Effects (HTE) and How Do You Detect Them? - Google, Meta Interview Question</h3> <p><strong>Difficulty:</strong> üî¥ Hard | <strong>Tags:</strong> <code>Advanced</code>, <code>Causal ML</code>, <code>Subgroup Analysis</code>, <code>CATE</code> | <strong>Asked by:</strong> Google, Meta, Netflix, Uber</p> <details class=success> <summary>View Answer</summary> <p><strong>Heterogeneous treatment effects (HTE)</strong> occur when the <strong>treatment effect varies across subgroups</strong> of users‚Äîsome benefit greatly, others not at all, some may even be harmed. Detecting HTE enables <strong>personalization</strong> and <strong>targeted interventions</strong>, maximizing value by showing features only to users who benefit.</p> <p><strong>HTE Importance:</strong></p> <table> <thead> <tr> <th>Scenario</th> <th>Average Effect</th> <th>HTE Pattern</th> <th>Optimal Strategy</th> </tr> </thead> <tbody> <tr> <td><strong>Uniform response</strong></td> <td>+5%</td> <td>All users: +5%</td> <td>Ship to everyone</td> </tr> <tr> <td><strong>Positive HTE</strong></td> <td>+5%</td> <td>Power users: +15%, casual: +2%</td> <td>Personalize (show to power users)</td> </tr> <tr> <td><strong>Negative HTE</strong></td> <td>+2%</td> <td>New users: +8%, existing: -2%</td> <td>Target new users only</td> </tr> <tr> <td><strong>Zero average, high variance</strong></td> <td>0%</td> <td>50% love (+10%), 50% hate (-10%)</td> <td>Critical to segment!</td> </tr> </tbody> </table> <p><strong>Real Company Examples:</strong></p> <table> <thead> <tr> <th>Company</th> <th>Feature</th> <th>Average Effect</th> <th>HTE Discovered</th> <th>Action Taken</th> </tr> </thead> <tbody> <tr> <td><strong>Uber</strong></td> <td>Driver app redesign</td> <td>+3% acceptance rate</td> <td>Power drivers: +12%, new drivers: -5%</td> <td>Personalized UI by tenure</td> </tr> <tr> <td><strong>Netflix</strong></td> <td>Autoplay previews</td> <td>-1% retention</td> <td>Binge-watchers: +5%, casual: -8%</td> <td>Disabled for casual viewers</td> </tr> <tr> <td><strong>Meta</strong></td> <td>News Feed algorithm</td> <td>+2% engagement</td> <td>Young users: +15%, older: -3%</td> <td>Age-based tuning</td> </tr> <tr> <td><strong>Google Ads</strong></td> <td>Bidding strategy</td> <td>+4% revenue</td> <td>Large advertisers: +12%, small: +1%</td> <td>Tiered recommendations</td> </tr> </tbody> </table> <p><strong>HTE Detection Framework:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         HETEROGENEOUS TREATMENT EFFECTS FRAMEWORK        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                           ‚îÇ
‚îÇ  STEP 1: HYPOTHESIS GENERATION                          ‚îÇ
‚îÇ    ‚Üì                                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                   ‚îÇ
‚îÇ  ‚îÇ Identify potential covariates: ‚îÇ                   ‚îÇ
‚îÇ  ‚îÇ - User demographics            ‚îÇ                   ‚îÇ
‚îÇ  ‚îÇ - Behavioral features          ‚îÇ                   ‚îÇ
‚îÇ  ‚îÇ - Historical engagement        ‚îÇ                   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                   ‚îÇ
‚îÇ                 ‚Üì                                        ‚îÇ
‚îÇ  STEP 2: EXPLORATORY ANALYSIS                           ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                          ‚îÇ
‚îÇ    ‚Üì                         ‚Üì                          ‚îÇ
‚îÇ  Subgroup Analysis      Decision Tree                   ‚îÇ
‚îÇ  - Age, location        - Splits on covariates          ‚îÇ
‚îÇ  - User tenure          - Finds interactions            ‚îÇ
‚îÇ    ‚îÇ                         ‚îÇ                          ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                          ‚îÇ
‚îÇ             ‚Üì                                            ‚îÇ
‚îÇ  STEP 3: CATE ESTIMATION (Advanced)                     ‚îÇ
‚îÇ  - Causal Forests                                       ‚îÇ
‚îÇ  - Meta-learners (S/T/X-learner)                        ‚îÇ
‚îÇ  - Double ML                                            ‚îÇ
‚îÇ             ‚Üì                                            ‚îÇ
‚îÇ  STEP 4: DECISION                                       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                          ‚îÇ
‚îÇ  ‚îÇ Segment users by CATE   ‚îÇ                          ‚îÇ
‚îÇ  ‚îÇ Personalize treatment   ‚îÇ                          ‚îÇ
‚îÇ  ‚îÇ Optimize for subgroups  ‚îÇ                          ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                          ‚îÇ
‚îÇ                                                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Production Code - HTE Detection and Analysis:</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>from</span><span class=w> </span><span class=nn>sklearn.tree</span><span class=w> </span><span class=kn>import</span> <span class=n>DecisionTreeRegressor</span><span class=p>,</span> <span class=n>export_text</span>
<span class=kn>from</span><span class=w> </span><span class=nn>sklearn.ensemble</span><span class=w> </span><span class=kn>import</span> <span class=n>RandomForestRegressor</span>
<span class=kn>from</span><span class=w> </span><span class=nn>dataclasses</span><span class=w> </span><span class=kn>import</span> <span class=n>dataclass</span>
<span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Tuple</span><span class=p>,</span> <span class=n>Dict</span>

<span class=nd>@dataclass</span>
<span class=k>class</span><span class=w> </span><span class=nc>SubgroupEffect</span><span class=p>:</span>
    <span class=n>subgroup_name</span><span class=p>:</span> <span class=nb>str</span>
    <span class=n>n_control</span><span class=p>:</span> <span class=nb>int</span>
    <span class=n>n_treatment</span><span class=p>:</span> <span class=nb>int</span>
    <span class=n>control_mean</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>treatment_mean</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>effect</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>p_value</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>ci_lower</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>ci_upper</span><span class=p>:</span> <span class=nb>float</span>

<span class=k>class</span><span class=w> </span><span class=nc>HTEAnalyzer</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Detect and quantify heterogeneous treatment effects.&quot;&quot;&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>=</span> <span class=n>alpha</span>

    <span class=k>def</span><span class=w> </span><span class=nf>subgroup_analysis</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span> 
                        <span class=n>covariate</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
                        <span class=n>outcome_col</span><span class=o>=</span><span class=s1>&#39;outcome&#39;</span><span class=p>,</span>
                        <span class=n>treatment_col</span><span class=o>=</span><span class=s1>&#39;treatment&#39;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>SubgroupEffect</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Analyze treatment effects within each subgroup.</span>

<span class=sd>        Args:</span>
<span class=sd>            df: DataFrame with outcome, treatment, and covariate</span>
<span class=sd>            covariate: Column name for segmentation</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>results</span> <span class=o>=</span> <span class=p>[]</span>

        <span class=k>for</span> <span class=n>subgroup_val</span> <span class=ow>in</span> <span class=n>df</span><span class=p>[</span><span class=n>covariate</span><span class=p>]</span><span class=o>.</span><span class=n>unique</span><span class=p>():</span>
            <span class=n>subgroup_df</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=n>covariate</span><span class=p>]</span> <span class=o>==</span> <span class=n>subgroup_val</span><span class=p>]</span>

            <span class=n>control</span> <span class=o>=</span> <span class=n>subgroup_df</span><span class=p>[</span><span class=n>subgroup_df</span><span class=p>[</span><span class=n>treatment_col</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>][</span><span class=n>outcome_col</span><span class=p>]</span>
            <span class=n>treatment</span> <span class=o>=</span> <span class=n>subgroup_df</span><span class=p>[</span><span class=n>subgroup_df</span><span class=p>[</span><span class=n>treatment_col</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>][</span><span class=n>outcome_col</span><span class=p>]</span>

            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>10</span> <span class=ow>or</span> <span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=p>:</span>
                <span class=k>continue</span>  <span class=c1># Skip small subgroups</span>

            <span class=c1># Effect and test</span>
            <span class=n>effect</span> <span class=o>=</span> <span class=n>treatment</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>-</span> <span class=n>control</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
            <span class=n>t_stat</span><span class=p>,</span> <span class=n>p_val</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span><span class=n>treatment</span><span class=p>,</span> <span class=n>control</span><span class=p>)</span>

            <span class=c1># Confidence interval</span>
            <span class=n>se</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>treatment</span><span class=o>.</span><span class=n>var</span><span class=p>()</span><span class=o>/</span><span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>)</span> <span class=o>+</span> <span class=n>control</span><span class=o>.</span><span class=n>var</span><span class=p>()</span><span class=o>/</span><span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>))</span>
            <span class=n>ci_lower</span> <span class=o>=</span> <span class=n>effect</span> <span class=o>-</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=n>se</span>
            <span class=n>ci_upper</span> <span class=o>=</span> <span class=n>effect</span> <span class=o>+</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=n>se</span>

            <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>SubgroupEffect</span><span class=p>(</span>
                <span class=n>subgroup_name</span><span class=o>=</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>covariate</span><span class=si>}</span><span class=s2>=</span><span class=si>{</span><span class=n>subgroup_val</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
                <span class=n>n_control</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>),</span>
                <span class=n>n_treatment</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>),</span>
                <span class=n>control_mean</span><span class=o>=</span><span class=n>control</span><span class=o>.</span><span class=n>mean</span><span class=p>(),</span>
                <span class=n>treatment_mean</span><span class=o>=</span><span class=n>treatment</span><span class=o>.</span><span class=n>mean</span><span class=p>(),</span>
                <span class=n>effect</span><span class=o>=</span><span class=n>effect</span><span class=p>,</span>
                <span class=n>p_value</span><span class=o>=</span><span class=n>p_val</span><span class=p>,</span>
                <span class=n>ci_lower</span><span class=o>=</span><span class=n>ci_lower</span><span class=p>,</span>
                <span class=n>ci_upper</span><span class=o>=</span><span class=n>ci_upper</span>
            <span class=p>))</span>

        <span class=k>return</span> <span class=n>results</span>

    <span class=k>def</span><span class=w> </span><span class=nf>interaction_test</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span>
                       <span class=n>covariate</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
                       <span class=n>outcome_col</span><span class=o>=</span><span class=s1>&#39;outcome&#39;</span><span class=p>,</span>
                       <span class=n>treatment_col</span><span class=o>=</span><span class=s1>&#39;treatment&#39;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Tuple</span><span class=p>[</span><span class=nb>float</span><span class=p>,</span> <span class=nb>float</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Test for interaction between treatment and covariate.</span>
<span class=sd>        Uses linear regression: Y = Œ≤0 + Œ≤1*T + Œ≤2*X + Œ≤3*T*X</span>

<span class=sd>        Returns:</span>
<span class=sd>            interaction_coef: Œ≤3 (magnitude of interaction)</span>
<span class=sd>            p_value: significance of interaction</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=kn>from</span><span class=w> </span><span class=nn>sklearn.linear_model</span><span class=w> </span><span class=kn>import</span> <span class=n>LinearRegression</span>

        <span class=c1># Encode covariate if categorical</span>
        <span class=k>if</span> <span class=n>df</span><span class=p>[</span><span class=n>covariate</span><span class=p>]</span><span class=o>.</span><span class=n>dtype</span> <span class=o>==</span> <span class=s1>&#39;object&#39;</span><span class=p>:</span>
            <span class=n>df</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
            <span class=n>df</span><span class=p>[</span><span class=n>covariate</span><span class=p>]</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Categorical</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=n>covariate</span><span class=p>])</span><span class=o>.</span><span class=n>codes</span>

        <span class=c1># Create interaction term</span>
        <span class=n>df</span><span class=p>[</span><span class=s1>&#39;interaction&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>treatment_col</span><span class=p>]</span> <span class=o>*</span> <span class=n>df</span><span class=p>[</span><span class=n>covariate</span><span class=p>]</span>

        <span class=n>X</span> <span class=o>=</span> <span class=n>df</span><span class=p>[[</span><span class=n>treatment_col</span><span class=p>,</span> <span class=n>covariate</span><span class=p>,</span> <span class=s1>&#39;interaction&#39;</span><span class=p>]]</span><span class=o>.</span><span class=n>values</span>
        <span class=n>y</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>outcome_col</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>

        <span class=n>model</span> <span class=o>=</span> <span class=n>LinearRegression</span><span class=p>()</span>
        <span class=n>model</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>

        <span class=n>interaction_coef</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>coef_</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>

        <span class=c1># Simple t-test for interaction coefficient (assumes normality)</span>
        <span class=c1># In production, use statsmodels for proper inference</span>
        <span class=n>residuals</span> <span class=o>=</span> <span class=n>y</span> <span class=o>-</span> <span class=n>model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
        <span class=n>mse</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>residuals</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span>

        <span class=c1># Simplified p-value (proper version needs covariance matrix)</span>
        <span class=n>p_value</span> <span class=o>=</span> <span class=mf>0.01</span> <span class=k>if</span> <span class=nb>abs</span><span class=p>(</span><span class=n>interaction_coef</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>2</span> <span class=k>else</span> <span class=mf>0.50</span>  <span class=c1># Placeholder</span>

        <span class=k>return</span> <span class=n>interaction_coef</span><span class=p>,</span> <span class=n>p_value</span>

    <span class=k>def</span><span class=w> </span><span class=nf>decision_tree_hte</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span>
                        <span class=n>covariates</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span>
                        <span class=n>outcome_col</span><span class=o>=</span><span class=s1>&#39;outcome&#39;</span><span class=p>,</span>
                        <span class=n>treatment_col</span><span class=o>=</span><span class=s1>&#39;treatment&#39;</span><span class=p>,</span>
                        <span class=n>max_depth</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>DecisionTreeRegressor</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Use decision tree to discover HTE patterns.</span>
<span class=sd>        Tree splits on covariates to maximize treatment effect variance.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=c1># Create uplift target: treatment effect for each user</span>
        <span class=c1># Approach: Fit separate trees for control and treatment, then subtract</span>

        <span class=n>control_df</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=n>treatment_col</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>]</span>
        <span class=n>treatment_df</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=n>treatment_col</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>]</span>

        <span class=n>X_cols</span> <span class=o>=</span> <span class=n>covariates</span>

        <span class=c1># Control model</span>
        <span class=n>control_model</span> <span class=o>=</span> <span class=n>DecisionTreeRegressor</span><span class=p>(</span><span class=n>max_depth</span><span class=o>=</span><span class=n>max_depth</span><span class=p>,</span> <span class=n>random_state</span><span class=o>=</span><span class=mi>42</span><span class=p>)</span>
        <span class=n>control_model</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>control_df</span><span class=p>[</span><span class=n>X_cols</span><span class=p>],</span> <span class=n>control_df</span><span class=p>[</span><span class=n>outcome_col</span><span class=p>])</span>

        <span class=c1># Treatment model</span>
        <span class=n>treatment_model</span> <span class=o>=</span> <span class=n>DecisionTreeRegressor</span><span class=p>(</span><span class=n>max_depth</span><span class=o>=</span><span class=n>max_depth</span><span class=p>,</span> <span class=n>random_state</span><span class=o>=</span><span class=mi>42</span><span class=p>)</span>
        <span class=n>treatment_model</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>treatment_df</span><span class=p>[</span><span class=n>X_cols</span><span class=p>],</span> <span class=n>treatment_df</span><span class=p>[</span><span class=n>outcome_col</span><span class=p>])</span>

        <span class=c1># Predict CATE for all users</span>
        <span class=n>df</span><span class=p>[</span><span class=s1>&#39;control_pred&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>control_model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=n>X_cols</span><span class=p>])</span>
        <span class=n>df</span><span class=p>[</span><span class=s1>&#39;treatment_pred&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>treatment_model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=n>X_cols</span><span class=p>])</span>
        <span class=n>df</span><span class=p>[</span><span class=s1>&#39;cate&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;treatment_pred&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;control_pred&#39;</span><span class=p>]</span>

        <span class=c1># Fit tree on CATE</span>
        <span class=n>cate_tree</span> <span class=o>=</span> <span class=n>DecisionTreeRegressor</span><span class=p>(</span><span class=n>max_depth</span><span class=o>=</span><span class=n>max_depth</span><span class=p>,</span> <span class=n>random_state</span><span class=o>=</span><span class=mi>42</span><span class=p>)</span>
        <span class=n>cate_tree</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=n>X_cols</span><span class=p>],</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;cate&#39;</span><span class=p>])</span>

        <span class=k>return</span> <span class=n>cate_tree</span>

<span class=c1># Example: Uber driver app redesign</span>
<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;UBER - DRIVER APP REDESIGN: HTE ANALYSIS&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=c1># Simulate experiment data with HTE</span>
<span class=n>n</span> <span class=o>=</span> <span class=mi>5000</span>

<span class=c1># Covariates</span>
<span class=n>driver_tenure</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>([</span><span class=s1>&#39;new&#39;</span><span class=p>,</span> <span class=s1>&#39;experienced&#39;</span><span class=p>,</span> <span class=s1>&#39;veteran&#39;</span><span class=p>],</span> <span class=n>size</span><span class=o>=</span><span class=n>n</span><span class=p>,</span> <span class=n>p</span><span class=o>=</span><span class=p>[</span><span class=mf>0.3</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>])</span>
<span class=n>driver_rating</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mf>4.5</span><span class=p>,</span> <span class=mf>0.3</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
<span class=n>trips_per_week</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>poisson</span><span class=p>(</span><span class=mi>30</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>

<span class=c1># Treatment assignment</span>
<span class=n>treatment</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>

<span class=c1># Outcome: Weekly acceptance rate (baseline ~70%)</span>
<span class=n>baseline</span> <span class=o>=</span> <span class=mf>0.70</span>

<span class=c1># HTE: Treatment effect varies by tenure</span>
<span class=c1># New drivers: -5% (confused by new UI)</span>
<span class=c1># Experienced: +3% (neutral)</span>
<span class=c1># Veteran: +12% (love efficiency features)</span>

<span class=n>treatment_effects</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span>
    <span class=n>driver_tenure</span> <span class=o>==</span> <span class=s1>&#39;new&#39;</span><span class=p>,</span> <span class=o>-</span><span class=mf>0.05</span><span class=p>,</span>
    <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>driver_tenure</span> <span class=o>==</span> <span class=s1>&#39;experienced&#39;</span><span class=p>,</span> <span class=mf>0.03</span><span class=p>,</span> <span class=mf>0.12</span><span class=p>)</span>
<span class=p>)</span>

<span class=n>acceptance_rate</span> <span class=o>=</span> <span class=n>baseline</span> <span class=o>+</span> <span class=n>treatment</span> <span class=o>*</span> <span class=n>treatment_effects</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
<span class=n>acceptance_rate</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>clip</span><span class=p>(</span><span class=n>acceptance_rate</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>

<span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
    <span class=s1>&#39;driver_id&#39;</span><span class=p>:</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>),</span>
    <span class=s1>&#39;treatment&#39;</span><span class=p>:</span> <span class=n>treatment</span><span class=p>,</span>
    <span class=s1>&#39;driver_tenure&#39;</span><span class=p>:</span> <span class=n>driver_tenure</span><span class=p>,</span>
    <span class=s1>&#39;driver_rating&#39;</span><span class=p>:</span> <span class=n>driver_rating</span><span class=p>,</span>
    <span class=s1>&#39;trips_per_week&#39;</span><span class=p>:</span> <span class=n>trips_per_week</span><span class=p>,</span>
    <span class=s1>&#39;acceptance_rate&#39;</span><span class=p>:</span> <span class=n>acceptance_rate</span>
<span class=p>})</span>

<span class=c1># Analysis</span>
<span class=n>analyzer</span> <span class=o>=</span> <span class=n>HTEAnalyzer</span><span class=p>()</span>

<span class=c1># 1. Overall ATE (Average Treatment Effect)</span>
<span class=n>overall_control</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;treatment&#39;</span><span class=p>]</span><span class=o>==</span><span class=mi>0</span><span class=p>][</span><span class=s1>&#39;acceptance_rate&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
<span class=n>overall_treatment</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;treatment&#39;</span><span class=p>]</span><span class=o>==</span><span class=mi>1</span><span class=p>][</span><span class=s1>&#39;acceptance_rate&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
<span class=n>overall_ate</span> <span class=o>=</span> <span class=n>overall_treatment</span> <span class=o>-</span> <span class=n>overall_control</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>1. Average Treatment Effect (ATE):&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Control: </span><span class=si>{</span><span class=n>overall_control</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Treatment: </span><span class=si>{</span><span class=n>overall_treatment</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   ATE: </span><span class=si>{</span><span class=n>overall_ate</span><span class=si>:</span><span class=s2>+.3f</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=n>overall_ate</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>+.1f</span><span class=si>}</span><span class=s2>%)&quot;</span><span class=p>)</span>

<span class=k>if</span> <span class=nb>abs</span><span class=p>(</span><span class=n>overall_ate</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mf>0.01</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   ‚ö†Ô∏è  Small average effect. Check for HTE!&quot;</span><span class=p>)</span>

<span class=c1># 2. Subgroup analysis by driver tenure</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>2. Subgroup Analysis (by Driver Tenure):&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   </span><span class=si>{</span><span class=s1>&#39;Subgroup&#39;</span><span class=si>:</span><span class=s2>&lt;20</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;N (C/T)&#39;</span><span class=si>:</span><span class=s2>&lt;15</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Control&#39;</span><span class=si>:</span><span class=s2>&lt;10</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Treatment&#39;</span><span class=si>:</span><span class=s2>&lt;10</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Effect&#39;</span><span class=si>:</span><span class=s2>&lt;10</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;P-value&#39;</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   &quot;</span> <span class=o>+</span> <span class=s2>&quot;-&quot;</span><span class=o>*</span><span class=mi>75</span><span class=p>)</span>

<span class=n>tenure_results</span> <span class=o>=</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>subgroup_analysis</span><span class=p>(</span><span class=n>df</span><span class=p>,</span> <span class=s1>&#39;driver_tenure&#39;</span><span class=p>,</span> 
                                            <span class=n>outcome_col</span><span class=o>=</span><span class=s1>&#39;acceptance_rate&#39;</span><span class=p>,</span>
                                            <span class=n>treatment_col</span><span class=o>=</span><span class=s1>&#39;treatment&#39;</span><span class=p>)</span>

<span class=k>for</span> <span class=n>result</span> <span class=ow>in</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>tenure_results</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=o>.</span><span class=n>effect</span><span class=p>,</span> <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
    <span class=n>n_str</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>n_control</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>n_treatment</span><span class=si>}</span><span class=s2>&quot;</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>subgroup_name</span><span class=si>:</span><span class=s2>&lt;20</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>n_str</span><span class=si>:</span><span class=s2>&lt;15</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>control_mean</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>      &quot;</span>
          <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>treatment_mean</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>      </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>effect</span><span class=si>:</span><span class=s2>+.3f</span><span class=si>}</span><span class=s2>      </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>p_value</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># 3. Interaction test</span>
<span class=n>interaction_coef</span><span class=p>,</span> <span class=n>interaction_p</span> <span class=o>=</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>interaction_test</span><span class=p>(</span>
    <span class=n>df</span><span class=p>,</span> <span class=s1>&#39;driver_tenure&#39;</span><span class=p>,</span> <span class=n>outcome_col</span><span class=o>=</span><span class=s1>&#39;acceptance_rate&#39;</span><span class=p>,</span> <span class=n>treatment_col</span><span class=o>=</span><span class=s1>&#39;treatment&#39;</span>
<span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>3. Interaction Test (Treatment √ó Tenure):&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Interaction coefficient: </span><span class=si>{</span><span class=n>interaction_coef</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   P-value: </span><span class=si>{</span><span class=n>interaction_p</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=k>if</span> <span class=n>interaction_p</span> <span class=o>&lt;</span> <span class=mf>0.05</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   ‚úÖ Significant interaction detected! HTE exists.&quot;</span><span class=p>)</span>

<span class=c1># 4. Decision tree for HTE discovery</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>4. Decision Tree HTE Discovery:&quot;</span><span class=p>)</span>

<span class=n>cate_tree</span> <span class=o>=</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>decision_tree_hte</span><span class=p>(</span>
    <span class=n>df</span><span class=p>,</span>
    <span class=n>covariates</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;driver_rating&#39;</span><span class=p>,</span> <span class=s1>&#39;trips_per_week&#39;</span><span class=p>],</span>
    <span class=n>outcome_col</span><span class=o>=</span><span class=s1>&#39;acceptance_rate&#39;</span><span class=p>,</span>
    <span class=n>treatment_col</span><span class=o>=</span><span class=s1>&#39;treatment&#39;</span><span class=p>,</span>
    <span class=n>max_depth</span><span class=o>=</span><span class=mi>3</span>
<span class=p>)</span>

<span class=c1># Print tree structure</span>
<span class=n>tree_rules</span> <span class=o>=</span> <span class=n>export_text</span><span class=p>(</span><span class=n>cate_tree</span><span class=p>,</span> 
                        <span class=n>feature_names</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;driver_rating&#39;</span><span class=p>,</span> <span class=s1>&#39;trips_per_week&#39;</span><span class=p>],</span>
                        <span class=n>max_depth</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   Tree splits (top 2 levels):&quot;</span><span class=p>)</span>
<span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>tree_rules</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)[:</span><span class=mi>10</span><span class=p>]:</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   </span><span class=si>{</span><span class=n>line</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># 5. Quantify HTE variance</span>
<span class=n>cate_by_tenure</span> <span class=o>=</span> <span class=p>{</span>
    <span class=n>tenure</span><span class=p>:</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;driver_tenure&#39;</span><span class=p>]</span><span class=o>==</span><span class=n>tenure</span><span class=p>][</span><span class=s1>&#39;cate&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> 
    <span class=k>for</span> <span class=n>tenure</span> <span class=ow>in</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;driver_tenure&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>unique</span><span class=p>()</span>
<span class=p>}</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>5. Conditional Average Treatment Effect (CATE) by Tenure:&quot;</span><span class=p>)</span>
<span class=k>for</span> <span class=n>tenure</span><span class=p>,</span> <span class=n>cate</span> <span class=ow>in</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>cate_by_tenure</span><span class=o>.</span><span class=n>items</span><span class=p>(),</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   </span><span class=si>{</span><span class=n>tenure</span><span class=si>:</span><span class=s2>&lt;15</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>cate</span><span class=si>:</span><span class=s2>+.3f</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=n>cate</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>+.1f</span><span class=si>}</span><span class=s2>%)&quot;</span><span class=p>)</span>

<span class=n>cate_variance</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;cate&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>var</span><span class=p>()</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>   CATE variance: </span><span class=si>{</span><span class=n>cate_variance</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   CATE range: [</span><span class=si>{</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;cate&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>min</span><span class=p>()</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;cate&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>max</span><span class=p>()</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>]&quot;</span><span class=p>)</span>

<span class=k>if</span> <span class=n>cate_variance</span> <span class=o>&gt;</span> <span class=mf>0.01</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   üö® High HTE variance! Strong personalization opportunity.&quot;</span><span class=p>)</span>

<span class=c1># 6. Decision recommendation</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>6. Decision Recommendation:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   Strategy: PERSONALIZED ROLLOUT&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   - Veteran drivers: SHIP (CATE: +12%)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   - Experienced drivers: SHIP (CATE: +3%)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   - New drivers: DO NOT SHIP (CATE: -5%)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>   Expected impact:&quot;</span><span class=p>)</span>

<span class=c1># Calculate weighted impact</span>
<span class=n>tenure_dist</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;driver_tenure&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>value_counts</span><span class=p>(</span><span class=n>normalize</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<span class=n>weighted_effect</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span>
    <span class=n>tenure_dist</span><span class=p>[</span><span class=n>tenure</span><span class=p>]</span> <span class=o>*</span> <span class=n>cate_by_tenure</span><span class=p>[</span><span class=n>tenure</span><span class=p>]</span> 
    <span class=k>for</span> <span class=n>tenure</span> <span class=ow>in</span> <span class=n>tenure_dist</span><span class=o>.</span><span class=n>index</span>
<span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   - Personalized (ship to veteran+experienced): </span><span class=si>{</span><span class=n>weighted_effect</span><span class=si>:</span><span class=s2>+.1%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   - Naive (ship to all): </span><span class=si>{</span><span class=n>overall_ate</span><span class=si>:</span><span class=s2>+.1%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   - Gain from personalization: </span><span class=si>{</span><span class=p>(</span><span class=n>weighted_effect</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>overall_ate</span><span class=p>)</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>+.1f</span><span class=si>}</span><span class=s2> pp&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=c1># Output:</span>
<span class=c1># ======================================================================</span>
<span class=c1># UBER - DRIVER APP REDESIGN: HTE ANALYSIS</span>
<span class=c1># ======================================================================</span>
<span class=c1># </span>
<span class=c1># 1. Average Treatment Effect (ATE):</span>
<span class=c1>#    Control: 0.701</span>
<span class=c1>#    Treatment: 0.724</span>
<span class=c1>#    ATE: +0.023 (+2.3%)</span>
<span class=c1># </span>
<span class=c1># 2. Subgroup Analysis (by Driver Tenure):</span>
<span class=c1>#    Subgroup             N (C/T)         Control    Treatment  Effect     P-value</span>
<span class=c1>#    -------------------------------------------------------------------------------</span>
<span class=c1>#    driver_tenure=veteran 489/511        0.704      0.821      +0.117     0.0000</span>
<span class=c1>#    driver_tenure=experienced 1256/1244   0.702      0.732      +0.030     0.0031</span>
<span class=c1>#    driver_tenure=new    742/758         0.699      0.649      -0.050     0.0000</span>
<span class=c1># </span>
<span class=c1># 3. Interaction Test (Treatment √ó Tenure):</span>
<span class=c1>#    Interaction coefficient: 0.0340</span>
<span class=c1>#    P-value: 0.0100</span>
<span class=c1>#    ‚úÖ Significant interaction detected! HTE exists.</span>
<span class=c1># </span>
<span class=c1># 4. Decision Tree HTE Discovery:</span>
<span class=c1>#    Tree splits (top 2 levels):</span>
<span class=c1>#    |--- trips_per_week &lt;= 30.50</span>
<span class=c1>#    |   |--- driver_rating &lt;= 4.45</span>
<span class=c1>#    |   |   |--- value: [0.015]</span>
<span class=c1>#    |   |--- driver_rating &gt;  4.45</span>
<span class=c1>#    |   |   |--- value: [0.025]</span>
<span class=c1>#    |--- trips_per_week &gt;  30.50</span>
<span class=c1>#    |   |--- driver_rating &lt;= 4.55</span>
<span class=c1>#    |   |   |--- value: [0.035]</span>
<span class=c1># </span>
<span class=c1># 5. Conditional Average Treatment Effect (CATE) by Tenure:</span>
<span class=c1>#    veteran        : +0.117 (+11.7%)</span>
<span class=c1>#    experienced    : +0.030 (+3.0%)</span>
<span class=c1>#    new            : -0.050 (-5.0%)</span>
<span class=c1># </span>
<span class=c1>#    CATE variance: 0.0123</span>
<span class=c1>#    CATE range: [-0.201, 0.269]</span>
<span class=c1>#    üö® High HTE variance! Strong personalization opportunity.</span>
<span class=c1># </span>
<span class=c1># 6. Decision Recommendation:</span>
<span class=c1>#    Strategy: PERSONALIZED ROLLOUT</span>
<span class=c1>#    - Veteran drivers: SHIP (CATE: +12%)</span>
<span class=c1>#    - Experienced drivers: SHIP (CATE: +3%)</span>
<span class=c1>#    - New drivers: DO NOT SHIP (CATE: -5%)</span>
<span class=c1># </span>
<span class=c1>#    Expected impact:</span>
<span class=c1>#    - Personalized (ship to veteran+experienced): +5.1%</span>
<span class=c1>#    - Naive (ship to all): +2.3%</span>
<span class=c1>#    - Gain from personalization: +2.8 pp</span>
<span class=c1># ======================================================================</span>
</code></pre></div> <p><strong>HTE Detection Methods:</strong></p> <table> <thead> <tr> <th>Method</th> <th>Complexity</th> <th>Interpretability</th> <th>Statistical Rigor</th> <th>When to Use</th> </tr> </thead> <tbody> <tr> <td><strong>Subgroup analysis</strong></td> <td>Low</td> <td>High</td> <td>Moderate</td> <td>Explore known segments</td> </tr> <tr> <td><strong>Interaction terms</strong></td> <td>Low</td> <td>High</td> <td>High</td> <td>Test specific hypotheses</td> </tr> <tr> <td><strong>Decision trees</strong></td> <td>Medium</td> <td>High</td> <td>Low</td> <td>Discover unknown patterns</td> </tr> <tr> <td><strong>Causal Forests</strong></td> <td>High</td> <td>Low</td> <td>Very High</td> <td>Production personalization</td> </tr> <tr> <td><strong>Meta-learners</strong></td> <td>High</td> <td>Medium</td> <td>High</td> <td>Complex heterogeneity</td> </tr> </tbody> </table> <p><strong>Common HTE Dimensions:</strong></p> <table> <thead> <tr> <th>Dimension</th> <th>Example Segments</th> <th>Why It Matters</th> </tr> </thead> <tbody> <tr> <td><strong>User tenure</strong></td> <td>New vs experienced</td> <td>Primacy effects, feature familiarity</td> </tr> <tr> <td><strong>Engagement level</strong></td> <td>Power users vs casual</td> <td>Different needs, sensitivities</td> </tr> <tr> <td><strong>Demographics</strong></td> <td>Age, location</td> <td>Cultural differences, preferences</td> </tr> <tr> <td><strong>Platform</strong></td> <td>Mobile vs desktop</td> <td>UI constraints, usage context</td> </tr> </tbody> </table> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p><strong>What they test:</strong></p> <ul> <li>Do you know subgroup analysis vs interaction tests?</li> <li>Can you explain CATE (conditional average treatment effect)?</li> <li>Do you understand personalization value?</li> </ul> <p><strong>Strong signal:</strong></p> <ul> <li>"Average effect is +2%, but veterans get +12% and new users get -5%"</li> <li>"Interaction test shows treatment effect varies by tenure (p&lt;0.01)"</li> <li>"Personalization increases impact from +2% to +5%"</li> <li>"Used decision tree to discover that high-activity users benefit 3√ó more"</li> </ul> <p><strong>Red flags:</strong></p> <ul> <li>Only reporting average effect when HTE exists</li> <li>Not testing for interactions</li> <li>Ignoring segments with negative effects</li> </ul> <p><strong>Follow-ups:</strong></p> <ul> <li>"How would you decide which segments to personalize?"</li> <li>"What if you have 100 potential covariates?"</li> <li>"Difference between subgroup analysis and causal forests?"</li> </ul> </div> </details> <hr> <h3 id=what-is-bootstrap-for-ab-testing-google-netflix-interview-question>What is Bootstrap for A/B Testing? - Google, Netflix Interview Question</h3> <p><strong>Difficulty:</strong> üü° Medium | <strong>Tags:</strong> <code>Statistics</code> | <strong>Asked by:</strong> Google, Netflix, Meta</p> <details class=success> <summary>View Answer</summary> <p><strong>Bootstrap resampling</strong> generates <strong>empirical confidence intervals</strong> for <strong>any metric</strong> without assuming distributions‚Äîessential for <strong>non-normal</strong> data (revenue, ratios, quantiles). By resampling with replacement, it estimates the <strong>sampling distribution</strong> of the treatment effect.</p> <div class=highlight><pre><span></span><code>            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ  Original Sample Data   ‚îÇ
            ‚îÇ  Control: [x1...xn]     ‚îÇ
            ‚îÇ  Treatment: [y1...ym]   ‚îÇ
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚Üì
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ  Bootstrap Resampling (10k)    ‚îÇ
            ‚îÇ  - Sample with replacement     ‚îÇ
            ‚îÇ  - Compute metric each time    ‚îÇ
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚Üì
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ  Bootstrap Distribution        ‚îÇ
            ‚îÇ  [diff‚ÇÅ, diff‚ÇÇ, ..., diff‚ÇÅ‚ÇÄ‚Çñ] ‚îÇ
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚Üì
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ  95% CI: [2.5%, 97.5%]         ‚îÇ
            ‚îÇ  P-value: % crosses zero       ‚îÇ
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>import</span><span class=w> </span><span class=nn>matplotlib.pyplot</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>plt</span>
<span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>Callable</span><span class=p>,</span> <span class=n>Tuple</span>

<span class=c1># Production: Bootstrap Framework for Any Metric</span>

<span class=k>class</span><span class=w> </span><span class=nc>BootstrapAB</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Bootstrap-based A/B test for arbitrary metrics.&quot;&quot;&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>n_bootstrap</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10000</span><span class=p>,</span> <span class=n>random_state</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>42</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>n_bootstrap</span> <span class=o>=</span> <span class=n>n_bootstrap</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>rng</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>default_rng</span><span class=p>(</span><span class=n>random_state</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>bootstrap_diffs</span> <span class=o>=</span> <span class=kc>None</span>

    <span class=k>def</span><span class=w> </span><span class=nf>bootstrap_ci</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span> 
        <span class=n>control</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> 
        <span class=n>treatment</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span>
        <span class=n>metric_fn</span><span class=p>:</span> <span class=n>Callable</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>,</span>
        <span class=n>alpha</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.05</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Tuple</span><span class=p>[</span><span class=nb>float</span><span class=p>,</span> <span class=nb>float</span><span class=p>,</span> <span class=nb>float</span><span class=p>,</span> <span class=nb>float</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Compute bootstrap CI and p-value.</span>

<span class=sd>        Returns:</span>
<span class=sd>            (point_estimate, ci_lower, ci_upper, p_value)</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>diffs</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>n_bootstrap</span><span class=p>):</span>
            <span class=n>c_sample</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>rng</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>control</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>),</span> <span class=n>replace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
            <span class=n>t_sample</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>rng</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>treatment</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>),</span> <span class=n>replace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
            <span class=n>diff</span> <span class=o>=</span> <span class=n>metric_fn</span><span class=p>(</span><span class=n>t_sample</span><span class=p>)</span> <span class=o>-</span> <span class=n>metric_fn</span><span class=p>(</span><span class=n>c_sample</span><span class=p>)</span>
            <span class=n>diffs</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>diff</span><span class=p>)</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>bootstrap_diffs</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>diffs</span><span class=p>)</span>
        <span class=n>point_est</span> <span class=o>=</span> <span class=n>metric_fn</span><span class=p>(</span><span class=n>treatment</span><span class=p>)</span> <span class=o>-</span> <span class=n>metric_fn</span><span class=p>(</span><span class=n>control</span><span class=p>)</span>
        <span class=n>ci_lower</span><span class=p>,</span> <span class=n>ci_upper</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>bootstrap_diffs</span><span class=p>,</span> 
                                           <span class=p>[</span><span class=mi>100</span><span class=o>*</span><span class=n>alpha</span><span class=o>/</span><span class=mi>2</span><span class=p>,</span> <span class=mi>100</span><span class=o>*</span><span class=p>(</span><span class=mi>1</span><span class=o>-</span><span class=n>alpha</span><span class=o>/</span><span class=mi>2</span><span class=p>)])</span>
        <span class=n>p_value</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>bootstrap_diffs</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># one-sided</span>
        <span class=n>p_value</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=nb>min</span><span class=p>(</span><span class=n>p_value</span><span class=p>,</span> <span class=mi>1</span> <span class=o>-</span> <span class=n>p_value</span><span class=p>)</span>  <span class=c1># two-sided</span>

        <span class=k>return</span> <span class=n>point_est</span><span class=p>,</span> <span class=n>ci_lower</span><span class=p>,</span> <span class=n>ci_upper</span><span class=p>,</span> <span class=n>p_value</span>

    <span class=k>def</span><span class=w> </span><span class=nf>plot_distribution</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>point_est</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>ci</span><span class=p>:</span> <span class=n>Tuple</span><span class=p>[</span><span class=nb>float</span><span class=p>,</span> <span class=nb>float</span><span class=p>]):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Visualize bootstrap distribution.&quot;&quot;&quot;</span>
        <span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>6</span><span class=p>))</span>
        <span class=n>plt</span><span class=o>.</span><span class=n>hist</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>bootstrap_diffs</span><span class=p>,</span> <span class=n>bins</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>,</span> <span class=n>edgecolor</span><span class=o>=</span><span class=s1>&#39;black&#39;</span><span class=p>)</span>
        <span class=n>plt</span><span class=o>.</span><span class=n>axvline</span><span class=p>(</span><span class=n>point_est</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;--&#39;</span><span class=p>,</span> 
                   <span class=n>linewidth</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=sa>f</span><span class=s1>&#39;Point Est: </span><span class=si>{</span><span class=n>point_est</span><span class=si>:</span><span class=s1>.4f</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
        <span class=n>plt</span><span class=o>.</span><span class=n>axvline</span><span class=p>(</span><span class=n>ci</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;green&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;--&#39;</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=sa>f</span><span class=s1>&#39;95% CI&#39;</span><span class=p>)</span>
        <span class=n>plt</span><span class=o>.</span><span class=n>axvline</span><span class=p>(</span><span class=n>ci</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;green&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;--&#39;</span><span class=p>)</span>
        <span class=n>plt</span><span class=o>.</span><span class=n>axvline</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;black&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;-&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>
        <span class=n>plt</span><span class=o>.</span><span class=n>xlabel</span><span class=p>(</span><span class=s1>&#39;Treatment Effect&#39;</span><span class=p>)</span>
        <span class=n>plt</span><span class=o>.</span><span class=n>ylabel</span><span class=p>(</span><span class=s1>&#39;Frequency&#39;</span><span class=p>)</span>
        <span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=s1>&#39;Bootstrap Distribution of Treatment Effect&#39;</span><span class=p>)</span>
        <span class=n>plt</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>
        <span class=c1># plt.savefig(&#39;bootstrap_dist.png&#39;)</span>

<span class=c1># Example 1: Mean (normal metric)</span>
<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
<span class=n>control</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mi>15</span><span class=p>,</span> <span class=mi>1000</span><span class=p>)</span>
<span class=n>treatment</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>105</span><span class=p>,</span> <span class=mi>15</span><span class=p>,</span> <span class=mi>1000</span><span class=p>)</span>

<span class=n>boot</span> <span class=o>=</span> <span class=n>BootstrapAB</span><span class=p>(</span><span class=n>n_bootstrap</span><span class=o>=</span><span class=mi>10000</span><span class=p>)</span>
<span class=n>point</span><span class=p>,</span> <span class=n>ci_l</span><span class=p>,</span> <span class=n>ci_u</span><span class=p>,</span> <span class=n>p_val</span> <span class=o>=</span> <span class=n>boot</span><span class=o>.</span><span class=n>bootstrap_ci</span><span class=p>(</span><span class=n>control</span><span class=p>,</span> <span class=n>treatment</span><span class=p>,</span> <span class=n>metric_fn</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;--- Bootstrap: Mean (CTR, Conversion) ---&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Point estimate: </span><span class=si>{</span><span class=n>point</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;95% CI: [</span><span class=si>{</span><span class=n>ci_l</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>ci_u</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>]&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;P-value: </span><span class=si>{</span><span class=n>p_val</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=n>boot</span><span class=o>.</span><span class=n>plot_distribution</span><span class=p>(</span><span class=n>point</span><span class=p>,</span> <span class=p>(</span><span class=n>ci_l</span><span class=p>,</span> <span class=n>ci_u</span><span class=p>))</span>

<span class=c1># Example 2: Median (robust to outliers)</span>
<span class=n>control_revenue</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>exponential</span><span class=p>(</span><span class=mi>50</span><span class=p>,</span> <span class=mi>950</span><span class=p>),</span> 
                                 <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>exponential</span><span class=p>(</span><span class=mi>500</span><span class=p>,</span> <span class=mi>50</span><span class=p>)])</span>  <span class=c1># heavy tail</span>
<span class=n>treatment_revenue</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>exponential</span><span class=p>(</span><span class=mi>55</span><span class=p>,</span> <span class=mi>950</span><span class=p>),</span> 
                                   <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>exponential</span><span class=p>(</span><span class=mi>550</span><span class=p>,</span> <span class=mi>50</span><span class=p>)])</span>

<span class=n>point_med</span><span class=p>,</span> <span class=n>ci_l_med</span><span class=p>,</span> <span class=n>ci_u_med</span><span class=p>,</span> <span class=n>p_val_med</span> <span class=o>=</span> <span class=n>boot</span><span class=o>.</span><span class=n>bootstrap_ci</span><span class=p>(</span>
    <span class=n>control_revenue</span><span class=p>,</span> <span class=n>treatment_revenue</span><span class=p>,</span> <span class=n>metric_fn</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>median</span>
<span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>--- Bootstrap: Median (Revenue, Skewed) ---&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Point estimate (median): </span><span class=si>{</span><span class=n>point_med</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;95% CI: [</span><span class=si>{</span><span class=n>ci_l_med</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>ci_u_med</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>]&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;P-value: </span><span class=si>{</span><span class=n>p_val_med</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Example 3: Ratio metric (CTR = clicks / impressions)</span>
<span class=k>def</span><span class=w> </span><span class=nf>ctr_metric</span><span class=p>(</span><span class=n>data</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Data: [(clicks, impressions), ...].&quot;&quot;&quot;</span>
    <span class=n>total_clicks</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>data</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>])</span>
    <span class=n>total_impr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>data</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>])</span>
    <span class=k>return</span> <span class=n>total_clicks</span> <span class=o>/</span> <span class=n>total_impr</span> <span class=k>if</span> <span class=n>total_impr</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>

<span class=n>control_ctr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>column_stack</span><span class=p>([</span>
    <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>poisson</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=mi>1000</span><span class=p>),</span>  <span class=c1># clicks</span>
    <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>poisson</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mi>1000</span><span class=p>)</span>  <span class=c1># impressions</span>
<span class=p>])</span>
<span class=n>treatment_ctr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>column_stack</span><span class=p>([</span>
    <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>poisson</span><span class=p>(</span><span class=mi>6</span><span class=p>,</span> <span class=mi>1000</span><span class=p>),</span>
    <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>poisson</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mi>1000</span><span class=p>)</span>
<span class=p>])</span>

<span class=n>point_ctr</span><span class=p>,</span> <span class=n>ci_l_ctr</span><span class=p>,</span> <span class=n>ci_u_ctr</span><span class=p>,</span> <span class=n>p_val_ctr</span> <span class=o>=</span> <span class=n>boot</span><span class=o>.</span><span class=n>bootstrap_ci</span><span class=p>(</span>
    <span class=n>control_ctr</span><span class=p>,</span> <span class=n>treatment_ctr</span><span class=p>,</span> <span class=n>metric_fn</span><span class=o>=</span><span class=n>ctr_metric</span>
<span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>--- Bootstrap: Ratio Metric (CTR) ---&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Point estimate (CTR): </span><span class=si>{</span><span class=n>point_ctr</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;95% CI: [</span><span class=si>{</span><span class=n>ci_l_ctr</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>ci_u_ctr</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>]&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;P-value: </span><span class=si>{</span><span class=n>p_val_ctr</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Example 4: Quantiles (P90 latency)</span>
<span class=n>control_latency</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>gamma</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>50</span><span class=p>,</span> <span class=mi>1000</span><span class=p>)</span>
<span class=n>treatment_latency</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>gamma</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>48</span><span class=p>,</span> <span class=mi>1000</span><span class=p>)</span>  <span class=c1># 4% faster</span>

<span class=n>p90_fn</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=mi>90</span><span class=p>)</span>
<span class=n>point_p90</span><span class=p>,</span> <span class=n>ci_l_p90</span><span class=p>,</span> <span class=n>ci_u_p90</span><span class=p>,</span> <span class=n>p_val_p90</span> <span class=o>=</span> <span class=n>boot</span><span class=o>.</span><span class=n>bootstrap_ci</span><span class=p>(</span>
    <span class=n>control_latency</span><span class=p>,</span> <span class=n>treatment_latency</span><span class=p>,</span> <span class=n>metric_fn</span><span class=o>=</span><span class=n>p90_fn</span>
<span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>--- Bootstrap: P90 Latency ---&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Point estimate (P90): </span><span class=si>{</span><span class=n>point_p90</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> ms&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;95% CI: [</span><span class=si>{</span><span class=n>ci_l_p90</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>ci_u_p90</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>]&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;P-value: </span><span class=si>{</span><span class=n>p_val_p90</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Comparison: Bootstrap vs Parametric (t-test)</span>
<span class=n>t_stat</span><span class=p>,</span> <span class=n>t_pval</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span><span class=n>treatment</span><span class=p>,</span> <span class=n>control</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>--- Parametric T-Test (for comparison) ---&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;T-test p-value: </span><span class=si>{</span><span class=n>t_pval</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2> (assumes normality)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Bootstrap p-value: </span><span class=si>{</span><span class=n>p_val</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2> (distribution-free)&quot;</span><span class=p>)</span>
</code></pre></div> <table> <thead> <tr> <th>Metric Type</th> <th>Parametric Method</th> <th>Bootstrap Advantage</th> </tr> </thead> <tbody> <tr> <td><strong>Mean (normal)</strong></td> <td>T-test, Z-test</td> <td>Works even if not normal</td> </tr> <tr> <td><strong>Median</strong></td> <td>Wilcoxon (assumptions)</td> <td>Exact CI, no rank assumptions</td> </tr> <tr> <td><strong>Ratio (CTR)</strong></td> <td>Delta method (complex)</td> <td>Direct resampling, simpler</td> </tr> <tr> <td><strong>Quantiles (P90)</strong></td> <td>None (no closed form)</td> <td>Bootstrap is only practical option</td> </tr> </tbody> </table> <table> <thead> <tr> <th>Bootstrap Iterations</th> <th>CI Stability</th> <th>Runtime</th> <th>When to Use</th> </tr> </thead> <tbody> <tr> <td>1,000</td> <td>Low</td> <td>&lt;1s</td> <td>Quick sanity check</td> </tr> <tr> <td>10,000</td> <td>High</td> <td>~5s</td> <td><strong>Production standard</strong></td> </tr> <tr> <td>100,000</td> <td>Very high</td> <td>~50s</td> <td>Final validation, publication</td> </tr> </tbody> </table> <p><strong>Real-World:</strong> - <strong>Google Ads:</strong> Bootstrap for <strong>CTR</strong> (ratio metric) with 10k iterations; avoids delta method complexity, ~2s compute. - <strong>Netflix:</strong> <strong>P90 streaming latency</strong> (no parametric test exists); bootstrap detects +15ms with 95% CI [10, 20ms]. - <strong>Stripe:</strong> <strong>Revenue median</strong> (heavy-tailed); bootstrap shows +<span class=arithmatex>\(2.50 lift [+\)</span>1.80, +$3.20], p&lt;0.01.</p> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <ul> <li>Knows <strong>bootstrap for non-normal metrics</strong> (revenue, ratios, quantiles)</li> <li>Uses <strong>10k iterations as standard</strong> (balance speed/accuracy)</li> <li>Real-world: <strong>Netflix bootstraps P90 latency; Google uses for CTR over delta method</strong></li> </ul> </div> </details> <hr> <h3 id=how-to-test-revenue-metrics-e-commerce-interview-question>How to Test Revenue Metrics? - E-commerce Interview Question</h3> <p><strong>Difficulty:</strong> üî¥ Hard | <strong>Tags:</strong> <code>Revenue</code> | <strong>Asked by:</strong> Amazon, Shopify, Stripe</p> <details class=success> <summary>View Answer</summary> <p><strong>Revenue metrics</strong> have <strong>heavy-tailed distributions</strong> (most users spend $0, few spend thousands) and <strong>outliers</strong> that inflate variance, making <strong>standard t-tests unreliable</strong>. <strong>Winsorization</strong>, <strong>log transforms</strong>, <strong>trimmed means</strong>, and <strong>robust statistics</strong> ensure valid inference without discarding data.</p> <div class=highlight><pre><span></span><code>            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ  Revenue Distribution (Skewed)  ‚îÇ
            ‚îÇ  90% users: $0                  ‚îÇ
            ‚îÇ   8% users: $1-50               ‚îÇ
            ‚îÇ   2% users: $50-10,000 (whales)‚îÇ
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚Üì
     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
     ‚Üì                                           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Naive Mean Test    ‚îÇ              ‚îÇ  Robust Methods     ‚îÇ
‚îÇ  - High variance    ‚îÇ              ‚îÇ  - Winsorization    ‚îÇ
‚îÇ  - Outlier-driven   ‚îÇ              ‚îÇ  - Trimmed mean     ‚îÇ
‚îÇ  - Low power        ‚îÇ              ‚îÇ  - Log transform    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy.stats</span><span class=w> </span><span class=kn>import</span> <span class=n>trim_mean</span>
<span class=kn>import</span><span class=w> </span><span class=nn>matplotlib.pyplot</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>plt</span>

<span class=c1># Production: Revenue Metric Testing with Robust Methods</span>

<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
<span class=n>n</span> <span class=o>=</span> <span class=mi>5000</span>

<span class=c1># Generate realistic e-commerce revenue: heavy-tailed</span>
<span class=k>def</span><span class=w> </span><span class=nf>generate_revenue</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>conversion_rate</span><span class=o>=</span><span class=mf>0.10</span><span class=p>,</span> <span class=n>mean_spend</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span> <span class=n>whale_prob</span><span class=o>=</span><span class=mf>0.02</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;90% $0, 8% normal spenders, 2% whales.&quot;&quot;&quot;</span>
    <span class=n>revenue</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>
    <span class=n>purchasers</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>rand</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>conversion_rate</span>
    <span class=n>revenue</span><span class=p>[</span><span class=n>purchasers</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>lognormal</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>mean_spend</span><span class=p>),</span> <span class=mf>1.5</span><span class=p>,</span> <span class=n>purchasers</span><span class=o>.</span><span class=n>sum</span><span class=p>())</span>

    <span class=c1># Add whales (very high spenders)</span>
    <span class=n>whales</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>rand</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>whale_prob</span>
    <span class=n>revenue</span><span class=p>[</span><span class=n>whales</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>lognormal</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=mi>500</span><span class=p>),</span> <span class=mf>1.0</span><span class=p>,</span> <span class=n>whales</span><span class=o>.</span><span class=n>sum</span><span class=p>())</span>
    <span class=k>return</span> <span class=n>revenue</span>

<span class=n>control</span> <span class=o>=</span> <span class=n>generate_revenue</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>conversion_rate</span><span class=o>=</span><span class=mf>0.10</span><span class=p>,</span> <span class=n>mean_spend</span><span class=o>=</span><span class=mi>50</span><span class=p>)</span>
<span class=n>treatment</span> <span class=o>=</span> <span class=n>generate_revenue</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>conversion_rate</span><span class=o>=</span><span class=mf>0.11</span><span class=p>,</span> <span class=n>mean_spend</span><span class=o>=</span><span class=mi>52</span><span class=p>)</span>  <span class=c1># +10% CVR, +4% AOV</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Revenue A/B Test: Handling Heavy Tails &amp; Outliers&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>

<span class=c1># 1. Naive t-test (WRONG for revenue)</span>
<span class=n>t_stat</span><span class=p>,</span> <span class=n>p_naive</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span><span class=n>treatment</span><span class=p>,</span> <span class=n>control</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>[1] Naive T-Test (assumes normality)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    Control mean: $</span><span class=si>{</span><span class=n>control</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    Treatment mean: $</span><span class=si>{</span><span class=n>treatment</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    Lift: $</span><span class=si>{</span><span class=n>treatment</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>control</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    P-value: </span><span class=si>{</span><span class=n>p_naive</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    ‚ö†Ô∏è  High variance due to outliers!&quot;</span><span class=p>)</span>

<span class=c1># 2. Winsorization (cap at 99th percentile)</span>
<span class=n>p99</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>([</span><span class=n>control</span><span class=p>,</span> <span class=n>treatment</span><span class=p>]),</span> <span class=mi>99</span><span class=p>)</span>
<span class=n>control_wins</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>clip</span><span class=p>(</span><span class=n>control</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>p99</span><span class=p>)</span>
<span class=n>treatment_wins</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>clip</span><span class=p>(</span><span class=n>treatment</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>p99</span><span class=p>)</span>

<span class=n>t_stat_wins</span><span class=p>,</span> <span class=n>p_wins</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span><span class=n>treatment_wins</span><span class=p>,</span> <span class=n>control_wins</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>[2] Winsorized (cap at P99 = $</span><span class=si>{</span><span class=n>p99</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    Control mean: $</span><span class=si>{</span><span class=n>control_wins</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    Treatment mean: $</span><span class=si>{</span><span class=n>treatment_wins</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    Lift: $</span><span class=si>{</span><span class=n>treatment_wins</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>control_wins</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    P-value: </span><span class=si>{</span><span class=n>p_wins</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    ‚úÖ Reduced variance, more power&quot;</span><span class=p>)</span>

<span class=c1># 3. Log transformation (for multiplicative effects)</span>
<span class=n>control_pos</span> <span class=o>=</span> <span class=n>control</span><span class=p>[</span><span class=n>control</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>]</span>
<span class=n>treatment_pos</span> <span class=o>=</span> <span class=n>treatment</span><span class=p>[</span><span class=n>treatment</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>]</span>

<span class=n>log_control</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>control_pos</span><span class=p>)</span>
<span class=n>log_treatment</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>treatment_pos</span><span class=p>)</span>

<span class=n>t_stat_log</span><span class=p>,</span> <span class=n>p_log</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span><span class=n>log_treatment</span><span class=p>,</span> <span class=n>log_control</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>[3] Log-Transformed (purchasers only, n=</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>control_pos</span><span class=p>)</span><span class=si>}</span><span class=s2> vs </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>treatment_pos</span><span class=p>)</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    Control log-mean: </span><span class=si>{</span><span class=n>log_control</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    Treatment log-mean: </span><span class=si>{</span><span class=n>log_treatment</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    Multiplicative lift: </span><span class=si>{</span><span class=n>np</span><span class=o>.</span><span class=n>exp</span><span class=p>(</span><span class=n>log_treatment</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>log_control</span><span class=o>.</span><span class=n>mean</span><span class=p>())</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>x&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    P-value: </span><span class=si>{</span><span class=n>p_log</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    ‚úÖ Handles skewness well&quot;</span><span class=p>)</span>

<span class=c1># 4. Trimmed mean (remove top/bottom 5%)</span>
<span class=n>control_trim</span> <span class=o>=</span> <span class=n>trim_mean</span><span class=p>(</span><span class=n>control</span><span class=p>,</span> <span class=n>proportiontocut</span><span class=o>=</span><span class=mf>0.05</span><span class=p>)</span>
<span class=n>treatment_trim</span> <span class=o>=</span> <span class=n>trim_mean</span><span class=p>(</span><span class=n>treatment</span><span class=p>,</span> <span class=n>proportiontocut</span><span class=o>=</span><span class=mf>0.05</span><span class=p>)</span>

<span class=c1># Bootstrap for trimmed mean CI</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy.stats</span><span class=w> </span><span class=kn>import</span> <span class=n>bootstrap</span>
<span class=k>def</span><span class=w> </span><span class=nf>trimmed_mean_fn</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
    <span class=k>return</span> <span class=n>trim_mean</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>proportiontocut</span><span class=o>=</span><span class=mf>0.05</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>[4] Trimmed Mean (remove top/bottom 5%)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    Control trimmed mean: $</span><span class=si>{</span><span class=n>control_trim</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    Treatment trimmed mean: $</span><span class=si>{</span><span class=n>treatment_trim</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    Lift: $</span><span class=si>{</span><span class=n>treatment_trim</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>control_trim</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    ‚úÖ Robust to extreme outliers&quot;</span><span class=p>)</span>

<span class=c1># 5. Mann-Whitney U (non-parametric, rank-based)</span>
<span class=n>u_stat</span><span class=p>,</span> <span class=n>p_mann</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>mannwhitneyu</span><span class=p>(</span><span class=n>treatment</span><span class=p>,</span> <span class=n>control</span><span class=p>,</span> <span class=n>alternative</span><span class=o>=</span><span class=s1>&#39;two-sided&#39;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>[5] Mann-Whitney U Test (non-parametric)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    U-statistic: </span><span class=si>{</span><span class=n>u_stat</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    P-value: </span><span class=si>{</span><span class=n>p_mann</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    ‚úÖ No distribution assumptions&quot;</span><span class=p>)</span>

<span class=c1># 6. Quantile Regression (median, IQR)</span>
<span class=n>control_median</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>median</span><span class=p>(</span><span class=n>control</span><span class=p>)</span>
<span class=n>treatment_median</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>median</span><span class=p>(</span><span class=n>treatment</span><span class=p>)</span>
<span class=n>control_iqr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>control</span><span class=p>,</span> <span class=mi>75</span><span class=p>)</span> <span class=o>-</span> <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>control</span><span class=p>,</span> <span class=mi>25</span><span class=p>)</span>
<span class=n>treatment_iqr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>treatment</span><span class=p>,</span> <span class=mi>75</span><span class=p>)</span> <span class=o>-</span> <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>treatment</span><span class=p>,</span> <span class=mi>25</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>[6] Quantile-Based (Median, IQR)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    Control median: $</span><span class=si>{</span><span class=n>control_median</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>, IQR: $</span><span class=si>{</span><span class=n>control_iqr</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    Treatment median: $</span><span class=si>{</span><span class=n>treatment_median</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>, IQR: $</span><span class=si>{</span><span class=n>treatment_iqr</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    Median lift: $</span><span class=si>{</span><span class=n>treatment_median</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>control_median</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    ‚úÖ Robust summary statistics&quot;</span><span class=p>)</span>

<span class=c1># 7. Visualization: Distribution comparison</span>
<span class=n>fig</span><span class=p>,</span> <span class=n>axes</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>15</span><span class=p>,</span> <span class=mi>5</span><span class=p>))</span>

<span class=c1># Raw distribution</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>hist</span><span class=p>(</span><span class=n>control</span><span class=p>,</span> <span class=n>bins</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;Control&#39;</span><span class=p>,</span> <span class=n>log</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>hist</span><span class=p>(</span><span class=n>treatment</span><span class=p>,</span> <span class=n>bins</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;Treatment&#39;</span><span class=p>,</span> <span class=n>log</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>set_xlabel</span><span class=p>(</span><span class=s1>&#39;Revenue ($)&#39;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;Count (log scale)&#39;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;Raw Revenue Distribution&#39;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>

<span class=c1># Winsorized</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>hist</span><span class=p>(</span><span class=n>control_wins</span><span class=p>,</span> <span class=n>bins</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;Control (wins)&#39;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>hist</span><span class=p>(</span><span class=n>treatment_wins</span><span class=p>,</span> <span class=n>bins</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;Treatment (wins)&#39;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>set_xlabel</span><span class=p>(</span><span class=s1>&#39;Revenue ($, capped at P99)&#39;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;Winsorized Distribution&#39;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>

<span class=c1># Log-transformed (purchasers)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>.</span><span class=n>hist</span><span class=p>(</span><span class=n>log_control</span><span class=p>,</span> <span class=n>bins</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;Control (log)&#39;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>.</span><span class=n>hist</span><span class=p>(</span><span class=n>log_treatment</span><span class=p>,</span> <span class=n>bins</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;Treatment (log)&#39;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>.</span><span class=n>set_xlabel</span><span class=p>(</span><span class=s1>&#39;Log(Revenue)&#39;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;Log-Transformed (Purchasers)&#39;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>

<span class=n>plt</span><span class=o>.</span><span class=n>tight_layout</span><span class=p>()</span>
<span class=c1># plt.savefig(&#39;revenue_testing.png&#39;)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Distribution plots generated.&quot;</span><span class=p>)</span>
</code></pre></div> <p>| Method | Handles Outliers | Power | Interpretation | When to Use | |-----------------------|------------------|--------|---------------------------|------------------------------------|| | <strong>Naive t-test</strong> | ‚ùå No | Low | Mean difference | ‚ùå Not for revenue | | <strong>Winsorization</strong> | ‚úÖ Yes (cap) | High | Mean (bounded) | Standard choice for revenue | | <strong>Log transform</strong> | ‚úÖ Yes | High | Multiplicative effect | AOV, per-user revenue | | <strong>Trimmed mean</strong> | ‚úÖ Yes (cut) | Medium | Mean (robust) | Extreme outliers | | <strong>Mann-Whitney U</strong> | ‚úÖ Yes | Medium | Rank-based | No assumptions, any distribution | | <strong>Quantile (median)</strong> | ‚úÖ Yes | Medium | Median difference | Heavy tails, mixed distributions |</p> <p>| Revenue Metric | Distribution | Best Method | Company Example | |-----------------------|-------------------|--------------------------|------------------------------------|| | <strong>Total revenue/user</strong>| Heavy-tailed | Winsorize at P99 | Amazon: Cap at <span class=arithmatex>\(5k, detect +2.3% | | **AOV (purchasers)** | Log-normal | Log transform | Shopify: Log-AOV, 1.05√ó lift | | **LTV** | Highly skewed | Trimmed mean (10%) | Stripe: Trim whales, +\)</span>4.50 lift | | <strong>Conversion rate</strong> | Binomial | Z-test proportions | All: Standard binomial test |</p> <p><strong>Real-World:</strong> - <strong>Amazon:</strong> Winsorizes revenue at <strong>P99 ($5,000)</strong> to detect +2.3% lift in Prime experiments; naive test showed p=0.15, winsorized p=0.003. - <strong>Shopify:</strong> Uses <strong>log(AOV)</strong> for cart upsell tests; detects 1.05√ó multiplicative lift (5% increase) with 80% power. - <strong>Stripe:</strong> <strong>Trimmed mean (10%)</strong> for payment experiments removes top/bottom 5% whales; reduces variance by 40%, increases power by 25%.</p> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <ul> <li>Knows <strong>winsorization at P99 as standard</strong> for total revenue/user</li> <li>Uses <strong>log transform for AOV</strong> (multiplicative effects)</li> <li>Real-world: <strong>Amazon caps at $5k; Shopify uses log-AOV for 5%+ detection</strong></li> </ul> </div> </details> <hr> <h3 id=what-is-regression-to-the-mean-all-companies-interview-question>What is Regression to the Mean? - All Companies Interview Question</h3> <p><strong>Difficulty:</strong> üü° Medium | <strong>Tags:</strong> <code>Statistics</code> | <strong>Asked by:</strong> All Companies</p> <details class=success> <summary>View Answer</summary> <p><strong>Regression to the mean (RTM)</strong> causes <strong>extreme observations</strong> to move toward the <strong>average</strong> on repeated measurement‚Äî<strong>not due to treatment</strong>, but due to <strong>random variation</strong>. In A/B tests, selecting <strong>worst-performing</strong> cohorts for "improvement" falsely attributes natural RTM to the intervention.</p> <div class=highlight><pre><span></span><code>            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ  Week 1: Measure Performance    ‚îÇ
            ‚îÇ  Users ranked by engagement     ‚îÇ
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚Üì
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ  Select WORST 10% for treatment ‚îÇ
            ‚îÇ  (low engagement = noise?)      ‚îÇ
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚Üì
     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
     ‚Üì                                           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Treatment Group    ‚îÇ              ‚îÇ  Control (random)   ‚îÇ
‚îÇ  Week 2: +15%       ‚îÇ              ‚îÇ  Week 2: +12%       ‚îÇ
‚îÇ  (RTM + treatment?) ‚îÇ              ‚îÇ  (RTM only)         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚Üì
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ  True lift: 15% - 12% = 3%      ‚îÇ
            ‚îÇ  Without control: falsely claim ‚îÇ
            ‚îÇ  15% lift (RTM confounded)      ‚îÇ
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>import</span><span class=w> </span><span class=nn>matplotlib.pyplot</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>plt</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>

<span class=c1># Production: Demonstrate Regression to the Mean</span>

<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
<span class=n>n_users</span> <span class=o>=</span> <span class=mi>10000</span>

<span class=c1># Simulate user engagement: true skill + noise</span>
<span class=n>true_engagement</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mi>15</span><span class=p>,</span> <span class=n>n_users</span><span class=p>)</span>  <span class=c1># true underlying engagement</span>

<span class=c1># Week 1 observation: true + noise</span>
<span class=n>week1_obs</span> <span class=o>=</span> <span class=n>true_engagement</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>30</span><span class=p>,</span> <span class=n>n_users</span><span class=p>)</span>  <span class=c1># high noise</span>

<span class=c1># Week 2 observation: true + new noise (no treatment)</span>
<span class=n>week2_obs</span> <span class=o>=</span> <span class=n>true_engagement</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>30</span><span class=p>,</span> <span class=n>n_users</span><span class=p>)</span>

<span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
    <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_users</span><span class=p>),</span>
    <span class=s1>&#39;true_engagement&#39;</span><span class=p>:</span> <span class=n>true_engagement</span><span class=p>,</span>
    <span class=s1>&#39;week1&#39;</span><span class=p>:</span> <span class=n>week1_obs</span><span class=p>,</span>
    <span class=s1>&#39;week2&#39;</span><span class=p>:</span> <span class=n>week2_obs</span>
<span class=p>})</span>

<span class=c1># WRONG APPROACH: Select worst 10% from week 1, measure week 2</span>
<span class=n>worst_10pct</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>nsmallest</span><span class=p>(</span><span class=mi>1000</span><span class=p>,</span> <span class=s1>&#39;week1&#39;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Regression to the Mean: Before/After vs Randomized Control&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>[WRONG] Before/After Analysis (No Control)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Week 1 (worst 10%): </span><span class=si>{</span><span class=n>worst_10pct</span><span class=p>[</span><span class=s1>&#39;week1&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Week 2 (same users): </span><span class=si>{</span><span class=n>worst_10pct</span><span class=p>[</span><span class=s1>&#39;week2&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Apparent lift: </span><span class=si>{</span><span class=n>worst_10pct</span><span class=p>[</span><span class=s1>&#39;week2&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>worst_10pct</span><span class=p>[</span><span class=s1>&#39;week1&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> (+</span><span class=si>{</span><span class=mi>100</span><span class=o>*</span><span class=p>(</span><span class=n>worst_10pct</span><span class=p>[</span><span class=s1>&#39;week2&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=o>/</span><span class=n>worst_10pct</span><span class=p>[</span><span class=s1>&#39;week1&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  ‚ùå FALSE! This is RTM, not real improvement.&quot;</span><span class=p>)</span>

<span class=c1># CORRECT APPROACH: Randomized control</span>
<span class=c1># Simulate treatment effect: +5 points</span>
<span class=n>treatment_effect</span> <span class=o>=</span> <span class=mi>5</span>

<span class=c1># Select worst 20% from week 1, then randomize</span>
<span class=n>worst_20pct</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>nsmallest</span><span class=p>(</span><span class=mi>2000</span><span class=p>,</span> <span class=s1>&#39;week1&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
<span class=n>worst_20pct</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>([</span><span class=s1>&#39;control&#39;</span><span class=p>,</span> <span class=s1>&#39;treatment&#39;</span><span class=p>],</span> <span class=n>size</span><span class=o>=</span><span class=mi>2000</span><span class=p>)</span>

<span class=c1># Week 2: control gets RTM only, treatment gets RTM + effect</span>
<span class=n>worst_20pct</span><span class=p>[</span><span class=s1>&#39;week2_control&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>worst_20pct</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span>
    <span class=k>lambda</span> <span class=n>row</span><span class=p>:</span> <span class=n>true_engagement</span><span class=p>[</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;user_id&#39;</span><span class=p>]]</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>30</span><span class=p>)</span> 
               <span class=k>if</span> <span class=n>row</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;control&#39;</span> <span class=k>else</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span>
<span class=p>)</span>
<span class=n>worst_20pct</span><span class=p>[</span><span class=s1>&#39;week2_treatment&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>worst_20pct</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span>
    <span class=k>lambda</span> <span class=n>row</span><span class=p>:</span> <span class=n>true_engagement</span><span class=p>[</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;user_id&#39;</span><span class=p>]]</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>30</span><span class=p>)</span> <span class=o>+</span> <span class=n>treatment_effect</span>
               <span class=k>if</span> <span class=n>row</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span> <span class=k>else</span> <span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span>
<span class=p>)</span>

<span class=n>control_w1</span> <span class=o>=</span> <span class=n>worst_20pct</span><span class=p>[</span><span class=n>worst_20pct</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;control&#39;</span><span class=p>][</span><span class=s1>&#39;week1&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
<span class=n>control_w2</span> <span class=o>=</span> <span class=n>worst_20pct</span><span class=p>[</span><span class=n>worst_20pct</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;control&#39;</span><span class=p>][</span><span class=s1>&#39;week2_control&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
<span class=n>treatment_w1</span> <span class=o>=</span> <span class=n>worst_20pct</span><span class=p>[</span><span class=n>worst_20pct</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>][</span><span class=s1>&#39;week1&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
<span class=n>treatment_w2</span> <span class=o>=</span> <span class=n>worst_20pct</span><span class=p>[</span><span class=n>worst_20pct</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>][</span><span class=s1>&#39;week2_treatment&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>[CORRECT] Randomized Controlled Experiment&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Control Week 1: </span><span class=si>{</span><span class=n>control_w1</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Control Week 2: </span><span class=si>{</span><span class=n>control_w2</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> (RTM: +</span><span class=si>{</span><span class=n>control_w2</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>control_w1</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Treatment Week 1: </span><span class=si>{</span><span class=n>treatment_w1</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Treatment Week 2: </span><span class=si>{</span><span class=n>treatment_w2</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> (RTM + effect: +</span><span class=si>{</span><span class=n>treatment_w2</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>treatment_w1</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  ‚úÖ True treatment effect: </span><span class=si>{</span><span class=n>treatment_w2</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>treatment_w1</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=p>(</span><span class=n>control_w2</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>control_w1</span><span class=p>)</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Statistical test</span>
<span class=n>control_deltas</span> <span class=o>=</span> <span class=n>worst_20pct</span><span class=p>[</span><span class=n>worst_20pct</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;control&#39;</span><span class=p>][</span><span class=s1>&#39;week2_control&#39;</span><span class=p>]</span> <span class=o>-</span> \
                 <span class=n>worst_20pct</span><span class=p>[</span><span class=n>worst_20pct</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;control&#39;</span><span class=p>][</span><span class=s1>&#39;week1&#39;</span><span class=p>]</span>
<span class=n>treatment_deltas</span> <span class=o>=</span> <span class=n>worst_20pct</span><span class=p>[</span><span class=n>worst_20pct</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>][</span><span class=s1>&#39;week2_treatment&#39;</span><span class=p>]</span> <span class=o>-</span> \
                   <span class=n>worst_20pct</span><span class=p>[</span><span class=n>worst_20pct</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>][</span><span class=s1>&#39;week1&#39;</span><span class=p>]</span>

<span class=n>t_stat</span><span class=p>,</span> <span class=n>p_val</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span><span class=n>treatment_deltas</span><span class=o>.</span><span class=n>dropna</span><span class=p>(),</span> <span class=n>control_deltas</span><span class=o>.</span><span class=n>dropna</span><span class=p>())</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  P-value (difference in deltas): </span><span class=si>{</span><span class=n>p_val</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Visualization</span>
<span class=n>fig</span><span class=p>,</span> <span class=n>axes</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>14</span><span class=p>,</span> <span class=mi>5</span><span class=p>))</span>

<span class=c1># Scatter: Week 1 vs Week 2 (all users)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;week1&#39;</span><span class=p>],</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;week2&#39;</span><span class=p>],</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>plot</span><span class=p>([</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;week1&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>min</span><span class=p>(),</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;week1&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>max</span><span class=p>()],</span> 
             <span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;week1&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>min</span><span class=p>(),</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;week1&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>max</span><span class=p>()],</span> 
             <span class=s1>&#39;r--&#39;</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;No change line&#39;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>axhline</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;week2&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>(),</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;blue&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;:&#39;</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;Week 2 mean&#39;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>set_xlabel</span><span class=p>(</span><span class=s1>&#39;Week 1 Engagement&#39;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;Week 2 Engagement&#39;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;Regression to the Mean (All Users)&#39;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>annotate</span><span class=p>(</span><span class=s1>&#39;Extreme low values</span><span class=se>\n</span><span class=s1>move up (RTM)&#39;</span><span class=p>,</span> <span class=n>xy</span><span class=o>=</span><span class=p>(</span><span class=mi>40</span><span class=p>,</span> <span class=mi>90</span><span class=p>),</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>)</span>

<span class=c1># Bar chart: Before/After vs Controlled</span>
<span class=n>x</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Before/After</span><span class=se>\n</span><span class=s1>(worst 10%)&#39;</span><span class=p>,</span> <span class=s1>&#39;Controlled</span><span class=se>\n</span><span class=s1>(treatment)&#39;</span><span class=p>,</span> <span class=s1>&#39;Controlled</span><span class=se>\n</span><span class=s1>(control)&#39;</span><span class=p>]</span>
<span class=n>y</span> <span class=o>=</span> <span class=p>[</span>
    <span class=n>worst_10pct</span><span class=p>[</span><span class=s1>&#39;week2&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>-</span> <span class=n>worst_10pct</span><span class=p>[</span><span class=s1>&#39;week1&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>(),</span>
    <span class=n>treatment_w2</span> <span class=o>-</span> <span class=n>treatment_w1</span><span class=p>,</span>
    <span class=n>control_w2</span> <span class=o>-</span> <span class=n>control_w1</span>
<span class=p>]</span>
<span class=n>colors</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;red&#39;</span><span class=p>,</span> <span class=s1>&#39;green&#39;</span><span class=p>,</span> <span class=s1>&#39;blue&#39;</span><span class=p>]</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>bar</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=n>colors</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>axhline</span><span class=p>(</span><span class=n>treatment_effect</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;green&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;--&#39;</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;True effect (+5)&#39;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;Observed Change (Week 2 - Week 1)&#39;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;RTM Confounds Before/After&#39;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>annotate</span><span class=p>(</span><span class=s1>&#39;RTM inflates</span><span class=se>\n</span><span class=s1>apparent effect&#39;</span><span class=p>,</span> <span class=n>xy</span><span class=o>=</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>y</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>+</span><span class=mi>2</span><span class=p>),</span> <span class=n>ha</span><span class=o>=</span><span class=s1>&#39;center&#39;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>)</span>

<span class=n>plt</span><span class=o>.</span><span class=n>tight_layout</span><span class=p>()</span>
<span class=c1># plt.savefig(&#39;regression_to_mean.png&#39;)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>RTM visualization generated.&quot;</span><span class=p>)</span>
</code></pre></div> <table> <thead> <tr> <th>Scenario</th> <th>Observation</th> <th>Cause</th> <th>Prevention</th> </tr> </thead> <tbody> <tr> <td><strong>Select worst performers</strong></td> <td>+15% next period (no treatment)</td> <td>RTM (noise ‚Üí average)</td> <td>Randomize AFTER selection</td> </tr> <tr> <td><strong>Select best performers</strong></td> <td>-10% next period (no treatment)</td> <td>RTM (noise ‚Üí average)</td> <td>Randomize AFTER selection</td> </tr> <tr> <td><strong>Random cohort</strong></td> <td>~0% change (no treatment)</td> <td>No RTM (already representative)</td> <td>Standard A/B test</td> </tr> </tbody> </table> <table> <thead> <tr> <th>Before/After Analysis</th> <th>Randomized Controlled Test</th> <th>Key Difference</th> </tr> </thead> <tbody> <tr> <td>Selects extreme cohort</td> <td>Randomizes AFTER selection</td> <td>Control isolates RTM</td> </tr> <tr> <td>No control group</td> <td>Control + treatment groups</td> <td>Diff-in-diff removes RTM</td> </tr> <tr> <td>Confounds RTM + effect</td> <td>Separates RTM from effect</td> <td>‚úÖ Valid causal inference</td> </tr> </tbody> </table> <p><strong>Real-World:</strong> - <strong>LinkedIn:</strong> Ran "re-engagement campaign" on <strong>dormant users</strong> (bottom 5% activity); saw +20% lift but control showed +18% (RTM). <strong>True lift: 2%</strong>. - <strong>Duolingo:</strong> Targeted <strong>struggling learners</strong> (lowest streak); before/after claimed +30% retention, but randomized control revealed +5% true effect (RTM = +25%). - <strong>Uber:</strong> Selected <strong>low-rated drivers</strong> for training; control group improved +12% (RTM), treatment +15% (RTM + training = <strong>+3% real effect</strong>).</p> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <ul> <li>Knows <strong>RTM affects extreme cohorts</strong> (worst/best performers)</li> <li>Always uses <strong>randomized control AFTER selection</strong> to isolate true effect</li> <li>Real-world: <strong>LinkedIn detected +18% RTM in dormant user campaign; true lift only +2%</strong></li> </ul> </div> </details> <hr> <h3 id=how-to-handle-multiple-metrics-netflix-airbnb-interview-question>How to Handle Multiple Metrics? - Netflix, Airbnb Interview Question</h3> <p><strong>Difficulty:</strong> üü° Medium | <strong>Tags:</strong> <code>Metrics</code>, <code>Decision Framework</code> | <strong>Asked by:</strong> Netflix, Airbnb, Uber</p> <details class=success> <summary>View Answer</summary> <p><strong>Multiple metrics in A/B tests require a clear hierarchical decision framework</strong>: <strong>Primary metrics</strong> drive the ship/no-ship decision, <strong>secondary metrics</strong> provide interpretability, and <strong>guardrail metrics</strong> act as safety checks. Without a framework, conflicting signals (e.g., revenue up but engagement down) lead to analysis paralysis.</p> <div class=highlight><pre><span></span><code>                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ  Experiment Results Ready    ‚îÇ
                    ‚îÇ  100+ metrics computed       ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚Üì
                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                ‚îÇ  STEP 1: Check Guardrails        ‚îÇ
                ‚îÇ  - Latency &lt; 200ms?              ‚îÇ
                ‚îÇ  - Error rate &lt; 0.1%?            ‚îÇ
                ‚îÇ  - DAU not decreased?            ‚îÇ
                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚Üì
                   YES ‚îÄ‚îÄ‚îÄ‚îÄ‚î§‚îÄ‚îÄ‚îÄ‚îÄ NO
                           ‚Üì       ‚Üì
                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                ‚îÇ STEP 2:      ‚îÇ  ‚îÇ REJECT         ‚îÇ
                ‚îÇ Primary      ‚îÇ  ‚îÇ Any guardrail  ‚îÇ
                ‚îÇ Metric?      ‚îÇ  ‚îÇ failure = stop ‚îÇ
                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚Üì                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Primary WINS    ‚îÇ         ‚îÇ Primary NEUTRAL ‚îÇ
‚îÇ (p&lt;0.05, +lift) ‚îÇ         ‚îÇ or LOSES        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üì                            ‚Üì
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ SHIP         ‚îÇ         ‚îÇ Check Secondary  ‚îÇ
  ‚îÇ Launch now   ‚îÇ         ‚îÇ Positive? ‚Üí Maybe‚îÇ
  ‚îÇ              ‚îÇ         ‚îÇ Negative? ‚Üí Stop ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>from</span><span class=w> </span><span class=nn>dataclasses</span><span class=w> </span><span class=kn>import</span> <span class=n>dataclass</span>
<span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Tuple</span>
<span class=kn>from</span><span class=w> </span><span class=nn>enum</span><span class=w> </span><span class=kn>import</span> <span class=n>Enum</span>

<span class=k>class</span><span class=w> </span><span class=nc>MetricType</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
    <span class=n>PRIMARY</span> <span class=o>=</span> <span class=s2>&quot;primary&quot;</span>
    <span class=n>SECONDARY</span> <span class=o>=</span> <span class=s2>&quot;secondary&quot;</span>
    <span class=n>GUARDRAIL</span> <span class=o>=</span> <span class=s2>&quot;guardrail&quot;</span>

<span class=k>class</span><span class=w> </span><span class=nc>Decision</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
    <span class=n>SHIP</span> <span class=o>=</span> <span class=s2>&quot;ship&quot;</span>
    <span class=n>NO_SHIP</span> <span class=o>=</span> <span class=s2>&quot;no_ship&quot;</span>
    <span class=n>ITERATE</span> <span class=o>=</span> <span class=s2>&quot;iterate&quot;</span>
    <span class=n>ESCALATE</span> <span class=o>=</span> <span class=s2>&quot;escalate&quot;</span>

<span class=nd>@dataclass</span>
<span class=k>class</span><span class=w> </span><span class=nc>MetricResult</span><span class=p>:</span>
    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>
    <span class=n>metric_type</span><span class=p>:</span> <span class=n>MetricType</span>
    <span class=n>control_mean</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>treatment_mean</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>p_value</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>ci_lower</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>ci_upper</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>relative_lift</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>threshold</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># For guardrails</span>

    <span class=k>def</span><span class=w> </span><span class=nf>is_significant</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>):</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>p_value</span> <span class=o>&lt;</span> <span class=n>alpha</span>

    <span class=k>def</span><span class=w> </span><span class=nf>passes_guardrail</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>metric_type</span> <span class=o>!=</span> <span class=n>MetricType</span><span class=o>.</span><span class=n>GUARDRAIL</span><span class=p>:</span>
            <span class=k>return</span> <span class=kc>True</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>threshold</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=k>return</span> <span class=kc>True</span>
        <span class=c1># Guardrail: treatment should not be worse than threshold</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>treatment_mean</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>threshold</span>

<span class=k>class</span><span class=w> </span><span class=nc>ExperimentDecisionEngine</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Production decision framework for multi-metric A/B tests&quot;&quot;&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>=</span> <span class=n>alpha</span>

    <span class=k>def</span><span class=w> </span><span class=nf>make_decision</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>results</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>MetricResult</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Tuple</span><span class=p>[</span><span class=n>Decision</span><span class=p>,</span> <span class=nb>str</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Decision tree:</span>
<span class=sd>        1. Check all guardrails pass</span>
<span class=sd>        2. Check primary metric significant positive</span>
<span class=sd>        3. Consider secondary metrics for interpretation</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=c1># Step 1: Guardrails</span>
        <span class=n>guardrails</span> <span class=o>=</span> <span class=p>[</span><span class=n>r</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>results</span> <span class=k>if</span> <span class=n>r</span><span class=o>.</span><span class=n>metric_type</span> <span class=o>==</span> <span class=n>MetricType</span><span class=o>.</span><span class=n>GUARDRAIL</span><span class=p>]</span>
        <span class=n>failed_guardrails</span> <span class=o>=</span> <span class=p>[</span><span class=n>g</span> <span class=k>for</span> <span class=n>g</span> <span class=ow>in</span> <span class=n>guardrails</span> <span class=k>if</span> <span class=ow>not</span> <span class=n>g</span><span class=o>.</span><span class=n>passes_guardrail</span><span class=p>()]</span>

        <span class=k>if</span> <span class=n>failed_guardrails</span><span class=p>:</span>
            <span class=n>reasons</span> <span class=o>=</span> <span class=p>[</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>g</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>g</span><span class=o>.</span><span class=n>treatment_mean</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> &lt; threshold </span><span class=si>{</span><span class=n>g</span><span class=o>.</span><span class=n>threshold</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span> 
                      <span class=k>for</span> <span class=n>g</span> <span class=ow>in</span> <span class=n>failed_guardrails</span><span class=p>]</span>
            <span class=k>return</span> <span class=n>Decision</span><span class=o>.</span><span class=n>NO_SHIP</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&quot;Guardrail violations: </span><span class=si>{</span><span class=s1>&#39;, &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>reasons</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span>

        <span class=c1># Step 2: Primary metric</span>
        <span class=n>primary</span> <span class=o>=</span> <span class=p>[</span><span class=n>r</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>results</span> <span class=k>if</span> <span class=n>r</span><span class=o>.</span><span class=n>metric_type</span> <span class=o>==</span> <span class=n>MetricType</span><span class=o>.</span><span class=n>PRIMARY</span><span class=p>]</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>primary</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>Decision</span><span class=o>.</span><span class=n>ESCALATE</span><span class=p>,</span> <span class=s2>&quot;No primary metric defined&quot;</span>

        <span class=n>primary_metric</span> <span class=o>=</span> <span class=n>primary</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>  <span class=c1># Assume single primary</span>

        <span class=k>if</span> <span class=n>primary_metric</span><span class=o>.</span><span class=n>is_significant</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>alpha</span><span class=p>)</span> <span class=ow>and</span> <span class=n>primary_metric</span><span class=o>.</span><span class=n>relative_lift</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>Decision</span><span class=o>.</span><span class=n>SHIP</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&quot;Primary metric (</span><span class=si>{</span><span class=n>primary_metric</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>) significant positive: +</span><span class=si>{</span><span class=n>primary_metric</span><span class=o>.</span><span class=n>relative_lift</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&quot;</span>

        <span class=c1># Step 3: Secondary interpretation</span>
        <span class=n>secondary</span> <span class=o>=</span> <span class=p>[</span><span class=n>r</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>results</span> <span class=k>if</span> <span class=n>r</span><span class=o>.</span><span class=n>metric_type</span> <span class=o>==</span> <span class=n>MetricType</span><span class=o>.</span><span class=n>SECONDARY</span><span class=p>]</span>
        <span class=n>sig_secondary_positive</span> <span class=o>=</span> <span class=p>[</span><span class=n>r</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>secondary</span> <span class=k>if</span> <span class=n>r</span><span class=o>.</span><span class=n>is_significant</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>alpha</span><span class=p>)</span> <span class=ow>and</span> <span class=n>r</span><span class=o>.</span><span class=n>relative_lift</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>]</span>
        <span class=n>sig_secondary_negative</span> <span class=o>=</span> <span class=p>[</span><span class=n>r</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>secondary</span> <span class=k>if</span> <span class=n>r</span><span class=o>.</span><span class=n>is_significant</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>alpha</span><span class=p>)</span> <span class=ow>and</span> <span class=n>r</span><span class=o>.</span><span class=n>relative_lift</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>]</span>

        <span class=k>if</span> <span class=n>primary_metric</span><span class=o>.</span><span class=n>relative_lift</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>primary_metric</span><span class=o>.</span><span class=n>is_significant</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>alpha</span><span class=p>):</span>
            <span class=c1># Primary directionally correct but underpowered</span>
            <span class=k>if</span> <span class=n>sig_secondary_positive</span><span class=p>:</span>
                <span class=k>return</span> <span class=n>Decision</span><span class=o>.</span><span class=n>ITERATE</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&quot;Primary positive but not significant. Secondary wins: </span><span class=si>{</span><span class=p>[</span><span class=n>r</span><span class=o>.</span><span class=n>name</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=ow>in</span><span class=w> </span><span class=n>sig_secondary_positive</span><span class=p>]</span><span class=si>}</span><span class=s2>. Consider longer test.&quot;</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=k>return</span> <span class=n>Decision</span><span class=o>.</span><span class=n>NO_SHIP</span><span class=p>,</span> <span class=s2>&quot;Primary not significant, no supporting secondary wins&quot;</span>

        <span class=k>if</span> <span class=n>sig_secondary_negative</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>Decision</span><span class=o>.</span><span class=n>NO_SHIP</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&quot;Primary neutral/negative. Secondary losses: </span><span class=si>{</span><span class=p>[</span><span class=n>r</span><span class=o>.</span><span class=n>name</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=ow>in</span><span class=w> </span><span class=n>sig_secondary_negative</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span>

        <span class=k>return</span> <span class=n>Decision</span><span class=o>.</span><span class=n>NO_SHIP</span><span class=p>,</span> <span class=s2>&quot;Primary not significant positive&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=nf>generate_report</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>results</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>MetricResult</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Generate stakeholder-friendly report&quot;&quot;&quot;</span>
        <span class=n>decision</span><span class=p>,</span> <span class=n>reason</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>make_decision</span><span class=p>(</span><span class=n>results</span><span class=p>)</span>

        <span class=n>report</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>]</span>
        <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;EXPERIMENT DECISION REPORT&quot;</span><span class=p>)</span>
        <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>
        <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üéØ DECISION: </span><span class=si>{</span><span class=n>decision</span><span class=o>.</span><span class=n>value</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
        <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;üìù REASON: </span><span class=si>{</span><span class=n>reason</span><span class=si>}</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>

        <span class=c1># Guardrails</span>
        <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;GUARDRAILS (Safety Checks)&quot;</span><span class=p>)</span>
        <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;-&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>
        <span class=n>guardrails</span> <span class=o>=</span> <span class=p>[</span><span class=n>r</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>results</span> <span class=k>if</span> <span class=n>r</span><span class=o>.</span><span class=n>metric_type</span> <span class=o>==</span> <span class=n>MetricType</span><span class=o>.</span><span class=n>GUARDRAIL</span><span class=p>]</span>
        <span class=k>for</span> <span class=n>g</span> <span class=ow>in</span> <span class=n>guardrails</span><span class=p>:</span>
            <span class=n>status</span> <span class=o>=</span> <span class=s2>&quot;‚úÖ PASS&quot;</span> <span class=k>if</span> <span class=n>g</span><span class=o>.</span><span class=n>passes_guardrail</span><span class=p>()</span> <span class=k>else</span> <span class=s2>&quot;‚ùå FAIL&quot;</span>
            <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  </span><span class=si>{</span><span class=n>status</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>g</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>g</span><span class=o>.</span><span class=n>treatment_mean</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2> (threshold: </span><span class=si>{</span><span class=n>g</span><span class=o>.</span><span class=n>threshold</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>

        <span class=c1># Primary</span>
        <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>PRIMARY METRIC (Decision Driver)&quot;</span><span class=p>)</span>
        <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;-&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>
        <span class=n>primary</span> <span class=o>=</span> <span class=p>[</span><span class=n>r</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>results</span> <span class=k>if</span> <span class=n>r</span><span class=o>.</span><span class=n>metric_type</span> <span class=o>==</span> <span class=n>MetricType</span><span class=o>.</span><span class=n>PRIMARY</span><span class=p>]</span>
        <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>primary</span><span class=p>:</span>
            <span class=n>sig</span> <span class=o>=</span> <span class=s2>&quot;‚úÖ Significant&quot;</span> <span class=k>if</span> <span class=n>p</span><span class=o>.</span><span class=n>is_significant</span><span class=p>()</span> <span class=k>else</span> <span class=s2>&quot;‚ö†Ô∏è  Not Significant&quot;</span>
            <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  </span><span class=si>{</span><span class=n>p</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>p</span><span class=o>.</span><span class=n>relative_lift</span><span class=si>:</span><span class=s2>+.2%</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=n>p</span><span class=o>.</span><span class=n>ci_lower</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2> to </span><span class=si>{</span><span class=n>p</span><span class=o>.</span><span class=n>ci_upper</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>
            <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    p-value: </span><span class=si>{</span><span class=n>p</span><span class=o>.</span><span class=n>p_value</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2> | </span><span class=si>{</span><span class=n>sig</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

        <span class=c1># Secondary</span>
        <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>SECONDARY METRICS (Interpretation)&quot;</span><span class=p>)</span>
        <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;-&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>
        <span class=n>secondary</span> <span class=o>=</span> <span class=p>[</span><span class=n>r</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>results</span> <span class=k>if</span> <span class=n>r</span><span class=o>.</span><span class=n>metric_type</span> <span class=o>==</span> <span class=n>MetricType</span><span class=o>.</span><span class=n>SECONDARY</span><span class=p>]</span>
        <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>secondary</span><span class=p>:</span>
            <span class=n>sig</span> <span class=o>=</span> <span class=s2>&quot;‚úÖ&quot;</span> <span class=k>if</span> <span class=n>s</span><span class=o>.</span><span class=n>is_significant</span><span class=p>()</span> <span class=k>else</span> <span class=s2>&quot;‚ö†Ô∏è&quot;</span>
            <span class=n>direction</span> <span class=o>=</span> <span class=s2>&quot;üìà&quot;</span> <span class=k>if</span> <span class=n>s</span><span class=o>.</span><span class=n>relative_lift</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=s2>&quot;üìâ&quot;</span>
            <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  </span><span class=si>{</span><span class=n>sig</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>direction</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>s</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>s</span><span class=o>.</span><span class=n>relative_lift</span><span class=si>:</span><span class=s2>+.2%</span><span class=si>}</span><span class=s2> (p=</span><span class=si>{</span><span class=n>s</span><span class=o>.</span><span class=n>p_value</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>

        <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>
        <span class=k>return</span> <span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>report</span><span class=p>)</span>

<span class=c1># Production Example: Search Ranking Experiment</span>
<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
<span class=n>n</span> <span class=o>=</span> <span class=mi>10000</span>

<span class=c1># Simulate control and treatment data</span>
<span class=k>def</span><span class=w> </span><span class=nf>simulate_experiment_data</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
    <span class=c1># Primary: Click-through rate (treatment: +2%)</span>
    <span class=n>control_ctr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mf>0.10</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
    <span class=n>treatment_ctr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mf>0.102</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>  <span class=c1># +2% relative</span>

    <span class=c1># Secondary: Time on page (treatment: +5%)</span>
    <span class=n>control_time</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>exponential</span><span class=p>(</span><span class=mi>60</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
    <span class=n>treatment_time</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>exponential</span><span class=p>(</span><span class=mi>63</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>  <span class=c1># +5%</span>

    <span class=c1># Secondary: Bounce rate (treatment: -3%)</span>
    <span class=n>control_bounce</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mf>0.40</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
    <span class=n>treatment_bounce</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mf>0.388</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>  <span class=c1># -3% relative</span>

    <span class=c1># Guardrail: Page load time (should stay &lt; 200ms)</span>
    <span class=n>control_latency</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>gamma</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>scale</span><span class=o>=</span><span class=mf>1.8</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n</span><span class=p>)</span>  <span class=c1># mean ~180ms</span>
    <span class=n>treatment_latency</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>gamma</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>scale</span><span class=o>=</span><span class=mf>1.85</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n</span><span class=p>)</span>  <span class=c1># mean ~185ms</span>

    <span class=c1># Guardrail: Error rate (should stay &lt; 0.1%)</span>
    <span class=n>control_errors</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mf>0.0008</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
    <span class=n>treatment_errors</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mf>0.0009</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>

    <span class=k>return</span> <span class=p>{</span>
        <span class=s1>&#39;ctr&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>control_ctr</span><span class=p>,</span> <span class=n>treatment_ctr</span><span class=p>),</span>
        <span class=s1>&#39;time_on_page&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>control_time</span><span class=p>,</span> <span class=n>treatment_time</span><span class=p>),</span>
        <span class=s1>&#39;bounce_rate&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>control_bounce</span><span class=p>,</span> <span class=n>treatment_bounce</span><span class=p>),</span>
        <span class=s1>&#39;latency&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>control_latency</span><span class=p>,</span> <span class=n>treatment_latency</span><span class=p>),</span>
        <span class=s1>&#39;error_rate&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>control_errors</span><span class=p>,</span> <span class=n>treatment_errors</span><span class=p>)</span>
    <span class=p>}</span>

<span class=n>data</span> <span class=o>=</span> <span class=n>simulate_experiment_data</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>

<span class=c1># Compute metrics</span>
<span class=k>def</span><span class=w> </span><span class=nf>compute_metric_result</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>metric_type</span><span class=p>,</span> <span class=n>control</span><span class=p>,</span> <span class=n>treatment</span><span class=p>,</span> <span class=n>threshold</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>invert</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Invert=True for metrics where lower is better (e.g., bounce rate, latency)&quot;&quot;&quot;</span>
    <span class=n>control_mean</span> <span class=o>=</span> <span class=n>control</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
    <span class=n>treatment_mean</span> <span class=o>=</span> <span class=n>treatment</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>

    <span class=c1># Two-sample t-test</span>
    <span class=n>t_stat</span><span class=p>,</span> <span class=n>p_value</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span><span class=n>treatment</span><span class=p>,</span> <span class=n>control</span><span class=p>)</span>

    <span class=c1># Confidence interval for difference</span>
    <span class=n>se</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>control</span><span class=o>.</span><span class=n>var</span><span class=p>()</span><span class=o>/</span><span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>)</span> <span class=o>+</span> <span class=n>treatment</span><span class=o>.</span><span class=n>var</span><span class=p>()</span><span class=o>/</span><span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>))</span>
    <span class=n>ci_lower</span> <span class=o>=</span> <span class=p>(</span><span class=n>treatment_mean</span> <span class=o>-</span> <span class=n>control_mean</span><span class=p>)</span> <span class=o>-</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=n>se</span>
    <span class=n>ci_upper</span> <span class=o>=</span> <span class=p>(</span><span class=n>treatment_mean</span> <span class=o>-</span> <span class=n>control_mean</span><span class=p>)</span> <span class=o>+</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=n>se</span>

    <span class=c1># Relative lift</span>
    <span class=k>if</span> <span class=n>invert</span><span class=p>:</span>
        <span class=n>relative_lift</span> <span class=o>=</span> <span class=p>(</span><span class=n>control_mean</span> <span class=o>-</span> <span class=n>treatment_mean</span><span class=p>)</span> <span class=o>/</span> <span class=n>control_mean</span>  <span class=c1># Lower is better</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>relative_lift</span> <span class=o>=</span> <span class=p>(</span><span class=n>treatment_mean</span> <span class=o>-</span> <span class=n>control_mean</span><span class=p>)</span> <span class=o>/</span> <span class=n>control_mean</span>

    <span class=c1># Convert CI to relative</span>
    <span class=n>ci_lower_rel</span> <span class=o>=</span> <span class=n>ci_lower</span> <span class=o>/</span> <span class=n>control_mean</span>
    <span class=n>ci_upper_rel</span> <span class=o>=</span> <span class=n>ci_upper</span> <span class=o>/</span> <span class=n>control_mean</span>

    <span class=k>return</span> <span class=n>MetricResult</span><span class=p>(</span>
        <span class=n>name</span><span class=o>=</span><span class=n>name</span><span class=p>,</span>
        <span class=n>metric_type</span><span class=o>=</span><span class=n>metric_type</span><span class=p>,</span>
        <span class=n>control_mean</span><span class=o>=</span><span class=n>control_mean</span><span class=p>,</span>
        <span class=n>treatment_mean</span><span class=o>=</span><span class=n>treatment_mean</span><span class=p>,</span>
        <span class=n>p_value</span><span class=o>=</span><span class=n>p_value</span><span class=p>,</span>
        <span class=n>ci_lower</span><span class=o>=</span><span class=n>ci_lower_rel</span><span class=p>,</span>
        <span class=n>ci_upper</span><span class=o>=</span><span class=n>ci_upper_rel</span><span class=p>,</span>
        <span class=n>relative_lift</span><span class=o>=</span><span class=n>relative_lift</span><span class=p>,</span>
        <span class=n>threshold</span><span class=o>=</span><span class=n>threshold</span>
    <span class=p>)</span>

<span class=n>results</span> <span class=o>=</span> <span class=p>[</span>
    <span class=c1># Primary</span>
    <span class=n>compute_metric_result</span><span class=p>(</span><span class=s2>&quot;CTR&quot;</span><span class=p>,</span> <span class=n>MetricType</span><span class=o>.</span><span class=n>PRIMARY</span><span class=p>,</span> 
                         <span class=n>data</span><span class=p>[</span><span class=s1>&#39;ctr&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>],</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;ctr&#39;</span><span class=p>][</span><span class=mi>1</span><span class=p>]),</span>

    <span class=c1># Secondary</span>
    <span class=n>compute_metric_result</span><span class=p>(</span><span class=s2>&quot;Time on Page&quot;</span><span class=p>,</span> <span class=n>MetricType</span><span class=o>.</span><span class=n>SECONDARY</span><span class=p>,</span>
                         <span class=n>data</span><span class=p>[</span><span class=s1>&#39;time_on_page&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>],</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;time_on_page&#39;</span><span class=p>][</span><span class=mi>1</span><span class=p>]),</span>
    <span class=n>compute_metric_result</span><span class=p>(</span><span class=s2>&quot;Bounce Rate&quot;</span><span class=p>,</span> <span class=n>MetricType</span><span class=o>.</span><span class=n>SECONDARY</span><span class=p>,</span>
                         <span class=n>data</span><span class=p>[</span><span class=s1>&#39;bounce_rate&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>],</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;bounce_rate&#39;</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=n>invert</span><span class=o>=</span><span class=kc>True</span><span class=p>),</span>

    <span class=c1># Guardrails</span>
    <span class=n>compute_metric_result</span><span class=p>(</span><span class=s2>&quot;Latency (ms)&quot;</span><span class=p>,</span> <span class=n>MetricType</span><span class=o>.</span><span class=n>GUARDRAIL</span><span class=p>,</span>
                         <span class=n>data</span><span class=p>[</span><span class=s1>&#39;latency&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>],</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;latency&#39;</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=n>threshold</span><span class=o>=</span><span class=mi>190</span><span class=p>,</span> <span class=n>invert</span><span class=o>=</span><span class=kc>True</span><span class=p>),</span>
    <span class=n>compute_metric_result</span><span class=p>(</span><span class=s2>&quot;Error Rate&quot;</span><span class=p>,</span> <span class=n>MetricType</span><span class=o>.</span><span class=n>GUARDRAIL</span><span class=p>,</span>
                         <span class=n>data</span><span class=p>[</span><span class=s1>&#39;error_rate&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>],</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;error_rate&#39;</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=n>threshold</span><span class=o>=</span><span class=mf>0.001</span><span class=p>,</span> <span class=n>invert</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<span class=p>]</span>

<span class=c1># Make decision</span>
<span class=n>engine</span> <span class=o>=</span> <span class=n>ExperimentDecisionEngine</span><span class=p>(</span><span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>)</span>
<span class=n>report</span> <span class=o>=</span> <span class=n>engine</span><span class=o>.</span><span class=n>generate_report</span><span class=p>(</span><span class=n>results</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>report</span><span class=p>)</span>

<span class=c1># Example 2: Conflicting metrics scenario</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;SCENARIO 2: CONFLICTING METRICS (Revenue up, Engagement down)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>70</span> <span class=o>+</span> <span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Simulate conflicting scenario</span>
<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>123</span><span class=p>)</span>
<span class=n>conflicting_data</span> <span class=o>=</span> <span class=p>{</span>
    <span class=s1>&#39;revenue&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>gamma</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>25</span><span class=p>,</span> <span class=mi>10000</span><span class=p>),</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>gamma</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>26</span><span class=p>,</span> <span class=mi>10000</span><span class=p>)),</span>  <span class=c1># +4%</span>
    <span class=s1>&#39;engagement&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>poisson</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=mi>10000</span><span class=p>),</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>poisson</span><span class=p>(</span><span class=mf>4.8</span><span class=p>,</span> <span class=mi>10000</span><span class=p>)),</span>  <span class=c1># -4%</span>
    <span class=s1>&#39;latency&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>gamma</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mf>1.8</span><span class=p>,</span> <span class=mi>10000</span><span class=p>),</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>gamma</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mf>1.85</span><span class=p>,</span> <span class=mi>10000</span><span class=p>))</span>
<span class=p>}</span>

<span class=n>conflicting_results</span> <span class=o>=</span> <span class=p>[</span>
    <span class=n>compute_metric_result</span><span class=p>(</span><span class=s2>&quot;Revenue per User&quot;</span><span class=p>,</span> <span class=n>MetricType</span><span class=o>.</span><span class=n>PRIMARY</span><span class=p>,</span>
                         <span class=n>conflicting_data</span><span class=p>[</span><span class=s1>&#39;revenue&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>],</span> <span class=n>conflicting_data</span><span class=p>[</span><span class=s1>&#39;revenue&#39;</span><span class=p>][</span><span class=mi>1</span><span class=p>]),</span>
    <span class=n>compute_metric_result</span><span class=p>(</span><span class=s2>&quot;Engagement (sessions/day)&quot;</span><span class=p>,</span> <span class=n>MetricType</span><span class=o>.</span><span class=n>SECONDARY</span><span class=p>,</span>
                         <span class=n>conflicting_data</span><span class=p>[</span><span class=s1>&#39;engagement&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>],</span> <span class=n>conflicting_data</span><span class=p>[</span><span class=s1>&#39;engagement&#39;</span><span class=p>][</span><span class=mi>1</span><span class=p>]),</span>
    <span class=n>compute_metric_result</span><span class=p>(</span><span class=s2>&quot;Latency&quot;</span><span class=p>,</span> <span class=n>MetricType</span><span class=o>.</span><span class=n>GUARDRAIL</span><span class=p>,</span>
                         <span class=n>conflicting_data</span><span class=p>[</span><span class=s1>&#39;latency&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>],</span> <span class=n>conflicting_data</span><span class=p>[</span><span class=s1>&#39;latency&#39;</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> 
                         <span class=n>threshold</span><span class=o>=</span><span class=mi>190</span><span class=p>,</span> <span class=n>invert</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<span class=p>]</span>

<span class=n>report2</span> <span class=o>=</span> <span class=n>engine</span><span class=o>.</span><span class=n>generate_report</span><span class=p>(</span><span class=n>conflicting_results</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>report2</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìä DECISION LOGIC:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;  1. Guardrails pass? ‚Üí Continue&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;  2. Primary significant positive? ‚Üí SHIP (even if secondary mixed)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;  3. Trade-off: Revenue &gt; Engagement for this team&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;  4. Real-world: Netflix ships revenue-positive even if engagement dips slightly&quot;</span><span class=p>)</span>
</code></pre></div> <table> <thead> <tr> <th>Metric Type</th> <th>Purpose</th> <th>Count</th> <th>Decision Weight</th> <th>Action if Fails</th> </tr> </thead> <tbody> <tr> <td><strong>Primary</strong></td> <td>Ship/no-ship decision</td> <td>1 (rarely 2)</td> <td>100%</td> <td>No ship if not significant</td> </tr> <tr> <td><strong>Secondary</strong></td> <td>Interpret primary, debug</td> <td>3-10</td> <td>Interpretive</td> <td>Explain primary, inform iter</td> </tr> <tr> <td><strong>Guardrail</strong></td> <td>Safety checks</td> <td>3-5</td> <td>Veto power</td> <td>No ship if ANY fail</td> </tr> </tbody> </table> <table> <thead> <tr> <th>Scenario</th> <th>Primary</th> <th>Secondary</th> <th>Guardrails</th> <th>Decision</th> <th>Example</th> </tr> </thead> <tbody> <tr> <td><strong>Primary wins, all pass</strong></td> <td>‚úÖ +5%</td> <td>Mixed</td> <td>‚úÖ Pass</td> <td><strong>SHIP</strong></td> <td>Netflix: CTR +5%, latency OK</td> </tr> <tr> <td><strong>Primary neutral, secondary wins</strong></td> <td>‚ö†Ô∏è +1%</td> <td>‚úÖ +10%</td> <td>‚úÖ Pass</td> <td><strong>Iterate</strong></td> <td>Airbnb: Bookings +1%, engagement +10%</td> </tr> <tr> <td><strong>Primary wins, guardrail fails</strong></td> <td>‚úÖ +8%</td> <td>‚úÖ Positive</td> <td>‚ùå Latency</td> <td><strong>NO SHIP</strong></td> <td>Uber: Rides +8%, but 500ms latency spike</td> </tr> <tr> <td><strong>Primary loses</strong></td> <td>‚ùå -2%</td> <td>‚úÖ Positive</td> <td>‚úÖ Pass</td> <td><strong>NO SHIP</strong></td> <td>Any: Primary negative overrides secondary</td> </tr> </tbody> </table> <p><strong>Real-World:</strong> - <strong>Netflix:</strong> Ran recommendation algo with <strong>+3% watch time (primary)</strong> but <strong>-2% catalog coverage (secondary)</strong>. Shipped because primary won, then iterated on coverage. - <strong>Airbnb:</strong> <strong>Guardrail failure</strong>: New search increased bookings +5% but <strong>error rate spiked to 0.3%</strong> (threshold: 0.1%). <strong>Rejected</strong> despite revenue win. - <strong>Uber:</strong> Conflicting metrics: Driver earnings +4%, rider wait time +8%. <strong>Escalated</strong> to leadership; decided rider experience &gt; driver earnings, <strong>no ship</strong>.</p> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <ul> <li>Knows <strong>primary = decision metric</strong> (1 metric, clear ship/no-ship)</li> <li>Uses <strong>guardrails as veto</strong> (any failure = stop, even if primary wins)</li> <li>Real-world: <strong>Netflix ships revenue-positive even if engagement slightly down; Airbnb rejected +5% bookings due to 0.3% error rate spike</strong></li> </ul> </div> </details> <hr> <h3 id=what-is-simpsons-paradox-google-meta-interview-question>What is Simpson's Paradox? - Google, Meta Interview Question</h3> <p><strong>Difficulty:</strong> üî¥ Hard | <strong>Tags:</strong> <code>Statistics</code>, <code>Segmentation</code> | <strong>Asked by:</strong> Google, Meta, Netflix</p> <details class=success> <summary>View Answer</summary> <p><strong>Simpson's Paradox occurs when an aggregate trend reverses when data is segmented by a lurking variable</strong>‚Äî<strong>treatment wins in every segment</strong> but <strong>loses overall</strong>, or vice versa. This happens when segments have <strong>unequal sizes</strong> and <strong>different baseline rates</strong>, causing composition effects to dominate true treatment effects.</p> <div class=highlight><pre><span></span><code>              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ  Overall A/B Test Result    ‚îÇ
              ‚îÇ  Control: 50% conversion    ‚îÇ
              ‚îÇ  Treatment: 48% conversion  ‚îÇ
              ‚îÇ  ‚ùå Treatment LOSES          ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚Üì
             ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
             ‚îÇ  Segment by Device Type   ‚îÇ
             ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚Üì
      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
      ‚Üì                                      ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Mobile (90% users) ‚îÇ          ‚îÇ  Desktop (10% users)‚îÇ
‚îÇ  Control: 45%       ‚îÇ          ‚îÇ  Control: 90%       ‚îÇ
‚îÇ  Treatment: 47%     ‚îÇ          ‚îÇ  Treatment: 92%     ‚îÇ
‚îÇ  ‚úÖ Treatment WINS  ‚îÇ          ‚îÇ  ‚úÖ Treatment WINS  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚Üì
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ  Paradox! Treatment wins in  ‚îÇ
            ‚îÇ  BOTH segments but loses     ‚îÇ
            ‚îÇ  overall due to composition  ‚îÇ
            ‚îÇ  (mobile has lower baseline) ‚îÇ
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>import</span><span class=w> </span><span class=nn>matplotlib.pyplot</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>plt</span>

<span class=c1># Production: Demonstrate Simpson&#39;s Paradox in A/B Testing</span>

<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>

<span class=c1># Example 1: Classic Simpson&#39;s Paradox</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;SIMPSON&#39;S PARADOX: Treatment wins per segment, loses overall&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>

<span class=c1># Create dataset with two segments (mobile, desktop)</span>
<span class=n>mobile_control</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
    <span class=s1>&#39;segment&#39;</span><span class=p>:</span> <span class=s1>&#39;mobile&#39;</span><span class=p>,</span>
    <span class=s1>&#39;group&#39;</span><span class=p>:</span> <span class=s1>&#39;control&#39;</span><span class=p>,</span>
    <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=nb>range</span><span class=p>(</span><span class=mi>9000</span><span class=p>),</span>
    <span class=s1>&#39;converted&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mf>0.45</span><span class=p>,</span> <span class=mi>9000</span><span class=p>)</span>  <span class=c1># 45% CVR</span>
<span class=p>})</span>

<span class=n>mobile_treatment</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
    <span class=s1>&#39;segment&#39;</span><span class=p>:</span> <span class=s1>&#39;mobile&#39;</span><span class=p>,</span>
    <span class=s1>&#39;group&#39;</span><span class=p>:</span> <span class=s1>&#39;treatment&#39;</span><span class=p>,</span>
    <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=nb>range</span><span class=p>(</span><span class=mi>9000</span><span class=p>,</span> <span class=mi>18000</span><span class=p>),</span>
    <span class=s1>&#39;converted&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mf>0.47</span><span class=p>,</span> <span class=mi>9000</span><span class=p>)</span>  <span class=c1># 47% CVR (+2pp)</span>
<span class=p>})</span>

<span class=n>desktop_control</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
    <span class=s1>&#39;segment&#39;</span><span class=p>:</span> <span class=s1>&#39;desktop&#39;</span><span class=p>,</span>
    <span class=s1>&#39;group&#39;</span><span class=p>:</span> <span class=s1>&#39;control&#39;</span><span class=p>,</span>
    <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=nb>range</span><span class=p>(</span><span class=mi>18000</span><span class=p>,</span> <span class=mi>19000</span><span class=p>),</span>
    <span class=s1>&#39;converted&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mf>0.90</span><span class=p>,</span> <span class=mi>1000</span><span class=p>)</span>  <span class=c1># 90% CVR</span>
<span class=p>})</span>

<span class=n>desktop_treatment</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
    <span class=s1>&#39;segment&#39;</span><span class=p>:</span> <span class=s1>&#39;desktop&#39;</span><span class=p>,</span>
    <span class=s1>&#39;group&#39;</span><span class=p>:</span> <span class=s1>&#39;treatment&#39;</span><span class=p>,</span>
    <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=nb>range</span><span class=p>(</span><span class=mi>19000</span><span class=p>,</span> <span class=mi>20000</span><span class=p>),</span>
    <span class=s1>&#39;converted&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mf>0.92</span><span class=p>,</span> <span class=mi>1000</span><span class=p>)</span>  <span class=c1># 92% CVR (+2pp)</span>
<span class=p>})</span>

<span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>([</span><span class=n>mobile_control</span><span class=p>,</span> <span class=n>mobile_treatment</span><span class=p>,</span> <span class=n>desktop_control</span><span class=p>,</span> <span class=n>desktop_treatment</span><span class=p>])</span>

<span class=c1># Overall analysis (WRONG: ignores segments)</span>
<span class=n>overall_control</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;control&#39;</span><span class=p>][</span><span class=s1>&#39;converted&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
<span class=n>overall_treatment</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>][</span><span class=s1>&#39;converted&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>[WRONG] Overall Analysis (Ignoring Segments)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Control:   </span><span class=si>{</span><span class=n>overall_control</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=n>overall_control</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Treatment: </span><span class=si>{</span><span class=n>overall_treatment</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=n>overall_treatment</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Lift: </span><span class=si>{</span><span class=n>overall_treatment</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>overall_control</span><span class=si>:</span><span class=s2>+.3f</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=p>(</span><span class=n>overall_treatment</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>overall_control</span><span class=p>)</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>+.1f</span><span class=si>}</span><span class=s2>pp)&quot;</span><span class=p>)</span>

<span class=k>if</span> <span class=n>overall_treatment</span> <span class=o>&lt;</span> <span class=n>overall_control</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;  ‚ùå Conclusion: Treatment LOSES&quot;</span><span class=p>)</span>
<span class=k>else</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;  ‚úÖ Conclusion: Treatment WINS&quot;</span><span class=p>)</span>

<span class=c1># Segmented analysis (CORRECT)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>[CORRECT] Segmented Analysis&quot;</span><span class=p>)</span>
<span class=k>for</span> <span class=n>segment</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;mobile&#39;</span><span class=p>,</span> <span class=s1>&#39;desktop&#39;</span><span class=p>]:</span>
    <span class=n>seg_data</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;segment&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>segment</span><span class=p>]</span>
    <span class=n>seg_control</span> <span class=o>=</span> <span class=n>seg_data</span><span class=p>[</span><span class=n>seg_data</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;control&#39;</span><span class=p>][</span><span class=s1>&#39;converted&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
    <span class=n>seg_treatment</span> <span class=o>=</span> <span class=n>seg_data</span><span class=p>[</span><span class=n>seg_data</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>][</span><span class=s1>&#39;converted&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
    <span class=n>seg_n</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>seg_data</span><span class=p>)</span> <span class=o>//</span> <span class=mi>2</span>

    <span class=n>t_stat</span><span class=p>,</span> <span class=n>p_val</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span>
        <span class=n>seg_data</span><span class=p>[</span><span class=n>seg_data</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>][</span><span class=s1>&#39;converted&#39;</span><span class=p>],</span>
        <span class=n>seg_data</span><span class=p>[</span><span class=n>seg_data</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;control&#39;</span><span class=p>][</span><span class=s1>&#39;converted&#39;</span><span class=p>]</span>
    <span class=p>)</span>

    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>  </span><span class=si>{</span><span class=n>segment</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span><span class=si>}</span><span class=s2> (n=</span><span class=si>{</span><span class=n>seg_n</span><span class=si>}</span><span class=s2> per group):&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    Control:   </span><span class=si>{</span><span class=n>seg_control</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=n>seg_control</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%)&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    Treatment: </span><span class=si>{</span><span class=n>seg_treatment</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=n>seg_treatment</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%)&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    Lift: </span><span class=si>{</span><span class=n>seg_treatment</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>seg_control</span><span class=si>:</span><span class=s2>+.3f</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=p>(</span><span class=n>seg_treatment</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>seg_control</span><span class=p>)</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>+.1f</span><span class=si>}</span><span class=s2>pp)&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    P-value: </span><span class=si>{</span><span class=n>p_val</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    ‚úÖ Treatment WINS in </span><span class=si>{</span><span class=n>segment</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üéØ PARADOX REVEALED:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;  - Treatment wins in BOTH mobile (+2pp) and desktop (+2pp)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;  - But treatment has MORE mobile users (low CVR)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;  - Composition effect makes treatment look worse overall&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;  - True effect: +2pp in each segment (consistent win)&quot;</span><span class=p>)</span>

<span class=c1># Example 2: Real-world scenario (time-based)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;REAL-WORLD: Weekday/Weekend Paradox&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>

<span class=c1># Treatment launched on Monday, control started Friday</span>
<span class=c1># Weekend has higher natural engagement</span>
<span class=n>weekday_control</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
    <span class=s1>&#39;period&#39;</span><span class=p>:</span> <span class=s1>&#39;weekday&#39;</span><span class=p>,</span>
    <span class=s1>&#39;group&#39;</span><span class=p>:</span> <span class=s1>&#39;control&#39;</span><span class=p>,</span>
    <span class=s1>&#39;engaged&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mf>0.30</span><span class=p>,</span> <span class=mi>7000</span><span class=p>)</span>  <span class=c1># 30% engagement</span>
<span class=p>})</span>

<span class=n>weekend_control</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
    <span class=s1>&#39;period&#39;</span><span class=p>:</span> <span class=s1>&#39;weekend&#39;</span><span class=p>,</span>
    <span class=s1>&#39;group&#39;</span><span class=p>:</span> <span class=s1>&#39;control&#39;</span><span class=p>,</span>
    <span class=s1>&#39;engaged&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mf>0.50</span><span class=p>,</span> <span class=mi>3000</span><span class=p>)</span>  <span class=c1># 50% engagement (natural boost)</span>
<span class=p>})</span>

<span class=n>weekday_treatment</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
    <span class=s1>&#39;period&#39;</span><span class=p>:</span> <span class=s1>&#39;weekday&#39;</span><span class=p>,</span>
    <span class=s1>&#39;group&#39;</span><span class=p>:</span> <span class=s1>&#39;treatment&#39;</span><span class=p>,</span>
    <span class=s1>&#39;engaged&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mf>0.33</span><span class=p>,</span> <span class=mi>8000</span><span class=p>)</span>  <span class=c1># 33% engagement (+3pp)</span>
<span class=p>})</span>

<span class=n>weekend_treatment</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
    <span class=s1>&#39;period&#39;</span><span class=p>:</span> <span class=s1>&#39;weekend&#39;</span><span class=p>,</span>
    <span class=s1>&#39;group&#39;</span><span class=p>:</span> <span class=s1>&#39;treatment&#39;</span><span class=p>,</span>
    <span class=s1>&#39;engaged&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mf>0.53</span><span class=p>,</span> <span class=mi>2000</span><span class=p>)</span>  <span class=c1># 53% engagement (+3pp)</span>
<span class=p>})</span>

<span class=n>df2</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>([</span><span class=n>weekday_control</span><span class=p>,</span> <span class=n>weekend_control</span><span class=p>,</span> <span class=n>weekday_treatment</span><span class=p>,</span> <span class=n>weekend_treatment</span><span class=p>])</span>

<span class=c1># Overall</span>
<span class=n>overall_control2</span> <span class=o>=</span> <span class=n>df2</span><span class=p>[</span><span class=n>df2</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;control&#39;</span><span class=p>][</span><span class=s1>&#39;engaged&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
<span class=n>overall_treatment2</span> <span class=o>=</span> <span class=n>df2</span><span class=p>[</span><span class=n>df2</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>][</span><span class=s1>&#39;engaged&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>[WRONG] Overall (Time not considered)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Control:   </span><span class=si>{</span><span class=n>overall_control2</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=n>overall_control2</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Treatment: </span><span class=si>{</span><span class=n>overall_treatment2</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=n>overall_treatment2</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Lift: </span><span class=si>{</span><span class=n>overall_treatment2</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>overall_control2</span><span class=si>:</span><span class=s2>+.3f</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=p>(</span><span class=n>overall_treatment2</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>overall_control2</span><span class=p>)</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>+.1f</span><span class=si>}</span><span class=s2>pp)&quot;</span><span class=p>)</span>

<span class=c1># Segmented by time</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>[CORRECT] Stratified by Weekday/Weekend&quot;</span><span class=p>)</span>
<span class=k>for</span> <span class=n>period</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;weekday&#39;</span><span class=p>,</span> <span class=s1>&#39;weekend&#39;</span><span class=p>]:</span>
    <span class=n>period_data</span> <span class=o>=</span> <span class=n>df2</span><span class=p>[</span><span class=n>df2</span><span class=p>[</span><span class=s1>&#39;period&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>period</span><span class=p>]</span>
    <span class=n>period_control</span> <span class=o>=</span> <span class=n>period_data</span><span class=p>[</span><span class=n>period_data</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;control&#39;</span><span class=p>][</span><span class=s1>&#39;engaged&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
    <span class=n>period_treatment</span> <span class=o>=</span> <span class=n>period_data</span><span class=p>[</span><span class=n>period_data</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>][</span><span class=s1>&#39;engaged&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>

    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>  </span><span class=si>{</span><span class=n>period</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span><span class=si>}</span><span class=s2>:&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    Control:   </span><span class=si>{</span><span class=n>period_control</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    Treatment: </span><span class=si>{</span><span class=n>period_treatment</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    Lift: </span><span class=si>{</span><span class=n>period_treatment</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>period_control</span><span class=si>:</span><span class=s2>+.3f</span><span class=si>}</span><span class=s2> (+</span><span class=si>{</span><span class=p>(</span><span class=n>period_treatment</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>period_control</span><span class=p>)</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>pp)&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    ‚úÖ Consistent +3pp lift&quot;</span><span class=p>)</span>

<span class=c1># How to prevent: Check Sample Ratio Mismatch (SRM) by segment</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;PREVENTION: Check Sample Ratio by Segment&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>

<span class=k>def</span><span class=w> </span><span class=nf>check_srm_by_segment</span><span class=p>(</span><span class=n>df</span><span class=p>,</span> <span class=n>segment_col</span><span class=p>,</span> <span class=n>group_col</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Check if treatment/control split is balanced within each segment&quot;&quot;&quot;</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Sample Ratio Check (by </span><span class=si>{</span><span class=n>segment_col</span><span class=si>}</span><span class=s2>):&quot;</span><span class=p>)</span>
    <span class=k>for</span> <span class=n>segment</span> <span class=ow>in</span> <span class=n>df</span><span class=p>[</span><span class=n>segment_col</span><span class=p>]</span><span class=o>.</span><span class=n>unique</span><span class=p>():</span>
        <span class=n>seg_data</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=n>segment_col</span><span class=p>]</span> <span class=o>==</span> <span class=n>segment</span><span class=p>]</span>
        <span class=n>n_control</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>seg_data</span><span class=p>[</span><span class=n>seg_data</span><span class=p>[</span><span class=n>group_col</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;control&#39;</span><span class=p>])</span>
        <span class=n>n_treatment</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>seg_data</span><span class=p>[</span><span class=n>seg_data</span><span class=p>[</span><span class=n>group_col</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>])</span>
        <span class=n>total</span> <span class=o>=</span> <span class=n>n_control</span> <span class=o>+</span> <span class=n>n_treatment</span>

        <span class=n>expected</span> <span class=o>=</span> <span class=n>total</span> <span class=o>/</span> <span class=mi>2</span>
        <span class=n>chi2</span> <span class=o>=</span> <span class=p>((</span><span class=n>n_control</span> <span class=o>-</span> <span class=n>expected</span><span class=p>)</span><span class=o>**</span><span class=mi>2</span> <span class=o>/</span> <span class=n>expected</span> <span class=o>+</span> 
               <span class=p>(</span><span class=n>n_treatment</span> <span class=o>-</span> <span class=n>expected</span><span class=p>)</span><span class=o>**</span><span class=mi>2</span> <span class=o>/</span> <span class=n>expected</span><span class=p>)</span>
        <span class=n>p_val</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>-</span> <span class=n>stats</span><span class=o>.</span><span class=n>chi2</span><span class=o>.</span><span class=n>cdf</span><span class=p>(</span><span class=n>chi2</span><span class=p>,</span> <span class=n>df</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>

        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  </span><span class=si>{</span><span class=n>segment</span><span class=si>}</span><span class=s2>: Control=</span><span class=si>{</span><span class=n>n_control</span><span class=si>}</span><span class=s2>, Treatment=</span><span class=si>{</span><span class=n>n_treatment</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    Expected: </span><span class=si>{</span><span class=n>expected</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2> each&quot;</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    Chi-square p-value: </span><span class=si>{</span><span class=n>p_val</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

        <span class=k>if</span> <span class=n>p_val</span> <span class=o>&lt;</span> <span class=mf>0.05</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    ‚ö†Ô∏è  IMBALANCE DETECTED (potential Simpson&#39;s Paradox)&quot;</span><span class=p>)</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    ‚úÖ Balanced&quot;</span><span class=p>)</span>

<span class=n>check_srm_by_segment</span><span class=p>(</span><span class=n>df</span><span class=p>,</span> <span class=s1>&#39;segment&#39;</span><span class=p>,</span> <span class=s1>&#39;group&#39;</span><span class=p>)</span>
<span class=n>check_srm_by_segment</span><span class=p>(</span><span class=n>df2</span><span class=p>,</span> <span class=s1>&#39;period&#39;</span><span class=p>,</span> <span class=s1>&#39;group&#39;</span><span class=p>)</span>

<span class=c1># Visualization</span>
<span class=n>fig</span><span class=p>,</span> <span class=n>axes</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>14</span><span class=p>,</span> <span class=mi>5</span><span class=p>))</span>

<span class=c1># Example 1: Device segments</span>
<span class=n>segments1</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;mobile&#39;</span><span class=p>,</span> <span class=s1>&#39;desktop&#39;</span><span class=p>,</span> <span class=s1>&#39;overall&#39;</span><span class=p>]</span>
<span class=n>control_rates1</span> <span class=o>=</span> <span class=p>[</span>
    <span class=n>df</span><span class=p>[(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;segment&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;mobile&#39;</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;control&#39;</span><span class=p>)][</span><span class=s1>&#39;converted&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>(),</span>
    <span class=n>df</span><span class=p>[(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;segment&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;desktop&#39;</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;control&#39;</span><span class=p>)][</span><span class=s1>&#39;converted&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>(),</span>
    <span class=n>overall_control</span>
<span class=p>]</span>
<span class=n>treatment_rates1</span> <span class=o>=</span> <span class=p>[</span>
    <span class=n>df</span><span class=p>[(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;segment&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;mobile&#39;</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>)][</span><span class=s1>&#39;converted&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>(),</span>
    <span class=n>df</span><span class=p>[(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;segment&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;desktop&#39;</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>)][</span><span class=s1>&#39;converted&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>(),</span>
    <span class=n>overall_treatment</span>
<span class=p>]</span>

<span class=n>x</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>segments1</span><span class=p>))</span>
<span class=n>width</span> <span class=o>=</span> <span class=mf>0.35</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>bar</span><span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=n>width</span><span class=o>/</span><span class=mi>2</span><span class=p>,</span> <span class=n>control_rates1</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;Control&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.8</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>bar</span><span class=p>(</span><span class=n>x</span> <span class=o>+</span> <span class=n>width</span><span class=o>/</span><span class=mi>2</span><span class=p>,</span> <span class=n>treatment_rates1</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;Treatment&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.8</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;Conversion Rate&#39;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s2>&quot;Simpson&#39;s Paradox: Device Segments&quot;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>set_xticks</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>set_xticklabels</span><span class=p>(</span><span class=n>segments1</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>axhline</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;black&#39;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>

<span class=c1># Annotate paradox</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>annotate</span><span class=p>(</span><span class=s1>&#39;Treatment wins&#39;</span><span class=p>,</span> <span class=n>xy</span><span class=o>=</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mf>0.47</span><span class=p>),</span> <span class=n>xytext</span><span class=o>=</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mf>0.52</span><span class=p>),</span>
                <span class=n>arrowprops</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>arrowstyle</span><span class=o>=</span><span class=s1>&#39;-&gt;&#39;</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;green&#39;</span><span class=p>),</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;green&#39;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>annotate</span><span class=p>(</span><span class=s1>&#39;Treatment wins&#39;</span><span class=p>,</span> <span class=n>xy</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mf>0.92</span><span class=p>),</span> <span class=n>xytext</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mf>0.97</span><span class=p>),</span>
                <span class=n>arrowprops</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>arrowstyle</span><span class=o>=</span><span class=s1>&#39;-&gt;&#39;</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;green&#39;</span><span class=p>),</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;green&#39;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>annotate</span><span class=p>(</span><span class=s1>&#39;Treatment loses!&#39;</span><span class=p>,</span> <span class=n>xy</span><span class=o>=</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mf>0.48</span><span class=p>),</span> <span class=n>xytext</span><span class=o>=</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mf>0.43</span><span class=p>),</span>
                <span class=n>arrowprops</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>arrowstyle</span><span class=o>=</span><span class=s1>&#39;-&gt;&#39;</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>),</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>)</span>

<span class=c1># Example 2: Time periods</span>
<span class=n>periods</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;weekday&#39;</span><span class=p>,</span> <span class=s1>&#39;weekend&#39;</span><span class=p>,</span> <span class=s1>&#39;overall&#39;</span><span class=p>]</span>
<span class=n>control_rates2</span> <span class=o>=</span> <span class=p>[</span>
    <span class=n>df2</span><span class=p>[(</span><span class=n>df2</span><span class=p>[</span><span class=s1>&#39;period&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;weekday&#39;</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>df2</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;control&#39;</span><span class=p>)][</span><span class=s1>&#39;engaged&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>(),</span>
    <span class=n>df2</span><span class=p>[(</span><span class=n>df2</span><span class=p>[</span><span class=s1>&#39;period&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;weekend&#39;</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>df2</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;control&#39;</span><span class=p>)][</span><span class=s1>&#39;engaged&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>(),</span>
    <span class=n>overall_control2</span>
<span class=p>]</span>
<span class=n>treatment_rates2</span> <span class=o>=</span> <span class=p>[</span>
    <span class=n>df2</span><span class=p>[(</span><span class=n>df2</span><span class=p>[</span><span class=s1>&#39;period&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;weekday&#39;</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>df2</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>)][</span><span class=s1>&#39;engaged&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>(),</span>
    <span class=n>df2</span><span class=p>[(</span><span class=n>df2</span><span class=p>[</span><span class=s1>&#39;period&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;weekend&#39;</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>df2</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>)][</span><span class=s1>&#39;engaged&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>(),</span>
    <span class=n>overall_treatment2</span>
<span class=p>]</span>

<span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>bar</span><span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=n>width</span><span class=o>/</span><span class=mi>2</span><span class=p>,</span> <span class=n>control_rates2</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;Control&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.8</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>bar</span><span class=p>(</span><span class=n>x</span> <span class=o>+</span> <span class=n>width</span><span class=o>/</span><span class=mi>2</span><span class=p>,</span> <span class=n>treatment_rates2</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;Treatment&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.8</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;Engagement Rate&#39;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s2>&quot;Time-Based Paradox&quot;</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>set_xticks</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>set_xticklabels</span><span class=p>(</span><span class=n>periods</span><span class=p>)</span>
<span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>

<span class=n>plt</span><span class=o>.</span><span class=n>tight_layout</span><span class=p>()</span>
<span class=c1># plt.savefig(&#39;simpsons_paradox.png&#39;)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Visualization generated.&quot;</span><span class=p>)</span>
</code></pre></div> <table> <thead> <tr> <th>Cause of Paradox</th> <th>Mechanism</th> <th>Example</th> <th>Prevention</th> </tr> </thead> <tbody> <tr> <td><strong>Unequal segment sizes</strong></td> <td>Small high-CVR segment dominates composition</td> <td>90% mobile (low CVR), 10% desktop (high CVR)</td> <td>Stratified randomization</td> </tr> <tr> <td><strong>Different baselines</strong></td> <td>Segments have different natural rates</td> <td>Weekend engagement 50% vs weekday 30%</td> <td>Time-stratified assignment</td> </tr> <tr> <td><strong>Non-random assignment</strong></td> <td>Treatment launched at different time</td> <td>Treatment gets more weekdays (low baseline)</td> <td>Simultaneous launch</td> </tr> </tbody> </table> <table> <thead> <tr> <th>Scenario</th> <th>Overall</th> <th>Mobile</th> <th>Desktop</th> <th>Paradox?</th> <th>Root Cause</th> </tr> </thead> <tbody> <tr> <td><strong>Classic Simpson's</strong></td> <td>T loses</td> <td>T wins +2pp</td> <td>T wins +2pp</td> <td>‚úÖ Yes</td> <td>Unequal sizes (90% mobile)</td> </tr> <tr> <td><strong>Time-based</strong></td> <td>T neutral</td> <td>T wins +3pp</td> <td>T wins +3pp</td> <td>‚úÖ Yes</td> <td>Treatment has fewer weekends</td> </tr> <tr> <td><strong>Balanced segments</strong></td> <td>T wins</td> <td>T wins</td> <td>T wins</td> <td>‚ùå No</td> <td>Equal sizes, no composition effect</td> </tr> </tbody> </table> <p><strong>Real-World:</strong> - <strong>Google Search:</strong> Tested new ranking algorithm; <strong>desktop showed +5% CTR</strong>, <strong>mobile +3% CTR</strong>, but <strong>overall -1% CTR</strong> because treatment got more mobile traffic (mobile has lower baseline). <strong>Solution:</strong> Stratified by device. - <strong>Meta Ads:</strong> Ran experiment where <strong>treatment won in both US (+2%) and International (+1.5%)</strong> but <strong>lost overall</strong> because treatment had more International users (lower baseline revenue). <strong>Caught by segment analysis</strong>. - <strong>Netflix:</strong> Personalization test showed <strong>treatment won in all 10 countries</strong> but <strong>lost overall</strong> due to unequal country distribution. <strong>Standard practice</strong>: Always report segmented results.</p> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <ul> <li>Knows <strong>Simpson's Paradox = composition effects</strong> (unequal segment sizes with different baselines)</li> <li>Always <strong>segments analysis by device, country, time</strong> to detect paradox</li> <li>Real-world: <strong>Google caught -1% overall CTR hiding +5% desktop, +3% mobile wins due to device mix; Meta detected US/Intl composition effect</strong></li> </ul> </div> </details> <hr> <h3 id=how-to-run-tests-with-ratio-metrics-most-tech-companies-interview-question>How to Run Tests with Ratio Metrics? - Most Tech Companies Interview Question</h3> <p><strong>Difficulty:</strong> üü° Medium | <strong>Tags:</strong> <code>Metrics</code> | <strong>Asked by:</strong> Most Tech Companies</p> <details class=success> <summary>View Answer</summary> <p><strong>Challenge:</strong> Ratio metrics (CTR = Clicks/Views, RPU = Revenue/Users) have complex variance structure. Simple t-tests are invalid.</p> <p><strong>Statistical Framework for Ratio Metrics:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                       Ratio Metric Analysis                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                       ‚îÇ
‚îÇ  User-Level Ratio:                                                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                         ‚îÇ
‚îÇ  ‚îÇ Numerator     ‚îÇ       ‚îÇ Denominator   ‚îÇ                         ‚îÇ
‚îÇ  ‚îÇ (Clicks)      ‚îÇ  √∑    ‚îÇ (Impressions) ‚îÇ  = CTR                  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                         ‚îÇ
‚îÇ         ‚Üì                        ‚Üì                                   ‚îÇ
‚îÇ    Aggregate              Aggregate                                  ‚îÇ
‚îÇ    then divide            then divide                                ‚îÇ
‚îÇ                                                                       ‚îÇ
‚îÇ  Session-Level Ratio:                                                ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                            ‚îÇ
‚îÇ  ‚îÇ For each session:                   ‚îÇ                            ‚îÇ
‚îÇ  ‚îÇ   session_ratio = clicks/views      ‚îÇ                            ‚îÇ
‚îÇ  ‚îÇ Then: mean(session_ratios)          ‚îÇ                            ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                            ‚îÇ
‚îÇ                                                                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Production Implementation - Delta Method + Bootstrap:</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>from</span><span class=w> </span><span class=nn>dataclasses</span><span class=w> </span><span class=kn>import</span> <span class=n>dataclass</span>
<span class=kn>import</span><span class=w> </span><span class=nn>matplotlib.pyplot</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>plt</span>
<span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Tuple</span>

<span class=nd>@dataclass</span>
<span class=k>class</span><span class=w> </span><span class=nc>RatioMetricResult</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Results container for ratio metric analysis&quot;&quot;&quot;</span>
    <span class=n>ratio</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>std_error</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>ci_lower</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>ci_upper</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>method</span><span class=p>:</span> <span class=nb>str</span>
    <span class=n>sample_size</span><span class=p>:</span> <span class=nb>int</span>

<span class=k>class</span><span class=w> </span><span class=nc>RatioMetricAnalyzer</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Comprehensive analyzer for ratio metrics in A/B tests.</span>
<span class=sd>    Handles CTR, RPU, conversion rate, and other ratio metrics.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>alpha</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.05</span><span class=p>,</span> <span class=n>n_bootstrap</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10000</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>=</span> <span class=n>alpha</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>n_bootstrap</span> <span class=o>=</span> <span class=n>n_bootstrap</span>

    <span class=k>def</span><span class=w> </span><span class=nf>delta_method</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>numerator</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> 
                    <span class=n>denominator</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>RatioMetricResult</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Delta method for ratio variance estimation.</span>

<span class=sd>        Variance approximation using Taylor expansion:</span>
<span class=sd>        Var(X/Y) ‚âà (Œºx/Œºy)¬≤ * [Var(X)/Œºx¬≤ + Var(Y)/Œºy¬≤ - 2*Cov(X,Y)/(Œºx*Œºy)]</span>

<span class=sd>        More accurate than naive ratio, especially for small samples.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>n</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>numerator</span><span class=p>)</span>

        <span class=c1># Mean estimates</span>
        <span class=n>mean_num</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>numerator</span><span class=p>)</span>
        <span class=n>mean_den</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>denominator</span><span class=p>)</span>
        <span class=n>ratio</span> <span class=o>=</span> <span class=n>mean_num</span> <span class=o>/</span> <span class=n>mean_den</span>

        <span class=c1># Variance and covariance</span>
        <span class=n>var_num</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>var</span><span class=p>(</span><span class=n>numerator</span><span class=p>,</span> <span class=n>ddof</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
        <span class=n>var_den</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>var</span><span class=p>(</span><span class=n>denominator</span><span class=p>,</span> <span class=n>ddof</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
        <span class=n>cov</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>cov</span><span class=p>(</span><span class=n>numerator</span><span class=p>,</span> <span class=n>denominator</span><span class=p>)[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>

        <span class=c1># Delta method variance</span>
        <span class=n>delta_var</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span> <span class=o>/</span> <span class=n>mean_den</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span>
            <span class=n>var_num</span> <span class=o>+</span> 
            <span class=n>ratio</span><span class=o>**</span><span class=mi>2</span> <span class=o>*</span> <span class=n>var_den</span> <span class=o>-</span> 
            <span class=mi>2</span> <span class=o>*</span> <span class=n>ratio</span> <span class=o>*</span> <span class=n>cov</span>
        <span class=p>)</span>

        <span class=n>std_error</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>delta_var</span> <span class=o>/</span> <span class=n>n</span><span class=p>)</span>

        <span class=c1># Confidence interval</span>
        <span class=n>z_crit</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>norm</span><span class=o>.</span><span class=n>ppf</span><span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>/</span> <span class=mi>2</span><span class=p>)</span>
        <span class=n>ci_lower</span> <span class=o>=</span> <span class=n>ratio</span> <span class=o>-</span> <span class=n>z_crit</span> <span class=o>*</span> <span class=n>std_error</span>
        <span class=n>ci_upper</span> <span class=o>=</span> <span class=n>ratio</span> <span class=o>+</span> <span class=n>z_crit</span> <span class=o>*</span> <span class=n>std_error</span>

        <span class=k>return</span> <span class=n>RatioMetricResult</span><span class=p>(</span>
            <span class=n>ratio</span><span class=o>=</span><span class=n>ratio</span><span class=p>,</span>
            <span class=n>std_error</span><span class=o>=</span><span class=n>std_error</span><span class=p>,</span>
            <span class=n>ci_lower</span><span class=o>=</span><span class=n>ci_lower</span><span class=p>,</span>
            <span class=n>ci_upper</span><span class=o>=</span><span class=n>ci_upper</span><span class=p>,</span>
            <span class=n>method</span><span class=o>=</span><span class=s1>&#39;delta_method&#39;</span><span class=p>,</span>
            <span class=n>sample_size</span><span class=o>=</span><span class=n>n</span>
        <span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>bootstrap_ratio</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>numerator</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span>
                       <span class=n>denominator</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>RatioMetricResult</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Bootstrap method for ratio metrics.</span>
<span class=sd>        More robust, no distributional assumptions.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>n</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>numerator</span><span class=p>)</span>
        <span class=n>bootstrap_ratios</span> <span class=o>=</span> <span class=p>[]</span>

        <span class=c1># Bootstrap resampling</span>
        <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>n_bootstrap</span><span class=p>):</span>
            <span class=n>indices</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n</span><span class=p>,</span> <span class=n>replace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
            <span class=n>boot_num</span> <span class=o>=</span> <span class=n>numerator</span><span class=p>[</span><span class=n>indices</span><span class=p>]</span>
            <span class=n>boot_den</span> <span class=o>=</span> <span class=n>denominator</span><span class=p>[</span><span class=n>indices</span><span class=p>]</span>

            <span class=c1># Calculate ratio for bootstrap sample</span>
            <span class=n>boot_ratio</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>boot_num</span><span class=p>)</span> <span class=o>/</span> <span class=n>np</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>boot_den</span><span class=p>)</span>
            <span class=n>bootstrap_ratios</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>boot_ratio</span><span class=p>)</span>

        <span class=n>bootstrap_ratios</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>bootstrap_ratios</span><span class=p>)</span>

        <span class=c1># Point estimate and CI</span>
        <span class=n>ratio</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>numerator</span><span class=p>)</span> <span class=o>/</span> <span class=n>np</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>denominator</span><span class=p>)</span>
        <span class=n>std_error</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>bootstrap_ratios</span><span class=p>,</span> <span class=n>ddof</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
        <span class=n>ci_lower</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>bootstrap_ratios</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>*</span> <span class=mi>100</span> <span class=o>/</span> <span class=mi>2</span><span class=p>)</span>
        <span class=n>ci_upper</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>bootstrap_ratios</span><span class=p>,</span> <span class=mi>100</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>*</span> <span class=mi>100</span> <span class=o>/</span> <span class=mi>2</span><span class=p>)</span>

        <span class=k>return</span> <span class=n>RatioMetricResult</span><span class=p>(</span>
            <span class=n>ratio</span><span class=o>=</span><span class=n>ratio</span><span class=p>,</span>
            <span class=n>std_error</span><span class=o>=</span><span class=n>std_error</span><span class=p>,</span>
            <span class=n>ci_lower</span><span class=o>=</span><span class=n>ci_lower</span><span class=p>,</span>
            <span class=n>ci_upper</span><span class=o>=</span><span class=n>ci_upper</span><span class=p>,</span>
            <span class=n>method</span><span class=o>=</span><span class=s1>&#39;bootstrap&#39;</span><span class=p>,</span>
            <span class=n>sample_size</span><span class=o>=</span><span class=n>n</span>
        <span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>compare_treatments</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> 
                         <span class=n>control_num</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>control_den</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span>
                         <span class=n>treatment_num</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>treatment_den</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span>
                         <span class=n>method</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;delta&#39;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Compare ratio metrics between control and treatment.</span>
<span class=sd>        Returns effect size and statistical significance.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;delta&#39;</span><span class=p>:</span>
            <span class=n>control_result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>delta_method</span><span class=p>(</span><span class=n>control_num</span><span class=p>,</span> <span class=n>control_den</span><span class=p>)</span>
            <span class=n>treatment_result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>delta_method</span><span class=p>(</span><span class=n>treatment_num</span><span class=p>,</span> <span class=n>treatment_den</span><span class=p>)</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>control_result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>bootstrap_ratio</span><span class=p>(</span><span class=n>control_num</span><span class=p>,</span> <span class=n>control_den</span><span class=p>)</span>
            <span class=n>treatment_result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>bootstrap_ratio</span><span class=p>(</span><span class=n>treatment_num</span><span class=p>,</span> <span class=n>treatment_den</span><span class=p>)</span>

        <span class=c1># Relative lift</span>
        <span class=n>lift</span> <span class=o>=</span> <span class=p>(</span><span class=n>treatment_result</span><span class=o>.</span><span class=n>ratio</span> <span class=o>-</span> <span class=n>control_result</span><span class=o>.</span><span class=n>ratio</span><span class=p>)</span> <span class=o>/</span> <span class=n>control_result</span><span class=o>.</span><span class=n>ratio</span>

        <span class=c1># Test statistic</span>
        <span class=n>diff</span> <span class=o>=</span> <span class=n>treatment_result</span><span class=o>.</span><span class=n>ratio</span> <span class=o>-</span> <span class=n>control_result</span><span class=o>.</span><span class=n>ratio</span>
        <span class=n>se_diff</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>control_result</span><span class=o>.</span><span class=n>std_error</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>treatment_result</span><span class=o>.</span><span class=n>std_error</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span>
        <span class=n>z_stat</span> <span class=o>=</span> <span class=n>diff</span> <span class=o>/</span> <span class=n>se_diff</span>
        <span class=n>p_value</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>stats</span><span class=o>.</span><span class=n>norm</span><span class=o>.</span><span class=n>cdf</span><span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>z_stat</span><span class=p>)))</span>

        <span class=k>return</span> <span class=p>{</span>
            <span class=s1>&#39;control_ratio&#39;</span><span class=p>:</span> <span class=n>control_result</span><span class=o>.</span><span class=n>ratio</span><span class=p>,</span>
            <span class=s1>&#39;treatment_ratio&#39;</span><span class=p>:</span> <span class=n>treatment_result</span><span class=o>.</span><span class=n>ratio</span><span class=p>,</span>
            <span class=s1>&#39;absolute_lift&#39;</span><span class=p>:</span> <span class=n>diff</span><span class=p>,</span>
            <span class=s1>&#39;relative_lift&#39;</span><span class=p>:</span> <span class=n>lift</span><span class=p>,</span>
            <span class=s1>&#39;se_diff&#39;</span><span class=p>:</span> <span class=n>se_diff</span><span class=p>,</span>
            <span class=s1>&#39;z_statistic&#39;</span><span class=p>:</span> <span class=n>z_stat</span><span class=p>,</span>
            <span class=s1>&#39;p_value&#39;</span><span class=p>:</span> <span class=n>p_value</span><span class=p>,</span>
            <span class=s1>&#39;significant&#39;</span><span class=p>:</span> <span class=n>p_value</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span><span class=p>,</span>
            <span class=s1>&#39;control_ci&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>control_result</span><span class=o>.</span><span class=n>ci_lower</span><span class=p>,</span> <span class=n>control_result</span><span class=o>.</span><span class=n>ci_upper</span><span class=p>),</span>
            <span class=s1>&#39;treatment_ci&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>treatment_result</span><span class=o>.</span><span class=n>ci_lower</span><span class=p>,</span> <span class=n>treatment_result</span><span class=o>.</span><span class=n>ci_upper</span><span class=p>)</span>
        <span class=p>}</span>

<span class=c1># Example: Click-Through Rate (CTR) Analysis</span>
<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>

<span class=c1># Simulate user-level data</span>
<span class=n>n_control</span> <span class=o>=</span> <span class=mi>10000</span>
<span class=n>n_treatment</span> <span class=o>=</span> <span class=mi>10000</span>

<span class=c1># Control group: 2% CTR</span>
<span class=n>control_impressions</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>poisson</span><span class=p>(</span><span class=n>lam</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n_control</span><span class=p>)</span>
<span class=n>control_clicks</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span>
    <span class=n>n</span><span class=o>=</span><span class=n>control_impressions</span><span class=p>,</span> 
    <span class=n>p</span><span class=o>=</span><span class=mf>0.02</span>
<span class=p>)</span>

<span class=c1># Treatment group: 2.3% CTR (15% relative lift)</span>
<span class=n>treatment_impressions</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>poisson</span><span class=p>(</span><span class=n>lam</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n_treatment</span><span class=p>)</span>
<span class=n>treatment_clicks</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span>
    <span class=n>n</span><span class=o>=</span><span class=n>treatment_impressions</span><span class=p>,</span>
    <span class=n>p</span><span class=o>=</span><span class=mf>0.023</span>
<span class=p>)</span>

<span class=c1># Analyze with both methods</span>
<span class=n>analyzer</span> <span class=o>=</span> <span class=n>RatioMetricAnalyzer</span><span class=p>(</span><span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span> <span class=n>n_bootstrap</span><span class=o>=</span><span class=mi>10000</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>80</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;RATIO METRIC ANALYSIS: Click-Through Rate (CTR)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>80</span><span class=p>)</span>

<span class=c1># Delta method</span>
<span class=n>delta_comparison</span> <span class=o>=</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>compare_treatments</span><span class=p>(</span>
    <span class=n>control_clicks</span><span class=p>,</span> <span class=n>control_impressions</span><span class=p>,</span>
    <span class=n>treatment_clicks</span><span class=p>,</span> <span class=n>treatment_impressions</span><span class=p>,</span>
    <span class=n>method</span><span class=o>=</span><span class=s1>&#39;delta&#39;</span>
<span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìä DELTA METHOD RESULTS:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Control CTR:    </span><span class=si>{</span><span class=n>delta_comparison</span><span class=p>[</span><span class=s1>&#39;control_ratio&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2> &quot;</span>
      <span class=sa>f</span><span class=s2>&quot;(95% CI: </span><span class=si>{</span><span class=n>delta_comparison</span><span class=p>[</span><span class=s1>&#39;control_ci&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2> - &quot;</span>
      <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>delta_comparison</span><span class=p>[</span><span class=s1>&#39;control_ci&#39;</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Treatment CTR:  </span><span class=si>{</span><span class=n>delta_comparison</span><span class=p>[</span><span class=s1>&#39;treatment_ratio&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2> &quot;</span>
      <span class=sa>f</span><span class=s2>&quot;(95% CI: </span><span class=si>{</span><span class=n>delta_comparison</span><span class=p>[</span><span class=s1>&#39;treatment_ci&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2> - &quot;</span>
      <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>delta_comparison</span><span class=p>[</span><span class=s1>&#39;treatment_ci&#39;</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Absolute Lift:  </span><span class=si>{</span><span class=n>delta_comparison</span><span class=p>[</span><span class=s1>&#39;absolute_lift&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Relative Lift:  </span><span class=si>{</span><span class=n>delta_comparison</span><span class=p>[</span><span class=s1>&#39;relative_lift&#39;</span><span class=p>]</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;P-value:        </span><span class=si>{</span><span class=n>delta_comparison</span><span class=p>[</span><span class=s1>&#39;p_value&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Significant:    </span><span class=si>{</span><span class=n>delta_comparison</span><span class=p>[</span><span class=s1>&#39;significant&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Bootstrap method</span>
<span class=n>bootstrap_comparison</span> <span class=o>=</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>compare_treatments</span><span class=p>(</span>
    <span class=n>control_clicks</span><span class=p>,</span> <span class=n>control_impressions</span><span class=p>,</span>
    <span class=n>treatment_clicks</span><span class=p>,</span> <span class=n>treatment_impressions</span><span class=p>,</span>
    <span class=n>method</span><span class=o>=</span><span class=s1>&#39;bootstrap&#39;</span>
<span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üîÑ BOOTSTRAP METHOD RESULTS:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Control CTR:    </span><span class=si>{</span><span class=n>bootstrap_comparison</span><span class=p>[</span><span class=s1>&#39;control_ratio&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2> &quot;</span>
      <span class=sa>f</span><span class=s2>&quot;(95% CI: </span><span class=si>{</span><span class=n>bootstrap_comparison</span><span class=p>[</span><span class=s1>&#39;control_ci&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2> - &quot;</span>
      <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>bootstrap_comparison</span><span class=p>[</span><span class=s1>&#39;control_ci&#39;</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Treatment CTR:  </span><span class=si>{</span><span class=n>bootstrap_comparison</span><span class=p>[</span><span class=s1>&#39;treatment_ratio&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2> &quot;</span>
      <span class=sa>f</span><span class=s2>&quot;(95% CI: </span><span class=si>{</span><span class=n>bootstrap_comparison</span><span class=p>[</span><span class=s1>&#39;treatment_ci&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2> - &quot;</span>
      <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>bootstrap_comparison</span><span class=p>[</span><span class=s1>&#39;treatment_ci&#39;</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Relative Lift:  </span><span class=si>{</span><span class=n>bootstrap_comparison</span><span class=p>[</span><span class=s1>&#39;relative_lift&#39;</span><span class=p>]</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;P-value:        </span><span class=si>{</span><span class=n>bootstrap_comparison</span><span class=p>[</span><span class=s1>&#39;p_value&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Output:</span>
<span class=c1># ================================================================================</span>
<span class=c1># RATIO METRIC ANALYSIS: Click-Through Rate (CTR)</span>
<span class=c1># ================================================================================</span>
<span class=c1># </span>
<span class=c1># üìä DELTA METHOD RESULTS:</span>
<span class=c1># Control CTR:    0.0200 (95% CI: 0.0198 - 0.0203)</span>
<span class=c1># Treatment CTR:  0.0230 (95% CI: 0.0227 - 0.0233)</span>
<span class=c1># Absolute Lift:  0.0029</span>
<span class=c1># Relative Lift:  14.72%</span>
<span class=c1># P-value:        0.0000</span>
<span class=c1># Significant:    True</span>
<span class=c1># </span>
<span class=c1># üîÑ BOOTSTRAP METHOD RESULTS:</span>
<span class=c1># Control CTR:    0.0200 (95% CI: 0.0198 - 0.0203)</span>
<span class=c1># Treatment CTR:  0.0230 (95% CI: 0.0227 - 0.0233)</span>
<span class=c1># Relative Lift:  14.72%</span>
<span class=c1># P-value:        0.0000</span>
</code></pre></div> <p><strong>Method Comparison Table:</strong></p> <table> <thead> <tr> <th>Method</th> <th>Time Complexity</th> <th>Assumptions</th> <th>Best Use Case</th> <th>Accuracy</th> </tr> </thead> <tbody> <tr> <td><strong>Delta Method</strong></td> <td>O(n)</td> <td>Normal approx</td> <td>Large samples (n&gt;1000)</td> <td>¬±0.5% error</td> </tr> <tr> <td><strong>Bootstrap</strong></td> <td>O(n * B)</td> <td>None</td> <td>Any sample size</td> <td>¬±0.1% error</td> </tr> <tr> <td><strong>Naive Ratio</strong></td> <td>O(n)</td> <td>Independent num/den</td> <td>‚ùå Never use</td> <td>Biased</td> </tr> </tbody> </table> <p><strong>Real-World Examples with Company Metrics:</strong></p> <table> <thead> <tr> <th>Company</th> <th>Metric Type</th> <th>Challenge</th> <th>Solution</th> <th>Impact</th> </tr> </thead> <tbody> <tr> <td><strong>Netflix</strong></td> <td>Play rate (plays/visits)</td> <td>High variance in visits per user</td> <td>Delta method with stratification by country</td> <td>95% accurate predictions</td> </tr> <tr> <td><strong>Google Ads</strong></td> <td>CTR (clicks/impressions)</td> <td>Users have different impression counts</td> <td>User-level aggregation + bootstrap</td> <td>Reduced false positives by 40%</td> </tr> <tr> <td><strong>Uber</strong></td> <td>Trips per active day</td> <td>Zero-inflated (many 0-trip days)</td> <td>Mixed model: logit(active) + Poisson(trips)</td> <td>Detected 12% lift vs 8% naive</td> </tr> <tr> <td><strong>Amazon</strong></td> <td>Units per order</td> <td>Order size varies 100x</td> <td>Winsorized delta method (99<sup>th</sup> percentile)</td> <td>Reduced outlier impact by 80%</td> </tr> </tbody> </table> <p><strong>User-Level vs Session-Level Analysis:</strong></p> <div class=highlight><pre><span></span><code><span class=c1># User-level ratio (RECOMMENDED)</span>
<span class=n>user_level_ctr</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=s1>&#39;user_id&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>agg</span><span class=p>({</span>
    <span class=s1>&#39;clicks&#39;</span><span class=p>:</span> <span class=s1>&#39;sum&#39;</span><span class=p>,</span>
    <span class=s1>&#39;impressions&#39;</span><span class=p>:</span> <span class=s1>&#39;sum&#39;</span>
<span class=p>})</span>
<span class=n>overall_ctr_user</span> <span class=o>=</span> <span class=n>user_level_ctr</span><span class=p>[</span><span class=s1>&#39;clicks&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span> <span class=o>/</span> <span class=n>user_level_ctr</span><span class=p>[</span><span class=s1>&#39;impressions&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>

<span class=c1># Session-level ratio (USE WITH CAUTION)</span>
<span class=n>session_level_ctr</span> <span class=o>=</span> <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;clicks&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;impressions&#39;</span><span class=p>])</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>

<span class=c1># User-level is correct because:</span>
<span class=c1># 1. Matches randomization unit</span>
<span class=c1># 2. Proper variance estimation</span>
<span class=c1># 3. Avoids Simpson&#39;s Paradox</span>
</code></pre></div> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p><strong>What they're testing:</strong> Understanding of ratio metric complexity, variance estimation methods.</p> <p><strong>Strong answer signals:</strong></p> <ul> <li>Explains why naive ratio is biased (numerator/denominator correlation)</li> <li>Implements delta method correctly (includes covariance term)</li> <li>Knows when bootstrap is better (small samples, non-normal)</li> <li>Matches analysis unit to randomization unit (user-level)</li> <li>Discusses trade-offs: delta method faster, bootstrap more robust</li> </ul> <p><strong>Red flags:</strong></p> <ul> <li>Using simple t-test on ratio</li> <li>Ignoring correlation between numerator and denominator</li> <li>Session-level analysis with user-level randomization</li> </ul> <p><strong>Follow-up questions:</strong></p> <ul> <li>"What if denominator can be zero?" (Fieller's theorem, exclude zeros)</li> <li>"How to handle extreme ratios?" (Winsorize, log-transform)</li> <li>"What if ratio distribution is skewed?" (Bootstrap, log-ratio)</li> </ul> </div> </details> <hr> <h3 id=what-is-sensitivity-analysis-netflix-uber-interview-question>What is Sensitivity Analysis? - Netflix, Uber Interview Question</h3> <p><strong>Difficulty:</strong> üü° Medium | <strong>Tags:</strong> <code>Robustness</code> | <strong>Asked by:</strong> Netflix, Uber, Airbnb</p> <details class=success> <summary>View Answer</summary> <p><strong>Purpose:</strong> Test if experimental conclusions are robust to analytical choices, assumptions, and edge cases. Critical before launch decisions.</p> <p><strong>Sensitivity Analysis Framework:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      Sensitivity Analysis                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                       ‚îÇ
‚îÇ  Base Analysis                                                       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                               ‚îÇ
‚îÇ  ‚îÇ Primary Metric   ‚îÇ                                               ‚îÇ
‚îÇ  ‚îÇ Full Dataset     ‚îÇ ‚îÄ‚îÄ‚ñ∫ Result: +5% lift, p=0.02                 ‚îÇ
‚îÇ  ‚îÇ Standard Method  ‚îÇ                                               ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                               ‚îÇ
‚îÇ           ‚îÇ                                                          ‚îÇ
‚îÇ           ‚îú‚îÄ‚îÄ‚ñ∫ Robustness Checks:                                   ‚îÇ
‚îÇ           ‚îÇ                                                          ‚îÇ
‚îÇ           ‚îú‚îÄ‚ñ∫ Time Periods                                          ‚îÇ
‚îÇ           ‚îÇ    ‚îú‚îÄ Week 1 only                                       ‚îÇ
‚îÇ           ‚îÇ    ‚îú‚îÄ Week 2 only                                       ‚îÇ
‚îÇ           ‚îÇ    ‚îî‚îÄ Exclude weekends                                  ‚îÇ
‚îÇ           ‚îÇ                                                          ‚îÇ
‚îÇ           ‚îú‚îÄ‚ñ∫ Outlier Treatment                                     ‚îÇ
‚îÇ           ‚îÇ    ‚îú‚îÄ Winsorize 1%                                      ‚îÇ
‚îÇ           ‚îÇ    ‚îú‚îÄ Winsorize 5%                                      ‚îÇ
‚îÇ           ‚îÇ    ‚îî‚îÄ Remove top 0.1%                                   ‚îÇ
‚îÇ           ‚îÇ                                                          ‚îÇ
‚îÇ           ‚îú‚îÄ‚ñ∫ Segments                                              ‚îÇ
‚îÇ           ‚îÇ    ‚îú‚îÄ Desktop only                                      ‚îÇ
‚îÇ           ‚îÇ    ‚îú‚îÄ Mobile only                                       ‚îÇ
‚îÇ           ‚îÇ    ‚îî‚îÄ By country                                        ‚îÇ
‚îÇ           ‚îÇ                                                          ‚îÇ
‚îÇ           ‚îî‚îÄ‚ñ∫ Alternative Methods                                   ‚îÇ
‚îÇ                ‚îú‚îÄ Mann-Whitney U                                    ‚îÇ
‚îÇ                ‚îú‚îÄ Permutation test                                  ‚îÇ
‚îÇ                ‚îî‚îÄ Bootstrap                                         ‚îÇ
‚îÇ                                                                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Production Implementation - Comprehensive Sensitivity Analyzer:</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>List</span><span class=p>,</span> <span class=n>Callable</span><span class=p>,</span> <span class=n>Tuple</span>
<span class=kn>from</span><span class=w> </span><span class=nn>dataclasses</span><span class=w> </span><span class=kn>import</span> <span class=n>dataclass</span>
<span class=kn>import</span><span class=w> </span><span class=nn>warnings</span>

<span class=nd>@dataclass</span>
<span class=k>class</span><span class=w> </span><span class=nc>SensitivityResult</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Container for sensitivity check results&quot;&quot;&quot;</span>
    <span class=n>check_name</span><span class=p>:</span> <span class=nb>str</span>
    <span class=n>effect_size</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>p_value</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>ci_lower</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>ci_upper</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>sample_size</span><span class=p>:</span> <span class=nb>int</span>
    <span class=n>significant</span><span class=p>:</span> <span class=nb>bool</span>

<span class=k>class</span><span class=w> </span><span class=nc>SensitivityAnalyzer</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Comprehensive sensitivity analysis for A/B test results.</span>
<span class=sd>    Tests robustness across multiple dimensions.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>alpha</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.05</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>=</span> <span class=n>alpha</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>results</span> <span class=o>=</span> <span class=p>[]</span>

    <span class=k>def</span><span class=w> </span><span class=nf>baseline_analysis</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>control</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> 
                         <span class=n>treatment</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span>
                         <span class=n>name</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&quot;Baseline&quot;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>SensitivityResult</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Standard t-test baseline&quot;&quot;&quot;</span>
        <span class=n>stat</span><span class=p>,</span> <span class=n>p_value</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span><span class=n>treatment</span><span class=p>,</span> <span class=n>control</span><span class=p>)</span>
        <span class=n>effect</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>treatment</span><span class=p>)</span> <span class=o>-</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>control</span><span class=p>)</span>

        <span class=c1># Cohen&#39;s d</span>
        <span class=n>pooled_std</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>((</span><span class=n>np</span><span class=o>.</span><span class=n>var</span><span class=p>(</span><span class=n>control</span><span class=p>,</span> <span class=n>ddof</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>var</span><span class=p>(</span><span class=n>treatment</span><span class=p>,</span> <span class=n>ddof</span><span class=o>=</span><span class=mi>1</span><span class=p>))</span> <span class=o>/</span> <span class=mi>2</span><span class=p>)</span>
        <span class=n>cohens_d</span> <span class=o>=</span> <span class=n>effect</span> <span class=o>/</span> <span class=n>pooled_std</span> <span class=k>if</span> <span class=n>pooled_std</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>

        <span class=c1># Confidence interval</span>
        <span class=n>se_diff</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>var</span><span class=p>(</span><span class=n>control</span><span class=p>,</span> <span class=n>ddof</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=o>/</span><span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>)</span> <span class=o>+</span> 
                         <span class=n>np</span><span class=o>.</span><span class=n>var</span><span class=p>(</span><span class=n>treatment</span><span class=p>,</span> <span class=n>ddof</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=o>/</span><span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>))</span>
        <span class=n>ci_lower</span> <span class=o>=</span> <span class=n>effect</span> <span class=o>-</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=n>se_diff</span>
        <span class=n>ci_upper</span> <span class=o>=</span> <span class=n>effect</span> <span class=o>+</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=n>se_diff</span>

        <span class=n>result</span> <span class=o>=</span> <span class=n>SensitivityResult</span><span class=p>(</span>
            <span class=n>check_name</span><span class=o>=</span><span class=n>name</span><span class=p>,</span>
            <span class=n>effect_size</span><span class=o>=</span><span class=n>effect</span><span class=p>,</span>
            <span class=n>p_value</span><span class=o>=</span><span class=n>p_value</span><span class=p>,</span>
            <span class=n>ci_lower</span><span class=o>=</span><span class=n>ci_lower</span><span class=p>,</span>
            <span class=n>ci_upper</span><span class=o>=</span><span class=n>ci_upper</span><span class=p>,</span>
            <span class=n>sample_size</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>)</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>),</span>
            <span class=n>significant</span><span class=o>=</span><span class=n>p_value</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span>
        <span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>result</span>

    <span class=k>def</span><span class=w> </span><span class=nf>time_period_sensitivity</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span>
                               <span class=n>metric_col</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> 
                               <span class=n>treatment_col</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
                               <span class=n>date_col</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>SensitivityResult</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Test sensitivity across time periods&quot;&quot;&quot;</span>
        <span class=n>time_results</span> <span class=o>=</span> <span class=p>[]</span>

        <span class=c1># Week-by-week</span>
        <span class=n>df</span><span class=p>[</span><span class=s1>&#39;week&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>to_datetime</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=n>date_col</span><span class=p>])</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>isocalendar</span><span class=p>()</span><span class=o>.</span><span class=n>week</span>
        <span class=k>for</span> <span class=n>week</span> <span class=ow>in</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;week&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>unique</span><span class=p>():</span>
            <span class=n>week_data</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;week&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>week</span><span class=p>]</span>
            <span class=n>control</span> <span class=o>=</span> <span class=n>week_data</span><span class=p>[</span><span class=n>week_data</span><span class=p>[</span><span class=n>treatment_col</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>][</span><span class=n>metric_col</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
            <span class=n>treatment</span> <span class=o>=</span> <span class=n>week_data</span><span class=p>[</span><span class=n>week_data</span><span class=p>[</span><span class=n>treatment_col</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>][</span><span class=n>metric_col</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>

            <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>baseline_analysis</span><span class=p>(</span><span class=n>control</span><span class=p>,</span> <span class=n>treatment</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&quot;Week_</span><span class=si>{</span><span class=n>week</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
            <span class=n>time_results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>

        <span class=c1># Weekday vs Weekend</span>
        <span class=n>df</span><span class=p>[</span><span class=s1>&#39;is_weekend&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>to_datetime</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=n>date_col</span><span class=p>])</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>dayofweek</span> <span class=o>&gt;=</span> <span class=mi>5</span>

        <span class=k>for</span> <span class=n>is_weekend</span> <span class=ow>in</span> <span class=p>[</span><span class=kc>False</span><span class=p>,</span> <span class=kc>True</span><span class=p>]:</span>
            <span class=n>subset</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;is_weekend&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>is_weekend</span><span class=p>]</span>
            <span class=n>control</span> <span class=o>=</span> <span class=n>subset</span><span class=p>[</span><span class=n>subset</span><span class=p>[</span><span class=n>treatment_col</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>][</span><span class=n>metric_col</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
            <span class=n>treatment</span> <span class=o>=</span> <span class=n>subset</span><span class=p>[</span><span class=n>subset</span><span class=p>[</span><span class=n>treatment_col</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>][</span><span class=n>metric_col</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>

            <span class=n>period_name</span> <span class=o>=</span> <span class=s2>&quot;Weekend&quot;</span> <span class=k>if</span> <span class=n>is_weekend</span> <span class=k>else</span> <span class=s2>&quot;Weekday&quot;</span>
            <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>baseline_analysis</span><span class=p>(</span><span class=n>control</span><span class=p>,</span> <span class=n>treatment</span><span class=p>,</span> <span class=n>period_name</span><span class=p>)</span>
            <span class=n>time_results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>

        <span class=k>return</span> <span class=n>time_results</span>

    <span class=k>def</span><span class=w> </span><span class=nf>outlier_sensitivity</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>control</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span>
                           <span class=n>treatment</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>SensitivityResult</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Test sensitivity to outlier treatment&quot;&quot;&quot;</span>
        <span class=n>outlier_results</span> <span class=o>=</span> <span class=p>[]</span>

        <span class=c1># Original</span>
        <span class=n>outlier_results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>baseline_analysis</span><span class=p>(</span><span class=n>control</span><span class=p>,</span> <span class=n>treatment</span><span class=p>,</span> <span class=s2>&quot;Original (no treatment)&quot;</span><span class=p>)</span>
        <span class=p>)</span>

        <span class=c1># Winsorization at different levels</span>
        <span class=k>for</span> <span class=n>percentile</span> <span class=ow>in</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>10</span><span class=p>]:</span>
            <span class=n>lower_p</span> <span class=o>=</span> <span class=n>percentile</span>
            <span class=n>upper_p</span> <span class=o>=</span> <span class=mi>100</span> <span class=o>-</span> <span class=n>percentile</span>

            <span class=n>control_wins</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>clip</span><span class=p>(</span>
                <span class=n>control</span><span class=p>,</span>
                <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>control</span><span class=p>,</span> <span class=n>lower_p</span><span class=p>),</span>
                <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>control</span><span class=p>,</span> <span class=n>upper_p</span><span class=p>)</span>
            <span class=p>)</span>
            <span class=n>treatment_wins</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>clip</span><span class=p>(</span>
                <span class=n>treatment</span><span class=p>,</span>
                <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>treatment</span><span class=p>,</span> <span class=n>lower_p</span><span class=p>),</span>
                <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>treatment</span><span class=p>,</span> <span class=n>upper_p</span><span class=p>)</span>
            <span class=p>)</span>

            <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>baseline_analysis</span><span class=p>(</span>
                <span class=n>control_wins</span><span class=p>,</span> <span class=n>treatment_wins</span><span class=p>,</span> 
                <span class=sa>f</span><span class=s2>&quot;Winsorize_</span><span class=si>{</span><span class=n>percentile</span><span class=si>}</span><span class=s2>%&quot;</span>
            <span class=p>)</span>
            <span class=n>outlier_results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>

        <span class=c1># Remove extreme outliers (3 IQR rule)</span>
        <span class=k>def</span><span class=w> </span><span class=nf>remove_outliers</span><span class=p>(</span><span class=n>data</span><span class=p>):</span>
            <span class=n>q1</span><span class=p>,</span> <span class=n>q3</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=p>[</span><span class=mi>25</span><span class=p>,</span> <span class=mi>75</span><span class=p>])</span>
            <span class=n>iqr</span> <span class=o>=</span> <span class=n>q3</span> <span class=o>-</span> <span class=n>q1</span>
            <span class=n>lower</span> <span class=o>=</span> <span class=n>q1</span> <span class=o>-</span> <span class=mi>3</span> <span class=o>*</span> <span class=n>iqr</span>
            <span class=n>upper</span> <span class=o>=</span> <span class=n>q3</span> <span class=o>+</span> <span class=mi>3</span> <span class=o>*</span> <span class=n>iqr</span>
            <span class=k>return</span> <span class=n>data</span><span class=p>[(</span><span class=n>data</span> <span class=o>&gt;=</span> <span class=n>lower</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>data</span> <span class=o>&lt;=</span> <span class=n>upper</span><span class=p>)]</span>

        <span class=n>control_clean</span> <span class=o>=</span> <span class=n>remove_outliers</span><span class=p>(</span><span class=n>control</span><span class=p>)</span>
        <span class=n>treatment_clean</span> <span class=o>=</span> <span class=n>remove_outliers</span><span class=p>(</span><span class=n>treatment</span><span class=p>)</span>

        <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>baseline_analysis</span><span class=p>(</span>
            <span class=n>control_clean</span><span class=p>,</span> <span class=n>treatment_clean</span><span class=p>,</span>
            <span class=s2>&quot;Remove_3IQR_outliers&quot;</span>
        <span class=p>)</span>
        <span class=n>outlier_results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>

        <span class=k>return</span> <span class=n>outlier_results</span>

    <span class=k>def</span><span class=w> </span><span class=nf>method_sensitivity</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>control</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span>
                          <span class=n>treatment</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>SensitivityResult</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Test sensitivity to statistical method&quot;&quot;&quot;</span>
        <span class=n>method_results</span> <span class=o>=</span> <span class=p>[]</span>

        <span class=c1># Parametric t-test</span>
        <span class=n>method_results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>baseline_analysis</span><span class=p>(</span><span class=n>control</span><span class=p>,</span> <span class=n>treatment</span><span class=p>,</span> <span class=s2>&quot;t-test&quot;</span><span class=p>)</span>
        <span class=p>)</span>

        <span class=c1># Non-parametric Mann-Whitney U</span>
        <span class=n>stat</span><span class=p>,</span> <span class=n>p_value</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>mannwhitneyu</span><span class=p>(</span><span class=n>treatment</span><span class=p>,</span> <span class=n>control</span><span class=p>,</span> <span class=n>alternative</span><span class=o>=</span><span class=s1>&#39;two-sided&#39;</span><span class=p>)</span>
        <span class=n>effect</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>median</span><span class=p>(</span><span class=n>treatment</span><span class=p>)</span> <span class=o>-</span> <span class=n>np</span><span class=o>.</span><span class=n>median</span><span class=p>(</span><span class=n>control</span><span class=p>)</span>

        <span class=n>method_results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>SensitivityResult</span><span class=p>(</span>
            <span class=n>check_name</span><span class=o>=</span><span class=s2>&quot;Mann-Whitney U&quot;</span><span class=p>,</span>
            <span class=n>effect_size</span><span class=o>=</span><span class=n>effect</span><span class=p>,</span>
            <span class=n>p_value</span><span class=o>=</span><span class=n>p_value</span><span class=p>,</span>
            <span class=n>ci_lower</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>  <span class=c1># Bootstrap for CI</span>
            <span class=n>ci_upper</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>,</span>
            <span class=n>sample_size</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>)</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>),</span>
            <span class=n>significant</span><span class=o>=</span><span class=n>p_value</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span>
        <span class=p>))</span>

        <span class=c1># Permutation test</span>
        <span class=n>observed_diff</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>treatment</span><span class=p>)</span> <span class=o>-</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>control</span><span class=p>)</span>
        <span class=n>combined</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>([</span><span class=n>control</span><span class=p>,</span> <span class=n>treatment</span><span class=p>])</span>
        <span class=n>n_control</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>)</span>

        <span class=n>perm_diffs</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>5000</span><span class=p>):</span>
            <span class=n>perm</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>permutation</span><span class=p>(</span><span class=n>combined</span><span class=p>)</span>
            <span class=n>perm_control</span> <span class=o>=</span> <span class=n>perm</span><span class=p>[:</span><span class=n>n_control</span><span class=p>]</span>
            <span class=n>perm_treatment</span> <span class=o>=</span> <span class=n>perm</span><span class=p>[</span><span class=n>n_control</span><span class=p>:]</span>
            <span class=n>perm_diffs</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>perm_treatment</span><span class=p>)</span> <span class=o>-</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>perm_control</span><span class=p>))</span>

        <span class=n>p_value_perm</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>perm_diffs</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=nb>abs</span><span class=p>(</span><span class=n>observed_diff</span><span class=p>))</span>

        <span class=n>method_results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>SensitivityResult</span><span class=p>(</span>
            <span class=n>check_name</span><span class=o>=</span><span class=s2>&quot;Permutation Test&quot;</span><span class=p>,</span>
            <span class=n>effect_size</span><span class=o>=</span><span class=n>observed_diff</span><span class=p>,</span>
            <span class=n>p_value</span><span class=o>=</span><span class=n>p_value_perm</span><span class=p>,</span>
            <span class=n>ci_lower</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>perm_diffs</span><span class=p>,</span> <span class=mf>2.5</span><span class=p>),</span>
            <span class=n>ci_upper</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>perm_diffs</span><span class=p>,</span> <span class=mf>97.5</span><span class=p>),</span>
            <span class=n>sample_size</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>)</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>),</span>
            <span class=n>significant</span><span class=o>=</span><span class=n>p_value_perm</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span>
        <span class=p>))</span>

        <span class=k>return</span> <span class=n>method_results</span>

    <span class=k>def</span><span class=w> </span><span class=nf>generate_report</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Generate summary report of all sensitivity checks&quot;&quot;&quot;</span>
        <span class=n>report_data</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=k>for</span> <span class=n>result</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>:</span>
            <span class=n>report_data</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
                <span class=s1>&#39;Check&#39;</span><span class=p>:</span> <span class=n>result</span><span class=o>.</span><span class=n>check_name</span><span class=p>,</span>
                <span class=s1>&#39;Effect Size&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>effect_size</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
                <span class=s1>&#39;P-value&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>p_value</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
                <span class=s1>&#39;CI&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&quot;[</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>ci_lower</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>ci_upper</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>]&quot;</span> <span class=k>if</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>isnan</span><span class=p>(</span><span class=n>result</span><span class=o>.</span><span class=n>ci_lower</span><span class=p>)</span> <span class=k>else</span> <span class=s2>&quot;N/A&quot;</span><span class=p>,</span>
                <span class=s1>&#39;Significant&#39;</span><span class=p>:</span> <span class=s1>&#39;‚úì&#39;</span> <span class=k>if</span> <span class=n>result</span><span class=o>.</span><span class=n>significant</span> <span class=k>else</span> <span class=s1>&#39;‚úó&#39;</span><span class=p>,</span>
                <span class=s1>&#39;N&#39;</span><span class=p>:</span> <span class=n>result</span><span class=o>.</span><span class=n>sample_size</span>
            <span class=p>})</span>

        <span class=k>return</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>report_data</span><span class=p>)</span>

<span class=c1># Example: Revenue Metric Sensitivity Analysis</span>
<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>

<span class=c1># Simulate revenue data with outliers</span>
<span class=n>n</span> <span class=o>=</span> <span class=mi>5000</span>
<span class=n>control_revenue</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>gamma</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>scale</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n</span><span class=p>)</span>
<span class=n>treatment_revenue</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>gamma</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>scale</span><span class=o>=</span><span class=mi>52</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n</span><span class=p>)</span>  <span class=c1># 4% lift</span>

<span class=c1># Add extreme outliers (whales)</span>
<span class=n>control_revenue</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=mi>10</span><span class=p>)]</span> <span class=o>*=</span> <span class=mi>20</span>
<span class=n>treatment_revenue</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=mi>10</span><span class=p>)]</span> <span class=o>*=</span> <span class=mi>20</span>

<span class=c1># Run comprehensive sensitivity analysis</span>
<span class=n>analyzer</span> <span class=o>=</span> <span class=n>SensitivityAnalyzer</span><span class=p>(</span><span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>80</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;SENSITIVITY ANALYSIS REPORT: Revenue Metric&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>80</span><span class=p>)</span>

<span class=c1># Baseline</span>
<span class=n>baseline</span> <span class=o>=</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>baseline_analysis</span><span class=p>(</span><span class=n>control_revenue</span><span class=p>,</span> <span class=n>treatment_revenue</span><span class=p>,</span> <span class=s2>&quot;Baseline&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìä BASELINE ANALYSIS:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Effect: $</span><span class=si>{</span><span class=n>baseline</span><span class=o>.</span><span class=n>effect_size</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>, P-value: </span><span class=si>{</span><span class=n>baseline</span><span class=o>.</span><span class=n>p_value</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Outlier sensitivity</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üéØ OUTLIER SENSITIVITY:&quot;</span><span class=p>)</span>
<span class=n>outlier_results</span> <span class=o>=</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>outlier_sensitivity</span><span class=p>(</span><span class=n>control_revenue</span><span class=p>,</span> <span class=n>treatment_revenue</span><span class=p>)</span>
<span class=k>for</span> <span class=n>result</span> <span class=ow>in</span> <span class=n>outlier_results</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>check_name</span><span class=si>:</span><span class=s2>30s</span><span class=si>}</span><span class=s2> Effect: $</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>effect_size</span><span class=si>:</span><span class=s2>8.2f</span><span class=si>}</span><span class=s2>  &quot;</span>
          <span class=sa>f</span><span class=s2>&quot;P-value: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>p_value</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>  </span><span class=si>{</span><span class=s1>&#39;‚úì&#39;</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>result</span><span class=o>.</span><span class=n>significant</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=s1>&#39;‚úó&#39;</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Method sensitivity</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üî¨ METHOD SENSITIVITY:&quot;</span><span class=p>)</span>
<span class=n>method_results</span> <span class=o>=</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>method_sensitivity</span><span class=p>(</span><span class=n>control_revenue</span><span class=p>,</span> <span class=n>treatment_revenue</span><span class=p>)</span>
<span class=k>for</span> <span class=n>result</span> <span class=ow>in</span> <span class=n>method_results</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>check_name</span><span class=si>:</span><span class=s2>30s</span><span class=si>}</span><span class=s2> Effect: $</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>effect_size</span><span class=si>:</span><span class=s2>8.2f</span><span class=si>}</span><span class=s2>  &quot;</span>
          <span class=sa>f</span><span class=s2>&quot;P-value: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>p_value</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>  </span><span class=si>{</span><span class=s1>&#39;‚úì&#39;</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>result</span><span class=o>.</span><span class=n>significant</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=s1>&#39;‚úó&#39;</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Summary table</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>80</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;SUMMARY TABLE:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>80</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>analyzer</span><span class=o>.</span><span class=n>generate_report</span><span class=p>()</span><span class=o>.</span><span class=n>to_string</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>))</span>

<span class=c1># Check consistency</span>
<span class=n>significant_count</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=mi>1</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>results</span> <span class=k>if</span> <span class=n>r</span><span class=o>.</span><span class=n>significant</span><span class=p>)</span>
<span class=n>total_checks</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>analyzer</span><span class=o>.</span><span class=n>results</span><span class=p>)</span>
<span class=n>consistency_rate</span> <span class=o>=</span> <span class=n>significant_count</span> <span class=o>/</span> <span class=n>total_checks</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìà ROBUSTNESS SCORE: </span><span class=si>{</span><span class=n>consistency_rate</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>% of checks significant&quot;</span><span class=p>)</span>

<span class=k>if</span> <span class=n>consistency_rate</span> <span class=o>&gt;</span> <span class=mf>0.8</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;‚úì DECISION: Strong evidence - SHIP&quot;</span><span class=p>)</span>
<span class=k>elif</span> <span class=n>consistency_rate</span> <span class=o>&gt;</span> <span class=mf>0.5</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;‚ö† DECISION: Moderate evidence - CONSIDER MORE DATA&quot;</span><span class=p>)</span>
<span class=k>else</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;‚úó DECISION: Weak evidence - DO NOT SHIP&quot;</span><span class=p>)</span>
</code></pre></div> <p><strong>Sensitivity Dimensions Table:</strong></p> <table> <thead> <tr> <th>Dimension</th> <th>Checks</th> <th>Purpose</th> <th>Interpretation</th> </tr> </thead> <tbody> <tr> <td><strong>Time Period</strong></td> <td>Week-by-week, weekday/weekend, first/last week</td> <td>Temporal stability</td> <td>All periods show lift ‚Üí stable effect</td> </tr> <tr> <td><strong>Outliers</strong></td> <td>Winsorize &#8533;/10%, Remove 3-IQR</td> <td>Robustness to extremes</td> <td>Effect persists ‚Üí not driven by whales</td> </tr> <tr> <td><strong>Segments</strong></td> <td>Device, country, new/returning</td> <td>Heterogeneity</td> <td>Effect in all segments ‚Üí universal</td> </tr> <tr> <td><strong>Methods</strong></td> <td>t-test, Mann-Whitney, permutation, bootstrap</td> <td>Distributional assumptions</td> <td>All methods agree ‚Üí robust</td> </tr> </tbody> </table> <p><strong>Real-World Examples with Company Metrics:</strong></p> <table> <thead> <tr> <th>Company</th> <th>Metric</th> <th>Sensitivity Issue</th> <th>Solution</th> <th>Outcome</th> </tr> </thead> <tbody> <tr> <td><strong>Netflix</strong></td> <td>Watch time</td> <td>Weekday vs weekend patterns differ</td> <td>Separate analysis by day type</td> <td>Found 10% weekday lift, 5% weekend lift</td> </tr> <tr> <td><strong>Uber</strong></td> <td>Trips per user</td> <td>Top 0.1% users drive 30% of trips</td> <td>Winsorize at 99<sup>th</sup> percentile</td> <td>Reduced from 15% lift to 8% (true effect)</td> </tr> <tr> <td><strong>Airbnb</strong></td> <td>Booking rate</td> <td>Different by season</td> <td>Stratify by month, use regression adjustment</td> <td>Confirmed 5% lift across all seasons</td> </tr> <tr> <td><strong>Meta</strong></td> <td>Session duration</td> <td>First week novelty effect</td> <td>Exclude first 3 days from analysis</td> <td>Effect dropped from 20% to 12%</td> </tr> </tbody> </table> <p><strong>Decision Framework:</strong></p> <table> <thead> <tr> <th>Consistency Rate</th> <th>Decision</th> <th>Action</th> </tr> </thead> <tbody> <tr> <td><strong>&gt;80% significant</strong></td> <td>üü¢ Strong evidence</td> <td>Ship confidently</td> </tr> <tr> <td><strong>50-80% significant</strong></td> <td>üü° Moderate evidence</td> <td>Collect more data or segment</td> </tr> <tr> <td><strong>&lt;50% significant</strong></td> <td>üî¥ Weak evidence</td> <td>Do not ship</td> </tr> </tbody> </table> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p><strong>What they're testing:</strong> Rigor, understanding of robustness, decision-making under uncertainty.</p> <p><strong>Strong answer signals:</strong></p> <ul> <li>Tests multiple dimensions (time, outliers, methods, segments)</li> <li>Quantifies consistency across checks (e.g., "80% of checks significant")</li> <li>Explains trade-offs (winsorizing reduces power but increases robustness)</li> <li>Knows when to adjust (e.g., exclude first week for novelty effects)</li> <li>Makes clear recommendation based on sensitivity results</li> </ul> <p><strong>Red flags:</strong></p> <ul> <li>Only runs one analysis configuration</li> <li>Ignores time periods or outliers</li> <li>Can't explain why results might differ across checks</li> </ul> <p><strong>Follow-up questions:</strong></p> <ul> <li>"What if different checks give opposite conclusions?" (Report both, investigate heterogeneity)</li> <li>"How many sensitivity checks is enough?" (Cover major assumptions, not exhaustive)</li> <li>"What if outlier treatment changes conclusion?" (Flag as inconclusive, need more data)</li> </ul> </div> </details> <hr> <h3 id=how-to-communicate-results-to-stakeholders-all-companies-interview-question>How to Communicate Results to Stakeholders? - All Companies Interview Question</h3> <p><strong>Difficulty:</strong> üü° Medium | <strong>Tags:</strong> <code>Communication</code> | <strong>Asked by:</strong> All Companies</p> <details class=success> <summary>View Answer</summary> <p><strong>Effective communication</strong> of A/B test results requires <strong>tailoring content</strong> to your audience‚Äîexecutives need business impact, product managers need actionable insights, and engineers need technical details. The goal is to <strong>drive decisions</strong> with clarity and confidence while being <strong>honest about limitations</strong>.</p> <p><strong>Communication Framework:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              A/B Test Results Communication Flow                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ   Analysis   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ    Report    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Decision   ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ   Complete   ‚îÇ     ‚îÇ  Generation  ‚îÇ     ‚îÇ   Meeting    ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ         ‚îÇ                     ‚îÇ                     ‚îÇ           ‚îÇ
‚îÇ         ‚Üì                     ‚Üì                     ‚Üì           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ  ‚îÇ  Stakeholder-Specific Content                         ‚îÇ     ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§     ‚îÇ
‚îÇ  ‚îÇ  Executive:   1-pager with decision + impact         ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  Product:     Detailed slides with segments          ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  Engineering: Technical appendix with methods        ‚îÇ     ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Report Structure (Pyramid Principle):</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>import</span><span class=w> </span><span class=nn>matplotlib.pyplot</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>plt</span>
<span class=kn>import</span><span class=w> </span><span class=nn>seaborn</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>sns</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>from</span><span class=w> </span><span class=nn>datetime</span><span class=w> </span><span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timedelta</span>

<span class=c1># Production: Comprehensive Stakeholder Communication System</span>

<span class=k>class</span><span class=w> </span><span class=nc>ABTestReporter</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Generate stakeholder-appropriate A/B test reports with visualizations.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>experiment_name</span><span class=p>,</span> <span class=n>start_date</span><span class=p>,</span> <span class=n>end_date</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>experiment_name</span> <span class=o>=</span> <span class=n>experiment_name</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>start_date</span> <span class=o>=</span> <span class=n>start_date</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>end_date</span> <span class=o>=</span> <span class=n>end_date</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>results</span> <span class=o>=</span> <span class=p>{}</span>

    <span class=k>def</span><span class=w> </span><span class=nf>analyze_test</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>control_data</span><span class=p>,</span> <span class=n>treatment_data</span><span class=p>,</span> <span class=n>metric_name</span><span class=p>,</span> 
                    <span class=n>metric_type</span><span class=o>=</span><span class=s1>&#39;continuous&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Analyze A/B test and store results.</span>

<span class=sd>        metric_type: &#39;continuous&#39; or &#39;proportion&#39;</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=n>metric_type</span> <span class=o>==</span> <span class=s1>&#39;continuous&#39;</span><span class=p>:</span>
            <span class=c1># Welch&#39;s t-test for continuous metrics</span>
            <span class=n>t_stat</span><span class=p>,</span> <span class=n>p_value</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span><span class=n>treatment_data</span><span class=p>,</span> <span class=n>control_data</span><span class=p>,</span> 
                                               <span class=n>equal_var</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
            <span class=n>control_mean</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>control_data</span><span class=p>)</span>
            <span class=n>treatment_mean</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>treatment_data</span><span class=p>)</span>
            <span class=n>control_se</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>sem</span><span class=p>(</span><span class=n>control_data</span><span class=p>)</span>
            <span class=n>treatment_se</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>sem</span><span class=p>(</span><span class=n>treatment_data</span><span class=p>)</span>

            <span class=c1># Confidence interval for difference</span>
            <span class=n>diff</span> <span class=o>=</span> <span class=n>treatment_mean</span> <span class=o>-</span> <span class=n>control_mean</span>
            <span class=n>se_diff</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>control_se</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>treatment_se</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span>
            <span class=n>ci_lower</span> <span class=o>=</span> <span class=n>diff</span> <span class=o>-</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=n>se_diff</span>
            <span class=n>ci_upper</span> <span class=o>=</span> <span class=n>diff</span> <span class=o>+</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=n>se_diff</span>

        <span class=k>else</span><span class=p>:</span>  <span class=c1># proportion</span>
            <span class=c1># Z-test for proportions</span>
            <span class=n>n_control</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>control_data</span><span class=p>)</span>
            <span class=n>n_treatment</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>treatment_data</span><span class=p>)</span>
            <span class=n>p_control</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>control_data</span><span class=p>)</span>
            <span class=n>p_treatment</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>treatment_data</span><span class=p>)</span>

            <span class=c1># Pooled proportion</span>
            <span class=n>p_pooled</span> <span class=o>=</span> <span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>control_data</span><span class=p>)</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>treatment_data</span><span class=p>))</span> <span class=o>/</span> <span class=p>(</span><span class=n>n_control</span> <span class=o>+</span> <span class=n>n_treatment</span><span class=p>)</span>
            <span class=n>se_pooled</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>p_pooled</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>p_pooled</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span><span class=o>/</span><span class=n>n_control</span> <span class=o>+</span> <span class=mi>1</span><span class=o>/</span><span class=n>n_treatment</span><span class=p>))</span>

            <span class=n>z_stat</span> <span class=o>=</span> <span class=p>(</span><span class=n>p_treatment</span> <span class=o>-</span> <span class=n>p_control</span><span class=p>)</span> <span class=o>/</span> <span class=n>se_pooled</span>
            <span class=n>p_value</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>stats</span><span class=o>.</span><span class=n>norm</span><span class=o>.</span><span class=n>cdf</span><span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>z_stat</span><span class=p>)))</span>

            <span class=n>control_mean</span> <span class=o>=</span> <span class=n>p_control</span>
            <span class=n>treatment_mean</span> <span class=o>=</span> <span class=n>p_treatment</span>

            <span class=c1># CI for difference in proportions</span>
            <span class=n>diff</span> <span class=o>=</span> <span class=n>treatment_mean</span> <span class=o>-</span> <span class=n>control_mean</span>
            <span class=n>se_diff</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>p_control</span><span class=o>*</span><span class=p>(</span><span class=mi>1</span><span class=o>-</span><span class=n>p_control</span><span class=p>)</span><span class=o>/</span><span class=n>n_control</span> <span class=o>+</span> 
                             <span class=n>p_treatment</span><span class=o>*</span><span class=p>(</span><span class=mi>1</span><span class=o>-</span><span class=n>p_treatment</span><span class=p>)</span><span class=o>/</span><span class=n>n_treatment</span><span class=p>)</span>
            <span class=n>ci_lower</span> <span class=o>=</span> <span class=n>diff</span> <span class=o>-</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=n>se_diff</span>
            <span class=n>ci_upper</span> <span class=o>=</span> <span class=n>diff</span> <span class=o>+</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=n>se_diff</span>

        <span class=c1># Store results</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>[</span><span class=n>metric_name</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s1>&#39;control_mean&#39;</span><span class=p>:</span> <span class=n>control_mean</span><span class=p>,</span>
            <span class=s1>&#39;treatment_mean&#39;</span><span class=p>:</span> <span class=n>treatment_mean</span><span class=p>,</span>
            <span class=s1>&#39;absolute_lift&#39;</span><span class=p>:</span> <span class=n>diff</span><span class=p>,</span>
            <span class=s1>&#39;relative_lift&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>treatment_mean</span> <span class=o>/</span> <span class=n>control_mean</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=mi>100</span><span class=p>,</span>
            <span class=s1>&#39;p_value&#39;</span><span class=p>:</span> <span class=n>p_value</span><span class=p>,</span>
            <span class=s1>&#39;significant&#39;</span><span class=p>:</span> <span class=n>p_value</span> <span class=o>&lt;</span> <span class=n>alpha</span><span class=p>,</span>
            <span class=s1>&#39;ci_lower&#39;</span><span class=p>:</span> <span class=n>ci_lower</span><span class=p>,</span>
            <span class=s1>&#39;ci_upper&#39;</span><span class=p>:</span> <span class=n>ci_upper</span><span class=p>,</span>
            <span class=s1>&#39;sample_size_control&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>control_data</span><span class=p>),</span>
            <span class=s1>&#39;sample_size_treatment&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>treatment_data</span><span class=p>)</span>
        <span class=p>}</span>

        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>[</span><span class=n>metric_name</span><span class=p>]</span>

    <span class=k>def</span><span class=w> </span><span class=nf>generate_executive_summary</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>primary_metric</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        1-page executive summary: Decision + Impact + Next Steps</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>[</span><span class=n>primary_metric</span><span class=p>]</span>

        <span class=n>summary</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;&quot;&quot;</span>
<span class=s2>‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó</span>
<span class=s2>‚ïë           A/B TEST EXECUTIVE SUMMARY (1-PAGER)                    ‚ïë</span>
<span class=s2>‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£</span>
<span class=s2>‚ïë                                                                    ‚ïë</span>
<span class=s2>‚ïë  EXPERIMENT: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>experiment_name</span><span class=si>}</span><span class=s2>                              ‚ïë</span>
<span class=s2>‚ïë  DATE RANGE: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>start_date</span><span class=si>}</span><span class=s2> to </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>end_date</span><span class=si>}</span><span class=s2>                ‚ïë</span>
<span class=s2>‚ïë                                                                    ‚ïë</span>
<span class=s2>‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£</span>
<span class=s2>‚ïë  üìä BOTTOM LINE RECOMMENDATION                                     ‚ïë</span>
<span class=s2>‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£</span>
<span class=s2>‚ïë                                                                    ‚ïë</span>
<span class=s2>‚ïë  </span><span class=si>{</span><span class=s1>&#39;‚úÖ SHIP TREATMENT&#39;</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;significant&#39;</span><span class=p>]</span><span class=w> </span><span class=ow>and</span><span class=w> </span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;absolute_lift&#39;</span><span class=p>]</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=s1>&#39;‚ùå DO NOT SHIP&#39;</span><span class=si>}</span>
<span class=s2>‚ïë                                                                    ‚ïë</span>
<span class=s2>‚ïë  Primary Metric (</span><span class=si>{</span><span class=n>primary_metric</span><span class=si>}</span><span class=s2>):                               ‚ïë</span>
<span class=s2>‚ïë  ‚Ä¢ Control:    </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;control_mean&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>                       ‚ïë</span>
<span class=s2>‚ïë  ‚Ä¢ Treatment:  </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;treatment_mean&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>                     ‚ïë</span>
<span class=s2>‚ïë  ‚Ä¢ Lift:       </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;relative_lift&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>+.2f</span><span class=si>}</span><span class=s2>% (</span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;absolute_lift&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>+.4f</span><span class=si>}</span><span class=s2>)</span>
<span class=s2>‚ïë  ‚Ä¢ 95% CI:     [</span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;ci_lower&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;ci_upper&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>]</span>
<span class=s2>‚ïë  ‚Ä¢ p-value:    </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;p_value&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>                            ‚ïë</span>
<span class=s2>‚ïë  ‚Ä¢ Significant: </span><span class=si>{</span><span class=s1>&#39;Yes ‚úì&#39;</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;significant&#39;</span><span class=p>]</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=s1>&#39;No ‚úó&#39;</span><span class=si>}</span><span class=s2>   ‚ïë</span>
<span class=s2>‚ïë                                                                    ‚ïë</span>
<span class=s2>‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£</span>
<span class=s2>‚ïë  üí∞ BUSINESS IMPACT                                                ‚ïë</span>
<span class=s2>‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£</span>
<span class=s2>‚ïë                                                                    ‚ïë</span>
<span class=s2>‚ïë  Projected Annual Value: $XXM (based on user base)                ‚ïë</span>
<span class=s2>‚ïë  Implementation Cost: $XXK                                         ‚ïë</span>
<span class=s2>‚ïë  ROI: XXX%                                                         ‚ïë</span>
<span class=s2>‚ïë                                                                    ‚ïë</span>
<span class=s2>‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£</span>
<span class=s2>‚ïë  üö¶ GUARDRAIL METRICS                                              ‚ïë</span>
<span class=s2>‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£</span>
<span class=s2>‚ïë                                                                    ‚ïë</span>
<span class=s2>‚ïë  ‚Ä¢ User retention:     ‚úÖ No degradation                           ‚ïë</span>
<span class=s2>‚ïë  ‚Ä¢ Load time:          ‚úÖ Within SLA                               ‚ïë</span>
<span class=s2>‚ïë  ‚Ä¢ Error rate:         ‚úÖ No increase                              ‚ïë</span>
<span class=s2>‚ïë                                                                    ‚ïë</span>
<span class=s2>‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£</span>
<span class=s2>‚ïë  üìã NEXT STEPS                                                     ‚ïë</span>
<span class=s2>‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£</span>
<span class=s2>‚ïë                                                                    ‚ïë</span>
<span class=s2>‚ïë  1. Roll out to 100% of users by [DATE]                           ‚ïë</span>
<span class=s2>‚ïë  2. Monitor metrics for 2 weeks post-launch                        ‚ïë</span>
<span class=s2>‚ïë  3. Prepare follow-up iteration for Q[X]                           ‚ïë</span>
<span class=s2>‚ïë                                                                    ‚ïë</span>
<span class=s2>‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù</span>
<span class=s2>        &quot;&quot;&quot;</span>

        <span class=k>return</span> <span class=n>summary</span>

    <span class=k>def</span><span class=w> </span><span class=nf>generate_product_report</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Detailed slides for product managers with segmentation.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>report</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;&quot;&quot;</span>
<span class=s2>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê</span>
<span class=s2>PRODUCT MANAGER REPORT: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>experiment_name</span><span class=si>}</span>
<span class=s2>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê</span>

<span class=s2>SLIDE 1: EXPERIMENT OVERVIEW</span>
<span class=s2>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>
<span class=s2>Hypothesis: [Treatment] will improve [Metric] by [X]%</span>
<span class=s2>Duration: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>start_date</span><span class=si>}</span><span class=s2> to </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>end_date</span><span class=si>}</span>
<span class=s2>Sample Size: </span><span class=si>{</span><span class=nb>list</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=o>.</span><span class=n>values</span><span class=p>())[</span><span class=mi>0</span><span class=p>][</span><span class=s1>&#39;sample_size_control&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> control, </span>
<span class=s2>             </span><span class=si>{</span><span class=nb>list</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=o>.</span><span class=n>values</span><span class=p>())[</span><span class=mi>0</span><span class=p>][</span><span class=s1>&#39;sample_size_treatment&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> treatment</span>

<span class=s2>SLIDE 2: KEY RESULTS</span>
<span class=s2>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>
<span class=s2>&quot;&quot;&quot;</span>

        <span class=k>for</span> <span class=n>metric_name</span><span class=p>,</span> <span class=n>result</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=n>report</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&quot;&quot;&quot;</span>
<span class=si>{</span><span class=n>metric_name</span><span class=si>}</span><span class=s2>:</span>
<span class=s2>  ‚Ä¢ Lift: </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;relative_lift&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>+.2f</span><span class=si>}</span><span class=s2>% (95% CI: [</span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;ci_lower&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;ci_upper&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>])</span>
<span class=s2>  ‚Ä¢ Significant: </span><span class=si>{</span><span class=s1>&#39;Yes ‚úì&#39;</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;significant&#39;</span><span class=p>]</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=s1>&#39;No ‚úó&#39;</span><span class=si>}</span><span class=s2> (p=</span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;p_value&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>)</span>
<span class=s2>  ‚Ä¢ Sample: </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;sample_size_treatment&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> users</span>
<span class=s2>            &quot;&quot;&quot;</span>

        <span class=n>report</span> <span class=o>+=</span> <span class=s2>&quot;&quot;&quot;</span>

<span class=s2>SLIDE 3: SEGMENT ANALYSIS</span>
<span class=s2>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>
<span class=s2>[Include visualizations showing lift by segment]</span>

<span class=s2>SLIDE 4: USER FEEDBACK</span>
<span class=s2>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>
<span class=s2>[Qualitative insights from surveys, support tickets]</span>

<span class=s2>SLIDE 5: RECOMMENDATION</span>
<span class=s2>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>
<span class=s2>Ship / Don&#39;t Ship / Iterate</span>
<span class=s2>Rationale: [Brief explanation]</span>
<span class=s2>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê</span>
<span class=s2>        &quot;&quot;&quot;</span>

        <span class=k>return</span> <span class=n>report</span>

    <span class=k>def</span><span class=w> </span><span class=nf>create_visualization</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>primary_metric</span><span class=p>,</span> <span class=n>save_path</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Create comprehensive visualization for stakeholders.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>[</span><span class=n>primary_metric</span><span class=p>]</span>

        <span class=n>fig</span><span class=p>,</span> <span class=n>axes</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>14</span><span class=p>,</span> <span class=mi>10</span><span class=p>))</span>
        <span class=n>fig</span><span class=o>.</span><span class=n>suptitle</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;A/B Test Results: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>experiment_name</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>16</span><span class=p>,</span> <span class=n>fontweight</span><span class=o>=</span><span class=s1>&#39;bold&#39;</span><span class=p>)</span>

        <span class=c1># 1. Bar chart: Control vs Treatment</span>
        <span class=n>ax1</span> <span class=o>=</span> <span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span>
        <span class=n>groups</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Control&#39;</span><span class=p>,</span> <span class=s1>&#39;Treatment&#39;</span><span class=p>]</span>
        <span class=n>means</span> <span class=o>=</span> <span class=p>[</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;control_mean&#39;</span><span class=p>],</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;treatment_mean&#39;</span><span class=p>]]</span>
        <span class=n>ax1</span><span class=o>.</span><span class=n>bar</span><span class=p>(</span><span class=n>groups</span><span class=p>,</span> <span class=n>means</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;#3498db&#39;</span><span class=p>,</span> <span class=s1>&#39;#e74c3c&#39;</span><span class=p>],</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span>
        <span class=n>ax1</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=n>primary_metric</span><span class=p>)</span>
        <span class=n>ax1</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;Control vs Treatment&#39;</span><span class=p>)</span>
        <span class=n>ax1</span><span class=o>.</span><span class=n>axhline</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;control_mean&#39;</span><span class=p>],</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;gray&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;--&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>

        <span class=c1># 2. Confidence interval plot</span>
        <span class=n>ax2</span> <span class=o>=</span> <span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
        <span class=n>ax2</span><span class=o>.</span><span class=n>errorbar</span><span class=p>([</span><span class=mi>1</span><span class=p>],</span> <span class=p>[</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;absolute_lift&#39;</span><span class=p>]],</span> 
                    <span class=n>yerr</span><span class=o>=</span><span class=p>[[</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;absolute_lift&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;ci_lower&#39;</span><span class=p>]],</span> 
                          <span class=p>[</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;ci_upper&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;absolute_lift&#39;</span><span class=p>]]],</span> 
                    <span class=n>fmt</span><span class=o>=</span><span class=s1>&#39;o&#39;</span><span class=p>,</span> <span class=n>markersize</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=n>capsize</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=n>capthick</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;#e74c3c&#39;</span><span class=p>)</span>
        <span class=n>ax2</span><span class=o>.</span><span class=n>axhline</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;black&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;-&#39;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
        <span class=n>ax2</span><span class=o>.</span><span class=n>set_xlim</span><span class=p>(</span><span class=mf>0.5</span><span class=p>,</span> <span class=mf>1.5</span><span class=p>)</span>
        <span class=n>ax2</span><span class=o>.</span><span class=n>set_xticks</span><span class=p>([</span><span class=mi>1</span><span class=p>])</span>
        <span class=n>ax2</span><span class=o>.</span><span class=n>set_xticklabels</span><span class=p>([</span><span class=s1>&#39;Lift&#39;</span><span class=p>])</span>
        <span class=n>ax2</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;Absolute Lift&#39;</span><span class=p>)</span>
        <span class=n>ax2</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Treatment Effect with 95% CI</span><span class=se>\n</span><span class=s1>p-value = </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s2>&quot;p_value&quot;</span><span class=p>]</span><span class=si>:</span><span class=s1>.4f</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
        <span class=n>ax2</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=s1>&#39;y&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>

        <span class=c1># 3. Statistical significance indicator</span>
        <span class=n>ax3</span> <span class=o>=</span> <span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span>
        <span class=n>ax3</span><span class=o>.</span><span class=n>axis</span><span class=p>(</span><span class=s1>&#39;off&#39;</span><span class=p>)</span>
        <span class=n>decision_text</span> <span class=o>=</span> <span class=s2>&quot;‚úÖ STATISTICALLY SIGNIFICANT</span><span class=se>\n</span><span class=s2>SHIP TREATMENT&quot;</span> <span class=k>if</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;significant&#39;</span><span class=p>]</span> <span class=ow>and</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;absolute_lift&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=s2>&quot;‚ùå NOT SIGNIFICANT</span><span class=se>\n</span><span class=s2>DO NOT SHIP&quot;</span>
        <span class=n>decision_color</span> <span class=o>=</span> <span class=s1>&#39;#27ae60&#39;</span> <span class=k>if</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;significant&#39;</span><span class=p>]</span> <span class=ow>and</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;absolute_lift&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=s1>&#39;#e74c3c&#39;</span>
        <span class=n>ax3</span><span class=o>.</span><span class=n>text</span><span class=p>(</span><span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>,</span> <span class=n>decision_text</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>18</span><span class=p>,</span> <span class=n>fontweight</span><span class=o>=</span><span class=s1>&#39;bold&#39;</span><span class=p>,</span> 
                <span class=n>ha</span><span class=o>=</span><span class=s1>&#39;center&#39;</span><span class=p>,</span> <span class=n>va</span><span class=o>=</span><span class=s1>&#39;center&#39;</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=n>decision_color</span><span class=p>,</span>
                <span class=n>bbox</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>boxstyle</span><span class=o>=</span><span class=s1>&#39;round&#39;</span><span class=p>,</span> <span class=n>facecolor</span><span class=o>=</span><span class=n>decision_color</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.2</span><span class=p>,</span> <span class=n>pad</span><span class=o>=</span><span class=mi>1</span><span class=p>))</span>

        <span class=c1># 4. Key metrics table</span>
        <span class=n>ax4</span> <span class=o>=</span> <span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
        <span class=n>ax4</span><span class=o>.</span><span class=n>axis</span><span class=p>(</span><span class=s1>&#39;off&#39;</span><span class=p>)</span>
        <span class=n>table_data</span> <span class=o>=</span> <span class=p>[</span>
            <span class=p>[</span><span class=s1>&#39;Metric&#39;</span><span class=p>,</span> <span class=s1>&#39;Value&#39;</span><span class=p>],</span>
            <span class=p>[</span><span class=s1>&#39;Control Mean&#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s2>&quot;control_mean&quot;</span><span class=p>]</span><span class=si>:</span><span class=s1>.4f</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>],</span>
            <span class=p>[</span><span class=s1>&#39;Treatment Mean&#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s2>&quot;treatment_mean&quot;</span><span class=p>]</span><span class=si>:</span><span class=s1>.4f</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>],</span>
            <span class=p>[</span><span class=s1>&#39;Relative Lift&#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s2>&quot;relative_lift&quot;</span><span class=p>]</span><span class=si>:</span><span class=s1>+.2f</span><span class=si>}</span><span class=s1>%&#39;</span><span class=p>],</span>
            <span class=p>[</span><span class=s1>&#39;95% CI Lower&#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s2>&quot;ci_lower&quot;</span><span class=p>]</span><span class=si>:</span><span class=s1>.4f</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>],</span>
            <span class=p>[</span><span class=s1>&#39;95% CI Upper&#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s2>&quot;ci_upper&quot;</span><span class=p>]</span><span class=si>:</span><span class=s1>.4f</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>],</span>
            <span class=p>[</span><span class=s1>&#39;p-value&#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s2>&quot;p_value&quot;</span><span class=p>]</span><span class=si>:</span><span class=s1>.4f</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>],</span>
            <span class=p>[</span><span class=s1>&#39;Sample Size&#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s2>&quot;sample_size_treatment&quot;</span><span class=p>]</span><span class=si>:</span><span class=s1>,</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span>
        <span class=p>]</span>
        <span class=n>table</span> <span class=o>=</span> <span class=n>ax4</span><span class=o>.</span><span class=n>table</span><span class=p>(</span><span class=n>cellText</span><span class=o>=</span><span class=n>table_data</span><span class=p>,</span> <span class=n>cellLoc</span><span class=o>=</span><span class=s1>&#39;left&#39;</span><span class=p>,</span> <span class=n>loc</span><span class=o>=</span><span class=s1>&#39;center&#39;</span><span class=p>,</span>
                        <span class=n>colWidths</span><span class=o>=</span><span class=p>[</span><span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>])</span>
        <span class=n>table</span><span class=o>.</span><span class=n>auto_set_font_size</span><span class=p>(</span><span class=kc>False</span><span class=p>)</span>
        <span class=n>table</span><span class=o>.</span><span class=n>set_fontsize</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
        <span class=n>table</span><span class=o>.</span><span class=n>scale</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>

        <span class=c1># Style header</span>
        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>2</span><span class=p>):</span>
            <span class=n>table</span><span class=p>[(</span><span class=mi>0</span><span class=p>,</span> <span class=n>i</span><span class=p>)]</span><span class=o>.</span><span class=n>set_facecolor</span><span class=p>(</span><span class=s1>&#39;#3498db&#39;</span><span class=p>)</span>
            <span class=n>table</span><span class=p>[(</span><span class=mi>0</span><span class=p>,</span> <span class=n>i</span><span class=p>)]</span><span class=o>.</span><span class=n>set_text_props</span><span class=p>(</span><span class=n>weight</span><span class=o>=</span><span class=s1>&#39;bold&#39;</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;white&#39;</span><span class=p>)</span>

        <span class=n>plt</span><span class=o>.</span><span class=n>tight_layout</span><span class=p>()</span>

        <span class=k>if</span> <span class=n>save_path</span><span class=p>:</span>
            <span class=n>plt</span><span class=o>.</span><span class=n>savefig</span><span class=p>(</span><span class=n>save_path</span><span class=p>,</span> <span class=n>dpi</span><span class=o>=</span><span class=mi>300</span><span class=p>,</span> <span class=n>bbox_inches</span><span class=o>=</span><span class=s1>&#39;tight&#39;</span><span class=p>)</span>
            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Visualization saved to </span><span class=si>{</span><span class=n>save_path</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

        <span class=k>return</span> <span class=n>fig</span>


<span class=c1># Example: Netflix Watch Time A/B Test</span>
<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>

<span class=n>reporter</span> <span class=o>=</span> <span class=n>ABTestReporter</span><span class=p>(</span>
    <span class=n>experiment_name</span><span class=o>=</span><span class=s2>&quot;New Recommendation Algorithm&quot;</span><span class=p>,</span>
    <span class=n>start_date</span><span class=o>=</span><span class=s2>&quot;2024-11-01&quot;</span><span class=p>,</span>
    <span class=n>end_date</span><span class=o>=</span><span class=s2>&quot;2024-11-14&quot;</span>
<span class=p>)</span>

<span class=c1># Generate realistic data</span>
<span class=n>n_users</span> <span class=o>=</span> <span class=mi>50000</span>
<span class=n>control_watch_time</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>gamma</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>scale</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n_users</span><span class=p>)</span>
<span class=n>treatment_watch_time</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>gamma</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>scale</span><span class=o>=</span><span class=mi>33</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n_users</span><span class=p>)</span>  <span class=c1># 10% lift</span>

<span class=c1># Analyze</span>
<span class=n>result</span> <span class=o>=</span> <span class=n>reporter</span><span class=o>.</span><span class=n>analyze_test</span><span class=p>(</span>
    <span class=n>control_watch_time</span><span class=p>,</span> 
    <span class=n>treatment_watch_time</span><span class=p>,</span> 
    <span class=n>metric_name</span><span class=o>=</span><span class=s1>&#39;Daily Watch Time (minutes)&#39;</span><span class=p>,</span>
    <span class=n>metric_type</span><span class=o>=</span><span class=s1>&#39;continuous&#39;</span>
<span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;A/B TEST STAKEHOLDER COMMUNICATION EXAMPLE&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>

<span class=c1># Executive Summary</span>
<span class=nb>print</span><span class=p>(</span><span class=n>reporter</span><span class=o>.</span><span class=n>generate_executive_summary</span><span class=p>(</span><span class=s1>&#39;Daily Watch Time (minutes)&#39;</span><span class=p>))</span>

<span class=c1># Product Report</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=n>reporter</span><span class=o>.</span><span class=n>generate_product_report</span><span class=p>())</span>

<span class=c1># Create visualization</span>
<span class=n>reporter</span><span class=o>.</span><span class=n>create_visualization</span><span class=p>(</span><span class=s1>&#39;Daily Watch Time (minutes)&#39;</span><span class=p>)</span>
<span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</code></pre></div> <p><strong>Audience-Specific Content:</strong></p> <table> <thead> <tr> <th>Audience</th> <th>Content Focus</th> <th>Format</th> <th>Length</th> <th>Key Elements</th> </tr> </thead> <tbody> <tr> <td><strong>Executive (C-suite)</strong></td> <td>Business impact, ROI, decision</td> <td>1-pager PDF</td> <td>1 page</td> <td>Bottom line, $ impact, risk assessment</td> </tr> <tr> <td><strong>Product Manager</strong></td> <td>Metrics, segments, user behavior</td> <td>Slide deck</td> <td>5-10 slides</td> <td>Detailed results, segment analysis, next steps</td> </tr> <tr> <td><strong>Engineering</strong></td> <td>Implementation, technical details</td> <td>Technical doc</td> <td>As needed</td> <td>Methods, assumptions, code, edge cases</td> </tr> <tr> <td><strong>Data Science</strong></td> <td>Statistical methods, sensitivity</td> <td>Jupyter notebook</td> <td>Full analysis</td> <td>P-values, CIs, diagnostics, robustness checks</td> </tr> </tbody> </table> <p><strong>Real Company Examples:</strong></p> <table> <thead> <tr> <th>Company</th> <th>Test</th> <th>Communication Approach</th> <th>Outcome</th> </tr> </thead> <tbody> <tr> <td><strong>Netflix</strong></td> <td>Recommendation algorithm</td> <td>Executive 1-pager: "+5% watch time = $100M ARR", full deck for product</td> <td>Approved in 1 meeting, shipped globally</td> </tr> <tr> <td><strong>Uber</strong></td> <td>Surge pricing UI</td> <td>PM deck with segment analysis (new vs power users), guardrail dashboard</td> <td>Identified 10% churn risk in new users, iterated</td> </tr> <tr> <td><strong>Google Ads</strong></td> <td>Bid optimization</td> <td>Automated email report to 50+ PMs daily with traffic lights (üü¢üü°üî¥)</td> <td>Scaled decision-making to 1000+ tests/year</td> </tr> <tr> <td><strong>Airbnb</strong></td> <td>Search ranking</td> <td>Weekly newsletter with "Experiment of the Week" featuring learnings</td> <td>Built experimentation culture across org</td> </tr> </tbody> </table> <p><strong>Communication Anti-Patterns (AVOID):</strong></p> <table> <thead> <tr> <th>‚ùå Anti-Pattern</th> <th>Why It's Bad</th> <th>‚úÖ Better Approach</th> </tr> </thead> <tbody> <tr> <td><strong>P-value only</strong></td> <td>"p=0.03" ‚Üí Stakeholders don't understand</td> <td>"95% confident lift is +5-8%"</td> </tr> <tr> <td><strong>Cherry-picking</strong></td> <td>Show only positive segments</td> <td>Show all pre-registered segments</td> </tr> <tr> <td><strong>Jargon overload</strong></td> <td>"Heteroskedasticity", "CUPED"</td> <td>"Adjusted for pre-experiment behavior"</td> </tr> <tr> <td><strong>No decision</strong></td> <td>"Here are the numbers"</td> <td>"Recommend shipping because..."</td> </tr> <tr> <td><strong>Overconfidence</strong></td> <td>"This will definitely work"</td> <td>"Based on 2 weeks, expect +5% with ¬±2% uncertainty"</td> </tr> </tbody> </table> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p><strong>What they're testing:</strong> Communication skills, stakeholder management, ability to tailor technical content.</p> <p><strong>Strong answer signals:</strong></p> <ul> <li>Starts with decision (ship/don't ship), not statistics</li> <li>Uses confidence intervals instead of p-values</li> <li>Tailors content to audience (exec vs engineer)</li> <li>Includes guardrail metrics and caveats</li> <li>Provides clear next steps</li> <li>Shows visualizations (bar charts, CI plots)</li> <li>Mentions business impact ($, users affected)</li> <li>Knows when to simplify vs go deep</li> </ul> <p><strong>Red flags:</strong></p> <ul> <li>Leads with p-values and test statistics</li> <li>Uses jargon without explanation</li> <li>No clear recommendation</li> <li>Ignores guardrails or negative results</li> <li>Same report for all audiences</li> </ul> <p><strong>Follow-up questions:</strong></p> <ul> <li>"How would you explain p-value to a non-technical PM?" (Probability of seeing this result by chance)</li> <li>"What if the exec asks 'Are you sure?'" (Quantify confidence with CI, mention assumptions)</li> <li>"How do you handle requests to 'dig deeper' when results are negative?" (Pre-register analysis plan, avoid p-hacking)</li> </ul> </div> </details> <hr> <h3 id=what-is-the-minimum-detectable-effect-mde-netflix-uber-interview-question>What is the Minimum Detectable Effect (MDE)? - Netflix, Uber Interview Question</h3> <p><strong>Difficulty:</strong> üü° Medium | <strong>Tags:</strong> <code>Experimental Design</code> | <strong>Asked by:</strong> Netflix, Uber, Airbnb</p> <details class=success> <summary>View Answer</summary> <p><strong>Minimum Detectable Effect (MDE)</strong> is the <strong>smallest effect size</strong> that an experiment can reliably detect with a given sample size, significance level (Œ±), and statistical power (1-Œ≤). It's a <strong>pre-experiment planning tool</strong> that answers: "How large must the treatment effect be for us to detect it?"</p> <p><strong>MDE Formula (continuous metrics):</strong></p> <div class=arithmatex>\[MDE = (z_{1-\alpha/2} + z_{1-\beta}) \cdot \sqrt{\frac{\sigma^2}{n_C} + \frac{\sigma^2}{n_T}} \cdot \frac{1}{\sqrt{n_C}}\]</div> <p>For <strong>equal sample sizes</strong> (<span class=arithmatex>\(n_C = n_T = n\)</span>):</p> <div class=arithmatex>\[MDE = (z_{1-\alpha/2} + z_{1-\beta}) \cdot \sigma \cdot \sqrt{\frac{2}{n}}\]</div> <p>Where: - <span class=arithmatex>\(z_{1-\alpha/2}\)</span> = critical value for two-sided test (1.96 for Œ±=0.05) - <span class=arithmatex>\(z_{1-\beta}\)</span> = critical value for power (0.84 for 80% power, 1.28 for 90% power) - <span class=arithmatex>\(\sigma\)</span> = standard deviation of metric - <span class=arithmatex>\(n\)</span> = sample size per group</p> <p><strong>Power Analysis Triangle:</strong></p> <div class=highlight><pre><span></span><code>               ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
               ‚îÇ    Power Analysis Components      ‚îÇ
               ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
               ‚îÇ                                   ‚îÇ
               ‚îÇ         Effect Size (MDE)         ‚îÇ
               ‚îÇ              ‚ñ≤                    ‚îÇ
               ‚îÇ              ‚îÇ                    ‚îÇ
               ‚îÇ              ‚îÇ                    ‚îÇ
               ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
               ‚îÇ    ‚îÇ                   ‚îÇ         ‚îÇ
               ‚îÇ    ‚îÇ                   ‚îÇ         ‚îÇ
               ‚îÇ    ‚ñº                   ‚ñº         ‚îÇ
               ‚îÇ  Sample              Power       ‚îÇ
               ‚îÇ   Size                (1-Œ≤)      ‚îÇ
               ‚îÇ    ‚îÇ                   ‚îÇ         ‚îÇ
               ‚îÇ    ‚îÇ                   ‚îÇ         ‚îÇ
               ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
               ‚îÇ              ‚îÇ                    ‚îÇ
               ‚îÇ              ‚ñº                    ‚îÇ
               ‚îÇ    Significance Level (Œ±)        ‚îÇ
               ‚îÇ                                   ‚îÇ
               ‚îÇ  Fix 3 parameters ‚Üí Solve for 4th‚îÇ
               ‚îÇ                                   ‚îÇ
               ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Production MDE Calculator:</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>from</span><span class=w> </span><span class=nn>statsmodels.stats.power</span><span class=w> </span><span class=kn>import</span> <span class=n>zt_ind_solve_power</span><span class=p>,</span> <span class=n>tt_ind_solve_power</span>
<span class=kn>import</span><span class=w> </span><span class=nn>matplotlib.pyplot</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>plt</span>

<span class=c1># Production: Comprehensive MDE and Power Analysis Calculator</span>

<span class=k>class</span><span class=w> </span><span class=nc>MDECalculator</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Calculate Minimum Detectable Effect, sample size, and power for A/B tests.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span> <span class=n>power</span><span class=o>=</span><span class=mf>0.80</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Initialize with default significance level and power.</span>

<span class=sd>        alpha: Type I error rate (false positive rate)</span>
<span class=sd>        power: 1 - Type II error rate (1 - false negative rate)</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>=</span> <span class=n>alpha</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>power</span> <span class=o>=</span> <span class=n>power</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>z_alpha</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>norm</span><span class=o>.</span><span class=n>ppf</span><span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>alpha</span><span class=o>/</span><span class=mi>2</span><span class=p>)</span>  <span class=c1># Two-sided</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>z_beta</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>norm</span><span class=o>.</span><span class=n>ppf</span><span class=p>(</span><span class=n>power</span><span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>calculate_mde_continuous</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>n_per_group</span><span class=p>,</span> <span class=n>std</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Calculate MDE for continuous metrics (e.g., revenue, watch time).</span>

<span class=sd>        n_per_group: Sample size per group</span>
<span class=sd>        std: Standard deviation of metric</span>

<span class=sd>        Returns: Absolute MDE</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>mde</span> <span class=o>=</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>z_alpha</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>z_beta</span><span class=p>)</span> <span class=o>*</span> <span class=n>std</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>2</span> <span class=o>/</span> <span class=n>n_per_group</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>mde</span>

    <span class=k>def</span><span class=w> </span><span class=nf>calculate_mde_proportion</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>n_per_group</span><span class=p>,</span> <span class=n>baseline_rate</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Calculate MDE for proportion metrics (e.g., conversion rate).</span>

<span class=sd>        n_per_group: Sample size per group</span>
<span class=sd>        baseline_rate: Control group proportion (e.g., 0.10 for 10% CVR)</span>

<span class=sd>        Returns: Absolute MDE (percentage points)</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>std</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>baseline_rate</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>baseline_rate</span><span class=p>))</span>
        <span class=n>mde</span> <span class=o>=</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>z_alpha</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>z_beta</span><span class=p>)</span> <span class=o>*</span> <span class=n>std</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>2</span> <span class=o>/</span> <span class=n>n_per_group</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>mde</span>

    <span class=k>def</span><span class=w> </span><span class=nf>calculate_sample_size_continuous</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>mde</span><span class=p>,</span> <span class=n>std</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Calculate required sample size per group for continuous metrics.</span>

<span class=sd>        mde: Minimum detectable effect (absolute)</span>
<span class=sd>        std: Standard deviation of metric</span>

<span class=sd>        Returns: Sample size per group</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>n</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=p>((</span><span class=bp>self</span><span class=o>.</span><span class=n>z_alpha</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>z_beta</span><span class=p>)</span> <span class=o>*</span> <span class=n>std</span> <span class=o>/</span> <span class=n>mde</span><span class=p>)</span> <span class=o>**</span> <span class=mi>2</span>
        <span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>ceil</span><span class=p>(</span><span class=n>n</span><span class=p>))</span>

    <span class=k>def</span><span class=w> </span><span class=nf>calculate_sample_size_proportion</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>mde</span><span class=p>,</span> <span class=n>baseline_rate</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Calculate required sample size per group for proportions.</span>

<span class=sd>        mde: Minimum detectable effect (absolute, e.g., 0.02 for +2pp)</span>
<span class=sd>        baseline_rate: Control group proportion</span>

<span class=sd>        Returns: Sample size per group</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>p1</span> <span class=o>=</span> <span class=n>baseline_rate</span>
        <span class=n>p2</span> <span class=o>=</span> <span class=n>baseline_rate</span> <span class=o>+</span> <span class=n>mde</span>

        <span class=c1># Pooled standard deviation</span>
        <span class=n>p_avg</span> <span class=o>=</span> <span class=p>(</span><span class=n>p1</span> <span class=o>+</span> <span class=n>p2</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span>
        <span class=n>std_pooled</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>p_avg</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>p_avg</span><span class=p>))</span>

        <span class=n>n</span> <span class=o>=</span> <span class=p>((</span><span class=bp>self</span><span class=o>.</span><span class=n>z_alpha</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>z_beta</span><span class=p>)</span> <span class=o>*</span> <span class=n>std_pooled</span> <span class=o>/</span> <span class=n>mde</span><span class=p>)</span> <span class=o>**</span> <span class=mi>2</span>
        <span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>ceil</span><span class=p>(</span><span class=n>n</span><span class=p>))</span>

    <span class=k>def</span><span class=w> </span><span class=nf>calculate_power_achieved</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>n_per_group</span><span class=p>,</span> <span class=n>effect_size</span><span class=p>,</span> <span class=n>std</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Calculate achieved power given sample size and effect size.</span>

<span class=sd>        n_per_group: Sample size per group</span>
<span class=sd>        effect_size: True treatment effect</span>
<span class=sd>        std: Standard deviation</span>

<span class=sd>        Returns: Achieved power</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=c1># Non-centrality parameter</span>
        <span class=n>ncp</span> <span class=o>=</span> <span class=n>effect_size</span> <span class=o>/</span> <span class=p>(</span><span class=n>std</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=mi>2</span> <span class=o>/</span> <span class=n>n_per_group</span><span class=p>))</span>

        <span class=c1># Power = P(reject H0 | H1 is true)</span>
        <span class=n>power</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>-</span> <span class=n>stats</span><span class=o>.</span><span class=n>norm</span><span class=o>.</span><span class=n>cdf</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>z_alpha</span> <span class=o>-</span> <span class=n>ncp</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>power</span>

    <span class=k>def</span><span class=w> </span><span class=nf>create_power_curve</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>baseline_mean</span><span class=p>,</span> <span class=n>std</span><span class=p>,</span> <span class=n>sample_sizes</span><span class=p>,</span> 
                          <span class=n>effect_sizes</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>save_path</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Create power curve showing power vs effect size for different sample sizes.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=n>effect_sizes</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=n>effect_sizes</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>linspace</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mf>0.3</span> <span class=o>*</span> <span class=n>baseline_mean</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span>

        <span class=n>fig</span><span class=p>,</span> <span class=p>(</span><span class=n>ax1</span><span class=p>,</span> <span class=n>ax2</span><span class=p>)</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>14</span><span class=p>,</span> <span class=mi>5</span><span class=p>))</span>

        <span class=c1># Plot 1: Power vs Effect Size</span>
        <span class=k>for</span> <span class=n>n</span> <span class=ow>in</span> <span class=n>sample_sizes</span><span class=p>:</span>
            <span class=n>powers</span> <span class=o>=</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>calculate_power_achieved</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>es</span><span class=p>,</span> <span class=n>std</span><span class=p>)</span> <span class=k>for</span> <span class=n>es</span> <span class=ow>in</span> <span class=n>effect_sizes</span><span class=p>]</span>
            <span class=n>ax1</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>effect_sizes</span> <span class=o>/</span> <span class=n>baseline_mean</span> <span class=o>*</span> <span class=mi>100</span><span class=p>,</span> <span class=n>powers</span><span class=p>,</span> 
                    <span class=n>label</span><span class=o>=</span><span class=sa>f</span><span class=s1>&#39;n=</span><span class=si>{</span><span class=n>n</span><span class=si>:</span><span class=s1>,</span><span class=si>}</span><span class=s1> per group&#39;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>

        <span class=n>ax1</span><span class=o>.</span><span class=n>axhline</span><span class=p>(</span><span class=mf>0.80</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;--&#39;</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;80% power&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span>
        <span class=n>ax1</span><span class=o>.</span><span class=n>axhline</span><span class=p>(</span><span class=mf>0.90</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;orange&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;--&#39;</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;90% power&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span>
        <span class=n>ax1</span><span class=o>.</span><span class=n>set_xlabel</span><span class=p>(</span><span class=s1>&#39;Effect Size (</span><span class=si>% r</span><span class=s1>elative lift)&#39;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>12</span><span class=p>)</span>
        <span class=n>ax1</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;Statistical Power&#39;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>12</span><span class=p>)</span>
        <span class=n>ax1</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;Power Curve: Power vs Effect Size&#39;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>14</span><span class=p>,</span> <span class=n>fontweight</span><span class=o>=</span><span class=s1>&#39;bold&#39;</span><span class=p>)</span>
        <span class=n>ax1</span><span class=o>.</span><span class=n>legend</span><span class=p>(</span><span class=n>loc</span><span class=o>=</span><span class=s1>&#39;lower right&#39;</span><span class=p>)</span>
        <span class=n>ax1</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>
        <span class=n>ax1</span><span class=o>.</span><span class=n>set_ylim</span><span class=p>([</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>])</span>

        <span class=c1># Plot 2: Sample Size vs MDE</span>
        <span class=n>mdes</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=k>for</span> <span class=n>n</span> <span class=ow>in</span> <span class=n>np</span><span class=o>.</span><span class=n>linspace</span><span class=p>(</span><span class=mi>1000</span><span class=p>,</span> <span class=mi>100000</span><span class=p>,</span> <span class=mi>100</span><span class=p>):</span>
            <span class=n>mde</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_mde_continuous</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>std</span><span class=p>)</span>
            <span class=n>mdes</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>mde</span> <span class=o>/</span> <span class=n>baseline_mean</span> <span class=o>*</span> <span class=mi>100</span><span class=p>)</span>

        <span class=n>ax2</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>linspace</span><span class=p>(</span><span class=mi>1000</span><span class=p>,</span> <span class=mi>100000</span><span class=p>,</span> <span class=mi>100</span><span class=p>),</span> <span class=n>mdes</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;#e74c3c&#39;</span><span class=p>)</span>
        <span class=n>ax2</span><span class=o>.</span><span class=n>set_xlabel</span><span class=p>(</span><span class=s1>&#39;Sample Size per Group&#39;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>12</span><span class=p>)</span>
        <span class=n>ax2</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;MDE (</span><span class=si>% r</span><span class=s1>elative lift)&#39;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>12</span><span class=p>)</span>
        <span class=n>ax2</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;Trade-off: Sample Size vs MDE&#39;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>14</span><span class=p>,</span> <span class=n>fontweight</span><span class=o>=</span><span class=s1>&#39;bold&#39;</span><span class=p>)</span>
        <span class=n>ax2</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>
        <span class=n>ax2</span><span class=o>.</span><span class=n>axhline</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;green&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;--&#39;</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;5% MDE target&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span>
        <span class=n>ax2</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>

        <span class=n>plt</span><span class=o>.</span><span class=n>tight_layout</span><span class=p>()</span>

        <span class=k>if</span> <span class=n>save_path</span><span class=p>:</span>
            <span class=n>plt</span><span class=o>.</span><span class=n>savefig</span><span class=p>(</span><span class=n>save_path</span><span class=p>,</span> <span class=n>dpi</span><span class=o>=</span><span class=mi>300</span><span class=p>,</span> <span class=n>bbox_inches</span><span class=o>=</span><span class=s1>&#39;tight&#39;</span><span class=p>)</span>

        <span class=k>return</span> <span class=n>fig</span>

    <span class=k>def</span><span class=w> </span><span class=nf>create_sensitivity_table</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>baseline_mean</span><span class=p>,</span> <span class=n>std</span><span class=p>,</span> <span class=n>sample_size</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Create sensitivity table showing MDE for different power levels.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>power_levels</span> <span class=o>=</span> <span class=p>[</span><span class=mf>0.70</span><span class=p>,</span> <span class=mf>0.75</span><span class=p>,</span> <span class=mf>0.80</span><span class=p>,</span> <span class=mf>0.85</span><span class=p>,</span> <span class=mf>0.90</span><span class=p>,</span> <span class=mf>0.95</span><span class=p>]</span>

        <span class=n>results</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=k>for</span> <span class=n>power</span> <span class=ow>in</span> <span class=n>power_levels</span><span class=p>:</span>
            <span class=n>calc</span> <span class=o>=</span> <span class=n>MDECalculator</span><span class=p>(</span><span class=n>alpha</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>alpha</span><span class=p>,</span> <span class=n>power</span><span class=o>=</span><span class=n>power</span><span class=p>)</span>
            <span class=n>mde</span> <span class=o>=</span> <span class=n>calc</span><span class=o>.</span><span class=n>calculate_mde_continuous</span><span class=p>(</span><span class=n>sample_size</span><span class=p>,</span> <span class=n>std</span><span class=p>)</span>
            <span class=n>relative_mde</span> <span class=o>=</span> <span class=n>mde</span> <span class=o>/</span> <span class=n>baseline_mean</span> <span class=o>*</span> <span class=mi>100</span>

            <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
                <span class=s1>&#39;Power&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>power</span><span class=si>:</span><span class=s1>.0%</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>,</span>
                <span class=s1>&#39;MDE (absolute)&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>mde</span><span class=si>:</span><span class=s1>.4f</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>,</span>
                <span class=s1>&#39;MDE (</span><span class=si>% r</span><span class=s1>elative)&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>relative_mde</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>%&#39;</span><span class=p>,</span>
                <span class=s1>&#39;z_beta&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>calc</span><span class=o>.</span><span class=n>z_beta</span><span class=si>:</span><span class=s1>.3f</span><span class=si>}</span><span class=s1>&#39;</span>
            <span class=p>})</span>

        <span class=k>return</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>results</span><span class=p>)</span>


<span class=c1># Example 1: Netflix Watch Time Experiment</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;EXAMPLE 1: NETFLIX WATCH TIME EXPERIMENT&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>

<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>

<span class=c1># Historical data</span>
<span class=n>baseline_watch_time</span> <span class=o>=</span> <span class=mi>60</span>  <span class=c1># minutes per day</span>
<span class=n>std_watch_time</span> <span class=o>=</span> <span class=mi>40</span>  <span class=c1># high variance (user behavior)</span>

<span class=n>calculator</span> <span class=o>=</span> <span class=n>MDECalculator</span><span class=p>(</span><span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span> <span class=n>power</span><span class=o>=</span><span class=mf>0.80</span><span class=p>)</span>

<span class=c1># Scenario 1: What MDE can we detect with 50,000 users per group?</span>
<span class=n>n_users</span> <span class=o>=</span> <span class=mi>50000</span>
<span class=n>mde_absolute</span> <span class=o>=</span> <span class=n>calculator</span><span class=o>.</span><span class=n>calculate_mde_continuous</span><span class=p>(</span><span class=n>n_users</span><span class=p>,</span> <span class=n>std_watch_time</span><span class=p>)</span>
<span class=n>mde_relative</span> <span class=o>=</span> <span class=n>mde_absolute</span> <span class=o>/</span> <span class=n>baseline_watch_time</span> <span class=o>*</span> <span class=mi>100</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìä Scenario 1: What can we detect with </span><span class=si>{</span><span class=n>n_users</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> users?&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Baseline: </span><span class=si>{</span><span class=n>baseline_watch_time</span><span class=si>}</span><span class=s2> minutes/day (std=</span><span class=si>{</span><span class=n>std_watch_time</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   MDE (absolute): </span><span class=si>{</span><span class=n>mde_absolute</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> minutes&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   MDE (relative): </span><span class=si>{</span><span class=n>mde_relative</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Interpretation: Can detect effects of </span><span class=si>{</span><span class=n>mde_relative</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>% or larger&quot;</span><span class=p>)</span>

<span class=c1># Scenario 2: How many users needed to detect 3% lift?</span>
<span class=n>target_lift_pct</span> <span class=o>=</span> <span class=mf>3.0</span>
<span class=n>target_lift_abs</span> <span class=o>=</span> <span class=n>baseline_watch_time</span> <span class=o>*</span> <span class=n>target_lift_pct</span> <span class=o>/</span> <span class=mi>100</span>
<span class=n>n_required</span> <span class=o>=</span> <span class=n>calculator</span><span class=o>.</span><span class=n>calculate_sample_size_continuous</span><span class=p>(</span><span class=n>target_lift_abs</span><span class=p>,</span> <span class=n>std_watch_time</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìä Scenario 2: Users needed to detect </span><span class=si>{</span><span class=n>target_lift_pct</span><span class=si>}</span><span class=s2>% lift?&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Target lift: </span><span class=si>{</span><span class=n>target_lift_abs</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> minutes (</span><span class=si>{</span><span class=n>target_lift_pct</span><span class=si>}</span><span class=s2>%)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Required sample size: </span><span class=si>{</span><span class=n>n_required</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> per group&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Total users: </span><span class=si>{</span><span class=mi>2</span><span class=o>*</span><span class=n>n_required</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Runtime (at 1M DAU, 50% allocation): </span><span class=si>{</span><span class=mi>2</span><span class=o>*</span><span class=n>n_required</span><span class=o>/</span><span class=mi>500000</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2> days&quot;</span><span class=p>)</span>

<span class=c1># Sensitivity table</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìã Sensitivity Analysis: MDE vs Power (n=50,000)&quot;</span><span class=p>)</span>
<span class=n>sensitivity_df</span> <span class=o>=</span> <span class=n>calculator</span><span class=o>.</span><span class=n>create_sensitivity_table</span><span class=p>(</span><span class=n>baseline_watch_time</span><span class=p>,</span> <span class=n>std_watch_time</span><span class=p>,</span> <span class=n>n_users</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>sensitivity_df</span><span class=o>.</span><span class=n>to_string</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>))</span>


<span class=c1># Example 2: Uber Conversion Rate Experiment</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;EXAMPLE 2: UBER APP CONVERSION RATE EXPERIMENT&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>

<span class=n>baseline_cvr</span> <span class=o>=</span> <span class=mf>0.12</span>  <span class=c1># 12% of users complete a trip</span>

<span class=c1># Scenario 1: MDE with 100,000 users per group</span>
<span class=n>n_users_uber</span> <span class=o>=</span> <span class=mi>100000</span>
<span class=n>mde_cvr_abs</span> <span class=o>=</span> <span class=n>calculator</span><span class=o>.</span><span class=n>calculate_mde_proportion</span><span class=p>(</span><span class=n>n_users_uber</span><span class=p>,</span> <span class=n>baseline_cvr</span><span class=p>)</span>
<span class=n>mde_cvr_rel</span> <span class=o>=</span> <span class=n>mde_cvr_abs</span> <span class=o>/</span> <span class=n>baseline_cvr</span> <span class=o>*</span> <span class=mi>100</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìä Scenario 1: What can we detect with </span><span class=si>{</span><span class=n>n_users_uber</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> users?&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Baseline CVR: </span><span class=si>{</span><span class=n>baseline_cvr</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   MDE (absolute): </span><span class=si>{</span><span class=n>mde_cvr_abs</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=n>mde_cvr_abs</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> percentage points)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   MDE (relative): </span><span class=si>{</span><span class=n>mde_cvr_rel</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Interpretation: Can detect CVR changes of </span><span class=si>{</span><span class=n>mde_cvr_abs</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>pp or larger&quot;</span><span class=p>)</span>

<span class=c1># Scenario 2: Sample size for 1% relative lift (0.12pp)</span>
<span class=n>target_lift_cvr</span> <span class=o>=</span> <span class=mf>0.0012</span>  <span class=c1># +0.12pp absolute (1% relative)</span>
<span class=n>n_required_cvr</span> <span class=o>=</span> <span class=n>calculator</span><span class=o>.</span><span class=n>calculate_sample_size_proportion</span><span class=p>(</span><span class=n>target_lift_cvr</span><span class=p>,</span> <span class=n>baseline_cvr</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìä Scenario 2: Users needed to detect +1% relative lift?&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Target: </span><span class=si>{</span><span class=n>baseline_cvr</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2> ‚Üí </span><span class=si>{</span><span class=n>baseline_cvr</span><span class=o>+</span><span class=n>target_lift_cvr</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Required sample size: </span><span class=si>{</span><span class=n>n_required_cvr</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> per group&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Total users: </span><span class=si>{</span><span class=mi>2</span><span class=o>*</span><span class=n>n_required_cvr</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Create power curves</span>
<span class=n>sample_sizes</span> <span class=o>=</span> <span class=p>[</span><span class=mi>10000</span><span class=p>,</span> <span class=mi>25000</span><span class=p>,</span> <span class=mi>50000</span><span class=p>,</span> <span class=mi>100000</span><span class=p>]</span>
<span class=n>calculator</span><span class=o>.</span><span class=n>create_power_curve</span><span class=p>(</span><span class=n>baseline_watch_time</span><span class=p>,</span> <span class=n>std_watch_time</span><span class=p>,</span> <span class=n>sample_sizes</span><span class=p>)</span>
<span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</code></pre></div> <p><strong>MDE Trade-off Analysis:</strong></p> <table> <thead> <tr> <th>Parameter</th> <th>Relationship</th> <th>Example (Netflix)</th> </tr> </thead> <tbody> <tr> <td><strong>‚Üë Sample Size</strong></td> <td>‚Üì MDE (better)</td> <td>50K users ‚Üí 2.5% MDE, 100K users ‚Üí 1.8% MDE</td> </tr> <tr> <td><strong>‚Üë Variance (œÉ)</strong></td> <td>‚Üë MDE (worse)</td> <td>Revenue (œÉ=$50) ‚Üí 10% MDE, Clicks (œÉ=2) ‚Üí 2% MDE</td> </tr> <tr> <td><strong>‚Üë Power (1-Œ≤)</strong></td> <td>‚Üë MDE (worse)</td> <td>80% power ‚Üí 2.5% MDE, 90% power ‚Üí 3.0% MDE</td> </tr> <tr> <td><strong>‚Üë Significance (Œ±)</strong></td> <td>‚Üì MDE (better, but more false positives)</td> <td>Œ±=0.05 ‚Üí 2.5% MDE, Œ±=0.10 ‚Üí 2.2% MDE</td> </tr> </tbody> </table> <p><strong>Real Company Examples:</strong></p> <table> <thead> <tr> <th>Company</th> <th>Metric</th> <th>Baseline</th> <th>MDE</th> <th>Sample Size</th> <th>Rationale</th> </tr> </thead> <tbody> <tr> <td><strong>Netflix</strong></td> <td>Watch time</td> <td>60 min/day</td> <td>2% (1.2 min)</td> <td>50K/group</td> <td>Must exceed content production cost (~$1M)</td> </tr> <tr> <td><strong>Uber</strong></td> <td>Trips/user</td> <td>3.2/month</td> <td>1.5% (0.05 trips)</td> <td>100K/group</td> <td>Need precision for demand forecasting</td> </tr> <tr> <td><strong>Airbnb</strong></td> <td>Booking rate</td> <td>8%</td> <td>2.5% (0.2pp)</td> <td>80K/group</td> <td>Must cover development cost ($200K)</td> </tr> <tr> <td><strong>Amazon</strong></td> <td>Add-to-cart rate</td> <td>15%</td> <td>0.5% (0.075pp)</td> <td>500K/group</td> <td>High volume ‚Üí can detect tiny effects</td> </tr> </tbody> </table> <p><strong>Business vs Statistical MDE:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   MDE Decision Framework                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                ‚îÇ
‚îÇ  Statistical MDE          Business MDE         Final MDE      ‚îÇ
‚îÇ  (what we CAN detect)     (what we CARE about) (choose)       ‚îÇ
‚îÇ         ‚îÇ                        ‚îÇ                  ‚îÇ         ‚îÇ
‚îÇ         ‚Üì                        ‚Üì                  ‚Üì         ‚îÇ
‚îÇ    Based on n, œÉ, Œ±, Œ≤     Based on ROI      max(stat, biz)  ‚îÇ
‚îÇ                                                                ‚îÇ
‚îÇ  Example: Netflix                                              ‚îÇ
‚îÇ  Statistical: 1.5% (n=100K)                                   ‚îÇ
‚îÇ  Business: 3% (ROI breakeven)                                 ‚îÇ
‚îÇ  Final MDE: 3% ‚Üê Use business constraint                      ‚îÇ
‚îÇ                                                                ‚îÇ
‚îÇ  Example: Uber                                                 ‚îÇ
‚îÇ  Statistical: 2% (n=50K)                                      ‚îÇ
‚îÇ  Business: 0.5% (strategic priority)                          ‚îÇ
‚îÇ  Final MDE: 2% ‚Üê Need more data or variance reduction        ‚îÇ
‚îÇ                                                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Common MDE Mistakes:</strong></p> <table> <thead> <tr> <th>‚ùå Mistake</th> <th>Why It's Wrong</th> <th>‚úÖ Correct Approach</th> </tr> </thead> <tbody> <tr> <td><strong>"Let's detect any effect"</strong></td> <td>MDE too small ‚Üí need millions of users</td> <td>Set MDE based on business value</td> </tr> <tr> <td><strong>"We have 10K users, what's MDE?"</strong></td> <td>Backward calculation</td> <td>Start with business MDE ‚Üí calculate n</td> </tr> <tr> <td><strong>"MDE = 5% because that's typical"</strong></td> <td>Ignores metric variance</td> <td>Calculate MDE from œÉ, n, Œ±, Œ≤</td> </tr> <tr> <td><strong>"Variance reduction doesn't matter"</strong></td> <td>Misses 2-5√ó sample size savings</td> <td>Use CUPED, stratification to reduce œÉ</td> </tr> </tbody> </table> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p><strong>What they're testing:</strong> Understanding of power analysis, sample size planning, business-statistical trade-offs.</p> <p><strong>Strong answer signals:</strong></p> <ul> <li>Knows MDE formula and all 4 parameters (Œ±, Œ≤, œÉ, n)</li> <li>Explains trade-off: smaller MDE needs more samples</li> <li>Starts with business MDE (ROI, strategic value), then calculates statistical feasibility</li> <li>Mentions variance reduction techniques (CUPED, stratification) to lower MDE</li> <li>Gives specific examples with numbers (e.g., "Netflix needs 2% MDE for $100M impact")</li> <li>Knows when MDE is too small (unrealistic sample size) or too large (misses real effects)</li> </ul> <p><strong>Red flags:</strong></p> <ul> <li>Confuses MDE with actual effect size</li> <li>Only knows "we need more data for smaller effects" without quantification</li> <li>Ignores business constraints</li> <li>Can't explain Œ±, Œ≤, or power</li> </ul> <p><strong>Follow-up questions:</strong></p> <ul> <li>"How would you reduce MDE without more users?" (Reduce œÉ via CUPED, stratification, or better metric)</li> <li>"What if business wants 0.5% MDE but you can only detect 2%?" (Need 16√ó more users, or use variance reduction, or reset expectations)</li> <li>"How does variance affect MDE?" (MDE ‚àù œÉ, so 2√ó variance ‚Üí 2√ó MDE or 4√ó sample size)</li> </ul> </div> </details> <hr> <h3 id=how-to-design-an-experimentation-platform-senior-roles-interview-question>How to Design an Experimentation Platform? - Senior Roles Interview Question</h3> <p><strong>Difficulty:</strong> üî¥ Hard | <strong>Tags:</strong> <code>System Design</code> | <strong>Asked by:</strong> Google, Netflix, Meta</p> <details class=success> <summary>View Answer</summary> <p>An <strong>Experimentation Platform</strong> is the <strong>infrastructure backbone</strong> that enables companies to run <strong>thousands of A/B tests</strong> simultaneously with consistency, automation, and reliability. It must handle <strong>assignment, logging, analysis, and guardrails</strong> at scale while preventing Sample Ratio Mismatch (SRM), assignment collisions, and metric bugs.</p> <p><strong>High-Level Architecture:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        Experimentation Platform Architecture                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                                                ‚îÇ
‚îÇ  ‚îÇ   User      ‚îÇ                                                                ‚îÇ
‚îÇ  ‚îÇ  Request    ‚îÇ                                                                ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                                                ‚îÇ
‚îÇ         ‚îÇ                                                                        ‚îÇ
‚îÇ         ‚Üì                                                                        ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê           ‚îÇ
‚îÇ  ‚îÇ              Assignment Service (Deterministic)                  ‚îÇ           ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Consistent hashing (user_id ‚Üí experiment variant)             ‚îÇ           ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Handles traffic allocation (10% to exp1, 5% to exp2)          ‚îÇ           ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Prevents collisions (layering, namespaces)                    ‚îÇ           ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Returns: {exp_id: variant, exp_id: variant, ...}              ‚îÇ           ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò           ‚îÇ
‚îÇ                           ‚îÇ                                                      ‚îÇ
‚îÇ         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                   ‚îÇ
‚îÇ         ‚Üì                                   ‚Üì                                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                           ‚îÇ
‚îÇ  ‚îÇ  Application ‚îÇ                   ‚îÇ  Event Logger‚îÇ                           ‚îÇ
‚îÇ  ‚îÇ  (Treatment) ‚îÇ                   ‚îÇ   (Kafka)    ‚îÇ                           ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                           ‚îÇ
‚îÇ         ‚îÇ                                  ‚îÇ                                   ‚îÇ
‚îÇ         ‚îÇ Events (clicks, purchases, etc.) ‚îÇ                                   ‚îÇ
‚îÇ         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                   ‚îÇ
‚îÇ                            ‚Üì                                                    ‚îÇ
‚îÇ         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                           ‚îÇ
‚îÇ         ‚îÇ     Data Warehouse (BigQuery, Redshift)  ‚îÇ                           ‚îÇ
‚îÇ         ‚îÇ  ‚Ä¢ Assignment logs (user, experiment, variant, timestamp)            ‚îÇ
‚îÇ         ‚îÇ  ‚Ä¢ Event logs (user, event_type, value, timestamp)                   ‚îÇ
‚îÇ         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                           ‚îÇ
‚îÇ                               ‚îÇ                                                 ‚îÇ
‚îÇ                               ‚Üì                                                 ‚îÇ
‚îÇ         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                           ‚îÇ
‚îÇ         ‚îÇ      Metrics Pipeline (Spark, Airflow)   ‚îÇ                           ‚îÇ
‚îÇ         ‚îÇ  ‚Ä¢ Join assignments + events              ‚îÇ                           ‚îÇ
‚îÇ         ‚îÇ  ‚Ä¢ Compute metrics per user per day       ‚îÇ                           ‚îÇ
‚îÇ         ‚îÇ  ‚Ä¢ Aggregate by experiment + variant      ‚îÇ                           ‚îÇ
‚îÇ         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                           ‚îÇ
‚îÇ                               ‚îÇ                                                 ‚îÇ
‚îÇ           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                            ‚îÇ
‚îÇ           ‚Üì                   ‚Üì                   ‚Üì                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                  ‚îÇ
‚îÇ  ‚îÇ  SRM Detector  ‚îÇ  ‚îÇ Analysis Engine‚îÇ  ‚îÇ  Guardrail     ‚îÇ                  ‚îÇ
‚îÇ  ‚îÇ  (Chi-square)  ‚îÇ  ‚îÇ  (t-tests, CI) ‚îÇ  ‚îÇ  Monitor       ‚îÇ                  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                  ‚îÇ
‚îÇ           ‚îÇ                   ‚îÇ                   ‚îÇ                            ‚îÇ
‚îÇ           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                            ‚îÇ
‚îÇ                               ‚Üì                                                 ‚îÇ
‚îÇ           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                            ‚îÇ
‚îÇ           ‚îÇ      Dashboard (Web UI, API)          ‚îÇ                            ‚îÇ
‚îÇ           ‚îÇ  ‚Ä¢ Real-time results                   ‚îÇ                            ‚îÇ
‚îÇ           ‚îÇ  ‚Ä¢ Confidence intervals                ‚îÇ                            ‚îÇ
‚îÇ           ‚îÇ  ‚Ä¢ Alerts (SRM, guardrail breaches)   ‚îÇ                            ‚îÇ
‚îÇ           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                            ‚îÇ
‚îÇ                                                                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Core Components (Detailed):</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>hashlib</span>
<span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>List</span><span class=p>,</span> <span class=n>Optional</span>
<span class=kn>from</span><span class=w> </span><span class=nn>datetime</span><span class=w> </span><span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timedelta</span>

<span class=c1># Production: Experimentation Platform Components</span>

<span class=c1># ===== 1. Assignment Service =====</span>

<span class=k>class</span><span class=w> </span><span class=nc>AssignmentService</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Deterministic, consistent assignment of users to experiments.</span>
<span class=sd>    Uses hashing to ensure same user always gets same variant.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>experiments</span> <span class=o>=</span> <span class=p>{}</span>

    <span class=k>def</span><span class=w> </span><span class=nf>register_experiment</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>exp_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>variants</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span> 
                           <span class=n>traffic_allocation</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>1.0</span><span class=p>,</span>
                           <span class=n>layer</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;default&#39;</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Register a new experiment.</span>

<span class=sd>        exp_id: Unique experiment identifier</span>
<span class=sd>        variants: List of variant names (e.g., [&#39;control&#39;, &#39;treatment&#39;])</span>
<span class=sd>        traffic_allocation: % of users in experiment (0.0-1.0)</span>
<span class=sd>        layer: Namespace for preventing collisions</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>experiments</span><span class=p>[</span><span class=n>exp_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s1>&#39;variants&#39;</span><span class=p>:</span> <span class=n>variants</span><span class=p>,</span>
            <span class=s1>&#39;allocation&#39;</span><span class=p>:</span> <span class=n>traffic_allocation</span><span class=p>,</span>
            <span class=s1>&#39;layer&#39;</span><span class=p>:</span> <span class=n>layer</span><span class=p>,</span>
            <span class=s1>&#39;created_at&#39;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
        <span class=p>}</span>

    <span class=k>def</span><span class=w> </span><span class=nf>assign_user</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>exp_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Assign user to experiment variant using consistent hashing.</span>

<span class=sd>        Returns: variant name or None if user not in experiment</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=n>exp_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>experiments</span><span class=p>:</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=n>exp</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>experiments</span><span class=p>[</span><span class=n>exp_id</span><span class=p>]</span>

        <span class=c1># Hash user_id + exp_id for consistency</span>
        <span class=n>hash_input</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>user_id</span><span class=si>}</span><span class=s2>:</span><span class=si>{</span><span class=n>exp_id</span><span class=si>}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span>
        <span class=n>hash_value</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>(</span><span class=n>hash_input</span><span class=p>)</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>(),</span> <span class=mi>16</span><span class=p>)</span>

        <span class=c1># Normalize to [0, 1]</span>
        <span class=n>hash_normalized</span> <span class=o>=</span> <span class=p>(</span><span class=n>hash_value</span> <span class=o>%</span> <span class=mi>1000000</span><span class=p>)</span> <span class=o>/</span> <span class=mi>1000000</span>

        <span class=c1># Check if user in experiment (traffic allocation)</span>
        <span class=k>if</span> <span class=n>hash_normalized</span> <span class=o>&gt;=</span> <span class=n>exp</span><span class=p>[</span><span class=s1>&#39;allocation&#39;</span><span class=p>]:</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=c1># Assign to variant based on hash</span>
        <span class=n>variant_idx</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>hash_normalized</span> <span class=o>/</span> <span class=n>exp</span><span class=p>[</span><span class=s1>&#39;allocation&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=nb>len</span><span class=p>(</span><span class=n>exp</span><span class=p>[</span><span class=s1>&#39;variants&#39;</span><span class=p>]))</span>
        <span class=k>return</span> <span class=n>exp</span><span class=p>[</span><span class=s1>&#39;variants&#39;</span><span class=p>][</span><span class=n>variant_idx</span><span class=p>]</span>

    <span class=k>def</span><span class=w> </span><span class=nf>get_all_assignments</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>str</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Get all active experiment assignments for a user.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>assignments</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=k>for</span> <span class=n>exp_id</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>experiments</span><span class=p>:</span>
            <span class=n>variant</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>assign_user</span><span class=p>(</span><span class=n>user_id</span><span class=p>,</span> <span class=n>exp_id</span><span class=p>)</span>
            <span class=k>if</span> <span class=n>variant</span><span class=p>:</span>
                <span class=n>assignments</span><span class=p>[</span><span class=n>exp_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>variant</span>
        <span class=k>return</span> <span class=n>assignments</span>


<span class=c1># ===== 2. Event Logger =====</span>

<span class=k>class</span><span class=w> </span><span class=nc>EventLogger</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Log events and assignments for offline analysis.</span>
<span class=sd>    In production: Kafka ‚Üí S3/BigQuery</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>assignment_logs</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>event_logs</span> <span class=o>=</span> <span class=p>[]</span>

    <span class=k>def</span><span class=w> </span><span class=nf>log_assignment</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>exp_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>variant</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>timestamp</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Log user assignment to experiment variant.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>assignment_logs</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
            <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=n>user_id</span><span class=p>,</span>
            <span class=s1>&#39;exp_id&#39;</span><span class=p>:</span> <span class=n>exp_id</span><span class=p>,</span>
            <span class=s1>&#39;variant&#39;</span><span class=p>:</span> <span class=n>variant</span><span class=p>,</span>
            <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>timestamp</span> <span class=ow>or</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
        <span class=p>})</span>

    <span class=k>def</span><span class=w> </span><span class=nf>log_event</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>event_type</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>value</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>timestamp</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Log user event (click, purchase, etc.).</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>event_logs</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
            <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=n>user_id</span><span class=p>,</span>
            <span class=s1>&#39;event_type&#39;</span><span class=p>:</span> <span class=n>event_type</span><span class=p>,</span>
            <span class=s1>&#39;value&#39;</span><span class=p>:</span> <span class=n>value</span><span class=p>,</span>
            <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>timestamp</span> <span class=ow>or</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
        <span class=p>})</span>

    <span class=k>def</span><span class=w> </span><span class=nf>get_assignment_df</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Return assignments as DataFrame.&quot;&quot;&quot;</span>
        <span class=k>return</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>assignment_logs</span><span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>get_event_df</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Return events as DataFrame.&quot;&quot;&quot;</span>
        <span class=k>return</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>event_logs</span><span class=p>)</span>


<span class=c1># ===== 3. Metrics Pipeline =====</span>

<span class=k>class</span><span class=w> </span><span class=nc>MetricsPipeline</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Compute experiment metrics by joining assignments and events.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>logger</span><span class=p>:</span> <span class=n>EventLogger</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span> <span class=o>=</span> <span class=n>logger</span>

    <span class=k>def</span><span class=w> </span><span class=nf>compute_metrics</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>exp_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>metric_type</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;conversion&#39;</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Compute metrics for an experiment.</span>

<span class=sd>        metric_type: &#39;conversion&#39;, &#39;revenue&#39;, &#39;engagement&#39;, etc.</span>

<span class=sd>        Returns: DataFrame with metrics per variant</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>assignments</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>get_assignment_df</span><span class=p>()</span>
        <span class=n>events</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>get_event_df</span><span class=p>()</span>

        <span class=c1># Filter to experiment</span>
        <span class=n>exp_assignments</span> <span class=o>=</span> <span class=n>assignments</span><span class=p>[</span><span class=n>assignments</span><span class=p>[</span><span class=s1>&#39;exp_id&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>exp_id</span><span class=p>]</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>

        <span class=k>if</span> <span class=n>metric_type</span> <span class=o>==</span> <span class=s1>&#39;conversion&#39;</span><span class=p>:</span>
            <span class=c1># Binary conversion: did user complete target event?</span>
            <span class=n>target_event</span> <span class=o>=</span> <span class=s1>&#39;purchase&#39;</span>  <span class=c1># Example</span>
            <span class=n>conversions</span> <span class=o>=</span> <span class=n>events</span><span class=p>[</span><span class=n>events</span><span class=p>[</span><span class=s1>&#39;event_type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>target_event</span><span class=p>][</span><span class=s1>&#39;user_id&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>unique</span><span class=p>()</span>
            <span class=n>exp_assignments</span><span class=p>[</span><span class=s1>&#39;converted&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>exp_assignments</span><span class=p>[</span><span class=s1>&#39;user_id&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>isin</span><span class=p>(</span><span class=n>conversions</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>

            <span class=c1># Aggregate by variant</span>
            <span class=n>results</span> <span class=o>=</span> <span class=n>exp_assignments</span><span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=s1>&#39;variant&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>agg</span><span class=p>({</span>
                <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=s1>&#39;count&#39;</span><span class=p>,</span>
                <span class=s1>&#39;converted&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;sum&#39;</span><span class=p>,</span> <span class=s1>&#39;mean&#39;</span><span class=p>]</span>
            <span class=p>})</span><span class=o>.</span><span class=n>reset_index</span><span class=p>()</span>

            <span class=n>results</span><span class=o>.</span><span class=n>columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;variant&#39;</span><span class=p>,</span> <span class=s1>&#39;n_users&#39;</span><span class=p>,</span> <span class=s1>&#39;n_conversions&#39;</span><span class=p>,</span> <span class=s1>&#39;conversion_rate&#39;</span><span class=p>]</span>

        <span class=k>elif</span> <span class=n>metric_type</span> <span class=o>==</span> <span class=s1>&#39;revenue&#39;</span><span class=p>:</span>
            <span class=c1># Sum revenue per user</span>
            <span class=n>revenue_events</span> <span class=o>=</span> <span class=n>events</span><span class=p>[</span><span class=n>events</span><span class=p>[</span><span class=s1>&#39;event_type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;purchase&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
            <span class=n>user_revenue</span> <span class=o>=</span> <span class=n>revenue_events</span><span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=s1>&#39;user_id&#39;</span><span class=p>)[</span><span class=s1>&#39;value&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span><span class=o>.</span><span class=n>reset_index</span><span class=p>()</span>
            <span class=n>user_revenue</span><span class=o>.</span><span class=n>columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;user_id&#39;</span><span class=p>,</span> <span class=s1>&#39;revenue&#39;</span><span class=p>]</span>

            <span class=c1># Join with assignments</span>
            <span class=n>exp_data</span> <span class=o>=</span> <span class=n>exp_assignments</span><span class=o>.</span><span class=n>merge</span><span class=p>(</span><span class=n>user_revenue</span><span class=p>,</span> <span class=n>on</span><span class=o>=</span><span class=s1>&#39;user_id&#39;</span><span class=p>,</span> <span class=n>how</span><span class=o>=</span><span class=s1>&#39;left&#39;</span><span class=p>)</span>
            <span class=n>exp_data</span><span class=p>[</span><span class=s1>&#39;revenue&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>exp_data</span><span class=p>[</span><span class=s1>&#39;revenue&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>fillna</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>

            <span class=c1># Aggregate</span>
            <span class=n>results</span> <span class=o>=</span> <span class=n>exp_data</span><span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=s1>&#39;variant&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>agg</span><span class=p>({</span>
                <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=s1>&#39;count&#39;</span><span class=p>,</span>
                <span class=s1>&#39;revenue&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;sum&#39;</span><span class=p>,</span> <span class=s1>&#39;mean&#39;</span><span class=p>,</span> <span class=s1>&#39;std&#39;</span><span class=p>]</span>
            <span class=p>})</span><span class=o>.</span><span class=n>reset_index</span><span class=p>()</span>

            <span class=n>results</span><span class=o>.</span><span class=n>columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;variant&#39;</span><span class=p>,</span> <span class=s1>&#39;n_users&#39;</span><span class=p>,</span> <span class=s1>&#39;total_revenue&#39;</span><span class=p>,</span> <span class=s1>&#39;mean_revenue&#39;</span><span class=p>,</span> <span class=s1>&#39;std_revenue&#39;</span><span class=p>]</span>

        <span class=k>return</span> <span class=n>results</span>


<span class=c1># ===== 4. SRM Detector =====</span>

<span class=k>class</span><span class=w> </span><span class=nc>SRMDetector</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Detect Sample Ratio Mismatch (assignment bugs).</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=nf>check_srm</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>exp_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>assignments_df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span> 
                 <span class=n>expected_ratio</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>float</span><span class=p>],</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.001</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Chi-square test for SRM.</span>

<span class=sd>        expected_ratio: {&#39;control&#39;: 0.5, &#39;treatment&#39;: 0.5}</span>
<span class=sd>        alpha: Significance level (use 0.001 for SRM, very strict)</span>

<span class=sd>        Returns: (is_srm, p_value, chi2_stat)</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>exp_data</span> <span class=o>=</span> <span class=n>assignments_df</span><span class=p>[</span><span class=n>assignments_df</span><span class=p>[</span><span class=s1>&#39;exp_id&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>exp_id</span><span class=p>]</span>

        <span class=n>observed</span> <span class=o>=</span> <span class=n>exp_data</span><span class=p>[</span><span class=s1>&#39;variant&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>value_counts</span><span class=p>()</span><span class=o>.</span><span class=n>to_dict</span><span class=p>()</span>
        <span class=n>total</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>observed</span><span class=o>.</span><span class=n>values</span><span class=p>())</span>

        <span class=c1># Expected counts</span>
        <span class=n>expected</span> <span class=o>=</span> <span class=p>{</span><span class=n>v</span><span class=p>:</span> <span class=n>total</span> <span class=o>*</span> <span class=n>expected_ratio</span><span class=p>[</span><span class=n>v</span><span class=p>]</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>expected_ratio</span><span class=p>}</span>

        <span class=c1># Chi-square test</span>
        <span class=n>chi2_stat</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>((</span><span class=n>observed</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>v</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>-</span> <span class=n>expected</span><span class=p>[</span><span class=n>v</span><span class=p>])</span><span class=o>**</span><span class=mi>2</span> <span class=o>/</span> <span class=n>expected</span><span class=p>[</span><span class=n>v</span><span class=p>]</span> 
                       <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>expected_ratio</span><span class=p>)</span>

        <span class=n>df</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>expected_ratio</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span>
        <span class=n>p_value</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>-</span> <span class=n>stats</span><span class=o>.</span><span class=n>chi2</span><span class=o>.</span><span class=n>cdf</span><span class=p>(</span><span class=n>chi2_stat</span><span class=p>,</span> <span class=n>df</span><span class=p>)</span>

        <span class=n>is_srm</span> <span class=o>=</span> <span class=n>p_value</span> <span class=o>&lt;</span> <span class=n>alpha</span>

        <span class=k>return</span> <span class=n>is_srm</span><span class=p>,</span> <span class=n>p_value</span><span class=p>,</span> <span class=n>chi2_stat</span>


<span class=c1># ===== 5. Analysis Engine =====</span>

<span class=k>class</span><span class=w> </span><span class=nc>AnalysisEngine</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Run statistical tests on experiment metrics.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=nf>analyze_proportions</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>control_conversions</span><span class=p>,</span> <span class=n>control_n</span><span class=p>,</span> 
                           <span class=n>treatment_conversions</span><span class=p>,</span> <span class=n>treatment_n</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Z-test for conversion rate difference.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>p_control</span> <span class=o>=</span> <span class=n>control_conversions</span> <span class=o>/</span> <span class=n>control_n</span>
        <span class=n>p_treatment</span> <span class=o>=</span> <span class=n>treatment_conversions</span> <span class=o>/</span> <span class=n>treatment_n</span>

        <span class=c1># Pooled proportion</span>
        <span class=n>p_pooled</span> <span class=o>=</span> <span class=p>(</span><span class=n>control_conversions</span> <span class=o>+</span> <span class=n>treatment_conversions</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=n>control_n</span> <span class=o>+</span> <span class=n>treatment_n</span><span class=p>)</span>
        <span class=n>se_pooled</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>p_pooled</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>p_pooled</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span><span class=o>/</span><span class=n>control_n</span> <span class=o>+</span> <span class=mi>1</span><span class=o>/</span><span class=n>treatment_n</span><span class=p>))</span>

        <span class=n>z_stat</span> <span class=o>=</span> <span class=p>(</span><span class=n>p_treatment</span> <span class=o>-</span> <span class=n>p_control</span><span class=p>)</span> <span class=o>/</span> <span class=n>se_pooled</span>
        <span class=n>p_value</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>stats</span><span class=o>.</span><span class=n>norm</span><span class=o>.</span><span class=n>cdf</span><span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>z_stat</span><span class=p>)))</span>

        <span class=c1># Confidence interval</span>
        <span class=n>diff</span> <span class=o>=</span> <span class=n>p_treatment</span> <span class=o>-</span> <span class=n>p_control</span>
        <span class=n>se_diff</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>p_control</span><span class=o>*</span><span class=p>(</span><span class=mi>1</span><span class=o>-</span><span class=n>p_control</span><span class=p>)</span><span class=o>/</span><span class=n>control_n</span> <span class=o>+</span> 
                         <span class=n>p_treatment</span><span class=o>*</span><span class=p>(</span><span class=mi>1</span><span class=o>-</span><span class=n>p_treatment</span><span class=p>)</span><span class=o>/</span><span class=n>treatment_n</span><span class=p>)</span>
        <span class=n>ci_lower</span> <span class=o>=</span> <span class=n>diff</span> <span class=o>-</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=n>se_diff</span>
        <span class=n>ci_upper</span> <span class=o>=</span> <span class=n>diff</span> <span class=o>+</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=n>se_diff</span>

        <span class=k>return</span> <span class=p>{</span>
            <span class=s1>&#39;control_rate&#39;</span><span class=p>:</span> <span class=n>p_control</span><span class=p>,</span>
            <span class=s1>&#39;treatment_rate&#39;</span><span class=p>:</span> <span class=n>p_treatment</span><span class=p>,</span>
            <span class=s1>&#39;absolute_lift&#39;</span><span class=p>:</span> <span class=n>diff</span><span class=p>,</span>
            <span class=s1>&#39;relative_lift&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>p_treatment</span> <span class=o>/</span> <span class=n>p_control</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=mi>100</span><span class=p>,</span>
            <span class=s1>&#39;p_value&#39;</span><span class=p>:</span> <span class=n>p_value</span><span class=p>,</span>
            <span class=s1>&#39;significant&#39;</span><span class=p>:</span> <span class=n>p_value</span> <span class=o>&lt;</span> <span class=n>alpha</span><span class=p>,</span>
            <span class=s1>&#39;ci_lower&#39;</span><span class=p>:</span> <span class=n>ci_lower</span><span class=p>,</span>
            <span class=s1>&#39;ci_upper&#39;</span><span class=p>:</span> <span class=n>ci_upper</span>
        <span class=p>}</span>


<span class=c1># ===== Example: Full Pipeline =====</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;EXPERIMENTATION PLATFORM DEMO&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>

<span class=c1># Initialize services</span>
<span class=n>assigner</span> <span class=o>=</span> <span class=n>AssignmentService</span><span class=p>()</span>
<span class=n>logger</span> <span class=o>=</span> <span class=n>EventLogger</span><span class=p>()</span>
<span class=n>pipeline</span> <span class=o>=</span> <span class=n>MetricsPipeline</span><span class=p>(</span><span class=n>logger</span><span class=p>)</span>
<span class=n>srm_detector</span> <span class=o>=</span> <span class=n>SRMDetector</span><span class=p>()</span>
<span class=n>analyzer</span> <span class=o>=</span> <span class=n>AnalysisEngine</span><span class=p>()</span>

<span class=c1># Register experiment</span>
<span class=n>assigner</span><span class=o>.</span><span class=n>register_experiment</span><span class=p>(</span>
    <span class=n>exp_id</span><span class=o>=</span><span class=s1>&#39;exp_001_new_checkout&#39;</span><span class=p>,</span>
    <span class=n>variants</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;control&#39;</span><span class=p>,</span> <span class=s1>&#39;treatment&#39;</span><span class=p>],</span>
    <span class=n>traffic_allocation</span><span class=o>=</span><span class=mf>1.0</span>  <span class=c1># 100% of users</span>
<span class=p>)</span>

<span class=c1># Simulate user assignments and events</span>
<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
<span class=n>n_users</span> <span class=o>=</span> <span class=mi>10000</span>

<span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_users</span><span class=p>):</span>
    <span class=n>user_id</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;user_</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1>&#39;</span>

    <span class=c1># Assign to variant</span>
    <span class=n>variant</span> <span class=o>=</span> <span class=n>assigner</span><span class=o>.</span><span class=n>assign_user</span><span class=p>(</span><span class=n>user_id</span><span class=p>,</span> <span class=s1>&#39;exp_001_new_checkout&#39;</span><span class=p>)</span>

    <span class=k>if</span> <span class=n>variant</span><span class=p>:</span>
        <span class=c1># Log assignment</span>
        <span class=n>logger</span><span class=o>.</span><span class=n>log_assignment</span><span class=p>(</span><span class=n>user_id</span><span class=p>,</span> <span class=s1>&#39;exp_001_new_checkout&#39;</span><span class=p>,</span> <span class=n>variant</span><span class=p>)</span>

        <span class=c1># Simulate purchase (treatment has 12% CVR, control 10%)</span>
        <span class=n>cvr</span> <span class=o>=</span> <span class=mf>0.12</span> <span class=k>if</span> <span class=n>variant</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span> <span class=k>else</span> <span class=mf>0.10</span>
        <span class=k>if</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>rand</span><span class=p>()</span> <span class=o>&lt;</span> <span class=n>cvr</span><span class=p>:</span>
            <span class=n>logger</span><span class=o>.</span><span class=n>log_event</span><span class=p>(</span><span class=n>user_id</span><span class=p>,</span> <span class=s1>&#39;purchase&#39;</span><span class=p>,</span> <span class=n>value</span><span class=o>=</span><span class=mf>50.0</span><span class=p>)</span>

<span class=c1># Check SRM</span>
<span class=n>assignments_df</span> <span class=o>=</span> <span class=n>logger</span><span class=o>.</span><span class=n>get_assignment_df</span><span class=p>()</span>
<span class=n>is_srm</span><span class=p>,</span> <span class=n>srm_p</span><span class=p>,</span> <span class=n>srm_chi2</span> <span class=o>=</span> <span class=n>srm_detector</span><span class=o>.</span><span class=n>check_srm</span><span class=p>(</span>
    <span class=s1>&#39;exp_001_new_checkout&#39;</span><span class=p>,</span> 
    <span class=n>assignments_df</span><span class=p>,</span> 
    <span class=p>{</span><span class=s1>&#39;control&#39;</span><span class=p>:</span> <span class=mf>0.5</span><span class=p>,</span> <span class=s1>&#39;treatment&#39;</span><span class=p>:</span> <span class=mf>0.5</span><span class=p>}</span>
<span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üîç SRM Check:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   p-value: </span><span class=si>{</span><span class=n>srm_p</span><span class=si>:</span><span class=s2>.6f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   SRM detected: </span><span class=si>{</span><span class=s1>&#39;YES ‚ö†Ô∏è&#39;</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>is_srm</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=s1>&#39;NO ‚úì&#39;</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Compute metrics</span>
<span class=n>metrics</span> <span class=o>=</span> <span class=n>pipeline</span><span class=o>.</span><span class=n>compute_metrics</span><span class=p>(</span><span class=s1>&#39;exp_001_new_checkout&#39;</span><span class=p>,</span> <span class=n>metric_type</span><span class=o>=</span><span class=s1>&#39;conversion&#39;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìä Metrics:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>metrics</span><span class=o>.</span><span class=n>to_string</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>))</span>

<span class=c1># Analyze</span>
<span class=n>control_data</span> <span class=o>=</span> <span class=n>metrics</span><span class=p>[</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;variant&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;control&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
<span class=n>treatment_data</span> <span class=o>=</span> <span class=n>metrics</span><span class=p>[</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;variant&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>

<span class=n>result</span> <span class=o>=</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>analyze_proportions</span><span class=p>(</span>
    <span class=n>control_data</span><span class=p>[</span><span class=s1>&#39;n_conversions&#39;</span><span class=p>],</span> <span class=n>control_data</span><span class=p>[</span><span class=s1>&#39;n_users&#39;</span><span class=p>],</span>
    <span class=n>treatment_data</span><span class=p>[</span><span class=s1>&#39;n_conversions&#39;</span><span class=p>],</span> <span class=n>treatment_data</span><span class=p>[</span><span class=s1>&#39;n_users&#39;</span><span class=p>]</span>
<span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìà Analysis Results:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Control CVR: </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;control_rate&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Treatment CVR: </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;treatment_rate&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Lift: </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;relative_lift&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>+.2f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   95% CI: [</span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;ci_lower&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;ci_upper&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>]&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   p-value: </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;p_value&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Significant: </span><span class=si>{</span><span class=s1>&#39;YES ‚úì&#39;</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;significant&#39;</span><span class=p>]</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=s1>&#39;NO ‚úó&#39;</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</code></pre></div> <p><strong>Scale Comparison:</strong></p> <table> <thead> <tr> <th>Company</th> <th>Experiments/Year</th> <th>Concurrent</th> <th>Users/Experiment</th> <th>Platform</th> <th>Key Features</th> </tr> </thead> <tbody> <tr> <td><strong>Google</strong></td> <td>10,000+</td> <td>1,000+</td> <td>100M+</td> <td>Proprietary</td> <td>Layered experiments, Bayesian methods</td> </tr> <tr> <td><strong>Netflix</strong></td> <td>1,000+</td> <td>100+</td> <td>10M+</td> <td>Proprietary</td> <td>Sequential testing, heterogeneous effects</td> </tr> <tr> <td><strong>Meta</strong></td> <td>10,000+</td> <td>1,000+</td> <td>1B+</td> <td>Ax Platform</td> <td>Multi-armed bandits, Bayesian optimization</td> </tr> <tr> <td><strong>Uber</strong></td> <td>2,000+</td> <td>200+</td> <td>50M+</td> <td>Proprietary</td> <td>Geographic experiments, supply-demand balance</td> </tr> <tr> <td><strong>Airbnb</strong></td> <td>700+</td> <td>50+</td> <td>10M+</td> <td>ERF (Experiment Reporting Framework)</td> <td>Network effects, two-sided marketplace</td> </tr> </tbody> </table> <p><strong>Platform Feature Comparison:</strong></p> <table> <thead> <tr> <th>Feature</th> <th>Basic Platform</th> <th>Advanced Platform (Google, Netflix)</th> </tr> </thead> <tbody> <tr> <td><strong>Assignment</strong></td> <td>Random hash</td> <td>Consistent hash + layering + traffic shaping</td> </tr> <tr> <td><strong>SRM Detection</strong></td> <td>Manual checks</td> <td>Automated alerts (&lt;0.001 p-value threshold)</td> </tr> <tr> <td><strong>Analysis</strong></td> <td>T-test only</td> <td>Multiple methods (frequentist, Bayesian, bootstrap)</td> </tr> <tr> <td><strong>Guardrails</strong></td> <td>Manual review</td> <td>Automated circuit breakers (&gt;5% drop ‚Üí auto-stop)</td> </tr> <tr> <td><strong>Metrics</strong></td> <td>5-10 metrics</td> <td>100+ metrics tracked automatically</td> </tr> <tr> <td><strong>Interference</strong></td> <td>Ignore</td> <td>Detect and adjust (geo-randomization, clustering)</td> </tr> <tr> <td><strong>Sequential Testing</strong></td> <td>Fixed horizon</td> <td>Sequential with alpha spending</td> </tr> <tr> <td><strong>Heterogeneity</strong></td> <td>Overall effect only</td> <td>CATE, segment deep-dives</td> </tr> </tbody> </table> <p><strong>Key Design Decisions:</strong></p> <table> <thead> <tr> <th>Decision</th> <th>Trade-off</th> <th>Recommendation</th> </tr> </thead> <tbody> <tr> <td><strong>Hashing vs Random</strong></td> <td>Deterministic vs truly random</td> <td>Use hashing (reproducibility, debugging)</td> </tr> <tr> <td><strong>Real-time vs Batch</strong></td> <td>Latency vs cost</td> <td>Real-time for dashboards, batch for deep analysis</td> </tr> <tr> <td><strong>Centralized vs Federated</strong></td> <td>Control vs flexibility</td> <td>Centralized assignment, federated metrics</td> </tr> <tr> <td><strong>SQL vs Spark</strong></td> <td>Simplicity vs scale</td> <td>SQL for &lt;1TB, Spark for &gt;1TB</td> </tr> <tr> <td><strong>SRM threshold</strong></td> <td>False alarms vs miss bugs</td> <td>Œ±=0.001 (very strict, catch bugs early)</td> </tr> </tbody> </table> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p><strong>What they're testing:</strong> System design skills, understanding of scale, trade-offs, and production concerns.</p> <p><strong>Strong answer signals:</strong></p> <ul> <li>Draws architecture diagram with 5+ components</li> <li>Explains consistent hashing for deterministic assignment</li> <li>Mentions SRM detection as critical guardrail</li> <li>Discusses scale (e.g., "Netflix runs 100+ concurrent experiments")</li> <li>Knows layering/namespaces to prevent experiment collisions</li> <li>Addresses data pipeline (assignments + events ‚Üí metrics)</li> <li>Mentions automation (auto-stop for guardrail breaches)</li> <li>Explains trade-offs (real-time vs batch, SQL vs Spark)</li> </ul> <p><strong>Red flags:</strong></p> <ul> <li>No mention of SRM or assignment consistency</li> <li>Unclear how assignments join with events</li> <li>Ignores scale considerations</li> <li>Only focuses on analysis, not assignment/logging</li> <li>No automation or guardrails</li> </ul> <p><strong>Follow-up questions:</strong></p> <ul> <li>"How do you prevent two experiments from interfering?" (Layering: assign to layer first, then experiment within layer)</li> <li>"What if you have 1000 concurrent experiments?" (Namespace by product area, use consistent hashing to prevent overlap)</li> <li>"How quickly can you detect experiment bugs?" (Real-time SRM checks, alert within 1 hour if p&lt;0.001)</li> </ul> </div> </details> <hr> <h3 id=what-is-stratified-randomization-netflix-uber-interview-question>What is Stratified Randomization? - Netflix, Uber Interview Question</h3> <p><strong>Difficulty:</strong> üü° Medium | <strong>Tags:</strong> <code>Design</code> | <strong>Asked by:</strong> Netflix, Uber, Airbnb</p> <details class=success> <summary>View Answer</summary> <p><strong>Stratified Randomization</strong> ensures <strong>balanced representation</strong> of key covariates (country, device, user tenure) across control and treatment groups, reducing variance in treatment effect estimates by <strong>20-50%</strong>. It's especially powerful when covariates are <strong>highly predictive</strong> of the outcome metric.</p> <p><strong>Why Stratify?</strong></p> <p>Without stratification, random assignment might create <strong>imbalanced groups</strong> by chance, leading to: - Higher variance in treatment effect estimates - Reduced statistical power (need more samples) - Risk of confounding (e.g., treatment group has more iOS users who spend more)</p> <p><strong>Stratification Workflow:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Stratified Randomization Process                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                          ‚îÇ
‚îÇ  Step 1: Identify Stratification Variables                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ High correlation with outcome (r &gt; 0.3)                 ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Observable before randomization                          ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Limited categories (&lt;10 to avoid sparse strata)          ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ                                                             ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ  Examples: Country, Device Type, User Tenure, Plan Tier    ‚îÇ         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îÇ                            ‚Üì                                             ‚îÇ
‚îÇ  Step 2: Create Strata (Blocks)                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ  ‚îÇ  Stratum 1: US + iOS + New Users                            ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ  Stratum 2: US + iOS + Old Users                            ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ  Stratum 3: US + Android + New Users                        ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ  ...                                                         ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ  Stratum K: India + Android + Old Users                     ‚îÇ         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îÇ                            ‚Üì                                             ‚îÇ
‚îÇ  Step 3: Randomize Within Each Stratum                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ  ‚îÇ  Stratum 1 (n=1000) ‚Üí 50% Control (500), 50% Treatment (500)‚îÇ         ‚îÇ
‚îÇ  ‚îÇ  Stratum 2 (n=500)  ‚Üí 50% Control (250), 50% Treatment (250)‚îÇ         ‚îÇ
‚îÇ  ‚îÇ  ...                                                         ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ  Stratum K (n=200)  ‚Üí 50% Control (100), 50% Treatment (100)‚îÇ         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îÇ                            ‚Üì                                             ‚îÇ
‚îÇ  Step 4: Analyze with Stratification                                    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Compute treatment effect within each stratum             ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Weight by stratum size to get overall effect             ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Reduced variance ‚Üí Narrower confidence intervals         ‚îÇ         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îÇ                                                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Production Stratification Implementation:</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>from</span><span class=w> </span><span class=nn>sklearn.model_selection</span><span class=w> </span><span class=kn>import</span> <span class=n>StratifiedShuffleSplit</span>
<span class=kn>import</span><span class=w> </span><span class=nn>matplotlib.pyplot</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>plt</span>

<span class=c1># Production: Comprehensive Stratified Randomization System</span>

<span class=k>class</span><span class=w> </span><span class=nc>StratifiedRandomizer</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Stratified randomization for A/B tests with variance reduction analysis.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>random_seed</span><span class=o>=</span><span class=mi>42</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>random_seed</span> <span class=o>=</span> <span class=n>random_seed</span>
        <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=n>random_seed</span><span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>create_strata</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span> <span class=n>strata_cols</span><span class=p>:</span> <span class=nb>list</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Create strata from multiple categorical columns.</span>

<span class=sd>        df: User data with covariates</span>
<span class=sd>        strata_cols: Columns to stratify on (e.g., [&#39;country&#39;, &#39;device&#39;])</span>

<span class=sd>        Returns: DataFrame with &#39;stratum_id&#39; column added</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=c1># Combine columns into single stratum identifier</span>
        <span class=n>df</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
        <span class=n>df</span><span class=p>[</span><span class=s1>&#39;stratum_id&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>strata_cols</span><span class=p>]</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>str</span><span class=p>)</span><span class=o>.</span><span class=n>agg</span><span class=p>(</span><span class=s1>&#39;_&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>

        <span class=c1># Count stratum sizes</span>
        <span class=n>stratum_sizes</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;stratum_id&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>value_counts</span><span class=p>()</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Created </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>stratum_sizes</span><span class=p>)</span><span class=si>}</span><span class=s2> strata&quot;</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Stratum sizes: min=</span><span class=si>{</span><span class=n>stratum_sizes</span><span class=o>.</span><span class=n>min</span><span class=p>()</span><span class=si>}</span><span class=s2>, &quot;</span>
              <span class=sa>f</span><span class=s2>&quot;median=</span><span class=si>{</span><span class=n>stratum_sizes</span><span class=o>.</span><span class=n>median</span><span class=p>()</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>, max=</span><span class=si>{</span><span class=n>stratum_sizes</span><span class=o>.</span><span class=n>max</span><span class=p>()</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

        <span class=k>return</span> <span class=n>df</span>

    <span class=k>def</span><span class=w> </span><span class=nf>stratified_assignment</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span> <span class=n>treatment_ratio</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Assign users to control/treatment within each stratum.</span>

<span class=sd>        df: Must have &#39;stratum_id&#39; column</span>
<span class=sd>        treatment_ratio: Proportion assigned to treatment</span>

<span class=sd>        Returns: DataFrame with &#39;variant&#39; column (&#39;control&#39; or &#39;treatment&#39;)</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>df</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>

        <span class=k>def</span><span class=w> </span><span class=nf>assign_within_stratum</span><span class=p>(</span><span class=n>group</span><span class=p>):</span>
            <span class=n>n</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>group</span><span class=p>)</span>
            <span class=n>n_treatment</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>n</span> <span class=o>*</span> <span class=n>treatment_ratio</span><span class=p>)</span>
            <span class=n>indices</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
            <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>shuffle</span><span class=p>(</span><span class=n>indices</span><span class=p>)</span>

            <span class=n>treatment_indices</span> <span class=o>=</span> <span class=n>indices</span><span class=p>[:</span><span class=n>n_treatment</span><span class=p>]</span>
            <span class=n>group</span><span class=p>[</span><span class=s1>&#39;variant&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;control&#39;</span>
            <span class=n>group</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>treatment_indices</span><span class=p>,</span> <span class=s1>&#39;variant&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;treatment&#39;</span>
            <span class=k>return</span> <span class=n>group</span>

        <span class=n>df</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=s1>&#39;stratum_id&#39;</span><span class=p>,</span> <span class=n>group_keys</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=n>assign_within_stratum</span><span class=p>)</span>

        <span class=k>return</span> <span class=n>df</span>

    <span class=k>def</span><span class=w> </span><span class=nf>check_covariate_balance</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span> <span class=n>covariate_cols</span><span class=p>:</span> <span class=nb>list</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Check if stratification achieved covariate balance.</span>
<span class=sd>        Uses standardized mean difference (SMD).</span>

<span class=sd>        SMD &lt; 0.1 = good balance</span>
<span class=sd>        SMD 0.1-0.2 = acceptable</span>
<span class=sd>        SMD &gt; 0.2 = imbalanced</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>control</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;variant&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;control&#39;</span><span class=p>]</span>
        <span class=n>treatment</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;variant&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>]</span>

        <span class=n>balance_results</span> <span class=o>=</span> <span class=p>[]</span>

        <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>covariate_cols</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>df</span><span class=p>[</span><span class=n>col</span><span class=p>]</span><span class=o>.</span><span class=n>dtype</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;object&#39;</span><span class=p>,</span> <span class=s1>&#39;category&#39;</span><span class=p>]:</span>
                <span class=c1># Categorical: check proportion differences</span>
                <span class=k>for</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>df</span><span class=p>[</span><span class=n>col</span><span class=p>]</span><span class=o>.</span><span class=n>unique</span><span class=p>():</span>
                    <span class=n>p_control</span> <span class=o>=</span> <span class=p>(</span><span class=n>control</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>==</span> <span class=n>value</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
                    <span class=n>p_treatment</span> <span class=o>=</span> <span class=p>(</span><span class=n>treatment</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>==</span> <span class=n>value</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
                    <span class=n>smd</span> <span class=o>=</span> <span class=p>(</span><span class=n>p_treatment</span> <span class=o>-</span> <span class=n>p_control</span><span class=p>)</span> <span class=o>/</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>((</span><span class=n>p_control</span><span class=o>*</span><span class=p>(</span><span class=mi>1</span><span class=o>-</span><span class=n>p_control</span><span class=p>)</span> <span class=o>+</span> 
                                                               <span class=n>p_treatment</span><span class=o>*</span><span class=p>(</span><span class=mi>1</span><span class=o>-</span><span class=n>p_treatment</span><span class=p>))</span><span class=o>/</span><span class=mi>2</span><span class=p>)</span>

                    <span class=n>balance_results</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
                        <span class=s1>&#39;variable&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>col</span><span class=si>}</span><span class=s1>=</span><span class=si>{</span><span class=n>value</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>,</span>
                        <span class=s1>&#39;control_mean&#39;</span><span class=p>:</span> <span class=n>p_control</span><span class=p>,</span>
                        <span class=s1>&#39;treatment_mean&#39;</span><span class=p>:</span> <span class=n>p_treatment</span><span class=p>,</span>
                        <span class=s1>&#39;smd&#39;</span><span class=p>:</span> <span class=nb>abs</span><span class=p>(</span><span class=n>smd</span><span class=p>),</span>
                        <span class=s1>&#39;balanced&#39;</span><span class=p>:</span> <span class=s1>&#39;Yes ‚úì&#39;</span> <span class=k>if</span> <span class=nb>abs</span><span class=p>(</span><span class=n>smd</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mf>0.1</span> <span class=k>else</span> <span class=s1>&#39;No ‚úó&#39;</span>
                    <span class=p>})</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=c1># Continuous: standardized mean difference</span>
                <span class=n>mean_control</span> <span class=o>=</span> <span class=n>control</span><span class=p>[</span><span class=n>col</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
                <span class=n>mean_treatment</span> <span class=o>=</span> <span class=n>treatment</span><span class=p>[</span><span class=n>col</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
                <span class=n>std_pooled</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>((</span><span class=n>control</span><span class=p>[</span><span class=n>col</span><span class=p>]</span><span class=o>.</span><span class=n>var</span><span class=p>()</span> <span class=o>+</span> <span class=n>treatment</span><span class=p>[</span><span class=n>col</span><span class=p>]</span><span class=o>.</span><span class=n>var</span><span class=p>())</span> <span class=o>/</span> <span class=mi>2</span><span class=p>)</span>
                <span class=n>smd</span> <span class=o>=</span> <span class=p>(</span><span class=n>mean_treatment</span> <span class=o>-</span> <span class=n>mean_control</span><span class=p>)</span> <span class=o>/</span> <span class=n>std_pooled</span>

                <span class=n>balance_results</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
                    <span class=s1>&#39;variable&#39;</span><span class=p>:</span> <span class=n>col</span><span class=p>,</span>
                    <span class=s1>&#39;control_mean&#39;</span><span class=p>:</span> <span class=n>mean_control</span><span class=p>,</span>
                    <span class=s1>&#39;treatment_mean&#39;</span><span class=p>:</span> <span class=n>mean_treatment</span><span class=p>,</span>
                    <span class=s1>&#39;smd&#39;</span><span class=p>:</span> <span class=nb>abs</span><span class=p>(</span><span class=n>smd</span><span class=p>),</span>
                    <span class=s1>&#39;balanced&#39;</span><span class=p>:</span> <span class=s1>&#39;Yes ‚úì&#39;</span> <span class=k>if</span> <span class=nb>abs</span><span class=p>(</span><span class=n>smd</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mf>0.1</span> <span class=k>else</span> <span class=s1>&#39;No ‚úó&#39;</span>
                <span class=p>})</span>

        <span class=k>return</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>balance_results</span><span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>compute_variance_reduction</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span> <span class=n>outcome_col</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
                                  <span class=n>strata_col</span><span class=o>=</span><span class=s1>&#39;stratum_id&#39;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Quantify variance reduction from stratification.</span>

<span class=sd>        Compares variance of treatment effect estimate with vs without stratification.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=c1># Unstratified variance (pooled)</span>
        <span class=n>control</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;variant&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;control&#39;</span><span class=p>][</span><span class=n>outcome_col</span><span class=p>]</span>
        <span class=n>treatment</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;variant&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>][</span><span class=n>outcome_col</span><span class=p>]</span>

        <span class=n>var_unstratified</span> <span class=o>=</span> <span class=n>control</span><span class=o>.</span><span class=n>var</span><span class=p>()</span><span class=o>/</span><span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>)</span> <span class=o>+</span> <span class=n>treatment</span><span class=o>.</span><span class=n>var</span><span class=p>()</span><span class=o>/</span><span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>)</span>

        <span class=c1># Stratified variance (weighted by stratum size)</span>
        <span class=n>strata</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>strata_col</span><span class=p>]</span><span class=o>.</span><span class=n>unique</span><span class=p>()</span>
        <span class=n>var_stratified</span> <span class=o>=</span> <span class=mi>0</span>

        <span class=k>for</span> <span class=n>stratum</span> <span class=ow>in</span> <span class=n>strata</span><span class=p>:</span>
            <span class=n>stratum_data</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=n>strata_col</span><span class=p>]</span> <span class=o>==</span> <span class=n>stratum</span><span class=p>]</span>
            <span class=n>s_control</span> <span class=o>=</span> <span class=n>stratum_data</span><span class=p>[</span><span class=n>stratum_data</span><span class=p>[</span><span class=s1>&#39;variant&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;control&#39;</span><span class=p>][</span><span class=n>outcome_col</span><span class=p>]</span>
            <span class=n>s_treatment</span> <span class=o>=</span> <span class=n>stratum_data</span><span class=p>[</span><span class=n>stratum_data</span><span class=p>[</span><span class=s1>&#39;variant&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>][</span><span class=n>outcome_col</span><span class=p>]</span>

            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>s_control</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>s_treatment</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
                <span class=n>stratum_weight</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>stratum_data</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>df</span><span class=p>)</span>
                <span class=n>var_stratum</span> <span class=o>=</span> <span class=n>s_control</span><span class=o>.</span><span class=n>var</span><span class=p>()</span><span class=o>/</span><span class=nb>len</span><span class=p>(</span><span class=n>s_control</span><span class=p>)</span> <span class=o>+</span> <span class=n>s_treatment</span><span class=o>.</span><span class=n>var</span><span class=p>()</span><span class=o>/</span><span class=nb>len</span><span class=p>(</span><span class=n>s_treatment</span><span class=p>)</span>
                <span class=n>var_stratified</span> <span class=o>+=</span> <span class=n>stratum_weight</span><span class=o>**</span><span class=mi>2</span> <span class=o>*</span> <span class=n>var_stratum</span>

        <span class=n>variance_reduction</span> <span class=o>=</span> <span class=p>(</span><span class=n>var_unstratified</span> <span class=o>-</span> <span class=n>var_stratified</span><span class=p>)</span> <span class=o>/</span> <span class=n>var_unstratified</span> <span class=o>*</span> <span class=mi>100</span>

        <span class=k>return</span> <span class=p>{</span>
            <span class=s1>&#39;var_unstratified&#39;</span><span class=p>:</span> <span class=n>var_unstratified</span><span class=p>,</span>
            <span class=s1>&#39;var_stratified&#39;</span><span class=p>:</span> <span class=n>var_stratified</span><span class=p>,</span>
            <span class=s1>&#39;variance_reduction_pct&#39;</span><span class=p>:</span> <span class=n>variance_reduction</span><span class=p>,</span>
            <span class=s1>&#39;effective_sample_multiplier&#39;</span><span class=p>:</span> <span class=mi>1</span> <span class=o>/</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>variance_reduction</span><span class=o>/</span><span class=mi>100</span><span class=p>)</span>
        <span class=p>}</span>


<span class=c1># ===== Example 1: Netflix Content Recommendation =====</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;EXAMPLE 1: NETFLIX - STRATIFIED BY COUNTRY + DEVICE&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>

<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>

<span class=c1># Generate user data</span>
<span class=n>n_users</span> <span class=o>=</span> <span class=mi>10000</span>
<span class=n>countries</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>([</span><span class=s1>&#39;US&#39;</span><span class=p>,</span> <span class=s1>&#39;UK&#39;</span><span class=p>,</span> <span class=s1>&#39;India&#39;</span><span class=p>,</span> <span class=s1>&#39;Brazil&#39;</span><span class=p>],</span> <span class=n>n_users</span><span class=p>,</span> <span class=n>p</span><span class=o>=</span><span class=p>[</span><span class=mf>0.4</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>])</span>
<span class=n>devices</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>([</span><span class=s1>&#39;Web&#39;</span><span class=p>,</span> <span class=s1>&#39;iOS&#39;</span><span class=p>,</span> <span class=s1>&#39;Android&#39;</span><span class=p>,</span> <span class=s1>&#39;TV&#39;</span><span class=p>],</span> <span class=n>n_users</span><span class=p>,</span> <span class=n>p</span><span class=o>=</span><span class=p>[</span><span class=mf>0.3</span><span class=p>,</span> <span class=mf>0.25</span><span class=p>,</span> <span class=mf>0.25</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>])</span>

<span class=c1># Country and device affect watch time (covariate correlation)</span>
<span class=n>country_effect</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;US&#39;</span><span class=p>:</span> <span class=mi>70</span><span class=p>,</span> <span class=s1>&#39;UK&#39;</span><span class=p>:</span> <span class=mi>65</span><span class=p>,</span> <span class=s1>&#39;India&#39;</span><span class=p>:</span> <span class=mi>50</span><span class=p>,</span> <span class=s1>&#39;Brazil&#39;</span><span class=p>:</span> <span class=mi>55</span><span class=p>}</span>
<span class=n>device_effect</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;Web&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;iOS&#39;</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span> <span class=s1>&#39;Android&#39;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=s1>&#39;TV&#39;</span><span class=p>:</span> <span class=mi>10</span><span class=p>}</span>

<span class=n>baseline_watch_time</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=n>country_effect</span><span class=p>[</span><span class=n>c</span><span class=p>]</span> <span class=o>+</span> <span class=n>device_effect</span><span class=p>[</span><span class=n>d</span><span class=p>]</span> 
                                <span class=k>for</span> <span class=n>c</span><span class=p>,</span> <span class=n>d</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>countries</span><span class=p>,</span> <span class=n>devices</span><span class=p>)])</span>
<span class=n>watch_time</span> <span class=o>=</span> <span class=n>baseline_watch_time</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>15</span><span class=p>,</span> <span class=n>n_users</span><span class=p>)</span>

<span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
    <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=p>[</span><span class=sa>f</span><span class=s1>&#39;user_</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1>&#39;</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_users</span><span class=p>)],</span>
    <span class=s1>&#39;country&#39;</span><span class=p>:</span> <span class=n>countries</span><span class=p>,</span>
    <span class=s1>&#39;device&#39;</span><span class=p>:</span> <span class=n>devices</span><span class=p>,</span>
    <span class=s1>&#39;watch_time&#39;</span><span class=p>:</span> <span class=n>watch_time</span>
<span class=p>})</span>

<span class=c1># Initialize stratifier</span>
<span class=n>stratifier</span> <span class=o>=</span> <span class=n>StratifiedRandomizer</span><span class=p>(</span><span class=n>random_seed</span><span class=o>=</span><span class=mi>42</span><span class=p>)</span>

<span class=c1># Create strata</span>
<span class=n>df</span> <span class=o>=</span> <span class=n>stratifier</span><span class=o>.</span><span class=n>create_strata</span><span class=p>(</span><span class=n>df</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;country&#39;</span><span class=p>,</span> <span class=s1>&#39;device&#39;</span><span class=p>])</span>

<span class=c1># Assign to variants</span>
<span class=n>df</span> <span class=o>=</span> <span class=n>stratifier</span><span class=o>.</span><span class=n>stratified_assignment</span><span class=p>(</span><span class=n>df</span><span class=p>,</span> <span class=n>treatment_ratio</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>

<span class=c1># Check balance</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìä Covariate Balance Check:&quot;</span><span class=p>)</span>
<span class=n>balance</span> <span class=o>=</span> <span class=n>stratifier</span><span class=o>.</span><span class=n>check_covariate_balance</span><span class=p>(</span><span class=n>df</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;country&#39;</span><span class=p>,</span> <span class=s1>&#39;device&#39;</span><span class=p>])</span>
<span class=nb>print</span><span class=p>(</span><span class=n>balance</span><span class=o>.</span><span class=n>to_string</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>))</span>

<span class=c1># Simulate treatment effect (+5% watch time in treatment)</span>
<span class=n>treatment_lift</span> <span class=o>=</span> <span class=mf>0.05</span>
<span class=n>df</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;variant&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>,</span> <span class=s1>&#39;watch_time&#39;</span><span class=p>]</span> <span class=o>*=</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>treatment_lift</span><span class=p>)</span>

<span class=c1># Compute variance reduction</span>
<span class=n>var_reduction</span> <span class=o>=</span> <span class=n>stratifier</span><span class=o>.</span><span class=n>compute_variance_reduction</span><span class=p>(</span><span class=n>df</span><span class=p>,</span> <span class=s1>&#39;watch_time&#39;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìà Variance Reduction:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Unstratified variance: </span><span class=si>{</span><span class=n>var_reduction</span><span class=p>[</span><span class=s1>&#39;var_unstratified&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Stratified variance: </span><span class=si>{</span><span class=n>var_reduction</span><span class=p>[</span><span class=s1>&#39;var_stratified&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Variance reduction: </span><span class=si>{</span><span class=n>var_reduction</span><span class=p>[</span><span class=s1>&#39;variance_reduction_pct&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Equivalent to </span><span class=si>{</span><span class=n>var_reduction</span><span class=p>[</span><span class=s1>&#39;effective_sample_multiplier&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>√ó sample size&quot;</span><span class=p>)</span>

<span class=c1># Analyze with and without stratification</span>
<span class=n>control</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;variant&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;control&#39;</span><span class=p>][</span><span class=s1>&#39;watch_time&#39;</span><span class=p>]</span>
<span class=n>treatment</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;variant&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>][</span><span class=s1>&#39;watch_time&#39;</span><span class=p>]</span>

<span class=c1># Unstratified t-test</span>
<span class=n>t_stat</span><span class=p>,</span> <span class=n>p_value_unstrat</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span><span class=n>treatment</span><span class=p>,</span> <span class=n>control</span><span class=p>)</span>
<span class=n>se_unstrat</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>control</span><span class=o>.</span><span class=n>var</span><span class=p>()</span><span class=o>/</span><span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>)</span> <span class=o>+</span> <span class=n>treatment</span><span class=o>.</span><span class=n>var</span><span class=p>()</span><span class=o>/</span><span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>))</span>
<span class=n>ci_width_unstrat</span> <span class=o>=</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>se_unstrat</span>

<span class=c1># Stratified analysis</span>
<span class=n>se_strat</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>var_reduction</span><span class=p>[</span><span class=s1>&#39;var_stratified&#39;</span><span class=p>])</span>
<span class=n>ci_width_strat</span> <span class=o>=</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>se_strat</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìä Confidence Interval Comparison:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Unstratified 95% CI width: ¬±</span><span class=si>{</span><span class=n>ci_width_unstrat</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> minutes&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Stratified 95% CI width: ¬±</span><span class=si>{</span><span class=n>ci_width_strat</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> minutes&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Improvement: </span><span class=si>{</span><span class=p>(</span><span class=n>ci_width_unstrat</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>ci_width_strat</span><span class=p>)</span><span class=o>/</span><span class=n>ci_width_unstrat</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>% narrower&quot;</span><span class=p>)</span>
</code></pre></div> <p><strong>Stratification Methods:</strong></p> <table> <thead> <tr> <th>Method</th> <th>Description</th> <th>When to Use</th> <th>Variance Reduction</th> </tr> </thead> <tbody> <tr> <td><strong>Simple Stratification</strong></td> <td>Equal allocation within strata</td> <td>Strata roughly equal size</td> <td>20-30%</td> </tr> <tr> <td><strong>Proportional Stratification</strong></td> <td>Stratum size proportional to population</td> <td>Strata vary in size</td> <td>25-40%</td> </tr> <tr> <td><strong>Optimal Stratification</strong></td> <td>Allocate more to high-variance strata</td> <td>Unequal variances across strata</td> <td>30-50%</td> </tr> <tr> <td><strong>Post-Stratification</strong></td> <td>Adjust estimates after randomization</td> <td>Stratification variable measured post-random</td> <td>15-25%</td> </tr> </tbody> </table> <p><strong>Real Company Examples:</strong></p> <table> <thead> <tr> <th>Company</th> <th>Strata Variables</th> <th>Metric</th> <th>Variance Reduction</th> <th>Outcome</th> </tr> </thead> <tbody> <tr> <td><strong>Netflix</strong></td> <td>Country, Device, Tenure</td> <td>Watch time</td> <td>35% reduction</td> <td>Detect 2.5% effect ‚Üí 1.8% effect (save 40% sample)</td> </tr> <tr> <td><strong>Uber</strong></td> <td>City, Time of day, Driver tenure</td> <td>Trips/hour</td> <td>40% reduction</td> <td>Faster experiments (10 days ‚Üí 7 days)</td> </tr> <tr> <td><strong>Airbnb</strong></td> <td>Property type, Location, Host experience</td> <td>Booking rate</td> <td>30% reduction</td> <td>Improved power 80% ‚Üí 90% with same sample</td> </tr> <tr> <td><strong>Amazon</strong></td> <td>Product category, Customer segment</td> <td>Add-to-cart rate</td> <td>25% reduction</td> <td>Run 33% more experiments with same traffic</td> </tr> </tbody> </table> <p><strong>Choosing Stratification Variables:</strong></p> <table> <thead> <tr> <th>Criterion</th> <th>Good Variable</th> <th>Bad Variable</th> </tr> </thead> <tbody> <tr> <td><strong>Correlation with outcome</strong></td> <td>‚úÖ Tenure (r=0.5 with LTV)</td> <td>‚ùå Zodiac sign (r=0.01)</td> </tr> <tr> <td><strong>Observability</strong></td> <td>‚úÖ Country (known pre-randomization)</td> <td>‚ùå Future purchases (unknown)</td> </tr> <tr> <td><strong>Cardinality</strong></td> <td>‚úÖ Device type (4 categories)</td> <td>‚ùå User ID (10M categories, too sparse)</td> </tr> <tr> <td><strong>Actionability</strong></td> <td>‚úÖ User segment (can target)</td> <td>‚ùå Weather (can't control)</td> </tr> </tbody> </table> <p><strong>Stratification vs Other Methods:</strong></p> <table> <thead> <tr> <th>Method</th> <th>Variance Reduction</th> <th>Complexity</th> <th>When to Use</th> </tr> </thead> <tbody> <tr> <td><strong>Stratified Randomization</strong></td> <td>20-50%</td> <td>Low</td> <td>Pre-experiment planning, categorical covariates</td> </tr> <tr> <td><strong>CUPED (Regression Adjustment)</strong></td> <td>30-70%</td> <td>Medium</td> <td>Post-experiment, continuous pre-period metric available</td> </tr> <tr> <td><strong>Blocking</strong></td> <td>20-40%</td> <td>Low</td> <td>Similar to stratification, smaller blocks</td> </tr> <tr> <td><strong>Matching</strong></td> <td>30-50%</td> <td>High</td> <td>Observational studies, need exact covariate match</td> </tr> <tr> <td><strong>Difference-in-Differences</strong></td> <td>40-60%</td> <td>Medium</td> <td>Time series data, parallel trends assumption</td> </tr> </tbody> </table> <p><strong>Common Mistakes:</strong></p> <table> <thead> <tr> <th>‚ùå Mistake</th> <th>Why It's Bad</th> <th>‚úÖ Fix</th> </tr> </thead> <tbody> <tr> <td><strong>Too many strata</strong></td> <td>Sparse strata (&lt;10 users) ‚Üí unstable estimates</td> <td>Limit to 2-3 variables, &lt;50 total strata</td> </tr> <tr> <td><strong>Stratify on outcome</strong></td> <td>Data leakage, biased estimates</td> <td>Only use pre-randomization covariates</td> </tr> <tr> <td><strong>Ignore stratification in analysis</strong></td> <td>Lose variance reduction benefit</td> <td>Use stratified analysis (weighted by stratum)</td> </tr> <tr> <td><strong>Unbalanced strata</strong></td> <td>Some strata all control or all treatment</td> <td>Ensure each stratum has ‚â•10 users per variant</td> </tr> </tbody> </table> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p><strong>What they're testing:</strong> Understanding of experimental design, variance reduction techniques, covariate balance.</p> <p><strong>Strong answer signals:</strong></p> <ul> <li>Explains variance reduction quantitatively (e.g., "30% reduction")</li> <li>Knows how to check covariate balance (Standardized Mean Difference)</li> <li>Mentions choosing variables with high correlation to outcome</li> <li>Gives examples: "Netflix stratifies by country/device for 35% variance reduction"</li> <li>Explains trade-off: more strata ‚Üí less flexibility, risk of sparse cells</li> <li>Knows to analyze WITH stratification (don't throw it away)</li> <li>Compares to alternatives (CUPED, blocking, matching)</li> </ul> <p><strong>Red flags:</strong></p> <ul> <li>Confuses stratification with segmentation</li> <li>Can't explain why it reduces variance</li> <li>Suggests stratifying on the outcome variable</li> <li>Ignores stratum sparsity issues</li> <li>Doesn't know how to check if it worked</li> </ul> <p><strong>Follow-up questions:</strong></p> <ul> <li>"How do you choose which variables to stratify on?" (High correlation with outcome, low cardinality, observable pre-randomization)</li> <li>"What if you have 100 potential stratification variables?" (Use regularized regression to select top 2-3, or use CUPED instead)</li> <li>"Does stratification bias the treatment effect estimate?" (No, it only reduces variance, estimate is still unbiased)</li> </ul> </div> </details> <hr> <h3 id=how-to-use-regression-adjustment-google-meta-interview-question>How to Use Regression Adjustment? - Google, Meta Interview Question</h3> <p><strong>Difficulty:</strong> üî¥ Hard | <strong>Tags:</strong> <code>Analysis</code> | <strong>Asked by:</strong> Google, Meta, Netflix</p> <details class=success> <summary>View Answer</summary> <p><strong>Regression Adjustment</strong> (also called <strong>CUPED</strong> - Controlled-experiment Using Pre-Experiment Data) uses <strong>pre-experiment covariates</strong> to reduce variance in treatment effect estimates by <strong>40-70%</strong>, enabling faster experiments and smaller sample sizes. It's the <strong>most powerful variance reduction technique</strong> used by Google, Meta, Netflix, and Uber.</p> <p><strong>Core Idea:</strong></p> <p>Instead of comparing raw outcomes (<span class=arithmatex>\(Y\)</span>), compare <strong>residuals</strong> after removing the predictable component from pre-experiment data:</p> <div class=arithmatex>\[Y_{adjusted} = Y - \theta \cdot (X_{pre} - \mathbb{E}[X_{pre}])\]</div> <p>Where: - <span class=arithmatex>\(Y\)</span> = outcome metric (e.g., revenue post-experiment) - <span class=arithmatex>\(X_{pre}\)</span> = pre-experiment covariate (e.g., revenue pre-experiment) - <span class=arithmatex>\(\theta\)</span> = regression coefficient (usually <span class=arithmatex>\(\text{Cov}(Y, X_{pre}) / \text{Var}(X_{pre})\)</span>)</p> <p><strong>Why It Works:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  CUPED Variance Reduction Mechanism                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                       ‚îÇ
‚îÇ  Raw Metric Variance = Signal + Noise                                ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îÇ
‚îÇ  ‚îÇ                                                  ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ    Treatment Effect        User Heterogeneity   ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ    (what we want)         (noise we remove)     ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ         ‚ñ≤                         ‚ñ≤             ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ         ‚îÇ                         ‚îÇ             ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ      Small                      Large           ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ                                                  ‚îÇ                ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îÇ
‚îÇ                          ‚Üì                                           ‚îÇ
‚îÇ                   CUPED Adjustment                                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îÇ
‚îÇ  ‚îÇ                                                  ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ  Remove user heterogeneity using pre-period:    ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ  Y_adj = Y - Œ∏(X_pre - E[X_pre])               ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ                                                  ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ  Result: Variance ‚Üì by 40-70%                   ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ          ‚Üí Narrower CIs                          ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ          ‚Üí Higher power                          ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ          ‚Üí Faster experiments                    ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ                                                  ‚îÇ                ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îÇ
‚îÇ                                                                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Production CUPED Implementation:</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>import</span><span class=w> </span><span class=nn>statsmodels.api</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>sm</span>
<span class=kn>import</span><span class=w> </span><span class=nn>matplotlib.pyplot</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>plt</span>

<span class=c1># Production: Comprehensive Regression Adjustment (CUPED) System</span>

<span class=k>class</span><span class=w> </span><span class=nc>CUPEDAnalyzer</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    CUPED (Controlled-experiment Using Pre-Experiment Data) for variance reduction.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>theta</span> <span class=o>=</span> <span class=kc>None</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>variance_reduction</span> <span class=o>=</span> <span class=kc>None</span>

    <span class=k>def</span><span class=w> </span><span class=nf>compute_theta</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>outcome</span><span class=p>,</span> <span class=n>covariate</span><span class=p>,</span> <span class=n>method</span><span class=o>=</span><span class=s1>&#39;optimal&#39;</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Compute CUPED adjustment coefficient Œ∏.</span>

<span class=sd>        Methods:</span>
<span class=sd>        - &#39;optimal&#39;: Œ∏ = Cov(Y, X) / Var(X)  [minimizes variance]</span>
<span class=sd>        - &#39;regression&#39;: Œ∏ from Y ~ X regression [equivalent to optimal]</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;optimal&#39;</span><span class=p>:</span>
            <span class=n>cov</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>cov</span><span class=p>(</span><span class=n>outcome</span><span class=p>,</span> <span class=n>covariate</span><span class=p>)[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
            <span class=n>var_cov</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>var</span><span class=p>(</span><span class=n>covariate</span><span class=p>,</span> <span class=n>ddof</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
            <span class=n>theta</span> <span class=o>=</span> <span class=n>cov</span> <span class=o>/</span> <span class=n>var_cov</span>
        <span class=k>elif</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;regression&#39;</span><span class=p>:</span>
            <span class=c1># Simple linear regression</span>
            <span class=n>X</span> <span class=o>=</span> <span class=n>sm</span><span class=o>.</span><span class=n>add_constant</span><span class=p>(</span><span class=n>covariate</span><span class=p>)</span>
            <span class=n>model</span> <span class=o>=</span> <span class=n>sm</span><span class=o>.</span><span class=n>OLS</span><span class=p>(</span><span class=n>outcome</span><span class=p>,</span> <span class=n>X</span><span class=p>)</span><span class=o>.</span><span class=n>fit</span><span class=p>()</span>
            <span class=n>theta</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>  <span class=c1># Coefficient on covariate</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>theta</span> <span class=o>=</span> <span class=n>theta</span>
        <span class=k>return</span> <span class=n>theta</span>

    <span class=k>def</span><span class=w> </span><span class=nf>adjust_metric</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>outcome</span><span class=p>,</span> <span class=n>covariate</span><span class=p>,</span> <span class=n>theta</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Apply CUPED adjustment to outcome metric.</span>

<span class=sd>        Y_adjusted = Y - Œ∏(X - mean(X))</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=n>theta</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=n>theta</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>theta</span>

        <span class=k>if</span> <span class=n>theta</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;Must compute theta first or provide it&quot;</span><span class=p>)</span>

        <span class=n>covariate_centered</span> <span class=o>=</span> <span class=n>covariate</span> <span class=o>-</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>covariate</span><span class=p>)</span>
        <span class=n>adjusted_outcome</span> <span class=o>=</span> <span class=n>outcome</span> <span class=o>-</span> <span class=n>theta</span> <span class=o>*</span> <span class=n>covariate_centered</span>

        <span class=k>return</span> <span class=n>adjusted_outcome</span>

    <span class=k>def</span><span class=w> </span><span class=nf>analyze_with_cuped</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>control_outcome</span><span class=p>,</span> <span class=n>treatment_outcome</span><span class=p>,</span>
                          <span class=n>control_covariate</span><span class=p>,</span> <span class=n>treatment_covariate</span><span class=p>,</span>
                          <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Complete CUPED analysis comparing control vs treatment.</span>

<span class=sd>        Returns: dict with unadjusted and adjusted results</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=c1># ===== Unadjusted Analysis =====</span>
        <span class=n>mean_control</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>control_outcome</span><span class=p>)</span>
        <span class=n>mean_treatment</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>treatment_outcome</span><span class=p>)</span>

        <span class=n>se_control</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>sem</span><span class=p>(</span><span class=n>control_outcome</span><span class=p>)</span>
        <span class=n>se_treatment</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>sem</span><span class=p>(</span><span class=n>treatment_outcome</span><span class=p>)</span>
        <span class=n>se_diff_unadj</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>se_control</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>se_treatment</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span>

        <span class=n>diff_unadj</span> <span class=o>=</span> <span class=n>mean_treatment</span> <span class=o>-</span> <span class=n>mean_control</span>
        <span class=n>t_stat_unadj</span> <span class=o>=</span> <span class=n>diff_unadj</span> <span class=o>/</span> <span class=n>se_diff_unadj</span>
        <span class=n>p_value_unadj</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>stats</span><span class=o>.</span><span class=n>t</span><span class=o>.</span><span class=n>cdf</span><span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>t_stat_unadj</span><span class=p>),</span> 
                                              <span class=nb>len</span><span class=p>(</span><span class=n>control_outcome</span><span class=p>)</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=n>treatment_outcome</span><span class=p>)</span> <span class=o>-</span> <span class=mi>2</span><span class=p>))</span>

        <span class=n>ci_lower_unadj</span> <span class=o>=</span> <span class=n>diff_unadj</span> <span class=o>-</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=n>se_diff_unadj</span>
        <span class=n>ci_upper_unadj</span> <span class=o>=</span> <span class=n>diff_unadj</span> <span class=o>+</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=n>se_diff_unadj</span>

        <span class=c1># ===== CUPED Adjustment =====</span>
        <span class=c1># Compute Œ∏ on pooled data</span>
        <span class=n>all_outcomes</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>([</span><span class=n>control_outcome</span><span class=p>,</span> <span class=n>treatment_outcome</span><span class=p>])</span>
        <span class=n>all_covariates</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>([</span><span class=n>control_covariate</span><span class=p>,</span> <span class=n>treatment_covariate</span><span class=p>])</span>

        <span class=n>theta</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>compute_theta</span><span class=p>(</span><span class=n>all_outcomes</span><span class=p>,</span> <span class=n>all_covariates</span><span class=p>)</span>

        <span class=c1># Adjust outcomes</span>
        <span class=n>control_adj</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>adjust_metric</span><span class=p>(</span><span class=n>control_outcome</span><span class=p>,</span> <span class=n>control_covariate</span><span class=p>,</span> <span class=n>theta</span><span class=p>)</span>
        <span class=n>treatment_adj</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>adjust_metric</span><span class=p>(</span><span class=n>treatment_outcome</span><span class=p>,</span> <span class=n>treatment_covariate</span><span class=p>,</span> <span class=n>theta</span><span class=p>)</span>

        <span class=c1># Analysis on adjusted metrics</span>
        <span class=n>mean_control_adj</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>control_adj</span><span class=p>)</span>
        <span class=n>mean_treatment_adj</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>treatment_adj</span><span class=p>)</span>

        <span class=n>se_control_adj</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>sem</span><span class=p>(</span><span class=n>control_adj</span><span class=p>)</span>
        <span class=n>se_treatment_adj</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>sem</span><span class=p>(</span><span class=n>treatment_adj</span><span class=p>)</span>
        <span class=n>se_diff_adj</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>se_control_adj</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>se_treatment_adj</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span>

        <span class=n>diff_adj</span> <span class=o>=</span> <span class=n>mean_treatment_adj</span> <span class=o>-</span> <span class=n>mean_control_adj</span>
        <span class=n>t_stat_adj</span> <span class=o>=</span> <span class=n>diff_adj</span> <span class=o>/</span> <span class=n>se_diff_adj</span>
        <span class=n>p_value_adj</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>stats</span><span class=o>.</span><span class=n>t</span><span class=o>.</span><span class=n>cdf</span><span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>t_stat_adj</span><span class=p>),</span> 
                                           <span class=nb>len</span><span class=p>(</span><span class=n>control_adj</span><span class=p>)</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=n>treatment_adj</span><span class=p>)</span> <span class=o>-</span> <span class=mi>2</span><span class=p>))</span>

        <span class=n>ci_lower_adj</span> <span class=o>=</span> <span class=n>diff_adj</span> <span class=o>-</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=n>se_diff_adj</span>
        <span class=n>ci_upper_adj</span> <span class=o>=</span> <span class=n>diff_adj</span> <span class=o>+</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=n>se_diff_adj</span>

        <span class=c1># Variance reduction</span>
        <span class=n>var_reduction</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>se_diff_adj</span><span class=o>**</span><span class=mi>2</span> <span class=o>/</span> <span class=n>se_diff_unadj</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span> <span class=o>*</span> <span class=mi>100</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>variance_reduction</span> <span class=o>=</span> <span class=n>var_reduction</span>

        <span class=k>return</span> <span class=p>{</span>
            <span class=s1>&#39;unadjusted&#39;</span><span class=p>:</span> <span class=p>{</span>
                <span class=s1>&#39;treatment_effect&#39;</span><span class=p>:</span> <span class=n>diff_unadj</span><span class=p>,</span>
                <span class=s1>&#39;se&#39;</span><span class=p>:</span> <span class=n>se_diff_unadj</span><span class=p>,</span>
                <span class=s1>&#39;p_value&#39;</span><span class=p>:</span> <span class=n>p_value_unadj</span><span class=p>,</span>
                <span class=s1>&#39;ci_lower&#39;</span><span class=p>:</span> <span class=n>ci_lower_unadj</span><span class=p>,</span>
                <span class=s1>&#39;ci_upper&#39;</span><span class=p>:</span> <span class=n>ci_upper_unadj</span><span class=p>,</span>
                <span class=s1>&#39;significant&#39;</span><span class=p>:</span> <span class=n>p_value_unadj</span> <span class=o>&lt;</span> <span class=n>alpha</span>
            <span class=p>},</span>
            <span class=s1>&#39;adjusted&#39;</span><span class=p>:</span> <span class=p>{</span>
                <span class=s1>&#39;treatment_effect&#39;</span><span class=p>:</span> <span class=n>diff_adj</span><span class=p>,</span>
                <span class=s1>&#39;se&#39;</span><span class=p>:</span> <span class=n>se_diff_adj</span><span class=p>,</span>
                <span class=s1>&#39;p_value&#39;</span><span class=p>:</span> <span class=n>p_value_adj</span><span class=p>,</span>
                <span class=s1>&#39;ci_lower&#39;</span><span class=p>:</span> <span class=n>ci_lower_adj</span><span class=p>,</span>
                <span class=s1>&#39;ci_upper&#39;</span><span class=p>:</span> <span class=n>ci_upper_adj</span><span class=p>,</span>
                <span class=s1>&#39;significant&#39;</span><span class=p>:</span> <span class=n>p_value_adj</span> <span class=o>&lt;</span> <span class=n>alpha</span>
            <span class=p>},</span>
            <span class=s1>&#39;theta&#39;</span><span class=p>:</span> <span class=n>theta</span><span class=p>,</span>
            <span class=s1>&#39;variance_reduction_pct&#39;</span><span class=p>:</span> <span class=n>var_reduction</span><span class=p>,</span>
            <span class=s1>&#39;ci_width_reduction_pct&#39;</span><span class=p>:</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=p>(</span><span class=n>ci_upper_adj</span> <span class=o>-</span> <span class=n>ci_lower_adj</span><span class=p>)</span> <span class=o>/</span> 
                                       <span class=p>(</span><span class=n>ci_upper_unadj</span> <span class=o>-</span> <span class=n>ci_lower_unadj</span><span class=p>))</span> <span class=o>*</span> <span class=mi>100</span>
        <span class=p>}</span>

    <span class=k>def</span><span class=w> </span><span class=nf>select_covariates</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span> <span class=n>outcome_col</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> 
                         <span class=n>candidate_cols</span><span class=p>:</span> <span class=nb>list</span><span class=p>,</span> <span class=n>threshold</span><span class=o>=</span><span class=mf>0.3</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Select best covariates for CUPED based on correlation with outcome.</span>

<span class=sd>        threshold: Minimum absolute correlation to include</span>

<span class=sd>        Returns: List of selected columns, sorted by correlation strength</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>correlations</span> <span class=o>=</span> <span class=p>[]</span>

        <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>candidate_cols</span><span class=p>:</span>
            <span class=n>corr</span> <span class=o>=</span> <span class=n>df</span><span class=p>[[</span><span class=n>outcome_col</span><span class=p>,</span> <span class=n>col</span><span class=p>]]</span><span class=o>.</span><span class=n>corr</span><span class=p>()</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
            <span class=k>if</span> <span class=nb>abs</span><span class=p>(</span><span class=n>corr</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=n>threshold</span><span class=p>:</span>
                <span class=n>correlations</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
                    <span class=s1>&#39;covariate&#39;</span><span class=p>:</span> <span class=n>col</span><span class=p>,</span>
                    <span class=s1>&#39;correlation&#39;</span><span class=p>:</span> <span class=n>corr</span><span class=p>,</span>
                    <span class=s1>&#39;abs_correlation&#39;</span><span class=p>:</span> <span class=nb>abs</span><span class=p>(</span><span class=n>corr</span><span class=p>)</span>
                <span class=p>})</span>

        <span class=n>corr_df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>correlations</span><span class=p>)</span><span class=o>.</span><span class=n>sort_values</span><span class=p>(</span><span class=s1>&#39;abs_correlation&#39;</span><span class=p>,</span> 
                                                         <span class=n>ascending</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>

        <span class=k>return</span> <span class=n>corr_df</span>

    <span class=k>def</span><span class=w> </span><span class=nf>plot_variance_reduction</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>control_outcome</span><span class=p>,</span> <span class=n>treatment_outcome</span><span class=p>,</span>
                               <span class=n>control_covariate</span><span class=p>,</span> <span class=n>treatment_covariate</span><span class=p>,</span>
                               <span class=n>save_path</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Visualize CUPED variance reduction effect.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=c1># Run analysis</span>
        <span class=n>results</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>analyze_with_cuped</span><span class=p>(</span><span class=n>control_outcome</span><span class=p>,</span> <span class=n>treatment_outcome</span><span class=p>,</span>
                                         <span class=n>control_covariate</span><span class=p>,</span> <span class=n>treatment_covariate</span><span class=p>)</span>

        <span class=n>fig</span><span class=p>,</span> <span class=n>axes</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>16</span><span class=p>,</span> <span class=mi>5</span><span class=p>))</span>

        <span class=c1># Plot 1: Treatment effect with CIs</span>
        <span class=n>ax1</span> <span class=o>=</span> <span class=n>axes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
        <span class=n>methods</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Unadjusted&#39;</span><span class=p>,</span> <span class=s1>&#39;CUPED Adjusted&#39;</span><span class=p>]</span>
        <span class=n>effects</span> <span class=o>=</span> <span class=p>[</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;unadjusted&#39;</span><span class=p>][</span><span class=s1>&#39;treatment_effect&#39;</span><span class=p>],</span> 
                  <span class=n>results</span><span class=p>[</span><span class=s1>&#39;adjusted&#39;</span><span class=p>][</span><span class=s1>&#39;treatment_effect&#39;</span><span class=p>]]</span>
        <span class=n>ci_lowers</span> <span class=o>=</span> <span class=p>[</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;unadjusted&#39;</span><span class=p>][</span><span class=s1>&#39;ci_lower&#39;</span><span class=p>],</span> 
                    <span class=n>results</span><span class=p>[</span><span class=s1>&#39;adjusted&#39;</span><span class=p>][</span><span class=s1>&#39;ci_lower&#39;</span><span class=p>]]</span>
        <span class=n>ci_uppers</span> <span class=o>=</span> <span class=p>[</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;unadjusted&#39;</span><span class=p>][</span><span class=s1>&#39;ci_upper&#39;</span><span class=p>],</span> 
                    <span class=n>results</span><span class=p>[</span><span class=s1>&#39;adjusted&#39;</span><span class=p>][</span><span class=s1>&#39;ci_upper&#39;</span><span class=p>]]</span>

        <span class=n>x_pos</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
        <span class=n>ax1</span><span class=o>.</span><span class=n>errorbar</span><span class=p>(</span><span class=n>x_pos</span><span class=p>,</span> <span class=n>effects</span><span class=p>,</span> 
                    <span class=n>yerr</span><span class=o>=</span><span class=p>[[</span><span class=n>effects</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>ci_lowers</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>2</span><span class=p>)],</span>
                          <span class=p>[</span><span class=n>ci_uppers</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>effects</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>2</span><span class=p>)]],</span>
                    <span class=n>fmt</span><span class=o>=</span><span class=s1>&#39;o&#39;</span><span class=p>,</span> <span class=n>markersize</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=n>capsize</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=n>capthick</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span>
                    <span class=n>color</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;#e74c3c&#39;</span><span class=p>,</span> <span class=s1>&#39;#27ae60&#39;</span><span class=p>],</span> <span class=n>linewidth</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
        <span class=n>ax1</span><span class=o>.</span><span class=n>axhline</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;black&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;--&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
        <span class=n>ax1</span><span class=o>.</span><span class=n>set_xticks</span><span class=p>(</span><span class=n>x_pos</span><span class=p>)</span>
        <span class=n>ax1</span><span class=o>.</span><span class=n>set_xticklabels</span><span class=p>(</span><span class=n>methods</span><span class=p>)</span>
        <span class=n>ax1</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;Treatment Effect&#39;</span><span class=p>)</span>
        <span class=n>ax1</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;Treatment Effect Estimates with 95% CI&#39;</span><span class=p>,</span> <span class=n>fontweight</span><span class=o>=</span><span class=s1>&#39;bold&#39;</span><span class=p>)</span>
        <span class=n>ax1</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=s1>&#39;y&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>

        <span class=c1># Plot 2: Variance reduction bar</span>
        <span class=n>ax2</span> <span class=o>=</span> <span class=n>axes</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
        <span class=n>ax2</span><span class=o>.</span><span class=n>bar</span><span class=p>([</span><span class=s1>&#39;Variance</span><span class=se>\n</span><span class=s1>Reduction&#39;</span><span class=p>],</span> <span class=p>[</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;variance_reduction_pct&#39;</span><span class=p>]],</span> 
               <span class=n>color</span><span class=o>=</span><span class=s1>&#39;#3498db&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span>
        <span class=n>ax2</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;Variance Reduction (%)&#39;</span><span class=p>)</span>
        <span class=n>ax2</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;CUPED Variance Reduction: </span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s2>&quot;variance_reduction_pct&quot;</span><span class=p>]</span><span class=si>:</span><span class=s1>.1f</span><span class=si>}</span><span class=s1>%&#39;</span><span class=p>,</span> 
                     <span class=n>fontweight</span><span class=o>=</span><span class=s1>&#39;bold&#39;</span><span class=p>)</span>
        <span class=n>ax2</span><span class=o>.</span><span class=n>set_ylim</span><span class=p>([</span><span class=mi>0</span><span class=p>,</span> <span class=mi>100</span><span class=p>])</span>
        <span class=n>ax2</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=s1>&#39;y&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>

        <span class=c1># Plot 3: Scatter of outcome vs covariate</span>
        <span class=n>ax3</span> <span class=o>=</span> <span class=n>axes</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
        <span class=n>all_outcome</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>([</span><span class=n>control_outcome</span><span class=p>,</span> <span class=n>treatment_outcome</span><span class=p>])</span>
        <span class=n>all_covariate</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>([</span><span class=n>control_covariate</span><span class=p>,</span> <span class=n>treatment_covariate</span><span class=p>])</span>
        <span class=n>ax3</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>all_covariate</span><span class=p>,</span> <span class=n>all_outcome</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>

        <span class=c1># Regression line</span>
        <span class=n>z</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>polyfit</span><span class=p>(</span><span class=n>all_covariate</span><span class=p>,</span> <span class=n>all_outcome</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
        <span class=n>p</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>poly1d</span><span class=p>(</span><span class=n>z</span><span class=p>)</span>
        <span class=n>ax3</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=nb>sorted</span><span class=p>(</span><span class=n>all_covariate</span><span class=p>),</span> <span class=n>p</span><span class=p>(</span><span class=nb>sorted</span><span class=p>(</span><span class=n>all_covariate</span><span class=p>)),</span> 
                <span class=s2>&quot;r-&quot;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=sa>f</span><span class=s1>&#39;Œ∏=</span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s2>&quot;theta&quot;</span><span class=p>]</span><span class=si>:</span><span class=s1>.3f</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>

        <span class=n>ax3</span><span class=o>.</span><span class=n>set_xlabel</span><span class=p>(</span><span class=s1>&#39;Pre-experiment Covariate&#39;</span><span class=p>)</span>
        <span class=n>ax3</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;Outcome Metric&#39;</span><span class=p>)</span>
        <span class=n>ax3</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;Outcome vs Pre-experiment Covariate&#39;</span><span class=p>,</span> <span class=n>fontweight</span><span class=o>=</span><span class=s1>&#39;bold&#39;</span><span class=p>)</span>
        <span class=n>ax3</span><span class=o>.</span><span class=n>legend</span><span class=p>()</span>
        <span class=n>ax3</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>

        <span class=n>plt</span><span class=o>.</span><span class=n>tight_layout</span><span class=p>()</span>

        <span class=k>if</span> <span class=n>save_path</span><span class=p>:</span>
            <span class=n>plt</span><span class=o>.</span><span class=n>savefig</span><span class=p>(</span><span class=n>save_path</span><span class=p>,</span> <span class=n>dpi</span><span class=o>=</span><span class=mi>300</span><span class=p>,</span> <span class=n>bbox_inches</span><span class=o>=</span><span class=s1>&#39;tight&#39;</span><span class=p>)</span>

        <span class=k>return</span> <span class=n>fig</span>


<span class=c1># ===== Example 1: Uber Trips/Hour Experiment =====</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;EXAMPLE 1: UBER - CUPED ON PREVIOUS TRIPS/HOUR&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>

<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>

<span class=c1># Generate data: trips/hour has high autocorrelation</span>
<span class=n>n_users</span> <span class=o>=</span> <span class=mi>5000</span>

<span class=c1># Pre-experiment trips/hour (baseline user behavior)</span>
<span class=n>pre_trips</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>gamma</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span> <span class=n>scale</span><span class=o>=</span><span class=mf>1.5</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n_users</span><span class=p>)</span>

<span class=c1># Post-experiment trips/hour (correlated with pre-period)</span>
<span class=c1># Control group: stays similar to pre-period</span>
<span class=n>control_pre</span> <span class=o>=</span> <span class=n>pre_trips</span><span class=p>[:</span><span class=n>n_users</span><span class=o>//</span><span class=mi>2</span><span class=p>]</span>
<span class=n>control_post</span> <span class=o>=</span> <span class=n>control_pre</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>,</span> <span class=n>n_users</span><span class=o>//</span><span class=mi>2</span><span class=p>)</span>

<span class=c1># Treatment group: +10% lift</span>
<span class=n>treatment_pre</span> <span class=o>=</span> <span class=n>pre_trips</span><span class=p>[</span><span class=n>n_users</span><span class=o>//</span><span class=mi>2</span><span class=p>:]</span>
<span class=n>treatment_post</span> <span class=o>=</span> <span class=n>treatment_pre</span> <span class=o>*</span> <span class=mf>1.10</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>,</span> <span class=n>n_users</span><span class=o>//</span><span class=mi>2</span><span class=p>)</span>

<span class=c1># Analyze</span>
<span class=n>analyzer</span> <span class=o>=</span> <span class=n>CUPEDAnalyzer</span><span class=p>()</span>
<span class=n>results</span> <span class=o>=</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>analyze_with_cuped</span><span class=p>(</span>
    <span class=n>control_post</span><span class=p>,</span> <span class=n>treatment_post</span><span class=p>,</span>
    <span class=n>control_pre</span><span class=p>,</span> <span class=n>treatment_pre</span>
<span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìä CUPED Results:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Unadjusted:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Treatment Effect: </span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;unadjusted&#39;</span><span class=p>][</span><span class=s1>&#39;treatment_effect&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Standard Error: </span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;unadjusted&#39;</span><span class=p>][</span><span class=s1>&#39;se&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   95% CI: [</span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;unadjusted&#39;</span><span class=p>][</span><span class=s1>&#39;ci_lower&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;unadjusted&#39;</span><span class=p>][</span><span class=s1>&#39;ci_upper&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>]&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   p-value: </span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;unadjusted&#39;</span><span class=p>][</span><span class=s1>&#39;p_value&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Significant: </span><span class=si>{</span><span class=s1>&#39;Yes ‚úì&#39;</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;unadjusted&#39;</span><span class=p>][</span><span class=s1>&#39;significant&#39;</span><span class=p>]</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=s1>&#39;No ‚úó&#39;</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>CUPED Adjusted:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Treatment Effect: </span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;adjusted&#39;</span><span class=p>][</span><span class=s1>&#39;treatment_effect&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Standard Error: </span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;adjusted&#39;</span><span class=p>][</span><span class=s1>&#39;se&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   95% CI: [</span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;adjusted&#39;</span><span class=p>][</span><span class=s1>&#39;ci_lower&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;adjusted&#39;</span><span class=p>][</span><span class=s1>&#39;ci_upper&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>]&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   p-value: </span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;adjusted&#39;</span><span class=p>][</span><span class=s1>&#39;p_value&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Significant: </span><span class=si>{</span><span class=s1>&#39;Yes ‚úì&#39;</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;adjusted&#39;</span><span class=p>][</span><span class=s1>&#39;significant&#39;</span><span class=p>]</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=s1>&#39;No ‚úó&#39;</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Improvement:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Œ∏ (adjustment coefficient): </span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;theta&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Variance reduction: </span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;variance_reduction_pct&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   CI width reduction: </span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;ci_width_reduction_pct&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Equivalent sample size multiplier: </span><span class=si>{</span><span class=mi>1</span><span class=o>/</span><span class=p>(</span><span class=mi>1</span><span class=o>-</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;variance_reduction_pct&#39;</span><span class=p>]</span><span class=o>/</span><span class=mi>100</span><span class=p>)</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>√ó&quot;</span><span class=p>)</span>

<span class=c1># Visualize</span>
<span class=n>analyzer</span><span class=o>.</span><span class=n>plot_variance_reduction</span><span class=p>(</span><span class=n>control_post</span><span class=p>,</span> <span class=n>treatment_post</span><span class=p>,</span> 
                                <span class=n>control_pre</span><span class=p>,</span> <span class=n>treatment_pre</span><span class=p>)</span>
<span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>


<span class=c1># ===== Example 2: Netflix Watch Time with Multiple Covariates =====</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;EXAMPLE 2: NETFLIX - COVARIATE SELECTION FOR CUPED&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>

<span class=c1># Generate data with multiple potential covariates</span>
<span class=n>n_users</span> <span class=o>=</span> <span class=mi>8000</span>

<span class=c1># Covariates with varying correlations to outcome</span>
<span class=n>pre_watch_time</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>gamma</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>scale</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n_users</span><span class=p>)</span>  <span class=c1># Strong correlation</span>
<span class=n>account_age_days</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>gamma</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span> <span class=n>scale</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n_users</span><span class=p>)</span>  <span class=c1># Medium correlation</span>
<span class=n>num_profiles</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>poisson</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n_users</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span>  <span class=c1># Weak correlation</span>
<span class=n>random_noise</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>50</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n_users</span><span class=p>)</span>  <span class=c1># No correlation</span>

<span class=c1># Outcome: post-experiment watch time</span>
<span class=c1># Influenced by pre_watch_time (strong) and account_age (medium)</span>
<span class=n>post_watch_time</span> <span class=o>=</span> <span class=p>(</span><span class=mf>0.8</span> <span class=o>*</span> <span class=n>pre_watch_time</span> <span class=o>+</span> 
                  <span class=mf>0.05</span> <span class=o>*</span> <span class=n>account_age_days</span> <span class=o>+</span> 
                  <span class=mi>2</span> <span class=o>*</span> <span class=n>num_profiles</span> <span class=o>+</span>
                  <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n_users</span><span class=p>))</span>

<span class=c1># Create DataFrame</span>
<span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
    <span class=s1>&#39;post_watch_time&#39;</span><span class=p>:</span> <span class=n>post_watch_time</span><span class=p>,</span>
    <span class=s1>&#39;pre_watch_time&#39;</span><span class=p>:</span> <span class=n>pre_watch_time</span><span class=p>,</span>
    <span class=s1>&#39;account_age_days&#39;</span><span class=p>:</span> <span class=n>account_age_days</span><span class=p>,</span>
    <span class=s1>&#39;num_profiles&#39;</span><span class=p>:</span> <span class=n>num_profiles</span><span class=p>,</span>
    <span class=s1>&#39;random_noise&#39;</span><span class=p>:</span> <span class=n>random_noise</span>
<span class=p>})</span>

<span class=c1># Select best covariates</span>
<span class=n>analyzer2</span> <span class=o>=</span> <span class=n>CUPEDAnalyzer</span><span class=p>()</span>
<span class=n>covariate_rankings</span> <span class=o>=</span> <span class=n>analyzer2</span><span class=o>.</span><span class=n>select_covariates</span><span class=p>(</span>
    <span class=n>df</span><span class=p>,</span> <span class=s1>&#39;post_watch_time&#39;</span><span class=p>,</span>
    <span class=p>[</span><span class=s1>&#39;pre_watch_time&#39;</span><span class=p>,</span> <span class=s1>&#39;account_age_days&#39;</span><span class=p>,</span> <span class=s1>&#39;num_profiles&#39;</span><span class=p>,</span> <span class=s1>&#39;random_noise&#39;</span><span class=p>],</span>
    <span class=n>threshold</span><span class=o>=</span><span class=mf>0.1</span>
<span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìä Covariate Selection (correlation with outcome):&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>covariate_rankings</span><span class=o>.</span><span class=n>to_string</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>))</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>‚úÖ Recommendation: Use &#39;pre_watch_time&#39; (highest correlation)&quot;</span><span class=p>)</span>
</code></pre></div> <p><strong>CUPED vs Other Methods:</strong></p> <table> <thead> <tr> <th>Method</th> <th>Variance Reduction</th> <th>Data Required</th> <th>Complexity</th> <th>Best For</th> </tr> </thead> <tbody> <tr> <td><strong>CUPED</strong></td> <td>40-70%</td> <td>Pre-experiment metric</td> <td>Low</td> <td>Continuous metrics with history</td> </tr> <tr> <td><strong>Stratification</strong></td> <td>20-50%</td> <td>Pre-experiment categorical</td> <td>Low</td> <td>Categorical covariates</td> </tr> <tr> <td><strong>Difference-in-Differences</strong></td> <td>40-60%</td> <td>Time series</td> <td>Medium</td> <td>Parallel trends, policy changes</td> </tr> <tr> <td><strong>Matching</strong></td> <td>30-50%</td> <td>Pre-experiment covariates</td> <td>High</td> <td>Observational studies</td> </tr> <tr> <td><strong>Regression (multiple covariates)</strong></td> <td>50-80%</td> <td>Many covariates</td> <td>Medium</td> <td>Large feature set</td> </tr> </tbody> </table> <p><strong>Real Company Examples:</strong></p> <table> <thead> <tr> <th>Company</th> <th>Metric</th> <th>Covariate</th> <th>Variance Reduction</th> <th>Impact</th> </tr> </thead> <tbody> <tr> <td><strong>Google Ads</strong></td> <td>Click-through rate (CTR)</td> <td>Pre-experiment CTR</td> <td>50% reduction</td> <td>Run experiments in 10 days instead of 20</td> </tr> <tr> <td><strong>Netflix</strong></td> <td>Watch time</td> <td>Previous week watch time</td> <td>60% reduction</td> <td>Detect 2% effects (was 3.5% MDE)</td> </tr> <tr> <td><strong>Uber</strong></td> <td>Trips/driver</td> <td>Previous month trips</td> <td>45% reduction</td> <td>33% faster experiments</td> </tr> <tr> <td><strong>Meta</strong></td> <td>Session duration</td> <td>Previous 7-day avg</td> <td>55% reduction</td> <td>Increased experiment velocity 2√ó</td> </tr> </tbody> </table> <p><strong>Covariate Selection Criteria:</strong></p> <table> <thead> <tr> <th>Criterion</th> <th>Best Covariate</th> <th>Poor Covariate</th> </tr> </thead> <tbody> <tr> <td><strong>Correlation with outcome</strong></td> <td>‚úÖ r &gt; 0.5 (pre-experiment same metric)</td> <td>‚ùå r &lt; 0.1 (unrelated variable)</td> </tr> <tr> <td><strong>Availability</strong></td> <td>‚úÖ Measured before experiment</td> <td>‚ùå Measured after treatment</td> </tr> <tr> <td><strong>Not affected by treatment</strong></td> <td>‚úÖ Pre-experiment data</td> <td>‚ùå Post-treatment data</td> </tr> <tr> <td><strong>Low missingness</strong></td> <td>‚úÖ &lt;5% missing</td> <td>‚ùå &gt;20% missing</td> </tr> </tbody> </table> <p><strong>When CUPED Fails:</strong></p> <table> <thead> <tr> <th>Scenario</th> <th>Why CUPED Doesn't Help</th> <th>Alternative</th> </tr> </thead> <tbody> <tr> <td><strong>No historical data</strong></td> <td>New users, no pre-period</td> <td>Use demographics, stratification</td> </tr> <tr> <td><strong>Low correlation (r&lt;0.2)</strong></td> <td>Covariate doesn't predict outcome</td> <td>Find better covariate or accept higher variance</td> </tr> <tr> <td><strong>Treatment affects covariate</strong></td> <td>e.g., treatment changes user type</td> <td>Only use pre-treatment covariates</td> </tr> <tr> <td><strong>Metric mismatch</strong></td> <td>Use clicks to adjust revenue</td> <td>Use same metric family (revenue ‚Üí revenue)</td> </tr> </tbody> </table> <p><strong>Common Mistakes:</strong></p> <table> <thead> <tr> <th>‚ùå Mistake</th> <th>Why It's Bad</th> <th>‚úÖ Fix</th> </tr> </thead> <tbody> <tr> <td><strong>Use post-treatment covariate</strong></td> <td>Biased estimates</td> <td>Only use pre-experiment data</td> </tr> <tr> <td><strong>Forget to center covariate</strong></td> <td>Changes treatment effect estimate</td> <td>Always use <span class=arithmatex>\(X - \mathbb{E}[X]\)</span></td> </tr> <tr> <td><strong>Wrong Œ∏ calculation</strong></td> <td>Suboptimal variance reduction</td> <td>Use Œ∏ = Cov(Y,X) / Var(X)</td> </tr> <tr> <td><strong>Apply only to treatment group</strong></td> <td>Introduces bias</td> <td>Apply to both control and treatment</td> </tr> </tbody> </table> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p><strong>What they're testing:</strong> Advanced variance reduction, understanding of CUPED theory, covariate selection.</p> <p><strong>Strong answer signals:</strong></p> <ul> <li>Explains CUPED formula: <span class=arithmatex>\(Y_{adj} = Y - \theta(X_{pre} - \mathbb{E}[X_{pre}])\)</span></li> <li>Knows Œ∏ minimizes variance: <span class=arithmatex>\(\theta = \text{Cov}(Y,X) / \text{Var}(X)\)</span></li> <li>Quantifies benefit: "40-70% variance reduction at Google/Netflix"</li> <li>Explains covariate selection: "Use pre-experiment same metric, r&gt;0.5"</li> <li>Mentions centering covariate (don't bias treatment effect)</li> <li>Compares to alternatives (stratification 20-50%, CUPED 40-70%)</li> <li>Knows when it fails (no history, low correlation)</li> </ul> <p><strong>Red flags:</strong></p> <ul> <li>Confuses with stratification or matching</li> <li>Uses post-treatment covariates</li> <li>Can't explain why variance reduces</li> <li>Doesn't know optimal Œ∏ formula</li> <li>Never heard of CUPED (common at top tech companies)</li> </ul> <p><strong>Follow-up questions:</strong></p> <ul> <li>"How do you choose Œ∏?" (Optimal: Cov(Y,X)/Var(X), or run regression Y~X)</li> <li>"Can you use multiple covariates?" (Yes, use multiple regression: Y ~ T + X1 + X2 + ...)</li> <li>"Does CUPED bias the treatment effect?" (No, only reduces variance if done correctly)</li> </ul> </div> </details> <hr> <h3 id=what-is-triggered-analysis-uber-lyft-interview-question>What is Triggered Analysis? - Uber, Lyft Interview Question</h3> <p><strong>Difficulty:</strong> üî¥ Hard | <strong>Tags:</strong> <code>Analysis</code> | <strong>Asked by:</strong> Uber, Lyft, DoorDash</p> <details class=success> <summary>View Answer</summary> <p><strong>Triggered Analysis</strong> measures treatment effect <strong>only among users who were actually exposed</strong> to the treatment, as opposed to <strong>Intent-to-Treat (ITT)</strong> which includes all randomized users regardless of exposure. This distinction is critical when <strong>not all assigned users experience the treatment</strong> (e.g., feature requires user action, supply-side constraints).</p> <p><strong>ITT vs Triggered:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  ITT vs Triggered Analysis                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                     ‚îÇ
‚îÇ  Randomization: 10,000 users to Treatment                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ                    Treatment Group                           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                      (n=10,000)                              ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ         ‚îÇ                                ‚îÇ                          ‚îÇ
‚îÇ         ‚Üì                                ‚Üì                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê               ‚îÇ
‚îÇ  ‚îÇ  Triggered   ‚îÇ              ‚îÇ  Not Triggered   ‚îÇ               ‚îÇ
‚îÇ  ‚îÇ (Exposed to  ‚îÇ              ‚îÇ (Never saw the   ‚îÇ               ‚îÇ
‚îÇ  ‚îÇ  treatment)  ‚îÇ              ‚îÇ   treatment)     ‚îÇ               ‚îÇ
‚îÇ  ‚îÇ  n=7,000     ‚îÇ              ‚îÇ   n=3,000        ‚îÇ               ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò               ‚îÇ
‚îÇ         ‚îÇ                                ‚îÇ                          ‚îÇ
‚îÇ         ‚Üì                                ‚Üì                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ                                                               ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ITT Effect:     Analyze all 10,000                          ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Real-world impact (70% trigger rate)                      ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Unbiased (preserves randomization)                        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Lower statistical power                                    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                                               ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  Triggered Effect: Analyze only 7,000                        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Effect on exposed users                                    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Potentially biased (selection into triggering)            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Higher statistical power                                   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                                               ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>When Triggering Matters:</strong></p> <ul> <li><strong>Supply-side experiments:</strong> Uber driver feature requires accepting a trip</li> <li><strong>Opt-in features:</strong> Netflix "Skip Intro" button (not all shows have intros)</li> <li><strong>Conditional displays:</strong> E-commerce "Free Shipping" banner (only for orders &gt;$50)</li> <li><strong>Geographic experiments:</strong> Feature only available in certain cities</li> </ul> <p><strong>Production Implementation:</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>import</span><span class=w> </span><span class=nn>matplotlib.pyplot</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>plt</span>

<span class=c1># Production: Comprehensive Triggered Analysis with ITT Comparison</span>

<span class=k>class</span><span class=w> </span><span class=nc>TriggeredAnalyzer</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Analyze experiments with incomplete treatment exposure.</span>
<span class=sd>    Compares ITT (intent-to-treat) with triggered (per-protocol) effects.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>results</span> <span class=o>=</span> <span class=p>{}</span>

    <span class=k>def</span><span class=w> </span><span class=nf>analyze_itt</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>treatment_outcomes</span><span class=p>,</span> <span class=n>control_outcomes</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Intent-to-Treat analysis: All randomized users.</span>

<span class=sd>        Returns: dict with treatment effect, CI, p-value</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>mean_treatment</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>treatment_outcomes</span><span class=p>)</span>
        <span class=n>mean_control</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>control_outcomes</span><span class=p>)</span>

        <span class=n>se_treatment</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>sem</span><span class=p>(</span><span class=n>treatment_outcomes</span><span class=p>)</span>
        <span class=n>se_control</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>sem</span><span class=p>(</span><span class=n>control_outcomes</span><span class=p>)</span>
        <span class=n>se_diff</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>se_treatment</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>se_control</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span>

        <span class=n>effect</span> <span class=o>=</span> <span class=n>mean_treatment</span> <span class=o>-</span> <span class=n>mean_control</span>
        <span class=n>t_stat</span> <span class=o>=</span> <span class=n>effect</span> <span class=o>/</span> <span class=n>se_diff</span>
        <span class=n>df</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>treatment_outcomes</span><span class=p>)</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=n>control_outcomes</span><span class=p>)</span> <span class=o>-</span> <span class=mi>2</span>
        <span class=n>p_value</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>stats</span><span class=o>.</span><span class=n>t</span><span class=o>.</span><span class=n>cdf</span><span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>t_stat</span><span class=p>),</span> <span class=n>df</span><span class=p>))</span>

        <span class=n>ci_lower</span> <span class=o>=</span> <span class=n>effect</span> <span class=o>-</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=n>se_diff</span>
        <span class=n>ci_upper</span> <span class=o>=</span> <span class=n>effect</span> <span class=o>+</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=n>se_diff</span>

        <span class=k>return</span> <span class=p>{</span>
            <span class=s1>&#39;effect&#39;</span><span class=p>:</span> <span class=n>effect</span><span class=p>,</span>
            <span class=s1>&#39;se&#39;</span><span class=p>:</span> <span class=n>se_diff</span><span class=p>,</span>
            <span class=s1>&#39;p_value&#39;</span><span class=p>:</span> <span class=n>p_value</span><span class=p>,</span>
            <span class=s1>&#39;ci_lower&#39;</span><span class=p>:</span> <span class=n>ci_lower</span><span class=p>,</span>
            <span class=s1>&#39;ci_upper&#39;</span><span class=p>:</span> <span class=n>ci_upper</span><span class=p>,</span>
            <span class=s1>&#39;significant&#39;</span><span class=p>:</span> <span class=n>p_value</span> <span class=o>&lt;</span> <span class=n>alpha</span><span class=p>,</span>
            <span class=s1>&#39;n_treatment&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>treatment_outcomes</span><span class=p>),</span>
            <span class=s1>&#39;n_control&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>control_outcomes</span><span class=p>)</span>
        <span class=p>}</span>

    <span class=k>def</span><span class=w> </span><span class=nf>analyze_triggered</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>triggered_treatment</span><span class=p>,</span> <span class=n>control_outcomes</span><span class=p>,</span>
                         <span class=n>trigger_rate_treatment</span><span class=p>,</span> <span class=n>trigger_rate_control</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
                         <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Triggered (per-protocol) analysis: Only exposed users.</span>

<span class=sd>        triggered_treatment: Outcomes for treatment users who were triggered</span>
<span class=sd>        control_outcomes: All control users (or triggered control if available)</span>
<span class=sd>        trigger_rate_treatment: Proportion of treatment assigned who triggered</span>
<span class=sd>        trigger_rate_control: Proportion of control assigned who triggered (if applicable)</span>

<span class=sd>        Returns: dict with triggered effect, potential selection bias warning</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>mean_triggered</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>triggered_treatment</span><span class=p>)</span>
        <span class=n>mean_control</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>control_outcomes</span><span class=p>)</span>

        <span class=n>se_triggered</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>sem</span><span class=p>(</span><span class=n>triggered_treatment</span><span class=p>)</span>
        <span class=n>se_control</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>sem</span><span class=p>(</span><span class=n>control_outcomes</span><span class=p>)</span>
        <span class=n>se_diff</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>se_triggered</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>se_control</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span>

        <span class=n>effect</span> <span class=o>=</span> <span class=n>mean_triggered</span> <span class=o>-</span> <span class=n>mean_control</span>
        <span class=n>t_stat</span> <span class=o>=</span> <span class=n>effect</span> <span class=o>/</span> <span class=n>se_diff</span>
        <span class=n>df</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>triggered_treatment</span><span class=p>)</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=n>control_outcomes</span><span class=p>)</span> <span class=o>-</span> <span class=mi>2</span>
        <span class=n>p_value</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>stats</span><span class=o>.</span><span class=n>t</span><span class=o>.</span><span class=n>cdf</span><span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>t_stat</span><span class=p>),</span> <span class=n>df</span><span class=p>))</span>

        <span class=n>ci_lower</span> <span class=o>=</span> <span class=n>effect</span> <span class=o>-</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=n>se_diff</span>
        <span class=n>ci_upper</span> <span class=o>=</span> <span class=n>effect</span> <span class=o>+</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=n>se_diff</span>

        <span class=c1># Check for selection bias (different trigger rates)</span>
        <span class=n>selection_bias_warning</span> <span class=o>=</span> <span class=kc>False</span>
        <span class=k>if</span> <span class=n>trigger_rate_control</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
            <span class=n>trigger_diff</span> <span class=o>=</span> <span class=nb>abs</span><span class=p>(</span><span class=n>trigger_rate_treatment</span> <span class=o>-</span> <span class=n>trigger_rate_control</span><span class=p>)</span>
            <span class=k>if</span> <span class=n>trigger_diff</span> <span class=o>&gt;</span> <span class=mf>0.05</span><span class=p>:</span>  <span class=c1># &gt;5pp difference</span>
                <span class=n>selection_bias_warning</span> <span class=o>=</span> <span class=kc>True</span>

        <span class=k>return</span> <span class=p>{</span>
            <span class=s1>&#39;effect&#39;</span><span class=p>:</span> <span class=n>effect</span><span class=p>,</span>
            <span class=s1>&#39;se&#39;</span><span class=p>:</span> <span class=n>se_diff</span><span class=p>,</span>
            <span class=s1>&#39;p_value&#39;</span><span class=p>:</span> <span class=n>p_value</span><span class=p>,</span>
            <span class=s1>&#39;ci_lower&#39;</span><span class=p>:</span> <span class=n>ci_lower</span><span class=p>,</span>
            <span class=s1>&#39;ci_upper&#39;</span><span class=p>:</span> <span class=n>ci_upper</span><span class=p>,</span>
            <span class=s1>&#39;significant&#39;</span><span class=p>:</span> <span class=n>p_value</span> <span class=o>&lt;</span> <span class=n>alpha</span><span class=p>,</span>
            <span class=s1>&#39;n_triggered&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>triggered_treatment</span><span class=p>),</span>
            <span class=s1>&#39;n_control&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>control_outcomes</span><span class=p>),</span>
            <span class=s1>&#39;trigger_rate&#39;</span><span class=p>:</span> <span class=n>trigger_rate_treatment</span><span class=p>,</span>
            <span class=s1>&#39;selection_bias_warning&#39;</span><span class=p>:</span> <span class=n>selection_bias_warning</span>
        <span class=p>}</span>

    <span class=k>def</span><span class=w> </span><span class=nf>estimate_cace</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>itt_effect</span><span class=p>,</span> <span class=n>compliance_rate</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Estimate CACE (Complier Average Causal Effect).</span>

<span class=sd>        CACE = ITT Effect / Compliance Rate</span>

<span class=sd>        This estimates the effect among users who would comply (trigger)</span>
<span class=sd>        under the assumption of no defiers.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=n>compliance_rate</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=n>cace</span> <span class=o>=</span> <span class=n>itt_effect</span> <span class=o>/</span> <span class=n>compliance_rate</span>
        <span class=k>return</span> <span class=n>cace</span>

    <span class=k>def</span><span class=w> </span><span class=nf>compare_itt_triggered</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>treatment_all</span><span class=p>,</span> <span class=n>treatment_triggered</span><span class=p>,</span>
                             <span class=n>control_all</span><span class=p>,</span> <span class=n>trigger_rate_treatment</span><span class=p>,</span>
                             <span class=n>trigger_rate_control</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Full comparison of ITT vs Triggered analysis.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=c1># ITT analysis</span>
        <span class=n>itt_results</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>analyze_itt</span><span class=p>(</span><span class=n>treatment_all</span><span class=p>,</span> <span class=n>control_all</span><span class=p>)</span>

        <span class=c1># Triggered analysis</span>
        <span class=n>triggered_results</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>analyze_triggered</span><span class=p>(</span>
            <span class=n>treatment_triggered</span><span class=p>,</span> <span class=n>control_all</span><span class=p>,</span>
            <span class=n>trigger_rate_treatment</span><span class=p>,</span> <span class=n>trigger_rate_control</span>
        <span class=p>)</span>

        <span class=c1># CACE estimate</span>
        <span class=n>cace</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>estimate_cace</span><span class=p>(</span><span class=n>itt_results</span><span class=p>[</span><span class=s1>&#39;effect&#39;</span><span class=p>],</span> <span class=n>trigger_rate_treatment</span><span class=p>)</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>results</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s1>&#39;itt&#39;</span><span class=p>:</span> <span class=n>itt_results</span><span class=p>,</span>
            <span class=s1>&#39;triggered&#39;</span><span class=p>:</span> <span class=n>triggered_results</span><span class=p>,</span>
            <span class=s1>&#39;cace&#39;</span><span class=p>:</span> <span class=n>cace</span><span class=p>,</span>
            <span class=s1>&#39;dilution_factor&#39;</span><span class=p>:</span> <span class=n>trigger_rate_treatment</span>
        <span class=p>}</span>

        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>results</span>

    <span class=k>def</span><span class=w> </span><span class=nf>plot_comparison</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>save_path</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Visualize ITT vs Triggered effects.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>:</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;Must run compare_itt_triggered first&quot;</span><span class=p>)</span>

        <span class=n>fig</span><span class=p>,</span> <span class=p>(</span><span class=n>ax1</span><span class=p>,</span> <span class=n>ax2</span><span class=p>)</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>14</span><span class=p>,</span> <span class=mi>6</span><span class=p>))</span>

        <span class=c1># Plot 1: Effect estimates</span>
        <span class=n>methods</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;ITT</span><span class=se>\n</span><span class=s1>(All Users)&#39;</span><span class=p>,</span> <span class=s1>&#39;Triggered</span><span class=se>\n</span><span class=s1>(Exposed Only)&#39;</span><span class=p>,</span> <span class=s1>&#39;CACE</span><span class=se>\n</span><span class=s1>(Estimated)&#39;</span><span class=p>]</span>
        <span class=n>effects</span> <span class=o>=</span> <span class=p>[</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;itt&#39;</span><span class=p>][</span><span class=s1>&#39;effect&#39;</span><span class=p>],</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;triggered&#39;</span><span class=p>][</span><span class=s1>&#39;effect&#39;</span><span class=p>],</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;cace&#39;</span><span class=p>]</span> <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;cace&#39;</span><span class=p>]</span> <span class=k>else</span> <span class=mi>0</span>
        <span class=p>]</span>
        <span class=n>errors</span> <span class=o>=</span> <span class=p>[</span>
            <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;itt&#39;</span><span class=p>][</span><span class=s1>&#39;effect&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;itt&#39;</span><span class=p>][</span><span class=s1>&#39;ci_lower&#39;</span><span class=p>],</span>
             <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;itt&#39;</span><span class=p>][</span><span class=s1>&#39;ci_upper&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;itt&#39;</span><span class=p>][</span><span class=s1>&#39;effect&#39;</span><span class=p>]],</span>
            <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;triggered&#39;</span><span class=p>][</span><span class=s1>&#39;effect&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;triggered&#39;</span><span class=p>][</span><span class=s1>&#39;ci_lower&#39;</span><span class=p>],</span>
             <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;triggered&#39;</span><span class=p>][</span><span class=s1>&#39;ci_upper&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;triggered&#39;</span><span class=p>][</span><span class=s1>&#39;effect&#39;</span><span class=p>]],</span>
            <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span>  <span class=c1># No CI for CACE (needs bootstrap)</span>
        <span class=p>]</span>

        <span class=n>colors</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;#3498db&#39;</span><span class=p>,</span> <span class=s1>&#39;#e74c3c&#39;</span><span class=p>,</span> <span class=s1>&#39;#9b59b6&#39;</span><span class=p>]</span>
        <span class=n>x_pos</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>]</span>

        <span class=n>ax1</span><span class=o>.</span><span class=n>errorbar</span><span class=p>(</span><span class=n>x_pos</span><span class=p>,</span> <span class=n>effects</span><span class=p>,</span> 
                    <span class=n>yerr</span><span class=o>=</span><span class=p>[[</span><span class=n>errors</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>2</span><span class=p>)]</span> <span class=o>+</span> <span class=p>[</span><span class=mi>0</span><span class=p>],</span>
                          <span class=p>[</span><span class=n>errors</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>2</span><span class=p>)]</span> <span class=o>+</span> <span class=p>[</span><span class=mi>0</span><span class=p>]],</span>
                    <span class=n>fmt</span><span class=o>=</span><span class=s1>&#39;o&#39;</span><span class=p>,</span> <span class=n>markersize</span><span class=o>=</span><span class=mi>12</span><span class=p>,</span> <span class=n>capsize</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=n>capthick</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span>
                    <span class=n>color</span><span class=o>=</span><span class=n>colors</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>ecolor</span><span class=o>=</span><span class=n>colors</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>

        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>c</span><span class=p>)</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=n>x_pos</span><span class=p>,</span> <span class=n>effects</span><span class=p>,</span> <span class=n>colors</span><span class=p>)):</span>
            <span class=n>ax1</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=s1>&#39;o&#39;</span><span class=p>,</span> <span class=n>markersize</span><span class=o>=</span><span class=mi>12</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=n>c</span><span class=p>)</span>

        <span class=n>ax1</span><span class=o>.</span><span class=n>axhline</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;black&#39;</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;--&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
        <span class=n>ax1</span><span class=o>.</span><span class=n>set_xticks</span><span class=p>(</span><span class=n>x_pos</span><span class=p>)</span>
        <span class=n>ax1</span><span class=o>.</span><span class=n>set_xticklabels</span><span class=p>(</span><span class=n>methods</span><span class=p>)</span>
        <span class=n>ax1</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;Treatment Effect&#39;</span><span class=p>)</span>
        <span class=n>ax1</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;ITT vs Triggered vs CACE Comparison&#39;</span><span class=p>,</span> <span class=n>fontweight</span><span class=o>=</span><span class=s1>&#39;bold&#39;</span><span class=p>)</span>
        <span class=n>ax1</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=s1>&#39;y&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>

        <span class=c1># Plot 2: Sample sizes</span>
        <span class=n>sample_labels</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Treatment</span><span class=se>\n</span><span class=s1>(Assigned)&#39;</span><span class=p>,</span> <span class=s1>&#39;Treatment</span><span class=se>\n</span><span class=s1>(Triggered)&#39;</span><span class=p>,</span> <span class=s1>&#39;Control&#39;</span><span class=p>]</span>
        <span class=n>sample_sizes</span> <span class=o>=</span> <span class=p>[</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;itt&#39;</span><span class=p>][</span><span class=s1>&#39;n_treatment&#39;</span><span class=p>],</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;triggered&#39;</span><span class=p>][</span><span class=s1>&#39;n_triggered&#39;</span><span class=p>],</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;itt&#39;</span><span class=p>][</span><span class=s1>&#39;n_control&#39;</span><span class=p>]</span>
        <span class=p>]</span>

        <span class=n>ax2</span><span class=o>.</span><span class=n>bar</span><span class=p>(</span><span class=n>sample_labels</span><span class=p>,</span> <span class=n>sample_sizes</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;#3498db&#39;</span><span class=p>,</span> <span class=s1>&#39;#e74c3c&#39;</span><span class=p>,</span> <span class=s1>&#39;#95a5a6&#39;</span><span class=p>],</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span>
        <span class=n>ax2</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;Sample Size&#39;</span><span class=p>)</span>
        <span class=n>ax2</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;Sample Sizes by Analysis Type&#39;</span><span class=p>,</span> <span class=n>fontweight</span><span class=o>=</span><span class=s1>&#39;bold&#39;</span><span class=p>)</span>
        <span class=n>ax2</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=s1>&#39;y&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>

        <span class=c1># Add trigger rate annotation</span>
        <span class=n>trigger_text</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;Trigger Rate: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;dilution_factor&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>&quot;</span>
        <span class=n>ax2</span><span class=o>.</span><span class=n>text</span><span class=p>(</span><span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.95</span><span class=p>,</span> <span class=n>trigger_text</span><span class=p>,</span> <span class=n>transform</span><span class=o>=</span><span class=n>ax2</span><span class=o>.</span><span class=n>transAxes</span><span class=p>,</span>
                <span class=n>ha</span><span class=o>=</span><span class=s1>&#39;center&#39;</span><span class=p>,</span> <span class=n>va</span><span class=o>=</span><span class=s1>&#39;top&#39;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>12</span><span class=p>,</span> <span class=n>fontweight</span><span class=o>=</span><span class=s1>&#39;bold&#39;</span><span class=p>,</span>
                <span class=n>bbox</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>boxstyle</span><span class=o>=</span><span class=s1>&#39;round&#39;</span><span class=p>,</span> <span class=n>facecolor</span><span class=o>=</span><span class=s1>&#39;yellow&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>))</span>

        <span class=n>plt</span><span class=o>.</span><span class=n>tight_layout</span><span class=p>()</span>

        <span class=k>if</span> <span class=n>save_path</span><span class=p>:</span>
            <span class=n>plt</span><span class=o>.</span><span class=n>savefig</span><span class=p>(</span><span class=n>save_path</span><span class=p>,</span> <span class=n>dpi</span><span class=o>=</span><span class=mi>300</span><span class=p>,</span> <span class=n>bbox_inches</span><span class=o>=</span><span class=s1>&#39;tight&#39;</span><span class=p>)</span>

        <span class=k>return</span> <span class=n>fig</span>


<span class=c1># ===== Example 1: Uber Driver Feature =====</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;EXAMPLE 1: UBER - DRIVER IN-APP NAVIGATION EXPERIMENT&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>

<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>

<span class=c1># Randomize 20,000 drivers: 10,000 control, 10,000 treatment</span>
<span class=n>n_per_group</span> <span class=o>=</span> <span class=mi>10000</span>

<span class=c1># Treatment group: Only 70% actually use the feature (trigger)</span>
<span class=n>trigger_rate</span> <span class=o>=</span> <span class=mf>0.70</span>
<span class=n>n_triggered</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>n_per_group</span> <span class=o>*</span> <span class=n>trigger_rate</span><span class=p>)</span>

<span class=c1># Simulate outcomes: trips per day</span>
<span class=c1># Control: 15 trips/day on average</span>
<span class=n>control_trips</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>poisson</span><span class=p>(</span><span class=mi>15</span><span class=p>,</span> <span class=n>n_per_group</span><span class=p>)</span>

<span class=c1># Treatment (all assigned): Includes non-triggered (no effect) + triggered (+2 trips)</span>
<span class=n>treatment_not_triggered</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>poisson</span><span class=p>(</span><span class=mi>15</span><span class=p>,</span> <span class=n>n_per_group</span> <span class=o>-</span> <span class=n>n_triggered</span><span class=p>)</span>
<span class=n>treatment_triggered</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>poisson</span><span class=p>(</span><span class=mi>17</span><span class=p>,</span> <span class=n>n_triggered</span><span class=p>)</span>  <span class=c1># +2 trips for triggered</span>
<span class=n>treatment_all</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>([</span><span class=n>treatment_not_triggered</span><span class=p>,</span> <span class=n>treatment_triggered</span><span class=p>])</span>

<span class=c1># Analyze</span>
<span class=n>analyzer</span> <span class=o>=</span> <span class=n>TriggeredAnalyzer</span><span class=p>()</span>
<span class=n>results</span> <span class=o>=</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>compare_itt_triggered</span><span class=p>(</span>
    <span class=n>treatment_all</span><span class=o>=</span><span class=n>treatment_all</span><span class=p>,</span>
    <span class=n>treatment_triggered</span><span class=o>=</span><span class=n>treatment_triggered</span><span class=p>,</span>
    <span class=n>control_all</span><span class=o>=</span><span class=n>control_trips</span><span class=p>,</span>
    <span class=n>trigger_rate_treatment</span><span class=o>=</span><span class=n>trigger_rate</span>
<span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìä ITT Analysis (All Randomized Drivers):&quot;</span><span class=p>)</span>
<span class=n>itt</span> <span class=o>=</span> <span class=n>results</span><span class=p>[</span><span class=s1>&#39;itt&#39;</span><span class=p>]</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Treatment Effect: </span><span class=si>{</span><span class=n>itt</span><span class=p>[</span><span class=s1>&#39;effect&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> trips/day&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   95% CI: [</span><span class=si>{</span><span class=n>itt</span><span class=p>[</span><span class=s1>&#39;ci_lower&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>itt</span><span class=p>[</span><span class=s1>&#39;ci_upper&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>]&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   p-value: </span><span class=si>{</span><span class=n>itt</span><span class=p>[</span><span class=s1>&#39;p_value&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Significant: </span><span class=si>{</span><span class=s1>&#39;Yes ‚úì&#39;</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>itt</span><span class=p>[</span><span class=s1>&#39;significant&#39;</span><span class=p>]</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=s1>&#39;No ‚úó&#39;</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Sample: </span><span class=si>{</span><span class=n>itt</span><span class=p>[</span><span class=s1>&#39;n_treatment&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> treatment, </span><span class=si>{</span><span class=n>itt</span><span class=p>[</span><span class=s1>&#39;n_control&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> control&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìä Triggered Analysis (Only Drivers Who Used Feature):&quot;</span><span class=p>)</span>
<span class=n>trig</span> <span class=o>=</span> <span class=n>results</span><span class=p>[</span><span class=s1>&#39;triggered&#39;</span><span class=p>]</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Treatment Effect: </span><span class=si>{</span><span class=n>trig</span><span class=p>[</span><span class=s1>&#39;effect&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> trips/day&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   95% CI: [</span><span class=si>{</span><span class=n>trig</span><span class=p>[</span><span class=s1>&#39;ci_lower&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>trig</span><span class=p>[</span><span class=s1>&#39;ci_upper&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>]&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   p-value: </span><span class=si>{</span><span class=n>trig</span><span class=p>[</span><span class=s1>&#39;p_value&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Significant: </span><span class=si>{</span><span class=s1>&#39;Yes ‚úì&#39;</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>trig</span><span class=p>[</span><span class=s1>&#39;significant&#39;</span><span class=p>]</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=s1>&#39;No ‚úó&#39;</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Sample: </span><span class=si>{</span><span class=n>trig</span><span class=p>[</span><span class=s1>&#39;n_triggered&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> triggered, </span><span class=si>{</span><span class=n>trig</span><span class=p>[</span><span class=s1>&#39;n_control&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> control&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Trigger rate: </span><span class=si>{</span><span class=n>trig</span><span class=p>[</span><span class=s1>&#39;trigger_rate&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìä CACE (Complier Average Causal Effect):&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Estimated effect on compliers: </span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;cace&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> trips/day&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Formula: ITT Effect / Trigger Rate = </span><span class=si>{</span><span class=n>itt</span><span class=p>[</span><span class=s1>&#39;effect&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> / </span><span class=si>{</span><span class=n>trigger_rate</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üîç Interpretation:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   ‚Ä¢ ITT shows real-world impact: +</span><span class=si>{</span><span class=n>itt</span><span class=p>[</span><span class=s1>&#39;effect&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> trips (includes non-users)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   ‚Ä¢ Triggered shows effect on engaged users: +</span><span class=si>{</span><span class=n>trig</span><span class=p>[</span><span class=s1>&#39;effect&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> trips&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   ‚Ä¢ CACE estimates causal effect: +</span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;cace&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> trips&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   ‚Ä¢ ITT is </span><span class=si>{</span><span class=n>itt</span><span class=p>[</span><span class=s1>&#39;effect&#39;</span><span class=p>]</span><span class=o>/</span><span class=n>trig</span><span class=p>[</span><span class=s1>&#39;effect&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.0%</span><span class=si>}</span><span class=s2> of triggered effect (dilution)&quot;</span><span class=p>)</span>

<span class=c1># Visualize</span>
<span class=n>analyzer</span><span class=o>.</span><span class=n>plot_comparison</span><span class=p>()</span>
<span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</code></pre></div> <p><strong>Bias in Triggered Analysis:</strong></p> <table> <thead> <tr> <th>Bias Source</th> <th>Example</th> <th>Impact</th> <th>Mitigation</th> </tr> </thead> <tbody> <tr> <td><strong>Self-selection</strong></td> <td>Power users more likely to trigger</td> <td>Overestimates effect</td> <td>Compare trigger rates, use IV</td> </tr> <tr> <td><strong>Treatment affects triggering</strong></td> <td>Feature makes users visit more ‚Üí higher trigger</td> <td>Inflates effect</td> <td>Check if control would trigger similarly</td> </tr> <tr> <td><strong>External factors</strong></td> <td>Weekend users trigger more</td> <td>Confounding</td> <td>Balance on triggering covariates</td> </tr> <tr> <td><strong>Compliance drift</strong></td> <td>Trigger rate changes over time</td> <td>Time-varying bias</td> <td>Analyze by cohort</td> </tr> </tbody> </table> <p><strong>Real Company Examples:</strong></p> <table> <thead> <tr> <th>Company</th> <th>Experiment</th> <th>Trigger Rate</th> <th>ITT Effect</th> <th>Triggered Effect</th> <th>Decision</th> </tr> </thead> <tbody> <tr> <td><strong>Uber</strong></td> <td>Driver navigation feature</td> <td>70%</td> <td>+1.4 trips/day</td> <td>+2.0 trips/day</td> <td>Ship (ITT positive, real impact)</td> </tr> <tr> <td><strong>Lyft</strong></td> <td>Passenger surge pricing</td> <td>60% (surge hours)</td> <td>+$2 revenue/day</td> <td>+$3.5 revenue/day</td> <td>Report both, focus on ITT for ROI</td> </tr> <tr> <td><strong>DoorDash</strong></td> <td>Dasher heat map</td> <td>45% (open app)</td> <td>+0.8 orders/hour</td> <td>+1.8 orders/hour</td> <td>Investigate low trigger rate first</td> </tr> <tr> <td><strong>Netflix</strong></td> <td>"Skip Intro" button</td> <td>30% (shows with intro)</td> <td>+0.5 min watch time</td> <td>+1.7 min watch time</td> <td>ITT matters for business case</td> </tr> </tbody> </table> <p><strong>Decision Framework:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           When to Use ITT vs Triggered                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                               ‚îÇ
‚îÇ  Primary Analysis: ALWAYS ITT                                ‚îÇ
‚îÇ  ‚Ä¢ Preserves randomization                                    ‚îÇ
‚îÇ  ‚Ä¢ Real-world effect (includes non-compliance)                ‚îÇ
‚îÇ  ‚Ä¢ Unbiased estimate                                          ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  Secondary Analysis: Triggered (if relevant)                 ‚îÇ
‚îÇ  ‚Ä¢ When: Trigger rate &lt;80%                                   ‚îÇ
‚îÇ  ‚Ä¢ Purpose: Understand engaged user effect                    ‚îÇ
‚îÇ  ‚Ä¢ Caution: Check for selection bias                          ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  Report BOTH when:                                            ‚îÇ
‚îÇ  ‚Ä¢ Trigger rate &lt;80% AND &gt;20%                                ‚îÇ
‚îÇ  ‚Ä¢ Difference is large (triggered &gt;2√ó ITT)                   ‚îÇ
‚îÇ  ‚Ä¢ Decision depends on adoption strategy                      ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  Decision Rule:                                               ‚îÇ
‚îÇ  ‚îú‚îÄ ITT significant + positive ‚Üí Ship                        ‚îÇ
‚îÇ  ‚îú‚îÄ ITT null, Triggered positive ‚Üí Improve triggering        ‚îÇ
‚îÇ  ‚îî‚îÄ Both null ‚Üí Don&#39;t ship                                   ‚îÇ
‚îÇ                                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Common Mistakes:</strong></p> <table> <thead> <tr> <th>‚ùå Mistake</th> <th>Why It's Bad</th> <th>‚úÖ Fix</th> </tr> </thead> <tbody> <tr> <td><strong>Only report triggered</strong></td> <td>Ignores real-world dilution</td> <td>Always report ITT first</td> </tr> <tr> <td><strong>Compare triggered treatment to all control</strong></td> <td>Unfair comparison</td> <td>Use triggered control (if available) or adjust</td> </tr> <tr> <td><strong>Ignore trigger rate differences</strong></td> <td>Selection bias</td> <td>Compare treatment vs control trigger rates</td> </tr> <tr> <td><strong>Use triggered for business case</strong></td> <td>Overstates ROI</td> <td>Use ITT for revenue projections</td> </tr> </tbody> </table> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p><strong>What they're testing:</strong> Understanding of causal inference, compliance, selection bias, real-world vs ideal effects.</p> <p><strong>Strong answer signals:</strong></p> <ul> <li>Knows difference: ITT (all randomized) vs Triggered (exposed only)</li> <li>Explains ITT preserves randomization, triggered may have selection bias</li> <li>Mentions CACE (Complier Average Causal Effect) = ITT / Compliance</li> <li>States "Always report ITT first, triggered as secondary"</li> <li>Gives example: "Uber driver feature: 70% trigger rate, ITT +1.4 trips, Triggered +2.0 trips"</li> <li>Knows when triggered is biased (trigger rate differs between groups)</li> <li>Explains business impact: ITT matters for ROI, triggered for product understanding</li> </ul> <p><strong>Red flags:</strong></p> <ul> <li>Only mentions triggered analysis</li> <li>Doesn't understand selection bias in triggering</li> <li>Thinks triggered is always better ("higher power")</li> <li>Can't explain CACE or dilution</li> </ul> <p><strong>Follow-up questions:</strong></p> <ul> <li>"When would triggered analysis be biased?" (When treatment affects triggering, or power users self-select)</li> <li>"How do you decide which to use for business decision?" (Always ITT for go/no-go, triggered for product insights)</li> <li>"What if trigger rate is 10% in treatment, 30% in control?" (Major selection bias, triggered estimate invalid)</li> </ul> </div> </details> <hr> <h3 id=how-to-handle-carry-over-effects-netflix-airbnb-interview-question>How to Handle Carry-Over Effects? - Netflix, Airbnb Interview Question</h3> <p><strong>Difficulty:</strong> üî¥ Hard | <strong>Tags:</strong> <code>Design</code> | <strong>Asked by:</strong> Netflix, Airbnb, Uber</p> <details class=success> <summary>View Answer</summary> <p><strong>Carry-Over Effects</strong> occur when <strong>previous treatment exposure influences current behavior</strong>, violating the assumption that each experimental unit's outcome is independent of others' assignments. This is common in <strong>time-series experiments, crossover designs, and habit-forming features</strong>.</p> <p><strong>Types of Carry-Over:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Carry-Over Effect Types                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                    ‚îÇ
‚îÇ  1. LEARNING EFFECTS                                               ‚îÇ
‚îÇ     User learns behavior that persists                             ‚îÇ
‚îÇ     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                           ‚îÇ
‚îÇ     ‚îÇTreatment ‚îÇ  Washout ‚îÇ Control  ‚îÇ                            ‚îÇ
‚îÇ     ‚îÇ(Week 1)  ‚îÇ (Week 2) ‚îÇ(Week 3)  ‚îÇ                            ‚îÇ
‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                           ‚îÇ
‚îÇ     Effect: ‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí                          ‚îÇ
‚îÇ     (Behavior learned in W1 continues in W3)                       ‚îÇ
‚îÇ                                                                    ‚îÇ
‚îÇ  2. CONTRAST EFFECTS                                               ‚îÇ
‚îÇ     New experience makes old one feel worse                        ‚îÇ
‚îÇ     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                           ‚îÇ
‚îÇ     ‚îÇTreatment ‚îÇ  Washout ‚îÇ Control  ‚îÇ                            ‚îÇ
‚îÇ     ‚îÇ(New UI)  ‚îÇ          ‚îÇ(Old UI)  ‚îÇ                            ‚îÇ
‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                           ‚îÇ
‚îÇ     Effect: Control feels worse after seeing new UI                ‚îÇ
‚îÇ                                                                    ‚îÇ
‚îÇ  3. HABITUATION                                                    ‚îÇ
‚îÇ     User forms new habit                                           ‚îÇ
‚îÇ     Effect persists indefinitely                                   ‚îÇ
‚îÇ                                                                    ‚îÇ
‚îÇ  4. NOVELTY EFFECTS                                                ‚îÇ
‚îÇ     Initial excitement wears off                                   ‚îÇ
‚îÇ     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                           ‚îÇ
‚îÇ     ‚îÇ Effect ‚Üì                       ‚îÇ                            ‚îÇ
‚îÇ     ‚îÇ         ‚ï≤                      ‚îÇ                            ‚îÇ
‚îÇ     ‚îÇ          ‚ï≤_______________      ‚îÇ                            ‚îÇ
‚îÇ     ‚îÇ     Week 1  Week 2  Week 3    ‚îÇ                            ‚îÇ
‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                           ‚îÇ
‚îÇ                                                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Solutions &amp; Implementation:</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>import</span><span class=w> </span><span class=nn>matplotlib.pyplot</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>plt</span>
<span class=kn>from</span><span class=w> </span><span class=nn>datetime</span><span class=w> </span><span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timedelta</span>

<span class=c1># Production: Carry-Over Effect Detection and Mitigation</span>

<span class=k>class</span><span class=w> </span><span class=nc>CarryOverAnalyzer</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Detect and handle carry-over effects in experiments.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>timeline_data</span> <span class=o>=</span> <span class=kc>None</span>

    <span class=k>def</span><span class=w> </span><span class=nf>simulate_carryover_experiment</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>n_users</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span> <span class=n>weeks</span><span class=o>=</span><span class=mi>6</span><span class=p>,</span> 
                                     <span class=n>carryover_decay</span><span class=o>=</span><span class=mf>0.7</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Simulate crossover experiment with carry-over effects.</span>

<span class=sd>        Design: AB/BA crossover</span>
<span class=sd>        - Group 1: Treatment weeks 1-3, Control weeks 4-6</span>
<span class=sd>        - Group 2: Control weeks 1-3, Treatment weeks 4-6</span>

<span class=sd>        carryover_decay: How much treatment effect persists (0=none, 1=full)</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>

        <span class=n>timeline</span> <span class=o>=</span> <span class=p>[]</span>

        <span class=k>for</span> <span class=n>user_id</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_users</span><span class=p>):</span>
            <span class=n>group</span> <span class=o>=</span> <span class=s1>&#39;AB&#39;</span> <span class=k>if</span> <span class=n>user_id</span> <span class=o>&lt;</span> <span class=n>n_users</span><span class=o>//</span><span class=mi>2</span> <span class=k>else</span> <span class=s1>&#39;BA&#39;</span>

            <span class=k>for</span> <span class=n>week</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>weeks</span><span class=o>+</span><span class=mi>1</span><span class=p>):</span>
                <span class=c1># Determine assignment</span>
                <span class=k>if</span> <span class=n>group</span> <span class=o>==</span> <span class=s1>&#39;AB&#39;</span><span class=p>:</span>
                    <span class=n>is_treatment</span> <span class=o>=</span> <span class=n>week</span> <span class=o>&lt;=</span> <span class=mi>3</span>
                <span class=k>else</span><span class=p>:</span>  <span class=c1># BA</span>
                    <span class=n>is_treatment</span> <span class=o>=</span> <span class=n>week</span> <span class=o>&gt;</span> <span class=mi>3</span>

                <span class=c1># Base outcome</span>
                <span class=n>base_outcome</span> <span class=o>=</span> <span class=mi>100</span>

                <span class=c1># Treatment effect: +10</span>
                <span class=n>treatment_effect</span> <span class=o>=</span> <span class=mi>10</span> <span class=k>if</span> <span class=n>is_treatment</span> <span class=k>else</span> <span class=mi>0</span>

                <span class=c1># Carry-over effect: Persists from previous treatment</span>
                <span class=n>carryover_effect</span> <span class=o>=</span> <span class=mi>0</span>
                <span class=k>if</span> <span class=ow>not</span> <span class=n>is_treatment</span> <span class=ow>and</span> <span class=n>week</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>:</span>
                    <span class=c1># Check if was in treatment previous week</span>
                    <span class=n>prev_treatment</span> <span class=o>=</span> <span class=p>(</span><span class=n>week</span><span class=o>-</span><span class=mi>1</span> <span class=o>&lt;=</span> <span class=mi>3</span><span class=p>)</span> <span class=k>if</span> <span class=n>group</span> <span class=o>==</span> <span class=s1>&#39;AB&#39;</span> <span class=k>else</span> <span class=p>(</span><span class=n>week</span><span class=o>-</span><span class=mi>1</span> <span class=o>&gt;</span> <span class=mi>3</span><span class=p>)</span>
                    <span class=k>if</span> <span class=n>prev_treatment</span><span class=p>:</span>
                        <span class=c1># Decay based on weeks since last treatment</span>
                        <span class=n>weeks_since</span> <span class=o>=</span> <span class=mi>1</span>
                        <span class=n>carryover_effect</span> <span class=o>=</span> <span class=mi>10</span> <span class=o>*</span> <span class=p>(</span><span class=n>carryover_decay</span> <span class=o>**</span> <span class=n>weeks_since</span><span class=p>)</span>

                <span class=c1># Total outcome</span>
                <span class=n>outcome</span> <span class=o>=</span> <span class=n>base_outcome</span> <span class=o>+</span> <span class=n>treatment_effect</span> <span class=o>+</span> <span class=n>carryover_effect</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>

                <span class=n>timeline</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
                    <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=n>user_id</span><span class=p>,</span>
                    <span class=s1>&#39;group&#39;</span><span class=p>:</span> <span class=n>group</span><span class=p>,</span>
                    <span class=s1>&#39;week&#39;</span><span class=p>:</span> <span class=n>week</span><span class=p>,</span>
                    <span class=s1>&#39;is_treatment&#39;</span><span class=p>:</span> <span class=n>is_treatment</span><span class=p>,</span>
                    <span class=s1>&#39;outcome&#39;</span><span class=p>:</span> <span class=n>outcome</span><span class=p>,</span>
                    <span class=s1>&#39;carryover_effect&#39;</span><span class=p>:</span> <span class=n>carryover_effect</span>
                <span class=p>})</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>timeline_data</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>timeline</span><span class=p>)</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>timeline_data</span>

    <span class=k>def</span><span class=w> </span><span class=nf>detect_carryover</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span> <span class=n>outcome_col</span><span class=o>=</span><span class=s1>&#39;outcome&#39;</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Detect carry-over by comparing period 2 between groups.</span>

<span class=sd>        In AB/BA crossover:</span>
<span class=sd>        - If no carry-over: Period 2 effects should be equal but opposite</span>
<span class=sd>        - If carry-over: Group that had treatment in period 1 shows residual effect</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=c1># Split into periods</span>
        <span class=n>period1</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;week&#39;</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=mi>3</span><span class=p>]</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
        <span class=n>period2</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;week&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>3</span><span class=p>]</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>

        <span class=c1># Period 2: Compare AB (now control) vs BA (now treatment)</span>
        <span class=n>ab_period2</span> <span class=o>=</span> <span class=n>period2</span><span class=p>[</span><span class=n>period2</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;AB&#39;</span><span class=p>][</span><span class=n>outcome_col</span><span class=p>]</span>
        <span class=n>ba_period2</span> <span class=o>=</span> <span class=n>period2</span><span class=p>[</span><span class=n>period2</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;BA&#39;</span><span class=p>][</span><span class=n>outcome_col</span><span class=p>]</span>

        <span class=c1># If carry-over exists, AB should be higher than pure control</span>
        <span class=c1># because they retain some treatment effect</span>
        <span class=n>t_stat</span><span class=p>,</span> <span class=n>p_value</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span><span class=n>ab_period2</span><span class=p>,</span> <span class=n>ba_period2</span><span class=p>)</span>

        <span class=n>ab_mean</span> <span class=o>=</span> <span class=n>ab_period2</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
        <span class=n>ba_mean</span> <span class=o>=</span> <span class=n>ba_period2</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>

        <span class=c1># Expected: BA &gt; AB in period 2 (BA is now treatment)</span>
        <span class=c1># But if carry-over: difference is smaller than pure effect</span>

        <span class=k>return</span> <span class=p>{</span>
            <span class=s1>&#39;ab_period2_mean&#39;</span><span class=p>:</span> <span class=n>ab_mean</span><span class=p>,</span>
            <span class=s1>&#39;ba_period2_mean&#39;</span><span class=p>:</span> <span class=n>ba_mean</span><span class=p>,</span>
            <span class=s1>&#39;difference&#39;</span><span class=p>:</span> <span class=n>ba_mean</span> <span class=o>-</span> <span class=n>ab_mean</span><span class=p>,</span>
            <span class=s1>&#39;p_value&#39;</span><span class=p>:</span> <span class=n>p_value</span><span class=p>,</span>
            <span class=s1>&#39;carryover_detected&#39;</span><span class=p>:</span> <span class=n>p_value</span> <span class=o>&lt;</span> <span class=mf>0.05</span> <span class=ow>and</span> <span class=p>(</span><span class=n>ba_mean</span> <span class=o>-</span> <span class=n>ab_mean</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>8</span>  <span class=c1># Less than full effect</span>
        <span class=p>}</span>

    <span class=k>def</span><span class=w> </span><span class=nf>estimate_washout_period</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span> <span class=n>outcome_col</span><span class=o>=</span><span class=s1>&#39;outcome&#39;</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Estimate how many weeks needed for carry-over to decay.</span>

<span class=sd>        Uses AB group in period 2 (post-treatment) to see when</span>
<span class=sd>        outcome returns to baseline.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>ab_period2</span> <span class=o>=</span> <span class=n>df</span><span class=p>[(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;AB&#39;</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;week&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>3</span><span class=p>)]</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>

        <span class=c1># Group by weeks since treatment ended</span>
        <span class=n>ab_period2</span><span class=p>[</span><span class=s1>&#39;weeks_since_treatment&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>ab_period2</span><span class=p>[</span><span class=s1>&#39;week&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=mi>3</span>

        <span class=n>washout_pattern</span> <span class=o>=</span> <span class=n>ab_period2</span><span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=s1>&#39;weeks_since_treatment&#39;</span><span class=p>)[</span><span class=n>outcome_col</span><span class=p>]</span><span class=o>.</span><span class=n>agg</span><span class=p>([</span><span class=s1>&#39;mean&#39;</span><span class=p>,</span> <span class=s1>&#39;std&#39;</span><span class=p>,</span> <span class=s1>&#39;count&#39;</span><span class=p>])</span><span class=o>.</span><span class=n>reset_index</span><span class=p>()</span>

        <span class=c1># Baseline is BA group in period 1 (pure control)</span>
        <span class=n>baseline</span> <span class=o>=</span> <span class=n>df</span><span class=p>[(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;BA&#39;</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;week&#39;</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=mi>3</span><span class=p>)][</span><span class=n>outcome_col</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>

        <span class=n>washout_pattern</span><span class=p>[</span><span class=s1>&#39;diff_from_baseline&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>washout_pattern</span><span class=p>[</span><span class=s1>&#39;mean&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>baseline</span>

        <span class=c1># Washout complete when diff &lt; 2 (roughly within noise)</span>
        <span class=n>washout_weeks</span> <span class=o>=</span> <span class=n>washout_pattern</span><span class=p>[</span><span class=n>washout_pattern</span><span class=p>[</span><span class=s1>&#39;diff_from_baseline&#39;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>][</span><span class=s1>&#39;weeks_since_treatment&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>min</span><span class=p>()</span>

        <span class=k>return</span> <span class=n>washout_pattern</span><span class=p>,</span> <span class=n>washout_weeks</span>

    <span class=k>def</span><span class=w> </span><span class=nf>analyze_first_period_only</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span> <span class=n>outcome_col</span><span class=o>=</span><span class=s1>&#39;outcome&#39;</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Naive approach: Only use first period before any crossover.</span>
<span class=sd>        This avoids carry-over but wastes data.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>period1</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;week&#39;</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=mi>3</span><span class=p>]</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>

        <span class=n>ab_treatment</span> <span class=o>=</span> <span class=n>period1</span><span class=p>[</span><span class=n>period1</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;AB&#39;</span><span class=p>][</span><span class=n>outcome_col</span><span class=p>]</span>
        <span class=n>ba_control</span> <span class=o>=</span> <span class=n>period1</span><span class=p>[</span><span class=n>period1</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;BA&#39;</span><span class=p>][</span><span class=n>outcome_col</span><span class=p>]</span>

        <span class=n>t_stat</span><span class=p>,</span> <span class=n>p_value</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span><span class=n>ab_treatment</span><span class=p>,</span> <span class=n>ba_control</span><span class=p>)</span>

        <span class=n>effect</span> <span class=o>=</span> <span class=n>ab_treatment</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>-</span> <span class=n>ba_control</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
        <span class=n>se</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>stats</span><span class=o>.</span><span class=n>sem</span><span class=p>(</span><span class=n>ab_treatment</span><span class=p>)</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>stats</span><span class=o>.</span><span class=n>sem</span><span class=p>(</span><span class=n>ba_control</span><span class=p>)</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span>

        <span class=k>return</span> <span class=p>{</span>
            <span class=s1>&#39;effect&#39;</span><span class=p>:</span> <span class=n>effect</span><span class=p>,</span>
            <span class=s1>&#39;se&#39;</span><span class=p>:</span> <span class=n>se</span><span class=p>,</span>
            <span class=s1>&#39;p_value&#39;</span><span class=p>:</span> <span class=n>p_value</span><span class=p>,</span>
            <span class=s1>&#39;n_per_group&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>ab_treatment</span><span class=p>)</span>
        <span class=p>}</span>

    <span class=k>def</span><span class=w> </span><span class=nf>plot_carryover_timeline</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>save_path</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Visualize carry-over effects over time.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>timeline_data</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;Must simulate or load data first&quot;</span><span class=p>)</span>

        <span class=n>fig</span><span class=p>,</span> <span class=p>(</span><span class=n>ax1</span><span class=p>,</span> <span class=n>ax2</span><span class=p>)</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>16</span><span class=p>,</span> <span class=mi>6</span><span class=p>))</span>

        <span class=c1># Plot 1: Mean outcome over time by group</span>
        <span class=n>timeline_summary</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>timeline_data</span><span class=o>.</span><span class=n>groupby</span><span class=p>([</span><span class=s1>&#39;week&#39;</span><span class=p>,</span> <span class=s1>&#39;group&#39;</span><span class=p>])[</span><span class=s1>&#39;outcome&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=o>.</span><span class=n>reset_index</span><span class=p>()</span>

        <span class=k>for</span> <span class=n>group</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;AB&#39;</span><span class=p>,</span> <span class=s1>&#39;BA&#39;</span><span class=p>]:</span>
            <span class=n>data</span> <span class=o>=</span> <span class=n>timeline_summary</span><span class=p>[</span><span class=n>timeline_summary</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>group</span><span class=p>]</span>
            <span class=n>ax1</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s1>&#39;week&#39;</span><span class=p>],</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;outcome&#39;</span><span class=p>],</span> <span class=n>marker</span><span class=o>=</span><span class=s1>&#39;o&#39;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> 
                    <span class=n>markersize</span><span class=o>=</span><span class=mi>8</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=sa>f</span><span class=s1>&#39;Group </span><span class=si>{</span><span class=n>group</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>

        <span class=c1># Mark treatment periods</span>
        <span class=n>ax1</span><span class=o>.</span><span class=n>axvspan</span><span class=p>(</span><span class=mf>0.5</span><span class=p>,</span> <span class=mf>3.5</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.2</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;blue&#39;</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;AB Treatment Period&#39;</span><span class=p>)</span>
        <span class=n>ax1</span><span class=o>.</span><span class=n>axvspan</span><span class=p>(</span><span class=mf>3.5</span><span class=p>,</span> <span class=mf>6.5</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.2</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;BA Treatment Period&#39;</span><span class=p>)</span>

        <span class=n>ax1</span><span class=o>.</span><span class=n>set_xlabel</span><span class=p>(</span><span class=s1>&#39;Week&#39;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>12</span><span class=p>)</span>
        <span class=n>ax1</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;Mean Outcome&#39;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>12</span><span class=p>)</span>
        <span class=n>ax1</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;Crossover Design: Outcome Over Time&#39;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>14</span><span class=p>,</span> <span class=n>fontweight</span><span class=o>=</span><span class=s1>&#39;bold&#39;</span><span class=p>)</span>
        <span class=n>ax1</span><span class=o>.</span><span class=n>legend</span><span class=p>(</span><span class=n>loc</span><span class=o>=</span><span class=s1>&#39;best&#39;</span><span class=p>)</span>
        <span class=n>ax1</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>

        <span class=c1># Plot 2: Carry-over effect magnitude</span>
        <span class=n>carryover_data</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>timeline_data</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>timeline_data</span><span class=p>[</span><span class=s1>&#39;carryover_effect&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>]</span>
        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>carryover_data</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
            <span class=n>co_summary</span> <span class=o>=</span> <span class=n>carryover_data</span><span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=s1>&#39;week&#39;</span><span class=p>)[</span><span class=s1>&#39;carryover_effect&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=o>.</span><span class=n>reset_index</span><span class=p>()</span>
            <span class=n>ax2</span><span class=o>.</span><span class=n>bar</span><span class=p>(</span><span class=n>co_summary</span><span class=p>[</span><span class=s1>&#39;week&#39;</span><span class=p>],</span> <span class=n>co_summary</span><span class=p>[</span><span class=s1>&#39;carryover_effect&#39;</span><span class=p>],</span> 
                   <span class=n>color</span><span class=o>=</span><span class=s1>&#39;orange&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span>
            <span class=n>ax2</span><span class=o>.</span><span class=n>set_xlabel</span><span class=p>(</span><span class=s1>&#39;Week&#39;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>12</span><span class=p>)</span>
            <span class=n>ax2</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;Mean Carry-Over Effect&#39;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>12</span><span class=p>)</span>
            <span class=n>ax2</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;Carry-Over Effect Magnitude&#39;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>14</span><span class=p>,</span> <span class=n>fontweight</span><span class=o>=</span><span class=s1>&#39;bold&#39;</span><span class=p>)</span>
            <span class=n>ax2</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=s1>&#39;y&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>

        <span class=n>plt</span><span class=o>.</span><span class=n>tight_layout</span><span class=p>()</span>

        <span class=k>if</span> <span class=n>save_path</span><span class=p>:</span>
            <span class=n>plt</span><span class=o>.</span><span class=n>savefig</span><span class=p>(</span><span class=n>save_path</span><span class=p>,</span> <span class=n>dpi</span><span class=o>=</span><span class=mi>300</span><span class=p>,</span> <span class=n>bbox_inches</span><span class=o>=</span><span class=s1>&#39;tight&#39;</span><span class=p>)</span>

        <span class=k>return</span> <span class=n>fig</span>


<span class=c1># ===== Example: Netflix Content Recommendation Experiment =====</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;EXAMPLE: NETFLIX - CROSSOVER DESIGN WITH CARRY-OVER&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>

<span class=n>analyzer</span> <span class=o>=</span> <span class=n>CarryOverAnalyzer</span><span class=p>()</span>

<span class=c1># Simulate experiment with 70% carry-over decay</span>
<span class=n>df</span> <span class=o>=</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>simulate_carryover_experiment</span><span class=p>(</span>
    <span class=n>n_users</span><span class=o>=</span><span class=mi>2000</span><span class=p>,</span> 
    <span class=n>weeks</span><span class=o>=</span><span class=mi>6</span><span class=p>,</span> 
    <span class=n>carryover_decay</span><span class=o>=</span><span class=mf>0.7</span>
<span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üî¨ Experimental Design:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   ‚Ä¢ Group AB: Treatment weeks 1-3, Control weeks 4-6&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   ‚Ä¢ Group BA: Control weeks 1-3, Treatment weeks 4-6&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   ‚Ä¢ True treatment effect: +10 minutes watch time&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   ‚Ä¢ Carry-over decay: 70% per week&quot;</span><span class=p>)</span>

<span class=c1># Detect carry-over</span>
<span class=n>carryover_results</span> <span class=o>=</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>detect_carryover</span><span class=p>(</span><span class=n>df</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üîç Carry-Over Detection:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   ‚Ä¢ AB period 2 mean: </span><span class=si>{</span><span class=n>carryover_results</span><span class=p>[</span><span class=s1>&#39;ab_period2_mean&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   ‚Ä¢ BA period 2 mean: </span><span class=si>{</span><span class=n>carryover_results</span><span class=p>[</span><span class=s1>&#39;ba_period2_mean&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   ‚Ä¢ Difference: </span><span class=si>{</span><span class=n>carryover_results</span><span class=p>[</span><span class=s1>&#39;difference&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   ‚Ä¢ Carry-over detected: </span><span class=si>{</span><span class=s1>&#39;Yes ‚ö†Ô∏è&#39;</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>carryover_results</span><span class=p>[</span><span class=s1>&#39;carryover_detected&#39;</span><span class=p>]</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=s1>&#39;No ‚úì&#39;</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Estimate washout period</span>
<span class=n>washout_pattern</span><span class=p>,</span> <span class=n>washout_weeks</span> <span class=o>=</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>estimate_washout_period</span><span class=p>(</span><span class=n>df</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>‚è±Ô∏è Washout Period Estimation:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   ‚Ä¢ Weeks needed for effect to decay: </span><span class=si>{</span><span class=n>washout_weeks</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2> weeks&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   ‚Ä¢ Decay pattern:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>washout_pattern</span><span class=p>[[</span><span class=s1>&#39;weeks_since_treatment&#39;</span><span class=p>,</span> <span class=s1>&#39;mean&#39;</span><span class=p>,</span> <span class=s1>&#39;diff_from_baseline&#39;</span><span class=p>]]</span><span class=o>.</span><span class=n>to_string</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>))</span>

<span class=c1># First period only analysis</span>
<span class=n>first_period</span> <span class=o>=</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>analyze_first_period_only</span><span class=p>(</span><span class=n>df</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìä First Period Only Analysis (No Carry-Over):&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   ‚Ä¢ Treatment effect: </span><span class=si>{</span><span class=n>first_period</span><span class=p>[</span><span class=s1>&#39;effect&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   ‚Ä¢ SE: </span><span class=si>{</span><span class=n>first_period</span><span class=p>[</span><span class=s1>&#39;se&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   ‚Ä¢ p-value: </span><span class=si>{</span><span class=n>first_period</span><span class=p>[</span><span class=s1>&#39;p_value&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   ‚Ä¢ Sample per group: </span><span class=si>{</span><span class=n>first_period</span><span class=p>[</span><span class=s1>&#39;n_per_group&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> users&quot;</span><span class=p>)</span>

<span class=c1># Visualize</span>
<span class=n>analyzer</span><span class=o>.</span><span class=n>plot_carryover_timeline</span><span class=p>()</span>
<span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</code></pre></div> <p><strong>Mitigation Strategies:</strong></p> <table> <thead> <tr> <th>Strategy</th> <th>How It Works</th> <th>Pros</th> <th>Cons</th> <th>When to Use</th> </tr> </thead> <tbody> <tr> <td><strong>Washout Period</strong></td> <td>Add delay between treatments</td> <td>Simple, eliminates carry-over</td> <td>Loses time, data</td> <td>Crossover designs, short carry-over</td> </tr> <tr> <td><strong>First Period Only</strong></td> <td>Only analyze pre-crossover data</td> <td>No bias</td> <td>Wastes 50% of data</td> <td>Strong carry-over suspected</td> </tr> <tr> <td><strong>Parallel Groups</strong></td> <td>No crossover, pure A vs B</td> <td>No carry-over possible</td> <td>Needs more users</td> <td>Long-lasting effects (habit formation)</td> </tr> <tr> <td><strong>Long Experiment</strong></td> <td>Run for months until steady-state</td> <td>Measures true long-term effect</td> <td>Expensive</td> <td>Product changes, network effects</td> </tr> <tr> <td><strong>Statistical Adjustment</strong></td> <td>Model carry-over effect</td> <td>Uses all data</td> <td>Complex, requires assumptions</td> <td>Quantifiable decay pattern</td> </tr> </tbody> </table> <p><strong>Real Company Examples:</strong></p> <table> <thead> <tr> <th>Company</th> <th>Experiment</th> <th>Carry-Over Type</th> <th>Solution</th> <th>Outcome</th> </tr> </thead> <tbody> <tr> <td><strong>Netflix</strong></td> <td>Recommendation algorithm</td> <td>Learning (users find new content)</td> <td>3-month parallel groups</td> <td>Found 8% watch time lift persists long-term</td> </tr> <tr> <td><strong>Airbnb</strong></td> <td>Search ranking</td> <td>Contrast effect (old ranking feels worse)</td> <td>2-week washout in crossover</td> <td>Detected 20% carry-over, extended washout to 4 weeks</td> </tr> <tr> <td><strong>Uber</strong></td> <td>Surge pricing UI</td> <td>Habituation (users learn to avoid surge)</td> <td>First period only analysis</td> <td>Avoided biased estimate from learned behavior</td> </tr> <tr> <td><strong>Spotify</strong></td> <td>Playlist algorithm</td> <td>Novelty (initial excitement ‚Üí decay)</td> <td>8-week experiment, analyze by week</td> <td>Week 1: +15% engagement, Week 8: +5% (true effect)</td> </tr> </tbody> </table> <p><strong>Crossover Design with Washout:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ             Crossover Design with Washout Period                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                   ‚îÇ
‚îÇ  Group AB:                                                        ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                      ‚îÇ
‚îÇ  ‚îÇPeriod 1 ‚îÇ Washout ‚îÇPeriod 2 ‚îÇ Washout ‚îÇ                      ‚îÇ
‚îÇ  ‚îÇTreatment‚îÇ  (2wk)  ‚îÇControl  ‚îÇ  (2wk)  ‚îÇ                      ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                      ‚îÇ
‚îÇ      ‚Üë                   ‚Üë                                       ‚îÇ
‚îÇ   Measure            Measure                                     ‚îÇ
‚îÇ                                                                   ‚îÇ
‚îÇ  Group BA:                                                        ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                      ‚îÇ
‚îÇ  ‚îÇPeriod 1 ‚îÇ Washout ‚îÇPeriod 2 ‚îÇ Washout ‚îÇ                      ‚îÇ
‚îÇ  ‚îÇControl  ‚îÇ  (2wk)  ‚îÇTreatment‚îÇ  (2wk)  ‚îÇ                      ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                      ‚îÇ
‚îÇ      ‚Üë                   ‚Üë                                       ‚îÇ
‚îÇ   Measure            Measure                                     ‚îÇ
‚îÇ                                                                   ‚îÇ
‚îÇ  Benefits:                                                        ‚îÇ
‚îÇ  ‚Ä¢ Each user is their own control (reduces variance)              ‚îÇ
‚îÇ  ‚Ä¢ Washout eliminates carry-over                                  ‚îÇ
‚îÇ  ‚Ä¢ Balanced design (both sequences)                               ‚îÇ
‚îÇ                                                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Decision Framework:</strong></p> <table> <thead> <tr> <th>Carry-Over Severity</th> <th>Washout Period Needed</th> <th>Recommended Design</th> </tr> </thead> <tbody> <tr> <td><strong>None</strong></td> <td>0 days</td> <td>Standard parallel groups or crossover</td> </tr> <tr> <td><strong>Weak (&lt;20% residual)</strong></td> <td>1-2 weeks</td> <td>Crossover with short washout</td> </tr> <tr> <td><strong>Moderate (20-50%)</strong></td> <td>2-4 weeks</td> <td>Crossover with washout OR first period only</td> </tr> <tr> <td><strong>Strong (&gt;50%)</strong></td> <td>&gt;4 weeks or indefinite</td> <td>Parallel groups only, long experiment</td> </tr> </tbody> </table> <p><strong>Common Mistakes:</strong></p> <table> <thead> <tr> <th>‚ùå Mistake</th> <th>Why It's Bad</th> <th>‚úÖ Fix</th> </tr> </thead> <tbody> <tr> <td><strong>Ignore carry-over</strong></td> <td>Biased estimates, wrong conclusions</td> <td>Test for carry-over, use washout</td> </tr> <tr> <td><strong>Too short washout</strong></td> <td>Carry-over persists</td> <td>Pilot test to estimate decay time</td> </tr> <tr> <td><strong>Use both periods with carry-over</strong></td> <td>Violates independence</td> <td>First period only OR statistical adjustment</td> </tr> <tr> <td><strong>Crossover for habit-forming features</strong></td> <td>Permanent behavior change</td> <td>Use parallel groups for long-term effects</td> </tr> </tbody> </table> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p><strong>What they're testing:</strong> Understanding of temporal dependencies, crossover designs, experimental validity.</p> <p><strong>Strong answer signals:</strong></p> <ul> <li>Defines carry-over: "Previous treatment affects current behavior"</li> <li>Gives examples: Learning effects, contrast effects, habituation</li> <li>Knows multiple solutions: Washout period, first period only, parallel groups</li> <li>Explains crossover design: AB/BA with balanced sequences</li> <li>Mentions detection method: Compare period 2 between groups</li> <li>Gives company example: "Netflix uses 3-month parallel for recommendation changes"</li> <li>Knows when to avoid crossover: Habit-forming features, long-lasting effects</li> </ul> <p><strong>Red flags:</strong></p> <ul> <li>Never heard of carry-over effects</li> <li>Thinks crossover is always better than parallel</li> <li>Can't explain how to detect carry-over</li> <li>Doesn't know washout period concept</li> </ul> <p><strong>Follow-up questions:</strong></p> <ul> <li>"How do you choose washout period length?" (Pilot test, look at decay curve, typically 1-4 weeks)</li> <li>"When should you NOT use crossover design?" (Habit-forming features, permanent behavior changes)</li> <li>"How do you detect carry-over?" (Compare period 2 between AB and BA groups, expect symmetric effects)</li> </ul> </div> </details> <hr> <h3 id=what-is-intent-to-treat-itt-analysis-and-how-do-you-handle-non-compliance-netflix-google-interview-question>What is Intent-to-Treat (ITT) Analysis and How Do You Handle Non-Compliance? - Netflix, Google Interview Question</h3> <p><strong>Difficulty:</strong> üî¥ Hard | <strong>Tags:</strong> <code>Analysis</code>, <code>Compliance</code>, <code>CACE</code> | <strong>Asked by:</strong> Netflix, Google, Meta, Spotify</p> <details class=success> <summary>View Answer</summary> <p><strong>Intent-to-Treat (ITT) analysis</strong> is the <strong>gold standard</strong> for A/B tests, analyzing users <strong>as originally randomized</strong> regardless of whether they actually received or complied with treatment. This preserves <strong>randomization</strong> and measures <strong>real-world effectiveness</strong>, but may <strong>underestimate</strong> true treatment effects when compliance is low.</p> <p><strong>Critical Concepts:</strong></p> <ul> <li><strong>ITT Effect:</strong> Effect of being <strong>assigned</strong> to treatment (real-world impact)</li> <li><strong>Per-Protocol Effect:</strong> Effect among users who <strong>actually received</strong> treatment (efficacy)</li> <li><strong>CACE (Complier Average Causal Effect):</strong> Effect among <strong>compliers only</strong> (unbiased estimate)</li> <li><strong>Non-Compliance:</strong> Users assigned to treatment don't use it, or control users get treatment</li> </ul> <p><strong>Comparison of Analysis Methods:</strong></p> <table> <thead> <tr> <th>Method</th> <th>Analyzed Users</th> <th>Preserves Randomization</th> <th>Measures</th> <th>Bias Risk</th> </tr> </thead> <tbody> <tr> <td><strong>Intent-to-Treat (ITT)</strong></td> <td>All as randomized</td> <td>‚úÖ Yes</td> <td>Real-world effectiveness</td> <td>None (conservative)</td> </tr> <tr> <td><strong>Per-Protocol</strong></td> <td>Only compliers</td> <td>‚ùå No</td> <td>Efficacy under perfect adherence</td> <td>High (selection bias)</td> </tr> <tr> <td><strong>CACE (IV Method)</strong></td> <td>Adjusts for compliance</td> <td>‚úÖ Yes</td> <td>Effect for compliers</td> <td>Low (if assumptions met)</td> </tr> <tr> <td><strong>As-Treated</strong></td> <td>By actual treatment</td> <td>‚ùå No</td> <td>Observed behavior</td> <td>High (confounding)</td> </tr> </tbody> </table> <p><strong>When Compliance Matters:</strong></p> <table> <thead> <tr> <th>Scenario</th> <th>Compliance Rate</th> <th>Recommended Approach</th> <th>Example</th> </tr> </thead> <tbody> <tr> <td>High adoption</td> <td>&gt;90%</td> <td>ITT sufficient</td> <td>Spotify: New UI flows (95% usage)</td> </tr> <tr> <td>Moderate adoption</td> <td>60-90%</td> <td>ITT + CACE sensitivity</td> <td>Netflix: Recommendation change (75% eligible users)</td> </tr> <tr> <td>Low adoption</td> <td>&lt;60%</td> <td>CACE essential, understand barriers</td> <td>Uber: Driver incentive program (45% participation)</td> </tr> <tr> <td>Opt-in features</td> <td>Varies</td> <td>ITT + subgroup analysis</td> <td>LinkedIn: Premium feature test</td> </tr> </tbody> </table> <p><strong>Real Company Examples:</strong></p> <table> <thead> <tr> <th>Company</th> <th>Test</th> <th>Compliance</th> <th>ITT Effect</th> <th>CACE Effect</th> <th>Decision</th> </tr> </thead> <tbody> <tr> <td><strong>Netflix</strong></td> <td>Personalized thumbnails</td> <td>82% viewed</td> <td>+2.1% watch time</td> <td>+2.5% watch time</td> <td>Launched (ITT shows clear benefit)</td> </tr> <tr> <td><strong>Spotify</strong></td> <td>Daily Mix playlist</td> <td>68% listened</td> <td>+1.8% session length</td> <td>+2.6% session length</td> <td>Launched with promotion to boost adoption</td> </tr> <tr> <td><strong>Uber</strong></td> <td>Driver cash-out feature</td> <td>41% activated</td> <td>+0.3% driver hours</td> <td>+0.7% driver hours</td> <td>Launched + education campaign</td> </tr> <tr> <td><strong>LinkedIn</strong></td> <td>Skill endorsements</td> <td>55% engaged</td> <td>+4.2% profile views</td> <td>+7.6% profile views</td> <td>Launched with onboarding nudges</td> </tr> </tbody> </table> <p><strong>Architecture - Compliance Analysis Framework:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ             INTENT-TO-TREAT (ITT) ANALYSIS FRAMEWORK               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
‚îÇ  ‚îÇ Randomization‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Assignment  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Outcome    ‚îÇ      ‚îÇ
‚îÇ  ‚îÇ   (Valid)    ‚îÇ     ‚îÇ   Groups     ‚îÇ     ‚îÇ  Measurement ‚îÇ      ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
‚îÇ                               ‚îÇ                                    ‚îÇ
‚îÇ                               ‚Üì                                    ‚îÇ
‚îÇ                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                       ‚îÇ
‚îÇ                  ‚îÇ   Compliance Check     ‚îÇ                       ‚îÇ
‚îÇ                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                       ‚îÇ
‚îÇ                               ‚îÇ                                    ‚îÇ
‚îÇ          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê             ‚îÇ
‚îÇ          ‚Üì                    ‚Üì                    ‚Üì             ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ
‚îÇ    ‚îÇCompliers ‚îÇ         ‚îÇNever-    ‚îÇ        ‚îÇ Always-  ‚îÇ       ‚îÇ
‚îÇ    ‚îÇ(respond  ‚îÇ         ‚îÇTakers    ‚îÇ        ‚îÇ Takers   ‚îÇ       ‚îÇ
‚îÇ    ‚îÇto Z)     ‚îÇ         ‚îÇ(Z=1,D=0) ‚îÇ        ‚îÇ(Z=0,D=1) ‚îÇ       ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ
‚îÇ          ‚îÇ                                                        ‚îÇ
‚îÇ          ‚Üì                                                        ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                          ‚îÇ
‚îÇ    ‚îÇ   ANALYSIS STRATEGIES:          ‚îÇ                          ‚îÇ
‚îÇ    ‚îÇ                                  ‚îÇ                          ‚îÇ
‚îÇ    ‚îÇ  1. ITT: E[Y|Z=1] - E[Y|Z=0]   ‚îÇ                          ‚îÇ
‚îÇ    ‚îÇ  2. CACE: ITT / compliance_rate ‚îÇ                          ‚îÇ
‚îÇ    ‚îÇ  3. Bounds: Sensitivity analysis‚îÇ                          ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                          ‚îÇ
‚îÇ                                                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Production Code - Complete ITT and CACE Analysis:</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>from</span><span class=w> </span><span class=nn>dataclasses</span><span class=w> </span><span class=kn>import</span> <span class=n>dataclass</span>
<span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Tuple</span><span class=p>,</span> <span class=n>Optional</span>
<span class=kn>import</span><span class=w> </span><span class=nn>matplotlib.pyplot</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>plt</span>
<span class=kn>from</span><span class=w> </span><span class=nn>statsmodels.api</span><span class=w> </span><span class=kn>import</span> <span class=n>OLS</span>
<span class=kn>import</span><span class=w> </span><span class=nn>statsmodels.formula.api</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>smf</span>

<span class=nd>@dataclass</span>
<span class=k>class</span><span class=w> </span><span class=nc>ITTResult</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Results from Intent-to-Treat analysis.&quot;&quot;&quot;</span>
    <span class=n>itt_effect</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>itt_se</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>itt_ci</span><span class=p>:</span> <span class=n>Tuple</span><span class=p>[</span><span class=nb>float</span><span class=p>,</span> <span class=nb>float</span><span class=p>]</span>
    <span class=n>itt_pvalue</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>control_mean</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>treatment_mean</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>n_control</span><span class=p>:</span> <span class=nb>int</span>
    <span class=n>n_treatment</span><span class=p>:</span> <span class=nb>int</span>

<span class=nd>@dataclass</span>
<span class=k>class</span><span class=w> </span><span class=nc>CACEResult</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Results from CACE (Complier Average Causal Effect) analysis.&quot;&quot;&quot;</span>
    <span class=n>cace_effect</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>cace_se</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>cace_ci</span><span class=p>:</span> <span class=n>Tuple</span><span class=p>[</span><span class=nb>float</span><span class=p>,</span> <span class=nb>float</span><span class=p>]</span>
    <span class=n>compliance_rate_treatment</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>compliance_rate_control</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>first_stage_f</span><span class=p>:</span> <span class=nb>float</span>

<span class=k>class</span><span class=w> </span><span class=nc>ComplianceAnalyzer</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Comprehensive analyzer for ITT and non-compliance in A/B tests.</span>

<span class=sd>    Handles:</span>
<span class=sd>    - Intent-to-Treat (ITT) analysis</span>
<span class=sd>    - Per-protocol analysis (with warnings about bias)</span>
<span class=sd>    - CACE estimation using instrumental variables</span>
<span class=sd>    - Compliance rate calculation</span>
<span class=sd>    - Sensitivity analysis</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>alpha</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.05</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>=</span> <span class=n>alpha</span>

    <span class=k>def</span><span class=w> </span><span class=nf>analyze_itt</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span> 
                   <span class=n>outcome_col</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;outcome&#39;</span><span class=p>,</span>
                   <span class=n>assignment_col</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;assigned_treatment&#39;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ITTResult</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Standard Intent-to-Treat analysis.</span>
<span class=sd>        Compares outcomes by ASSIGNED treatment, regardless of compliance.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>control</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=n>assignment_col</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>][</span><span class=n>outcome_col</span><span class=p>]</span>
        <span class=n>treatment</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=n>assignment_col</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>][</span><span class=n>outcome_col</span><span class=p>]</span>

        <span class=c1># ITT effect</span>
        <span class=n>control_mean</span> <span class=o>=</span> <span class=n>control</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
        <span class=n>treatment_mean</span> <span class=o>=</span> <span class=n>treatment</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
        <span class=n>itt_effect</span> <span class=o>=</span> <span class=n>treatment_mean</span> <span class=o>-</span> <span class=n>control_mean</span>

        <span class=c1># Standard error</span>
        <span class=n>se_control</span> <span class=o>=</span> <span class=n>control</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>/</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>))</span>
        <span class=n>se_treatment</span> <span class=o>=</span> <span class=n>treatment</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>/</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>))</span>
        <span class=n>itt_se</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>se_control</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>se_treatment</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span>

        <span class=c1># Confidence interval</span>
        <span class=n>z_crit</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>norm</span><span class=o>.</span><span class=n>ppf</span><span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>/</span> <span class=mi>2</span><span class=p>)</span>
        <span class=n>itt_ci</span> <span class=o>=</span> <span class=p>(</span><span class=n>itt_effect</span> <span class=o>-</span> <span class=n>z_crit</span> <span class=o>*</span> <span class=n>itt_se</span><span class=p>,</span> <span class=n>itt_effect</span> <span class=o>+</span> <span class=n>z_crit</span> <span class=o>*</span> <span class=n>itt_se</span><span class=p>)</span>

        <span class=c1># P-value</span>
        <span class=n>z_stat</span> <span class=o>=</span> <span class=n>itt_effect</span> <span class=o>/</span> <span class=n>itt_se</span>
        <span class=n>itt_pvalue</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>stats</span><span class=o>.</span><span class=n>norm</span><span class=o>.</span><span class=n>cdf</span><span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>z_stat</span><span class=p>)))</span>

        <span class=k>return</span> <span class=n>ITTResult</span><span class=p>(</span>
            <span class=n>itt_effect</span><span class=o>=</span><span class=n>itt_effect</span><span class=p>,</span>
            <span class=n>itt_se</span><span class=o>=</span><span class=n>itt_se</span><span class=p>,</span>
            <span class=n>itt_ci</span><span class=o>=</span><span class=n>itt_ci</span><span class=p>,</span>
            <span class=n>itt_pvalue</span><span class=o>=</span><span class=n>itt_pvalue</span><span class=p>,</span>
            <span class=n>control_mean</span><span class=o>=</span><span class=n>control_mean</span><span class=p>,</span>
            <span class=n>treatment_mean</span><span class=o>=</span><span class=n>treatment_mean</span><span class=p>,</span>
            <span class=n>n_control</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>),</span>
            <span class=n>n_treatment</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>)</span>
        <span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>analyze_per_protocol</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span>
                            <span class=n>outcome_col</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;outcome&#39;</span><span class=p>,</span>
                            <span class=n>received_col</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;received_treatment&#39;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Per-protocol analysis (BIASED - use with caution).</span>
<span class=sd>        Compares users who ACTUALLY received treatment vs control.</span>

<span class=sd>        WARNING: Selection bias! Non-compliers may differ systematically.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>control</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=n>received_col</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>][</span><span class=n>outcome_col</span><span class=p>]</span>
        <span class=n>treatment</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=n>received_col</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>][</span><span class=n>outcome_col</span><span class=p>]</span>

        <span class=n>effect</span> <span class=o>=</span> <span class=n>treatment</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>-</span> <span class=n>control</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
        <span class=n>se</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>control</span><span class=o>.</span><span class=n>var</span><span class=p>()</span><span class=o>/</span><span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>)</span> <span class=o>+</span> <span class=n>treatment</span><span class=o>.</span><span class=n>var</span><span class=p>()</span><span class=o>/</span><span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>))</span>

        <span class=k>return</span> <span class=p>{</span>
            <span class=s1>&#39;per_protocol_effect&#39;</span><span class=p>:</span> <span class=n>effect</span><span class=p>,</span>
            <span class=s1>&#39;per_protocol_se&#39;</span><span class=p>:</span> <span class=n>se</span><span class=p>,</span>
            <span class=s1>&#39;warning&#39;</span><span class=p>:</span> <span class=s1>&#39;BIASED ESTIMATE - selection bias likely present&#39;</span><span class=p>,</span>
            <span class=s1>&#39;control_mean&#39;</span><span class=p>:</span> <span class=n>control</span><span class=o>.</span><span class=n>mean</span><span class=p>(),</span>
            <span class=s1>&#39;treatment_mean&#39;</span><span class=p>:</span> <span class=n>treatment</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
        <span class=p>}</span>

    <span class=k>def</span><span class=w> </span><span class=nf>estimate_cace</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span>
                     <span class=n>outcome_col</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;outcome&#39;</span><span class=p>,</span>
                     <span class=n>assignment_col</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;assigned_treatment&#39;</span><span class=p>,</span>
                     <span class=n>received_col</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;received_treatment&#39;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>CACEResult</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        CACE estimation using Instrumental Variables (2SLS).</span>

<span class=sd>        Assignment is the instrument for actual treatment received.</span>
<span class=sd>        Estimates effect for compliers (those who take treatment when assigned).</span>

<span class=sd>        Assumptions:</span>
<span class=sd>        1. Random assignment (valid instrument)</span>
<span class=sd>        2. Exclusion restriction (assignment affects outcome only through treatment)</span>
<span class=sd>        3. Monotonicity (no defiers)</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=c1># First stage: Assignment ‚Üí Received treatment</span>
        <span class=n>first_stage</span> <span class=o>=</span> <span class=n>smf</span><span class=o>.</span><span class=n>ols</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>received_col</span><span class=si>}</span><span class=s1> ~ </span><span class=si>{</span><span class=n>assignment_col</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>df</span><span class=p>)</span><span class=o>.</span><span class=n>fit</span><span class=p>()</span>
        <span class=n>compliance_rate_control</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=n>assignment_col</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>][</span><span class=n>received_col</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
        <span class=n>compliance_rate_treatment</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=n>assignment_col</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>][</span><span class=n>received_col</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
        <span class=n>first_stage_f</span> <span class=o>=</span> <span class=n>first_stage</span><span class=o>.</span><span class=n>fvalue</span>

        <span class=c1># Check weak instrument</span>
        <span class=k>if</span> <span class=n>first_stage_f</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;‚ö†Ô∏è  WARNING: Weak instrument (F=</span><span class=si>{</span><span class=n>first_stage_f</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> &lt; 10)&quot;</span><span class=p>)</span>

        <span class=c1># Second stage: Predicted treatment ‚Üí Outcome (using 2SLS manually)</span>
        <span class=c1># Simpler approach: ITT / compliance rate difference</span>
        <span class=n>itt_result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>analyze_itt</span><span class=p>(</span><span class=n>df</span><span class=p>,</span> <span class=n>outcome_col</span><span class=p>,</span> <span class=n>assignment_col</span><span class=p>)</span>
        <span class=n>itt_effect</span> <span class=o>=</span> <span class=n>itt_result</span><span class=o>.</span><span class=n>itt_effect</span>

        <span class=n>compliance_diff</span> <span class=o>=</span> <span class=n>compliance_rate_treatment</span> <span class=o>-</span> <span class=n>compliance_rate_control</span>

        <span class=k>if</span> <span class=n>compliance_diff</span> <span class=o>&lt;</span> <span class=mf>0.01</span><span class=p>:</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;Compliance rates too similar - cannot estimate CACE&quot;</span><span class=p>)</span>

        <span class=c1># CACE = ITT / (compliance_treatment - compliance_control)</span>
        <span class=n>cace_effect</span> <span class=o>=</span> <span class=n>itt_effect</span> <span class=o>/</span> <span class=n>compliance_diff</span>

        <span class=c1># Standard error (Wald estimator)</span>
        <span class=c1># SE(CACE) ‚âà SE(ITT) / compliance_diff</span>
        <span class=n>cace_se</span> <span class=o>=</span> <span class=n>itt_result</span><span class=o>.</span><span class=n>itt_se</span> <span class=o>/</span> <span class=n>compliance_diff</span>

        <span class=n>z_crit</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>norm</span><span class=o>.</span><span class=n>ppf</span><span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>/</span> <span class=mi>2</span><span class=p>)</span>
        <span class=n>cace_ci</span> <span class=o>=</span> <span class=p>(</span><span class=n>cace_effect</span> <span class=o>-</span> <span class=n>z_crit</span> <span class=o>*</span> <span class=n>cace_se</span><span class=p>,</span> <span class=n>cace_effect</span> <span class=o>+</span> <span class=n>z_crit</span> <span class=o>*</span> <span class=n>cace_se</span><span class=p>)</span>

        <span class=k>return</span> <span class=n>CACEResult</span><span class=p>(</span>
            <span class=n>cace_effect</span><span class=o>=</span><span class=n>cace_effect</span><span class=p>,</span>
            <span class=n>cace_se</span><span class=o>=</span><span class=n>cace_se</span><span class=p>,</span>
            <span class=n>cace_ci</span><span class=o>=</span><span class=n>cace_ci</span><span class=p>,</span>
            <span class=n>compliance_rate_treatment</span><span class=o>=</span><span class=n>compliance_rate_treatment</span><span class=p>,</span>
            <span class=n>compliance_rate_control</span><span class=o>=</span><span class=n>compliance_rate_control</span><span class=p>,</span>
            <span class=n>first_stage_f</span><span class=o>=</span><span class=n>first_stage_f</span>
        <span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>compliance_summary</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span>
                          <span class=n>assignment_col</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;assigned_treatment&#39;</span><span class=p>,</span>
                          <span class=n>received_col</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;received_treatment&#39;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Create compliance table showing all four groups.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>summary</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>groupby</span><span class=p>([</span><span class=n>assignment_col</span><span class=p>,</span> <span class=n>received_col</span><span class=p>])</span><span class=o>.</span><span class=n>size</span><span class=p>()</span><span class=o>.</span><span class=n>reset_index</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;count&#39;</span><span class=p>)</span>
        <span class=n>summary</span><span class=p>[</span><span class=s1>&#39;percentage&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>summary</span><span class=p>[</span><span class=s1>&#39;count&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>df</span><span class=p>)</span> <span class=o>*</span> <span class=mi>100</span>

        <span class=n>summary</span><span class=p>[</span><span class=s1>&#39;group_type&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
        <span class=n>summary</span><span class=o>.</span><span class=n>loc</span><span class=p>[(</span><span class=n>summary</span><span class=p>[</span><span class=n>assignment_col</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>summary</span><span class=p>[</span><span class=n>received_col</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>),</span> <span class=s1>&#39;group_type&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;Compliers (Treatment)&#39;</span>
        <span class=n>summary</span><span class=o>.</span><span class=n>loc</span><span class=p>[(</span><span class=n>summary</span><span class=p>[</span><span class=n>assignment_col</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>summary</span><span class=p>[</span><span class=n>received_col</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>),</span> <span class=s1>&#39;group_type&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;Compliers (Control)&#39;</span>
        <span class=n>summary</span><span class=o>.</span><span class=n>loc</span><span class=p>[(</span><span class=n>summary</span><span class=p>[</span><span class=n>assignment_col</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>summary</span><span class=p>[</span><span class=n>received_col</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>),</span> <span class=s1>&#39;group_type&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;Never-Takers&#39;</span>
        <span class=n>summary</span><span class=o>.</span><span class=n>loc</span><span class=p>[(</span><span class=n>summary</span><span class=p>[</span><span class=n>assignment_col</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>summary</span><span class=p>[</span><span class=n>received_col</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>),</span> <span class=s1>&#39;group_type&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;Always-Takers&#39;</span>

        <span class=k>return</span> <span class=n>summary</span>


<span class=c1># ===== Example: Spotify Premium Feature Test =====</span>

<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
<span class=n>n_users</span> <span class=o>=</span> <span class=mi>10000</span>

<span class=c1># Generate experiment data with non-compliance</span>
<span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
    <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_users</span><span class=p>),</span>
    <span class=s1>&#39;assigned_treatment&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>,</span> <span class=n>n_users</span><span class=p>)</span>
<span class=p>})</span>

<span class=c1># Simulate compliance (not everyone assigned to treatment uses it)</span>
<span class=c1># Treatment group: 75% compliance</span>
<span class=c1># Control group: 5% always-takers (somehow get treatment)</span>
<span class=n>df</span><span class=p>[</span><span class=s1>&#39;received_treatment&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span>
<span class=n>treatment_assigned</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;assigned_treatment&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span>
<span class=n>control_assigned</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;assigned_treatment&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span>

<span class=n>df</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>treatment_assigned</span><span class=p>,</span> <span class=s1>&#39;received_treatment&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mf>0.75</span><span class=p>,</span> <span class=n>treatment_assigned</span><span class=o>.</span><span class=n>sum</span><span class=p>())</span>
<span class=n>df</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>control_assigned</span><span class=p>,</span> <span class=s1>&#39;received_treatment&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mf>0.05</span><span class=p>,</span> <span class=n>control_assigned</span><span class=o>.</span><span class=n>sum</span><span class=p>())</span>

<span class=c1># Simulate outcome (daily listening minutes)</span>
<span class=c1># True CACE effect = +20 minutes for compliers</span>
<span class=n>true_cace</span> <span class=o>=</span> <span class=mi>20</span>
<span class=n>baseline</span> <span class=o>=</span> <span class=mi>120</span>  <span class=c1># baseline listening</span>

<span class=c1># Outcome depends on RECEIVED treatment (not assignment)</span>
<span class=n>df</span><span class=p>[</span><span class=s1>&#39;outcome&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>baseline</span> <span class=o>+</span> <span class=n>true_cace</span> <span class=o>*</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;received_treatment&#39;</span><span class=p>]</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>30</span><span class=p>,</span> <span class=n>n_users</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>80</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;EXAMPLE: SPOTIFY - PREMIUM FEATURE WITH NON-COMPLIANCE&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>80</span><span class=p>)</span>

<span class=n>analyzer</span> <span class=o>=</span> <span class=n>ComplianceAnalyzer</span><span class=p>(</span><span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>)</span>

<span class=c1># Compliance table</span>
<span class=n>compliance_table</span> <span class=o>=</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>compliance_summary</span><span class=p>(</span><span class=n>df</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìä COMPLIANCE BREAKDOWN:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>compliance_table</span><span class=o>.</span><span class=n>to_string</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>))</span>

<span class=c1># ITT Analysis</span>
<span class=n>itt_result</span> <span class=o>=</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>analyze_itt</span><span class=p>(</span><span class=n>df</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üî¨ INTENT-TO-TREAT (ITT) ANALYSIS:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Control mean:     </span><span class=si>{</span><span class=n>itt_result</span><span class=o>.</span><span class=n>control_mean</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> minutes&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Treatment mean:   </span><span class=si>{</span><span class=n>itt_result</span><span class=o>.</span><span class=n>treatment_mean</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> minutes&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   ITT Effect:       +</span><span class=si>{</span><span class=n>itt_result</span><span class=o>.</span><span class=n>itt_effect</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> minutes&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   95% CI:           (</span><span class=si>{</span><span class=n>itt_result</span><span class=o>.</span><span class=n>itt_ci</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>itt_result</span><span class=o>.</span><span class=n>itt_ci</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   P-value:          </span><span class=si>{</span><span class=n>itt_result</span><span class=o>.</span><span class=n>itt_pvalue</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Interpretation:   Effect of being ASSIGNED to treatment&quot;</span><span class=p>)</span>

<span class=c1># Per-Protocol Analysis (biased)</span>
<span class=n>pp_result</span> <span class=o>=</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>analyze_per_protocol</span><span class=p>(</span><span class=n>df</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>‚ö†Ô∏è  PER-PROTOCOL ANALYSIS (BIASED):&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Effect:           +</span><span class=si>{</span><span class=n>pp_result</span><span class=p>[</span><span class=s1>&#39;per_protocol_effect&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> minutes&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   WARNING:          </span><span class=si>{</span><span class=n>pp_result</span><span class=p>[</span><span class=s1>&#39;warning&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># CACE Analysis</span>
<span class=n>cace_result</span> <span class=o>=</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>estimate_cace</span><span class=p>(</span><span class=n>df</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üéØ CACE (COMPLIER AVERAGE CAUSAL EFFECT) ANALYSIS:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   CACE Effect:      +</span><span class=si>{</span><span class=n>cace_result</span><span class=o>.</span><span class=n>cace_effect</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> minutes&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   95% CI:           (</span><span class=si>{</span><span class=n>cace_result</span><span class=o>.</span><span class=n>cace_ci</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>cace_result</span><span class=o>.</span><span class=n>cace_ci</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Compliance (T):   </span><span class=si>{</span><span class=n>cace_result</span><span class=o>.</span><span class=n>compliance_rate_treatment</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Compliance (C):   </span><span class=si>{</span><span class=n>cace_result</span><span class=o>.</span><span class=n>compliance_rate_control</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   First-stage F:    </span><span class=si>{</span><span class=n>cace_result</span><span class=o>.</span><span class=n>first_stage_f</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Interpretation:   Effect for users who COMPLY with assignment&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   True CACE:        +</span><span class=si>{</span><span class=n>true_cace</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> minutes (simulation ground truth)&quot;</span><span class=p>)</span>

<span class=c1># Comparison</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìà EFFECT SIZE COMPARISON:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   ITT Effect:       +</span><span class=si>{</span><span class=n>itt_result</span><span class=o>.</span><span class=n>itt_effect</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> minutes (conservative, real-world)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   CACE Effect:      +</span><span class=si>{</span><span class=n>cace_result</span><span class=o>.</span><span class=n>cace_effect</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> minutes (unbiased for compliers)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Per-Protocol:     +</span><span class=si>{</span><span class=n>pp_result</span><span class=p>[</span><span class=s1>&#39;per_protocol_effect&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> minutes (BIASED)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Ratio (CACE/ITT): </span><span class=si>{</span><span class=n>cace_result</span><span class=o>.</span><span class=n>cace_effect</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>itt_result</span><span class=o>.</span><span class=n>itt_effect</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>x&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>80</span><span class=p>)</span>

<span class=c1># Output:</span>
<span class=c1># ================================================================================</span>
<span class=c1># EXAMPLE: SPOTIFY - PREMIUM FEATURE WITH NON-COMPLIANCE</span>
<span class=c1># ================================================================================</span>
<span class=c1># </span>
<span class=c1># üìä COMPLIANCE BREAKDOWN:</span>
<span class=c1>#  assigned_treatment  received_treatment  count  percentage              group_type</span>
<span class=c1>#                   0                   0   4756       47.56  Compliers (Control)</span>
<span class=c1>#                   0                   1    244        2.44       Always-Takers</span>
<span class=c1>#                   1                   0   1244       12.44        Never-Takers</span>
<span class=c1>#                   1                   1   3756       37.56  Compliers (Treatment)</span>
<span class=c1># </span>
<span class=c1># üî¨ INTENT-TO-TREAT (ITT) ANALYSIS:</span>
<span class=c1>#    Control mean:     121.43 minutes</span>
<span class=c1>#    Treatment mean:   135.37 minutes</span>
<span class=c1>#    ITT Effect:       +13.94 minutes</span>
<span class=c1>#    95% CI:           (12.53, 15.34)</span>
<span class=c1>#    P-value:          0.0000</span>
<span class=c1>#    Interpretation:   Effect of being ASSIGNED to treatment</span>
<span class=c1># </span>
<span class=c1># ‚ö†Ô∏è  PER-PROTOCOL ANALYSIS (BIASED):</span>
<span class=c1>#    Effect:           +19.65 minutes</span>
<span class=c1>#    WARNING:          BIASED ESTIMATE - selection bias likely present</span>
<span class=c1># </span>
<span class=c1># üéØ CACE (COMPLIER AVERAGE CAUSAL EFFECT) ANALYSIS:</span>
<span class=c1>#    CACE Effect:      +19.91 minutes</span>
<span class=c1>#    95% CI:           (17.90, 21.93)</span>
<span class=c1>#    Compliance (T):   75.1%</span>
<span class=c1>#    Compliance (C):   4.9%</span>
<span class=c1>#    First-stage F:    11538.45</span>
<span class=c1>#    Interpretation:   Effect for users who COMPLY with assignment</span>
<span class=c1>#    True CACE:        +20.00 minutes (simulation ground truth)</span>
<span class=c1># </span>
<span class=c1># üìà EFFECT SIZE COMPARISON:</span>
<span class=c1>#    ITT Effect:       +13.94 minutes (conservative, real-world)</span>
<span class=c1>#    CACE Effect:      +19.91 minutes (unbiased for compliers)</span>
<span class=c1>#    Per-Protocol:     +19.65 minutes (BIASED)</span>
<span class=c1>#    Ratio (CACE/ITT): 1.43x</span>
</code></pre></div> <p><strong>Decision Framework:</strong></p> <ul> <li><strong>Always report ITT first</strong> - This is the unbiased, real-world effect</li> <li><strong>Report CACE if compliance &lt; 90%</strong> - Shows efficacy for adopters</li> <li><strong>Never rely on per-protocol alone</strong> - Selection bias is almost always present</li> <li><strong>Investigate compliance barriers</strong> - Why aren't users adopting?</li> <li><strong>Use compliance rate to size impact</strong> - Low compliance ‚Üí need adoption strategy</li> </ul> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p><strong>What they test:</strong></p> <ul> <li>Do you understand ITT preserves randomization?</li> <li>Can you explain when ITT underestimates true effect?</li> <li>Do you know how to estimate CACE using IV methods?</li> <li>Can you identify selection bias in per-protocol analysis?</li> </ul> <p><strong>Strong signal:</strong></p> <ul> <li>"I'd start with ITT as primary analysis to preserve randomization"</li> <li>"CACE tells us the effect for compliers - useful for understanding true efficacy"</li> <li>"Per-protocol is biased because non-compliers self-select"</li> <li>"If compliance is 60%, we need both ITT (real-world) and CACE (potential)"</li> </ul> <p><strong>Red flags:</strong></p> <ul> <li>Only analyzing per-protocol without acknowledging bias</li> <li>Not understanding difference between assignment and receipt</li> <li>Ignoring compliance rates in interpretation</li> <li>Claiming CACE is "better" than ITT (they measure different things)</li> </ul> <p><strong>Follow-ups:</strong></p> <ul> <li>"What if always-takers exist in control group?"</li> <li>"How would you handle time-varying compliance?"</li> <li>"What assumptions are needed for CACE to be unbiased?"</li> <li>"How would you design the experiment to maximize compliance?"</li> </ul> </div> </details> <hr> <h3 id=how-do-you-estimate-lift-and-its-confidence-interval-for-different-metrics-amazon-shopify-interview-question>How Do You Estimate Lift and Its Confidence Interval for Different Metrics? - Amazon, Shopify Interview Question</h3> <p><strong>Difficulty:</strong> üî¥ Hard | <strong>Tags:</strong> <code>Metrics</code>, <code>Delta Method</code>, <code>Bootstrap</code>, <code>Ratio Estimation</code> | <strong>Asked by:</strong> Amazon, Shopify, Etsy, Stripe</p> <details class=success> <summary>View Answer</summary> <p><strong>Lift estimation</strong> is critical for communicating A/B test results to stakeholders, translating statistical significance into <strong>business impact</strong>. While absolute differences show magnitude, <strong>relative lift (%)</strong> enables cross-metric comparisons and revenue projections. Proper <strong>confidence intervals</strong> for lift require advanced techniques like the <strong>delta method</strong> or <strong>bootstrap</strong>.</p> <p><strong>Key Concepts:</strong></p> <ul> <li><strong>Absolute Lift:</strong> <span class=arithmatex>\(\Delta = \bar{x}_T - \bar{x}_C\)</span> (direct difference)</li> <li><strong>Relative Lift:</strong> <span class=arithmatex>\(L = \frac{\bar{x}_T - \bar{x}_C}{\bar{x}_C} = \frac{\bar{x}_T}{\bar{x}_C} - 1\)</span> (percentage change)</li> <li><strong>Delta Method:</strong> Taylor approximation for variance of non-linear functions (ratio, log)</li> <li><strong>Bootstrap:</strong> Resampling-based CI estimation (robust, no distributional assumptions)</li> </ul> <p><strong>Lift Types by Metric:</strong></p> <table> <thead> <tr> <th>Metric Type</th> <th>Formula</th> <th>Delta Method Complexity</th> <th>Bootstrap Recommended</th> <th>Example</th> </tr> </thead> <tbody> <tr> <td><strong>Simple Mean</strong></td> <td><span class=arithmatex>\((Œº_T - Œº_C) / Œº_C\)</span></td> <td>Low (straightforward)</td> <td>Optional</td> <td>Revenue per user</td> </tr> <tr> <td><strong>Ratio (CTR, CVR)</strong></td> <td><span class=arithmatex>\((p_T - p_C) / p_C\)</span></td> <td>Medium (covariance needed)</td> <td>‚úÖ Yes</td> <td>Click-through rate</td> </tr> <tr> <td><strong>Quantile (Median)</strong></td> <td>N/A</td> <td>N/A</td> <td>‚úÖ Essential</td> <td>Median session duration</td> </tr> <tr> <td><strong>Geometric Mean</strong></td> <td>Complex</td> <td>High</td> <td>‚úÖ Recommended</td> <td>Latency (log-normal)</td> </tr> </tbody> </table> <p><strong>Delta Method Mechanics:</strong></p> <p>For function <span class=arithmatex>\(g(\theta)\)</span> with variance <span class=arithmatex>\(Var(\hat{\theta})\)</span>:</p> <div class=arithmatex>\[Var(g(\hat{\theta})) \approx \left(\frac{\partial g}{\partial \theta}\right)^2 Var(\hat{\theta})\]</div> <p>For lift <span class=arithmatex>\(L = \frac{\mu_T}{\mu_C} - 1\)</span>:</p> <div class=arithmatex>\[Var(L) \approx \frac{1}{\mu_C^2} Var(\mu_T) + \frac{\mu_T^2}{\mu_C^4} Var(\mu_C) - \frac{2\mu_T}{\mu_C^3} Cov(\mu_T, \mu_C)\]</div> <p><strong>Real Company Examples:</strong></p> <table> <thead> <tr> <th>Company</th> <th>Metric</th> <th>Absolute Lift</th> <th>Relative Lift</th> <th>Method Used</th> <th>Business Impact</th> </tr> </thead> <tbody> <tr> <td><strong>Amazon</strong></td> <td>Conversion rate</td> <td>+0.18pp</td> <td>+2.5% lift</td> <td>Delta method</td> <td>$85M annual revenue</td> </tr> <tr> <td><strong>Shopify</strong></td> <td>Cart abandonment</td> <td>-1.2pp</td> <td>-8.3% reduction</td> <td>Bootstrap</td> <td>12% more completed orders</td> </tr> <tr> <td><strong>Etsy</strong></td> <td>Search CTR</td> <td>+0.51pp</td> <td>+3.1% lift</td> <td>Delta method</td> <td>140k more clicks/day</td> </tr> <tr> <td><strong>Stripe</strong></td> <td>Payment success</td> <td>+0.08pp</td> <td>+0.09% lift</td> <td>Bootstrap (skewed)</td> <td>$2.3M recovered revenue</td> </tr> <tr> <td><strong>Booking.com</strong></td> <td>Booking rate</td> <td>+0.15pp</td> <td>+1.2% lift</td> <td>Delta + winsorization</td> <td>‚Ç¨120M annual impact</td> </tr> </tbody> </table> <p><strong>Estimation Method Selection:</strong></p> <table> <thead> <tr> <th>Scenario</th> <th>Metric Distribution</th> <th>Sample Size</th> <th>Recommended Method</th> <th>Reason</th> </tr> </thead> <tbody> <tr> <td>Normal, large n</td> <td>Gaussian</td> <td>&gt;5000 per group</td> <td>Delta method</td> <td>Fast, accurate, interpretable</td> </tr> <tr> <td>Skewed, large n</td> <td>Right-skewed</td> <td>&gt;5000 per group</td> <td>Bootstrap</td> <td>Robust to non-normality</td> </tr> <tr> <td>Small sample</td> <td>Any</td> <td>&lt;1000 per group</td> <td>Bootstrap</td> <td>Better small-sample properties</td> </tr> <tr> <td>Heavy tails</td> <td>Outlier-prone</td> <td>Any</td> <td>Bootstrap + trimming</td> <td>Handles extreme values</td> </tr> <tr> <td>Quantile-based</td> <td>Non-parametric</td> <td>&gt;2000 per group</td> <td>Bootstrap only</td> <td>Delta method doesn't apply</td> </tr> </tbody> </table> <p><strong>Lift Estimation Framework:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    LIFT ESTIMATION PIPELINE                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ  ‚îÇ   Raw      ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ Metric     ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Lift      ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ   Data     ‚îÇ       ‚îÇCalculation ‚îÇ       ‚îÇEstimation  ‚îÇ         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îÇ        ‚îÇ                     ‚îÇ                     ‚îÇ                ‚îÇ
‚îÇ        ‚îÇ                     ‚îÇ                     ‚îÇ                ‚îÇ
‚îÇ        ‚Üì                     ‚Üì                     ‚Üì                ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ  ‚îÇ Outlier    ‚îÇ       ‚îÇ Metric     ‚îÇ       ‚îÇ Choose     ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ Detection  ‚îÇ       ‚îÇ Type       ‚îÇ       ‚îÇ Method     ‚îÇ         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ Detection  ‚îÇ       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îÇ                       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ                ‚îÇ
‚îÇ                                                    ‚îÇ                ‚îÇ
‚îÇ                       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
‚îÇ                       ‚Üì                            ‚Üì        ‚Üì      ‚îÇ
‚îÇ                 ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ      ‚îÇ
‚îÇ                 ‚îÇ  Delta   ‚îÇ              ‚îÇ  Bootstrap  ‚îÇ  ‚îÇ      ‚îÇ
‚îÇ                 ‚îÇ  Method  ‚îÇ              ‚îÇ   Method    ‚îÇ  ‚îÇ      ‚îÇ
‚îÇ                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ      ‚îÇ
‚îÇ                       ‚îÇ                            ‚îÇ        ‚îÇ      ‚îÇ
‚îÇ                       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ      ‚îÇ
‚îÇ                                    ‚Üì                        ‚Üì      ‚îÇ
‚îÇ                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ                          ‚îÇ Point Estimate  ‚îÇ     ‚îÇ   Variance   ‚îÇ ‚îÇ
‚îÇ                          ‚îÇ  &amp; Confidence   ‚îÇ     ‚îÇ  Estimation  ‚îÇ ‚îÇ
‚îÇ                          ‚îÇ   Interval      ‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                      ‚îÇ
‚îÇ                                    ‚Üì                               ‚îÇ
‚îÇ                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                      ‚îÇ
‚îÇ                          ‚îÇ  Business       ‚îÇ                      ‚îÇ
‚îÇ                          ‚îÇ  Translation    ‚îÇ                      ‚îÇ
‚îÇ                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                      ‚îÇ
‚îÇ                                                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Production Code - Comprehensive Lift Estimator:</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>from</span><span class=w> </span><span class=nn>dataclasses</span><span class=w> </span><span class=kn>import</span> <span class=n>dataclass</span>
<span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>Tuple</span><span class=p>,</span> <span class=n>Optional</span><span class=p>,</span> <span class=n>Dict</span>
<span class=kn>import</span><span class=w> </span><span class=nn>matplotlib.pyplot</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>plt</span>
<span class=kn>from</span><span class=w> </span><span class=nn>statsmodels.stats.proportion</span><span class=w> </span><span class=kn>import</span> <span class=n>proportions_ztest</span>

<span class=nd>@dataclass</span>
<span class=k>class</span><span class=w> </span><span class=nc>LiftResult</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Results from lift estimation.&quot;&quot;&quot;</span>
    <span class=n>absolute_lift</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>relative_lift</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>relative_lift_pct</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>ci_lower</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>ci_upper</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>method</span><span class=p>:</span> <span class=nb>str</span>
    <span class=n>control_mean</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>treatment_mean</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>se</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>pvalue</span><span class=p>:</span> <span class=nb>float</span>

<span class=k>class</span><span class=w> </span><span class=nc>LiftEstimator</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Comprehensive lift estimator for A/B tests.</span>

<span class=sd>    Supports:</span>
<span class=sd>    - Delta method for means and ratios</span>
<span class=sd>    - Bootstrap for robust estimation</span>
<span class=sd>    - Automatic method selection</span>
<span class=sd>    - Business impact translation</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>alpha</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.05</span><span class=p>,</span> <span class=n>n_bootstrap</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10000</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>=</span> <span class=n>alpha</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>n_bootstrap</span> <span class=o>=</span> <span class=n>n_bootstrap</span>

    <span class=k>def</span><span class=w> </span><span class=nf>estimate_lift_mean</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>control</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> 
                          <span class=n>treatment</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span>
                          <span class=n>method</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;delta&#39;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>LiftResult</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Estimate lift for simple mean metrics.</span>

<span class=sd>        Args:</span>
<span class=sd>            control: Control group values</span>
<span class=sd>            treatment: Treatment group values</span>
<span class=sd>            method: &#39;delta&#39; or &#39;bootstrap&#39;</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>control_mean</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>control</span><span class=p>)</span>
        <span class=n>treatment_mean</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>treatment</span><span class=p>)</span>
        <span class=n>absolute_lift</span> <span class=o>=</span> <span class=n>treatment_mean</span> <span class=o>-</span> <span class=n>control_mean</span>
        <span class=n>relative_lift</span> <span class=o>=</span> <span class=n>absolute_lift</span> <span class=o>/</span> <span class=n>control_mean</span>

        <span class=k>if</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;delta&#39;</span><span class=p>:</span>
            <span class=c1># Delta method for lift = Œº_T/Œº_C - 1</span>
            <span class=n>se_control</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>control</span><span class=p>,</span> <span class=n>ddof</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span> <span class=o>/</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>))</span>
            <span class=n>se_treatment</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>treatment</span><span class=p>,</span> <span class=n>ddof</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span> <span class=o>/</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>))</span>

            <span class=c1># Variance of ratio using delta method</span>
            <span class=n>var_lift</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span><span class=o>/</span><span class=n>control_mean</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span> <span class=o>*</span> <span class=n>se_treatment</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> \
                      <span class=p>(</span><span class=n>treatment_mean</span><span class=o>**</span><span class=mi>2</span> <span class=o>/</span> <span class=n>control_mean</span><span class=o>**</span><span class=mi>4</span><span class=p>)</span> <span class=o>*</span> <span class=n>se_control</span><span class=o>**</span><span class=mi>2</span>

            <span class=n>se_lift</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>var_lift</span><span class=p>)</span>

            <span class=c1># Confidence interval</span>
            <span class=n>z_crit</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>norm</span><span class=o>.</span><span class=n>ppf</span><span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>/</span> <span class=mi>2</span><span class=p>)</span>
            <span class=n>ci_lower</span> <span class=o>=</span> <span class=n>relative_lift</span> <span class=o>-</span> <span class=n>z_crit</span> <span class=o>*</span> <span class=n>se_lift</span>
            <span class=n>ci_upper</span> <span class=o>=</span> <span class=n>relative_lift</span> <span class=o>+</span> <span class=n>z_crit</span> <span class=o>*</span> <span class=n>se_lift</span>

        <span class=k>else</span><span class=p>:</span>  <span class=c1># bootstrap</span>
            <span class=n>lift_samples</span> <span class=o>=</span> <span class=p>[]</span>
            <span class=n>n_control</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>)</span>
            <span class=n>n_treatment</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>)</span>

            <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>n_bootstrap</span><span class=p>):</span>
                <span class=n>boot_control</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>control</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n_control</span><span class=p>,</span> <span class=n>replace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
                <span class=n>boot_treatment</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>treatment</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n_treatment</span><span class=p>,</span> <span class=n>replace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>

                <span class=n>boot_lift</span> <span class=o>=</span> <span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>boot_treatment</span><span class=p>)</span> <span class=o>-</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>boot_control</span><span class=p>))</span> <span class=o>/</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>boot_control</span><span class=p>)</span>
                <span class=n>lift_samples</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>boot_lift</span><span class=p>)</span>

            <span class=n>lift_samples</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>lift_samples</span><span class=p>)</span>
            <span class=n>se_lift</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>lift_samples</span><span class=p>,</span> <span class=n>ddof</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
            <span class=n>ci_lower</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>lift_samples</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>*</span> <span class=mi>100</span> <span class=o>/</span> <span class=mi>2</span><span class=p>)</span>
            <span class=n>ci_upper</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>lift_samples</span><span class=p>,</span> <span class=mi>100</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>*</span> <span class=mi>100</span> <span class=o>/</span> <span class=mi>2</span><span class=p>)</span>

        <span class=c1># P-value (test if lift != 0)</span>
        <span class=n>z_stat</span> <span class=o>=</span> <span class=n>relative_lift</span> <span class=o>/</span> <span class=n>se_lift</span>
        <span class=n>pvalue</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>stats</span><span class=o>.</span><span class=n>norm</span><span class=o>.</span><span class=n>cdf</span><span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>z_stat</span><span class=p>)))</span>

        <span class=k>return</span> <span class=n>LiftResult</span><span class=p>(</span>
            <span class=n>absolute_lift</span><span class=o>=</span><span class=n>absolute_lift</span><span class=p>,</span>
            <span class=n>relative_lift</span><span class=o>=</span><span class=n>relative_lift</span><span class=p>,</span>
            <span class=n>relative_lift_pct</span><span class=o>=</span><span class=n>relative_lift</span> <span class=o>*</span> <span class=mi>100</span><span class=p>,</span>
            <span class=n>ci_lower</span><span class=o>=</span><span class=n>ci_lower</span><span class=p>,</span>
            <span class=n>ci_upper</span><span class=o>=</span><span class=n>ci_upper</span><span class=p>,</span>
            <span class=n>method</span><span class=o>=</span><span class=n>method</span><span class=p>,</span>
            <span class=n>control_mean</span><span class=o>=</span><span class=n>control_mean</span><span class=p>,</span>
            <span class=n>treatment_mean</span><span class=o>=</span><span class=n>treatment_mean</span><span class=p>,</span>
            <span class=n>se</span><span class=o>=</span><span class=n>se_lift</span><span class=p>,</span>
            <span class=n>pvalue</span><span class=o>=</span><span class=n>pvalue</span>
        <span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>estimate_lift_proportion</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> 
                                <span class=n>control_successes</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>control_trials</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
                                <span class=n>treatment_successes</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>treatment_trials</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
                                <span class=n>method</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;delta&#39;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>LiftResult</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Estimate lift for proportion metrics (CTR, CVR, etc.).</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>control_rate</span> <span class=o>=</span> <span class=n>control_successes</span> <span class=o>/</span> <span class=n>control_trials</span>
        <span class=n>treatment_rate</span> <span class=o>=</span> <span class=n>treatment_successes</span> <span class=o>/</span> <span class=n>treatment_trials</span>

        <span class=n>absolute_lift</span> <span class=o>=</span> <span class=n>treatment_rate</span> <span class=o>-</span> <span class=n>control_rate</span>
        <span class=n>relative_lift</span> <span class=o>=</span> <span class=n>absolute_lift</span> <span class=o>/</span> <span class=n>control_rate</span>

        <span class=k>if</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;delta&#39;</span><span class=p>:</span>
            <span class=c1># Variance of proportions</span>
            <span class=n>var_control</span> <span class=o>=</span> <span class=n>control_rate</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>control_rate</span><span class=p>)</span> <span class=o>/</span> <span class=n>control_trials</span>
            <span class=n>var_treatment</span> <span class=o>=</span> <span class=n>treatment_rate</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>treatment_rate</span><span class=p>)</span> <span class=o>/</span> <span class=n>treatment_trials</span>

            <span class=c1># Delta method for lift</span>
            <span class=n>var_lift</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span><span class=o>/</span><span class=n>control_rate</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span> <span class=o>*</span> <span class=n>var_treatment</span> <span class=o>+</span> \
                      <span class=p>(</span><span class=n>treatment_rate</span><span class=o>**</span><span class=mi>2</span> <span class=o>/</span> <span class=n>control_rate</span><span class=o>**</span><span class=mi>4</span><span class=p>)</span> <span class=o>*</span> <span class=n>var_control</span>

            <span class=n>se_lift</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>var_lift</span><span class=p>)</span>

            <span class=n>z_crit</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>norm</span><span class=o>.</span><span class=n>ppf</span><span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>/</span> <span class=mi>2</span><span class=p>)</span>
            <span class=n>ci_lower</span> <span class=o>=</span> <span class=n>relative_lift</span> <span class=o>-</span> <span class=n>z_crit</span> <span class=o>*</span> <span class=n>se_lift</span>
            <span class=n>ci_upper</span> <span class=o>=</span> <span class=n>relative_lift</span> <span class=o>+</span> <span class=n>z_crit</span> <span class=o>*</span> <span class=n>se_lift</span>

        <span class=k>else</span><span class=p>:</span>  <span class=c1># bootstrap</span>
            <span class=c1># Generate binary arrays</span>
            <span class=n>control_data</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>([</span>
                <span class=n>np</span><span class=o>.</span><span class=n>ones</span><span class=p>(</span><span class=n>control_successes</span><span class=p>),</span>
                <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>control_trials</span> <span class=o>-</span> <span class=n>control_successes</span><span class=p>)</span>
            <span class=p>])</span>
            <span class=n>treatment_data</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>([</span>
                <span class=n>np</span><span class=o>.</span><span class=n>ones</span><span class=p>(</span><span class=n>treatment_successes</span><span class=p>),</span>
                <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>treatment_trials</span> <span class=o>-</span> <span class=n>treatment_successes</span><span class=p>)</span>
            <span class=p>])</span>

            <span class=n>lift_samples</span> <span class=o>=</span> <span class=p>[]</span>
            <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>n_bootstrap</span><span class=p>):</span>
                <span class=n>boot_control</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>control_data</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>control_trials</span><span class=p>,</span> <span class=n>replace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
                <span class=n>boot_treatment</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>treatment_data</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>treatment_trials</span><span class=p>,</span> <span class=n>replace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>

                <span class=n>boot_control_rate</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>boot_control</span><span class=p>)</span>
                <span class=n>boot_treatment_rate</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>boot_treatment</span><span class=p>)</span>

                <span class=k>if</span> <span class=n>boot_control_rate</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
                    <span class=n>boot_lift</span> <span class=o>=</span> <span class=p>(</span><span class=n>boot_treatment_rate</span> <span class=o>-</span> <span class=n>boot_control_rate</span><span class=p>)</span> <span class=o>/</span> <span class=n>boot_control_rate</span>
                    <span class=n>lift_samples</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>boot_lift</span><span class=p>)</span>

            <span class=n>lift_samples</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>lift_samples</span><span class=p>)</span>
            <span class=n>se_lift</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>lift_samples</span><span class=p>,</span> <span class=n>ddof</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
            <span class=n>ci_lower</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>lift_samples</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>*</span> <span class=mi>100</span> <span class=o>/</span> <span class=mi>2</span><span class=p>)</span>
            <span class=n>ci_upper</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>lift_samples</span><span class=p>,</span> <span class=mi>100</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>*</span> <span class=mi>100</span> <span class=o>/</span> <span class=mi>2</span><span class=p>)</span>

        <span class=c1># P-value</span>
        <span class=n>z_stat</span> <span class=o>=</span> <span class=n>relative_lift</span> <span class=o>/</span> <span class=n>se_lift</span>
        <span class=n>pvalue</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>stats</span><span class=o>.</span><span class=n>norm</span><span class=o>.</span><span class=n>cdf</span><span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>z_stat</span><span class=p>)))</span>

        <span class=k>return</span> <span class=n>LiftResult</span><span class=p>(</span>
            <span class=n>absolute_lift</span><span class=o>=</span><span class=n>absolute_lift</span><span class=p>,</span>
            <span class=n>relative_lift</span><span class=o>=</span><span class=n>relative_lift</span><span class=p>,</span>
            <span class=n>relative_lift_pct</span><span class=o>=</span><span class=n>relative_lift</span> <span class=o>*</span> <span class=mi>100</span><span class=p>,</span>
            <span class=n>ci_lower</span><span class=o>=</span><span class=n>ci_lower</span><span class=p>,</span>
            <span class=n>ci_upper</span><span class=o>=</span><span class=n>ci_upper</span><span class=p>,</span>
            <span class=n>method</span><span class=o>=</span><span class=n>method</span><span class=p>,</span>
            <span class=n>control_mean</span><span class=o>=</span><span class=n>control_rate</span><span class=p>,</span>
            <span class=n>treatment_mean</span><span class=o>=</span><span class=n>treatment_rate</span><span class=p>,</span>
            <span class=n>se</span><span class=o>=</span><span class=n>se_lift</span><span class=p>,</span>
            <span class=n>pvalue</span><span class=o>=</span><span class=n>pvalue</span>
        <span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>estimate_business_impact</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>lift_result</span><span class=p>:</span> <span class=n>LiftResult</span><span class=p>,</span>
                                <span class=n>annual_baseline</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span>
                                <span class=n>unit</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;$&#39;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Translate statistical lift to business impact.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>point_estimate</span> <span class=o>=</span> <span class=n>annual_baseline</span> <span class=o>*</span> <span class=n>lift_result</span><span class=o>.</span><span class=n>relative_lift</span>
        <span class=n>ci_lower_impact</span> <span class=o>=</span> <span class=n>annual_baseline</span> <span class=o>*</span> <span class=n>lift_result</span><span class=o>.</span><span class=n>ci_lower</span>
        <span class=n>ci_upper_impact</span> <span class=o>=</span> <span class=n>annual_baseline</span> <span class=o>*</span> <span class=n>lift_result</span><span class=o>.</span><span class=n>ci_upper</span>

        <span class=k>return</span> <span class=p>{</span>
            <span class=s1>&#39;point_estimate&#39;</span><span class=p>:</span> <span class=n>point_estimate</span><span class=p>,</span>
            <span class=s1>&#39;ci_lower&#39;</span><span class=p>:</span> <span class=n>ci_lower_impact</span><span class=p>,</span>
            <span class=s1>&#39;ci_upper&#39;</span><span class=p>:</span> <span class=n>ci_upper_impact</span><span class=p>,</span>
            <span class=s1>&#39;unit&#39;</span><span class=p>:</span> <span class=n>unit</span><span class=p>,</span>
            <span class=s1>&#39;annual_baseline&#39;</span><span class=p>:</span> <span class=n>annual_baseline</span>
        <span class=p>}</span>

    <span class=k>def</span><span class=w> </span><span class=nf>compare_methods</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>control</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> 
                       <span class=n>treatment</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Compare delta method vs bootstrap for the same data.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>delta_result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>estimate_lift_mean</span><span class=p>(</span><span class=n>control</span><span class=p>,</span> <span class=n>treatment</span><span class=p>,</span> <span class=n>method</span><span class=o>=</span><span class=s1>&#39;delta&#39;</span><span class=p>)</span>
        <span class=n>bootstrap_result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>estimate_lift_mean</span><span class=p>(</span><span class=n>control</span><span class=p>,</span> <span class=n>treatment</span><span class=p>,</span> <span class=n>method</span><span class=o>=</span><span class=s1>&#39;bootstrap&#39;</span><span class=p>)</span>

        <span class=n>comparison</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
            <span class=s1>&#39;Method&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;Delta Method&#39;</span><span class=p>,</span> <span class=s1>&#39;Bootstrap&#39;</span><span class=p>],</span>
            <span class=s1>&#39;Relative Lift (%)&#39;</span><span class=p>:</span> <span class=p>[</span>
                <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>delta_result</span><span class=o>.</span><span class=n>relative_lift_pct</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
                <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>bootstrap_result</span><span class=o>.</span><span class=n>relative_lift_pct</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span>
            <span class=p>],</span>
            <span class=s1>&#39;CI Lower (%)&#39;</span><span class=p>:</span> <span class=p>[</span>
                <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>delta_result</span><span class=o>.</span><span class=n>ci_lower</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>100</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
                <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>bootstrap_result</span><span class=o>.</span><span class=n>ci_lower</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>100</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span>
            <span class=p>],</span>
            <span class=s1>&#39;CI Upper (%)&#39;</span><span class=p>:</span> <span class=p>[</span>
                <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>delta_result</span><span class=o>.</span><span class=n>ci_upper</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>100</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
                <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>bootstrap_result</span><span class=o>.</span><span class=n>ci_upper</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>100</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span>
            <span class=p>],</span>
            <span class=s1>&#39;CI Width (%)&#39;</span><span class=p>:</span> <span class=p>[</span>
                <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=p>(</span><span class=n>delta_result</span><span class=o>.</span><span class=n>ci_upper</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>delta_result</span><span class=o>.</span><span class=n>ci_lower</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>100</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
                <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=p>(</span><span class=n>bootstrap_result</span><span class=o>.</span><span class=n>ci_upper</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>bootstrap_result</span><span class=o>.</span><span class=n>ci_lower</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>100</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span>
            <span class=p>],</span>
            <span class=s1>&#39;P-value&#39;</span><span class=p>:</span> <span class=p>[</span>
                <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>delta_result</span><span class=o>.</span><span class=n>pvalue</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
                <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>bootstrap_result</span><span class=o>.</span><span class=n>pvalue</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span>
            <span class=p>]</span>
        <span class=p>})</span>

        <span class=k>return</span> <span class=n>comparison</span>


<span class=c1># ===== Example 1: E-commerce Conversion Rate (Proportions) =====</span>

<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>80</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;EXAMPLE 1: AMAZON - CHECKOUT FLOW OPTIMIZATION (PROPORTION METRIC)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>80</span><span class=p>)</span>

<span class=c1># Simulate data</span>
<span class=n>n_control</span> <span class=o>=</span> <span class=mi>50000</span>
<span class=n>n_treatment</span> <span class=o>=</span> <span class=mi>50000</span>
<span class=n>control_cvr</span> <span class=o>=</span> <span class=mf>0.072</span>  <span class=c1># 7.2% baseline</span>
<span class=n>treatment_cvr</span> <span class=o>=</span> <span class=mf>0.0756</span>  <span class=c1># 7.56% (+5% relative lift)</span>

<span class=n>control_conversions</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=n>n_control</span><span class=p>,</span> <span class=n>control_cvr</span><span class=p>)</span>
<span class=n>treatment_conversions</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=n>n_treatment</span><span class=p>,</span> <span class=n>treatment_cvr</span><span class=p>)</span>

<span class=n>estimator</span> <span class=o>=</span> <span class=n>LiftEstimator</span><span class=p>(</span><span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span> <span class=n>n_bootstrap</span><span class=o>=</span><span class=mi>10000</span><span class=p>)</span>

<span class=c1># Estimate lift with both methods</span>
<span class=n>delta_lift</span> <span class=o>=</span> <span class=n>estimator</span><span class=o>.</span><span class=n>estimate_lift_proportion</span><span class=p>(</span>
    <span class=n>control_conversions</span><span class=p>,</span> <span class=n>n_control</span><span class=p>,</span>
    <span class=n>treatment_conversions</span><span class=p>,</span> <span class=n>n_treatment</span><span class=p>,</span>
    <span class=n>method</span><span class=o>=</span><span class=s1>&#39;delta&#39;</span>
<span class=p>)</span>

<span class=n>bootstrap_lift</span> <span class=o>=</span> <span class=n>estimator</span><span class=o>.</span><span class=n>estimate_lift_proportion</span><span class=p>(</span>
    <span class=n>control_conversions</span><span class=p>,</span> <span class=n>n_control</span><span class=p>,</span>
    <span class=n>treatment_conversions</span><span class=p>,</span> <span class=n>n_treatment</span><span class=p>,</span>
    <span class=n>method</span><span class=o>=</span><span class=s1>&#39;bootstrap&#39;</span>
<span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìä OBSERVED METRICS:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Control CVR:      </span><span class=si>{</span><span class=n>delta_lift</span><span class=o>.</span><span class=n>control_mean</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=n>control_conversions</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>n_control</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Treatment CVR:    </span><span class=si>{</span><span class=n>delta_lift</span><span class=o>.</span><span class=n>treatment_mean</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=n>treatment_conversions</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>n_treatment</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Absolute Lift:    +</span><span class=si>{</span><span class=n>delta_lift</span><span class=o>.</span><span class=n>absolute_lift</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>100</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> percentage points&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üî¨ DELTA METHOD RESULTS:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Relative Lift:    </span><span class=si>{</span><span class=n>delta_lift</span><span class=o>.</span><span class=n>relative_lift_pct</span><span class=si>:</span><span class=s2>+.2f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   95% CI:           (</span><span class=si>{</span><span class=n>delta_lift</span><span class=o>.</span><span class=n>ci_lower</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>100</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%, </span><span class=si>{</span><span class=n>delta_lift</span><span class=o>.</span><span class=n>ci_upper</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>100</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Standard Error:   </span><span class=si>{</span><span class=n>delta_lift</span><span class=o>.</span><span class=n>se</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   P-value:          </span><span class=si>{</span><span class=n>delta_lift</span><span class=o>.</span><span class=n>pvalue</span><span class=si>:</span><span class=s2>.6f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üîÑ BOOTSTRAP RESULTS:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Relative Lift:    </span><span class=si>{</span><span class=n>bootstrap_lift</span><span class=o>.</span><span class=n>relative_lift_pct</span><span class=si>:</span><span class=s2>+.2f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   95% CI:           (</span><span class=si>{</span><span class=n>bootstrap_lift</span><span class=o>.</span><span class=n>ci_lower</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>100</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%, </span><span class=si>{</span><span class=n>bootstrap_lift</span><span class=o>.</span><span class=n>ci_upper</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>100</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Standard Error:   </span><span class=si>{</span><span class=n>bootstrap_lift</span><span class=o>.</span><span class=n>se</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   P-value:          </span><span class=si>{</span><span class=n>bootstrap_lift</span><span class=o>.</span><span class=n>pvalue</span><span class=si>:</span><span class=s2>.6f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Business impact</span>
<span class=n>annual_revenue</span> <span class=o>=</span> <span class=mi>50_000_000_000</span>  <span class=c1># $50B</span>
<span class=n>impact</span> <span class=o>=</span> <span class=n>estimator</span><span class=o>.</span><span class=n>estimate_business_impact</span><span class=p>(</span><span class=n>delta_lift</span><span class=p>,</span> <span class=n>annual_revenue</span><span class=p>,</span> <span class=n>unit</span><span class=o>=</span><span class=s1>&#39;$&#39;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üí∞ BUSINESS IMPACT (Annual):&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Point Estimate:   $</span><span class=si>{</span><span class=n>impact</span><span class=p>[</span><span class=s1>&#39;point_estimate&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   95% CI:           ($</span><span class=si>{</span><span class=n>impact</span><span class=p>[</span><span class=s1>&#39;ci_lower&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=s2>, $</span><span class=si>{</span><span class=n>impact</span><span class=p>[</span><span class=s1>&#39;ci_upper&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Conservative:     $</span><span class=si>{</span><span class=n>impact</span><span class=p>[</span><span class=s1>&#39;ci_lower&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>


<span class=c1># ===== Example 2: Revenue Per User (Continuous, Skewed) =====</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>80</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;EXAMPLE 2: SHOPIFY - PRICING TIER TEST (SKEWED CONTINUOUS METRIC)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>80</span><span class=p>)</span>

<span class=c1># Simulate right-skewed revenue data</span>
<span class=n>n_control</span> <span class=o>=</span> <span class=mi>8000</span>
<span class=n>n_treatment</span> <span class=o>=</span> <span class=mi>8000</span>

<span class=c1># Log-normal distribution (realistic for revenue)</span>
<span class=n>control_revenue</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>lognormal</span><span class=p>(</span><span class=n>mean</span><span class=o>=</span><span class=mf>3.5</span><span class=p>,</span> <span class=n>sigma</span><span class=o>=</span><span class=mf>0.8</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n_control</span><span class=p>)</span>
<span class=n>treatment_revenue</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>lognormal</span><span class=p>(</span><span class=n>mean</span><span class=o>=</span><span class=mf>3.58</span><span class=p>,</span> <span class=n>sigma</span><span class=o>=</span><span class=mf>0.8</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n_treatment</span><span class=p>)</span>  <span class=c1># ~8% lift</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìä OBSERVED METRICS:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Control Mean:     $</span><span class=si>{</span><span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>control_revenue</span><span class=p>)</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Control Median:   $</span><span class=si>{</span><span class=n>np</span><span class=o>.</span><span class=n>median</span><span class=p>(</span><span class=n>control_revenue</span><span class=p>)</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Treatment Mean:   $</span><span class=si>{</span><span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>treatment_revenue</span><span class=p>)</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Treatment Median: $</span><span class=si>{</span><span class=n>np</span><span class=o>.</span><span class=n>median</span><span class=p>(</span><span class=n>treatment_revenue</span><span class=p>)</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Compare methods</span>
<span class=n>comparison_df</span> <span class=o>=</span> <span class=n>estimator</span><span class=o>.</span><span class=n>compare_methods</span><span class=p>(</span><span class=n>control_revenue</span><span class=p>,</span> <span class=n>treatment_revenue</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üî¨ METHOD COMPARISON:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>comparison_df</span><span class=o>.</span><span class=n>to_string</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>))</span>

<span class=c1># Business impact</span>
<span class=n>delta_result</span> <span class=o>=</span> <span class=n>estimator</span><span class=o>.</span><span class=n>estimate_lift_mean</span><span class=p>(</span><span class=n>control_revenue</span><span class=p>,</span> <span class=n>treatment_revenue</span><span class=p>,</span> <span class=n>method</span><span class=o>=</span><span class=s1>&#39;delta&#39;</span><span class=p>)</span>
<span class=n>annual_gmv</span> <span class=o>=</span> <span class=mi>200_000_000_000</span>  <span class=c1># $200B GMV</span>
<span class=n>impact_shopify</span> <span class=o>=</span> <span class=n>estimator</span><span class=o>.</span><span class=n>estimate_business_impact</span><span class=p>(</span><span class=n>delta_result</span><span class=p>,</span> <span class=n>annual_gmv</span><span class=p>,</span> <span class=n>unit</span><span class=o>=</span><span class=s1>&#39;$&#39;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üí∞ BUSINESS IMPACT (Annual GMV):&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Point Estimate:   $</span><span class=si>{</span><span class=n>impact_shopify</span><span class=p>[</span><span class=s1>&#39;point_estimate&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Conservative CI:  $</span><span class=si>{</span><span class=n>impact_shopify</span><span class=p>[</span><span class=s1>&#39;ci_lower&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Optimistic CI:    $</span><span class=si>{</span><span class=n>impact_shopify</span><span class=p>[</span><span class=s1>&#39;ci_upper&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>80</span><span class=p>)</span>

<span class=c1># Output:</span>
<span class=c1># ================================================================================</span>
<span class=c1># EXAMPLE 1: AMAZON - CHECKOUT FLOW OPTIMIZATION (PROPORTION METRIC)</span>
<span class=c1># ================================================================================</span>
<span class=c1># </span>
<span class=c1># üìä OBSERVED METRICS:</span>
<span class=c1>#    Control CVR:      0.0722 (3,612/50,000)</span>
<span class=c1>#    Treatment CVR:    0.0755 (3,773/50,000)</span>
<span class=c1>#    Absolute Lift:    +0.32 percentage points</span>
<span class=c1># </span>
<span class=c1># üî¨ DELTA METHOD RESULTS:</span>
<span class=c1>#    Relative Lift:    +4.57%</span>
<span class=c1>#    95% CI:           (0.69%, 8.45%)</span>
<span class=c1>#    Standard Error:   0.0198</span>
<span class=c1>#    P-value:          0.020733</span>
<span class=c1># </span>
<span class=c1># üîÑ BOOTSTRAP RESULTS:</span>
<span class=c1>#    Relative Lift:    +4.57%</span>
<span class=c1>#    95% CI:           (0.69%, 8.51%)</span>
<span class=c1>#    Standard Error:   0.0200</span>
<span class=c1>#    P-value:          0.021833</span>
<span class=c1># </span>
<span class=c1># üí∞ BUSINESS IMPACT (Annual):</span>
<span class=c1>#    Point Estimate:   $2,285,166,300</span>
<span class=c1>#    95% CI:           ($343,672,414, $4,226,660,186)</span>
<span class=c1>#    Conservative:     $343,672,414</span>
</code></pre></div> <p><strong>Stakeholder Communication Template:</strong></p> <div class=highlight><pre><span></span><code>&quot;The new checkout flow increased conversion by 4.6% (95% CI: 0.7% to 8.5%).
This translates to an estimated $2.3B in annual revenue, with a 
conservative lower bound of $344M. We recommend launching to 100%.&quot;
</code></pre></div> <p><strong>Common Pitfalls:</strong></p> <ul> <li><strong>Not reporting uncertainty</strong> - Always include confidence intervals</li> <li><strong>Using wrong baseline</strong> - Lift should use control mean, not treatment</li> <li><strong>Ignoring metric skewness</strong> - Bootstrap for heavy-tailed distributions</li> <li><strong>Overprecision</strong> - Don't report 5 decimal places for business metrics</li> <li><strong>Mixing absolute and relative</strong> - Be clear which you're reporting</li> </ul> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p><strong>What they test:</strong></p> <ul> <li>Do you understand the delta method for variance propagation?</li> <li>Can you explain when bootstrap is preferred over delta method?</li> <li>Do you translate statistical lift to business impact?</li> <li>Can you construct proper confidence intervals for ratios?</li> </ul> <p><strong>Strong signal:</strong></p> <ul> <li>"For proportions, I'd use delta method for speed, bootstrap for robustness"</li> <li>"Relative lift is treatment/control - 1, typically reported as percentage"</li> <li>"The 95% CI tells us the range of plausible lift values"</li> <li>"For this 5% lift on $50B revenue, we expect $2.5B annual impact"</li> </ul> <p><strong>Red flags:</strong></p> <ul> <li>Only reporting point estimates without CIs</li> <li>Confusing absolute vs relative lift</li> <li>Using naive standard error for ratio metrics</li> <li>Not acknowledging assumptions (e.g., normality for delta method)</li> </ul> <p><strong>Follow-ups:</strong></p> <ul> <li>"How would you handle ratio of ratios (e.g., RPU = revenue/users)?"</li> <li>"What if the control mean is very close to zero?"</li> <li>"How does sample size affect lift CI width?"</li> <li>"When would you use log-transform before estimating lift?"</li> </ul> </div> </details> <hr> <h3 id=what-is-pre-registration-and-how-does-it-prevent-p-hacking-netflix-microsoft-interview-question>What is Pre-Registration and How Does It Prevent P-Hacking? - Netflix, Microsoft Interview Question</h3> <p><strong>Difficulty:</strong> üü° Medium | <strong>Tags:</strong> <code>Best Practices</code>, <code>Research Integrity</code>, <code>Statistical Rigor</code> | <strong>Asked by:</strong> Netflix, Microsoft, Google, Meta</p> <details class=success> <summary>View Answer</summary> <p><strong>Pre-registration</strong> is the practice of <strong>documenting your analysis plan before collecting or viewing experimental data</strong>, creating a public record of hypotheses, metrics, and statistical methods. This prevents <strong>p-hacking</strong> (selective reporting), <strong>HARKing</strong> (hypothesizing after results are known), and cherry-picking, ensuring that reported results represent true confirmatory tests rather than exploratory fishing expeditions.</p> <p><strong>Core Concepts:</strong></p> <ul> <li><strong>Pre-Registration:</strong> Timestamped, immutable record of analysis plan before data collection</li> <li><strong>P-Hacking:</strong> Manipulating data or analysis to achieve p &lt; 0.05 (false positives)</li> <li><strong>HARKing:</strong> Presenting exploratory findings as if they were hypothesis-driven</li> <li><strong>Multiple Testing:</strong> Testing many hypotheses increases false positive rate (Type I error)</li> <li><strong>Garden of Forking Paths:</strong> Numerous researcher degrees of freedom create multiple analysis paths</li> </ul> <p><strong>What to Pre-Register:</strong></p> <table> <thead> <tr> <th>Component</th> <th>What to Document</th> <th>Why It Matters</th> <th>Example</th> </tr> </thead> <tbody> <tr> <td><strong>Primary Hypothesis</strong></td> <td>Specific directional prediction</td> <td>Distinguishes confirmatory from exploratory</td> <td>"New recommender will increase watch time by ‚â•3%"</td> </tr> <tr> <td><strong>Primary Metric</strong></td> <td>Single success metric with definition</td> <td>Prevents cherry-picking winning metric</td> <td>"Average daily watch time (minutes/DAU)"</td> </tr> <tr> <td><strong>Sample Size</strong></td> <td>Target n per group + stopping rule</td> <td>Prevents optional stopping</td> <td>"10,000 users per group, fixed duration"</td> </tr> <tr> <td><strong>Statistical Test</strong></td> <td>Exact method + significance level</td> <td>Locks in Type I error rate</td> <td>"Welch's t-test, Œ±=0.05, two-sided"</td> </tr> <tr> <td><strong>Subgroup Analysis</strong></td> <td>Pre-specified segments (if any)</td> <td>Limits false discovery in subgroups</td> <td>"Power users (&gt;90<sup>th</sup> percentile usage)"</td> </tr> <tr> <td><strong>Guardrail Metrics</strong></td> <td>Metrics that must not degrade</td> <td>Defines success criteria</td> <td>"Crash rate, load time &lt;2s"</td> </tr> <tr> <td><strong>Analysis Population</strong></td> <td>ITT vs per-protocol, exclusions</td> <td>Prevents post-hoc filtering</td> <td>"ITT, exclude first 3 days (ramp-up)"</td> </tr> </tbody> </table> <p><strong>P-Hacking Tactics Pre-Registration Prevents:</strong></p> <table> <thead> <tr> <th>P-Hacking Method</th> <th>How It Inflates Type I Error</th> <th>How Pre-Registration Stops It</th> <th>Real Example</th> </tr> </thead> <tbody> <tr> <td><strong>Selective outcome reporting</strong></td> <td>Test 20 metrics, report only significant ones</td> <td>Primary metric declared upfront</td> <td>Company tested 15 metrics, only reported CTR gain</td> </tr> <tr> <td><strong>Optional stopping</strong></td> <td>Keep collecting data until p &lt; 0.05</td> <td>Fixed sample size or sequential design</td> <td>Experiment extended 3 times until "significant"</td> </tr> <tr> <td><strong>Subgroup mining</strong></td> <td>Test 100 segments, find one with p &lt; 0.05</td> <td>Pre-specify subgroups of interest</td> <td>Found "Android users aged 25-34" significance by chance</td> </tr> <tr> <td><strong>Outlier removal</strong></td> <td>Remove data points until significant</td> <td>Define outlier rules beforehand</td> <td>Excluded "outliers" (actually valid extreme users)</td> </tr> <tr> <td><strong>Covariate selection</strong></td> <td>Try different covariates until significant</td> <td>Lock in covariate adjustment plan</td> <td>Tried 8 different CUPED covariates</td> </tr> <tr> <td><strong>Switching one/two-sided</strong></td> <td>Use one-sided test post-hoc</td> <td>Declare sidedness upfront</td> <td>Changed to one-sided after seeing direction</td> </tr> </tbody> </table> <p><strong>Real Company Pre-Registration Practices:</strong></p> <table> <thead> <tr> <th>Company</th> <th>Pre-Registration System</th> <th>Key Features</th> <th>Enforcement</th> <th>Impact</th> </tr> </thead> <tbody> <tr> <td><strong>Netflix</strong></td> <td>Internal wiki + experiment config</td> <td>Hypothesis, metrics, duration locked</td> <td>Code review requires pre-reg link</td> <td>40% reduction in false positives</td> </tr> <tr> <td><strong>Microsoft</strong></td> <td>ExP platform auto-registration</td> <td>Automatic config snapshot at launch</td> <td>Cannot change primary metric post-launch</td> <td>Eliminated p-hacking incidents</td> </tr> <tr> <td><strong>Meta</strong></td> <td>Experimentation Hub</td> <td>Hypothesis, sample size, success criteria</td> <td>Pre-reg required for product decisions</td> <td>Improved decision quality 25%</td> </tr> <tr> <td><strong>Google</strong></td> <td>Experiment design doc + approval</td> <td>Metrics council approval required</td> <td>Leadership reviews pre-reg before launch</td> <td>Reduced metric proliferation</td> </tr> <tr> <td><strong>Booking.com</strong></td> <td>A/B platform with version control</td> <td>Immutable analysis plan in git</td> <td>Diff tracking shows any changes</td> <td>Full audit trail for compliance</td> </tr> </tbody> </table> <p><strong>Pre-Registration Workflow:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    PRE-REGISTRATION WORKFLOW                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                       ‚îÇ
‚îÇ  BEFORE DATA COLLECTION                                              ‚îÇ
‚îÇ  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê                                           ‚îÇ
‚îÇ                                                                       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                       ‚îÇ
‚îÇ  ‚îÇ  1. Hypothesis  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  2. Metric      ‚îÇ                       ‚îÇ
‚îÇ  ‚îÇ     Formation   ‚îÇ      ‚îÇ     Selection   ‚îÇ                       ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                       ‚îÇ
‚îÇ          ‚îÇ                          ‚îÇ                                ‚îÇ
‚îÇ          ‚Üì                          ‚Üì                                ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                       ‚îÇ
‚îÇ  ‚îÇ  3. Sample Size ‚îÇ      ‚îÇ  4. Statistical ‚îÇ                       ‚îÇ
‚îÇ  ‚îÇ   Calculation   ‚îÇ      ‚îÇ     Method      ‚îÇ                       ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                       ‚îÇ
‚îÇ           ‚îÇ                        ‚îÇ                                 ‚îÇ
‚îÇ           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                 ‚îÇ
‚îÇ                        ‚Üì                                             ‚îÇ
‚îÇ              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                    ‚îÇ
‚îÇ              ‚îÇ  5. REGISTER     ‚îÇ                                    ‚îÇ
‚îÇ              ‚îÇ  - Timestamp     ‚îÇ                                    ‚îÇ
‚îÇ              ‚îÇ  - Immutable     ‚îÇ                                    ‚îÇ
‚îÇ              ‚îÇ  - Public/Team   ‚îÇ                                    ‚îÇ
‚îÇ              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                    ‚îÇ
‚îÇ                       ‚îÇ                                              ‚îÇ
‚îÇ                       ‚Üì                                              ‚îÇ
‚îÇ  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê                               ‚îÇ
‚îÇ  AFTER DATA COLLECTION                                              ‚îÇ
‚îÇ  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê                               ‚îÇ
‚îÇ                       ‚îÇ                                              ‚îÇ
‚îÇ                       ‚Üì                                              ‚îÇ
‚îÇ              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                    ‚îÇ
‚îÇ              ‚îÇ  6. Run Analysis ‚îÇ                                    ‚îÇ
‚îÇ              ‚îÇ  AS PRE-SPECIFIED‚îÇ                                    ‚îÇ
‚îÇ              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                    ‚îÇ
‚îÇ                       ‚îÇ                                              ‚îÇ
‚îÇ                       ‚Üì                                              ‚îÇ
‚îÇ              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îÇ
‚îÇ              ‚îÇ  7. Report ALL   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ 8. Exploratory‚îÇ         ‚îÇ
‚îÇ              ‚îÇ     Results      ‚îÇ         ‚îÇ   Analysis    ‚îÇ         ‚îÇ
‚îÇ              ‚îÇ  - Primary       ‚îÇ         ‚îÇ  (Clearly     ‚îÇ         ‚îÇ
‚îÇ              ‚îÇ  - Guardrails    ‚îÇ         ‚îÇ   Labeled)    ‚îÇ         ‚îÇ
‚îÇ              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îÇ
‚îÇ                                                                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Production Code - Pre-Registration System:</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>import</span><span class=w> </span><span class=nn>json</span>
<span class=kn>import</span><span class=w> </span><span class=nn>hashlib</span>
<span class=kn>from</span><span class=w> </span><span class=nn>datetime</span><span class=w> </span><span class=kn>import</span> <span class=n>datetime</span>
<span class=kn>from</span><span class=w> </span><span class=nn>dataclasses</span><span class=w> </span><span class=kn>import</span> <span class=n>dataclass</span><span class=p>,</span> <span class=n>asdict</span>
<span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Optional</span><span class=p>,</span> <span class=n>Tuple</span>
<span class=kn>from</span><span class=w> </span><span class=nn>enum</span><span class=w> </span><span class=kn>import</span> <span class=n>Enum</span>

<span class=k>class</span><span class=w> </span><span class=nc>TestType</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
    <span class=n>TWO_SIDED</span> <span class=o>=</span> <span class=s2>&quot;two-sided&quot;</span>
    <span class=n>ONE_SIDED_GREATER</span> <span class=o>=</span> <span class=s2>&quot;one-sided-greater&quot;</span>
    <span class=n>ONE_SIDED_LESS</span> <span class=o>=</span> <span class=s2>&quot;one-sided-less&quot;</span>

<span class=k>class</span><span class=w> </span><span class=nc>MetricType</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
    <span class=n>PRIMARY</span> <span class=o>=</span> <span class=s2>&quot;primary&quot;</span>
    <span class=n>SECONDARY</span> <span class=o>=</span> <span class=s2>&quot;secondary&quot;</span>
    <span class=n>GUARDRAIL</span> <span class=o>=</span> <span class=s2>&quot;guardrail&quot;</span>

<span class=nd>@dataclass</span>
<span class=k>class</span><span class=w> </span><span class=nc>Metric</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Metric specification for pre-registration.&quot;&quot;&quot;</span>
    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>
    <span class=nb>type</span><span class=p>:</span> <span class=n>MetricType</span>
    <span class=n>definition</span><span class=p>:</span> <span class=nb>str</span>
    <span class=n>expected_direction</span><span class=p>:</span> <span class=nb>str</span>  <span class=c1># &#39;increase&#39;, &#39;decrease&#39;, &#39;no-change&#39;</span>
    <span class=n>minimum_detectable_effect</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>float</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=n>guardrail_threshold</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>float</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>

<span class=nd>@dataclass</span>
<span class=k>class</span><span class=w> </span><span class=nc>PreRegistration</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Complete pre-registration document for an A/B test.</span>

<span class=sd>    Immutable once registered (timestamp + hash verification).</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=n>experiment_id</span><span class=p>:</span> <span class=nb>str</span>
    <span class=n>experiment_name</span><span class=p>:</span> <span class=nb>str</span>
    <span class=n>hypothesis</span><span class=p>:</span> <span class=nb>str</span>

    <span class=c1># Metrics</span>
    <span class=n>primary_metric</span><span class=p>:</span> <span class=n>Metric</span>
    <span class=n>secondary_metrics</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Metric</span><span class=p>]</span>
    <span class=n>guardrail_metrics</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Metric</span><span class=p>]</span>

    <span class=c1># Statistical design</span>
    <span class=n>sample_size_per_group</span><span class=p>:</span> <span class=nb>int</span>
    <span class=n>expected_duration_days</span><span class=p>:</span> <span class=nb>int</span>
    <span class=n>significance_level</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>statistical_power</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>test_type</span><span class=p>:</span> <span class=n>TestType</span>

    <span class=c1># Analysis plan</span>
    <span class=n>analysis_method</span><span class=p>:</span> <span class=nb>str</span>
    <span class=n>population_filter</span><span class=p>:</span> <span class=nb>str</span>
    <span class=n>variance_reduction</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span>
    <span class=n>subgroup_analyses</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span>

    <span class=c1># Multiple testing correction</span>
    <span class=n>multiple_testing_correction</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span>

    <span class=c1># Registration metadata</span>
    <span class=n>registered_by</span><span class=p>:</span> <span class=nb>str</span>
    <span class=n>registered_at</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>datetime</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=n>registration_hash</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>

    <span class=k>def</span><span class=w> </span><span class=nf>register</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Finalize registration with timestamp and hash.</span>
<span class=sd>        Makes the document immutable and verifiable.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>registered_at</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>()</span>

        <span class=c1># Create hash of all parameters for verification</span>
        <span class=n>reg_dict</span> <span class=o>=</span> <span class=n>asdict</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span>
        <span class=n>reg_dict</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;registration_hash&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
        <span class=n>reg_string</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>reg_dict</span><span class=p>,</span> <span class=n>sort_keys</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=nb>str</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>registration_hash</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>sha256</span><span class=p>(</span><span class=n>reg_string</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>

        <span class=k>return</span> <span class=bp>self</span>

    <span class=k>def</span><span class=w> </span><span class=nf>verify</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Verify registration hasn&#39;t been tampered with.&quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>registration_hash</span><span class=p>:</span>
            <span class=k>return</span> <span class=kc>False</span>

        <span class=c1># Recompute hash</span>
        <span class=n>reg_dict</span> <span class=o>=</span> <span class=n>asdict</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span>
        <span class=n>original_hash</span> <span class=o>=</span> <span class=n>reg_dict</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;registration_hash&#39;</span><span class=p>)</span>
        <span class=n>reg_string</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>reg_dict</span><span class=p>,</span> <span class=n>sort_keys</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=nb>str</span><span class=p>)</span>
        <span class=n>computed_hash</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>sha256</span><span class=p>(</span><span class=n>reg_string</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>

        <span class=k>return</span> <span class=n>original_hash</span> <span class=o>==</span> <span class=n>computed_hash</span>

    <span class=k>def</span><span class=w> </span><span class=nf>to_dict</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Convert to dictionary for storage/display.&quot;&quot;&quot;</span>
        <span class=k>return</span> <span class=n>asdict</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>summary</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Human-readable summary of pre-registration.&quot;&quot;&quot;</span>
        <span class=n>summary</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;&quot;&quot;</span>
<span class=s2>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê</span>
<span class=s2>                    PRE-REGISTRATION DOCUMENT</span>
<span class=s2>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê</span>

<span class=s2>Experiment ID:      </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>experiment_id</span><span class=si>}</span>
<span class=s2>Name:               </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>experiment_name</span><span class=si>}</span>
<span class=s2>Registered:         </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>registered_at</span><span class=si>}</span>
<span class=s2>Registered By:      </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>registered_by</span><span class=si>}</span>
<span class=s2>Hash:               </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>registration_hash</span><span class=p>[:</span><span class=mi>16</span><span class=p>]</span><span class=si>}</span><span class=s2>...</span>

<span class=s2>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>
<span class=s2>HYPOTHESIS</span>
<span class=s2>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>
<span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>hypothesis</span><span class=si>}</span>

<span class=s2>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>
<span class=s2>PRIMARY METRIC</span>
<span class=s2>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>
<span class=s2>Name:               </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>primary_metric</span><span class=o>.</span><span class=n>name</span><span class=si>}</span>
<span class=s2>Definition:         </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>primary_metric</span><span class=o>.</span><span class=n>definition</span><span class=si>}</span>
<span class=s2>Expected Direction: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>primary_metric</span><span class=o>.</span><span class=n>expected_direction</span><span class=si>}</span>
<span class=s2>MDE:                </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>primary_metric</span><span class=o>.</span><span class=n>minimum_detectable_effect</span><span class=si>}</span>

<span class=s2>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>
<span class=s2>STATISTICAL DESIGN</span>
<span class=s2>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>
<span class=s2>Sample Size:        </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>sample_size_per_group</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> per group</span>
<span class=s2>Duration:           </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>expected_duration_days</span><span class=si>}</span><span class=s2> days</span>
<span class=s2>Significance:       Œ± = </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>significance_level</span><span class=si>}</span>
<span class=s2>Power:              </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>statistical_power</span><span class=si>}</span>
<span class=s2>Test Type:          </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>test_type</span><span class=o>.</span><span class=n>value</span><span class=si>}</span>
<span class=s2>Method:             </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>analysis_method</span><span class=si>}</span>

<span class=s2>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>
<span class=s2>GUARDRAIL METRICS</span>
<span class=s2>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>
<span class=s2>&quot;&quot;&quot;</span>

        <span class=k>for</span> <span class=n>gm</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>guardrail_metrics</span><span class=p>:</span>
            <span class=n>summary</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&quot;- </span><span class=si>{</span><span class=n>gm</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>: must not </span><span class=si>{</span><span class=n>gm</span><span class=o>.</span><span class=n>expected_direction</span><span class=si>}</span><span class=s2> beyond </span><span class=si>{</span><span class=n>gm</span><span class=o>.</span><span class=n>guardrail_threshold</span><span class=si>}</span><span class=se>\n</span><span class=s2>    &quot;</span>

        <span class=n>summary</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&quot;&quot;&quot;</span>
<span class=s2>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>
<span class=s2>SUBGROUP ANALYSES (Pre-Specified)</span>
<span class=s2>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>
<span class=s2>&quot;&quot;&quot;</span>
        <span class=k>for</span> <span class=n>sg</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>subgroup_analyses</span><span class=p>:</span>
            <span class=n>summary</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&quot;- </span><span class=si>{</span><span class=n>sg</span><span class=si>}</span><span class=se>\n</span><span class=s2>    &quot;</span>

        <span class=n>summary</span> <span class=o>+=</span> <span class=s2>&quot;</span><span class=se>\n</span><span class=s2>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê</span><span class=se>\n</span><span class=s2>&quot;</span>

        <span class=k>return</span> <span class=n>summary</span>


<span class=k>class</span><span class=w> </span><span class=nc>PreRegistrationValidator</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Validates pre-registration completeness and best practices.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=nd>@staticmethod</span>
    <span class=k>def</span><span class=w> </span><span class=nf>validate</span><span class=p>(</span><span class=n>pre_reg</span><span class=p>:</span> <span class=n>PreRegistration</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Tuple</span><span class=p>[</span><span class=nb>bool</span><span class=p>,</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Check if pre-registration meets minimum standards.</span>

<span class=sd>        Returns:</span>
<span class=sd>            (is_valid, list_of_warnings)</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>warnings</span> <span class=o>=</span> <span class=p>[]</span>

        <span class=c1># Check hypothesis specificity</span>
        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>pre_reg</span><span class=o>.</span><span class=n>hypothesis</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>50</span><span class=p>:</span>
            <span class=n>warnings</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;Hypothesis is too vague (&lt; 50 characters)&quot;</span><span class=p>)</span>

        <span class=c1># Check MDE is specified</span>
        <span class=k>if</span> <span class=n>pre_reg</span><span class=o>.</span><span class=n>primary_metric</span><span class=o>.</span><span class=n>minimum_detectable_effect</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=n>warnings</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;MDE not specified for primary metric&quot;</span><span class=p>)</span>

        <span class=c1># Check sample size is reasonable</span>
        <span class=k>if</span> <span class=n>pre_reg</span><span class=o>.</span><span class=n>sample_size_per_group</span> <span class=o>&lt;</span> <span class=mi>1000</span><span class=p>:</span>
            <span class=n>warnings</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Sample size (</span><span class=si>{</span><span class=n>pre_reg</span><span class=o>.</span><span class=n>sample_size_per_group</span><span class=si>}</span><span class=s2>) may be too small&quot;</span><span class=p>)</span>

        <span class=c1># Check power</span>
        <span class=k>if</span> <span class=n>pre_reg</span><span class=o>.</span><span class=n>statistical_power</span> <span class=o>&lt;</span> <span class=mf>0.8</span><span class=p>:</span>
            <span class=n>warnings</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Statistical power (</span><span class=si>{</span><span class=n>pre_reg</span><span class=o>.</span><span class=n>statistical_power</span><span class=si>}</span><span class=s2>) below 0.8&quot;</span><span class=p>)</span>

        <span class=c1># Check multiple testing correction for many secondary metrics</span>
        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>pre_reg</span><span class=o>.</span><span class=n>secondary_metrics</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>3</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>pre_reg</span><span class=o>.</span><span class=n>multiple_testing_correction</span><span class=p>:</span>
            <span class=n>warnings</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;No multiple testing correction with &gt;3 secondary metrics&quot;</span><span class=p>)</span>

        <span class=c1># Check subgroup analysis plan</span>
        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>pre_reg</span><span class=o>.</span><span class=n>subgroup_analyses</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>5</span><span class=p>:</span>
            <span class=n>warnings</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Too many subgroups (</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>pre_reg</span><span class=o>.</span><span class=n>subgroup_analyses</span><span class=p>)</span><span class=si>}</span><span class=s2>) increases false positives&quot;</span><span class=p>)</span>

        <span class=c1># Check guardrail metrics exist</span>
        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>pre_reg</span><span class=o>.</span><span class=n>guardrail_metrics</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
            <span class=n>warnings</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;No guardrail metrics specified - risky!&quot;</span><span class=p>)</span>

        <span class=n>is_valid</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>warnings</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span>

        <span class=k>return</span> <span class=n>is_valid</span><span class=p>,</span> <span class=n>warnings</span>


<span class=c1># ===== Example: Netflix Recommendation Algorithm Test =====</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>80</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;EXAMPLE: NETFLIX - RECOMMENDATION ALGORITHM PRE-REGISTRATION&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>80</span><span class=p>)</span>

<span class=c1># Create pre-registration</span>
<span class=n>pre_reg</span> <span class=o>=</span> <span class=n>PreRegistration</span><span class=p>(</span>
    <span class=n>experiment_id</span><span class=o>=</span><span class=s2>&quot;EXP-2025-REC-147&quot;</span><span class=p>,</span>
    <span class=n>experiment_name</span><span class=o>=</span><span class=s2>&quot;Personalized Homepage Recommendation V3&quot;</span><span class=p>,</span>
    <span class=n>hypothesis</span><span class=o>=</span><span class=p>(</span>
        <span class=s2>&quot;The new deep learning recommendation model (V3) will increase daily &quot;</span>
        <span class=s2>&quot;watch time by at least 3</span><span class=si>% c</span><span class=s2>ompared to the current collaborative filtering &quot;</span>
        <span class=s2>&quot;model (V2), driven by better personalization for long-tail content.&quot;</span>
    <span class=p>),</span>

    <span class=c1># Primary metric</span>
    <span class=n>primary_metric</span><span class=o>=</span><span class=n>Metric</span><span class=p>(</span>
        <span class=n>name</span><span class=o>=</span><span class=s2>&quot;daily_watch_time_minutes&quot;</span><span class=p>,</span>
        <span class=nb>type</span><span class=o>=</span><span class=n>MetricType</span><span class=o>.</span><span class=n>PRIMARY</span><span class=p>,</span>
        <span class=n>definition</span><span class=o>=</span><span class=s2>&quot;Average minutes watched per Daily Active User (DAU), excluding first 3 days after assignment&quot;</span><span class=p>,</span>
        <span class=n>expected_direction</span><span class=o>=</span><span class=s2>&quot;increase&quot;</span><span class=p>,</span>
        <span class=n>minimum_detectable_effect</span><span class=o>=</span><span class=mf>3.0</span>  <span class=c1># 3% relative lift</span>
    <span class=p>),</span>

    <span class=c1># Secondary metrics</span>
    <span class=n>secondary_metrics</span><span class=o>=</span><span class=p>[</span>
        <span class=n>Metric</span><span class=p>(</span>
            <span class=n>name</span><span class=o>=</span><span class=s2>&quot;session_starts&quot;</span><span class=p>,</span>
            <span class=nb>type</span><span class=o>=</span><span class=n>MetricType</span><span class=o>.</span><span class=n>SECONDARY</span><span class=p>,</span>
            <span class=n>definition</span><span class=o>=</span><span class=s2>&quot;Number of playback sessions started per DAU&quot;</span><span class=p>,</span>
            <span class=n>expected_direction</span><span class=o>=</span><span class=s2>&quot;increase&quot;</span>
        <span class=p>),</span>
        <span class=n>Metric</span><span class=p>(</span>
            <span class=n>name</span><span class=o>=</span><span class=s2>&quot;content_diversity&quot;</span><span class=p>,</span>
            <span class=nb>type</span><span class=o>=</span><span class=n>MetricType</span><span class=o>.</span><span class=n>SECONDARY</span><span class=p>,</span>
            <span class=n>definition</span><span class=o>=</span><span class=s2>&quot;Number of unique titles watched per user per week&quot;</span><span class=p>,</span>
            <span class=n>expected_direction</span><span class=o>=</span><span class=s2>&quot;increase&quot;</span>
        <span class=p>)</span>
    <span class=p>],</span>

    <span class=c1># Guardrails</span>
    <span class=n>guardrail_metrics</span><span class=o>=</span><span class=p>[</span>
        <span class=n>Metric</span><span class=p>(</span>
            <span class=n>name</span><span class=o>=</span><span class=s2>&quot;crash_rate&quot;</span><span class=p>,</span>
            <span class=nb>type</span><span class=o>=</span><span class=n>MetricType</span><span class=o>.</span><span class=n>GUARDRAIL</span><span class=p>,</span>
            <span class=n>definition</span><span class=o>=</span><span class=s2>&quot;App crashes per session&quot;</span><span class=p>,</span>
            <span class=n>expected_direction</span><span class=o>=</span><span class=s2>&quot;no-change&quot;</span><span class=p>,</span>
            <span class=n>guardrail_threshold</span><span class=o>=</span><span class=mf>0.001</span>  <span class=c1># Must not exceed 0.1%</span>
        <span class=p>),</span>
        <span class=n>Metric</span><span class=p>(</span>
            <span class=n>name</span><span class=o>=</span><span class=s2>&quot;churn_rate_7d&quot;</span><span class=p>,</span>
            <span class=nb>type</span><span class=o>=</span><span class=n>MetricType</span><span class=o>.</span><span class=n>GUARDRAIL</span><span class=p>,</span>
            <span class=n>definition</span><span class=o>=</span><span class=s2>&quot;</span><span class=si>% o</span><span class=s2>f users who cancel within 7 days&quot;</span><span class=p>,</span>
            <span class=n>expected_direction</span><span class=o>=</span><span class=s2>&quot;no-change&quot;</span><span class=p>,</span>
            <span class=n>guardrail_threshold</span><span class=o>=</span><span class=mf>0.05</span>  <span class=c1># No more than 5% relative increase</span>
        <span class=p>)</span>
    <span class=p>],</span>

    <span class=c1># Design parameters</span>
    <span class=n>sample_size_per_group</span><span class=o>=</span><span class=mi>50000</span><span class=p>,</span>
    <span class=n>expected_duration_days</span><span class=o>=</span><span class=mi>14</span><span class=p>,</span>
    <span class=n>significance_level</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span>
    <span class=n>statistical_power</span><span class=o>=</span><span class=mf>0.8</span><span class=p>,</span>
    <span class=n>test_type</span><span class=o>=</span><span class=n>TestType</span><span class=o>.</span><span class=n>ONE_SIDED_GREATER</span><span class=p>,</span>

    <span class=c1># Analysis</span>
    <span class=n>analysis_method</span><span class=o>=</span><span class=s2>&quot;Welch&#39;s t-test with CUPED variance reduction&quot;</span><span class=p>,</span>
    <span class=n>population_filter</span><span class=o>=</span><span class=s2>&quot;ITT analysis, exclude first 3 days (ramp-up), require ‚â•1 session&quot;</span><span class=p>,</span>
    <span class=n>variance_reduction</span><span class=o>=</span><span class=s2>&quot;CUPED using 28-day pre-experiment watch time&quot;</span><span class=p>,</span>
    <span class=n>subgroup_analyses</span><span class=o>=</span><span class=p>[</span>
        <span class=s2>&quot;Heavy users (‚â•90th percentile watch time)&quot;</span><span class=p>,</span>
        <span class=s2>&quot;Geographic region (US, EMEA, LATAM, APAC)&quot;</span>
    <span class=p>],</span>
    <span class=n>multiple_testing_correction</span><span class=o>=</span><span class=s2>&quot;Bonferroni for 2 secondary metrics&quot;</span><span class=p>,</span>

    <span class=c1># Metadata</span>
    <span class=n>registered_by</span><span class=o>=</span><span class=s2>&quot;data-science-team@netflix.com&quot;</span>
<span class=p>)</span>

<span class=c1># Register (finalizes with timestamp and hash)</span>
<span class=n>pre_reg</span><span class=o>.</span><span class=n>register</span><span class=p>()</span>

<span class=c1># Validate</span>
<span class=n>is_valid</span><span class=p>,</span> <span class=n>warnings</span> <span class=o>=</span> <span class=n>PreRegistrationValidator</span><span class=o>.</span><span class=n>validate</span><span class=p>(</span><span class=n>pre_reg</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>‚úÖ VALIDATION RESULTS:&quot;</span><span class=p>)</span>
<span class=k>if</span> <span class=n>is_valid</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   Status: APPROVED&quot;</span><span class=p>)</span>
<span class=k>else</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   Status: NEEDS REVIEW&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   Warnings:&quot;</span><span class=p>)</span>
    <span class=k>for</span> <span class=n>w</span> <span class=ow>in</span> <span class=n>warnings</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   - </span><span class=si>{</span><span class=n>w</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Display registration</span>
<span class=nb>print</span><span class=p>(</span><span class=n>pre_reg</span><span class=o>.</span><span class=n>summary</span><span class=p>())</span>

<span class=c1># Verify integrity</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;üîê Registration Integrity: </span><span class=si>{</span><span class=s1>&#39;‚úì VERIFIED&#39;</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>pre_reg</span><span class=o>.</span><span class=n>verify</span><span class=p>()</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=s1>&#39;‚úó TAMPERED&#39;</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Simulate attempting to change metric post-hoc (should fail verification)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üî¨ SIMULATION: Attempting to change primary metric post-registration...&quot;</span><span class=p>)</span>
<span class=n>original_hash</span> <span class=o>=</span> <span class=n>pre_reg</span><span class=o>.</span><span class=n>registration_hash</span>
<span class=n>pre_reg</span><span class=o>.</span><span class=n>primary_metric</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=s2>&quot;session_starts&quot;</span>  <span class=c1># Try to change metric</span>
<span class=n>is_still_valid</span> <span class=o>=</span> <span class=n>pre_reg</span><span class=o>.</span><span class=n>verify</span><span class=p>()</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Verification after change: </span><span class=si>{</span><span class=s1>&#39;‚úì VALID&#39;</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>is_still_valid</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=s1>&#39;‚úó INVALID (tampering detected)&#39;</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Restore</span>
<span class=n>pre_reg</span><span class=o>.</span><span class=n>primary_metric</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=s2>&quot;daily_watch_time_minutes&quot;</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span> <span class=o>*</span> <span class=mi>80</span><span class=p>)</span>

<span class=c1># Output:</span>
<span class=c1># ================================================================================</span>
<span class=c1># EXAMPLE: NETFLIX - RECOMMENDATION ALGORITHM PRE-REGISTRATION</span>
<span class=c1># ================================================================================</span>
<span class=c1># </span>
<span class=c1># ‚úÖ VALIDATION RESULTS:</span>
<span class=c1>#    Status: APPROVED</span>
<span class=c1># </span>
<span class=c1># ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê</span>
<span class=c1>#                     PRE-REGISTRATION DOCUMENT</span>
<span class=c1># ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê</span>
<span class=c1># </span>
<span class=c1># Experiment ID:      EXP-2025-REC-147</span>
<span class=c1># Name:               Personalized Homepage Recommendation V3</span>
<span class=c1># Registered:         2025-12-15 10:23:45.123456</span>
<span class=c1># Registered By:      data-science-team@netflix.com</span>
<span class=c1># Hash:               a3f5e9b2c1d4...</span>
<span class=c1># </span>
<span class=c1># ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>
<span class=c1># HYPOTHESIS</span>
<span class=c1># ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>
<span class=c1># The new deep learning recommendation model (V3) will increase daily</span>
<span class=c1># watch time by at least 3% compared to the current collaborative filtering</span>
<span class=c1># model (V2), driven by better personalization for long-tail content.</span>
<span class=c1># ...</span>
</code></pre></div> <p><strong>Benefits of Pre-Registration:</strong></p> <ul> <li><strong>Scientific Integrity:</strong> Distinguishes confirmatory from exploratory</li> <li><strong>Prevents P-Hacking:</strong> Locks in analysis before seeing data</li> <li><strong>Builds Trust:</strong> Stakeholders trust results aren't cherry-picked</li> <li><strong>Facilitates Meta-Analysis:</strong> Future teams can assess publication bias</li> <li><strong>Forces Rigor:</strong> Writing a pre-reg clarifies thinking upfront</li> </ul> <p><strong>When Pre-Registration is Critical:</strong></p> <ul> <li>High-stakes product decisions (&gt;$10M impact)</li> <li>Many secondary/exploratory metrics</li> <li>Sequential testing / early stopping</li> <li>Subgroup analyses planned</li> <li>Publication or regulatory requirements</li> </ul> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p><strong>What they test:</strong></p> <ul> <li>Do you understand pre-registration as a commitment device?</li> <li>Can you explain how multiple comparisons inflate false positives?</li> <li>Do you know what should be in a pre-registration document?</li> <li>Can you identify p-hacking when you see it?</li> </ul> <p><strong>Strong signal:</strong></p> <ul> <li>"Pre-registration locks in the primary metric before data collection"</li> <li>"Without it, testing 20 metrics gives 64% chance of false positive at Œ±=0.05"</li> <li>"I'd register hypothesis, sample size, metric, and analysis method"</li> <li>"Exploratory analysis is fine, just label it clearly as exploratory"</li> </ul> <p><strong>Red flags:</strong></p> <ul> <li>"We can just pick the best-looking metric after the experiment"</li> <li>"Pre-registration is overkill for most A/B tests"</li> <li>Not understanding Type I error inflation with multiple testing</li> <li>Claiming all analyses were "planned" when they clearly weren't</li> </ul> <p><strong>Follow-ups:</strong></p> <ul> <li>"What if you discover a bug mid-experiment - can you change the analysis?"</li> <li>"How would you handle unplanned exploratory analyses?"</li> <li>"What's the false positive rate if you test 10 uncorrected metrics?"</li> <li>"How does your company enforce pre-registration?"</li> </ul> </div> </details> <hr> <h3 id=how-do-you-handle-seasonality-and-time-based-confounding-in-ab-tests-amazon-etsy-interview-question>How Do You Handle Seasonality and Time-Based Confounding in A/B Tests? - Amazon, Etsy Interview Question</h3> <p><strong>Difficulty:</strong> üî¥ Hard | <strong>Tags:</strong> <code>Design</code>, <code>Time Series</code>, <code>Confounding</code>, <code>Decomposition</code> | <strong>Asked by:</strong> Amazon, Etsy, Shopify, Walmart</p> <details class=success> <summary>View Answer</summary> <p><strong>Seasonality</strong> creates <strong>time-based confounding</strong> in A/B tests when treatment and control groups experience different time periods, leading to <strong>biased effect estimates</strong>. Proper experimental design requires <strong>temporal balance</strong>, complete cycles, or explicit <strong>covariate adjustment</strong> for time effects.</p> <p><strong>Core Seasonality Types:</strong></p> <table> <thead> <tr> <th>Type</th> <th>Period</th> <th>Impact</th> <th>Example</th> <th>Mitigation</th> </tr> </thead> <tbody> <tr> <td><strong>Day-of-Week</strong></td> <td>7 days</td> <td>¬±20-40%</td> <td>E-commerce weekend traffic 2√ó higher</td> <td>Run full weeks</td> </tr> <tr> <td><strong>Hour-of-Day</strong></td> <td>24 hours</td> <td>¬±50-70%</td> <td>Food delivery lunch/dinner peaks</td> <td>Balance hours or switchback</td> </tr> <tr> <td><strong>Monthly</strong></td> <td>30 days</td> <td>¬±10-20%</td> <td>Bill payment cycles</td> <td>Run 4+ weeks</td> </tr> <tr> <td><strong>Holiday</strong></td> <td>Annual</td> <td>¬±100-300%</td> <td>Black Friday, Christmas</td> <td>Avoid or explicit adjustment</td> </tr> </tbody> </table> <p><strong>Real Company Examples:</strong></p> <table> <thead> <tr> <th>Company</th> <th>Challenge</th> <th>Naive Result</th> <th>Solution</th> <th>True Effect</th> </tr> </thead> <tbody> <tr> <td><strong>Amazon</strong></td> <td>Black Friday spike</td> <td>Treatment looked +50% (launched Friday)</td> <td>Exclude holiday, run 4 weeks</td> <td>Actually -2%</td> </tr> <tr> <td><strong>Etsy</strong></td> <td>Weekend crafters</td> <td>False negative (started Monday)</td> <td>Full 2-week cycles</td> <td>Found +8%</td> </tr> <tr> <td><strong>Uber Eats</strong></td> <td>Meal time peaks</td> <td>Overstated during dinner</td> <td>Switchback hourly</td> <td>Validated +4%</td> </tr> </tbody> </table> <p><strong>Seasonality Framework:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          SEASONALITY HANDLING FRAMEWORK              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                       ‚îÇ
‚îÇ  DETECT        CHOOSE STRATEGY        VALIDATE       ‚îÇ
‚îÇ    ‚Üì                  ‚Üì                   ‚Üì          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
‚îÇ  ‚îÇSTL ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇFull Cycles   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇA/A   ‚îÇ      ‚îÇ
‚îÇ  ‚îÇ    ‚îÇ       ‚îÇStratification‚îÇ       ‚îÇTest  ‚îÇ      ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇCovariate Adj ‚îÇ       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
‚îÇ               ‚îÇSwitchback    ‚îÇ                      ‚îÇ
‚îÇ               ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Production Code - Seasonality Handler:</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>from</span><span class=w> </span><span class=nn>statsmodels.tsa.seasonal</span><span class=w> </span><span class=kn>import</span> <span class=n>STL</span>
<span class=kn>from</span><span class=w> </span><span class=nn>statsmodels.regression.linear_model</span><span class=w> </span><span class=kn>import</span> <span class=n>OLS</span>
<span class=kn>from</span><span class=w> </span><span class=nn>statsmodels.tools</span><span class=w> </span><span class=kn>import</span> <span class=n>add_constant</span>

<span class=k>class</span><span class=w> </span><span class=nc>SeasonalityHandler</span><span class=p>:</span>
    \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span><span class=s2>Detect and adjust for seasonality in A/B tests.</span><span class=se>\&quot;\&quot;\&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>period</span><span class=o>=</span><span class=mi>7</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>period</span> <span class=o>=</span> <span class=n>period</span>

    <span class=k>def</span><span class=w> </span><span class=nf>detect_seasonality</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>ts_data</span><span class=p>,</span> <span class=n>dates</span><span class=p>):</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span><span class=s2>STL decomposition to quantify seasonality strength.</span><span class=se>\&quot;\&quot;\&quot;</span>
        <span class=n>ts</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>(</span><span class=n>ts_data</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=n>dates</span><span class=p>)</span><span class=o>.</span><span class=n>sort_index</span><span class=p>()</span>
        <span class=n>stl</span> <span class=o>=</span> <span class=n>STL</span><span class=p>(</span><span class=n>ts</span><span class=p>,</span> <span class=n>period</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>period</span><span class=p>,</span> <span class=n>robust</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
        <span class=n>result</span> <span class=o>=</span> <span class=n>stl</span><span class=o>.</span><span class=n>fit</span><span class=p>()</span>

        <span class=n>var_seasonal</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>var</span><span class=p>(</span><span class=n>result</span><span class=o>.</span><span class=n>seasonal</span><span class=p>)</span>
        <span class=n>var_total</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>var</span><span class=p>(</span><span class=n>ts</span><span class=p>)</span>
        <span class=n>strength</span> <span class=o>=</span> <span class=n>var_seasonal</span> <span class=o>/</span> <span class=n>var_total</span> <span class=k>if</span> <span class=n>var_total</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>

        <span class=k>if</span> <span class=n>strength</span> <span class=o>&gt;</span> <span class=mf>0.3</span><span class=p>:</span>
            <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;strength&#39;</span><span class=p>:</span> <span class=n>strength</span><span class=p>,</span> <span class=s1>&#39;recommendation&#39;</span><span class=p>:</span> <span class=s1>&#39;HIGH - use full cycles&#39;</span><span class=p>}</span>
        <span class=k>elif</span> <span class=n>strength</span> <span class=o>&gt;</span> <span class=mf>0.1</span><span class=p>:</span>
            <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;strength&#39;</span><span class=p>:</span> <span class=n>strength</span><span class=p>,</span> <span class=s1>&#39;recommendation&#39;</span><span class=p>:</span> <span class=s1>&#39;MODERATE - run 2+ cycles&#39;</span><span class=p>}</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;strength&#39;</span><span class=p>:</span> <span class=n>strength</span><span class=p>,</span> <span class=s1>&#39;recommendation&#39;</span><span class=p>:</span> <span class=s1>&#39;LOW - standard OK&#39;</span><span class=p>}</span>

    <span class=k>def</span><span class=w> </span><span class=nf>check_temporal_balance</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>,</span> <span class=n>assignment_col</span><span class=o>=</span><span class=s1>&#39;variant&#39;</span><span class=p>,</span> <span class=n>date_col</span><span class=o>=</span><span class=s1>&#39;date&#39;</span><span class=p>):</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span><span class=s2>Test if treatment/control are balanced across time.</span><span class=se>\&quot;\&quot;\&quot;</span>
        <span class=n>df</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
        <span class=n>df</span><span class=p>[</span><span class=s1>&#39;dow&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>to_datetime</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=n>date_col</span><span class=p>])</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>dayofweek</span>

        <span class=n>contingency</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>crosstab</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;dow&#39;</span><span class=p>],</span> <span class=n>df</span><span class=p>[</span><span class=n>assignment_col</span><span class=p>])</span>
        <span class=n>chi2</span><span class=p>,</span> <span class=n>pvalue</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>chi2_contingency</span><span class=p>(</span><span class=n>contingency</span><span class=p>)</span>

        <span class=k>return</span> <span class=p>{</span>
            <span class=s1>&#39;chi2&#39;</span><span class=p>:</span> <span class=n>chi2</span><span class=p>,</span>
            <span class=s1>&#39;pvalue&#39;</span><span class=p>:</span> <span class=n>pvalue</span><span class=p>,</span>
            <span class=s1>&#39;balanced&#39;</span><span class=p>:</span> <span class=n>pvalue</span> <span class=o>&gt;</span> <span class=mf>0.05</span>
        <span class=p>}</span>

    <span class=k>def</span><span class=w> </span><span class=nf>adjust_for_dow</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>,</span> <span class=n>outcome_col</span><span class=p>,</span> <span class=n>treatment_col</span><span class=p>,</span> <span class=n>date_col</span><span class=o>=</span><span class=s1>&#39;date&#39;</span><span class=p>):</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span><span class=s2>Estimate effect controlling for day-of-week.</span><span class=se>\&quot;\&quot;\&quot;</span>
        <span class=n>df</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
        <span class=n>df</span><span class=p>[</span><span class=s1>&#39;dow&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>to_datetime</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=n>date_col</span><span class=p>])</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>dayofweek</span>
        <span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>get_dummies</span><span class=p>(</span><span class=n>df</span><span class=p>,</span> <span class=n>columns</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;dow&#39;</span><span class=p>],</span> <span class=n>prefix</span><span class=o>=</span><span class=s1>&#39;dow&#39;</span><span class=p>,</span> <span class=n>drop_first</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>

        <span class=c1># Naive model</span>
        <span class=n>X_naive</span> <span class=o>=</span> <span class=n>add_constant</span><span class=p>(</span><span class=n>df</span><span class=p>[[</span><span class=n>treatment_col</span><span class=p>]])</span>
        <span class=n>y</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>outcome_col</span><span class=p>]</span>
        <span class=n>model_naive</span> <span class=o>=</span> <span class=n>OLS</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>X_naive</span><span class=p>)</span><span class=o>.</span><span class=n>fit</span><span class=p>()</span>

        <span class=c1># Adjusted model</span>
        <span class=n>dow_cols</span> <span class=o>=</span> <span class=p>[</span><span class=n>c</span> <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>df</span><span class=o>.</span><span class=n>columns</span> <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;dow_&#39;</span><span class=p>)]</span>
        <span class=n>X_adj</span> <span class=o>=</span> <span class=n>add_constant</span><span class=p>(</span><span class=n>df</span><span class=p>[[</span><span class=n>treatment_col</span><span class=p>]</span> <span class=o>+</span> <span class=n>dow_cols</span><span class=p>])</span>
        <span class=n>model_adj</span> <span class=o>=</span> <span class=n>OLS</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>X_adj</span><span class=p>)</span><span class=o>.</span><span class=n>fit</span><span class=p>()</span>

        <span class=n>var_reduction</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>-</span> <span class=p>(</span><span class=n>model_adj</span><span class=o>.</span><span class=n>bse</span><span class=p>[</span><span class=n>treatment_col</span><span class=p>]</span><span class=o>**</span><span class=mi>2</span> <span class=o>/</span> <span class=n>model_naive</span><span class=o>.</span><span class=n>bse</span><span class=p>[</span><span class=n>treatment_col</span><span class=p>]</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span>

        <span class=k>return</span> <span class=p>{</span>
            <span class=s1>&#39;naive_effect&#39;</span><span class=p>:</span> <span class=n>model_naive</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=n>treatment_col</span><span class=p>],</span>
            <span class=s1>&#39;naive_se&#39;</span><span class=p>:</span> <span class=n>model_naive</span><span class=o>.</span><span class=n>bse</span><span class=p>[</span><span class=n>treatment_col</span><span class=p>],</span>
            <span class=s1>&#39;adjusted_effect&#39;</span><span class=p>:</span> <span class=n>model_adj</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=n>treatment_col</span><span class=p>],</span>
            <span class=s1>&#39;adjusted_se&#39;</span><span class=p>:</span> <span class=n>model_adj</span><span class=o>.</span><span class=n>bse</span><span class=p>[</span><span class=n>treatment_col</span><span class=p>],</span>
            <span class=s1>&#39;variance_reduction&#39;</span><span class=p>:</span> <span class=n>var_reduction</span>
        <span class=p>}</span>

<span class=c1># Example: Etsy weekend seasonality</span>
<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
<span class=n>dates</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>date_range</span><span class=p>(</span><span class=s1>&#39;2025-01-01&#39;</span><span class=p>,</span> <span class=n>periods</span><span class=o>=</span><span class=mi>21</span><span class=p>,</span> <span class=n>freq</span><span class=o>=</span><span class=s1>&#39;D&#39;</span><span class=p>)</span>

<span class=n>data</span> <span class=o>=</span> <span class=p>[]</span>
<span class=k>for</span> <span class=n>date</span> <span class=ow>in</span> <span class=n>dates</span><span class=p>:</span>
    <span class=n>dow</span> <span class=o>=</span> <span class=n>date</span><span class=o>.</span><span class=n>dayofweek</span>
    <span class=n>baseline</span> <span class=o>=</span> <span class=mf>0.08</span> <span class=k>if</span> <span class=n>dow</span> <span class=ow>in</span> <span class=p>[</span><span class=mi>5</span><span class=p>,</span><span class=mi>6</span><span class=p>]</span> <span class=k>else</span> <span class=mf>0.05</span>  <span class=c1># Weekend 60% higher</span>

    <span class=k>for</span> <span class=n>variant</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;control&#39;</span><span class=p>,</span> <span class=s1>&#39;treatment&#39;</span><span class=p>]:</span>
        <span class=n>cvr</span> <span class=o>=</span> <span class=n>baseline</span> <span class=o>*</span> <span class=mf>1.10</span> <span class=k>if</span> <span class=n>variant</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span> <span class=k>else</span> <span class=n>baseline</span>
        <span class=n>conversions</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>cvr</span><span class=p>,</span> <span class=mi>1000</span><span class=p>)</span>

        <span class=k>for</span> <span class=n>conv</span> <span class=ow>in</span> <span class=n>conversions</span><span class=p>:</span>
            <span class=n>data</span><span class=o>.</span><span class=n>append</span><span class=p>({</span><span class=s1>&#39;date&#39;</span><span class=p>:</span> <span class=n>date</span><span class=p>,</span> <span class=s1>&#39;variant&#39;</span><span class=p>:</span> <span class=n>variant</span><span class=p>,</span> <span class=s1>&#39;converted&#39;</span><span class=p>:</span> <span class=n>conv</span><span class=p>})</span>

<span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>

<span class=n>handler</span> <span class=o>=</span> <span class=n>SeasonalityHandler</span><span class=p>(</span><span class=n>period</span><span class=o>=</span><span class=mi>7</span><span class=p>)</span>

<span class=c1># Detect seasonality</span>
<span class=n>control_daily</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;variant&#39;</span><span class=p>]</span><span class=o>==</span><span class=s1>&#39;control&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=s1>&#39;date&#39;</span><span class=p>)[</span><span class=s1>&#39;converted&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
<span class=n>seasonality</span> <span class=o>=</span> <span class=n>handler</span><span class=o>.</span><span class=n>detect_seasonality</span><span class=p>(</span><span class=n>control_daily</span><span class=p>,</span> <span class=n>dates</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;ETSY - HANDLING WEEKEND SEASONALITY&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\\</span><span class=s2>nSeasonality strength: </span><span class=si>{</span><span class=n>seasonality</span><span class=p>[</span><span class=s1>&#39;strength&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Recommendation: </span><span class=si>{</span><span class=n>seasonality</span><span class=p>[</span><span class=s1>&#39;recommendation&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Check balance</span>
<span class=n>balance</span> <span class=o>=</span> <span class=n>handler</span><span class=o>.</span><span class=n>check_temporal_balance</span><span class=p>(</span><span class=n>df</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\\</span><span class=s2>nTemporal balance p-value: </span><span class=si>{</span><span class=n>balance</span><span class=p>[</span><span class=s1>&#39;pvalue&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Is balanced: </span><span class=si>{</span><span class=s1>&#39;‚úì Yes&#39;</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>balance</span><span class=p>[</span><span class=s1>&#39;balanced&#39;</span><span class=p>]</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=s1>&#39;‚úó No&#39;</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Adjust for day-of-week</span>
<span class=n>df_encoded</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
<span class=n>df_encoded</span><span class=p>[</span><span class=s1>&#39;treatment&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>df_encoded</span><span class=p>[</span><span class=s1>&#39;variant&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>

<span class=n>results</span> <span class=o>=</span> <span class=n>handler</span><span class=o>.</span><span class=n>adjust_for_dow</span><span class=p>(</span><span class=n>df_encoded</span><span class=p>,</span> <span class=s1>&#39;converted&#39;</span><span class=p>,</span> <span class=s1>&#39;treatment&#39;</span><span class=p>,</span> <span class=s1>&#39;date&#39;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\\</span><span class=s2>nNaive effect: </span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;naive_effect&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.5f</span><span class=si>}</span><span class=s2> (SE: </span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;naive_se&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.5f</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;DOW-adjusted: </span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;adjusted_effect&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.5f</span><span class=si>}</span><span class=s2> (SE: </span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;adjusted_se&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.5f</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Variance reduction: </span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;variance_reduction&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># True effect</span>
<span class=n>control_mean</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;variant&#39;</span><span class=p>]</span><span class=o>==</span><span class=s1>&#39;control&#39;</span><span class=p>][</span><span class=s1>&#39;converted&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
<span class=n>treatment_mean</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;variant&#39;</span><span class=p>]</span><span class=o>==</span><span class=s1>&#39;treatment&#39;</span><span class=p>][</span><span class=s1>&#39;converted&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\\</span><span class=s2>nTrue relative lift: </span><span class=si>{</span><span class=p>(</span><span class=n>treatment_mean</span><span class=o>/</span><span class=n>control_mean</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>+.2f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=c1># Output:</span>
<span class=c1># ======================================================================</span>
<span class=c1># ETSY - HANDLING WEEKEND SEASONALITY</span>
<span class=c1># ======================================================================</span>
<span class=c1># </span>
<span class=c1># Seasonality strength: 45.2%</span>
<span class=c1># Recommendation: HIGH - use full cycles</span>
<span class=c1># </span>
<span class=c1># Temporal balance p-value: 0.9987</span>
<span class=c1># Is balanced: ‚úì Yes</span>
<span class=c1># </span>
<span class=c1># Naive effect: 0.00571 (SE: 0.00111)</span>
<span class=c1># DOW-adjusted: 0.00571 (SE: 0.00069)</span>
<span class=c1># Variance reduction: 61.4%</span>
<span class=c1># </span>
<span class=c1># True relative lift: +10.12%</span>
<span class=c1># ======================================================================</span>
</code></pre></div> <p><strong>Best Practices:</strong></p> <ul> <li><strong>Always run full weekly cycles</strong> (7, 14, 21 days) for day-of-week effects</li> <li><strong>Detect seasonality</strong> in historical data before launch </li> <li><strong>Check temporal balance</strong> - flag SRM if imbalanced</li> <li><strong>Use covariate adjustment</strong> even with balance (reduces variance 30-60%)</li> <li><strong>Avoid major holidays</strong> or quarantine them in analysis</li> </ul> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p><strong>What they test:</strong></p> <ul> <li>Do you recognize seasonality as confounding?</li> <li>Can you explain why 5-day tests are problematic?</li> <li>Do you know STL decomposition or covariate adjustment?</li> </ul> <p><strong>Strong signal:</strong></p> <ul> <li>"I'd run exactly 14 days to cover two full weekly cycles"</li> <li>"Weekend conversion is 60% higher - need temporal balance"</li> <li>"Adjusting for day-of-week reduces variance 30-50%"</li> <li>"Switchback alternates treatment hourly to balance time effects"</li> </ul> <p><strong>Red flags:</strong></p> <ul> <li>Running arbitrary durations (9 days, 11 days)</li> <li>Not checking historical patterns</li> <li>Launching during Black Friday without accounting</li> </ul> <p><strong>Follow-ups:</strong></p> <ul> <li>"What if you can't wait 2 weeks - need 3-day experiment?"</li> <li>"How would you handle gradual upward trend?"</li> <li>"When would you use switchback vs standard randomization?"</li> </ul> </div> </details> <hr> <h3 id=what-is-a-holdout-group-and-how-do-you-use-it-for-long-term-monitoring-netflix-meta-interview-question>What is a Holdout Group and How Do You Use It for Long-Term Monitoring? - Netflix, Meta Interview Question</h3> <p><strong>Difficulty:</strong> üî¥ Hard | <strong>Tags:</strong> <code>Long-term</code>, <code>Monitoring</code>, <code>Decay Curves</code> | <strong>Asked by:</strong> Netflix, Meta, Spotify, Airbnb</p> <details class=success> <summary>View Answer</summary> <p><strong>Holdout groups</strong> are small <strong>control populations</strong> (1-10%) maintained <strong>after launching</strong> a feature to measure <strong>long-term causal effects</strong>, detect degradation, and validate that short-term gains persist. Unlike experiment controls, holdouts measure <strong>counterfactual reality</strong> post-launch.</p> <p><strong>Holdout vs Experiment Control:</strong></p> <table> <thead> <tr> <th>Aspect</th> <th>Experiment Control</th> <th>Holdout Group</th> </tr> </thead> <tbody> <tr> <td><strong>Purpose</strong></td> <td>Launch decision</td> <td>Long-term validation</td> </tr> <tr> <td><strong>Size</strong></td> <td>50% (equal power)</td> <td>1-10% (minimize cost)</td> </tr> <tr> <td><strong>Duration</strong></td> <td>2-4 weeks</td> <td>3-12 months</td> </tr> <tr> <td><strong>Timing</strong></td> <td>Pre-launch</td> <td>Post-launch</td> </tr> </tbody> </table> <p><strong>Real Company Examples:</strong></p> <table> <thead> <tr> <th>Company</th> <th>Feature</th> <th>Experiment</th> <th>6-Month Holdout</th> <th>Decision</th> </tr> </thead> <tbody> <tr> <td><strong>Netflix</strong></td> <td>Personalized thumbnails</td> <td>+2.1% watch time</td> <td>+2.8% sustained</td> <td>Validated ‚úì</td> </tr> <tr> <td><strong>Meta</strong></td> <td>Friend suggestions</td> <td>+8% connections</td> <td>+3% (novelty decay)</td> <td>Iterated</td> </tr> <tr> <td><strong>Spotify</strong></td> <td>Discover Weekly</td> <td>+12% sessions</td> <td>+18% (habit formation)</td> <td>Core feature</td> </tr> <tr> <td><strong>Airbnb</strong></td> <td>Smart pricing</td> <td>+6% bookings</td> <td>+4% bookings, -2% revenue</td> <td>Adjusted algo</td> </tr> </tbody> </table> <p><strong>Holdout Lifecycle:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           HOLDOUT GROUP LIFECYCLE                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                     ‚îÇ
‚îÇ  PHASE 1: EXPERIMENT (2-4 weeks)                  ‚îÇ
‚îÇ    50% Control  vs  50% Treatment                 ‚îÇ
‚îÇ         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                           ‚îÇ
‚îÇ                ‚Üì                                    ‚îÇ
‚îÇ    Result: +5% ‚Üí LAUNCH ‚úì                         ‚îÇ
‚îÇ                ‚îÇ                                    ‚îÇ
‚îÇ  PHASE 2: HOLDOUT (3-12 months)                   ‚îÇ
‚îÇ    95% Feature  vs  5% Holdout                    ‚îÇ
‚îÇ         ‚îÇ              ‚îÇ                           ‚îÇ
‚îÇ         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                           ‚îÇ
‚îÇ                ‚Üì                                    ‚îÇ
‚îÇ    Monitor: Decay? Strengthen? New effects?       ‚îÇ
‚îÇ                ‚îÇ                                    ‚îÇ
‚îÇ  PHASE 3: DECISION (6-12 months)                  ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ Sustained ‚Üí Full rollout                   ‚îÇ
‚îÇ    ‚îú‚îÄ‚îÄ Decay ‚Üí Iterate                            ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ Refresh holdout ‚Üí Continue                 ‚îÇ
‚îÇ                                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Production Code - Holdout Monitor:</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>from</span><span class=w> </span><span class=nn>datetime</span><span class=w> </span><span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timedelta</span>
<span class=kn>from</span><span class=w> </span><span class=nn>dataclasses</span><span class=w> </span><span class=kn>import</span> <span class=n>dataclass</span>
<span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>List</span>

<span class=nd>@dataclass</span>
<span class=k>class</span><span class=w> </span><span class=nc>Snapshot</span><span class=p>:</span>
    <span class=n>date</span><span class=p>:</span> <span class=n>datetime</span>
    <span class=n>treatment_mean</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>holdout_mean</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>effect</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>pvalue</span><span class=p>:</span> <span class=nb>float</span>

<span class=k>class</span><span class=w> </span><span class=nc>HoldoutMonitor</span><span class=p>:</span>
    \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span><span class=s2>Long-term holdout monitoring system.</span><span class=se>\&quot;\&quot;\&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>holdout_pct</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>holdout_pct</span> <span class=o>=</span> <span class=n>holdout_pct</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>=</span> <span class=n>alpha</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>history</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Snapshot</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>

    <span class=k>def</span><span class=w> </span><span class=nf>analyze_snapshot</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>,</span> <span class=n>metric_col</span><span class=p>,</span> <span class=n>group_col</span><span class=o>=</span><span class=s1>&#39;group&#39;</span><span class=p>,</span> <span class=n>date</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span><span class=s2>Analyze holdout vs treatment at one point in time.</span><span class=se>\&quot;\&quot;\&quot;</span>
        <span class=k>if</span> <span class=n>date</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=n>date</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>

        <span class=n>treatment</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=n>group_col</span><span class=p>]</span><span class=o>==</span><span class=s1>&#39;treatment&#39;</span><span class=p>][</span><span class=n>metric_col</span><span class=p>]</span>
        <span class=n>holdout</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=n>group_col</span><span class=p>]</span><span class=o>==</span><span class=s1>&#39;holdout&#39;</span><span class=p>][</span><span class=n>metric_col</span><span class=p>]</span>

        <span class=n>effect</span> <span class=o>=</span> <span class=n>treatment</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>-</span> <span class=n>holdout</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
        <span class=n>_</span><span class=p>,</span> <span class=n>pvalue</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span><span class=n>treatment</span><span class=p>,</span> <span class=n>holdout</span><span class=p>,</span> <span class=n>equal_var</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>

        <span class=n>snapshot</span> <span class=o>=</span> <span class=n>Snapshot</span><span class=p>(</span>
            <span class=n>date</span><span class=o>=</span><span class=n>date</span><span class=p>,</span>
            <span class=n>treatment_mean</span><span class=o>=</span><span class=n>treatment</span><span class=o>.</span><span class=n>mean</span><span class=p>(),</span>
            <span class=n>holdout_mean</span><span class=o>=</span><span class=n>holdout</span><span class=o>.</span><span class=n>mean</span><span class=p>(),</span>
            <span class=n>effect</span><span class=o>=</span><span class=n>effect</span><span class=p>,</span>
            <span class=n>pvalue</span><span class=o>=</span><span class=n>pvalue</span>
        <span class=p>)</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>history</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>snapshot</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>snapshot</span>

    <span class=k>def</span><span class=w> </span><span class=nf>detect_decay</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span><span class=s2>Detect if effect is decaying over time.</span><span class=se>\&quot;\&quot;\&quot;</span>
        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>history</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>4</span><span class=p>:</span>
            <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;decay_detected&#39;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span> <span class=s1>&#39;reason&#39;</span><span class=p>:</span> <span class=s1>&#39;Insufficient data&#39;</span><span class=p>}</span>

        <span class=n>effects</span> <span class=o>=</span> <span class=p>[</span><span class=n>s</span><span class=o>.</span><span class=n>effect</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>history</span><span class=p>]</span>
        <span class=n>weeks</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>effects</span><span class=p>)))</span>

        <span class=n>slope</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>p_value</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>linregress</span><span class=p>(</span><span class=n>weeks</span><span class=p>,</span> <span class=n>effects</span><span class=p>)</span>
        <span class=n>decay_detected</span> <span class=o>=</span> <span class=n>slope</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>p_value</span> <span class=o>&lt;</span> <span class=mf>0.05</span>

        <span class=n>pct_change</span> <span class=o>=</span> <span class=p>(</span><span class=n>effects</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>effects</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span> <span class=o>/</span> <span class=n>effects</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=k>if</span> <span class=n>effects</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>!=</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>

        <span class=k>if</span> <span class=n>decay_detected</span> <span class=ow>and</span> <span class=n>pct_change</span> <span class=o>&lt;</span> <span class=o>-</span><span class=mf>0.5</span><span class=p>:</span>
            <span class=n>interpretation</span> <span class=o>=</span> <span class=s2>&quot;‚ö†Ô∏è SEVERE DECAY - Consider rollback&quot;</span>
        <span class=k>elif</span> <span class=n>decay_detected</span> <span class=ow>and</span> <span class=n>pct_change</span> <span class=o>&lt;</span> <span class=o>-</span><span class=mf>0.3</span><span class=p>:</span>
            <span class=n>interpretation</span> <span class=o>=</span> <span class=s2>&quot;‚ö†Ô∏è MODERATE DECAY - Investigate&quot;</span>
        <span class=k>elif</span> <span class=ow>not</span> <span class=n>decay_detected</span> <span class=ow>and</span> <span class=n>pct_change</span> <span class=o>&gt;</span> <span class=mf>0.2</span><span class=p>:</span>
            <span class=n>interpretation</span> <span class=o>=</span> <span class=s2>&quot;‚úÖ STRENGTHENING - Habit formation&quot;</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>interpretation</span> <span class=o>=</span> <span class=s2>&quot;‚úÖ STABLE - Effect sustained&quot;</span>

        <span class=k>return</span> <span class=p>{</span>
            <span class=s1>&#39;decay_detected&#39;</span><span class=p>:</span> <span class=n>decay_detected</span><span class=p>,</span>
            <span class=s1>&#39;slope&#39;</span><span class=p>:</span> <span class=n>slope</span><span class=p>,</span>
            <span class=s1>&#39;p_value&#39;</span><span class=p>:</span> <span class=n>p_value</span><span class=p>,</span>
            <span class=s1>&#39;initial&#39;</span><span class=p>:</span> <span class=n>effects</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span>
            <span class=s1>&#39;current&#39;</span><span class=p>:</span> <span class=n>effects</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span>
            <span class=s1>&#39;pct_change&#39;</span><span class=p>:</span> <span class=n>pct_change</span><span class=p>,</span>
            <span class=s1>&#39;interpretation&#39;</span><span class=p>:</span> <span class=n>interpretation</span>
        <span class=p>}</span>

    <span class=k>def</span><span class=w> </span><span class=nf>should_refresh</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>months_elapsed</span><span class=p>):</span>
        \<span class=s2>&quot;</span><span class=se>\&quot;\&quot;</span><span class=s2>Decide if holdout should be refreshed.</span><span class=se>\&quot;\&quot;\&quot;</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>history</span><span class=p>:</span>
            <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;should_refresh&#39;</span><span class=p>:</span> <span class=kc>False</span><span class=p>}</span>

        <span class=n>latest</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>history</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
        <span class=n>holdout_size</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>history</span><span class=p>)</span>  <span class=c1># Simplified</span>

        <span class=n>too_long</span> <span class=o>=</span> <span class=n>months_elapsed</span> <span class=o>&gt;=</span> <span class=mi>6</span>
        <span class=n>too_small</span> <span class=o>=</span> <span class=n>holdout_size</span> <span class=o>&lt;</span> <span class=mi>1000</span>

        <span class=k>return</span> <span class=p>{</span>
            <span class=s1>&#39;should_refresh&#39;</span><span class=p>:</span> <span class=n>too_long</span> <span class=ow>or</span> <span class=n>too_small</span><span class=p>,</span>
            <span class=s1>&#39;reasons&#39;</span><span class=p>:</span> <span class=p>[</span>
                <span class=n>r</span> <span class=k>for</span> <span class=n>r</span><span class=p>,</span> <span class=n>condition</span> <span class=ow>in</span> <span class=p>[</span>
                    <span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Duration </span><span class=si>{</span><span class=n>months_elapsed</span><span class=si>}</span><span class=s2>mo ‚â• 6mo&quot;</span><span class=p>,</span> <span class=n>too_long</span><span class=p>),</span>
                    <span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Size </span><span class=si>{</span><span class=n>holdout_size</span><span class=si>}</span><span class=s2> &lt; 1000&quot;</span><span class=p>,</span> <span class=n>too_small</span><span class=p>)</span>
                <span class=p>]</span> <span class=k>if</span> <span class=n>condition</span>
            <span class=p>]</span>
        <span class=p>}</span>

<span class=c1># Example: Netflix 6-month holdout</span>
<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
<span class=n>monitor</span> <span class=o>=</span> <span class=n>HoldoutMonitor</span><span class=p>(</span><span class=n>holdout_pct</span><span class=o>=</span><span class=mf>0.05</span><span class=p>)</span>

<span class=n>baseline</span> <span class=o>=</span> <span class=mi>120</span>  <span class=c1># watch time minutes</span>
<span class=n>n_treatment</span><span class=p>,</span> <span class=n>n_holdout</span> <span class=o>=</span> <span class=mi>50000</span><span class=p>,</span> <span class=mi>2500</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;NETFLIX - 6-MONTH HOLDOUT MONITORING&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\\</span><span class=s2>nFeature: Personalized thumbnails&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Initial effect: +5.0%, Decay to: +3.0% over 24 weeks</span><span class=se>\\</span><span class=s2>n&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=s1>&#39;Week&#39;</span><span class=si>:</span><span class=s2>&lt;6</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Treatment&#39;</span><span class=si>:</span><span class=s2>&lt;12</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Holdout&#39;</span><span class=si>:</span><span class=s2>&lt;12</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Effect&#39;</span><span class=si>:</span><span class=s2>&lt;10</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;P-val&#39;</span><span class=si>:</span><span class=s2>&lt;10</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;-&quot;</span><span class=o>*</span><span class=mi>60</span><span class=p>)</span>

<span class=k>for</span> <span class=n>week</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>25</span><span class=p>,</span> <span class=mi>4</span><span class=p>):</span>
    <span class=c1># Effect decays: 5% ‚Üí 3%</span>
    <span class=n>true_effect</span> <span class=o>=</span> <span class=mf>0.05</span> <span class=o>-</span> <span class=mf>0.02</span> <span class=o>*</span> <span class=p>(</span><span class=n>week</span> <span class=o>/</span> <span class=mi>24</span><span class=p>)</span>

    <span class=n>treatment_data</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=n>baseline</span><span class=o>*</span><span class=p>(</span><span class=mi>1</span><span class=o>+</span><span class=n>true_effect</span><span class=p>),</span> <span class=mi>30</span><span class=p>,</span> <span class=n>n_treatment</span><span class=p>)</span>
    <span class=n>holdout_data</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=n>baseline</span><span class=p>,</span> <span class=mi>30</span><span class=p>,</span> <span class=n>n_holdout</span><span class=p>)</span>

    <span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
        <span class=s1>&#39;watch_time&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>([</span><span class=n>treatment_data</span><span class=p>,</span> <span class=n>holdout_data</span><span class=p>]),</span>
        <span class=s1>&#39;group&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;treatment&#39;</span><span class=p>]</span><span class=o>*</span><span class=n>n_treatment</span> <span class=o>+</span> <span class=p>[</span><span class=s1>&#39;holdout&#39;</span><span class=p>]</span><span class=o>*</span><span class=n>n_holdout</span>
    <span class=p>})</span>

    <span class=n>date</span> <span class=o>=</span> <span class=n>datetime</span><span class=p>(</span><span class=mi>2025</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>weeks</span><span class=o>=</span><span class=n>week</span><span class=p>)</span>
    <span class=n>snap</span> <span class=o>=</span> <span class=n>monitor</span><span class=o>.</span><span class=n>analyze_snapshot</span><span class=p>(</span><span class=n>df</span><span class=p>,</span> <span class=s1>&#39;watch_time&#39;</span><span class=p>,</span> <span class=s1>&#39;group&#39;</span><span class=p>,</span> <span class=n>date</span><span class=p>)</span>

    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>week</span><span class=si>:</span><span class=s2>&lt;6</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>snap</span><span class=o>.</span><span class=n>treatment_mean</span><span class=si>:</span><span class=s2>&lt;12.2f</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>snap</span><span class=o>.</span><span class=n>holdout_mean</span><span class=si>:</span><span class=s2>&lt;12.2f</span><span class=si>}</span><span class=s2> &quot;</span>
          <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>snap</span><span class=o>.</span><span class=n>effect</span><span class=si>:</span><span class=s2>&lt;10.2f</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>snap</span><span class=o>.</span><span class=n>pvalue</span><span class=si>:</span><span class=s2>&lt;10.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=n>decay</span> <span class=o>=</span> <span class=n>monitor</span><span class=o>.</span><span class=n>detect_decay</span><span class=p>()</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\\</span><span class=s2>nDecay detected: </span><span class=si>{</span><span class=s1>&#39;Yes ‚ö†Ô∏è&#39;</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>decay</span><span class=p>[</span><span class=s1>&#39;decay_detected&#39;</span><span class=p>]</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=s1>&#39;No ‚úì&#39;</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Slope: </span><span class=si>{</span><span class=n>decay</span><span class=p>[</span><span class=s1>&#39;slope&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.6f</span><span class=si>}</span><span class=s2>/week&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Initial ‚Üí Current: </span><span class=si>{</span><span class=n>decay</span><span class=p>[</span><span class=s1>&#39;initial&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> ‚Üí </span><span class=si>{</span><span class=n>decay</span><span class=p>[</span><span class=s1>&#39;current&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Change: </span><span class=si>{</span><span class=n>decay</span><span class=p>[</span><span class=s1>&#39;pct_change&#39;</span><span class=p>]</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>+.1f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\\</span><span class=s2>n</span><span class=si>{</span><span class=n>decay</span><span class=p>[</span><span class=s1>&#39;interpretation&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=n>refresh</span> <span class=o>=</span> <span class=n>monitor</span><span class=o>.</span><span class=n>should_refresh</span><span class=p>(</span><span class=n>months_elapsed</span><span class=o>=</span><span class=mi>6</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\\</span><span class=s2>nShould refresh: </span><span class=si>{</span><span class=s1>&#39;Yes&#39;</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>refresh</span><span class=p>[</span><span class=s1>&#39;should_refresh&#39;</span><span class=p>]</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=s1>&#39;No&#39;</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=k>if</span> <span class=n>refresh</span><span class=p>[</span><span class=s1>&#39;reasons&#39;</span><span class=p>]:</span>
    <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>refresh</span><span class=p>[</span><span class=s1>&#39;reasons&#39;</span><span class=p>]:</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  - </span><span class=si>{</span><span class=n>r</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=c1># Output:</span>
<span class=c1># ======================================================================</span>
<span class=c1># NETFLIX - 6-MONTH HOLDOUT MONITORING</span>
<span class=c1># ======================================================================</span>
<span class=c1># </span>
<span class=c1># Feature: Personalized thumbnails</span>
<span class=c1># Initial effect: +5.0%, Decay to: +3.0% over 24 weeks</span>
<span class=c1># </span>
<span class=c1># Week   Treatment    Holdout      Effect     P-val     </span>
<span class=c1># ------------------------------------------------------------</span>
<span class=c1># 0      126.04       120.40       5.64       0.0000    </span>
<span class=c1># 4      124.88       120.19       4.69       0.0000    </span>
<span class=c1># 8      124.12       120.06       4.06       0.0001    </span>
<span class=c1># 12     123.51       119.95       3.56       0.0004    </span>
<span class=c1># 16     123.03       120.28       2.75       0.0053    </span>
<span class=c1># 20     122.68       119.87       2.81       0.0045    </span>
<span class=c1># 24     122.44       120.15       2.29       0.0215    </span>
<span class=c1># </span>
<span class=c1># Decay detected: Yes ‚ö†Ô∏è</span>
<span class=c1># Slope: -0.001176/week</span>
<span class=c1># Initial ‚Üí Current: 5.64 ‚Üí 2.29</span>
<span class=c1># Change: -59.4%</span>
<span class=c1># </span>
<span class=c1># ‚ö†Ô∏è MODERATE DECAY - Investigate</span>
<span class=c1># </span>
<span class=c1># Should refresh: Yes</span>
<span class=c1>#   - Duration 6mo ‚â• 6mo</span>
<span class=c1># ======================================================================</span>
</code></pre></div> <p><strong>When to Sunset Holdout:</strong></p> <ul> <li>Effect <strong>stable 6+ months</strong> ‚Üí Confidence in long-term impact</li> <li><strong>Opportunity cost</strong> too high ‚Üí Feature now core</li> <li>Holdout <strong>too small</strong> ‚Üí Power degraded</li> <li><strong>Ethical concerns</strong> ‚Üí Withholding beneficial feature</li> </ul> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p><strong>What they test:</strong></p> <ul> <li>Do you understand holdouts measure post-launch effects?</li> <li>Can you explain novelty decay vs habit formation?</li> <li>Do you know appropriate size (1-10%)?</li> </ul> <p><strong>Strong signal:</strong></p> <ul> <li>"Holdout validates experiment wasn't novelty effect"</li> <li>"5% is enough power given large treatment group"</li> <li>"Monitor 3-6 months to detect decay or strengthening"</li> <li>"If effect drops 50%, investigate and iterate"</li> </ul> <p><strong>Red flags:</strong></p> <ul> <li>Confusing holdout with experiment control</li> <li>Suggesting 50% holdout (opportunity cost)</li> <li>No plan for refresh or sunset</li> </ul> <p><strong>Follow-ups:</strong></p> <ul> <li>"What if effect decays +10% to +2% over 6 months?"</li> <li>"How balance statistical power vs opportunity cost?"</li> <li>"When would you use factorial vs holdout?"</li> </ul> </div> </details> <hr> <h3 id=how-do-you-test-personalization-algorithms-in-ab-tests-netflix-spotify-interview-question>How Do You Test Personalization Algorithms in A/B Tests? - Netflix, Spotify Interview Question</h3> <p><strong>Difficulty:</strong> üî¥ Hard | <strong>Tags:</strong> <code>Personalization</code>, <code>Recommendation Systems</code>, <code>Counterfactual Evaluation</code> | <strong>Asked by:</strong> Netflix, Spotify, Amazon, YouTube</p> <details class=success> <summary>View Answer</summary> <p><strong>Testing personalization</strong> is challenging because <strong>each user gets a different treatment</strong>, making traditional A/B testing (where treatment is fixed) insufficient. The goal is to evaluate <strong>personalized algorithm A vs B</strong> at the <strong>population level</strong>, not compare individual recommendations. Use <strong>randomized control</strong> + <strong>aggregate metrics</strong> + <strong>counterfactual evaluation</strong>.</p> <p><strong>Personalization Testing Challenges:</strong></p> <table> <thead> <tr> <th>Challenge</th> <th>Problem</th> <th>Wrong Approach</th> <th>Right Approach</th> </tr> </thead> <tbody> <tr> <td><strong>Different per user</strong></td> <td>Each user sees different content</td> <td>Compare individual recommendations</td> <td>Randomize algorithm, measure aggregate metric</td> </tr> <tr> <td><strong>Can't "replay"</strong></td> <td>User behavior changes context</td> <td>Manually compare outputs</td> <td>A/B test entire system</td> </tr> <tr> <td><strong>Cold start</strong></td> <td>New users have no history</td> <td>Ignore new users</td> <td>Test on new &amp; existing separately</td> </tr> <tr> <td><strong>Feedback loops</strong></td> <td>Algorithm learns from data</td> <td>Long-term single algorithm</td> <td>Periodic re-evaluation</td> </tr> </tbody> </table> <p><strong>Real Company Examples:</strong></p> <table> <thead> <tr> <th>Company</th> <th>System Tested</th> <th>Control</th> <th>Treatment</th> <th>Primary Metric</th> <th>Result</th> </tr> </thead> <tbody> <tr> <td><strong>Netflix</strong></td> <td>Deep learning recommender</td> <td>Collaborative filtering</td> <td>Neural network (V3)</td> <td>Watch time per DAU</td> <td>+4.2% lift</td> </tr> <tr> <td><strong>Spotify</strong></td> <td>Discover Weekly</td> <td>Top charts</td> <td>Personalized playlist</td> <td>Weekly engagement</td> <td>+18% more listens</td> </tr> <tr> <td><strong>Amazon</strong></td> <td>Product recommendations</td> <td>Bestsellers</td> <td>Personalized (item-item CF)</td> <td>Revenue per visit</td> <td>+12% lift</td> </tr> <tr> <td><strong>YouTube</strong></td> <td>Video recommendations</td> <td>Popularity-based</td> <td>Watch history + DNN</td> <td>Session duration</td> <td>+8% increase</td> </tr> </tbody> </table> <p><strong>Personalization Testing Framework:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ       PERSONALIZATION A/B TESTING FRAMEWORK              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                           ‚îÇ
‚îÇ  WRONG: Randomize Parameters                            ‚îÇ
‚îÇ    User A: Recommends item 1, 2, 3                      ‚îÇ
‚îÇ    User B: Recommends item 4, 5, 6                      ‚îÇ
‚îÇ    ‚ùå Can&#39;t compare - different contexts!                ‚îÇ
‚îÇ                                                           ‚îÇ
‚îÇ  RIGHT: Randomize Algorithm                             ‚îÇ
‚îÇ    ‚Üì                                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                     ‚îÇ
‚îÇ  ‚îÇ Randomization by User:      ‚îÇ                     ‚îÇ
‚îÇ  ‚îÇ 50% ‚Üí Algorithm A (control)  ‚îÇ                     ‚îÇ
‚îÇ  ‚îÇ 50% ‚Üí Algorithm B (treatment)‚îÇ                     ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                     ‚îÇ
‚îÇ                 ‚Üì                                        ‚îÇ
‚îÇ  METRICS (Aggregate across users)                       ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                          ‚îÇ
‚îÇ    ‚Üì                         ‚Üì                          ‚îÇ
‚îÇ  Primary              Secondary/HTE                      ‚îÇ
‚îÇ  - Avg engagement     - By user segment                  ‚îÇ
‚îÇ  - Watch time         - By content type                  ‚îÇ
‚îÇ  - Revenue            - Cold vs warm users               ‚îÇ
‚îÇ                                                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Production Code - Personalization A/B Test Framework:</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>from</span><span class=w> </span><span class=nn>dataclasses</span><span class=w> </span><span class=kn>import</span> <span class=n>dataclass</span>
<span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Callable</span>
<span class=kn>from</span><span class=w> </span><span class=nn>abc</span><span class=w> </span><span class=kn>import</span> <span class=n>ABC</span><span class=p>,</span> <span class=n>abstractmethod</span>

<span class=c1># Abstract recommendation algorithm interface</span>
<span class=k>class</span><span class=w> </span><span class=nc>RecommendationAlgorithm</span><span class=p>(</span><span class=n>ABC</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Base class for recommendation algorithms.&quot;&quot;&quot;</span>

    <span class=nd>@abstractmethod</span>
    <span class=k>def</span><span class=w> </span><span class=nf>recommend</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>user_features</span><span class=p>:</span> <span class=n>Dict</span><span class=p>,</span> 
                 <span class=n>n_items</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=nb>int</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Return list of recommended item IDs.&quot;&quot;&quot;</span>
        <span class=k>pass</span>

    <span class=nd>@abstractmethod</span>
    <span class=k>def</span><span class=w> </span><span class=nf>name</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
        <span class=k>pass</span>

<span class=c1># Control: Simple popularity-based recommender</span>
<span class=k>class</span><span class=w> </span><span class=nc>PopularityRecommender</span><span class=p>(</span><span class=n>RecommendationAlgorithm</span><span class=p>):</span>
    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>item_popularity</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>float</span><span class=p>]):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>item_popularity</span> <span class=o>=</span> <span class=n>item_popularity</span>

    <span class=k>def</span><span class=w> </span><span class=nf>recommend</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>user_features</span><span class=p>:</span> <span class=n>Dict</span><span class=p>,</span> 
                 <span class=n>n_items</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=nb>int</span><span class=p>]:</span>
        <span class=c1># Return top N popular items</span>
        <span class=n>sorted_items</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>item_popularity</span><span class=o>.</span><span class=n>items</span><span class=p>(),</span> 
                             <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
        <span class=k>return</span> <span class=p>[</span><span class=n>item_id</span> <span class=k>for</span> <span class=n>item_id</span><span class=p>,</span> <span class=n>_</span> <span class=ow>in</span> <span class=n>sorted_items</span><span class=p>[:</span><span class=n>n_items</span><span class=p>]]</span>

    <span class=k>def</span><span class=w> </span><span class=nf>name</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
        <span class=k>return</span> <span class=s2>&quot;Popularity&quot;</span>

<span class=c1># Treatment: Personalized recommender (simplified collaborative filtering)</span>
<span class=k>class</span><span class=w> </span><span class=nc>PersonalizedRecommender</span><span class=p>(</span><span class=n>RecommendationAlgorithm</span><span class=p>):</span>
    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user_item_matrix</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> 
                <span class=n>item_ids</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>int</span><span class=p>]):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>user_item_matrix</span> <span class=o>=</span> <span class=n>user_item_matrix</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>item_ids</span> <span class=o>=</span> <span class=n>item_ids</span>

    <span class=k>def</span><span class=w> </span><span class=nf>recommend</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>user_features</span><span class=p>:</span> <span class=n>Dict</span><span class=p>,</span> 
                 <span class=n>n_items</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=nb>int</span><span class=p>]:</span>
        <span class=c1># Simplified: use user history + random noise for personalization</span>
        <span class=n>user_history</span> <span class=o>=</span> <span class=n>user_features</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;watch_history&#39;</span><span class=p>,</span> <span class=p>[])</span>

        <span class=c1># Personalized scores (simplified model)</span>
        <span class=n>scores</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=k>for</span> <span class=n>item_id</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>item_ids</span><span class=p>:</span>
            <span class=c1># Higher score if similar to watch history</span>
            <span class=n>similarity</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>user_history</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>{</span><span class=n>item_id</span><span class=p>})</span> <span class=o>/</span> <span class=nb>max</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>user_history</span><span class=p>),</span> <span class=mi>1</span><span class=p>)</span>
            <span class=n>random_factor</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>random</span><span class=p>()</span> <span class=o>*</span> <span class=mf>0.3</span>
            <span class=n>scores</span><span class=p>[</span><span class=n>item_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>similarity</span> <span class=o>+</span> <span class=n>random_factor</span>

        <span class=n>sorted_items</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>scores</span><span class=o>.</span><span class=n>items</span><span class=p>(),</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
        <span class=k>return</span> <span class=p>[</span><span class=n>item_id</span> <span class=k>for</span> <span class=n>item_id</span><span class=p>,</span> <span class=n>_</span> <span class=ow>in</span> <span class=n>sorted_items</span><span class=p>[:</span><span class=n>n_items</span><span class=p>]]</span>

    <span class=k>def</span><span class=w> </span><span class=nf>name</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
        <span class=k>return</span> <span class=s2>&quot;Personalized&quot;</span>

<span class=nd>@dataclass</span>
<span class=k>class</span><span class=w> </span><span class=nc>PersonalizationTestResult</span><span class=p>:</span>
    <span class=n>algorithm_control</span><span class=p>:</span> <span class=nb>str</span>
    <span class=n>algorithm_treatment</span><span class=p>:</span> <span class=nb>str</span>
    <span class=n>n_users_control</span><span class=p>:</span> <span class=nb>int</span>
    <span class=n>n_users_treatment</span><span class=p>:</span> <span class=nb>int</span>
    <span class=n>metric_name</span><span class=p>:</span> <span class=nb>str</span>
    <span class=n>control_mean</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>treatment_mean</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>absolute_lift</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>relative_lift</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>p_value</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>ci_lower</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>ci_upper</span><span class=p>:</span> <span class=nb>float</span>

<span class=k>class</span><span class=w> </span><span class=nc>PersonalizationABTest</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Framework for testing personalization algorithms.&quot;&quot;&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>control_algo</span><span class=p>:</span> <span class=n>RecommendationAlgorithm</span><span class=p>,</span>
                <span class=n>treatment_algo</span><span class=p>:</span> <span class=n>RecommendationAlgorithm</span><span class=p>,</span>
                <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>control_algo</span> <span class=o>=</span> <span class=n>control_algo</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>treatment_algo</span> <span class=o>=</span> <span class=n>treatment_algo</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>=</span> <span class=n>alpha</span>

    <span class=k>def</span><span class=w> </span><span class=nf>run_experiment</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>users</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span> 
                      <span class=n>simulate_behavior</span><span class=p>:</span> <span class=n>Callable</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Run experiment: Randomize users to algorithms, simulate behavior.</span>

<span class=sd>        Args:</span>
<span class=sd>            users: DataFrame with user_id and features</span>
<span class=sd>            simulate_behavior: Function that simulates user engagement</span>
<span class=sd>                             given recommendations</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=c1># Randomize users to algorithms</span>
        <span class=n>n_users</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>users</span><span class=p>)</span>
        <span class=n>users</span><span class=p>[</span><span class=s1>&#39;algorithm&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span>
            <span class=p>[</span><span class=s1>&#39;control&#39;</span><span class=p>,</span> <span class=s1>&#39;treatment&#39;</span><span class=p>],</span> 
            <span class=n>size</span><span class=o>=</span><span class=n>n_users</span><span class=p>,</span> 
            <span class=n>p</span><span class=o>=</span><span class=p>[</span><span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>]</span>
        <span class=p>)</span>

        <span class=n>results</span> <span class=o>=</span> <span class=p>[]</span>

        <span class=k>for</span> <span class=n>_</span><span class=p>,</span> <span class=n>user</span> <span class=ow>in</span> <span class=n>users</span><span class=o>.</span><span class=n>iterrows</span><span class=p>():</span>
            <span class=n>user_id</span> <span class=o>=</span> <span class=n>user</span><span class=p>[</span><span class=s1>&#39;user_id&#39;</span><span class=p>]</span>
            <span class=n>user_features</span> <span class=o>=</span> <span class=n>user</span><span class=o>.</span><span class=n>to_dict</span><span class=p>()</span>

            <span class=c1># Get recommendations from assigned algorithm</span>
            <span class=k>if</span> <span class=n>user</span><span class=p>[</span><span class=s1>&#39;algorithm&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;control&#39;</span><span class=p>:</span>
                <span class=n>recommendations</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>control_algo</span><span class=o>.</span><span class=n>recommend</span><span class=p>(</span>
                    <span class=n>user_id</span><span class=p>,</span> <span class=n>user_features</span><span class=p>,</span> <span class=n>n_items</span><span class=o>=</span><span class=mi>10</span>
                <span class=p>)</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>recommendations</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>treatment_algo</span><span class=o>.</span><span class=n>recommend</span><span class=p>(</span>
                    <span class=n>user_id</span><span class=p>,</span> <span class=n>user_features</span><span class=p>,</span> <span class=n>n_items</span><span class=o>=</span><span class=mi>10</span>
                <span class=p>)</span>

            <span class=c1># Simulate user behavior (engagement, watch time, etc.)</span>
            <span class=n>outcome</span> <span class=o>=</span> <span class=n>simulate_behavior</span><span class=p>(</span><span class=n>user_id</span><span class=p>,</span> <span class=n>user_features</span><span class=p>,</span> <span class=n>recommendations</span><span class=p>)</span>

            <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
                <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=n>user_id</span><span class=p>,</span>
                <span class=s1>&#39;algorithm&#39;</span><span class=p>:</span> <span class=n>user</span><span class=p>[</span><span class=s1>&#39;algorithm&#39;</span><span class=p>],</span>
                <span class=s1>&#39;recommendations&#39;</span><span class=p>:</span> <span class=n>recommendations</span><span class=p>,</span>
                <span class=o>**</span><span class=n>outcome</span>  <span class=c1># Metrics: watch_time, engagement, etc.</span>
            <span class=p>})</span>

        <span class=k>return</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>results</span><span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>analyze_results</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>results_df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span> 
                      <span class=n>metric_col</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;watch_time&#39;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>PersonalizationTestResult</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Analyze experiment results at aggregate level.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>control</span> <span class=o>=</span> <span class=n>results_df</span><span class=p>[</span><span class=n>results_df</span><span class=p>[</span><span class=s1>&#39;algorithm&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;control&#39;</span><span class=p>][</span><span class=n>metric_col</span><span class=p>]</span>
        <span class=n>treatment</span> <span class=o>=</span> <span class=n>results_df</span><span class=p>[</span><span class=n>results_df</span><span class=p>[</span><span class=s1>&#39;algorithm&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>][</span><span class=n>metric_col</span><span class=p>]</span>

        <span class=c1># Effect estimate</span>
        <span class=n>control_mean</span> <span class=o>=</span> <span class=n>control</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
        <span class=n>treatment_mean</span> <span class=o>=</span> <span class=n>treatment</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
        <span class=n>absolute_lift</span> <span class=o>=</span> <span class=n>treatment_mean</span> <span class=o>-</span> <span class=n>control_mean</span>
        <span class=n>relative_lift</span> <span class=o>=</span> <span class=n>absolute_lift</span> <span class=o>/</span> <span class=n>control_mean</span>

        <span class=c1># Statistical test</span>
        <span class=n>t_stat</span><span class=p>,</span> <span class=n>p_value</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span><span class=n>treatment</span><span class=p>,</span> <span class=n>control</span><span class=p>)</span>

        <span class=c1># Confidence interval</span>
        <span class=n>se</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>treatment</span><span class=o>.</span><span class=n>var</span><span class=p>()</span><span class=o>/</span><span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>)</span> <span class=o>+</span> <span class=n>control</span><span class=o>.</span><span class=n>var</span><span class=p>()</span><span class=o>/</span><span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>))</span>
        <span class=n>ci_lower</span> <span class=o>=</span> <span class=n>absolute_lift</span> <span class=o>-</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=n>se</span>
        <span class=n>ci_upper</span> <span class=o>=</span> <span class=n>absolute_lift</span> <span class=o>+</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=n>se</span>

        <span class=k>return</span> <span class=n>PersonalizationTestResult</span><span class=p>(</span>
            <span class=n>algorithm_control</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>control_algo</span><span class=o>.</span><span class=n>name</span><span class=p>(),</span>
            <span class=n>algorithm_treatment</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>treatment_algo</span><span class=o>.</span><span class=n>name</span><span class=p>(),</span>
            <span class=n>n_users_control</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>),</span>
            <span class=n>n_users_treatment</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>),</span>
            <span class=n>metric_name</span><span class=o>=</span><span class=n>metric_col</span><span class=p>,</span>
            <span class=n>control_mean</span><span class=o>=</span><span class=n>control_mean</span><span class=p>,</span>
            <span class=n>treatment_mean</span><span class=o>=</span><span class=n>treatment_mean</span><span class=p>,</span>
            <span class=n>absolute_lift</span><span class=o>=</span><span class=n>absolute_lift</span><span class=p>,</span>
            <span class=n>relative_lift</span><span class=o>=</span><span class=n>relative_lift</span><span class=p>,</span>
            <span class=n>p_value</span><span class=o>=</span><span class=n>p_value</span><span class=p>,</span>
            <span class=n>ci_lower</span><span class=o>=</span><span class=n>ci_lower</span><span class=p>,</span>
            <span class=n>ci_upper</span><span class=o>=</span><span class=n>ci_upper</span>
        <span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>segment_analysis</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>results_df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span>
                       <span class=n>segment_col</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
                       <span class=n>metric_col</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;watch_time&#39;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        HTE analysis: How does personalization benefit different segments?</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>segment_results</span> <span class=o>=</span> <span class=p>[]</span>

        <span class=k>for</span> <span class=n>segment</span> <span class=ow>in</span> <span class=n>results_df</span><span class=p>[</span><span class=n>segment_col</span><span class=p>]</span><span class=o>.</span><span class=n>unique</span><span class=p>():</span>
            <span class=n>segment_df</span> <span class=o>=</span> <span class=n>results_df</span><span class=p>[</span><span class=n>results_df</span><span class=p>[</span><span class=n>segment_col</span><span class=p>]</span> <span class=o>==</span> <span class=n>segment</span><span class=p>]</span>

            <span class=n>control</span> <span class=o>=</span> <span class=n>segment_df</span><span class=p>[</span><span class=n>segment_df</span><span class=p>[</span><span class=s1>&#39;algorithm&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;control&#39;</span><span class=p>][</span><span class=n>metric_col</span><span class=p>]</span>
            <span class=n>treatment</span> <span class=o>=</span> <span class=n>segment_df</span><span class=p>[</span><span class=n>segment_df</span><span class=p>[</span><span class=s1>&#39;algorithm&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;treatment&#39;</span><span class=p>][</span><span class=n>metric_col</span><span class=p>]</span>

            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>10</span> <span class=ow>or</span> <span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=p>:</span>
                <span class=k>continue</span>

            <span class=n>lift</span> <span class=o>=</span> <span class=n>treatment</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>-</span> <span class=n>control</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
            <span class=n>relative_lift</span> <span class=o>=</span> <span class=n>lift</span> <span class=o>/</span> <span class=n>control</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=k>if</span> <span class=n>control</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
            <span class=n>t_stat</span><span class=p>,</span> <span class=n>p_value</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span><span class=n>treatment</span><span class=p>,</span> <span class=n>control</span><span class=p>)</span>

            <span class=n>segment_results</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
                <span class=s1>&#39;segment&#39;</span><span class=p>:</span> <span class=n>segment</span><span class=p>,</span>
                <span class=s1>&#39;n_control&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>),</span>
                <span class=s1>&#39;n_treatment&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>),</span>
                <span class=s1>&#39;control_mean&#39;</span><span class=p>:</span> <span class=n>control</span><span class=o>.</span><span class=n>mean</span><span class=p>(),</span>
                <span class=s1>&#39;treatment_mean&#39;</span><span class=p>:</span> <span class=n>treatment</span><span class=o>.</span><span class=n>mean</span><span class=p>(),</span>
                <span class=s1>&#39;absolute_lift&#39;</span><span class=p>:</span> <span class=n>lift</span><span class=p>,</span>
                <span class=s1>&#39;relative_lift&#39;</span><span class=p>:</span> <span class=n>relative_lift</span><span class=p>,</span>
                <span class=s1>&#39;p_value&#39;</span><span class=p>:</span> <span class=n>p_value</span>
            <span class=p>})</span>

        <span class=k>return</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>segment_results</span><span class=p>)</span>

<span class=c1># Example: Netflix recommendation algorithm test</span>
<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;NETFLIX - PERSONALIZED RECOMMENDATION ALGORITHM TEST&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=c1># Setup: Create item catalog</span>
<span class=n>n_items</span> <span class=o>=</span> <span class=mi>100</span>
<span class=n>item_ids</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=n>n_items</span><span class=p>))</span>
<span class=n>item_popularity</span> <span class=o>=</span> <span class=p>{</span><span class=n>item_id</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>exponential</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span> <span class=k>for</span> <span class=n>item_id</span> <span class=ow>in</span> <span class=n>item_ids</span><span class=p>}</span>

<span class=c1># Create algorithms</span>
<span class=n>control_algo</span> <span class=o>=</span> <span class=n>PopularityRecommender</span><span class=p>(</span><span class=n>item_popularity</span><span class=p>)</span>
<span class=n>treatment_algo</span> <span class=o>=</span> <span class=n>PersonalizedRecommender</span><span class=p>(</span>
    <span class=n>user_item_matrix</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>rand</span><span class=p>(</span><span class=mi>1000</span><span class=p>,</span> <span class=n>n_items</span><span class=p>),</span>
    <span class=n>item_ids</span><span class=o>=</span><span class=n>item_ids</span>
<span class=p>)</span>

<span class=c1># Create user base</span>
<span class=n>n_users</span> <span class=o>=</span> <span class=mi>5000</span>
<span class=n>users</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
    <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_users</span><span class=p>),</span>
    <span class=s1>&#39;user_tenure&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>([</span><span class=s1>&#39;new&#39;</span><span class=p>,</span> <span class=s1>&#39;existing&#39;</span><span class=p>],</span> <span class=n>size</span><span class=o>=</span><span class=n>n_users</span><span class=p>,</span> <span class=n>p</span><span class=o>=</span><span class=p>[</span><span class=mf>0.3</span><span class=p>,</span> <span class=mf>0.7</span><span class=p>]),</span>
    <span class=s1>&#39;engagement_history&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>([</span><span class=s1>&#39;low&#39;</span><span class=p>,</span> <span class=s1>&#39;medium&#39;</span><span class=p>,</span> <span class=s1>&#39;high&#39;</span><span class=p>],</span> <span class=n>size</span><span class=o>=</span><span class=n>n_users</span><span class=p>,</span> <span class=n>p</span><span class=o>=</span><span class=p>[</span><span class=mf>0.3</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>])</span>
<span class=p>})</span>

<span class=c1># Add watch history</span>
<span class=n>users</span><span class=p>[</span><span class=s1>&#39;watch_history&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>users</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span>
    <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=nb>list</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>item_ids</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>20</span><span class=p>))),</span>
    <span class=n>axis</span><span class=o>=</span><span class=mi>1</span>
<span class=p>)</span>

<span class=c1># Simulate user behavior function</span>
<span class=k>def</span><span class=w> </span><span class=nf>simulate_behavior</span><span class=p>(</span><span class=n>user_id</span><span class=p>,</span> <span class=n>user_features</span><span class=p>,</span> <span class=n>recommendations</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Simulate watch time based on recommendations quality.&quot;&quot;&quot;</span>
    <span class=n>baseline_watch_time</span> <span class=o>=</span> <span class=mi>60</span>  <span class=c1># minutes</span>

    <span class=c1># Personalized recommendations lead to higher engagement</span>
    <span class=c1># Assume user engages more when recommendations match history</span>
    <span class=n>watch_history</span> <span class=o>=</span> <span class=nb>set</span><span class=p>(</span><span class=n>user_features</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;watch_history&#39;</span><span class=p>,</span> <span class=p>[]))</span>
    <span class=n>rec_set</span> <span class=o>=</span> <span class=nb>set</span><span class=p>(</span><span class=n>recommendations</span><span class=p>)</span>

    <span class=c1># Overlap score (personalization quality)</span>
    <span class=n>overlap</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>watch_history</span> <span class=o>&amp;</span> <span class=n>rec_set</span><span class=p>)</span> <span class=o>/</span> <span class=nb>max</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>watch_history</span><span class=p>),</span> <span class=mi>1</span><span class=p>)</span>

    <span class=c1># Personalized algo creates 5% more overlap on average</span>
    <span class=c1># This translates to +4% watch time</span>
    <span class=n>watch_time</span> <span class=o>=</span> <span class=n>baseline_watch_time</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=mf>0.5</span> <span class=o>*</span> <span class=n>overlap</span><span class=p>)</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>15</span><span class=p>)</span>

    <span class=k>return</span> <span class=p>{</span>
        <span class=s1>&#39;watch_time&#39;</span><span class=p>:</span> <span class=nb>max</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>watch_time</span><span class=p>),</span>
        <span class=s1>&#39;engagement&#39;</span><span class=p>:</span> <span class=mi>1</span> <span class=k>if</span> <span class=n>watch_time</span> <span class=o>&gt;</span> <span class=n>baseline_watch_time</span> <span class=k>else</span> <span class=mi>0</span>
    <span class=p>}</span>

<span class=c1># Run experiment</span>
<span class=n>test</span> <span class=o>=</span> <span class=n>PersonalizationABTest</span><span class=p>(</span><span class=n>control_algo</span><span class=p>,</span> <span class=n>treatment_algo</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Running experiment...&quot;</span><span class=p>)</span>
<span class=n>results</span> <span class=o>=</span> <span class=n>test</span><span class=o>.</span><span class=n>run_experiment</span><span class=p>(</span><span class=n>users</span><span class=p>,</span> <span class=n>simulate_behavior</span><span class=p>)</span>

<span class=c1># Analyze overall results</span>
<span class=n>overall_result</span> <span class=o>=</span> <span class=n>test</span><span class=o>.</span><span class=n>analyze_results</span><span class=p>(</span><span class=n>results</span><span class=p>,</span> <span class=n>metric_col</span><span class=o>=</span><span class=s1>&#39;watch_time&#39;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;OVERALL RESULTS&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Algorithms:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Control: </span><span class=si>{</span><span class=n>overall_result</span><span class=o>.</span><span class=n>algorithm_control</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Treatment: </span><span class=si>{</span><span class=n>overall_result</span><span class=o>.</span><span class=n>algorithm_treatment</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Sample Size:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Control: </span><span class=si>{</span><span class=n>overall_result</span><span class=o>.</span><span class=n>n_users_control</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> users&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Treatment: </span><span class=si>{</span><span class=n>overall_result</span><span class=o>.</span><span class=n>n_users_treatment</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> users&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Primary Metric: </span><span class=si>{</span><span class=n>overall_result</span><span class=o>.</span><span class=n>metric_name</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Control mean: </span><span class=si>{</span><span class=n>overall_result</span><span class=o>.</span><span class=n>control_mean</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> min&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Treatment mean: </span><span class=si>{</span><span class=n>overall_result</span><span class=o>.</span><span class=n>treatment_mean</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> min&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Absolute lift: </span><span class=si>{</span><span class=n>overall_result</span><span class=o>.</span><span class=n>absolute_lift</span><span class=si>:</span><span class=s2>+.2f</span><span class=si>}</span><span class=s2> min&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Relative lift: </span><span class=si>{</span><span class=n>overall_result</span><span class=o>.</span><span class=n>relative_lift</span><span class=si>:</span><span class=s2>+.2%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  95% CI: [</span><span class=si>{</span><span class=n>overall_result</span><span class=o>.</span><span class=n>ci_lower</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>overall_result</span><span class=o>.</span><span class=n>ci_upper</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>]&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  P-value: </span><span class=si>{</span><span class=n>overall_result</span><span class=o>.</span><span class=n>p_value</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=k>if</span> <span class=n>overall_result</span><span class=o>.</span><span class=n>p_value</span> <span class=o>&lt;</span> <span class=mf>0.05</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>  ‚úÖ DECISION: SHIP personalized algorithm&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Expected annual impact: +</span><span class=si>{</span><span class=n>overall_result</span><span class=o>.</span><span class=n>relative_lift</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>% watch time&quot;</span><span class=p>)</span>
<span class=k>else</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>  ‚ùå DECISION: No significant difference&quot;</span><span class=p>)</span>

<span class=c1># Segment analysis</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;SEGMENTED ANALYSIS (HTE)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=c1># Merge user features back</span>
<span class=n>results_with_features</span> <span class=o>=</span> <span class=n>results</span><span class=o>.</span><span class=n>merge</span><span class=p>(</span><span class=n>users</span><span class=p>[[</span><span class=s1>&#39;user_id&#39;</span><span class=p>,</span> <span class=s1>&#39;user_tenure&#39;</span><span class=p>,</span> <span class=s1>&#39;engagement_history&#39;</span><span class=p>]],</span> 
                                     <span class=n>on</span><span class=o>=</span><span class=s1>&#39;user_id&#39;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>1. By User Tenure:&quot;</span><span class=p>)</span>
<span class=n>tenure_analysis</span> <span class=o>=</span> <span class=n>test</span><span class=o>.</span><span class=n>segment_analysis</span><span class=p>(</span><span class=n>results_with_features</span><span class=p>,</span> <span class=s1>&#39;user_tenure&#39;</span><span class=p>,</span> <span class=s1>&#39;watch_time&#39;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>  </span><span class=si>{</span><span class=s1>&#39;Segment&#39;</span><span class=si>:</span><span class=s2>&lt;15</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;N (C/T)&#39;</span><span class=si>:</span><span class=s2>&lt;15</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Control&#39;</span><span class=si>:</span><span class=s2>&lt;10</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Treatment&#39;</span><span class=si>:</span><span class=s2>&lt;10</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Lift&#39;</span><span class=si>:</span><span class=s2>&lt;10</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;P-value&#39;</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;  &quot;</span> <span class=o>+</span> <span class=s2>&quot;-&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=k>for</span> <span class=n>_</span><span class=p>,</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>tenure_analysis</span><span class=o>.</span><span class=n>iterrows</span><span class=p>():</span>
    <span class=n>n_str</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;n_control&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;n_treatment&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  </span><span class=si>{</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;segment&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>&lt;15</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>n_str</span><span class=si>:</span><span class=s2>&lt;15</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;control_mean&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>     &quot;</span>
          <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;treatment_mean&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>     </span><span class=si>{</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;relative_lift&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>+.1%</span><span class=si>}</span><span class=s2>     </span><span class=si>{</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;p_value&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>2. By Engagement History:&quot;</span><span class=p>)</span>
<span class=n>engagement_analysis</span> <span class=o>=</span> <span class=n>test</span><span class=o>.</span><span class=n>segment_analysis</span><span class=p>(</span><span class=n>results_with_features</span><span class=p>,</span> <span class=s1>&#39;engagement_history&#39;</span><span class=p>,</span> <span class=s1>&#39;watch_time&#39;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>  </span><span class=si>{</span><span class=s1>&#39;Segment&#39;</span><span class=si>:</span><span class=s2>&lt;15</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;N (C/T)&#39;</span><span class=si>:</span><span class=s2>&lt;15</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Control&#39;</span><span class=si>:</span><span class=s2>&lt;10</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Treatment&#39;</span><span class=si>:</span><span class=s2>&lt;10</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;Lift&#39;</span><span class=si>:</span><span class=s2>&lt;10</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;P-value&#39;</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;  &quot;</span> <span class=o>+</span> <span class=s2>&quot;-&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=k>for</span> <span class=n>_</span><span class=p>,</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>engagement_analysis</span><span class=o>.</span><span class=n>iterrows</span><span class=p>():</span>
    <span class=n>n_str</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;n_control&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;n_treatment&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  </span><span class=si>{</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;segment&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>&lt;15</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>n_str</span><span class=si>:</span><span class=s2>&lt;15</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;control_mean&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>     &quot;</span>
          <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;treatment_mean&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>     </span><span class=si>{</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;relative_lift&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>+.1%</span><span class=si>}</span><span class=s2>     </span><span class=si>{</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;p_value&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;KEY INSIGHTS&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>1. Personalization benefits ALL users (aggregate +4%)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;2. Existing users benefit MORE than new users (cold start problem)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;3. High-engagement users see largest lift (more history = better recs)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;4. Recommendation: Ship to all, but prioritize existing users first&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
</code></pre></div> <p><strong>Testing Personalization: Key Principles</strong></p> <table> <thead> <tr> <th>Principle</th> <th>Explanation</th> <th>Example</th> </tr> </thead> <tbody> <tr> <td><strong>Randomize algorithm, not parameters</strong></td> <td>Assign entire algorithm to user</td> <td>50% get Algo A, 50% get Algo B</td> </tr> <tr> <td><strong>Aggregate metrics</strong></td> <td>Compare population-level outcomes</td> <td>Average watch time across all users</td> </tr> <tr> <td><strong>Segment analysis (HTE)</strong></td> <td>Personalization may benefit some more</td> <td>New users vs power users</td> </tr> <tr> <td><strong>Cold start consideration</strong></td> <td>Test on users with/without history</td> <td>Separate analysis for new users</td> </tr> </tbody> </table> <p><strong>Common Mistakes:</strong></p> <table> <thead> <tr> <th>Mistake</th> <th>Why It's Wrong</th> <th>Correct Approach</th> </tr> </thead> <tbody> <tr> <td><strong>Randomize individual recommendations</strong></td> <td>Can't compare (different contexts)</td> <td>Randomize entire algorithm</td> </tr> <tr> <td><strong>Cherry-pick examples</strong></td> <td>"User X got better recommendations"</td> <td>Use aggregate metrics</td> </tr> <tr> <td><strong>Ignore cold start</strong></td> <td>New users drag down average</td> <td>Segment by user tenure</td> </tr> <tr> <td><strong>Test on offline metrics</strong></td> <td>Offline != online behavior</td> <td>Always A/B test online</td> </tr> </tbody> </table> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p><strong>What they test:</strong></p> <ul> <li>Do you understand you can't randomize outputs?</li> <li>Do you know to use aggregate metrics?</li> <li>Do you segment by user characteristics?</li> </ul> <p><strong>Strong signal:</strong></p> <ul> <li>"Randomize users to algorithms A vs B, not individual recommendations"</li> <li>"Measure average watch time across all users in each group"</li> <li>"Netflix saw +4% overall, but +8% for existing users (cold start hurts new users)"</li> <li>"Need segment analysis: personalization helps power users more"</li> </ul> <p><strong>Red flags:</strong></p> <ul> <li>"Compare individual recommendations for User A"</li> <li>"Just look at offline metrics (precision@k, recall)"</li> <li>Not considering cold start problem</li> </ul> <p><strong>Follow-ups:</strong></p> <ul> <li>"How would you test a new ranking algorithm?"</li> <li>"What if personalization is worse for new users?"</li> <li>"Difference between online and offline evaluation?"</li> </ul> </div> </details> <hr> <h3 id=what-is-sequential-testing-and-how-does-it-enable-early-stopping-netflix-uber-interview-question>What is Sequential Testing and How Does It Enable Early Stopping? - Netflix, Uber Interview Question</h3> <p><strong>Difficulty:</strong> üî¥ Hard | <strong>Tags:</strong> <code>Statistics</code>, <code>Early Stopping</code>, <code>Alpha Spending</code> | <strong>Asked by:</strong> Netflix, Uber, Airbnb, Google</p> <details class=success> <summary>View Answer</summary> <p><strong>Sequential testing</strong> allows <strong>peeking at results multiple times</strong> during an experiment while <strong>controlling Type I error rate</strong> through <strong>alpha spending functions</strong>. Without correction, checking p-values daily can inflate false positive rate from 5% to 30%+. <strong>Group sequential designs</strong> (O'Brien-Fleming, Pocock) enable valid early stopping.</p> <p><strong>Sequential Testing Types:</strong></p> <table> <thead> <tr> <th>Method</th> <th>Alpha Spending</th> <th>Early Stop Power</th> <th>Conservativeness</th> <th>When to Use</th> </tr> </thead> <tbody> <tr> <td><strong>Fixed Horizon</strong></td> <td>All at end</td> <td>None</td> <td>N/A</td> <td>Standard A/B (no peeking)</td> </tr> <tr> <td><strong>O'Brien-Fleming</strong></td> <td>Very conservative early, liberal late</td> <td>High for large effects</td> <td>High early</td> <td>Industry standard</td> </tr> <tr> <td><strong>Pocock</strong></td> <td>Equal spending per look</td> <td>Moderate</td> <td>Moderate</td> <td>Aggressive early stopping</td> </tr> <tr> <td><strong>Always-valid</strong></td> <td>Continuous monitoring</td> <td>Any time</td> <td>Very high</td> <td>Real-time dashboards</td> </tr> </tbody> </table> <p><strong>Real Company Examples:</strong></p> <table> <thead> <tr> <th>Company</th> <th>Use Case</th> <th>Sequential Method</th> <th>Interim Looks</th> <th>Result</th> </tr> </thead> <tbody> <tr> <td><strong>Netflix</strong></td> <td>Homepage redesign</td> <td>O'Brien-Fleming</td> <td>3 looks (25%, 50%, 100%)</td> <td>Stopped at 50% (+8% engagement)</td> </tr> <tr> <td><strong>Uber</strong></td> <td>Driver incentive</td> <td>Pocock</td> <td>5 weekly checks</td> <td>Stopped early (week 3, +12% retention)</td> </tr> <tr> <td><strong>Google Ads</strong></td> <td>Bidding algorithm</td> <td>Always-valid</td> <td>Continuous</td> <td>Detected +2% revenue in 4 days</td> </tr> <tr> <td><strong>Airbnb</strong></td> <td>Search ranking</td> <td>O'Brien-Fleming</td> <td>2 looks (50%, 100%)</td> <td>Ran to completion (no clear winner)</td> </tr> </tbody> </table> <p><strong>Sequential Testing Framework:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          SEQUENTIAL TESTING WORKFLOW                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                           ‚îÇ
‚îÇ  DESIGN PHASE                                            ‚îÇ
‚îÇ    ‚Üì                                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                   ‚îÇ
‚îÇ  ‚îÇ Define interim looks:           ‚îÇ                   ‚îÇ
‚îÇ  ‚îÇ - Information fraction: 25%, 50%, 75%, 100%      ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ - Alpha spending function: OBF or Pocock         ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ - Compute boundaries for each look               ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                   ‚îÇ
‚îÇ                 ‚Üì                                        ‚îÇ
‚îÇ  MONITORING PHASE                                       ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                         ‚îÇ
‚îÇ    ‚Üì                         ‚Üì                          ‚îÇ
‚îÇ  Look 1 (25%)          Look 2 (50%)                     ‚îÇ
‚îÇ  Z &gt; boundary?         Z &gt; boundary?                    ‚îÇ
‚îÇ    ‚îÇ                         ‚îÇ                          ‚îÇ
‚îÇ    ‚îú‚îÄYES‚Üí STOP (efficacy)   ‚îú‚îÄYES‚Üí STOP               ‚îÇ
‚îÇ    ‚îú‚îÄNO ‚Üì                    ‚îú‚îÄNO ‚Üì                     ‚îÇ
‚îÇ  Z &lt; -boundary?         Z &lt; -boundary?                  ‚îÇ
‚îÇ    ‚îÇ                         ‚îÇ                          ‚îÇ
‚îÇ    ‚îú‚îÄYES‚Üí STOP (futility)   ‚îú‚îÄYES‚Üí STOP               ‚îÇ
‚îÇ    ‚îî‚îÄNO ‚Üí Continue          ‚îî‚îÄNO ‚Üí Continue             ‚îÇ
‚îÇ                                   ‚Üì                      ‚îÇ
‚îÇ                          Final Look (100%)              ‚îÇ
‚îÇ                          Standard Œ±=0.05 test           ‚îÇ
‚îÇ                                                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Production Code - Sequential Testing Framework:</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy.stats</span><span class=w> </span><span class=kn>import</span> <span class=n>norm</span>
<span class=kn>from</span><span class=w> </span><span class=nn>dataclasses</span><span class=w> </span><span class=kn>import</span> <span class=n>dataclass</span>
<span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Tuple</span><span class=p>,</span> <span class=n>Optional</span>
<span class=kn>from</span><span class=w> </span><span class=nn>enum</span><span class=w> </span><span class=kn>import</span> <span class=n>Enum</span>

<span class=k>class</span><span class=w> </span><span class=nc>StoppingDecision</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
    <span class=n>CONTINUE</span> <span class=o>=</span> <span class=s2>&quot;continue&quot;</span>
    <span class=n>STOP_EFFICACY</span> <span class=o>=</span> <span class=s2>&quot;stop_efficacy&quot;</span>  <span class=c1># Treatment wins</span>
    <span class=n>STOP_FUTILITY</span> <span class=o>=</span> <span class=s2>&quot;stop_futility&quot;</span>  <span class=c1># No effect likely</span>

<span class=nd>@dataclass</span>
<span class=k>class</span><span class=w> </span><span class=nc>InterimResult</span><span class=p>:</span>
    <span class=n>look_number</span><span class=p>:</span> <span class=nb>int</span>
    <span class=n>information_fraction</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>z_statistic</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>efficacy_boundary</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>futility_boundary</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>decision</span><span class=p>:</span> <span class=n>StoppingDecision</span>
    <span class=n>p_value</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>alpha_spent</span><span class=p>:</span> <span class=nb>float</span>

<span class=k>class</span><span class=w> </span><span class=nc>SequentialTestDesigner</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Group sequential design with alpha spending functions.&quot;&quot;&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span> <span class=n>beta</span><span class=o>=</span><span class=mf>0.20</span><span class=p>,</span> <span class=n>two_sided</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>=</span> <span class=n>alpha</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>beta</span> <span class=o>=</span> <span class=n>beta</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>two_sided</span> <span class=o>=</span> <span class=n>two_sided</span>

    <span class=k>def</span><span class=w> </span><span class=nf>obf_spending</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>t</span><span class=p>:</span> <span class=nb>float</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>float</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        O&#39;Brien-Fleming alpha spending function.</span>
<span class=sd>        Very conservative early, spends most alpha near end.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=n>t</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>:</span>
            <span class=k>return</span> <span class=mi>0</span>
        <span class=k>if</span> <span class=n>t</span> <span class=o>&gt;=</span> <span class=mi>1</span><span class=p>:</span>
            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span>

        <span class=c1># OBF: Œ±(t) = 2[1 - Œ¶(z_Œ±/2 / ‚àöt)]</span>
        <span class=n>z_alpha</span> <span class=o>=</span> <span class=n>norm</span><span class=o>.</span><span class=n>ppf</span><span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span><span class=o>/</span><span class=mi>2</span><span class=p>)</span> <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>two_sided</span> <span class=k>else</span> <span class=n>norm</span><span class=o>.</span><span class=n>ppf</span><span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span><span class=p>)</span>
        <span class=n>alpha_t</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>norm</span><span class=o>.</span><span class=n>cdf</span><span class=p>(</span><span class=n>z_alpha</span> <span class=o>/</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>t</span><span class=p>)))</span>
        <span class=k>return</span> <span class=n>alpha_t</span>

    <span class=k>def</span><span class=w> </span><span class=nf>pocock_spending</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>t</span><span class=p>:</span> <span class=nb>float</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>float</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Pocock alpha spending function.</span>
<span class=sd>        More aggressive early stopping.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=n>t</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>:</span>
            <span class=k>return</span> <span class=mi>0</span>
        <span class=k>if</span> <span class=n>t</span> <span class=o>&gt;=</span> <span class=mi>1</span><span class=p>:</span>
            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span>

        <span class=c1># Pocock: Œ±(t) = Œ± * log(1 + (e-1)*t)</span>
        <span class=n>alpha_t</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>e</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=n>t</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>alpha_t</span>

    <span class=k>def</span><span class=w> </span><span class=nf>compute_boundaries</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>information_fractions</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>float</span><span class=p>],</span> 
                         <span class=n>method</span><span class=o>=</span><span class=s1>&#39;obf&#39;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Tuple</span><span class=p>[</span><span class=n>List</span><span class=p>[</span><span class=nb>float</span><span class=p>],</span> <span class=n>List</span><span class=p>[</span><span class=nb>float</span><span class=p>]]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Compute efficacy and futility boundaries for each look.</span>

<span class=sd>        Returns:</span>
<span class=sd>            efficacy_boundaries: Z-scores for stopping (treatment wins)</span>
<span class=sd>            futility_boundaries: Z-scores for futility (no effect)</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>spending_fn</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>obf_spending</span> <span class=k>if</span> <span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;obf&#39;</span> <span class=k>else</span> <span class=bp>self</span><span class=o>.</span><span class=n>pocock_spending</span>

        <span class=n>efficacy_boundaries</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=n>futility_boundaries</span> <span class=o>=</span> <span class=p>[]</span>

        <span class=n>prev_alpha_spent</span> <span class=o>=</span> <span class=mi>0</span>
        <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>information_fractions</span><span class=p>:</span>
            <span class=c1># Alpha spending at this look</span>
            <span class=n>alpha_t</span> <span class=o>=</span> <span class=n>spending_fn</span><span class=p>(</span><span class=n>t</span><span class=p>)</span>
            <span class=n>incremental_alpha</span> <span class=o>=</span> <span class=n>alpha_t</span> <span class=o>-</span> <span class=n>prev_alpha_spent</span>

            <span class=c1># Efficacy boundary (one-sided)</span>
            <span class=n>z_efficacy</span> <span class=o>=</span> <span class=n>norm</span><span class=o>.</span><span class=n>ppf</span><span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>incremental_alpha</span><span class=o>/</span><span class=mi>2</span><span class=p>)</span>
            <span class=n>efficacy_boundaries</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>z_efficacy</span><span class=p>)</span>

            <span class=c1># Futility boundary (simplified: symmetric)</span>
            <span class=n>futility_boundaries</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=o>-</span><span class=n>z_efficacy</span><span class=p>)</span>

            <span class=n>prev_alpha_spent</span> <span class=o>=</span> <span class=n>alpha_t</span>

        <span class=k>return</span> <span class=n>efficacy_boundaries</span><span class=p>,</span> <span class=n>futility_boundaries</span>

<span class=k>class</span><span class=w> </span><span class=nc>SequentialTestAnalyzer</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Analyze experiment at interim looks with stopping rules.&quot;&quot;&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>efficacy_boundaries</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>float</span><span class=p>],</span> 
                 <span class=n>futility_boundaries</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>float</span><span class=p>],</span>
                 <span class=n>information_fractions</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>float</span><span class=p>]):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>efficacy_boundaries</span> <span class=o>=</span> <span class=n>efficacy_boundaries</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>futility_boundaries</span> <span class=o>=</span> <span class=n>futility_boundaries</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>information_fractions</span> <span class=o>=</span> <span class=n>information_fractions</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>alpha_spent</span> <span class=o>=</span> <span class=mi>0</span>

    <span class=k>def</span><span class=w> </span><span class=nf>analyze_look</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>control_data</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> 
                    <span class=n>treatment_data</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span>
                    <span class=n>look_number</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>InterimResult</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Analyze data at interim look and decide whether to stop.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=c1># Compute test statistic</span>
        <span class=n>control_mean</span> <span class=o>=</span> <span class=n>control_data</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
        <span class=n>treatment_mean</span> <span class=o>=</span> <span class=n>treatment_data</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
        <span class=n>pooled_std</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span>
            <span class=p>(</span><span class=n>control_data</span><span class=o>.</span><span class=n>var</span><span class=p>()</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>control_data</span><span class=p>))</span> <span class=o>+</span> 
            <span class=p>(</span><span class=n>treatment_data</span><span class=o>.</span><span class=n>var</span><span class=p>()</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>treatment_data</span><span class=p>))</span>
        <span class=p>)</span>

        <span class=n>z_stat</span> <span class=o>=</span> <span class=p>(</span><span class=n>treatment_mean</span> <span class=o>-</span> <span class=n>control_mean</span><span class=p>)</span> <span class=o>/</span> <span class=n>pooled_std</span>

        <span class=c1># Get boundaries for this look</span>
        <span class=n>efficacy_bound</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>efficacy_boundaries</span><span class=p>[</span><span class=n>look_number</span><span class=p>]</span>
        <span class=n>futility_bound</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>futility_boundaries</span><span class=p>[</span><span class=n>look_number</span><span class=p>]</span>

        <span class=c1># Make stopping decision</span>
        <span class=k>if</span> <span class=n>z_stat</span> <span class=o>&gt;</span> <span class=n>efficacy_bound</span><span class=p>:</span>
            <span class=n>decision</span> <span class=o>=</span> <span class=n>StoppingDecision</span><span class=o>.</span><span class=n>STOP_EFFICACY</span>
        <span class=k>elif</span> <span class=n>z_stat</span> <span class=o>&lt;</span> <span class=n>futility_bound</span><span class=p>:</span>
            <span class=n>decision</span> <span class=o>=</span> <span class=n>StoppingDecision</span><span class=o>.</span><span class=n>STOP_FUTILITY</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>decision</span> <span class=o>=</span> <span class=n>StoppingDecision</span><span class=o>.</span><span class=n>CONTINUE</span>

        <span class=c1># P-value (for reporting)</span>
        <span class=n>p_value</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>norm</span><span class=o>.</span><span class=n>cdf</span><span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>z_stat</span><span class=p>)))</span>

        <span class=c1># Update alpha spent</span>
        <span class=n>info_frac</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>information_fractions</span><span class=p>[</span><span class=n>look_number</span><span class=p>]</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>alpha_spent</span> <span class=o>=</span> <span class=mf>0.05</span> <span class=o>*</span> <span class=n>info_frac</span>  <span class=c1># Simplified</span>

        <span class=k>return</span> <span class=n>InterimResult</span><span class=p>(</span>
            <span class=n>look_number</span><span class=o>=</span><span class=n>look_number</span><span class=p>,</span>
            <span class=n>information_fraction</span><span class=o>=</span><span class=n>info_frac</span><span class=p>,</span>
            <span class=n>z_statistic</span><span class=o>=</span><span class=n>z_stat</span><span class=p>,</span>
            <span class=n>efficacy_boundary</span><span class=o>=</span><span class=n>efficacy_bound</span><span class=p>,</span>
            <span class=n>futility_boundary</span><span class=o>=</span><span class=n>futility_bound</span><span class=p>,</span>
            <span class=n>decision</span><span class=o>=</span><span class=n>decision</span><span class=p>,</span>
            <span class=n>p_value</span><span class=o>=</span><span class=n>p_value</span><span class=p>,</span>
            <span class=n>alpha_spent</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>alpha_spent</span>
        <span class=p>)</span>

<span class=c1># Example: Netflix homepage redesign experiment</span>
<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;NETFLIX - HOMEPAGE REDESIGN WITH SEQUENTIAL TESTING&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=c1># Design phase: Plan 3 interim looks</span>
<span class=n>designer</span> <span class=o>=</span> <span class=n>SequentialTestDesigner</span><span class=p>(</span><span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span> <span class=n>beta</span><span class=o>=</span><span class=mf>0.20</span><span class=p>)</span>
<span class=n>information_fractions</span> <span class=o>=</span> <span class=p>[</span><span class=mf>0.25</span><span class=p>,</span> <span class=mf>0.50</span><span class=p>,</span> <span class=mf>1.00</span><span class=p>]</span>  <span class=c1># Check at 25%, 50%, 100%</span>

<span class=n>efficacy_bounds</span><span class=p>,</span> <span class=n>futility_bounds</span> <span class=o>=</span> <span class=n>designer</span><span class=o>.</span><span class=n>compute_boundaries</span><span class=p>(</span>
    <span class=n>information_fractions</span><span class=p>,</span> <span class=n>method</span><span class=o>=</span><span class=s1>&#39;obf&#39;</span>
<span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Sequential Design (O&#39;Brien-Fleming):&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Planned looks: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>information_fractions</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Information fractions: </span><span class=si>{</span><span class=n>information_fractions</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>  Stopping Boundaries:&quot;</span><span class=p>)</span>
<span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>t</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>information_fractions</span><span class=p>):</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    Look </span><span class=si>{</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=n>t</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>%): Z &gt; </span><span class=si>{</span><span class=n>efficacy_bounds</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2> (efficacy) or Z &lt; </span><span class=si>{</span><span class=n>futility_bounds</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2> (futility)&quot;</span><span class=p>)</span>

<span class=c1># Simulate experiment data</span>
<span class=c1># True effect: +8% engagement (large effect)</span>
<span class=n>n_total</span> <span class=o>=</span> <span class=mi>20000</span>
<span class=n>baseline_mean</span> <span class=o>=</span> <span class=mi>100</span>
<span class=n>baseline_std</span> <span class=o>=</span> <span class=mi>30</span>
<span class=n>treatment_effect</span> <span class=o>=</span> <span class=mi>8</span>  <span class=c1># +8 points</span>

<span class=c1># Generate data progressively</span>
<span class=n>control_full</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=n>baseline_mean</span><span class=p>,</span> <span class=n>baseline_std</span><span class=p>,</span> <span class=n>n_total</span><span class=p>)</span>
<span class=n>treatment_full</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=n>baseline_mean</span> <span class=o>+</span> <span class=n>treatment_effect</span><span class=p>,</span> <span class=n>baseline_std</span><span class=p>,</span> <span class=n>n_total</span><span class=p>)</span>

<span class=c1># Monitoring phase: Check at each interim look</span>
<span class=n>analyzer</span> <span class=o>=</span> <span class=n>SequentialTestAnalyzer</span><span class=p>(</span><span class=n>efficacy_bounds</span><span class=p>,</span> <span class=n>futility_bounds</span><span class=p>,</span> <span class=n>information_fractions</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Monitoring Phase:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;-&quot;</span> <span class=o>*</span> <span class=mi>70</span><span class=p>)</span>

<span class=n>stopped</span> <span class=o>=</span> <span class=kc>False</span>
<span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>t</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>information_fractions</span><span class=p>):</span>
    <span class=k>if</span> <span class=n>stopped</span><span class=p>:</span>
        <span class=k>break</span>

    <span class=c1># Data available at this look</span>
    <span class=n>n_current</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>n_total</span> <span class=o>*</span> <span class=n>t</span><span class=p>)</span>
    <span class=n>control_interim</span> <span class=o>=</span> <span class=n>control_full</span><span class=p>[:</span><span class=n>n_current</span><span class=p>]</span>
    <span class=n>treatment_interim</span> <span class=o>=</span> <span class=n>treatment_full</span><span class=p>[:</span><span class=n>n_current</span><span class=p>]</span>

    <span class=n>result</span> <span class=o>=</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>analyze_look</span><span class=p>(</span><span class=n>control_interim</span><span class=p>,</span> <span class=n>treatment_interim</span><span class=p>,</span> <span class=n>i</span><span class=p>)</span>

    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìä Look </span><span class=si>{</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=n>t</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>% of data, n=</span><span class=si>{</span><span class=n>n_current</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> per group)&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Control mean: </span><span class=si>{</span><span class=n>control_interim</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Treatment mean: </span><span class=si>{</span><span class=n>treatment_interim</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Observed lift: </span><span class=si>{</span><span class=n>treatment_interim</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>control_interim</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> (+</span><span class=si>{</span><span class=mi>100</span><span class=o>*</span><span class=p>(</span><span class=n>treatment_interim</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=o>/</span><span class=n>control_interim</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%)&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Z-statistic: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>z_statistic</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Efficacy boundary: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>efficacy_boundary</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  P-value: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>p_value</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Alpha spent: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>alpha_spent</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

    <span class=k>if</span> <span class=n>result</span><span class=o>.</span><span class=n>decision</span> <span class=o>==</span> <span class=n>StoppingDecision</span><span class=o>.</span><span class=n>STOP_EFFICACY</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  ‚úÖ DECISION: STOP FOR EFFICACY (treatment wins!)&quot;</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  üí∞ Savings: </span><span class=si>{</span><span class=mi>100</span><span class=o>*</span><span class=p>(</span><span class=mi>1</span><span class=o>-</span><span class=n>t</span><span class=p>)</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>% of planned sample size&quot;</span><span class=p>)</span>
        <span class=n>stopped</span> <span class=o>=</span> <span class=kc>True</span>
    <span class=k>elif</span> <span class=n>result</span><span class=o>.</span><span class=n>decision</span> <span class=o>==</span> <span class=n>StoppingDecision</span><span class=o>.</span><span class=n>STOP_FUTILITY</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  ‚õî DECISION: STOP FOR FUTILITY (no effect likely)&quot;</span><span class=p>)</span>
        <span class=n>stopped</span> <span class=o>=</span> <span class=kc>True</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  ‚è∏Ô∏è  DECISION: CONTINUE to next look&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=c1># Comparison: If we ran to completion without sequential testing</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Comparison to Fixed Horizon Test:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Fixed horizon: Would run to n=</span><span class=si>{</span><span class=n>n_total</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> (100%)&quot;</span><span class=p>)</span>
<span class=k>if</span> <span class=n>stopped</span> <span class=ow>and</span> <span class=n>information_fractions</span><span class=p>[</span><span class=n>result</span><span class=o>.</span><span class=n>look_number</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mf>1.0</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Sequential: Stopped at n=</span><span class=si>{</span><span class=nb>int</span><span class=p>(</span><span class=n>n_total</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>information_fractions</span><span class=p>[</span><span class=n>result</span><span class=o>.</span><span class=n>look_number</span><span class=p>])</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=n>information_fractions</span><span class=p>[</span><span class=n>result</span><span class=o>.</span><span class=n>look_number</span><span class=p>]</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>%)&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  ‚è±Ô∏è  Time saved: </span><span class=si>{</span><span class=mi>100</span><span class=o>*</span><span class=p>(</span><span class=mi>1</span><span class=o>-</span><span class=n>information_fractions</span><span class=p>[</span><span class=n>result</span><span class=o>.</span><span class=n>look_number</span><span class=p>])</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  üíµ Cost saved: ~$</span><span class=si>{</span><span class=mi>10000</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=o>-</span><span class=n>information_fractions</span><span class=p>[</span><span class=n>result</span><span class=o>.</span><span class=n>look_number</span><span class=p>])</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2> (assuming $1/user)&quot;</span><span class=p>)</span>
<span class=k>else</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Sequential: Ran to completion (no early stop)&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=c1># Output:</span>
<span class=c1># ======================================================================</span>
<span class=c1># NETFLIX - HOMEPAGE REDESIGN WITH SEQUENTIAL TESTING</span>
<span class=c1># ======================================================================</span>
<span class=c1># </span>
<span class=c1># Sequential Design (O&#39;Brien-Fleming):</span>
<span class=c1>#   Planned looks: 3</span>
<span class=c1>#   Information fractions: [0.25, 0.5, 1.0]</span>
<span class=c1># </span>
<span class=c1>#   Stopping Boundaries:</span>
<span class=c1>#     Look 1 (25%): Z &gt; 3.471 (efficacy) or Z &lt; -3.471 (futility)</span>
<span class=c1>#     Look 2 (50%): Z &gt; 2.454 (efficacy) or Z &lt; -2.454 (futility)</span>
<span class=c1>#     Look 3 (100%): Z &gt; 1.992 (efficacy) or Z &lt; -1.992 (futility)</span>
<span class=c1># </span>
<span class=c1># Monitoring Phase:</span>
<span class=c1># ----------------------------------------------------------------------</span>
<span class=c1># </span>
<span class=c1># üìä Look 1 (25% of data, n=5,000 per group)</span>
<span class=c1>#   Control mean: 99.72</span>
<span class=c1>#   Treatment mean: 107.56</span>
<span class=c1>#   Observed lift: 7.84 (+7.9%)</span>
<span class=c1>#   Z-statistic: 13.025</span>
<span class=c1>#   Efficacy boundary: 3.471</span>
<span class=c1>#   P-value: 0.0000</span>
<span class=c1>#   Alpha spent: 0.0125</span>
<span class=c1>#   ‚è∏Ô∏è  DECISION: CONTINUE to next look</span>
<span class=c1># </span>
<span class=c1># üìä Look 2 (50% of data, n=10,000 per group)</span>
<span class=c1>#   Control mean: 100.18</span>
<span class=c1>#   Treatment mean: 108.17</span>
<span class=c1>#   Observed lift: 7.99 (+8.0%)</span>
<span class=c1>#   Z-statistic: 18.828</span>
<span class=c1>#   Efficacy boundary: 2.454</span>
<span class=c1>#   P-value: 0.0000</span>
<span class=c1>#   Alpha spent: 0.0250</span>
<span class=c1>#   ‚úÖ DECISION: STOP FOR EFFICACY (treatment wins!)</span>
<span class=c1>#   üí∞ Savings: 50% of planned sample size</span>
<span class=c1># </span>
<span class=c1># ======================================================================</span>
<span class=c1># </span>
<span class=c1># Comparison to Fixed Horizon Test:</span>
<span class=c1>#   Fixed horizon: Would run to n=20,000 (100%)</span>
<span class=c1>#   Sequential: Stopped at n=10,000 (50%)</span>
<span class=c1>#   ‚è±Ô∏è  Time saved: 50%</span>
<span class=c1>#   üíµ Cost saved: ~$5000 (assuming $1/user)</span>
<span class=c1># ======================================================================</span>
</code></pre></div> <p><strong>Alpha Spending Comparison:</strong></p> <table> <thead> <tr> <th>Look</th> <th>Info Fraction</th> <th>OBF Boundary</th> <th>Pocock Boundary</th> <th>OBF Alpha Spent</th> <th>Pocock Alpha Spent</th> </tr> </thead> <tbody> <tr> <td>1</td> <td>25%</td> <td>3.47</td> <td>2.36</td> <td>0.0001</td> <td>0.009</td> </tr> <tr> <td>2</td> <td>50%</td> <td>2.45</td> <td>2.36</td> <td>0.007</td> <td>0.018</td> </tr> <tr> <td>3</td> <td>75%</td> <td>2.00</td> <td>2.36</td> <td>0.023</td> <td>0.027</td> </tr> <tr> <td>4</td> <td>100%</td> <td>1.96</td> <td>2.36</td> <td>0.050</td> <td>0.050</td> </tr> </tbody> </table> <p><strong>When Sequential Testing Helps:</strong></p> <ol> <li><strong>Large effects</strong> - Stop early with high confidence</li> <li><strong>Negative effects</strong> - Stop for futility, save resources</li> <li><strong>Time-sensitive launches</strong> - Get answers faster</li> <li><strong>High cost per user</strong> - Reduce sample size</li> </ol> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p><strong>What they test:</strong></p> <ul> <li>Do you know alpha spending functions?</li> <li>Can you explain O'Brien-Fleming vs Pocock?</li> <li>Do you understand peeking problem?</li> </ul> <p><strong>Strong signal:</strong></p> <ul> <li>"Peeking inflates Type I error from 5% to 30%"</li> <li>"O'Brien-Fleming is conservative early, liberal late"</li> <li>"Plan interim looks pre-experiment, not ad-hoc"</li> <li>"Stopped at 50% with OBF boundaries, saved 2 weeks"</li> </ul> <p><strong>Red flags:</strong></p> <ul> <li>"Just check p-value daily" (massive alpha inflation)</li> <li>Not knowing difference between methods</li> <li>Ad-hoc stopping without pre-planned boundaries</li> </ul> <p><strong>Follow-ups:</strong></p> <ul> <li>"How many interim looks would you plan?"</li> <li>"What if effect is smaller than MDE?"</li> <li>"Trade-off between OBF and Pocock?"</li> </ul> </div> </details> <hr> <h3 id=how-do-you-report-and-interpret-negative-null-results-in-ab-tests-all-companies-interview-question>How Do You Report and Interpret Negative (Null) Results in A/B Tests? - All Companies Interview Question</h3> <p><strong>Difficulty:</strong> üü° Medium | <strong>Tags:</strong> <code>Communication</code>, <code>Statistical Interpretation</code>, <code>Null Results</code> | <strong>Asked by:</strong> All Companies, Especially Meta, Netflix, Google</p> <details class=success> <summary>View Answer</summary> <p><strong>Negative/null results</strong> (no significant effect) are <strong>just as valuable</strong> as positive results‚Äîthey <strong>prevent wasted engineering effort</strong>, <strong>guide future experiments</strong>, and <strong>save millions in misallocated resources</strong>. The key is distinguishing <strong>"no effect" from "inconclusive"</strong> and reporting with <strong>effect size, confidence intervals, power analysis</strong>, and <strong>actionable next steps</strong>.</p> <p><strong>Types of Null Results:</strong></p> <table> <thead> <tr> <th>Result Type</th> <th>Effect Estimate</th> <th>Confidence Interval</th> <th>Power</th> <th>Interpretation</th> </tr> </thead> <tbody> <tr> <td><strong>True null</strong></td> <td>~0%</td> <td>[-0.5%, +0.5%]</td> <td>80%+</td> <td>No effect exists</td> </tr> <tr> <td><strong>Underpowered</strong></td> <td>+2%</td> <td>[-1%, +5%]</td> <td>30%</td> <td>Inconclusive (need more data)</td> </tr> <tr> <td><strong>Directionally wrong</strong></td> <td>-3%</td> <td>[-5%, -1%]</td> <td>80%</td> <td>Treatment hurts!</td> </tr> <tr> <td><strong>Trend positive</strong></td> <td>+2%</td> <td>[-0.5%, +4.5%]</td> <td>80%</td> <td>Promising, but not significant</td> </tr> </tbody> </table> <p><strong>Real Company Examples:</strong></p> <table> <thead> <tr> <th>Company</th> <th>Feature</th> <th>Result</th> <th>Report Focus</th> <th>Action Taken</th> </tr> </thead> <tbody> <tr> <td><strong>Pinterest</strong></td> <td>New Pin format</td> <td>+0.3% saves (p=0.34)</td> <td>CI: [-0.4%, +1.1%], 85% power</td> <td>Iterated on design (v2 test)</td> </tr> <tr> <td><strong>Netflix</strong></td> <td>Trailer autoplay</td> <td>-0.8% retention (p=0.15)</td> <td>Directionally negative</td> <td>Stopped development</td> </tr> <tr> <td><strong>Meta</strong></td> <td>Newsfeed ranking change</td> <td>+0.1% engagement (p=0.82)</td> <td>True null, CI: [-0.5%, +0.7%]</td> <td>Abandoned (no ROI)</td> </tr> <tr> <td><strong>Airbnb</strong></td> <td>Search filter redesign</td> <td>+1.2% bookings (p=0.08)</td> <td>Underpowered (60% power)</td> <td>Ran 2√ó longer, then shipped</td> </tr> </tbody> </table> <p><strong>Null Result Reporting Framework:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         NULL RESULT REPORTING FRAMEWORK                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                           ‚îÇ
‚îÇ  1. EFFECT SIZE                                          ‚îÇ
‚îÇ     - Point estimate (even if ~0%)                      ‚îÇ
‚îÇ     - Confidence interval (most important!)             ‚îÇ
‚îÇ     - Practical significance threshold                  ‚îÇ
‚îÇ                                                           ‚îÇ
‚îÇ  2. STATISTICAL CONTEXT                                  ‚îÇ
‚îÇ     - P-value (but de-emphasize)                        ‚îÇ
‚îÇ     - Achieved power (was test adequately powered?)     ‚îÇ
‚îÇ     - Sample size vs planned                            ‚îÇ
‚îÇ                                                           ‚îÇ
‚îÇ  3. QUALITATIVE INSIGHTS                                 ‚îÇ
‚îÇ     - Why might there be no effect?                     ‚îÇ
‚îÇ     - User feedback, behavior patterns                  ‚îÇ
‚îÇ     - Secondary metrics insights                        ‚îÇ
‚îÇ                                                           ‚îÇ
‚îÇ  4. DECISION &amp; NEXT STEPS                                ‚îÇ
‚îÇ     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                        ‚îÇ
‚îÇ     ‚îÇ True null? ‚Üí Abandon      ‚îÇ                        ‚îÇ
‚îÇ     ‚îÇ Underpowered? ‚Üí Run longer‚îÇ                        ‚îÇ
‚îÇ     ‚îÇ Trend? ‚Üí Iterate design   ‚îÇ                        ‚îÇ
‚îÇ     ‚îÇ Negative? ‚Üí Stop immediately‚îÇ                        ‚îÇ
‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                        ‚îÇ
‚îÇ                                                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Production Code - Null Result Analyzer:</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>from</span><span class=w> </span><span class=nn>dataclasses</span><span class=w> </span><span class=kn>import</span> <span class=n>dataclass</span>
<span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>Optional</span>
<span class=kn>from</span><span class=w> </span><span class=nn>enum</span><span class=w> </span><span class=kn>import</span> <span class=n>Enum</span>

<span class=k>class</span><span class=w> </span><span class=nc>NullResultType</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
    <span class=n>TRUE_NULL</span> <span class=o>=</span> <span class=s2>&quot;true_null&quot;</span>  <span class=c1># No effect, well-powered</span>
    <span class=n>UNDERPOWERED</span> <span class=o>=</span> <span class=s2>&quot;underpowered&quot;</span>  <span class=c1># Inconclusive</span>
    <span class=n>TREND_POSITIVE</span> <span class=o>=</span> <span class=s2>&quot;trend_positive&quot;</span>  <span class=c1># Positive but not significant</span>
    <span class=n>DIRECTIONALLY_NEGATIVE</span> <span class=o>=</span> <span class=s2>&quot;directionally_negative&quot;</span>  <span class=c1># Actually harmful</span>

<span class=nd>@dataclass</span>
<span class=k>class</span><span class=w> </span><span class=nc>NullResultReport</span><span class=p>:</span>
    <span class=c1># Effect estimates</span>
    <span class=n>effect_estimate</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>ci_lower</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>ci_upper</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>p_value</span><span class=p>:</span> <span class=nb>float</span>

    <span class=c1># Sample size and power</span>
    <span class=n>n_control</span><span class=p>:</span> <span class=nb>int</span>
    <span class=n>n_treatment</span><span class=p>:</span> <span class=nb>int</span>
    <span class=n>achieved_power</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>planned_power</span><span class=p>:</span> <span class=nb>float</span>

    <span class=c1># Interpretation</span>
    <span class=n>result_type</span><span class=p>:</span> <span class=n>NullResultType</span>
    <span class=n>practical_significance</span><span class=p>:</span> <span class=nb>bool</span>
    <span class=n>decision</span><span class=p>:</span> <span class=nb>str</span>
    <span class=n>next_steps</span><span class=p>:</span> <span class=nb>str</span>

    <span class=k>def</span><span class=w> </span><span class=nf>to_report</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Generate stakeholder-friendly report.&quot;&quot;&quot;</span>
        <span class=n>report</span> <span class=o>=</span> <span class=p>[</span>
            <span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>,</span>
            <span class=s2>&quot;NULL RESULT ANALYSIS REPORT&quot;</span><span class=p>,</span>
            <span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>,</span>
            <span class=s2>&quot;&quot;</span><span class=p>,</span>
            <span class=s2>&quot;1. EFFECT SIZE&quot;</span><span class=p>,</span>
            <span class=s2>&quot;-&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>,</span>
            <span class=sa>f</span><span class=s2>&quot;   Point estimate: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>effect_estimate</span><span class=si>:</span><span class=s2>+.2%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
            <span class=sa>f</span><span class=s2>&quot;   95% Confidence Interval: [</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>ci_lower</span><span class=si>:</span><span class=s2>+.2%</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>ci_upper</span><span class=si>:</span><span class=s2>+.2%</span><span class=si>}</span><span class=s2>]&quot;</span><span class=p>,</span>
            <span class=sa>f</span><span class=s2>&quot;   P-value: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>p_value</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
            <span class=s2>&quot;&quot;</span><span class=p>,</span>
        <span class=p>]</span>

        <span class=c1># Interpretation of CI</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>ci_lower</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>ci_upper</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
            <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;   ‚ÑπÔ∏è  CI crosses zero: Cannot rule out no effect&quot;</span><span class=p>)</span>
        <span class=k>elif</span> <span class=bp>self</span><span class=o>.</span><span class=n>ci_lower</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
            <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;   üìà CI entirely positive: Likely positive effect (but not significant)&quot;</span><span class=p>)</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;   üìâ CI entirely negative: Treatment likely harmful&quot;</span><span class=p>)</span>

        <span class=n>report</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span>
            <span class=s2>&quot;&quot;</span><span class=p>,</span>
            <span class=s2>&quot;2. STATISTICAL POWER&quot;</span><span class=p>,</span>
            <span class=s2>&quot;-&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>,</span>
            <span class=sa>f</span><span class=s2>&quot;   Sample size: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>n_control</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> control, </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>n_treatment</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> treatment&quot;</span><span class=p>,</span>
            <span class=sa>f</span><span class=s2>&quot;   Achieved power: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>achieved_power</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
            <span class=sa>f</span><span class=s2>&quot;   Planned power: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>planned_power</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
            <span class=s2>&quot;&quot;</span><span class=p>,</span>
        <span class=p>])</span>

        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>achieved_power</span> <span class=o>&lt;</span> <span class=mf>0.8</span><span class=p>:</span>
            <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   ‚ö†Ô∏è  UNDERPOWERED: Only </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>achieved_power</span><span class=si>:</span><span class=s2>.0%</span><span class=si>}</span><span class=s2> power (need 80%+)&quot;</span><span class=p>)</span>
            <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;   This test cannot reliably detect effects.&quot;</span><span class=p>)</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;   ‚úÖ Well-powered: Can reliably detect meaningful effects&quot;</span><span class=p>)</span>

        <span class=n>report</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span>
            <span class=s2>&quot;&quot;</span><span class=p>,</span>
            <span class=s2>&quot;3. CLASSIFICATION&quot;</span><span class=p>,</span>
            <span class=s2>&quot;-&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>,</span>
            <span class=sa>f</span><span class=s2>&quot;   Result type: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>result_type</span><span class=o>.</span><span class=n>value</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;_&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39; &#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
            <span class=sa>f</span><span class=s2>&quot;   Practically significant: </span><span class=si>{</span><span class=s1>&#39;Yes&#39;</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=o>.</span><span class=n>practical_significance</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=s1>&#39;No&#39;</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
            <span class=s2>&quot;&quot;</span><span class=p>,</span>
            <span class=s2>&quot;4. DECISION&quot;</span><span class=p>,</span>
            <span class=s2>&quot;-&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>,</span>
            <span class=sa>f</span><span class=s2>&quot;   </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>decision</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
            <span class=s2>&quot;&quot;</span><span class=p>,</span>
            <span class=s2>&quot;5. NEXT STEPS&quot;</span><span class=p>,</span>
            <span class=s2>&quot;-&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>,</span>
            <span class=sa>f</span><span class=s2>&quot;   </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>next_steps</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
            <span class=s2>&quot;&quot;</span><span class=p>,</span>
            <span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span>
        <span class=p>])</span>

        <span class=k>return</span> <span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>report</span><span class=p>)</span>

<span class=k>class</span><span class=w> </span><span class=nc>NullResultAnalyzer</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Analyze and report null/negative A/B test results.&quot;&quot;&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span> <span class=n>mde</span><span class=o>=</span><span class=mf>0.02</span><span class=p>,</span> <span class=n>practical_threshold</span><span class=o>=</span><span class=mf>0.01</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>=</span> <span class=n>alpha</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>mde</span> <span class=o>=</span> <span class=n>mde</span>  <span class=c1># Minimum detectable effect</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>practical_threshold</span> <span class=o>=</span> <span class=n>practical_threshold</span>  <span class=c1># 1% = practically significant</span>

    <span class=k>def</span><span class=w> </span><span class=nf>analyze</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>control</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> 
               <span class=n>treatment</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span>
               <span class=n>planned_power</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.8</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>NullResultReport</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Comprehensive analysis of null result.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=c1># Effect estimate</span>
        <span class=n>control_mean</span> <span class=o>=</span> <span class=n>control</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
        <span class=n>treatment_mean</span> <span class=o>=</span> <span class=n>treatment</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
        <span class=n>effect</span> <span class=o>=</span> <span class=p>(</span><span class=n>treatment_mean</span> <span class=o>-</span> <span class=n>control_mean</span><span class=p>)</span> <span class=o>/</span> <span class=n>control_mean</span>

        <span class=c1># Statistical test</span>
        <span class=n>t_stat</span><span class=p>,</span> <span class=n>p_value</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span><span class=n>treatment</span><span class=p>,</span> <span class=n>control</span><span class=p>)</span>

        <span class=c1># Confidence interval</span>
        <span class=n>se</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>treatment</span><span class=o>.</span><span class=n>var</span><span class=p>()</span><span class=o>/</span><span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>)</span> <span class=o>+</span> <span class=n>control</span><span class=o>.</span><span class=n>var</span><span class=p>()</span><span class=o>/</span><span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>))</span>
        <span class=n>ci_lower</span> <span class=o>=</span> <span class=n>effect</span> <span class=o>-</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=p>(</span><span class=n>se</span> <span class=o>/</span> <span class=n>control_mean</span><span class=p>)</span>
        <span class=n>ci_upper</span> <span class=o>=</span> <span class=n>effect</span> <span class=o>+</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=p>(</span><span class=n>se</span> <span class=o>/</span> <span class=n>control_mean</span><span class=p>)</span>

        <span class=c1># Achieved power (post-hoc)</span>
        <span class=n>achieved_power</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>compute_achieved_power</span><span class=p>(</span>
            <span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>),</span> <span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>),</span> 
            <span class=n>control</span><span class=o>.</span><span class=n>std</span><span class=p>(),</span> <span class=n>treatment</span><span class=o>.</span><span class=n>std</span><span class=p>(),</span>
            <span class=n>effect</span>
        <span class=p>)</span>

        <span class=c1># Classify result</span>
        <span class=n>result_type</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>classify_result</span><span class=p>(</span><span class=n>effect</span><span class=p>,</span> <span class=n>ci_lower</span><span class=p>,</span> <span class=n>ci_upper</span><span class=p>,</span> 
                                          <span class=n>p_value</span><span class=p>,</span> <span class=n>achieved_power</span><span class=p>)</span>

        <span class=c1># Practical significance</span>
        <span class=n>practical_sig</span> <span class=o>=</span> <span class=nb>abs</span><span class=p>(</span><span class=n>effect</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>practical_threshold</span>

        <span class=c1># Decision and next steps</span>
        <span class=n>decision</span><span class=p>,</span> <span class=n>next_steps</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>make_decision</span><span class=p>(</span>
            <span class=n>result_type</span><span class=p>,</span> <span class=n>effect</span><span class=p>,</span> <span class=n>ci_lower</span><span class=p>,</span> <span class=n>ci_upper</span><span class=p>,</span> 
            <span class=n>achieved_power</span><span class=p>,</span> <span class=n>practical_sig</span>
        <span class=p>)</span>

        <span class=k>return</span> <span class=n>NullResultReport</span><span class=p>(</span>
            <span class=n>effect_estimate</span><span class=o>=</span><span class=n>effect</span><span class=p>,</span>
            <span class=n>ci_lower</span><span class=o>=</span><span class=n>ci_lower</span><span class=p>,</span>
            <span class=n>ci_upper</span><span class=o>=</span><span class=n>ci_upper</span><span class=p>,</span>
            <span class=n>p_value</span><span class=o>=</span><span class=n>p_value</span><span class=p>,</span>
            <span class=n>n_control</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>),</span>
            <span class=n>n_treatment</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>),</span>
            <span class=n>achieved_power</span><span class=o>=</span><span class=n>achieved_power</span><span class=p>,</span>
            <span class=n>planned_power</span><span class=o>=</span><span class=n>planned_power</span><span class=p>,</span>
            <span class=n>result_type</span><span class=o>=</span><span class=n>result_type</span><span class=p>,</span>
            <span class=n>practical_significance</span><span class=o>=</span><span class=n>practical_sig</span><span class=p>,</span>
            <span class=n>decision</span><span class=o>=</span><span class=n>decision</span><span class=p>,</span>
            <span class=n>next_steps</span><span class=o>=</span><span class=n>next_steps</span>
        <span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>compute_achieved_power</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>n_control</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>n_treatment</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
                              <span class=n>std_control</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>std_treatment</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span>
                              <span class=n>effect</span><span class=p>:</span> <span class=nb>float</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>float</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Compute achieved power for observed effect.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=c1># Pooled standard deviation</span>
        <span class=n>pooled_std</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>((</span><span class=n>std_control</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>std_treatment</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span><span class=p>)</span>

        <span class=c1># Effect size (Cohen&#39;s d)</span>
        <span class=n>d</span> <span class=o>=</span> <span class=n>effect</span> <span class=o>/</span> <span class=n>pooled_std</span> <span class=k>if</span> <span class=n>pooled_std</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>

        <span class=c1># Power calculation (simplified)</span>
        <span class=n>n_harmonic</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>/</span> <span class=p>(</span><span class=mi>1</span><span class=o>/</span><span class=n>n_control</span> <span class=o>+</span> <span class=mi>1</span><span class=o>/</span><span class=n>n_treatment</span><span class=p>)</span>
        <span class=n>ncp</span> <span class=o>=</span> <span class=nb>abs</span><span class=p>(</span><span class=n>d</span><span class=p>)</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>n_harmonic</span> <span class=o>/</span> <span class=mi>2</span><span class=p>)</span>  <span class=c1># Non-centrality parameter</span>

        <span class=c1># Critical value</span>
        <span class=n>t_crit</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>t</span><span class=o>.</span><span class=n>ppf</span><span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span><span class=o>/</span><span class=mi>2</span><span class=p>,</span> <span class=n>n_control</span> <span class=o>+</span> <span class=n>n_treatment</span> <span class=o>-</span> <span class=mi>2</span><span class=p>)</span>

        <span class=c1># Power</span>
        <span class=n>power</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>-</span> <span class=n>stats</span><span class=o>.</span><span class=n>nct</span><span class=o>.</span><span class=n>cdf</span><span class=p>(</span><span class=n>t_crit</span><span class=p>,</span> <span class=n>n_control</span> <span class=o>+</span> <span class=n>n_treatment</span> <span class=o>-</span> <span class=mi>2</span><span class=p>,</span> <span class=n>ncp</span><span class=p>)</span>

        <span class=k>return</span> <span class=nb>max</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>min</span><span class=p>(</span><span class=n>power</span><span class=p>,</span> <span class=mi>1</span><span class=p>))</span>  <span class=c1># Clamp to [0, 1]</span>

    <span class=k>def</span><span class=w> </span><span class=nf>classify_result</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>effect</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>ci_lower</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>ci_upper</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span>
                       <span class=n>p_value</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>achieved_power</span><span class=p>:</span> <span class=nb>float</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>NullResultType</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Classify the type of null result.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=c1># Directionally negative</span>
        <span class=k>if</span> <span class=n>ci_upper</span> <span class=o>&lt;</span> <span class=o>-</span><span class=bp>self</span><span class=o>.</span><span class=n>practical_threshold</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>NullResultType</span><span class=o>.</span><span class=n>DIRECTIONALLY_NEGATIVE</span>

        <span class=c1># Underpowered</span>
        <span class=k>if</span> <span class=n>achieved_power</span> <span class=o>&lt;</span> <span class=mf>0.8</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>NullResultType</span><span class=o>.</span><span class=n>UNDERPOWERED</span>

        <span class=c1># Trend positive</span>
        <span class=k>if</span> <span class=n>effect</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>ci_lower</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>ci_upper</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>practical_threshold</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>NullResultType</span><span class=o>.</span><span class=n>TREND_POSITIVE</span>

        <span class=c1># True null (well-powered, CI tight around zero)</span>
        <span class=k>return</span> <span class=n>NullResultType</span><span class=o>.</span><span class=n>TRUE_NULL</span>

    <span class=k>def</span><span class=w> </span><span class=nf>make_decision</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>result_type</span><span class=p>:</span> <span class=n>NullResultType</span><span class=p>,</span>
                     <span class=n>effect</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>ci_lower</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>ci_upper</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span>
                     <span class=n>achieved_power</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>practical_sig</span><span class=p>:</span> <span class=nb>bool</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>tuple</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Generate decision and next steps recommendation.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=n>result_type</span> <span class=o>==</span> <span class=n>NullResultType</span><span class=o>.</span><span class=n>TRUE_NULL</span><span class=p>:</span>
            <span class=n>decision</span> <span class=o>=</span> <span class=s2>&quot;‚ùå DO NOT SHIP: No meaningful effect detected (well-powered test)&quot;</span>
            <span class=n>next_steps</span> <span class=o>=</span> <span class=p>(</span>
                <span class=s2>&quot;1. Abandon this approach</span><span class=se>\n</span><span class=s2>&quot;</span>
                <span class=s2>&quot;   2. Document learnings (what didn&#39;t work and why)</span><span class=se>\n</span><span class=s2>&quot;</span>
                <span class=s2>&quot;   3. Explore alternative solutions</span><span class=se>\n</span><span class=s2>&quot;</span>
                <span class=s2>&quot;   4. Consider different user segments or use cases&quot;</span>
            <span class=p>)</span>

        <span class=k>elif</span> <span class=n>result_type</span> <span class=o>==</span> <span class=n>NullResultType</span><span class=o>.</span><span class=n>UNDERPOWERED</span><span class=p>:</span>
            <span class=n>decision</span> <span class=o>=</span> <span class=s2>&quot;‚è∏Ô∏è  INCONCLUSIVE: Test underpowered, cannot make confident decision&quot;</span>
            <span class=n>next_steps</span> <span class=o>=</span> <span class=p>(</span>
                <span class=sa>f</span><span class=s2>&quot;1. Increase sample size to achieve 80% power</span><span class=se>\n</span><span class=s2>&quot;</span>
                <span class=sa>f</span><span class=s2>&quot;   2. Current power: </span><span class=si>{</span><span class=n>achieved_power</span><span class=si>:</span><span class=s2>.0%</span><span class=si>}</span><span class=s2> ‚Üí need ~</span><span class=si>{</span><span class=mi>1</span><span class=o>/</span><span class=n>achieved_power</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>√ó more data</span><span class=se>\n</span><span class=s2>&quot;</span>
                <span class=sa>f</span><span class=s2>&quot;   3. Run test for </span><span class=si>{</span><span class=mi>2</span><span class=o>*</span><span class=p>(</span><span class=mi>1</span><span class=o>-</span><span class=n>achieved_power</span><span class=p>)</span><span class=o>/</span><span class=n>achieved_power</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2> more weeks</span><span class=se>\n</span><span class=s2>&quot;</span>
                <span class=s2>&quot;   4. Or consider reducing MDE if appropriate&quot;</span>
            <span class=p>)</span>

        <span class=k>elif</span> <span class=n>result_type</span> <span class=o>==</span> <span class=n>NullResultType</span><span class=o>.</span><span class=n>TREND_POSITIVE</span><span class=p>:</span>
            <span class=n>decision</span> <span class=o>=</span> <span class=s2>&quot;üî∂ ITERATE: Promising trend, but not statistically significant&quot;</span>
            <span class=n>next_steps</span> <span class=o>=</span> <span class=p>(</span>
                <span class=s2>&quot;1. Treatment shows positive direction but needs validation</span><span class=se>\n</span><span class=s2>&quot;</span>
                <span class=sa>f</span><span class=s2>&quot;   2. Consider iteration: What if effect is </span><span class=si>{</span><span class=n>effect</span><span class=o>*</span><span class=mf>1.5</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>?</span><span class=se>\n</span><span class=s2>&quot;</span>
                <span class=s2>&quot;   3. Run longer for significance OR iterate on design</span><span class=se>\n</span><span class=s2>&quot;</span>
                <span class=s2>&quot;   4. Check if any segments show strong positive effects&quot;</span>
            <span class=p>)</span>

        <span class=k>else</span><span class=p>:</span>  <span class=c1># DIRECTIONALLY_NEGATIVE</span>
            <span class=n>decision</span> <span class=o>=</span> <span class=s2>&quot;‚õî STOP IMMEDIATELY: Treatment is harmful&quot;</span>
            <span class=n>next_steps</span> <span class=o>=</span> <span class=p>(</span>
                <span class=sa>f</span><span class=s2>&quot;1. Do NOT ship (CI entirely negative: [</span><span class=si>{</span><span class=n>ci_lower</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>ci_upper</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>])</span><span class=se>\n</span><span class=s2>&quot;</span>
                <span class=s2>&quot;   2. Investigate why treatment hurt metrics</span><span class=se>\n</span><span class=s2>&quot;</span>
                <span class=s2>&quot;   3. User research: What went wrong?</span><span class=se>\n</span><span class=s2>&quot;</span>
                <span class=s2>&quot;   4. Document to prevent similar mistakes&quot;</span>
            <span class=p>)</span>

        <span class=k>return</span> <span class=n>decision</span><span class=p>,</span> <span class=n>next_steps</span>

<span class=c1># Example: Pinterest Pin format test</span>
<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;PINTEREST - NEW PIN FORMAT TEST (NULL RESULT)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=c1># Simulate experiment with small true effect (+0.3%) but not significant</span>
<span class=n>n</span> <span class=o>=</span> <span class=mi>10000</span>
<span class=n>baseline_saves</span> <span class=o>=</span> <span class=mi>100</span>
<span class=n>baseline_std</span> <span class=o>=</span> <span class=mi>30</span>

<span class=n>control</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=n>baseline_saves</span><span class=p>,</span> <span class=n>baseline_std</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
<span class=n>treatment</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=n>baseline_saves</span> <span class=o>*</span> <span class=mf>1.003</span><span class=p>,</span> <span class=n>baseline_std</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>  <span class=c1># +0.3% true effect</span>

<span class=c1># Analyze</span>
<span class=n>analyzer</span> <span class=o>=</span> <span class=n>NullResultAnalyzer</span><span class=p>(</span><span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span> <span class=n>mde</span><span class=o>=</span><span class=mf>0.02</span><span class=p>,</span> <span class=n>practical_threshold</span><span class=o>=</span><span class=mf>0.01</span><span class=p>)</span>
<span class=n>result</span> <span class=o>=</span> <span class=n>analyzer</span><span class=o>.</span><span class=n>analyze</span><span class=p>(</span><span class=n>control</span><span class=p>,</span> <span class=n>treatment</span><span class=p>,</span> <span class=n>planned_power</span><span class=o>=</span><span class=mf>0.8</span><span class=p>)</span>

<span class=c1># Generate report</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=n>result</span><span class=o>.</span><span class=n>to_report</span><span class=p>())</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;KEY TAKEAWAYS&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>1. ‚úÖ Always report effect size + CI (even when p&gt;0.05)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;2. üîç Check achieved power (is inconclusive = underpowered?)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;3. üéØ Distinguish &#39;no effect&#39; from &#39;can&#39;t tell&#39;&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;4. üìö Document learnings (negative results prevent future waste)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;5. üöÄ Next steps: Run longer, iterate, or abandon&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
</code></pre></div> <p><strong>Reporting Checklist:</strong></p> <table> <thead> <tr> <th>Element</th> <th>Why Important</th> <th>Example</th> </tr> </thead> <tbody> <tr> <td><strong>Effect estimate</strong></td> <td>Shows magnitude</td> <td>+0.3% (even if p=0.34)</td> </tr> <tr> <td><strong>Confidence interval</strong></td> <td>Quantifies uncertainty</td> <td>CI: [-0.4%, +1.1%]</td> </tr> <tr> <td><strong>Achieved power</strong></td> <td>Was test adequate?</td> <td>85% power achieved</td> </tr> <tr> <td><strong>Practical significance</strong></td> <td>Business relevance</td> <td>+0.3% too small to matter</td> </tr> <tr> <td><strong>Next steps</strong></td> <td>Actionable</td> <td>Iterate design, test v2</td> </tr> </tbody> </table> <p><strong>Common Null Result Mistakes:</strong></p> <table> <thead> <tr> <th>Mistake</th> <th>Why Wrong</th> <th>Correct Approach</th> </tr> </thead> <tbody> <tr> <td><strong>"No effect" when underpowered</strong></td> <td>Can't distinguish no effect from inconclusive</td> <td>Report power, extend test</td> </tr> <tr> <td><strong>Only report p-value</strong></td> <td>Ignores effect size and CI</td> <td>Always show effect + CI</td> </tr> <tr> <td><strong>Throw away null results</strong></td> <td>Wastes learning, repeats mistakes</td> <td>Document and share</td> </tr> <tr> <td><strong>Run forever hoping for sig</strong></td> <td>p-hacking, alpha inflation</td> <td>Pre-register stopping rules</td> </tr> </tbody> </table> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p><strong>What they test:</strong></p> <ul> <li>Do you distinguish "no effect" from "inconclusive"?</li> <li>Do you report effect size + CI (not just p-value)?</li> <li>Do you check statistical power?</li> </ul> <p><strong>Strong signal:</strong></p> <ul> <li>"Effect is +0.3% with CI [-0.4%, +1.1%] and p=0.34"</li> <li>"Test had 85% power, so this is a true null (not underpowered)"</li> <li>"Pinterest decided to iterate on design based on user feedback"</li> <li>"Negative results saved us from shipping a harmful feature"</li> </ul> <p><strong>Red flags:</strong></p> <ul> <li>"p&gt;0.05, so no effect" (ignoring effect size)</li> <li>Not checking if test was adequately powered</li> <li>Suggesting to "just run longer" without power analysis</li> </ul> <p><strong>Follow-ups:</strong></p> <ul> <li>"How do you decide whether to run longer vs abandon?"</li> <li>"What's the difference between underpowered and true null?"</li> <li>"How do you communicate this to non-technical stakeholders?"</li> </ul> </div> </details> <hr> <h3 id=what-is-variance-reduction-and-how-do-you-apply-cuped-and-other-techniques-netflix-meta-interview-question>What is Variance Reduction and How Do You Apply CUPED and Other Techniques? - Netflix, Meta Interview Question</h3> <p><strong>Difficulty:</strong> üî¥ Hard | <strong>Tags:</strong> <code>Efficiency</code>, <code>CUPED</code>, <code>Covariate Adjustment</code>, <code>Power</code> | <strong>Asked by:</strong> Netflix, Meta, Microsoft, Google</p> <details class=success> <summary>View Answer</summary> <p><strong>Variance reduction techniques</strong> use <strong>pre-experiment covariates</strong> (historical behavior, demographics) to <strong>remove noise</strong> from outcome measurements, dramatically <strong>increasing statistical power</strong> without collecting more data. <strong>CUPED</strong> (Controlled-experiment Using Pre-Experiment Data) is the gold standard, reducing variance by 20-50% and cutting experiment duration in half.</p> <p><strong>Variance Reduction Impact:</strong></p> <table> <thead> <tr> <th>Technique</th> <th>Variance Reduction</th> <th>Effective Sample Size Increase</th> <th>Experiment Time Savings</th> </tr> </thead> <tbody> <tr> <td><strong>CUPED</strong></td> <td>30-50%</td> <td>1.5-2√ó</td> <td>30-50% shorter</td> </tr> <tr> <td><strong>Stratification</strong></td> <td>10-20%</td> <td>1.1-1.25√ó</td> <td>10-20% shorter</td> </tr> <tr> <td><strong>Regression adjustment</strong></td> <td>15-30%</td> <td>1.2-1.4√ó</td> <td>15-30% shorter</td> </tr> <tr> <td><strong>Paired design</strong></td> <td>40-60%</td> <td>2-2.5√ó</td> <td>40-60% shorter</td> </tr> </tbody> </table> <p><strong>Real Company Examples:</strong></p> <table> <thead> <tr> <th>Company</th> <th>Technique</th> <th>Covariate Used</th> <th>Variance Reduction</th> <th>Impact</th> </tr> </thead> <tbody> <tr> <td><strong>Netflix</strong></td> <td>CUPED</td> <td>Pre-period watch hours</td> <td>40%</td> <td>2-week test ‚Üí 1 week</td> </tr> <tr> <td><strong>Meta</strong></td> <td>Regression adj.</td> <td>Historical engagement</td> <td>25%</td> <td>Detected +1% at 80% power</td> </tr> <tr> <td><strong>Google Ads</strong></td> <td>Stratification</td> <td>Account size</td> <td>15%</td> <td>Increased sensitivity 20%</td> </tr> <tr> <td><strong>Airbnb</strong></td> <td>CUPED + stratification</td> <td>Booking history + location</td> <td>50%</td> <td>3-week test ‚Üí 1.5 weeks</td> </tr> </tbody> </table> <p><strong>Variance Reduction Framework:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          VARIANCE REDUCTION WORKFLOW                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                           ‚îÇ
‚îÇ  STEP 1: COLLECT PRE-EXPERIMENT DATA                    ‚îÇ
‚îÇ    ‚Üì                                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                   ‚îÇ
‚îÇ  ‚îÇ Measure same metric before    ‚îÇ                   ‚îÇ
‚îÇ  ‚îÇ experiment (e.g., week -1)    ‚îÇ                   ‚îÇ
‚îÇ  ‚îÇ Or use correlated covariate   ‚îÇ                   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                   ‚îÇ
‚îÇ                 ‚Üì                                        ‚îÇ
‚îÇ  STEP 2: CHOOSE TECHNIQUE                               ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                          ‚îÇ
‚îÇ    ‚Üì                         ‚Üì                          ‚îÇ
‚îÇ  CUPED                 Stratification                   ‚îÇ
‚îÇ  (regression adj.)     (block randomization)            ‚îÇ
‚îÇ    ‚îÇ                         ‚îÇ                          ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                          ‚îÇ
‚îÇ             ‚Üì                                            ‚îÇ
‚îÇ  STEP 3: ADJUST OUTCOME                                 ‚îÇ
‚îÇ  Y_adjusted = Y - Œ∏(X - E[X])                          ‚îÇ
‚îÇ  where X = pre-experiment covariate                     ‚îÇ
‚îÇ             ‚Üì                                            ‚îÇ
‚îÇ  STEP 4: RUN T-TEST ON ADJUSTED METRIC                  ‚îÇ
‚îÇ  Standard inference, but with reduced variance          ‚îÇ
‚îÇ                                                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Production Code - CUPED and Variance Reduction:</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>from</span><span class=w> </span><span class=nn>dataclasses</span><span class=w> </span><span class=kn>import</span> <span class=n>dataclass</span>
<span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>Tuple</span><span class=p>,</span> <span class=n>Optional</span>

<span class=nd>@dataclass</span>
<span class=k>class</span><span class=w> </span><span class=nc>VarianceReductionResult</span><span class=p>:</span>
    <span class=n>method</span><span class=p>:</span> <span class=nb>str</span>
    <span class=n>effect_raw</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>effect_adjusted</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>se_raw</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>se_adjusted</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>p_value_raw</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>p_value_adjusted</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>variance_reduction</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>power_gain</span><span class=p>:</span> <span class=nb>float</span>

<span class=k>class</span><span class=w> </span><span class=nc>VarianceReducer</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Apply CUPED and other variance reduction techniques.&quot;&quot;&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.05</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>=</span> <span class=n>alpha</span>

    <span class=k>def</span><span class=w> </span><span class=nf>cuped_adjustment</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>outcome</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> 
                       <span class=n>covariate</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span>
                       <span class=n>treatment</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Tuple</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=nb>float</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        CUPED: Controlled-experiment Using Pre-Experiment Data.</span>

<span class=sd>        Adjusts outcome using pre-experiment covariate:</span>
<span class=sd>        Y_adj = Y - Œ∏(X - mean(X))</span>

<span class=sd>        where Œ∏ = Cov(Y, X) / Var(X)</span>

<span class=sd>        Args:</span>
<span class=sd>            outcome: Experiment outcome (Y)</span>
<span class=sd>            covariate: Pre-experiment covariate (X)</span>
<span class=sd>            treatment: Treatment indicator</span>

<span class=sd>        Returns:</span>
<span class=sd>            adjusted_outcome: Y_adj</span>
<span class=sd>            theta: Adjustment coefficient</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=c1># Compute theta (optimal adjustment coefficient)</span>
        <span class=n>covariate_centered</span> <span class=o>=</span> <span class=n>covariate</span> <span class=o>-</span> <span class=n>covariate</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
        <span class=n>theta</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>cov</span><span class=p>(</span><span class=n>outcome</span><span class=p>,</span> <span class=n>covariate</span><span class=p>)[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>/</span> <span class=n>np</span><span class=o>.</span><span class=n>var</span><span class=p>(</span><span class=n>covariate</span><span class=p>)</span>

        <span class=c1># Adjust outcome</span>
        <span class=n>adjusted_outcome</span> <span class=o>=</span> <span class=n>outcome</span> <span class=o>-</span> <span class=n>theta</span> <span class=o>*</span> <span class=n>covariate_centered</span>

        <span class=k>return</span> <span class=n>adjusted_outcome</span><span class=p>,</span> <span class=n>theta</span>

    <span class=k>def</span><span class=w> </span><span class=nf>stratified_analysis</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span>
                          <span class=n>strata_col</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
                          <span class=n>outcome_col</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
                          <span class=n>treatment_col</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Tuple</span><span class=p>[</span><span class=nb>float</span><span class=p>,</span> <span class=nb>float</span><span class=p>,</span> <span class=nb>float</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Stratified analysis: Analyze within strata, then combine.</span>

<span class=sd>        Returns:</span>
<span class=sd>            effect: Weighted average treatment effect</span>
<span class=sd>            se: Standard error</span>
<span class=sd>            p_value: P-value</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>effects</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=n>variances</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=n>weights</span> <span class=o>=</span> <span class=p>[]</span>

        <span class=k>for</span> <span class=n>stratum</span> <span class=ow>in</span> <span class=n>df</span><span class=p>[</span><span class=n>strata_col</span><span class=p>]</span><span class=o>.</span><span class=n>unique</span><span class=p>():</span>
            <span class=n>stratum_df</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=n>strata_col</span><span class=p>]</span> <span class=o>==</span> <span class=n>stratum</span><span class=p>]</span>

            <span class=n>control</span> <span class=o>=</span> <span class=n>stratum_df</span><span class=p>[</span><span class=n>stratum_df</span><span class=p>[</span><span class=n>treatment_col</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>][</span><span class=n>outcome_col</span><span class=p>]</span>
            <span class=n>treatment</span> <span class=o>=</span> <span class=n>stratum_df</span><span class=p>[</span><span class=n>stratum_df</span><span class=p>[</span><span class=n>treatment_col</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>][</span><span class=n>outcome_col</span><span class=p>]</span>

            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>2</span> <span class=ow>or</span> <span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>:</span>
                <span class=k>continue</span>

            <span class=c1># Effect within stratum</span>
            <span class=n>effect</span> <span class=o>=</span> <span class=n>treatment</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>-</span> <span class=n>control</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>

            <span class=c1># Variance within stratum</span>
            <span class=n>var</span> <span class=o>=</span> <span class=n>control</span><span class=o>.</span><span class=n>var</span><span class=p>()</span><span class=o>/</span><span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>)</span> <span class=o>+</span> <span class=n>treatment</span><span class=o>.</span><span class=n>var</span><span class=p>()</span><span class=o>/</span><span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>)</span>

            <span class=c1># Weight by sample size</span>
            <span class=n>weight</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>stratum_df</span><span class=p>)</span>

            <span class=n>effects</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>effect</span><span class=p>)</span>
            <span class=n>variances</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>var</span><span class=p>)</span>
            <span class=n>weights</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>weight</span><span class=p>)</span>

        <span class=c1># Weighted average</span>
        <span class=n>weights</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>weights</span><span class=p>)</span> <span class=o>/</span> <span class=nb>sum</span><span class=p>(</span><span class=n>weights</span><span class=p>)</span>
        <span class=n>overall_effect</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>average</span><span class=p>(</span><span class=n>effects</span><span class=p>,</span> <span class=n>weights</span><span class=o>=</span><span class=n>weights</span><span class=p>)</span>
        <span class=n>overall_var</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>average</span><span class=p>(</span><span class=n>variances</span><span class=p>,</span> <span class=n>weights</span><span class=o>=</span><span class=n>weights</span><span class=p>)</span>
        <span class=n>overall_se</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>overall_var</span><span class=p>)</span>

        <span class=c1># Z-test</span>
        <span class=n>z_stat</span> <span class=o>=</span> <span class=n>overall_effect</span> <span class=o>/</span> <span class=n>overall_se</span>
        <span class=n>p_value</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>stats</span><span class=o>.</span><span class=n>norm</span><span class=o>.</span><span class=n>cdf</span><span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>z_stat</span><span class=p>)))</span>

        <span class=k>return</span> <span class=n>overall_effect</span><span class=p>,</span> <span class=n>overall_se</span><span class=p>,</span> <span class=n>p_value</span>

    <span class=k>def</span><span class=w> </span><span class=nf>regression_adjustment</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span>
                             <span class=n>covariates</span><span class=p>:</span> <span class=nb>list</span><span class=p>,</span>
                             <span class=n>outcome_col</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
                             <span class=n>treatment_col</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Tuple</span><span class=p>[</span><span class=nb>float</span><span class=p>,</span> <span class=nb>float</span><span class=p>,</span> <span class=nb>float</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Regression adjustment: Include covariates in linear model.</span>

<span class=sd>        Model: Y = Œ≤0 + Œ≤1*T + Œ≤2*X1 + Œ≤3*X2 + ...</span>

<span class=sd>        Returns:</span>
<span class=sd>            treatment_effect: Œ≤1</span>
<span class=sd>            se: Standard error of Œ≤1</span>
<span class=sd>            p_value: P-value</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=kn>from</span><span class=w> </span><span class=nn>sklearn.linear_model</span><span class=w> </span><span class=kn>import</span> <span class=n>LinearRegression</span>

        <span class=n>X</span> <span class=o>=</span> <span class=n>df</span><span class=p>[[</span><span class=n>treatment_col</span><span class=p>]</span> <span class=o>+</span> <span class=n>covariates</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
        <span class=n>y</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>outcome_col</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>

        <span class=n>model</span> <span class=o>=</span> <span class=n>LinearRegression</span><span class=p>()</span>
        <span class=n>model</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>

        <span class=n>treatment_effect</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>coef_</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>

        <span class=c1># Compute standard error (simplified)</span>
        <span class=n>residuals</span> <span class=o>=</span> <span class=n>y</span> <span class=o>-</span> <span class=n>model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
        <span class=n>mse</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>residuals</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span>

        <span class=c1># Covariance matrix (simplified)</span>
        <span class=n>X_centered</span> <span class=o>=</span> <span class=n>X</span> <span class=o>-</span> <span class=n>X</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
        <span class=n>var_treatment</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>linalg</span><span class=o>.</span><span class=n>inv</span><span class=p>(</span><span class=n>X_centered</span><span class=o>.</span><span class=n>T</span> <span class=o>@</span> <span class=n>X_centered</span><span class=p>)[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span>
        <span class=n>se</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>mse</span> <span class=o>*</span> <span class=n>var_treatment</span><span class=p>)</span>

        <span class=n>z_stat</span> <span class=o>=</span> <span class=n>treatment_effect</span> <span class=o>/</span> <span class=n>se</span>
        <span class=n>p_value</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>stats</span><span class=o>.</span><span class=n>norm</span><span class=o>.</span><span class=n>cdf</span><span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>z_stat</span><span class=p>)))</span>

        <span class=k>return</span> <span class=n>treatment_effect</span><span class=p>,</span> <span class=n>se</span><span class=p>,</span> <span class=n>p_value</span>

    <span class=k>def</span><span class=w> </span><span class=nf>compare_methods</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span>
                      <span class=n>pre_metric_col</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
                      <span class=n>outcome_col</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
                      <span class=n>treatment_col</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>VarianceReductionResult</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Compare raw vs CUPED-adjusted analysis.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>control</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=n>treatment_col</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>][</span><span class=n>outcome_col</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
        <span class=n>treatment</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=n>treatment_col</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>][</span><span class=n>outcome_col</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>

        <span class=c1># Raw analysis</span>
        <span class=n>effect_raw</span> <span class=o>=</span> <span class=n>treatment</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>-</span> <span class=n>control</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
        <span class=n>se_raw</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>treatment</span><span class=o>.</span><span class=n>var</span><span class=p>()</span><span class=o>/</span><span class=nb>len</span><span class=p>(</span><span class=n>treatment</span><span class=p>)</span> <span class=o>+</span> <span class=n>control</span><span class=o>.</span><span class=n>var</span><span class=p>()</span><span class=o>/</span><span class=nb>len</span><span class=p>(</span><span class=n>control</span><span class=p>))</span>
        <span class=n>t_stat_raw</span><span class=p>,</span> <span class=n>p_raw</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span><span class=n>treatment</span><span class=p>,</span> <span class=n>control</span><span class=p>)</span>

        <span class=c1># CUPED adjustment</span>
        <span class=n>outcome_all</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>outcome_col</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
        <span class=n>covariate_all</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>pre_metric_col</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
        <span class=n>treatment_all</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>treatment_col</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>

        <span class=n>adjusted_outcome</span><span class=p>,</span> <span class=n>theta</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cuped_adjustment</span><span class=p>(</span>
            <span class=n>outcome_all</span><span class=p>,</span> <span class=n>covariate_all</span><span class=p>,</span> <span class=n>treatment_all</span>
        <span class=p>)</span>

        <span class=n>df</span><span class=p>[</span><span class=s1>&#39;adjusted_outcome&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>adjusted_outcome</span>

        <span class=n>control_adj</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=n>treatment_col</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>][</span><span class=s1>&#39;adjusted_outcome&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
        <span class=n>treatment_adj</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=n>treatment_col</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>][</span><span class=s1>&#39;adjusted_outcome&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>

        <span class=n>effect_adj</span> <span class=o>=</span> <span class=n>treatment_adj</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>-</span> <span class=n>control_adj</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
        <span class=n>se_adj</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>treatment_adj</span><span class=o>.</span><span class=n>var</span><span class=p>()</span><span class=o>/</span><span class=nb>len</span><span class=p>(</span><span class=n>treatment_adj</span><span class=p>)</span> <span class=o>+</span> 
                       <span class=n>control_adj</span><span class=o>.</span><span class=n>var</span><span class=p>()</span><span class=o>/</span><span class=nb>len</span><span class=p>(</span><span class=n>control_adj</span><span class=p>))</span>
        <span class=n>t_stat_adj</span><span class=p>,</span> <span class=n>p_adj</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span><span class=n>treatment_adj</span><span class=p>,</span> <span class=n>control_adj</span><span class=p>)</span>

        <span class=c1># Variance reduction</span>
        <span class=n>var_reduction</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>-</span> <span class=p>(</span><span class=n>se_adj</span><span class=o>**</span><span class=mi>2</span> <span class=o>/</span> <span class=n>se_raw</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span>
        <span class=n>power_gain</span> <span class=o>=</span> <span class=n>se_raw</span> <span class=o>/</span> <span class=n>se_adj</span>  <span class=c1># Effective sample size multiplier</span>

        <span class=k>return</span> <span class=n>VarianceReductionResult</span><span class=p>(</span>
            <span class=n>method</span><span class=o>=</span><span class=s1>&#39;CUPED&#39;</span><span class=p>,</span>
            <span class=n>effect_raw</span><span class=o>=</span><span class=n>effect_raw</span><span class=p>,</span>
            <span class=n>effect_adjusted</span><span class=o>=</span><span class=n>effect_adj</span><span class=p>,</span>
            <span class=n>se_raw</span><span class=o>=</span><span class=n>se_raw</span><span class=p>,</span>
            <span class=n>se_adjusted</span><span class=o>=</span><span class=n>se_adj</span><span class=p>,</span>
            <span class=n>p_value_raw</span><span class=o>=</span><span class=n>p_raw</span><span class=p>,</span>
            <span class=n>p_value_adjusted</span><span class=o>=</span><span class=n>p_adj</span><span class=p>,</span>
            <span class=n>variance_reduction</span><span class=o>=</span><span class=n>var_reduction</span><span class=p>,</span>
            <span class=n>power_gain</span><span class=o>=</span><span class=n>power_gain</span>
        <span class=p>)</span>

<span class=c1># Example: Netflix homepage test</span>
<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;NETFLIX - HOMEPAGE TEST WITH CUPED&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=c1># Simulate experiment data</span>
<span class=n>n</span> <span class=o>=</span> <span class=mi>2000</span>

<span class=c1># Pre-experiment covariate: watch hours in week -1</span>
<span class=n>pre_watch_hours</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>gamma</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span> <span class=n>scale</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n</span><span class=p>)</span>  <span class=c1># Skewed distribution</span>

<span class=c1># Treatment assignment</span>
<span class=n>treatment_indicator</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>

<span class=c1># Experiment outcome: watch hours in week 0</span>
<span class=c1># True treatment effect: +2 hours</span>
<span class=c1># High correlation with pre-period (r=0.7)</span>

<span class=n>correlation</span> <span class=o>=</span> <span class=mf>0.7</span>
<span class=n>noise</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>

<span class=n>watch_hours_experiment</span> <span class=o>=</span> <span class=p>(</span>
    <span class=mf>0.7</span> <span class=o>*</span> <span class=n>pre_watch_hours</span> <span class=o>+</span>  <span class=c1># Correlated with history</span>
    <span class=mf>2.0</span> <span class=o>*</span> <span class=n>treatment_indicator</span> <span class=o>+</span>  <span class=c1># Treatment effect</span>
    <span class=n>noise</span>  <span class=c1># Random variation</span>
<span class=p>)</span>

<span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
    <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>),</span>
    <span class=s1>&#39;treatment&#39;</span><span class=p>:</span> <span class=n>treatment_indicator</span><span class=p>,</span>
    <span class=s1>&#39;pre_watch_hours&#39;</span><span class=p>:</span> <span class=n>pre_watch_hours</span><span class=p>,</span>
    <span class=s1>&#39;watch_hours&#39;</span><span class=p>:</span> <span class=n>watch_hours_experiment</span>
<span class=p>})</span>

<span class=c1># Analysis</span>
<span class=n>reducer</span> <span class=o>=</span> <span class=n>VarianceReducer</span><span class=p>()</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Data Summary:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Sample size: </span><span class=si>{</span><span class=n>n</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> users (control: </span><span class=si>{</span><span class=p>(</span><span class=n>treatment_indicator</span><span class=o>==</span><span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>, treatment: </span><span class=si>{</span><span class=p>(</span><span class=n>treatment_indicator</span><span class=o>==</span><span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Pre-period watch hours: mean=</span><span class=si>{</span><span class=n>pre_watch_hours</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>, std=</span><span class=si>{</span><span class=n>pre_watch_hours</span><span class=o>.</span><span class=n>std</span><span class=p>()</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Correlation (pre vs experiment): r=</span><span class=si>{</span><span class=n>np</span><span class=o>.</span><span class=n>corrcoef</span><span class=p>(</span><span class=n>pre_watch_hours</span><span class=p>,</span><span class=w> </span><span class=n>watch_hours_experiment</span><span class=p>)[</span><span class=mi>0</span><span class=p>,</span><span class=mi>1</span><span class=p>]</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Compare methods</span>
<span class=n>result</span> <span class=o>=</span> <span class=n>reducer</span><span class=o>.</span><span class=n>compare_methods</span><span class=p>(</span>
    <span class=n>df</span><span class=p>,</span>
    <span class=n>pre_metric_col</span><span class=o>=</span><span class=s1>&#39;pre_watch_hours&#39;</span><span class=p>,</span>
    <span class=n>outcome_col</span><span class=o>=</span><span class=s1>&#39;watch_hours&#39;</span><span class=p>,</span>
    <span class=n>treatment_col</span><span class=o>=</span><span class=s1>&#39;treatment&#39;</span>
<span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;VARIANCE REDUCTION COMPARISON&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>1. Raw Analysis (No Adjustment):&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Effect: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>effect_raw</span><span class=si>:</span><span class=s2>+.3f</span><span class=si>}</span><span class=s2> hours&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   SE: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>se_raw</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   95% CI: [</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>effect_raw</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mf>1.96</span><span class=o>*</span><span class=n>result</span><span class=o>.</span><span class=n>se_raw</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>effect_raw</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mf>1.96</span><span class=o>*</span><span class=n>result</span><span class=o>.</span><span class=n>se_raw</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>]&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   P-value: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>p_value_raw</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=k>if</span> <span class=n>result</span><span class=o>.</span><span class=n>p_value_raw</span> <span class=o>&lt;</span> <span class=mf>0.05</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   ‚úÖ Significant&quot;</span><span class=p>)</span>
<span class=k>else</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   ‚ùå Not significant&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>2. CUPED-Adjusted Analysis:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Effect: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>effect_adjusted</span><span class=si>:</span><span class=s2>+.3f</span><span class=si>}</span><span class=s2> hours&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   SE: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>se_adjusted</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   95% CI: [</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>effect_adjusted</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mf>1.96</span><span class=o>*</span><span class=n>result</span><span class=o>.</span><span class=n>se_adjusted</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>effect_adjusted</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mf>1.96</span><span class=o>*</span><span class=n>result</span><span class=o>.</span><span class=n>se_adjusted</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>]&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   P-value: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>p_value_adjusted</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=k>if</span> <span class=n>result</span><span class=o>.</span><span class=n>p_value_adjusted</span> <span class=o>&lt;</span> <span class=mf>0.05</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   ‚úÖ Significant&quot;</span><span class=p>)</span>
<span class=k>else</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   ‚ùå Not significant&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>3. Variance Reduction:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Variance reduction: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>variance_reduction</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   SE reduction: </span><span class=si>{</span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>result</span><span class=o>.</span><span class=n>se_adjusted</span><span class=o>/</span><span class=n>result</span><span class=o>.</span><span class=n>se_raw</span><span class=p>)</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Effective sample size multiplier: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>power_gain</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>√ó&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Equivalent to running experiment with </span><span class=si>{</span><span class=nb>int</span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>result</span><span class=o>.</span><span class=n>power_gain</span><span class=p>)</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> users (without CUPED)&quot;</span><span class=p>)</span>

<span class=c1># Time savings</span>
<span class=n>time_savings</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>-</span> <span class=mi>1</span><span class=o>/</span><span class=n>result</span><span class=o>.</span><span class=n>power_gain</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>   üìà Impact: </span><span class=si>{</span><span class=n>time_savings</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>% shorter experiment (or </span><span class=si>{</span><span class=n>time_savings</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>% smaller sample)&quot;</span><span class=p>)</span>

<span class=k>if</span> <span class=n>result</span><span class=o>.</span><span class=n>variance_reduction</span> <span class=o>&gt;</span> <span class=mf>0.30</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   üéâ EXCELLENT: &gt;30% variance reduction. CUPED highly effective!&quot;</span><span class=p>)</span>
<span class=k>elif</span> <span class=n>result</span><span class=o>.</span><span class=n>variance_reduction</span> <span class=o>&gt;</span> <span class=mf>0.15</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   üëç GOOD: 15-30% variance reduction. CUPED worth using.&quot;</span><span class=p>)</span>
<span class=k>else</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   ü§î MODEST: &lt;15% variance reduction. Low correlation with covariate.&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;DECISION IMPACT&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Without CUPED:&quot;</span><span class=p>)</span>
<span class=k>if</span> <span class=n>result</span><span class=o>.</span><span class=n>p_value_raw</span> <span class=o>&lt;</span> <span class=mf>0.05</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;  ‚úÖ Would ship (significant at p&lt;0.05)&quot;</span><span class=p>)</span>
<span class=k>else</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;  ‚ùå Would NOT ship (not significant)&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;  ‚è±Ô∏è  Need to run longer or increase sample size&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>With CUPED:&quot;</span><span class=p>)</span>
<span class=k>if</span> <span class=n>result</span><span class=o>.</span><span class=n>p_value_adjusted</span> <span class=o>&lt;</span> <span class=mf>0.05</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;  ‚úÖ Can ship NOW (significant with variance reduction)&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  üí∞ Saved </span><span class=si>{</span><span class=n>time_savings</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>% experiment time&quot;</span><span class=p>)</span>
<span class=k>else</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;  ‚ùå Still not significant&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=c1># Output:</span>
<span class=c1># ======================================================================</span>
<span class=c1># NETFLIX - HOMEPAGE TEST WITH CUPED</span>
<span class=c1># ======================================================================</span>
<span class=c1># </span>
<span class=c1># Data Summary:</span>
<span class=c1>#   Sample size: 2,000 users (control: 1,014, treatment: 986)</span>
<span class=c1>#   Pre-period watch hours: mean=10.03, std=4.50</span>
<span class=c1>#   Correlation (pre vs experiment): r=0.680</span>
<span class=c1># </span>
<span class=c1># ======================================================================</span>
<span class=c1># VARIANCE REDUCTION COMPARISON</span>
<span class=c1># ======================================================================</span>
<span class=c1># </span>
<span class=c1># 1. Raw Analysis (No Adjustment):</span>
<span class=c1>#    Effect: +2.123 hours</span>
<span class=c1>#    SE: 0.289</span>
<span class=c1>#    95% CI: [1.557, 2.689]</span>
<span class=c1>#    P-value: 0.0000</span>
<span class=c1>#    ‚úÖ Significant</span>
<span class=c1># </span>
<span class=c1># 2. CUPED-Adjusted Analysis:</span>
<span class=c1>#    Effect: +2.123 hours</span>
<span class=c1>#    SE: 0.184</span>
<span class=c1>#    95% CI: [1.762, 2.484]</span>
<span class=c1>#    P-value: 0.0000</span>
<span class=c1>#    ‚úÖ Significant</span>
<span class=c1># </span>
<span class=c1># 3. Variance Reduction:</span>
<span class=c1>#    Variance reduction: 59.5%</span>
<span class=c1>#    SE reduction: 36.3%</span>
<span class=c1>#    Effective sample size multiplier: 1.57√ó</span>
<span class=c1>#    Equivalent to running experiment with 3,145 users (without CUPED)</span>
<span class=c1># </span>
<span class=c1>#    üìà Impact: 36% shorter experiment (or 36% smaller sample)</span>
<span class=c1>#    üéâ EXCELLENT: &gt;30% variance reduction. CUPED highly effective!</span>
<span class=c1># </span>
<span class=c1># ======================================================================</span>
<span class=c1># DECISION IMPACT</span>
<span class=c1># ======================================================================</span>
<span class=c1># </span>
<span class=c1># Without CUPED:</span>
<span class=c1>#   ‚úÖ Would ship (significant at p&lt;0.05)</span>
<span class=c1># </span>
<span class=c1># With CUPED:</span>
<span class=c1>#   ‚úÖ Can ship NOW (significant with variance reduction)</span>
<span class=c1>#   üí∞ Saved 36% experiment time</span>
<span class=c1># </span>
<span class=c1># ======================================================================</span>
</code></pre></div> <p><strong>Key CUPED Principles:</strong></p> <ul> <li><strong>Use pre-experiment data</strong> - Same metric measured before experiment starts</li> <li><strong>Covariate must be unaffected by treatment</strong> - Collected before randomization</li> <li><strong>Optimal adjustment</strong> - CUPED automatically finds best coefficient Œ∏</li> <li><strong>Preserves unbiasedness</strong> - Treatment effect estimate unchanged</li> <li><strong>Only reduces variance</strong> - SE shrinks, power increases</li> </ul> <p><strong>When Variance Reduction Helps Most:</strong></p> <table> <thead> <tr> <th>Scenario</th> <th>Why Variance Reduction Critical</th> <th>Expected Gain</th> </tr> </thead> <tbody> <tr> <td><strong>High baseline variance</strong></td> <td>Users highly heterogeneous</td> <td>30-50%</td> </tr> <tr> <td><strong>Small effect size</strong></td> <td>Need high power to detect</td> <td>40-60% time savings</td> </tr> <tr> <td><strong>Limited traffic</strong></td> <td>Can't increase sample size</td> <td>Essential</td> </tr> <tr> <td><strong>Time-sensitive launch</strong></td> <td>Need faster decision</td> <td>30-50% shorter test</td> </tr> </tbody> </table> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p><strong>What they test:</strong></p> <ul> <li>Do you know CUPED formula and intuition?</li> <li>Can you explain why it preserves unbiasedness?</li> <li>Do you understand power implications?</li> </ul> <p><strong>Strong signal:</strong></p> <ul> <li>"CUPED uses Y_adj = Y - Œ∏(X - mean(X)) where Œ∏ = Cov(Y,X)/Var(X)"</li> <li>"Reduces variance by 40%, cutting experiment time in half"</li> <li>"Netflix uses week -1 watch hours to adjust week 0 metric"</li> <li>"Pre-period covariate must be unaffected by treatment"</li> </ul> <p><strong>Red flags:</strong></p> <ul> <li>Using post-treatment covariates (biased!)</li> <li>Not knowing CUPED is regression adjustment</li> <li>Thinking CUPED changes the effect estimate (it only reduces SE)</li> </ul> <p><strong>Follow-ups:</strong></p> <ul> <li>"What if no pre-experiment data available?"</li> <li>"Can you combine CUPED with stratification?"</li> <li>"How much variance reduction is enough to matter?"</li> </ul> </div> </details> <hr> <h3 id=how-do-you-handle-feature-interactions-when-running-multiple-experiments-netflix-airbnb-interview-question>How Do You Handle Feature Interactions When Running Multiple Experiments? - Netflix, Airbnb Interview Question</h3> <p><strong>Difficulty:</strong> üî¥ Hard | <strong>Tags:</strong> <code>Experimental Design</code>, <code>Factorial Design</code>, <code>Interaction Effects</code> | <strong>Asked by:</strong> Netflix, Airbnb, Meta, Google</p> <details class=success> <summary>View Answer</summary> <p><strong>Feature interactions</strong> occur when <strong>multiple experiments run simultaneously</strong> and the <strong>effect of one feature depends on another</strong>. Without proper design, interactions can <strong>confound results</strong> (A looks good alone but bad with B) or <strong>waste opportunities</strong> (A+B together is better than A or B alone). Solutions: <strong>mutual exclusion</strong>, <strong>factorial design</strong>, or <strong>layered experiments</strong>.</p> <p><strong>Interaction Types:</strong></p> <table> <thead> <tr> <th>Interaction Type</th> <th>Example</th> <th>Problem</th> <th>Solution</th> </tr> </thead> <tbody> <tr> <td><strong>Synergistic</strong></td> <td>Button color + CTA text together = 2√ó lift</td> <td>Miss combined effect if tested separately</td> <td>Factorial design</td> </tr> <tr> <td><strong>Antagonistic</strong></td> <td>Feature A good alone, bad with Feature B</td> <td>Ship both, metrics drop</td> <td>Test combinations</td> </tr> <tr> <td><strong>Independent</strong></td> <td>Homepage A/B + Checkout A/B</td> <td>No interaction expected</td> <td>Layered experiments</td> </tr> <tr> <td><strong>Interference</strong></td> <td>Search ranking + recommendation algo</td> <td>Shared surface, can't isolate</td> <td>Mutual exclusion</td> </tr> </tbody> </table> <p><strong>Real Company Examples:</strong></p> <table> <thead> <tr> <th>Company</th> <th>Features Tested</th> <th>Interaction Found</th> <th>Impact</th> <th>Decision</th> </tr> </thead> <tbody> <tr> <td><strong>Meta</strong></td> <td>News Feed ranking + notification cadence</td> <td>Synergistic: +8% together vs +3% each</td> <td>+5pp interaction effect</td> <td>Shipped both</td> </tr> <tr> <td><strong>Netflix</strong></td> <td>Homepage layout + Autoplay</td> <td>Antagonistic: +5% layout, -3% when combined</td> <td>Autoplay hurts new layout</td> <td>Ship layout only</td> </tr> <tr> <td><strong>Airbnb</strong></td> <td>Search filters + Map view</td> <td>Independent: No interaction (p=0.87)</td> <td>Effects add linearly</td> <td>Layered experiments</td> </tr> <tr> <td><strong>Google Ads</strong></td> <td>Bidding algo + Landing page quality</td> <td>Synergistic: +15% revenue together</td> <td>Factorial test required</td> <td>Shipped both</td> </tr> </tbody> </table> <p><strong>Feature Interaction Framework:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ       FEATURE INTERACTION TESTING STRATEGIES           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                           ‚îÇ
‚îÇ  STRATEGY 1: MUTUAL EXCLUSION                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îÇ
‚îÇ  ‚îÇ Separate traffic buckets:       ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ - 50% Experiment A              ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ - 50% Experiment B              ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ ‚úÖ No interaction possible        ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ ‚ùå Wastes traffic (can&#39;t test both)‚îÇ                ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îÇ
‚îÇ                                                           ‚îÇ
‚îÇ  STRATEGY 2: FACTORIAL DESIGN                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îÇ
‚îÇ  ‚îÇ Test all combinations:         ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ - 25% A=off, B=off (control)   ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ - 25% A=on,  B=off             ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ - 25% A=off, B=on              ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ - 25% A=on,  B=on              ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ ‚úÖ Detects interactions          ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ ‚ùå Needs 4√ó traffic (2 features) ‚îÇ                ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îÇ
‚îÇ                                                           ‚îÇ
‚îÇ  STRATEGY 3: LAYERED EXPERIMENTS                        ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îÇ
‚îÇ  ‚îÇ Independent experiments:       ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ - Layer 1: Experiment A        ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ - Layer 2: Experiment B        ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ Each user in both (orthogonal) ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ ‚úÖ Efficient (uses all traffic)  ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ ‚ö†Ô∏è  Assumes no interaction       ‚îÇ                ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îÇ
‚îÇ                                                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Production Code - Factorial Design &amp; Interaction Testing:</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>from</span><span class=w> </span><span class=nn>dataclasses</span><span class=w> </span><span class=kn>import</span> <span class=n>dataclass</span>
<span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Tuple</span>
<span class=kn>from</span><span class=w> </span><span class=nn>itertools</span><span class=w> </span><span class=kn>import</span> <span class=n>product</span>

<span class=nd>@dataclass</span>
<span class=k>class</span><span class=w> </span><span class=nc>FactorialResult</span><span class=p>:</span>
    <span class=n>feature_a</span><span class=p>:</span> <span class=nb>str</span>
    <span class=n>feature_b</span><span class=p>:</span> <span class=nb>str</span>
    <span class=n>main_effect_a</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>main_effect_b</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>interaction_effect</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>interaction_pvalue</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>has_significant_interaction</span><span class=p>:</span> <span class=nb>bool</span>

<span class=k>class</span><span class=w> </span><span class=nc>FactorialExperiment</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;2√ó2 factorial design for testing feature interactions.&quot;&quot;&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>feature_a_name</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&quot;Feature A&quot;</span><span class=p>,</span>
                <span class=n>feature_b_name</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&quot;Feature B&quot;</span><span class=p>,</span>
                <span class=n>alpha</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.05</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>feature_a_name</span> <span class=o>=</span> <span class=n>feature_a_name</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>feature_b_name</span> <span class=o>=</span> <span class=n>feature_b_name</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>=</span> <span class=n>alpha</span>

    <span class=k>def</span><span class=w> </span><span class=nf>randomize_users</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>n_users</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Randomize users to 4 groups (2x2 factorial).</span>

<span class=sd>        Groups:</span>
<span class=sd>        - Control: A=0, B=0</span>
<span class=sd>        - A only: A=1, B=0</span>
<span class=sd>        - B only: A=0, B=1</span>
<span class=sd>        - Both: A=1, B=1</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>users</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
            <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_users</span><span class=p>),</span>
            <span class=s1>&#39;feature_a&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>,</span> <span class=n>n_users</span><span class=p>),</span>
            <span class=s1>&#39;feature_b&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>,</span> <span class=n>n_users</span><span class=p>)</span>
        <span class=p>})</span>

        <span class=c1># Create group labels</span>
        <span class=n>users</span><span class=p>[</span><span class=s1>&#39;group&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>users</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span>
            <span class=k>lambda</span> <span class=n>row</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&quot;A=</span><span class=si>{</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;feature_a&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>,B=</span><span class=si>{</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;feature_b&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
            <span class=n>axis</span><span class=o>=</span><span class=mi>1</span>
        <span class=p>)</span>

        <span class=k>return</span> <span class=n>users</span>

    <span class=k>def</span><span class=w> </span><span class=nf>analyze_factorial</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span> 
                        <span class=n>outcome_col</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;outcome&#39;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>FactorialResult</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Analyze 2x2 factorial experiment.</span>

<span class=sd>        Estimates:</span>
<span class=sd>        - Main effect of A: E[Y|A=1] - E[Y|A=0] (averaging over B)</span>
<span class=sd>        - Main effect of B: E[Y|B=1] - E[Y|B=0] (averaging over A)</span>
<span class=sd>        - Interaction: Does effect of A depend on B?</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=c1># Group means</span>
        <span class=n>means</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=k>for</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span> <span class=ow>in</span> <span class=n>product</span><span class=p>([</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>],</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]):</span>
            <span class=n>group</span> <span class=o>=</span> <span class=n>df</span><span class=p>[(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;feature_a&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>a</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;feature_b&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>b</span><span class=p>)]</span>
            <span class=n>means</span><span class=p>[(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>)]</span> <span class=o>=</span> <span class=n>group</span><span class=p>[</span><span class=n>outcome_col</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>

        <span class=c1># Main effect of A (average over B)</span>
        <span class=n>main_effect_a</span> <span class=o>=</span> <span class=p>(</span>
            <span class=p>(</span><span class=n>means</span><span class=p>[(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>)]</span> <span class=o>+</span> <span class=n>means</span><span class=p>[(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>)])</span> <span class=o>/</span> <span class=mi>2</span> <span class=o>-</span> 
            <span class=p>(</span><span class=n>means</span><span class=p>[(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)]</span> <span class=o>+</span> <span class=n>means</span><span class=p>[(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>)])</span> <span class=o>/</span> <span class=mi>2</span>
        <span class=p>)</span>

        <span class=c1># Main effect of B (average over A)</span>
        <span class=n>main_effect_b</span> <span class=o>=</span> <span class=p>(</span>
            <span class=p>(</span><span class=n>means</span><span class=p>[(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>)]</span> <span class=o>+</span> <span class=n>means</span><span class=p>[(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>)])</span> <span class=o>/</span> <span class=mi>2</span> <span class=o>-</span> 
            <span class=p>(</span><span class=n>means</span><span class=p>[(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)]</span> <span class=o>+</span> <span class=n>means</span><span class=p>[(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>)])</span> <span class=o>/</span> <span class=mi>2</span>
        <span class=p>)</span>

        <span class=c1># Interaction effect</span>
        <span class=c1># Interaction = (A effect when B=1) - (A effect when B=0)</span>
        <span class=n>a_effect_when_b1</span> <span class=o>=</span> <span class=n>means</span><span class=p>[(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>)]</span> <span class=o>-</span> <span class=n>means</span><span class=p>[(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>)]</span>
        <span class=n>a_effect_when_b0</span> <span class=o>=</span> <span class=n>means</span><span class=p>[(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>)]</span> <span class=o>-</span> <span class=n>means</span><span class=p>[(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)]</span>
        <span class=n>interaction_effect</span> <span class=o>=</span> <span class=n>a_effect_when_b1</span> <span class=o>-</span> <span class=n>a_effect_when_b0</span>

        <span class=c1># Statistical test for interaction</span>
        <span class=c1># Use 2-way ANOVA</span>
        <span class=kn>from</span><span class=w> </span><span class=nn>sklearn.linear_model</span><span class=w> </span><span class=kn>import</span> <span class=n>LinearRegression</span>

        <span class=c1># Create interaction term</span>
        <span class=n>df</span><span class=p>[</span><span class=s1>&#39;interaction&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;feature_a&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;feature_b&#39;</span><span class=p>]</span>

        <span class=n>X</span> <span class=o>=</span> <span class=n>df</span><span class=p>[[</span><span class=s1>&#39;feature_a&#39;</span><span class=p>,</span> <span class=s1>&#39;feature_b&#39;</span><span class=p>,</span> <span class=s1>&#39;interaction&#39;</span><span class=p>]]</span><span class=o>.</span><span class=n>values</span>
        <span class=n>y</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>outcome_col</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>

        <span class=n>model</span> <span class=o>=</span> <span class=n>LinearRegression</span><span class=p>()</span>
        <span class=n>model</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>

        <span class=c1># Coefficient for interaction term</span>
        <span class=n>interaction_coef</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>coef_</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>

        <span class=c1># T-test for interaction coefficient (simplified)</span>
        <span class=n>residuals</span> <span class=o>=</span> <span class=n>y</span> <span class=o>-</span> <span class=n>model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
        <span class=n>mse</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>residuals</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span>

        <span class=c1># Standard error (simplified)</span>
        <span class=n>X_centered</span> <span class=o>=</span> <span class=n>X</span> <span class=o>-</span> <span class=n>X</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
        <span class=n>var_interaction</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>linalg</span><span class=o>.</span><span class=n>inv</span><span class=p>(</span><span class=n>X_centered</span><span class=o>.</span><span class=n>T</span> <span class=o>@</span> <span class=n>X_centered</span><span class=p>)[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>]</span>
        <span class=n>se_interaction</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>mse</span> <span class=o>*</span> <span class=n>var_interaction</span><span class=p>)</span>

        <span class=n>t_stat</span> <span class=o>=</span> <span class=n>interaction_coef</span> <span class=o>/</span> <span class=n>se_interaction</span>
        <span class=n>p_value</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>stats</span><span class=o>.</span><span class=n>t</span><span class=o>.</span><span class=n>cdf</span><span class=p>(</span><span class=nb>abs</span><span class=p>(</span><span class=n>t_stat</span><span class=p>),</span> <span class=nb>len</span><span class=p>(</span><span class=n>df</span><span class=p>)</span> <span class=o>-</span> <span class=mi>4</span><span class=p>))</span>

        <span class=n>has_interaction</span> <span class=o>=</span> <span class=n>p_value</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span>

        <span class=k>return</span> <span class=n>FactorialResult</span><span class=p>(</span>
            <span class=n>feature_a</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>feature_a_name</span><span class=p>,</span>
            <span class=n>feature_b</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>feature_b_name</span><span class=p>,</span>
            <span class=n>main_effect_a</span><span class=o>=</span><span class=n>main_effect_a</span><span class=p>,</span>
            <span class=n>main_effect_b</span><span class=o>=</span><span class=n>main_effect_b</span><span class=p>,</span>
            <span class=n>interaction_effect</span><span class=o>=</span><span class=n>interaction_effect</span><span class=p>,</span>
            <span class=n>interaction_pvalue</span><span class=o>=</span><span class=n>p_value</span><span class=p>,</span>
            <span class=n>has_significant_interaction</span><span class=o>=</span><span class=n>has_interaction</span>
        <span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>print_factorial_table</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span> 
                             <span class=n>outcome_col</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;outcome&#39;</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Print 2x2 table of mean outcomes.&quot;&quot;&quot;</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>2√ó2 Factorial Table (</span><span class=si>{</span><span class=n>outcome_col</span><span class=si>}</span><span class=s2>):&quot;</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot; &quot;</span><span class=o>*</span><span class=mi>20</span> <span class=o>+</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>feature_b_name</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot; &quot;</span><span class=o>*</span><span class=mi>20</span> <span class=o>+</span> <span class=s2>&quot;OFF      ON&quot;</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot; &quot;</span><span class=o>*</span><span class=mi>20</span> <span class=o>+</span> <span class=s2>&quot;-&quot;</span><span class=o>*</span><span class=mi>15</span><span class=p>)</span>

        <span class=k>for</span> <span class=n>a</span> <span class=ow>in</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]:</span>
            <span class=n>a_label</span> <span class=o>=</span> <span class=s2>&quot;OFF&quot;</span> <span class=k>if</span> <span class=n>a</span> <span class=o>==</span> <span class=mi>0</span> <span class=k>else</span> <span class=s2>&quot;ON &quot;</span>
            <span class=n>row_means</span> <span class=o>=</span> <span class=p>[]</span>
            <span class=k>for</span> <span class=n>b</span> <span class=ow>in</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]:</span>
                <span class=n>group</span> <span class=o>=</span> <span class=n>df</span><span class=p>[(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;feature_a&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>a</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;feature_b&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>b</span><span class=p>)]</span>
                <span class=n>mean_val</span> <span class=o>=</span> <span class=n>group</span><span class=p>[</span><span class=n>outcome_col</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
                <span class=n>row_means</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>mean_val</span><span class=p>)</span>

            <span class=k>if</span> <span class=n>a</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>feature_a_name</span><span class=si>}</span><span class=s2>  </span><span class=si>{</span><span class=n>a_label</span><span class=si>}</span><span class=s2>  | </span><span class=si>{</span><span class=n>row_means</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>    </span><span class=si>{</span><span class=n>row_means</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;            </span><span class=si>{</span><span class=n>a_label</span><span class=si>}</span><span class=s2>  | </span><span class=si>{</span><span class=n>row_means</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>    </span><span class=si>{</span><span class=n>row_means</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Example: Meta News Feed ranking + Notification cadence</span>
<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;META - NEWS FEED RANKING + NOTIFICATION CADENCE&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Factorial Experiment to Detect Interactions&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=c1># Simulate factorial experiment</span>
<span class=n>experiment</span> <span class=o>=</span> <span class=n>FactorialExperiment</span><span class=p>(</span>
    <span class=n>feature_a_name</span><span class=o>=</span><span class=s2>&quot;News Feed Ranking&quot;</span><span class=p>,</span>
    <span class=n>feature_b_name</span><span class=o>=</span><span class=s2>&quot;Notification Cadence&quot;</span>
<span class=p>)</span>

<span class=n>n_users</span> <span class=o>=</span> <span class=mi>10000</span>
<span class=n>users</span> <span class=o>=</span> <span class=n>experiment</span><span class=o>.</span><span class=n>randomize_users</span><span class=p>(</span><span class=n>n_users</span><span class=p>)</span>

<span class=c1># Simulate engagement with SYNERGISTIC interaction</span>
<span class=c1># - Feature A alone: +3% engagement</span>
<span class=c1># - Feature B alone: +3% engagement</span>
<span class=c1># - Both together: +8% engagement (synergy = +2%)</span>

<span class=n>baseline_engagement</span> <span class=o>=</span> <span class=mi>100</span>

<span class=k>def</span><span class=w> </span><span class=nf>simulate_engagement</span><span class=p>(</span><span class=n>row</span><span class=p>):</span>
    <span class=n>engagement</span> <span class=o>=</span> <span class=n>baseline_engagement</span>

    <span class=c1># Main effect of A</span>
    <span class=k>if</span> <span class=n>row</span><span class=p>[</span><span class=s1>&#39;feature_a&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
        <span class=n>engagement</span> <span class=o>+=</span> <span class=mi>3</span>

    <span class=c1># Main effect of B</span>
    <span class=k>if</span> <span class=n>row</span><span class=p>[</span><span class=s1>&#39;feature_b&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
        <span class=n>engagement</span> <span class=o>+=</span> <span class=mi>3</span>

    <span class=c1># Synergistic interaction</span>
    <span class=k>if</span> <span class=n>row</span><span class=p>[</span><span class=s1>&#39;feature_a&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span> <span class=ow>and</span> <span class=n>row</span><span class=p>[</span><span class=s1>&#39;feature_b&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
        <span class=n>engagement</span> <span class=o>+=</span> <span class=mi>2</span>  <span class=c1># Extra +2% when both are on</span>

    <span class=c1># Add noise</span>
    <span class=n>engagement</span> <span class=o>+=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>20</span><span class=p>)</span>

    <span class=k>return</span> <span class=nb>max</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>engagement</span><span class=p>)</span>

<span class=n>users</span><span class=p>[</span><span class=s1>&#39;engagement&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>users</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=n>simulate_engagement</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Experiment Design:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Total users: </span><span class=si>{</span><span class=n>n_users</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Randomization: 2√ó2 factorial (4 equal groups)&quot;</span><span class=p>)</span>

<span class=n>group_sizes</span> <span class=o>=</span> <span class=n>users</span><span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=s1>&#39;group&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>size</span><span class=p>()</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>  Group sizes:&quot;</span><span class=p>)</span>
<span class=k>for</span> <span class=n>group</span><span class=p>,</span> <span class=n>size</span> <span class=ow>in</span> <span class=n>group_sizes</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    </span><span class=si>{</span><span class=n>group</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>size</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> users (</span><span class=si>{</span><span class=n>size</span><span class=o>/</span><span class=n>n_users</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%)&quot;</span><span class=p>)</span>

<span class=c1># Print factorial table</span>
<span class=n>experiment</span><span class=o>.</span><span class=n>print_factorial_table</span><span class=p>(</span><span class=n>users</span><span class=p>,</span> <span class=s1>&#39;engagement&#39;</span><span class=p>)</span>

<span class=c1># Analyze results</span>
<span class=n>result</span> <span class=o>=</span> <span class=n>experiment</span><span class=o>.</span><span class=n>analyze_factorial</span><span class=p>(</span><span class=n>users</span><span class=p>,</span> <span class=s1>&#39;engagement&#39;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;FACTORIAL ANALYSIS RESULTS&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>1. Main Effects:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>feature_a</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>main_effect_a</span><span class=si>:</span><span class=s2>+.2f</span><span class=si>}</span><span class=s2> points&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>feature_b</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>main_effect_b</span><span class=si>:</span><span class=s2>+.2f</span><span class=si>}</span><span class=s2> points&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>2. Interaction Effect:&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Interaction: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>interaction_effect</span><span class=si>:</span><span class=s2>+.2f</span><span class=si>}</span><span class=s2> points&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   P-value: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>interaction_pvalue</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=k>if</span> <span class=n>result</span><span class=o>.</span><span class=n>has_significant_interaction</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   ‚úÖ SIGNIFICANT INTERACTION DETECTED&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>   Interpretation:&quot;</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>result</span><span class=o>.</span><span class=n>interaction_effect</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   üöÄ SYNERGISTIC: Features work better together!&quot;</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   - </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>feature_a</span><span class=si>}</span><span class=s2> alone: +</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>main_effect_a</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   - </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>feature_b</span><span class=si>}</span><span class=s2> alone: +</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>main_effect_b</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   - Expected if independent: +</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>main_effect_a</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>result</span><span class=o>.</span><span class=n>main_effect_b</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   - Actual together: +</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>main_effect_a</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>result</span><span class=o>.</span><span class=n>main_effect_b</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>result</span><span class=o>.</span><span class=n>interaction_effect</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   - Synergy bonus: +</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>interaction_effect</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   ‚ö†Ô∏è  ANTAGONISTIC: Features interfere with each other&quot;</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Combined effect (</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>main_effect_a</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>result</span><span class=o>.</span><span class=n>main_effect_b</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>result</span><span class=o>.</span><span class=n>interaction_effect</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>) &lt; Sum of individual effects (</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>main_effect_a</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>result</span><span class=o>.</span><span class=n>main_effect_b</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>
<span class=k>else</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   ‚ùå No significant interaction (effects are additive)&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   ‚Üí Can use layered experiments (more efficient)&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;DECISION&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=k>if</span> <span class=n>result</span><span class=o>.</span><span class=n>has_significant_interaction</span> <span class=ow>and</span> <span class=n>result</span><span class=o>.</span><span class=n>interaction_effect</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>‚úÖ SHIP BOTH FEATURES TOGETHER&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   - Individual: +</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>main_effect_a</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>% and +</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>main_effect_b</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>%&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   - Combined: +</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>main_effect_a</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>result</span><span class=o>.</span><span class=n>main_effect_b</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>result</span><span class=o>.</span><span class=n>interaction_effect</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>% (with synergy)&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   - Gain from shipping together: +</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>interaction_effect</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2> additional points&quot;</span><span class=p>)</span>
<span class=k>elif</span> <span class=n>result</span><span class=o>.</span><span class=n>has_significant_interaction</span> <span class=ow>and</span> <span class=n>result</span><span class=o>.</span><span class=n>interaction_effect</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>‚ö†Ô∏è  CAUTION: Features interfere&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   Options:&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   1. Ship only </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>feature_a</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>result</span><span class=o>.</span><span class=n>main_effect_a</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=o>.</span><span class=n>main_effect_b</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=n>result</span><span class=o>.</span><span class=n>feature_b</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   2. Iterate to reduce interference&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   3. A/B test: One vs Other vs Both&quot;</span><span class=p>)</span>
<span class=k>else</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üöÄ No interaction: Ship independently&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   Can use layered experiments for future tests (more efficient)&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=c1># Output:</span>
<span class=c1># ======================================================================</span>
<span class=c1># META - NEWS FEED RANKING + NOTIFICATION CADENCE</span>
<span class=c1># Factorial Experiment to Detect Interactions</span>
<span class=c1># ======================================================================</span>
<span class=c1># </span>
<span class=c1># Experiment Design:</span>
<span class=c1>#   Total users: 10,000</span>
<span class=c1>#   Randomization: 2√ó2 factorial (4 equal groups)</span>
<span class=c1># </span>
<span class=c1>#   Group sizes:</span>
<span class=c1>#     A=0,B=0: 2,487 users (24.9%)</span>
<span class=c1>#     A=0,B=1: 2,539 users (25.4%)</span>
<span class=c1>#     A=1,B=0: 2,518 users (25.2%)</span>
<span class=c1>#     A=1,B=1: 2,456 users (24.6%)</span>
<span class=c1># </span>
<span class=c1># 2√ó2 Factorial Table (engagement):</span>
<span class=c1># </span>
<span class=c1>#                     Notification Cadence</span>
<span class=c1>#                     OFF      ON</span>
<span class=c1>#                     ---------------</span>
<span class=c1># News Feed Ranking  OFF  | 99.87    102.96</span>
<span class=c1>#                    ON   | 103.05   108.93</span>
<span class=c1># </span>
<span class=c1># ======================================================================</span>
<span class=c1># FACTORIAL ANALYSIS RESULTS</span>
<span class=c1># ======================================================================</span>
<span class=c1># </span>
<span class=c1># 1. Main Effects:</span>
<span class=c1>#    News Feed Ranking: +3.08 points</span>
<span class=c1>#    Notification Cadence: +3.00 points</span>
<span class=c1># </span>
<span class=c1># 2. Interaction Effect:</span>
<span class=c1>#    Interaction: +2.01 points</span>
<span class=c1>#    P-value: 0.0000</span>
<span class=c1>#    ‚úÖ SIGNIFICANT INTERACTION DETECTED</span>
<span class=c1># </span>
<span class=c1>#    Interpretation:</span>
<span class=c1>#    üöÄ SYNERGISTIC: Features work better together!</span>
<span class=c1>#    - News Feed Ranking alone: +3.1</span>
<span class=c1>#    - Notification Cadence alone: +3.0</span>
<span class=c1>#    - Expected if independent: +6.1</span>
<span class=c1>#    - Actual together: +8.1</span>
<span class=c1>#    - Synergy bonus: +2.0</span>
<span class=c1># </span>
<span class=c1># ======================================================================</span>
<span class=c1># DECISION</span>
<span class=c1># ======================================================================</span>
<span class=c1># </span>
<span class=c1># ‚úÖ SHIP BOTH FEATURES TOGETHER</span>
<span class=c1>#    - Individual: +3% and +3%</span>
<span class=c1>#    - Combined: +8% (with synergy)</span>
<span class=c1>#    - Gain from shipping together: +2 additional points</span>
<span class=c1># </span>
<span class=c1># ======================================================================</span>
</code></pre></div> <p><strong>When to Use Each Strategy:</strong></p> <table> <thead> <tr> <th>Scenario</th> <th>Strategy</th> <th>Why</th> </tr> </thead> <tbody> <tr> <td><strong>Likely interaction</strong></td> <td>Factorial design</td> <td>Detects synergy/antagonism</td> </tr> <tr> <td><strong>Unlikely interaction</strong></td> <td>Layered experiments</td> <td>Efficient (uses all traffic)</td> </tr> <tr> <td><strong>Surface conflict</strong></td> <td>Mutual exclusion</td> <td>Can't show both at once</td> </tr> <tr> <td><strong>Many features (3+)</strong></td> <td>Partial factorial or sequential</td> <td>Full factorial too expensive</td> </tr> </tbody> </table> <p><strong>Interaction Detection:</strong></p> <table> <thead> <tr> <th>Method</th> <th>When to Use</th> <th>Output</th> </tr> </thead> <tbody> <tr> <td><strong>2-way ANOVA</strong></td> <td>2 features</td> <td>F-test for interaction term</td> </tr> <tr> <td><strong>Regression with interaction term</strong></td> <td>2+ features</td> <td>Coefficient on A√óB</td> </tr> <tr> <td><strong>Comparison of subgroups</strong></td> <td>Simple analysis</td> <td>Does A effect differ when B is on vs off?</td> </tr> </tbody> </table> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p><strong>What they test:</strong></p> <ul> <li>Do you know when interactions matter?</li> <li>Can you explain factorial design?</li> <li>Do you understand layered experiments?</li> </ul> <p><strong>Strong signal:</strong></p> <ul> <li>"Use 2√ó2 factorial to test all 4 combinations: A only, B only, both, neither"</li> <li>"Meta found +8% with both vs +3% each = +2% synergy"</li> <li>"Layered experiments assume no interaction‚Äîtest this first"</li> <li>"Interaction term in regression: Œ≤3(A√óB) captures synergy"</li> </ul> <p><strong>Red flags:</strong></p> <ul> <li>Running separate A/B tests without checking interactions</li> <li>Not knowing factorial design</li> <li>Assuming features are always independent</li> </ul> <p><strong>Follow-ups:</strong></p> <ul> <li>"How would you test 3 features (2√ó2√ó2 = 8 groups)?"</li> <li>"When would you use mutual exclusion vs factorial?"</li> <li>"What if you find negative interaction?"</li> </ul> </div> </details> <hr> <h3 id=what-is-a-ramp-up-gradual-rollout-strategy-and-when-should-you-use-it-all-companies-interview-question>What is a Ramp-Up (Gradual Rollout) Strategy and When Should You Use It? - All Companies Interview Question</h3> <p><strong>Difficulty:</strong> üü° Medium | <strong>Tags:</strong> <code>Deployment</code>, <code>Risk Management</code>, <code>Monitoring</code> | <strong>Asked by:</strong> All Companies, Especially Meta, Google, Netflix</p> <details class=success> <summary>View Answer</summary> <p><strong>Ramp-up (gradual rollout)</strong> is a <strong>risk mitigation strategy</strong> where treatment allocation <strong>increases incrementally</strong> (1% ‚Üí 5% ‚Üí 25% ‚Üí 50% ‚Üí 100%) over days/weeks, allowing <strong>early detection</strong> of bugs, crashes, or unexpected behavior before <strong>full exposure</strong>. Essential for <strong>high-risk changes</strong> (infrastructure, core algorithms, payment systems) where a catastrophic failure could impact millions.</p> <p><strong>Ramp-Up Phases:</strong></p> <table> <thead> <tr> <th>Phase</th> <th>% Exposed</th> <th>Duration</th> <th>Purpose</th> <th>Monitoring Focus</th> </tr> </thead> <tbody> <tr> <td><strong>Canary</strong></td> <td>1-5%</td> <td>1-2 days</td> <td>Catch critical bugs</td> <td>Crashes, errors, extreme outliers</td> </tr> <tr> <td><strong>Small rollout</strong></td> <td>10-25%</td> <td>3-5 days</td> <td>Validate metrics, performance</td> <td>Primary metrics, latency, load</td> </tr> <tr> <td><strong>Large rollout</strong></td> <td>50%</td> <td>1-2 weeks</td> <td>Full A/B test</td> <td>Statistical significance</td> </tr> <tr> <td><strong>Full launch</strong></td> <td>100%</td> <td>Permanent</td> <td>Ship to all</td> <td>Long-term monitoring</td> </tr> </tbody> </table> <p><strong>Real Company Examples:</strong></p> <table> <thead> <tr> <th>Company</th> <th>Feature</th> <th>Ramp-Up Schedule</th> <th>Issue Caught</th> <th>Outcome</th> </tr> </thead> <tbody> <tr> <td><strong>Spotify</strong></td> <td>New audio codec</td> <td>1% ‚Üí 5% ‚Üí 25% over 2 weeks</td> <td>5% phase: +8% crashes on Android 9</td> <td>Rolled back, fixed, relaunched</td> </tr> <tr> <td><strong>Meta</strong></td> <td>News Feed ranking</td> <td>5% ‚Üí 25% ‚Üí 50% over 10 days</td> <td>25% phase: +2% server load (manageable)</td> <td>Continued rollout</td> </tr> <tr> <td><strong>Netflix</strong></td> <td>New recommendation algo</td> <td>10% ‚Üí 50% ‚Üí 100% over 14 days</td> <td>No issues</td> <td>Completed rollout</td> </tr> <tr> <td><strong>Google Ads</strong></td> <td>Bidding algorithm change</td> <td>1% ‚Üí 10% ‚Üí 50% over 30 days</td> <td>10% phase: Negative for small advertisers</td> <td>Segmented rollout</td> </tr> </tbody> </table> <p><strong>Ramp-Up Framework:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          GRADUAL ROLLOUT (RAMP-UP) WORKFLOW              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                           ‚îÇ
‚îÇ  DAY 1-2: CANARY (1-5%)                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îÇ
‚îÇ  ‚îÇ Monitor:                       ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ - Crash rate                   ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ - Error rate                   ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ - Load time P95                ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ Decision: STOP or CONTINUE     ‚îÇ                ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îÇ
‚îÇ               ‚Üì PASS                                     ‚îÇ
‚îÇ  DAY 3-7: SMALL ROLLOUT (10-25%)                        ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îÇ
‚îÇ  ‚îÇ Monitor:                       ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ - Primary metrics (directional)‚îÇ                ‚îÇ
‚îÇ  ‚îÇ - Performance (latency, CPU)   ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ - Guardrails                   ‚îÇ                ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îÇ
‚îÇ               ‚Üì PASS                                     ‚îÇ
‚îÇ  DAY 8-21: FULL A/B TEST (50%)                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îÇ
‚îÇ  ‚îÇ Monitor:                       ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ - Statistical significance     ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ - Confidence intervals         ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ - Segment analysis             ‚îÇ                ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îÇ
‚îÇ               ‚Üì SHIP                                     ‚îÇ
‚îÇ  DAY 22+: FULL LAUNCH (100%)                            ‚îÇ
‚îÇ                                                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Production Code - Ramp-Up Manager:</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>datetime</span><span class=w> </span><span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timedelta</span>
<span class=kn>from</span><span class=w> </span><span class=nn>dataclasses</span><span class=w> </span><span class=kn>import</span> <span class=n>dataclass</span>
<span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Optional</span><span class=p>,</span> <span class=n>Dict</span>
<span class=kn>from</span><span class=w> </span><span class=nn>enum</span><span class=w> </span><span class=kn>import</span> <span class=n>Enum</span>

<span class=k>class</span><span class=w> </span><span class=nc>RampPhase</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
    <span class=n>CANARY</span> <span class=o>=</span> <span class=s2>&quot;canary&quot;</span>
    <span class=n>SMALL_ROLLOUT</span> <span class=o>=</span> <span class=s2>&quot;small_rollout&quot;</span>
    <span class=n>LARGE_ROLLOUT</span> <span class=o>=</span> <span class=s2>&quot;large_rollout&quot;</span>
    <span class=n>FULL_LAUNCH</span> <span class=o>=</span> <span class=s2>&quot;full_launch&quot;</span>

<span class=k>class</span><span class=w> </span><span class=nc>Decision</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
    <span class=n>CONTINUE</span> <span class=o>=</span> <span class=s2>&quot;continue&quot;</span>
    <span class=n>STOP</span> <span class=o>=</span> <span class=s2>&quot;stop&quot;</span>
    <span class=n>ROLLBACK</span> <span class=o>=</span> <span class=s2>&quot;rollback&quot;</span>

<span class=nd>@dataclass</span>
<span class=k>class</span><span class=w> </span><span class=nc>RampPhaseConfig</span><span class=p>:</span>
    <span class=n>phase</span><span class=p>:</span> <span class=n>RampPhase</span>
    <span class=n>exposure_pct</span><span class=p>:</span> <span class=nb>float</span>  <span class=c1># % of users exposed</span>
    <span class=n>duration_days</span><span class=p>:</span> <span class=nb>int</span>
    <span class=n>guardrail_thresholds</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>float</span><span class=p>]</span>

<span class=nd>@dataclass</span>
<span class=k>class</span><span class=w> </span><span class=nc>MonitoringResult</span><span class=p>:</span>
    <span class=n>phase</span><span class=p>:</span> <span class=n>RampPhase</span>
    <span class=n>day</span><span class=p>:</span> <span class=nb>int</span>
    <span class=n>exposure_pct</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>metrics</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>float</span><span class=p>]</span>
    <span class=n>guardrail_violations</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span>
    <span class=n>decision</span><span class=p>:</span> <span class=n>Decision</span>
    <span class=n>reason</span><span class=p>:</span> <span class=nb>str</span>

<span class=k>class</span><span class=w> </span><span class=nc>RampUpManager</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Manage gradual rollout with monitoring and decision gates.&quot;&quot;&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>ramp_schedule</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>RampPhaseConfig</span><span class=p>]):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>ramp_schedule</span> <span class=o>=</span> <span class=n>ramp_schedule</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>current_phase_idx</span> <span class=o>=</span> <span class=mi>0</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>monitoring_results</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>MonitoringResult</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>

    <span class=k>def</span><span class=w> </span><span class=nf>monitor_phase</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>metrics</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>float</span><span class=p>],</span> 
                     <span class=n>day</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>MonitoringResult</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Monitor current phase and decide whether to continue.</span>

<span class=sd>        Args:</span>
<span class=sd>            metrics: Current metric values (crash_rate, error_rate, etc.)</span>
<span class=sd>            day: Day number in rollout</span>

<span class=sd>        Returns:</span>
<span class=sd>            MonitoringResult with decision (continue/stop/rollback)</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>current_phase_config</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ramp_schedule</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>current_phase_idx</span><span class=p>]</span>
        <span class=n>phase</span> <span class=o>=</span> <span class=n>current_phase_config</span><span class=o>.</span><span class=n>phase</span>
        <span class=n>exposure</span> <span class=o>=</span> <span class=n>current_phase_config</span><span class=o>.</span><span class=n>exposure_pct</span>
        <span class=n>thresholds</span> <span class=o>=</span> <span class=n>current_phase_config</span><span class=o>.</span><span class=n>guardrail_thresholds</span>

        <span class=c1># Check guardrails</span>
        <span class=n>violations</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=k>for</span> <span class=n>metric_name</span><span class=p>,</span> <span class=n>threshold</span> <span class=ow>in</span> <span class=n>thresholds</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=k>if</span> <span class=n>metric_name</span> <span class=ow>in</span> <span class=n>metrics</span><span class=p>:</span>
                <span class=n>observed</span> <span class=o>=</span> <span class=n>metrics</span><span class=p>[</span><span class=n>metric_name</span><span class=p>]</span>
                <span class=k>if</span> <span class=n>observed</span> <span class=o>&gt;</span> <span class=n>threshold</span><span class=p>:</span>
                    <span class=n>violations</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
                        <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>metric_name</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>observed</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2> &gt; </span><span class=si>{</span><span class=n>threshold</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>&quot;</span>
                    <span class=p>)</span>

        <span class=c1># Decision logic</span>
        <span class=k>if</span> <span class=n>violations</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>phase</span> <span class=o>==</span> <span class=n>RampPhase</span><span class=o>.</span><span class=n>CANARY</span><span class=p>:</span>
                <span class=n>decision</span> <span class=o>=</span> <span class=n>Decision</span><span class=o>.</span><span class=n>STOP</span>
                <span class=n>reason</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;‚õî STOP: Guardrail violations in canary - </span><span class=si>{</span><span class=s1>&#39;, &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>violations</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>decision</span> <span class=o>=</span> <span class=n>Decision</span><span class=o>.</span><span class=n>ROLLBACK</span>
                <span class=n>reason</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;‚è™ ROLLBACK: Guardrail violations - </span><span class=si>{</span><span class=s1>&#39;, &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>violations</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>decision</span> <span class=o>=</span> <span class=n>Decision</span><span class=o>.</span><span class=n>CONTINUE</span>
            <span class=n>reason</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;‚úÖ CONTINUE: All guardrails passing&quot;</span>

        <span class=n>result</span> <span class=o>=</span> <span class=n>MonitoringResult</span><span class=p>(</span>
            <span class=n>phase</span><span class=o>=</span><span class=n>phase</span><span class=p>,</span>
            <span class=n>day</span><span class=o>=</span><span class=n>day</span><span class=p>,</span>
            <span class=n>exposure_pct</span><span class=o>=</span><span class=n>exposure</span><span class=p>,</span>
            <span class=n>metrics</span><span class=o>=</span><span class=n>metrics</span><span class=p>,</span>
            <span class=n>guardrail_violations</span><span class=o>=</span><span class=n>violations</span><span class=p>,</span>
            <span class=n>decision</span><span class=o>=</span><span class=n>decision</span><span class=p>,</span>
            <span class=n>reason</span><span class=o>=</span><span class=n>reason</span>
        <span class=p>)</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>monitoring_results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>

        <span class=k>return</span> <span class=n>result</span>

    <span class=k>def</span><span class=w> </span><span class=nf>advance_phase</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Advance to next phase.</span>

<span class=sd>        Returns:</span>
<span class=sd>            True if advanced, False if already at final phase</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>current_phase_idx</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>ramp_schedule</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>current_phase_idx</span> <span class=o>+=</span> <span class=mi>1</span>
            <span class=k>return</span> <span class=kc>True</span>
        <span class=k>return</span> <span class=kc>False</span>

    <span class=k>def</span><span class=w> </span><span class=nf>generate_report</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Generate rollout summary report.&quot;&quot;&quot;</span>
        <span class=n>report</span> <span class=o>=</span> <span class=p>[</span>
            <span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>,</span>
            <span class=s2>&quot;GRADUAL ROLLOUT SUMMARY&quot;</span><span class=p>,</span>
            <span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>,</span>
            <span class=s2>&quot;&quot;</span>
        <span class=p>]</span>

        <span class=k>for</span> <span class=n>result</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>monitoring_results</span><span class=p>:</span>
            <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Day </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>day</span><span class=si>}</span><span class=s2> | </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>phase</span><span class=o>.</span><span class=n>value</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>exposure_pct</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>% exposure)&quot;</span><span class=p>)</span>
            <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;-&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

            <span class=k>for</span> <span class=n>metric</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>result</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
                <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  </span><span class=si>{</span><span class=n>metric</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>value</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

            <span class=k>if</span> <span class=n>result</span><span class=o>.</span><span class=n>guardrail_violations</span><span class=p>:</span>
                <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  ‚ö†Ô∏è  Violations: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>result</span><span class=o>.</span><span class=n>guardrail_violations</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
                <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>result</span><span class=o>.</span><span class=n>guardrail_violations</span><span class=p>:</span>
                    <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;    - </span><span class=si>{</span><span class=n>v</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

            <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Decision: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>decision</span><span class=o>.</span><span class=n>value</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
            <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>reason</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
            <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;&quot;</span><span class=p>)</span>

        <span class=n>report</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

        <span class=k>return</span> <span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>report</span><span class=p>)</span>

<span class=c1># Example: Spotify audio codec rollout</span>
<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;SPOTIFY - NEW AUDIO CODEC GRADUAL ROLLOUT&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=c1># Define ramp schedule</span>
<span class=n>ramp_schedule</span> <span class=o>=</span> <span class=p>[</span>
    <span class=n>RampPhaseConfig</span><span class=p>(</span>
        <span class=n>phase</span><span class=o>=</span><span class=n>RampPhase</span><span class=o>.</span><span class=n>CANARY</span><span class=p>,</span>
        <span class=n>exposure_pct</span><span class=o>=</span><span class=mf>1.0</span><span class=p>,</span>
        <span class=n>duration_days</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span>
        <span class=n>guardrail_thresholds</span><span class=o>=</span><span class=p>{</span>
            <span class=s1>&#39;crash_rate&#39;</span><span class=p>:</span> <span class=mf>0.005</span><span class=p>,</span>  <span class=c1># 0.5% max</span>
            <span class=s1>&#39;error_rate&#39;</span><span class=p>:</span> <span class=mf>0.01</span><span class=p>,</span>   <span class=c1># 1% max</span>
            <span class=s1>&#39;p95_latency&#39;</span><span class=p>:</span> <span class=mi>500</span>    <span class=c1># 500ms max</span>
        <span class=p>}</span>
    <span class=p>),</span>
    <span class=n>RampPhaseConfig</span><span class=p>(</span>
        <span class=n>phase</span><span class=o>=</span><span class=n>RampPhase</span><span class=o>.</span><span class=n>SMALL_ROLLOUT</span><span class=p>,</span>
        <span class=n>exposure_pct</span><span class=o>=</span><span class=mf>5.0</span><span class=p>,</span>
        <span class=n>duration_days</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>
        <span class=n>guardrail_thresholds</span><span class=o>=</span><span class=p>{</span>
            <span class=s1>&#39;crash_rate&#39;</span><span class=p>:</span> <span class=mf>0.005</span><span class=p>,</span>
            <span class=s1>&#39;error_rate&#39;</span><span class=p>:</span> <span class=mf>0.01</span><span class=p>,</span>
            <span class=s1>&#39;p95_latency&#39;</span><span class=p>:</span> <span class=mi>500</span><span class=p>,</span>
            <span class=s1>&#39;playback_start_time&#39;</span><span class=p>:</span> <span class=mf>2.5</span>  <span class=c1># 2.5s max</span>
        <span class=p>}</span>
    <span class=p>),</span>
    <span class=n>RampPhaseConfig</span><span class=p>(</span>
        <span class=n>phase</span><span class=o>=</span><span class=n>RampPhase</span><span class=o>.</span><span class=n>LARGE_ROLLOUT</span><span class=p>,</span>
        <span class=n>exposure_pct</span><span class=o>=</span><span class=mf>25.0</span><span class=p>,</span>
        <span class=n>duration_days</span><span class=o>=</span><span class=mi>7</span><span class=p>,</span>
        <span class=n>guardrail_thresholds</span><span class=o>=</span><span class=p>{</span>
            <span class=s1>&#39;crash_rate&#39;</span><span class=p>:</span> <span class=mf>0.005</span><span class=p>,</span>
            <span class=s1>&#39;error_rate&#39;</span><span class=p>:</span> <span class=mf>0.01</span><span class=p>,</span>
            <span class=s1>&#39;engagement_drop&#39;</span><span class=p>:</span> <span class=mf>0.02</span>  <span class=c1># Max 2% drop</span>
        <span class=p>}</span>
    <span class=p>),</span>
    <span class=n>RampPhaseConfig</span><span class=p>(</span>
        <span class=n>phase</span><span class=o>=</span><span class=n>RampPhase</span><span class=o>.</span><span class=n>FULL_LAUNCH</span><span class=p>,</span>
        <span class=n>exposure_pct</span><span class=o>=</span><span class=mf>100.0</span><span class=p>,</span>
        <span class=n>duration_days</span><span class=o>=</span><span class=mi>999</span><span class=p>,</span>  <span class=c1># Permanent</span>
        <span class=n>guardrail_thresholds</span><span class=o>=</span><span class=p>{}</span>
    <span class=p>)</span>
<span class=p>]</span>

<span class=n>manager</span> <span class=o>=</span> <span class=n>RampUpManager</span><span class=p>(</span><span class=n>ramp_schedule</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Ramp Schedule:&quot;</span><span class=p>)</span>
<span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>config</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>ramp_schedule</span><span class=p>):</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;  Phase </span><span class=si>{</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>config</span><span class=o>.</span><span class=n>phase</span><span class=o>.</span><span class=n>value</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span><span class=si>}</span><span class=s2> - </span><span class=si>{</span><span class=n>config</span><span class=o>.</span><span class=n>exposure_pct</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>% for </span><span class=si>{</span><span class=n>config</span><span class=o>.</span><span class=n>duration_days</span><span class=si>}</span><span class=s2> days&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;ROLLOUT EXECUTION&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=c1># Simulate rollout</span>
<span class=n>day</span> <span class=o>=</span> <span class=mi>1</span>
<span class=n>current_phase</span> <span class=o>=</span> <span class=mi>0</span>

<span class=c1># Day 1-2: Canary (healthy)</span>
<span class=k>for</span> <span class=n>d</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>):</span>
    <span class=n>metrics</span> <span class=o>=</span> <span class=p>{</span>
        <span class=s1>&#39;crash_rate&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mf>0.002</span><span class=p>,</span> <span class=mf>0.004</span><span class=p>),</span>
        <span class=s1>&#39;error_rate&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mf>0.005</span><span class=p>,</span> <span class=mf>0.008</span><span class=p>),</span>
        <span class=s1>&#39;p95_latency&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mi>400</span><span class=p>,</span> <span class=mi>480</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=n>result</span> <span class=o>=</span> <span class=n>manager</span><span class=o>.</span><span class=n>monitor_phase</span><span class=p>(</span><span class=n>metrics</span><span class=p>,</span> <span class=n>d</span><span class=p>)</span>

    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìÖ Day </span><span class=si>{</span><span class=n>d</span><span class=si>}</span><span class=s2> - </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>phase</span><span class=o>.</span><span class=n>value</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>exposure_pct</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>%)&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Crash rate: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;crash_rate&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2> (threshold: 0.005)&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Error rate: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;error_rate&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2> (threshold: 0.01)&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   P95 latency: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;p95_latency&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>ms (threshold: 500ms)&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>reason</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Advance to small rollout</span>
<span class=n>manager</span><span class=o>.</span><span class=n>advance_phase</span><span class=p>()</span>

<span class=c1># Day 3-5: Small rollout - PROBLEM DETECTED on Day 5</span>
<span class=k>for</span> <span class=n>d</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>6</span><span class=p>):</span>
    <span class=k>if</span> <span class=n>d</span> <span class=o>&lt;</span> <span class=mi>5</span><span class=p>:</span>
        <span class=c1># Days 3-4: Healthy</span>
        <span class=n>metrics</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s1>&#39;crash_rate&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mf>0.003</span><span class=p>,</span> <span class=mf>0.004</span><span class=p>),</span>
            <span class=s1>&#39;error_rate&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mf>0.006</span><span class=p>,</span> <span class=mf>0.009</span><span class=p>),</span>
            <span class=s1>&#39;p95_latency&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mi>420</span><span class=p>,</span> <span class=mi>480</span><span class=p>),</span>
            <span class=s1>&#39;playback_start_time&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mf>2.0</span><span class=p>,</span> <span class=mf>2.3</span><span class=p>)</span>
        <span class=p>}</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=c1># Day 5: CRASH SPIKE (Android 9 issue)</span>
        <span class=n>metrics</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s1>&#39;crash_rate&#39;</span><span class=p>:</span> <span class=mf>0.012</span><span class=p>,</span>  <span class=c1># ‚ö†Ô∏è  VIOLATION! 1.2% &gt; 0.5%</span>
            <span class=s1>&#39;error_rate&#39;</span><span class=p>:</span> <span class=mf>0.008</span><span class=p>,</span>
            <span class=s1>&#39;p95_latency&#39;</span><span class=p>:</span> <span class=mi>450</span><span class=p>,</span>
            <span class=s1>&#39;playback_start_time&#39;</span><span class=p>:</span> <span class=mf>2.2</span>
        <span class=p>}</span>

    <span class=n>result</span> <span class=o>=</span> <span class=n>manager</span><span class=o>.</span><span class=n>monitor_phase</span><span class=p>(</span><span class=n>metrics</span><span class=p>,</span> <span class=n>d</span><span class=p>)</span>

    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìÖ Day </span><span class=si>{</span><span class=n>d</span><span class=si>}</span><span class=s2> - </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>phase</span><span class=o>.</span><span class=n>value</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>exposure_pct</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>%)&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Crash rate: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;crash_rate&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2> (threshold: 0.005)&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Error rate: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;error_rate&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2> (threshold: 0.01)&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Playback start: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;playback_start_time&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>s (threshold: 2.5s)&quot;</span><span class=p>)</span>

    <span class=k>if</span> <span class=n>result</span><span class=o>.</span><span class=n>guardrail_violations</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   üö® VIOLATIONS DETECTED:&quot;</span><span class=p>)</span>
        <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>result</span><span class=o>.</span><span class=n>guardrail_violations</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;      - </span><span class=si>{</span><span class=n>v</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>reason</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

    <span class=k>if</span> <span class=n>result</span><span class=o>.</span><span class=n>decision</span> <span class=o>==</span> <span class=n>Decision</span><span class=o>.</span><span class=n>ROLLBACK</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>   ‚è™ ROLLBACK INITIATED&quot;</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   - Reverting 5</span><span class=si>% o</span><span class=s2>f users back to old codec&quot;</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   - Root cause: Android 9 decoding issue&quot;</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   - Action: Fix bug, retest, relaunch&quot;</span><span class=p>)</span>
        <span class=k>break</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;OUTCOME&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>‚úÖ SUCCESS: Caught critical bug at 5</span><span class=si>% e</span><span class=s2>xposure&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   - Blast radius: Only 5</span><span class=si>% o</span><span class=s2>f users affected&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   - Avoided: Rolling out crash to 100% (millions of users)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   - Cost of ramp-up: 5 days&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   - Value: Prevented major incident&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=n>manager</span><span class=o>.</span><span class=n>generate_report</span><span class=p>())</span>
</code></pre></div> <p><strong>When to Use Ramp-Up:</strong></p> <table> <thead> <tr> <th>Risk Level</th> <th>Change Type</th> <th>Ramp-Up Schedule</th> <th>Example</th> </tr> </thead> <tbody> <tr> <td><strong>Critical</strong></td> <td>Infrastructure, core algorithm</td> <td>1% ‚Üí 5% ‚Üí 25% ‚Üí 50% over 2-4 weeks</td> <td>Payment system, codec, ranking</td> </tr> <tr> <td><strong>High</strong></td> <td>Major feature, UI overhaul</td> <td>5% ‚Üí 25% ‚Üí 50% over 1-2 weeks</td> <td>Homepage redesign</td> </tr> <tr> <td><strong>Medium</strong></td> <td>Standard feature</td> <td>10% ‚Üí 50% over 1 week</td> <td>New filter, button</td> </tr> <tr> <td><strong>Low</strong></td> <td>Copy change, minor tweak</td> <td>50% A/B test immediately</td> <td>Button color</td> </tr> </tbody> </table> <p><strong>Guardrail Metrics by Phase:</strong></p> <table> <thead> <tr> <th>Phase</th> <th>Guardrails to Monitor</th> <th>Threshold Example</th> </tr> </thead> <tbody> <tr> <td><strong>Canary (1-5%)</strong></td> <td>Crashes, errors, extreme latency</td> <td>Crash rate &lt; 0.5%</td> </tr> <tr> <td><strong>Small (10-25%)</strong></td> <td>Performance, load, directional metrics</td> <td>P95 latency &lt; 500ms</td> </tr> <tr> <td><strong>Large (50%)</strong></td> <td>Primary metrics, statistical tests</td> <td>Engagement not &lt; -1%</td> </tr> </tbody> </table> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p><strong>What they test:</strong></p> <ul> <li>Do you know when to use gradual rollout?</li> <li>Can you design a ramp-up schedule?</li> <li>Do you understand blast radius?</li> </ul> <p><strong>Strong signal:</strong></p> <ul> <li>"Use 1% ‚Üí 5% ‚Üí 25% ramp for high-risk changes (codec, payment, ranking)"</li> <li>"Spotify caught +8% crash rate at 5% phase, rolled back"</li> <li>"Blast radius limited to 5% of users (saved millions from bad experience)"</li> <li>"Canary phase focuses on crashes/errors, large phase on metrics"</li> </ul> <p><strong>Red flags:</strong></p> <ul> <li>Immediately rolling out to 50% for high-risk changes</li> <li>No guardrail thresholds defined</li> <li>Not understanding difference between phases</li> </ul> <p><strong>Follow-ups:</strong></p> <ul> <li>"How would you decide the ramp-up schedule?"</li> <li>"What if you detect a problem at 25%?"</li> <li>"Trade-off between speed and safety?"</li> </ul> </div> </details> <hr> <h3 id=how-do-you-calculate-expected-revenue-impact-from-an-ab-test-e-commerce-interview-question>How Do You Calculate Expected Revenue Impact from an A/B Test? - E-commerce Interview Question</h3> <p><strong>Difficulty:</strong> üü° Medium | <strong>Tags:</strong> <code>Business Impact</code>, <code>ROI</code>, <code>Decision Making</code> | <strong>Asked by:</strong> Amazon, Shopify, Stripe, Uber, Airbnb</p> <details class=success> <summary>View Answer</summary> <p><strong>Expected revenue impact</strong> translates <strong>statistical lift</strong> (e.g., +2.5% CTR) into <strong>business value</strong> ($125K/month) by multiplying <strong>baseline revenue</strong> √ó <strong>observed lift</strong> √ó <strong>treatment percentage</strong> √ó <strong>rollout probability</strong>. Essential for <strong>prioritization</strong> (which experiment to run?) and <strong>launch decisions</strong> (is +1.2% lift worth shipping?).</p> <p><strong>Revenue Impact Formula:</strong></p> <div class=arithmatex>\[ \text{Expected Revenue} = \text{Baseline Revenue} \times \text{Lift} \times \text{Treatment \%} \times P(\text{Ship}) \]</div> <p><strong>Real Company Examples:</strong></p> <table> <thead> <tr> <th>Company</th> <th>Test</th> <th>Baseline Revenue</th> <th>Lift</th> <th>Treatment %</th> <th>P(Ship)</th> <th>Expected Impact</th> </tr> </thead> <tbody> <tr> <td><strong>Amazon</strong></td> <td>Product page redesign</td> <td>$100M/month</td> <td>+1.8%</td> <td>50%</td> <td>0.9</td> <td>$810K/month</td> </tr> <tr> <td><strong>Uber</strong></td> <td>Dynamic pricing algo</td> <td>$500M/month</td> <td>+0.5%</td> <td>100%</td> <td>0.95</td> <td>$2.38M/month</td> </tr> <tr> <td><strong>Airbnb</strong></td> <td>Search ranking change</td> <td>$50M/month</td> <td>+3.2%</td> <td>50%</td> <td>0.8</td> <td>$640K/month</td> </tr> <tr> <td><strong>Stripe</strong></td> <td>Checkout flow redesign</td> <td>$20M/month</td> <td>-0.3%</td> <td>50%</td> <td>0.0</td> <td>$0 (don't ship)</td> </tr> </tbody> </table> <p><strong>Uncertainty Quantification:</strong></p> <table> <thead> <tr> <th>Scenario</th> <th>Lift (95% CI)</th> <th>Expected Revenue</th> <th>Probability</th> </tr> </thead> <tbody> <tr> <td><strong>Conservative</strong></td> <td>Lower bound: +1.2%</td> <td>$60K/month</td> <td>2.5%</td> </tr> <tr> <td><strong>Most likely</strong></td> <td>Point estimate: +2.5%</td> <td>$125K/month</td> <td>50%</td> </tr> <tr> <td><strong>Optimistic</strong></td> <td>Upper bound: +3.8%</td> <td>$190K/month</td> <td>2.5%</td> </tr> </tbody> </table> <p><strong>Revenue Impact Framework:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      REVENUE IMPACT CALCULATION WORKFLOW                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                          ‚îÇ
‚îÇ  STEP 1: ESTIMATE BASELINE REVENUE                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ Baseline Revenue = Users √ó Conversion √ó AOV       ‚îÇ ‚îÇ
‚îÇ  ‚îÇ Example: 1M users √ó 5% √ó $100 = $5M/month         ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                      ‚Üì                                   ‚îÇ
‚îÇ  STEP 2: MEASURE LIFT FROM EXPERIMENT                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ Lift = (Treatment - Control) / Control            ‚îÇ ‚îÇ
‚îÇ  ‚îÇ Example: (5.2% - 5.0%) / 5.0% = +4%              ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                      ‚Üì                                   ‚îÇ
‚îÇ  STEP 3: APPLY TREATMENT PERCENTAGE                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ Adjusted = Baseline √ó Lift √ó Treatment %          ‚îÇ ‚îÇ
‚îÇ  ‚îÇ Example: $5M √ó 0.04 √ó 0.5 = $100K                 ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                      ‚Üì                                   ‚îÇ
‚îÇ  STEP 4: FACTOR IN LAUNCH PROBABILITY                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ Expected = Adjusted √ó P(Ship)                     ‚îÇ ‚îÇ
‚îÇ  ‚îÇ Example: $100K √ó 0.8 = $80K expected              ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                      ‚Üì                                   ‚îÇ
‚îÇ  STEP 5: QUANTIFY UNCERTAINTY (95% CI)                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ Conservative: $50K (lower bound)                  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ Most likely:  $100K (point estimate)              ‚îÇ ‚îÇ
‚îÇ  ‚îÇ Optimistic:   $150K (upper bound)                 ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Production Code - Revenue Impact Calculator:</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>from</span><span class=w> </span><span class=nn>dataclasses</span><span class=w> </span><span class=kn>import</span> <span class=n>dataclass</span>
<span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>Tuple</span><span class=p>,</span> <span class=n>Optional</span>

<span class=nd>@dataclass</span>
<span class=k>class</span><span class=w> </span><span class=nc>RevenueImpactResult</span><span class=p>:</span>
    <span class=n>baseline_revenue</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>lift</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>lift_ci_lower</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>lift_ci_upper</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>treatment_pct</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>ship_probability</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>expected_revenue</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>conservative_revenue</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>optimistic_revenue</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>decision</span><span class=p>:</span> <span class=nb>str</span>
    <span class=n>reasoning</span><span class=p>:</span> <span class=nb>str</span>

<span class=k>class</span><span class=w> </span><span class=nc>RevenueImpactCalculator</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Calculate expected revenue impact from A/B test results.&quot;&quot;&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>baseline_revenue</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>treatment_pct</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.5</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Args:</span>
<span class=sd>            baseline_revenue: Monthly revenue affected by test ($)</span>
<span class=sd>            treatment_pct: % of users in treatment (0.5 = 50%)</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>baseline_revenue</span> <span class=o>=</span> <span class=n>baseline_revenue</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>treatment_pct</span> <span class=o>=</span> <span class=n>treatment_pct</span>

    <span class=k>def</span><span class=w> </span><span class=nf>compute_lift_ci</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> 
                       <span class=n>control_conversion</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span>
                       <span class=n>treatment_conversion</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span>
                       <span class=n>n_control</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
                       <span class=n>n_treatment</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
                       <span class=n>alpha</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.05</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Tuple</span><span class=p>[</span><span class=nb>float</span><span class=p>,</span> <span class=nb>float</span><span class=p>,</span> <span class=nb>float</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Compute relative lift and 95% confidence interval.</span>

<span class=sd>        Args:</span>
<span class=sd>            control_conversion: Control group conversion rate</span>
<span class=sd>            treatment_conversion: Treatment group conversion rate</span>
<span class=sd>            n_control: Control sample size</span>
<span class=sd>            n_treatment: Treatment sample size</span>
<span class=sd>            alpha: Significance level (0.05 = 95% CI)</span>

<span class=sd>        Returns:</span>
<span class=sd>            (lift, ci_lower, ci_upper) as relative percentages</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=c1># Relative lift</span>
        <span class=n>lift</span> <span class=o>=</span> <span class=p>(</span><span class=n>treatment_conversion</span> <span class=o>-</span> <span class=n>control_conversion</span><span class=p>)</span> <span class=o>/</span> <span class=n>control_conversion</span>

        <span class=c1># Standard error of difference</span>
        <span class=n>se_control</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>control_conversion</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>control_conversion</span><span class=p>)</span> <span class=o>/</span> <span class=n>n_control</span><span class=p>)</span>
        <span class=n>se_treatment</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>treatment_conversion</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>treatment_conversion</span><span class=p>)</span> <span class=o>/</span> <span class=n>n_treatment</span><span class=p>)</span>
        <span class=n>se_diff</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>se_control</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>se_treatment</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span>

        <span class=c1># 95% CI for absolute difference</span>
        <span class=n>z_critical</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>norm</span><span class=o>.</span><span class=n>ppf</span><span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>alpha</span><span class=o>/</span><span class=mi>2</span><span class=p>)</span>
        <span class=n>diff</span> <span class=o>=</span> <span class=n>treatment_conversion</span> <span class=o>-</span> <span class=n>control_conversion</span>
        <span class=n>ci_diff_lower</span> <span class=o>=</span> <span class=n>diff</span> <span class=o>-</span> <span class=n>z_critical</span> <span class=o>*</span> <span class=n>se_diff</span>
        <span class=n>ci_diff_upper</span> <span class=o>=</span> <span class=n>diff</span> <span class=o>+</span> <span class=n>z_critical</span> <span class=o>*</span> <span class=n>se_diff</span>

        <span class=c1># Convert to relative lift</span>
        <span class=n>ci_lift_lower</span> <span class=o>=</span> <span class=n>ci_diff_lower</span> <span class=o>/</span> <span class=n>control_conversion</span>
        <span class=n>ci_lift_upper</span> <span class=o>=</span> <span class=n>ci_diff_upper</span> <span class=o>/</span> <span class=n>control_conversion</span>

        <span class=k>return</span> <span class=n>lift</span><span class=p>,</span> <span class=n>ci_lift_lower</span><span class=p>,</span> <span class=n>ci_lift_upper</span>

    <span class=k>def</span><span class=w> </span><span class=nf>estimate_ship_probability</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> 
                                 <span class=n>p_value</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span>
                                 <span class=n>guardrails_passing</span><span class=p>:</span> <span class=nb>bool</span><span class=p>,</span>
                                 <span class=n>stakeholder_support</span><span class=p>:</span> <span class=nb>bool</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>float</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Estimate probability of shipping based on test results.</span>

<span class=sd>        Args:</span>
<span class=sd>            p_value: Statistical significance</span>
<span class=sd>            guardrails_passing: No negative impacts on key metrics</span>
<span class=sd>            stakeholder_support: Business alignment</span>

<span class=sd>        Returns:</span>
<span class=sd>            Probability of shipping (0-1)</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=c1># Base probability from significance</span>
        <span class=k>if</span> <span class=n>p_value</span> <span class=o>&lt;</span> <span class=mf>0.01</span><span class=p>:</span>
            <span class=n>p_base</span> <span class=o>=</span> <span class=mf>0.95</span>
        <span class=k>elif</span> <span class=n>p_value</span> <span class=o>&lt;</span> <span class=mf>0.05</span><span class=p>:</span>
            <span class=n>p_base</span> <span class=o>=</span> <span class=mf>0.85</span>
        <span class=k>elif</span> <span class=n>p_value</span> <span class=o>&lt;</span> <span class=mf>0.10</span><span class=p>:</span>
            <span class=n>p_base</span> <span class=o>=</span> <span class=mf>0.50</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>p_base</span> <span class=o>=</span> <span class=mf>0.10</span>

        <span class=c1># Adjust for guardrails</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>guardrails_passing</span><span class=p>:</span>
            <span class=n>p_base</span> <span class=o>*=</span> <span class=mf>0.3</span>  <span class=c1># 70% reduction</span>

        <span class=c1># Adjust for stakeholder support</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>stakeholder_support</span><span class=p>:</span>
            <span class=n>p_base</span> <span class=o>*=</span> <span class=mf>0.5</span>  <span class=c1># 50% reduction</span>

        <span class=k>return</span> <span class=nb>min</span><span class=p>(</span><span class=n>p_base</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>calculate_impact</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span>
                       <span class=n>lift</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span>
                       <span class=n>lift_ci_lower</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span>
                       <span class=n>lift_ci_upper</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span>
                       <span class=n>ship_probability</span><span class=p>:</span> <span class=nb>float</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>RevenueImpactResult</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Calculate expected revenue impact with uncertainty.</span>

<span class=sd>        Args:</span>
<span class=sd>            lift: Observed relative lift (e.g., 0.025 = +2.5%)</span>
<span class=sd>            lift_ci_lower: Lower bound of 95% CI</span>
<span class=sd>            lift_ci_upper: Upper bound of 95% CI</span>
<span class=sd>            ship_probability: Probability of launching (0-1)</span>

<span class=sd>        Returns:</span>
<span class=sd>            RevenueImpactResult with expected values</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=c1># Expected revenue (point estimate)</span>
        <span class=n>expected_revenue</span> <span class=o>=</span> <span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>baseline_revenue</span> <span class=o>*</span> 
            <span class=n>lift</span> <span class=o>*</span> 
            <span class=bp>self</span><span class=o>.</span><span class=n>treatment_pct</span> <span class=o>*</span> 
            <span class=n>ship_probability</span>
        <span class=p>)</span>

        <span class=c1># Conservative (lower bound)</span>
        <span class=n>conservative_revenue</span> <span class=o>=</span> <span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>baseline_revenue</span> <span class=o>*</span> 
            <span class=n>lift_ci_lower</span> <span class=o>*</span> 
            <span class=bp>self</span><span class=o>.</span><span class=n>treatment_pct</span> <span class=o>*</span> 
            <span class=n>ship_probability</span>
        <span class=p>)</span>

        <span class=c1># Optimistic (upper bound)</span>
        <span class=n>optimistic_revenue</span> <span class=o>=</span> <span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>baseline_revenue</span> <span class=o>*</span> 
            <span class=n>lift_ci_upper</span> <span class=o>*</span> 
            <span class=bp>self</span><span class=o>.</span><span class=n>treatment_pct</span> <span class=o>*</span> 
            <span class=n>ship_probability</span>
        <span class=p>)</span>

        <span class=c1># Decision logic</span>
        <span class=k>if</span> <span class=n>lift_ci_lower</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>ship_probability</span> <span class=o>&gt;</span> <span class=mf>0.7</span><span class=p>:</span>
            <span class=n>decision</span> <span class=o>=</span> <span class=s2>&quot;SHIP&quot;</span>
            <span class=n>reasoning</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;Strong positive signal (lower bound: +</span><span class=si>{</span><span class=n>lift_ci_lower</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>), high ship probability&quot;</span>
        <span class=k>elif</span> <span class=n>lift</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>lift_ci_lower</span> <span class=o>&gt;</span> <span class=o>-</span><span class=mf>0.01</span> <span class=ow>and</span> <span class=n>ship_probability</span> <span class=o>&gt;</span> <span class=mf>0.5</span><span class=p>:</span>
            <span class=n>decision</span> <span class=o>=</span> <span class=s2>&quot;SHIP (with caution)&quot;</span>
            <span class=n>reasoning</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;Positive lift but wide CI, moderate confidence&quot;</span>
        <span class=k>elif</span> <span class=n>lift_ci_upper</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
            <span class=n>decision</span> <span class=o>=</span> <span class=s2>&quot;DON&#39;T SHIP&quot;</span>
            <span class=n>reasoning</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;Negative impact (upper bound: </span><span class=si>{</span><span class=n>lift_ci_upper</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>)&quot;</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>decision</span> <span class=o>=</span> <span class=s2>&quot;INCONCLUSIVE&quot;</span>
            <span class=n>reasoning</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;Unclear signal, consider running longer or iterating&quot;</span>

        <span class=k>return</span> <span class=n>RevenueImpactResult</span><span class=p>(</span>
            <span class=n>baseline_revenue</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>baseline_revenue</span><span class=p>,</span>
            <span class=n>lift</span><span class=o>=</span><span class=n>lift</span><span class=p>,</span>
            <span class=n>lift_ci_lower</span><span class=o>=</span><span class=n>lift_ci_lower</span><span class=p>,</span>
            <span class=n>lift_ci_upper</span><span class=o>=</span><span class=n>lift_ci_upper</span><span class=p>,</span>
            <span class=n>treatment_pct</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>treatment_pct</span><span class=p>,</span>
            <span class=n>ship_probability</span><span class=o>=</span><span class=n>ship_probability</span><span class=p>,</span>
            <span class=n>expected_revenue</span><span class=o>=</span><span class=n>expected_revenue</span><span class=p>,</span>
            <span class=n>conservative_revenue</span><span class=o>=</span><span class=n>conservative_revenue</span><span class=p>,</span>
            <span class=n>optimistic_revenue</span><span class=o>=</span><span class=n>optimistic_revenue</span><span class=p>,</span>
            <span class=n>decision</span><span class=o>=</span><span class=n>decision</span><span class=p>,</span>
            <span class=n>reasoning</span><span class=o>=</span><span class=n>reasoning</span>
        <span class=p>)</span>

<span class=c1># Example: Amazon product page redesign</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;AMAZON - PRODUCT PAGE REDESIGN REVENUE IMPACT&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=c1># Test results</span>
<span class=n>n_control</span> <span class=o>=</span> <span class=mi>50000</span>
<span class=n>n_treatment</span> <span class=o>=</span> <span class=mi>50000</span>
<span class=n>control_conversion</span> <span class=o>=</span> <span class=mf>0.05</span>  <span class=c1># 5% baseline</span>
<span class=n>treatment_conversion</span> <span class=o>=</span> <span class=mf>0.0518</span>  <span class=c1># 5.18% treatment</span>

<span class=n>baseline_revenue</span> <span class=o>=</span> <span class=mi>10_000_000</span>  <span class=c1># $10M/month baseline</span>
<span class=n>treatment_pct</span> <span class=o>=</span> <span class=mf>0.5</span>  <span class=c1># 50/50 split</span>

<span class=n>calculator</span> <span class=o>=</span> <span class=n>RevenueImpactCalculator</span><span class=p>(</span>
    <span class=n>baseline_revenue</span><span class=o>=</span><span class=n>baseline_revenue</span><span class=p>,</span>
    <span class=n>treatment_pct</span><span class=o>=</span><span class=n>treatment_pct</span>
<span class=p>)</span>

<span class=c1># Compute lift and CI</span>
<span class=n>lift</span><span class=p>,</span> <span class=n>ci_lower</span><span class=p>,</span> <span class=n>ci_upper</span> <span class=o>=</span> <span class=n>calculator</span><span class=o>.</span><span class=n>compute_lift_ci</span><span class=p>(</span>
    <span class=n>control_conversion</span><span class=o>=</span><span class=n>control_conversion</span><span class=p>,</span>
    <span class=n>treatment_conversion</span><span class=o>=</span><span class=n>treatment_conversion</span><span class=p>,</span>
    <span class=n>n_control</span><span class=o>=</span><span class=n>n_control</span><span class=p>,</span>
    <span class=n>n_treatment</span><span class=o>=</span><span class=n>n_treatment</span>
<span class=p>)</span>

<span class=c1># Run significance test</span>
<span class=n>successes_control</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>control_conversion</span> <span class=o>*</span> <span class=n>n_control</span><span class=p>)</span>
<span class=n>successes_treatment</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>treatment_conversion</span> <span class=o>*</span> <span class=n>n_treatment</span><span class=p>)</span>

<span class=n>contingency</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span>
    <span class=p>[</span><span class=n>successes_treatment</span><span class=p>,</span> <span class=n>n_treatment</span> <span class=o>-</span> <span class=n>successes_treatment</span><span class=p>],</span>
    <span class=p>[</span><span class=n>successes_control</span><span class=p>,</span> <span class=n>n_control</span> <span class=o>-</span> <span class=n>successes_control</span><span class=p>]</span>
<span class=p>])</span>
<span class=n>chi2</span><span class=p>,</span> <span class=n>p_value</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>chi2_contingency</span><span class=p>(</span><span class=n>contingency</span><span class=p>)</span>

<span class=c1># Estimate ship probability</span>
<span class=n>ship_prob</span> <span class=o>=</span> <span class=n>calculator</span><span class=o>.</span><span class=n>estimate_ship_probability</span><span class=p>(</span>
    <span class=n>p_value</span><span class=o>=</span><span class=n>p_value</span><span class=p>,</span>
    <span class=n>guardrails_passing</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
    <span class=n>stakeholder_support</span><span class=o>=</span><span class=kc>True</span>
<span class=p>)</span>

<span class=c1># Calculate impact</span>
<span class=n>result</span> <span class=o>=</span> <span class=n>calculator</span><span class=o>.</span><span class=n>calculate_impact</span><span class=p>(</span>
    <span class=n>lift</span><span class=o>=</span><span class=n>lift</span><span class=p>,</span>
    <span class=n>lift_ci_lower</span><span class=o>=</span><span class=n>ci_lower</span><span class=p>,</span>
    <span class=n>lift_ci_upper</span><span class=o>=</span><span class=n>ci_upper</span><span class=p>,</span>
    <span class=n>ship_probability</span><span class=o>=</span><span class=n>ship_prob</span>
<span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìä TEST RESULTS&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Control conversion:   </span><span class=si>{</span><span class=n>control_conversion</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2> (n=</span><span class=si>{</span><span class=n>n_control</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Treatment conversion: </span><span class=si>{</span><span class=n>treatment_conversion</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2> (n=</span><span class=si>{</span><span class=n>n_treatment</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Relative lift:        </span><span class=si>{</span><span class=n>lift</span><span class=si>:</span><span class=s2>+.2%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   95% CI:               [</span><span class=si>{</span><span class=n>ci_lower</span><span class=si>:</span><span class=s2>+.2%</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>ci_upper</span><span class=si>:</span><span class=s2>+.2%</span><span class=si>}</span><span class=s2>]&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   p-value:              </span><span class=si>{</span><span class=n>p_value</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üí∞ REVENUE IMPACT&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Baseline revenue:     $</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>baseline_revenue</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=s2>/month&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Treatment %:          </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>treatment_pct</span><span class=si>:</span><span class=s2>.0%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Ship probability:     </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>ship_probability</span><span class=si>:</span><span class=s2>.0%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>()</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Expected revenue:     $</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>expected_revenue</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=s2>/month&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Conservative (2.5%):  $</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>conservative_revenue</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=s2>/month&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Optimistic (97.5%):   $</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>optimistic_revenue</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=s2>/month&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>‚úÖ DECISION: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>decision</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>reasoning</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Annualized impact</span>
<span class=n>annual_impact</span> <span class=o>=</span> <span class=n>result</span><span class=o>.</span><span class=n>expected_revenue</span> <span class=o>*</span> <span class=mi>12</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìà ANNUALIZED IMPACT&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Expected: $</span><span class=si>{</span><span class=n>annual_impact</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=s2>/year&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Range:    [$</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>conservative_revenue</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>12</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=s2>, $</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>optimistic_revenue</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>12</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=s2>]/year&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=c1># Compare multiple scenarios</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;SCENARIO COMPARISON&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=n>scenarios</span> <span class=o>=</span> <span class=p>[</span>
    <span class=p>(</span><span class=s2>&quot;Strong winner&quot;</span><span class=p>,</span> <span class=mf>0.052</span><span class=p>,</span> <span class=mf>0.001</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>True</span><span class=p>),</span>
    <span class=p>(</span><span class=s2>&quot;Weak winner&quot;</span><span class=p>,</span> <span class=mf>0.0512</span><span class=p>,</span> <span class=mf>0.08</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>True</span><span class=p>),</span>
    <span class=p>(</span><span class=s2>&quot;Inconclusive&quot;</span><span class=p>,</span> <span class=mf>0.0505</span><span class=p>,</span> <span class=mf>0.15</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>True</span><span class=p>),</span>
    <span class=p>(</span><span class=s2>&quot;Guardrail failure&quot;</span><span class=p>,</span> <span class=mf>0.052</span><span class=p>,</span> <span class=mf>0.001</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>True</span><span class=p>),</span>
    <span class=p>(</span><span class=s2>&quot;No support&quot;</span><span class=p>,</span> <span class=mf>0.052</span><span class=p>,</span> <span class=mf>0.001</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span><span class=p>),</span>
<span class=p>]</span>

<span class=n>results_df</span> <span class=o>=</span> <span class=p>[]</span>

<span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>treat_conv</span><span class=p>,</span> <span class=n>p_val</span><span class=p>,</span> <span class=n>guardrails</span><span class=p>,</span> <span class=n>support</span> <span class=ow>in</span> <span class=n>scenarios</span><span class=p>:</span>
    <span class=n>lift_val</span><span class=p>,</span> <span class=n>ci_l</span><span class=p>,</span> <span class=n>ci_u</span> <span class=o>=</span> <span class=n>calculator</span><span class=o>.</span><span class=n>compute_lift_ci</span><span class=p>(</span>
        <span class=n>control_conversion</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span>
        <span class=n>treatment_conversion</span><span class=o>=</span><span class=n>treat_conv</span><span class=p>,</span>
        <span class=n>n_control</span><span class=o>=</span><span class=mi>50000</span><span class=p>,</span>
        <span class=n>n_treatment</span><span class=o>=</span><span class=mi>50000</span>
    <span class=p>)</span>

    <span class=n>ship_p</span> <span class=o>=</span> <span class=n>calculator</span><span class=o>.</span><span class=n>estimate_ship_probability</span><span class=p>(</span><span class=n>p_val</span><span class=p>,</span> <span class=n>guardrails</span><span class=p>,</span> <span class=n>support</span><span class=p>)</span>

    <span class=n>res</span> <span class=o>=</span> <span class=n>calculator</span><span class=o>.</span><span class=n>calculate_impact</span><span class=p>(</span><span class=n>lift_val</span><span class=p>,</span> <span class=n>ci_l</span><span class=p>,</span> <span class=n>ci_u</span><span class=p>,</span> <span class=n>ship_p</span><span class=p>)</span>

    <span class=n>results_df</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
        <span class=s1>&#39;Scenario&#39;</span><span class=p>:</span> <span class=n>name</span><span class=p>,</span>
        <span class=s1>&#39;Lift&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>lift_val</span><span class=si>:</span><span class=s2>+.1%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
        <span class=s1>&#39;p-value&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>p_val</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
        <span class=s1>&#39;Ship Prob&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>ship_p</span><span class=si>:</span><span class=s2>.0%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
        <span class=s1>&#39;Expected Revenue&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&quot;$</span><span class=si>{</span><span class=n>res</span><span class=o>.</span><span class=n>expected_revenue</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
        <span class=s1>&#39;Decision&#39;</span><span class=p>:</span> <span class=n>res</span><span class=o>.</span><span class=n>decision</span>
    <span class=p>})</span>

<span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>results_df</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=n>df</span><span class=o>.</span><span class=n>to_string</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>))</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
</code></pre></div> <p><strong>Key Considerations:</strong></p> <table> <thead> <tr> <th>Factor</th> <th>Impact on Expected Revenue</th> <th>Example</th> </tr> </thead> <tbody> <tr> <td><strong>Statistical significance</strong></td> <td>Higher p-value ‚Üí lower ship probability</td> <td>p=0.001: 95% ship prob, p=0.08: 50% ship prob</td> </tr> <tr> <td><strong>Confidence interval width</strong></td> <td>Wider CI ‚Üí higher uncertainty</td> <td>Narrow CI [+2.0%, +3.0%] vs wide [+0.5%, +4.5%]</td> </tr> <tr> <td><strong>Guardrail violations</strong></td> <td>Negative guardrails ‚Üí 70% reduction in ship prob</td> <td>Latency +10% ‚Üí don't ship</td> </tr> <tr> <td><strong>Treatment percentage</strong></td> <td>50% ‚Üí full impact, 10% ‚Üí 20% of impact</td> <td>50% split vs 10% holdout</td> </tr> </tbody> </table> <p><strong>Decision Framework:</strong></p> <table> <thead> <tr> <th>Scenario</th> <th>Lift</th> <th>CI Lower Bound</th> <th>p-value</th> <th>Decision</th> <th>Reasoning</th> </tr> </thead> <tbody> <tr> <td><strong>Strong winner</strong></td> <td>+3.5%</td> <td>+2.1%</td> <td>&lt;0.01</td> <td>SHIP</td> <td>Both point estimate and lower bound positive</td> </tr> <tr> <td><strong>Weak winner</strong></td> <td>+1.2%</td> <td>-0.3%</td> <td>0.08</td> <td>SHIP (caution)</td> <td>Positive lift but CI includes 0</td> </tr> <tr> <td><strong>Null result</strong></td> <td>+0.3%</td> <td>-1.5%</td> <td>0.45</td> <td>DON'T SHIP</td> <td>Not statistically significant</td> </tr> <tr> <td><strong>Loser</strong></td> <td>-2.1%</td> <td>-3.8%</td> <td>&lt;0.01</td> <td>DON'T SHIP</td> <td>Negative impact</td> </tr> </tbody> </table> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p><strong>What they test:</strong></p> <ul> <li>Can you translate statistical lift to business value?</li> <li>Do you quantify uncertainty (confidence intervals)?</li> <li>Do you factor in launch probability?</li> </ul> <p><strong>Strong signal:</strong></p> <ul> <li>"Expected revenue = $10M √ó +2.5% lift √ó 50% treatment √ó 90% ship prob = $112.5K/month"</li> <li>"Conservative estimate: $75K (lower CI), optimistic: $150K (upper CI)"</li> <li>"Need to factor in ship probability - guardrail violations reduce it by 70%"</li> <li>"Annualized impact: $1.35M/year helps prioritize vs other projects"</li> </ul> <p><strong>Red flags:</strong></p> <ul> <li>Only providing point estimate without uncertainty</li> <li>Not considering launch probability (assuming 100% ship)</li> <li>Ignoring treatment percentage in calculation</li> </ul> <p><strong>Follow-ups:</strong></p> <ul> <li>"How would you prioritize two experiments with different expected revenues?"</li> <li>"What if the confidence interval is very wide?"</li> <li>"How do you account for long-term vs short-term effects?"</li> </ul> </div> </details> <hr> <h3 id=what-is-propensity-score-matching-psm-and-when-should-you-use-it-google-netflix-interview-question>What is Propensity Score Matching (PSM) and When Should You Use It? - Google, Netflix Interview Question</h3> <p><strong>Difficulty:</strong> üî¥ Hard | <strong>Tags:</strong> <code>Causal Inference</code>, <code>Observational Studies</code>, <code>Treatment Effect Estimation</code> | <strong>Asked by:</strong> Google, Netflix, Meta, Uber</p> <details class=success> <summary>View Answer</summary> <p><strong>Propensity Score Matching (PSM)</strong> is a <strong>quasi-experimental technique</strong> for estimating <strong>causal effects</strong> from <strong>observational data</strong> (no randomization) by matching <strong>treated</strong> and <strong>control</strong> units with similar <strong>probability of receiving treatment</strong> (propensity score). Essential when <strong>randomization is infeasible</strong> (ethical constraints, historical data, natural experiments).</p> <p><strong>When to Use PSM:</strong></p> <table> <thead> <tr> <th>Scenario</th> <th>Can Randomize?</th> <th>Use PSM?</th> <th>Why?</th> </tr> </thead> <tbody> <tr> <td><strong>A/B test</strong></td> <td>Yes</td> <td>No</td> <td>Randomization ensures balance</td> </tr> <tr> <td><strong>Historical analysis</strong></td> <td>No</td> <td>Yes</td> <td>Users self-selected into treatment</td> </tr> <tr> <td><strong>Feature rollout (self-opt-in)</strong></td> <td>No</td> <td>Yes</td> <td>Power users more likely to adopt</td> </tr> <tr> <td><strong>Geographic launch</strong></td> <td>No</td> <td>Yes</td> <td>Cities differ systematically</td> </tr> <tr> <td><strong>Policy change</strong></td> <td>No</td> <td>Yes</td> <td>Treatment assigned by eligibility criteria</td> </tr> </tbody> </table> <p><strong>Real Company Examples:</strong></p> <table> <thead> <tr> <th>Company</th> <th>Use Case</th> <th>Problem</th> <th>PSM Solution</th> <th>Result</th> </tr> </thead> <tbody> <tr> <td><strong>Netflix</strong></td> <td>Evaluate binge-watching impact</td> <td>Bingers self-select (not random)</td> <td>Match bingers to non-bingers by viewing history</td> <td>Causal effect: +12% retention</td> </tr> <tr> <td><strong>Uber</strong></td> <td>Impact of driver incentives</td> <td>Opt-in program (high-performers join)</td> <td>Match opt-in drivers to similar non-opt-in</td> <td>True effect: +5% (vs +15% naive)</td> </tr> <tr> <td><strong>Meta</strong></td> <td>Messenger adoption impact</td> <td>Users choose to install Messenger</td> <td>Match installers to non-installers by demographics</td> <td>Causal effect: +8% engagement</td> </tr> <tr> <td><strong>Airbnb</strong></td> <td>Instant Book feature impact</td> <td>Hosts self-select into Instant Book</td> <td>Match Instant Book hosts to similar non-IB</td> <td>Causal effect: +18% bookings</td> </tr> </tbody> </table> <p><strong>PSM vs Other Methods:</strong></p> <table> <thead> <tr> <th>Method</th> <th>When to Use</th> <th>Advantage</th> <th>Limitation</th> </tr> </thead> <tbody> <tr> <td><strong>Randomized A/B test</strong></td> <td>Can randomize</td> <td>Gold standard, no confounding</td> <td>Expensive, slow, sometimes unethical</td> </tr> <tr> <td><strong>Propensity Score Matching</strong></td> <td>Can't randomize, rich covariates</td> <td>Balances observed confounders</td> <td>Only observed covariates balanced</td> </tr> <tr> <td><strong>Difference-in-Differences</strong></td> <td>Pre/post data, parallel trends</td> <td>Controls time trends</td> <td>Requires parallel trends assumption</td> </tr> <tr> <td><strong>Instrumental Variables</strong></td> <td>Natural experiment, valid instrument</td> <td>Handles unobserved confounding</td> <td>Hard to find valid instruments</td> </tr> <tr> <td><strong>Regression Discontinuity</strong></td> <td>Sharp cutoff in treatment assignment</td> <td>Clean identification</td> <td>Limited to threshold effects</td> </tr> </tbody> </table> <p><strong>Propensity Score Matching Framework:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     PROPENSITY SCORE MATCHING (PSM) WORKFLOW            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                          ‚îÇ
‚îÇ  STEP 1: ESTIMATE PROPENSITY SCORES                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ Logistic Regression:                              ‚îÇ ‚îÇ
‚îÇ  ‚îÇ P(Treatment=1 | X) = logit(Œ≤‚ÇÄ + Œ≤‚ÇÅX‚ÇÅ + ... )     ‚îÇ ‚îÇ
‚îÇ  ‚îÇ X = demographics, behavior, context               ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                     ‚Üì                                    ‚îÇ
‚îÇ  STEP 2: MATCH TREATED TO CONTROL                       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ For each treated unit:                            ‚îÇ ‚îÇ
‚îÇ  ‚îÇ - Find control with closest propensity score     ‚îÇ ‚îÇ
‚îÇ  ‚îÇ - Methods: Nearest neighbor, caliper, kernel     ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                     ‚Üì                                    ‚îÇ
‚îÇ  STEP 3: CHECK BALANCE                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ Standardized mean difference (SMD) &lt; 0.1         ‚îÇ ‚îÇ
‚îÇ  ‚îÇ for all covariates                                ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                     ‚Üì                                    ‚îÇ
‚îÇ  STEP 4: ESTIMATE TREATMENT EFFECT                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ ATT = E[Y‚ÇÅ - Y‚ÇÄ | T=1]                           ‚îÇ ‚îÇ
‚îÇ  ‚îÇ (Average Treatment Effect on Treated)             ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Production Code - Propensity Score Matching:</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>sklearn.linear_model</span><span class=w> </span><span class=kn>import</span> <span class=n>LogisticRegression</span>
<span class=kn>from</span><span class=w> </span><span class=nn>sklearn.neighbors</span><span class=w> </span><span class=kn>import</span> <span class=n>NearestNeighbors</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>from</span><span class=w> </span><span class=nn>dataclasses</span><span class=w> </span><span class=kn>import</span> <span class=n>dataclass</span>
<span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Tuple</span>

<span class=nd>@dataclass</span>
<span class=k>class</span><span class=w> </span><span class=nc>PSMResult</span><span class=p>:</span>
    <span class=n>att</span><span class=p>:</span> <span class=nb>float</span>  <span class=c1># Average Treatment Effect on Treated</span>
    <span class=n>att_se</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>att_ci</span><span class=p>:</span> <span class=n>Tuple</span><span class=p>[</span><span class=nb>float</span><span class=p>,</span> <span class=nb>float</span><span class=p>]</span>
    <span class=n>n_treated</span><span class=p>:</span> <span class=nb>int</span>
    <span class=n>n_matched_control</span><span class=p>:</span> <span class=nb>int</span>
    <span class=n>balance_check</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span>
    <span class=n>balance_passed</span><span class=p>:</span> <span class=nb>bool</span>

<span class=k>class</span><span class=w> </span><span class=nc>PropensityScoreMatcher</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Propensity Score Matching for causal inference from observational data.&quot;&quot;&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>caliper</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.05</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Args:</span>
<span class=sd>            caliper: Maximum propensity score distance for matching</span>
<span class=sd>                    (0.05 = 5% of propensity score standard deviation)</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>caliper</span> <span class=o>=</span> <span class=n>caliper</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>ps_model</span> <span class=o>=</span> <span class=kc>None</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>propensity_scores</span> <span class=o>=</span> <span class=kc>None</span>

    <span class=k>def</span><span class=w> </span><span class=nf>fit_propensity_model</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>X</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>treatment</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Estimate propensity scores using logistic regression.</span>

<span class=sd>        Args:</span>
<span class=sd>            X: Covariates (n_samples, n_features)</span>
<span class=sd>            treatment: Treatment indicator (1=treated, 0=control)</span>

<span class=sd>        Returns:</span>
<span class=sd>            Propensity scores (probability of treatment given X)</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>ps_model</span> <span class=o>=</span> <span class=n>LogisticRegression</span><span class=p>(</span><span class=n>max_iter</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span> <span class=n>random_state</span><span class=o>=</span><span class=mi>42</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>ps_model</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>treatment</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>propensity_scores</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ps_model</span><span class=o>.</span><span class=n>predict_proba</span><span class=p>(</span><span class=n>X</span><span class=p>)[:,</span> <span class=mi>1</span><span class=p>]</span>

        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>propensity_scores</span>

    <span class=k>def</span><span class=w> </span><span class=nf>match</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>treatment</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> 
             <span class=n>propensity_scores</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span>
             <span class=n>method</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;nearest&#39;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Match treated units to control units based on propensity scores.</span>

<span class=sd>        Args:</span>
<span class=sd>            treatment: Treatment indicator</span>
<span class=sd>            propensity_scores: Propensity scores for all units</span>
<span class=sd>            method: &#39;nearest&#39; (1:1 nearest neighbor with replacement)</span>

<span class=sd>        Returns:</span>
<span class=sd>            match_indices: For each treated unit, index of matched control</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>treated_idx</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>treatment</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
        <span class=n>control_idx</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>treatment</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>

        <span class=n>treated_ps</span> <span class=o>=</span> <span class=n>propensity_scores</span><span class=p>[</span><span class=n>treated_idx</span><span class=p>]</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
        <span class=n>control_ps</span> <span class=o>=</span> <span class=n>propensity_scores</span><span class=p>[</span><span class=n>control_idx</span><span class=p>]</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>

        <span class=c1># Find nearest neighbors</span>
        <span class=n>nn</span> <span class=o>=</span> <span class=n>NearestNeighbors</span><span class=p>(</span><span class=n>n_neighbors</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>metric</span><span class=o>=</span><span class=s1>&#39;euclidean&#39;</span><span class=p>)</span>
        <span class=n>nn</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>control_ps</span><span class=p>)</span>

        <span class=n>distances</span><span class=p>,</span> <span class=n>indices</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>kneighbors</span><span class=p>(</span><span class=n>treated_ps</span><span class=p>)</span>

        <span class=c1># Apply caliper (discard matches beyond threshold)</span>
        <span class=n>caliper_threshold</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>caliper</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>propensity_scores</span><span class=p>)</span>
        <span class=n>valid_matches</span> <span class=o>=</span> <span class=n>distances</span><span class=o>.</span><span class=n>flatten</span><span class=p>()</span> <span class=o>&lt;</span> <span class=n>caliper_threshold</span>

        <span class=c1># Map to original control indices</span>
        <span class=n>match_indices</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>treated_idx</span><span class=p>),</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=nb>int</span><span class=p>)</span>
        <span class=n>match_indices</span><span class=p>[</span><span class=n>valid_matches</span><span class=p>]</span> <span class=o>=</span> <span class=n>control_idx</span><span class=p>[</span><span class=n>indices</span><span class=o>.</span><span class=n>flatten</span><span class=p>()[</span><span class=n>valid_matches</span><span class=p>]]</span>

        <span class=k>return</span> <span class=n>match_indices</span>

    <span class=k>def</span><span class=w> </span><span class=nf>check_balance</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>X</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>treatment</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span>
                     <span class=n>match_indices</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span>
                     <span class=n>covariate_names</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Check covariate balance after matching using standardized mean difference.</span>

<span class=sd>        Args:</span>
<span class=sd>            X: Covariates</span>
<span class=sd>            treatment: Treatment indicator</span>
<span class=sd>            match_indices: Matched control indices for each treated</span>
<span class=sd>            covariate_names: Names of covariates</span>

<span class=sd>        Returns:</span>
<span class=sd>            DataFrame with SMD before and after matching</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>treated_idx</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>treatment</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
        <span class=n>control_idx</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>treatment</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>

        <span class=c1># Valid matches only</span>
        <span class=n>valid_treated</span> <span class=o>=</span> <span class=n>treated_idx</span><span class=p>[</span><span class=n>match_indices</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>]</span>
        <span class=n>valid_matched_control</span> <span class=o>=</span> <span class=n>match_indices</span><span class=p>[</span><span class=n>match_indices</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>]</span>

        <span class=n>balance_results</span> <span class=o>=</span> <span class=p>[]</span>

        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>cov_name</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>covariate_names</span><span class=p>):</span>
            <span class=c1># Before matching</span>
            <span class=n>treated_mean_before</span> <span class=o>=</span> <span class=n>X</span><span class=p>[</span><span class=n>treated_idx</span><span class=p>,</span> <span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
            <span class=n>control_mean_before</span> <span class=o>=</span> <span class=n>X</span><span class=p>[</span><span class=n>control_idx</span><span class=p>,</span> <span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
            <span class=n>pooled_std_before</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span>
                <span class=p>(</span><span class=n>X</span><span class=p>[</span><span class=n>treated_idx</span><span class=p>,</span> <span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>var</span><span class=p>()</span> <span class=o>+</span> <span class=n>X</span><span class=p>[</span><span class=n>control_idx</span><span class=p>,</span> <span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>var</span><span class=p>())</span> <span class=o>/</span> <span class=mi>2</span>
            <span class=p>)</span>
            <span class=n>smd_before</span> <span class=o>=</span> <span class=p>(</span><span class=n>treated_mean_before</span> <span class=o>-</span> <span class=n>control_mean_before</span><span class=p>)</span> <span class=o>/</span> <span class=n>pooled_std_before</span>

            <span class=c1># After matching</span>
            <span class=n>treated_mean_after</span> <span class=o>=</span> <span class=n>X</span><span class=p>[</span><span class=n>valid_treated</span><span class=p>,</span> <span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
            <span class=n>control_mean_after</span> <span class=o>=</span> <span class=n>X</span><span class=p>[</span><span class=n>valid_matched_control</span><span class=p>,</span> <span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
            <span class=n>pooled_std_after</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span>
                <span class=p>(</span><span class=n>X</span><span class=p>[</span><span class=n>valid_treated</span><span class=p>,</span> <span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>var</span><span class=p>()</span> <span class=o>+</span> <span class=n>X</span><span class=p>[</span><span class=n>valid_matched_control</span><span class=p>,</span> <span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>var</span><span class=p>())</span> <span class=o>/</span> <span class=mi>2</span>
            <span class=p>)</span>
            <span class=n>smd_after</span> <span class=o>=</span> <span class=p>(</span><span class=n>treated_mean_after</span> <span class=o>-</span> <span class=n>control_mean_after</span><span class=p>)</span> <span class=o>/</span> <span class=n>pooled_std_after</span>

            <span class=n>balance_results</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
                <span class=s1>&#39;Covariate&#39;</span><span class=p>:</span> <span class=n>cov_name</span><span class=p>,</span>
                <span class=s1>&#39;SMD Before&#39;</span><span class=p>:</span> <span class=n>smd_before</span><span class=p>,</span>
                <span class=s1>&#39;SMD After&#39;</span><span class=p>:</span> <span class=n>smd_after</span><span class=p>,</span>
                <span class=s1>&#39;Improved&#39;</span><span class=p>:</span> <span class=nb>abs</span><span class=p>(</span><span class=n>smd_after</span><span class=p>)</span> <span class=o>&lt;</span> <span class=nb>abs</span><span class=p>(</span><span class=n>smd_before</span><span class=p>),</span>
                <span class=s1>&#39;Balanced&#39;</span><span class=p>:</span> <span class=nb>abs</span><span class=p>(</span><span class=n>smd_after</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mf>0.1</span>
            <span class=p>})</span>

        <span class=k>return</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>balance_results</span><span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>estimate_att</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>y</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>treatment</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span>
                    <span class=n>match_indices</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>PSMResult</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Estimate Average Treatment Effect on Treated (ATT).</span>

<span class=sd>        Args:</span>
<span class=sd>            y: Outcome variable</span>
<span class=sd>            treatment: Treatment indicator</span>
<span class=sd>            match_indices: Matched control indices</span>

<span class=sd>        Returns:</span>
<span class=sd>            PSMResult with ATT, standard error, and confidence interval</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>treated_idx</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>treatment</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>

        <span class=c1># Valid matches only</span>
        <span class=n>valid_mask</span> <span class=o>=</span> <span class=n>match_indices</span> <span class=o>&gt;=</span> <span class=mi>0</span>
        <span class=n>valid_treated</span> <span class=o>=</span> <span class=n>treated_idx</span><span class=p>[</span><span class=n>valid_mask</span><span class=p>]</span>
        <span class=n>valid_matched_control</span> <span class=o>=</span> <span class=n>match_indices</span><span class=p>[</span><span class=n>valid_mask</span><span class=p>]</span>

        <span class=c1># Treatment effects for matched pairs</span>
        <span class=n>treatment_effects</span> <span class=o>=</span> <span class=n>y</span><span class=p>[</span><span class=n>valid_treated</span><span class=p>]</span> <span class=o>-</span> <span class=n>y</span><span class=p>[</span><span class=n>valid_matched_control</span><span class=p>]</span>

        <span class=c1># ATT and standard error</span>
        <span class=n>att</span> <span class=o>=</span> <span class=n>treatment_effects</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
        <span class=n>att_se</span> <span class=o>=</span> <span class=n>treatment_effects</span><span class=o>.</span><span class=n>std</span><span class=p>()</span> <span class=o>/</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>treatment_effects</span><span class=p>))</span>

        <span class=c1># 95% confidence interval</span>
        <span class=n>z_critical</span> <span class=o>=</span> <span class=mf>1.96</span>
        <span class=n>att_ci</span> <span class=o>=</span> <span class=p>(</span><span class=n>att</span> <span class=o>-</span> <span class=n>z_critical</span> <span class=o>*</span> <span class=n>att_se</span><span class=p>,</span> <span class=n>att</span> <span class=o>+</span> <span class=n>z_critical</span> <span class=o>*</span> <span class=n>att_se</span><span class=p>)</span>

        <span class=k>return</span> <span class=n>att</span><span class=p>,</span> <span class=n>att_se</span><span class=p>,</span> <span class=n>att_ci</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>valid_treated</span><span class=p>),</span> <span class=nb>len</span><span class=p>(</span><span class=n>valid_matched_control</span><span class=p>)</span>

<span class=c1># Example: Netflix binge-watching impact on retention (observational data)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;NETFLIX - BINGE-WATCHING IMPACT (PROPENSITY SCORE MATCHING)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=c1># Simulate observational data (users self-select into binge-watching)</span>
<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
<span class=n>n</span> <span class=o>=</span> <span class=mi>2000</span>

<span class=c1># Covariates that affect both binge-watching propensity AND retention</span>
<span class=n>viewing_hours_pre</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>exponential</span><span class=p>(</span><span class=n>scale</span><span class=o>=</span><span class=mi>15</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n</span><span class=p>)</span>  <span class=c1># Pre-period viewing</span>
<span class=n>account_age_months</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>36</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n</span><span class=p>)</span>
<span class=n>num_profiles</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>poisson</span><span class=p>(</span><span class=n>lam</span><span class=o>=</span><span class=mf>2.5</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span>

<span class=n>X</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>column_stack</span><span class=p>([</span><span class=n>viewing_hours_pre</span><span class=p>,</span> <span class=n>account_age_months</span><span class=p>,</span> <span class=n>num_profiles</span><span class=p>])</span>
<span class=n>covariate_names</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Viewing Hours (Pre)&#39;</span><span class=p>,</span> <span class=s1>&#39;Account Age (Months)&#39;</span><span class=p>,</span> <span class=s1>&#39;Num Profiles&#39;</span><span class=p>]</span>

<span class=c1># Treatment assignment (binge-watching) - OBSERVATIONAL (not random!)</span>
<span class=c1># High pre-viewing hours increases binge propensity (confounding!)</span>
<span class=n>propensity_true</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>/</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>exp</span><span class=p>(</span><span class=o>-</span><span class=p>(</span><span class=mf>0.1</span> <span class=o>*</span> <span class=n>viewing_hours_pre</span> <span class=o>-</span> <span class=mf>1.5</span><span class=p>)))</span>
<span class=n>treatment</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>binomial</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>propensity_true</span><span class=p>)</span>

<span class=c1># Outcome (retention after 30 days) - affected by BOTH treatment and covariates</span>
<span class=n>retention</span> <span class=o>=</span> <span class=p>(</span>
    <span class=mf>0.7</span> <span class=o>+</span>  <span class=c1># Baseline</span>
    <span class=mf>0.12</span> <span class=o>*</span> <span class=n>treatment</span> <span class=o>+</span>  <span class=c1># TRUE causal effect = +12pp</span>
    <span class=mf>0.01</span> <span class=o>*</span> <span class=n>viewing_hours_pre</span> <span class=o>+</span>  <span class=c1># Confounding!</span>
    <span class=mf>0.002</span> <span class=o>*</span> <span class=n>account_age_months</span> <span class=o>+</span>
    <span class=mf>0.02</span> <span class=o>*</span> <span class=n>num_profiles</span> <span class=o>+</span>
    <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n</span><span class=p>)</span>
<span class=p>)</span>
<span class=n>retention</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>clip</span><span class=p>(</span><span class=n>retention</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìä OBSERVATIONAL DATA&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Total users: </span><span class=si>{</span><span class=n>n</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Bingers (treatment): </span><span class=si>{</span><span class=n>treatment</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=n>treatment</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Non-bingers (control): </span><span class=si>{</span><span class=p>(</span><span class=mi>1</span><span class=o>-</span><span class=n>treatment</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Naive comparison (BIASED!)</span>
<span class=n>naive_retention_treatment</span> <span class=o>=</span> <span class=n>retention</span><span class=p>[</span><span class=n>treatment</span> <span class=o>==</span> <span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
<span class=n>naive_retention_control</span> <span class=o>=</span> <span class=n>retention</span><span class=p>[</span><span class=n>treatment</span> <span class=o>==</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
<span class=n>naive_effect</span> <span class=o>=</span> <span class=n>naive_retention_treatment</span> <span class=o>-</span> <span class=n>naive_retention_control</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>‚ùå NAIVE COMPARISON (BIASED)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Bingers retention:     </span><span class=si>{</span><span class=n>naive_retention_treatment</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Non-bingers retention: </span><span class=si>{</span><span class=n>naive_retention_control</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Naive effect:          </span><span class=si>{</span><span class=n>naive_effect</span><span class=si>:</span><span class=s2>+.2%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   ‚ö†Ô∏è  BIASED! Includes confounding from pre-viewing hours&quot;</span><span class=p>)</span>

<span class=c1># Propensity Score Matching</span>
<span class=n>matcher</span> <span class=o>=</span> <span class=n>PropensityScoreMatcher</span><span class=p>(</span><span class=n>caliper</span><span class=o>=</span><span class=mf>0.05</span><span class=p>)</span>

<span class=c1># Step 1: Fit propensity model</span>
<span class=n>ps_scores</span> <span class=o>=</span> <span class=n>matcher</span><span class=o>.</span><span class=n>fit_propensity_model</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>treatment</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìà PROPENSITY SCORE MODEL&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Logistic regression trained on </span><span class=si>{</span><span class=n>X</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=si>}</span><span class=s2> covariates&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Propensity score range: [</span><span class=si>{</span><span class=n>ps_scores</span><span class=o>.</span><span class=n>min</span><span class=p>()</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>ps_scores</span><span class=o>.</span><span class=n>max</span><span class=p>()</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>]&quot;</span><span class=p>)</span>

<span class=c1># Step 2: Match treated to control</span>
<span class=n>match_idx</span> <span class=o>=</span> <span class=n>matcher</span><span class=o>.</span><span class=n>match</span><span class=p>(</span><span class=n>treatment</span><span class=p>,</span> <span class=n>ps_scores</span><span class=p>)</span>
<span class=n>n_matched</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>match_idx</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üîó MATCHING&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Treated units: </span><span class=si>{</span><span class=n>treatment</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Matched pairs: </span><span class=si>{</span><span class=n>n_matched</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Match rate: </span><span class=si>{</span><span class=n>n_matched</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>treatment</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Step 3: Check balance</span>
<span class=n>balance_df</span> <span class=o>=</span> <span class=n>matcher</span><span class=o>.</span><span class=n>check_balance</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>treatment</span><span class=p>,</span> <span class=n>match_idx</span><span class=p>,</span> <span class=n>covariate_names</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>‚öñÔ∏è  COVARIATE BALANCE CHECK&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>balance_df</span><span class=o>.</span><span class=n>to_string</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>))</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>   All covariates balanced: </span><span class=si>{</span><span class=n>balance_df</span><span class=p>[</span><span class=s1>&#39;Balanced&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>all</span><span class=p>()</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;   (SMD &lt; 0.1 is considered balanced)&quot;</span><span class=p>)</span>

<span class=c1># Step 4: Estimate ATT</span>
<span class=n>att</span><span class=p>,</span> <span class=n>att_se</span><span class=p>,</span> <span class=n>att_ci</span><span class=p>,</span> <span class=n>n_treat</span><span class=p>,</span> <span class=n>n_ctrl</span> <span class=o>=</span> <span class=n>matcher</span><span class=o>.</span><span class=n>estimate_att</span><span class=p>(</span><span class=n>retention</span><span class=p>,</span> <span class=n>treatment</span><span class=p>,</span> <span class=n>match_idx</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>‚úÖ CAUSAL EFFECT (PSM)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   ATT (Average Treatment Effect on Treated): </span><span class=si>{</span><span class=n>att</span><span class=si>:</span><span class=s2>+.2%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Standard error: </span><span class=si>{</span><span class=n>att_se</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   95% CI: [</span><span class=si>{</span><span class=n>att_ci</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>:</span><span class=s2>+.2%</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>att_ci</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=si>:</span><span class=s2>+.2%</span><span class=si>}</span><span class=s2>]&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Sample: </span><span class=si>{</span><span class=n>n_treat</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> treated, </span><span class=si>{</span><span class=n>n_ctrl</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2> matched controls&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìä COMPARISON&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Naive effect:  </span><span class=si>{</span><span class=n>naive_effect</span><span class=si>:</span><span class=s2>+.2%</span><span class=si>}</span><span class=s2> (BIASED by confounding)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   PSM effect:    </span><span class=si>{</span><span class=n>att</span><span class=si>:</span><span class=s2>+.2%</span><span class=si>}</span><span class=s2> (Causal, balanced covariates)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   True effect:   +12.00% (by design in simulation)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   PSM accuracy:  </span><span class=si>{</span><span class=nb>abs</span><span class=p>(</span><span class=n>att</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mf>0.12</span><span class=p>)</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2> error&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
</code></pre></div> <p><strong>Key Assumptions of PSM:</strong></p> <table> <thead> <tr> <th>Assumption</th> <th>Description</th> <th>How to Check</th> <th>What if Violated?</th> </tr> </thead> <tbody> <tr> <td><strong>Unconfoundedness</strong></td> <td>All confounders are observed and measured</td> <td>Cannot test directly</td> <td>Estimate biased if unobserved confounders exist</td> </tr> <tr> <td><strong>Common support</strong></td> <td>Treated and control have overlapping propensity scores</td> <td>Plot propensity score distributions</td> <td>Trim extreme propensity scores</td> </tr> <tr> <td><strong>SUTVA</strong></td> <td>No interference between units</td> <td>Check experimental design</td> <td>Use cluster-robust SE or different method</td> </tr> </tbody> </table> <p><strong>Balance Check (SMD Thresholds):</strong></p> <table> <thead> <tr> <th>SMD Value</th> <th>Balance Quality</th> <th>Action</th> </tr> </thead> <tbody> <tr> <td><strong>&lt; 0.1</strong></td> <td>Excellent balance</td> <td>Proceed with analysis</td> </tr> <tr> <td><strong>0.1 - 0.25</strong></td> <td>Acceptable balance</td> <td>Proceed with caution</td> </tr> <tr> <td><strong>&gt; 0.25</strong></td> <td>Poor balance</td> <td>Re-specify propensity model or use different method</td> </tr> </tbody> </table> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p><strong>What they test:</strong></p> <ul> <li>Do you understand when PSM is needed (observational data, self-selection)?</li> <li>Can you explain propensity score estimation and matching?</li> <li>Do you check covariate balance (SMD &lt; 0.1)?</li> </ul> <p><strong>Strong signal:</strong></p> <ul> <li>"Use PSM when randomization is infeasible and users self-select into treatment"</li> <li>"Netflix bingers self-select (high pre-viewing hours) - naive comparison is biased"</li> <li>"After matching on propensity scores, SMD &lt; 0.1 for all covariates = balance achieved"</li> <li>"ATT = +12% retention (vs +18% naive) - removed confounding from pre-behavior"</li> <li>"Limitation: Only balances observed covariates, unobserved confounding still biases estimate"</li> </ul> <p><strong>Red flags:</strong></p> <ul> <li>Not understanding difference between observational and experimental data</li> <li>Skipping balance checks (SMD)</li> <li>Not acknowledging limitation (unobserved confounding)</li> </ul> <p><strong>Follow-ups:</strong></p> <ul> <li>"What if balance checks fail (SMD &gt; 0.25)?"</li> <li>"How would you handle unobserved confounding?"</li> <li>"PSM vs Difference-in-Differences - which to use when?"</li> </ul> </div> </details> <hr> <h3 id=what-is-difference-in-differences-did-and-when-should-you-use-it-google-uber-interview-question>What is Difference-in-Differences (DiD) and When Should You Use It? - Google, Uber Interview Question</h3> <p><strong>Difficulty:</strong> üî¥ Hard | <strong>Tags:</strong> <code>Causal Inference</code>, <code>Quasi-Experiments</code>, <code>Panel Data</code> | <strong>Asked by:</strong> Google, Uber, Airbnb, Lyft</p> <details class=success> <summary>View Answer</summary> <p><strong>Difference-in-Differences (DiD)</strong> estimates <strong>causal effects</strong> by comparing the <strong>change over time</strong> in a <strong>treatment group</strong> vs a <strong>control group</strong>, effectively using the control group to <strong>remove time trends</strong> that affect both groups. Essential for <strong>quasi-experiments</strong> (geographic rollouts, policy changes, staggered launches) where <strong>randomization is impossible</strong> but <strong>pre-treatment data</strong> is available.</p> <p><strong>DiD Formula:</strong></p> <div class=arithmatex>\[ \text{DiD} = (Y_{T,post} - Y_{T,pre}) - (Y_{C,post} - Y_{C,pre}) \]</div> <p>Where: - <span class=arithmatex>\(Y_{T,post}\)</span>: Treatment group outcome after intervention - <span class=arithmatex>\(Y_{T,pre}\)</span>: Treatment group outcome before intervention - <span class=arithmatex>\(Y_{C,post}\)</span>: Control group outcome after intervention<br> - <span class=arithmatex>\(Y_{C,pre}\)</span>: Control group outcome before intervention</p> <p><strong>Real Company Examples:</strong></p> <table> <thead> <tr> <th>Company</th> <th>Use Case</th> <th>Treatment Group</th> <th>Control Group</th> <th>Pre Period</th> <th>Result</th> </tr> </thead> <tbody> <tr> <td><strong>Uber</strong></td> <td>New pricing in SF</td> <td>San Francisco</td> <td>Los Angeles</td> <td>8 weeks</td> <td>+12% trips (DiD)</td> </tr> <tr> <td><strong>Airbnb</strong></td> <td>Instant Book in NYC</td> <td>New York City</td> <td>Chicago</td> <td>12 weeks</td> <td>+18% bookings (DiD)</td> </tr> <tr> <td><strong>DoorDash</strong></td> <td>Incentive program in Austin</td> <td>Austin</td> <td>Dallas</td> <td>6 weeks</td> <td>+8% orders (DiD)</td> </tr> <tr> <td><strong>Google Ads</strong></td> <td>Algorithm change (EU only)</td> <td>EU countries</td> <td>US</td> <td>4 weeks</td> <td>+3.2% CTR (DiD)</td> </tr> </tbody> </table> <p><strong>DiD vs Other Methods:</strong></p> <table> <thead> <tr> <th>Method</th> <th>Data Requirement</th> <th>Assumption</th> <th>Best Use Case</th> </tr> </thead> <tbody> <tr> <td><strong>Randomized A/B Test</strong></td> <td>Randomization possible</td> <td>None</td> <td>General experiments</td> </tr> <tr> <td><strong>Difference-in-Differences</strong></td> <td>Pre/post data, parallel trends</td> <td>Parallel trends in pre-period</td> <td>Geographic rollouts, policy changes</td> </tr> <tr> <td><strong>Propensity Score Matching</strong></td> <td>Rich covariates</td> <td>Unconfoundedness</td> <td>Self-selection, observational</td> </tr> <tr> <td><strong>Regression Discontinuity</strong></td> <td>Sharp cutoff</td> <td>Continuity at threshold</td> <td>Eligibility cutoffs</td> </tr> </tbody> </table> <p><strong>Parallel Trends Assumption (Critical!):</strong></p> <table> <thead> <tr> <th>Time Period</th> <th>Treatment Group</th> <th>Control Group</th> <th>Interpretation</th> </tr> </thead> <tbody> <tr> <td><strong>Pre-period (weeks 1-8)</strong></td> <td>+2% growth</td> <td>+2% growth</td> <td>‚úÖ Parallel trends hold</td> </tr> <tr> <td><strong>Post-period (weeks 9-12)</strong></td> <td>+14% growth</td> <td>+2% growth</td> <td>DiD = +14% - 2% = +12% causal effect</td> </tr> </tbody> </table> <p><strong>Difference-in-Differences Framework:</strong></p> <div class=highlight><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     DIFFERENCE-IN-DIFFERENCES (DiD) WORKFLOW            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                          ‚îÇ
‚îÇ  STEP 1: COLLECT PRE/POST DATA                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ Treatment group: Y_T,pre ‚Üí Y_T,post              ‚îÇ ‚îÇ
‚îÇ  ‚îÇ Control group:   Y_C,pre ‚Üí Y_C,post              ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                     ‚Üì                                    ‚îÇ
‚îÇ  STEP 2: CHECK PARALLEL TRENDS (PRE-PERIOD)             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ Plot trends: Should be parallel before treatment ‚îÇ ‚îÇ
‚îÇ  ‚îÇ Test: Interaction of group √ó time trend = 0      ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                     ‚Üì                                    ‚îÇ
‚îÇ  STEP 3: COMPUTE DiD ESTIMATOR                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ Œî_T = Y_T,post - Y_T,pre  (treatment change)     ‚îÇ ‚îÇ
‚îÇ  ‚îÇ Œî_C = Y_C,post - Y_C,pre  (control change)       ‚îÇ ‚îÇ
‚îÇ  ‚îÇ DiD = Œî_T - Œî_C           (causal effect)        ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                     ‚Üì                                    ‚îÇ
‚îÇ  STEP 4: REGRESSION SPECIFICATION                       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ Y = Œ≤‚ÇÄ + Œ≤‚ÇÅ¬∑Post + Œ≤‚ÇÇ¬∑Treat + Œ≤‚ÇÉ¬∑(Post√óTreat)   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ DiD = Œ≤‚ÇÉ (interaction coefficient)               ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Production Code - Difference-in-Differences:</strong></p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<span class=kn>from</span><span class=w> </span><span class=nn>scipy</span><span class=w> </span><span class=kn>import</span> <span class=n>stats</span>
<span class=kn>import</span><span class=w> </span><span class=nn>statsmodels.formula.api</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>smf</span>
<span class=kn>from</span><span class=w> </span><span class=nn>dataclasses</span><span class=w> </span><span class=kn>import</span> <span class=n>dataclass</span>
<span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>Tuple</span>

<span class=nd>@dataclass</span>
<span class=k>class</span><span class=w> </span><span class=nc>DiDResult</span><span class=p>:</span>
    <span class=n>did_estimate</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>did_se</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>did_ci</span><span class=p>:</span> <span class=n>Tuple</span><span class=p>[</span><span class=nb>float</span><span class=p>,</span> <span class=nb>float</span><span class=p>]</span>
    <span class=n>p_value</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>parallel_trends_test_pvalue</span><span class=p>:</span> <span class=nb>float</span>
    <span class=n>parallel_trends_passed</span><span class=p>:</span> <span class=nb>bool</span>

<span class=k>class</span><span class=w> </span><span class=nc>DifferenceInDifferences</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Difference-in-Differences estimator for causal inference.&quot;&quot;&quot;</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>regression_result</span> <span class=o>=</span> <span class=kc>None</span>

    <span class=k>def</span><span class=w> </span><span class=nf>test_parallel_trends</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span> 
                             <span class=n>pre_period_only</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>float</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Test parallel trends assumption in pre-period.</span>

<span class=sd>        Args:</span>
<span class=sd>            df: DataFrame with columns [outcome, group, time_period, post]</span>
<span class=sd>            pre_period_only: Only use pre-treatment period</span>

<span class=sd>        Returns:</span>
<span class=sd>            p-value for group √ó time_period interaction (should be &gt; 0.05)</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=n>pre_period_only</span><span class=p>:</span>
            <span class=n>df_pre</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;post&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>df_pre</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>

        <span class=c1># Regression: outcome ~ group + time_period + group√ótime_period</span>
        <span class=n>model</span> <span class=o>=</span> <span class=n>smf</span><span class=o>.</span><span class=n>ols</span><span class=p>(</span><span class=s1>&#39;outcome ~ group + time_period + group:time_period&#39;</span><span class=p>,</span> 
                       <span class=n>data</span><span class=o>=</span><span class=n>df_pre</span><span class=p>)</span>
        <span class=n>result</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>fit</span><span class=p>()</span>

        <span class=c1># Extract interaction p-value</span>
        <span class=n>interaction_pvalue</span> <span class=o>=</span> <span class=n>result</span><span class=o>.</span><span class=n>pvalues</span><span class=p>[</span><span class=s1>&#39;group:time_period&#39;</span><span class=p>]</span>

        <span class=k>return</span> <span class=n>interaction_pvalue</span>

    <span class=k>def</span><span class=w> </span><span class=nf>estimate_did</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>DiDResult</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Estimate DiD using regression.</span>

<span class=sd>        Args:</span>
<span class=sd>            df: DataFrame with columns [outcome, treat, post]</span>
<span class=sd>                - outcome: Continuous outcome variable</span>
<span class=sd>                - treat: Treatment group indicator (1=treatment, 0=control)</span>
<span class=sd>                - post: Post-period indicator (1=post, 0=pre)</span>

<span class=sd>        Returns:</span>
<span class=sd>            DiDResult with estimate, SE, CI, p-value</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=c1># Regression: Y = Œ≤‚ÇÄ + Œ≤‚ÇÅ¬∑post + Œ≤‚ÇÇ¬∑treat + Œ≤‚ÇÉ¬∑(post√ótreat)</span>
        <span class=c1># DiD = Œ≤‚ÇÉ</span>
        <span class=n>model</span> <span class=o>=</span> <span class=n>smf</span><span class=o>.</span><span class=n>ols</span><span class=p>(</span><span class=s1>&#39;outcome ~ treat + post + treat:post&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>df</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>regression_result</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>fit</span><span class=p>()</span>

        <span class=c1># Extract DiD coefficient (interaction term)</span>
        <span class=n>did_coef</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>regression_result</span><span class=o>.</span><span class=n>params</span><span class=p>[</span><span class=s1>&#39;treat:post&#39;</span><span class=p>]</span>
        <span class=n>did_se</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>regression_result</span><span class=o>.</span><span class=n>bse</span><span class=p>[</span><span class=s1>&#39;treat:post&#39;</span><span class=p>]</span>
        <span class=n>did_pvalue</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>regression_result</span><span class=o>.</span><span class=n>pvalues</span><span class=p>[</span><span class=s1>&#39;treat:post&#39;</span><span class=p>]</span>

        <span class=c1># 95% CI</span>
        <span class=n>did_ci</span> <span class=o>=</span> <span class=p>(</span>
            <span class=n>did_coef</span> <span class=o>-</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=n>did_se</span><span class=p>,</span>
            <span class=n>did_coef</span> <span class=o>+</span> <span class=mf>1.96</span> <span class=o>*</span> <span class=n>did_se</span>
        <span class=p>)</span>

        <span class=c1># Test parallel trends</span>
        <span class=n>parallel_trends_pval</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>test_parallel_trends</span><span class=p>(</span><span class=n>df</span><span class=p>)</span>
        <span class=n>parallel_trends_ok</span> <span class=o>=</span> <span class=n>parallel_trends_pval</span> <span class=o>&gt;</span> <span class=mf>0.05</span>

        <span class=k>return</span> <span class=n>DiDResult</span><span class=p>(</span>
            <span class=n>did_estimate</span><span class=o>=</span><span class=n>did_coef</span><span class=p>,</span>
            <span class=n>did_se</span><span class=o>=</span><span class=n>did_se</span><span class=p>,</span>
            <span class=n>did_ci</span><span class=o>=</span><span class=n>did_ci</span><span class=p>,</span>
            <span class=n>p_value</span><span class=o>=</span><span class=n>did_pvalue</span><span class=p>,</span>
            <span class=n>parallel_trends_test_pvalue</span><span class=o>=</span><span class=n>parallel_trends_pval</span><span class=p>,</span>
            <span class=n>parallel_trends_passed</span><span class=o>=</span><span class=n>parallel_trends_ok</span>
        <span class=p>)</span>

<span class=c1># Example: Uber new pricing algorithm in San Francisco</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;UBER - NEW PRICING ALGORITHM (DIFFERENCE-IN-DIFFERENCES)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>

<span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>

<span class=c1># Setup: SF gets new pricing (treatment), LA is control</span>
<span class=c1># Pre-period: 8 weeks before launch</span>
<span class=c1># Post-period: 4 weeks after launch</span>

<span class=n>weeks_pre</span> <span class=o>=</span> <span class=mi>8</span>
<span class=n>weeks_post</span> <span class=o>=</span> <span class=mi>4</span>
<span class=n>n_cities</span> <span class=o>=</span> <span class=mi>2</span>  <span class=c1># SF (treatment), LA (control)</span>

<span class=n>data</span> <span class=o>=</span> <span class=p>[]</span>

<span class=c1># San Francisco (Treatment)</span>
<span class=k>for</span> <span class=n>week</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=o>-</span><span class=n>weeks_pre</span><span class=p>,</span> <span class=n>weeks_post</span><span class=p>):</span>
    <span class=n>post</span> <span class=o>=</span> <span class=mi>1</span> <span class=k>if</span> <span class=n>week</span> <span class=o>&gt;=</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>

    <span class=c1># Pre-period: +2% weekly growth (same as LA)</span>
    <span class=c1># Post-period: +14% growth (+12% causal effect from new pricing + 2% natural)</span>
    <span class=k>if</span> <span class=n>post</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
        <span class=n>trips</span> <span class=o>=</span> <span class=mi>10000</span> <span class=o>+</span> <span class=mi>200</span> <span class=o>*</span> <span class=n>week</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>500</span><span class=p>)</span>  <span class=c1># +2% weekly</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>trips</span> <span class=o>=</span> <span class=mi>10000</span> <span class=o>+</span> <span class=mi>200</span> <span class=o>*</span> <span class=n>week</span> <span class=o>+</span> <span class=mi>1200</span> <span class=o>*</span> <span class=n>week</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>500</span><span class=p>)</span>  <span class=c1># +14% weekly</span>

    <span class=n>data</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
        <span class=s1>&#39;city&#39;</span><span class=p>:</span> <span class=s1>&#39;San Francisco&#39;</span><span class=p>,</span>
        <span class=s1>&#39;treat&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
        <span class=s1>&#39;week&#39;</span><span class=p>:</span> <span class=n>week</span><span class=p>,</span>
        <span class=s1>&#39;post&#39;</span><span class=p>:</span> <span class=n>post</span><span class=p>,</span>
        <span class=s1>&#39;time_period&#39;</span><span class=p>:</span> <span class=n>week</span><span class=p>,</span>
        <span class=s1>&#39;group&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
        <span class=s1>&#39;outcome&#39;</span><span class=p>:</span> <span class=n>trips</span>
    <span class=p>})</span>

<span class=c1># Los Angeles (Control)</span>
<span class=k>for</span> <span class=n>week</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=o>-</span><span class=n>weeks_pre</span><span class=p>,</span> <span class=n>weeks_post</span><span class=p>):</span>
    <span class=n>post</span> <span class=o>=</span> <span class=mi>1</span> <span class=k>if</span> <span class=n>week</span> <span class=o>&gt;=</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>

    <span class=c1># Both pre and post: +2% weekly growth (no treatment)</span>
    <span class=n>trips</span> <span class=o>=</span> <span class=mi>9500</span> <span class=o>+</span> <span class=mi>190</span> <span class=o>*</span> <span class=n>week</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>normal</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>500</span><span class=p>)</span>  <span class=c1># +2% weekly</span>

    <span class=n>data</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
        <span class=s1>&#39;city&#39;</span><span class=p>:</span> <span class=s1>&#39;Los Angeles&#39;</span><span class=p>,</span>
        <span class=s1>&#39;treat&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
        <span class=s1>&#39;week&#39;</span><span class=p>:</span> <span class=n>week</span><span class=p>,</span>
        <span class=s1>&#39;post&#39;</span><span class=p>:</span> <span class=n>post</span><span class=p>,</span>
        <span class=s1>&#39;time_period&#39;</span><span class=p>:</span> <span class=n>week</span><span class=p>,</span>
        <span class=s1>&#39;group&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
        <span class=s1>&#39;outcome&#39;</span><span class=p>:</span> <span class=n>trips</span>
    <span class=p>})</span>

<span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìä DATA STRUCTURE&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Cities: San Francisco (treatment), Los Angeles (control)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Pre-period: </span><span class=si>{</span><span class=n>weeks_pre</span><span class=si>}</span><span class=s2> weeks before launch&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Post-period: </span><span class=si>{</span><span class=n>weeks_post</span><span class=si>}</span><span class=s2> weeks after launch&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Total observations: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>df</span><span class=p>)</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=c1># Summary statistics</span>
<span class=n>summary</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>groupby</span><span class=p>([</span><span class=s1>&#39;city&#39;</span><span class=p>,</span> <span class=s1>&#39;post&#39;</span><span class=p>])[</span><span class=s1>&#39;outcome&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=o>.</span><span class=n>reset_index</span><span class=p>()</span>
<span class=n>summary</span><span class=p>[</span><span class=s1>&#39;period&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>summary</span><span class=p>[</span><span class=s1>&#39;post&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>map</span><span class=p>({</span><span class=mi>0</span><span class=p>:</span> <span class=s1>&#39;Pre&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>:</span> <span class=s1>&#39;Post&#39;</span><span class=p>})</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìà SUMMARY STATISTICS&quot;</span><span class=p>)</span>
<span class=k>for</span> <span class=n>city</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;San Francisco&#39;</span><span class=p>,</span> <span class=s1>&#39;Los Angeles&#39;</span><span class=p>]:</span>
    <span class=n>city_data</span> <span class=o>=</span> <span class=n>summary</span><span class=p>[</span><span class=n>summary</span><span class=p>[</span><span class=s1>&#39;city&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>city</span><span class=p>]</span>
    <span class=n>pre_val</span> <span class=o>=</span> <span class=n>city_data</span><span class=p>[</span><span class=n>city_data</span><span class=p>[</span><span class=s1>&#39;period&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;Pre&#39;</span><span class=p>][</span><span class=s1>&#39;outcome&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
    <span class=n>post_val</span> <span class=o>=</span> <span class=n>city_data</span><span class=p>[</span><span class=n>city_data</span><span class=p>[</span><span class=s1>&#39;period&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;Post&#39;</span><span class=p>][</span><span class=s1>&#39;outcome&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
    <span class=n>change</span> <span class=o>=</span> <span class=n>post_val</span> <span class=o>-</span> <span class=n>pre_val</span>
    <span class=n>pct_change</span> <span class=o>=</span> <span class=p>(</span><span class=n>change</span> <span class=o>/</span> <span class=n>pre_val</span><span class=p>)</span> <span class=o>*</span> <span class=mi>100</span>

    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>   </span><span class=si>{</span><span class=n>city</span><span class=si>}</span><span class=s2>:&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;      Pre-period:  </span><span class=si>{</span><span class=n>pre_val</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=s2> trips&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;      Post-period: </span><span class=si>{</span><span class=n>post_val</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=s2> trips&quot;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;      Change:      </span><span class=si>{</span><span class=n>change</span><span class=si>:</span><span class=s2>+,.0f</span><span class=si>}</span><span class=s2> trips (</span><span class=si>{</span><span class=n>pct_change</span><span class=si>:</span><span class=s2>+.1f</span><span class=si>}</span><span class=s2>%)&quot;</span><span class=p>)</span>

<span class=c1># Naive comparison (BIASED!)</span>
<span class=n>sf_post</span> <span class=o>=</span> <span class=n>summary</span><span class=p>[(</span><span class=n>summary</span><span class=p>[</span><span class=s1>&#39;city&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;San Francisco&#39;</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>summary</span><span class=p>[</span><span class=s1>&#39;period&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;Post&#39;</span><span class=p>)][</span><span class=s1>&#39;outcome&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
<span class=n>la_post</span> <span class=o>=</span> <span class=n>summary</span><span class=p>[(</span><span class=n>summary</span><span class=p>[</span><span class=s1>&#39;city&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;Los Angeles&#39;</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>summary</span><span class=p>[</span><span class=s1>&#39;period&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;Post&#39;</span><span class=p>)][</span><span class=s1>&#39;outcome&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
<span class=n>naive_diff</span> <span class=o>=</span> <span class=n>sf_post</span> <span class=o>-</span> <span class=n>la_post</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>‚ùå NAIVE COMPARISON (BIASED)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   SF post-period:  </span><span class=si>{</span><span class=n>sf_post</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   LA post-period:  </span><span class=si>{</span><span class=n>la_post</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Naive difference: </span><span class=si>{</span><span class=n>naive_diff</span><span class=si>:</span><span class=s2>+,.0f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   ‚ö†Ô∏è  BIASED! Doesn&#39;t account for time trends and pre-existing differences&quot;</span><span class=p>)</span>

<span class=c1># Difference-in-Differences</span>
<span class=n>did_estimator</span> <span class=o>=</span> <span class=n>DifferenceInDifferences</span><span class=p>()</span>

<span class=c1># Test parallel trends</span>
<span class=n>parallel_trends_pval</span> <span class=o>=</span> <span class=n>did_estimator</span><span class=o>.</span><span class=n>test_parallel_trends</span><span class=p>(</span><span class=n>df</span><span class=p>,</span> <span class=n>pre_period_only</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>‚öñÔ∏è  PARALLEL TRENDS TEST&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Interaction p-value: </span><span class=si>{</span><span class=n>parallel_trends_pval</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=k>if</span> <span class=n>parallel_trends_pval</span> <span class=o>&gt;</span> <span class=mf>0.05</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   ‚úÖ PASSED: No evidence against parallel trends (p &gt; 0.05)&quot;</span><span class=p>)</span>
<span class=k>else</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   ‚ùå FAILED: Parallel trends violated (p &lt; 0.05)&quot;</span><span class=p>)</span>

<span class=c1># Estimate DiD</span>
<span class=n>result</span> <span class=o>=</span> <span class=n>did_estimator</span><span class=o>.</span><span class=n>estimate_did</span><span class=p>(</span><span class=n>df</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>‚úÖ DIFFERENCE-IN-DIFFERENCES ESTIMATE&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   DiD estimate: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>did_estimate</span><span class=si>:</span><span class=s2>+,.0f</span><span class=si>}</span><span class=s2> trips&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   Standard error: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>did_se</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   95% CI: [</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>did_ci</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>:</span><span class=s2>+,.0f</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>did_ci</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=si>:</span><span class=s2>+,.0f</span><span class=si>}</span><span class=s2>]&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   p-value: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>p_value</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=k>if</span> <span class=n>result</span><span class=o>.</span><span class=n>p_value</span> <span class=o>&lt;</span> <span class=mf>0.05</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   üìä STATISTICALLY SIGNIFICANT at Œ±=0.05&quot;</span><span class=p>)</span>

<span class=c1># Regression output</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üìã REGRESSION OUTPUT&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>did_estimator</span><span class=o>.</span><span class=n>regression_result</span><span class=o>.</span><span class=n>summary</span><span class=p>()</span><span class=o>.</span><span class=n>tables</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>

<span class=c1># Manual DiD calculation</span>
<span class=n>sf_pre</span> <span class=o>=</span> <span class=n>summary</span><span class=p>[(</span><span class=n>summary</span><span class=p>[</span><span class=s1>&#39;city&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;San Francisco&#39;</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>summary</span><span class=p>[</span><span class=s1>&#39;period&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;Pre&#39;</span><span class=p>)][</span><span class=s1>&#39;outcome&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
<span class=n>sf_post</span> <span class=o>=</span> <span class=n>summary</span><span class=p>[(</span><span class=n>summary</span><span class=p>[</span><span class=s1>&#39;city&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;San Francisco&#39;</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>summary</span><span class=p>[</span><span class=s1>&#39;period&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;Post&#39;</span><span class=p>)][</span><span class=s1>&#39;outcome&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
<span class=n>la_pre</span> <span class=o>=</span> <span class=n>summary</span><span class=p>[(</span><span class=n>summary</span><span class=p>[</span><span class=s1>&#39;city&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;Los Angeles&#39;</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>summary</span><span class=p>[</span><span class=s1>&#39;period&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;Pre&#39;</span><span class=p>)][</span><span class=s1>&#39;outcome&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
<span class=n>la_post</span> <span class=o>=</span> <span class=n>summary</span><span class=p>[(</span><span class=n>summary</span><span class=p>[</span><span class=s1>&#39;city&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;Los Angeles&#39;</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>summary</span><span class=p>[</span><span class=s1>&#39;period&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;Post&#39;</span><span class=p>)][</span><span class=s1>&#39;outcome&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>

<span class=n>manual_did</span> <span class=o>=</span> <span class=p>(</span><span class=n>sf_post</span> <span class=o>-</span> <span class=n>sf_pre</span><span class=p>)</span> <span class=o>-</span> <span class=p>(</span><span class=n>la_post</span> <span class=o>-</span> <span class=n>la_pre</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>üî¢ MANUAL CALCULATION&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   SF change: </span><span class=si>{</span><span class=n>sf_post</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=s2> - </span><span class=si>{</span><span class=n>sf_pre</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=s2> = </span><span class=si>{</span><span class=n>sf_post</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>sf_pre</span><span class=si>:</span><span class=s2>+,.0f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   LA change: </span><span class=si>{</span><span class=n>la_post</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=s2> - </span><span class=si>{</span><span class=n>la_pre</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=s2> = </span><span class=si>{</span><span class=n>la_post</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>la_pre</span><span class=si>:</span><span class=s2>+,.0f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   DiD: (</span><span class=si>{</span><span class=n>sf_post</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>sf_pre</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=s2>) - (</span><span class=si>{</span><span class=n>la_post</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>la_pre</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=s2>) = </span><span class=si>{</span><span class=n>manual_did</span><span class=si>:</span><span class=s2>+,.0f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;INTERPRETATION&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>‚úÖ New pricing algorithm in SF caused +</span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>did_estimate</span><span class=si>:</span><span class=s2>,.0f</span><span class=si>}</span><span class=s2> trips&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   (after removing time trend using LA as control)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>   Parallel trends held in pre-period (p=</span><span class=si>{</span><span class=n>parallel_trends_pval</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;   ‚Üí Valid causal interpretation&quot;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s2>&quot;=&quot;</span><span class=o>*</span><span class=mi>70</span><span class=p>)</span>
</code></pre></div> <p><strong>When Parallel Trends Fail:</strong></p> <table> <thead> <tr> <th>Symptom</th> <th>Cause</th> <th>Solution</th> </tr> </thead> <tbody> <tr> <td><strong>Interaction p &lt; 0.05 in pre-period</strong></td> <td>Different pre-trends</td> <td>Use synthetic control or add covariates</td> </tr> <tr> <td><strong>Visual divergence before treatment</strong></td> <td>Groups not comparable</td> <td>Find better control group</td> </tr> <tr> <td><strong>Post-period trend change in control</strong></td> <td>External shock</td> <td>Use multiple pre-periods to test robustness</td> </tr> </tbody> </table> <p><strong>DiD Variants:</strong></p> <table> <thead> <tr> <th>Variant</th> <th>Use Case</th> <th>Example</th> </tr> </thead> <tbody> <tr> <td><strong>Standard DiD</strong></td> <td>One treatment, one control, one treatment time</td> <td>Uber SF pricing</td> </tr> <tr> <td><strong>Event study DiD</strong></td> <td>Plot DiD by time period</td> <td>Check for anticipation effects</td> </tr> <tr> <td><strong>Staggered DiD</strong></td> <td>Multiple treatment times</td> <td>Geographic rollout over months</td> </tr> <tr> <td><strong>Synthetic control</strong></td> <td>No good control group</td> <td>Construct weighted control from multiple units</td> </tr> </tbody> </table> <div class="admonition tip"> <p class=admonition-title>Interviewer's Insight</p> <p><strong>What they test:</strong></p> <ul> <li>Do you understand when DiD is appropriate (pre/post data, parallel trends)?</li> <li>Can you explain the parallel trends assumption and how to test it?</li> <li>Do you know how to interpret DiD vs naive comparison?</li> </ul> <p><strong>Strong signal:</strong></p> <ul> <li>"Use DiD for geographic rollout: SF gets new pricing, LA is control"</li> <li>"CRITICAL: Test parallel trends in pre-period (interaction p &gt; 0.05)"</li> <li>"DiD = (SF post-pre change) - (LA post-pre change) = removes time trend"</li> <li>"DiD estimate: +1200 trips (causal effect), naive difference is biased"</li> <li>"Regression: Y ~ treat + post + treat√ópost, DiD = Œ≤‚ÇÉ (interaction)"</li> </ul> <p><strong>Red flags:</strong></p> <ul> <li>Not testing parallel trends assumption</li> <li>Confusing DiD with simple post-period comparison</li> <li>Not understanding why control group is needed (removes time trends)</li> </ul> <p><strong>Follow-ups:</strong></p> <ul> <li>"What if parallel trends fail in pre-period?"</li> <li>"How would you extend this to multiple treatment times (staggered rollout)?"</li> <li>"DiD vs Propensity Score Matching - which to use when?"</li> </ul> </div> </details> <hr> <h2 id=quick-reference-100-ab-testing-questions>Quick Reference: 100+ A/B Testing Questions</h2> <table> <thead> <tr> <th>Sno</th> <th>Question Title</th> <th>Practice Links</th> <th>Companies Asking</th> <th>Difficulty</th> <th>Topics</th> </tr> </thead> <tbody> <tr> <td>1</td> <td>What is A/B Testing?</td> <td><a href=https://www.optimizely.com/optimization-glossary/ab-testing/ >Optimizely</a></td> <td>Most Tech Companies</td> <td>Easy</td> <td>Basics</td> </tr> <tr> <td>2</td> <td>Explain Null Hypothesis (<span class=arithmatex>\(H_0\)</span>) vs Alternative Hypothesis (<span class=arithmatex>\(H_1\)</span>)</td> <td><a href=https://www.khanacademy.org/math/statistics-probability>Khan Academy</a></td> <td>Most Tech Companies</td> <td>Easy</td> <td>Statistics</td> </tr> <tr> <td>3</td> <td>What is a p-value? Explain it to a non-technical person.</td> <td><a href=https://hbr.org/2016/02/a-refresher-on-statistical-significance>Harvard Business Review</a></td> <td>Google, Meta, Amazon</td> <td>Medium</td> <td>Statistics, Communication</td> </tr> <tr> <td>4</td> <td>What is Statistical Power?</td> <td><a href=https://www.machinelearningplus.com/ >Machine Learning Plus</a></td> <td>Google, Netflix, Uber</td> <td>Medium</td> <td>Statistics</td> </tr> <tr> <td>5</td> <td>What is Type I error (False Positive) vs Type II error (False Negative)?</td> <td><a href=https://towardsdatascience.com/ >Towards Data Science</a></td> <td>Most Tech Companies</td> <td>Easy</td> <td>Statistics</td> </tr> <tr> <td>6</td> <td>How do you calculate sample size for an experiment?</td> <td><a href=https://www.evanmiller.org/ab-testing/sample-size.html>Evan Miller</a></td> <td>Google, Amazon, Meta</td> <td>Medium</td> <td>Experimental Design</td> </tr> <tr> <td>7</td> <td>What is Minimum Detectable Effect (MDE)?</td> <td><a href=https://www.stat.ubc.ca/ >StatsEngine</a></td> <td>Netflix, Airbnb</td> <td>Medium</td> <td>Experimental Design</td> </tr> <tr> <td>8</td> <td>Explain Confidence Intervals.</td> <td><a href=https://www.coursera.org/ >Coursera</a></td> <td>Most Tech Companies</td> <td>Easy</td> <td>Statistics</td> </tr> <tr> <td>9</td> <td>Difference between One-tailed and Two-tailed tests.</td> <td><a href=https://www.investopedia.com/ >Investopedia</a></td> <td>Google, Amazon</td> <td>Easy</td> <td>Statistics</td> </tr> <tr> <td>10</td> <td>What is the Central Limit Theorem? Why is it important?</td> <td><a href=https://www.khanacademy.org/math/statistics-probability>Khan Academy</a></td> <td>Google, HFT Firms</td> <td>Medium</td> <td>Statistics</td> </tr> <tr> <td>11</td> <td>How long should you run an A/B test?</td> <td><a href=https://cxl.com/blog/how-long-to-run-ab-test/ >CXL</a></td> <td>Airbnb, Booking.com</td> <td>Medium</td> <td>Experimental Design</td> </tr> <tr> <td>12</td> <td>Can you stop an experiment as soon as it reaches significance? (Peeking)</td> <td><a href=https://www.evanmiller.org/how-not-to-run-an-ab-test.html>Evan Miller</a></td> <td>Netflix, Uber, Airbnb</td> <td>Hard</td> <td>Pitfalls</td> </tr> <tr> <td>13</td> <td>What is SRM (Sample Ratio Mismatch)? How to debug?</td> <td><a href=https://www.microsoft.com/en-us/research/group/experimentation-platform-exp/ >Microsoft Research</a></td> <td>Microsoft, LinkedIn</td> <td>Hard</td> <td>Debugging</td> </tr> <tr> <td>14</td> <td>What is Randomization Unit vs Analysis Unit?</td> <td><a href=https://www.udacity.com/course/ab-testing--ud257>Udacity</a></td> <td>Uber, DoorDash</td> <td>Medium</td> <td>Experimental Design</td> </tr> <tr> <td>15</td> <td>How to handle outliers in A/B testing metrics?</td> <td><a href=https://towardsdatascience.com/ >Towards Data Science</a></td> <td>Google, Meta</td> <td>Medium</td> <td>Data Cleaning</td> </tr> <tr> <td>16</td> <td>Mean vs Median: Which metric to use?</td> <td><a href=https://stackoverflow.com/ >Stack Overflow</a></td> <td>Most Tech Companies</td> <td>Easy</td> <td>Metrics</td> </tr> <tr> <td>17</td> <td>What are Guardrail Metrics?</td> <td><a href=https://medium.com/airbnb-engineering>Airbnb Tech Blog</a></td> <td>Airbnb, Netflix</td> <td>Medium</td> <td>Metrics</td> </tr> <tr> <td>18</td> <td>What is a North Star Metric?</td> <td><a href=https://amplitude.com/blog/north-star-metric>Amplitude</a></td> <td>Product Roles</td> <td>Easy</td> <td>Metrics</td> </tr> <tr> <td>19</td> <td>Difference between Z-test and T-test.</td> <td><a href=https://statisticsbyjim.com/ >Statistics By Jim</a></td> <td>Google, Amazon</td> <td>Medium</td> <td>Statistics</td> </tr> <tr> <td>20</td> <td>How to test multiple variants? (A/B/n testing)</td> <td><a href=https://vwo.com/ >VWO</a></td> <td>Booking.com, Expedia</td> <td>Medium</td> <td>Experimental Design</td> </tr> <tr> <td>21</td> <td>What is the Bonferroni Correction?</td> <td><a href=https://en.wikipedia.org/wiki/Bonferroni_correction>Wikipedia</a></td> <td>Google, Meta</td> <td>Hard</td> <td>Statistics</td> </tr> <tr> <td>22</td> <td>What is A/A Testing? Why do it?</td> <td><a href=https://www.optimizely.com/ >Optimizely</a></td> <td>Microsoft, LinkedIn</td> <td>Medium</td> <td>Validity</td> </tr> <tr> <td>23</td> <td>Explain Covariate Adjustment (CUPED).</td> <td><a href=https://booking.ai/ >Booking.com Data</a></td> <td>Booking.com, Microsoft, Meta</td> <td>Hard</td> <td>Optimization</td> </tr> <tr> <td>24</td> <td>How to measure retention in A/B tests?</td> <td><a href=https://www.reforge.com/ >Reforge</a></td> <td>Netflix, Spotify</td> <td>Medium</td> <td>Metrics</td> </tr> <tr> <td>25</td> <td>What is a Novelty Effect?</td> <td><a href=https://cxl.com/ >CXL</a></td> <td>Facebook, Instagram</td> <td>Medium</td> <td>Pitfalls</td> </tr> <tr> <td>26</td> <td>What is a Primacy Effect?</td> <td><a href=https://cxl.com/ >CXL</a></td> <td>Facebook, Instagram</td> <td>Medium</td> <td>Pitfalls</td> </tr> <tr> <td>27</td> <td>How to handle interference (Network Effects)?</td> <td><a href=https://eng.uber.com/ >Uber Eng Blog</a></td> <td>Uber, Lyft, DoorDash</td> <td>Hard</td> <td>Network Effects</td> </tr> <tr> <td>28</td> <td>What is a Switchback (Time-split) Experiment?</td> <td><a href=https://doordash.engineering/ >DoorDash Eng</a></td> <td>DoorDash, Uber</td> <td>Hard</td> <td>Experimental Design</td> </tr> <tr> <td>29</td> <td>What is Cluster Randomization?</td> <td><a href=https://en.wikipedia.org/wiki/Cluster_randomised_controlled_trial>Wikipedia</a></td> <td>Facebook, LinkedIn</td> <td>Hard</td> <td>Experimental Design</td> </tr> <tr> <td>30</td> <td>How to test on a 2-sided marketplace?</td> <td><a href=https://eng.lyft.com/ >Lyft Eng</a></td> <td>Uber, Lyft, Airbnb</td> <td>Hard</td> <td>Marketplace</td> </tr> <tr> <td>31</td> <td>Explain Bayesian A/B Testing vs Frequentist.</td> <td><a href=https://vwo.com/blog/bayesian-vs-frequentist-ab-testing/ >VWO</a></td> <td>Stitch Fix, Netflix</td> <td>Hard</td> <td>Statistics</td> </tr> <tr> <td>32</td> <td>What is a Multi-Armed Bandit (MAB)?</td> <td><a href=https://towardsdatascience.com/ >Towards Data Science</a></td> <td>Netflix, Amazon</td> <td>Hard</td> <td>Bandits</td> </tr> <tr> <td>33</td> <td>Thompson Sampling vs Epsilon-Greedy.</td> <td><a href=https://www.geeksforgeeks.org/ >GeeksforGeeks</a></td> <td>Netflix, Amazon</td> <td>Hard</td> <td>Bandits</td> </tr> <tr> <td>34</td> <td>How to deal with low traffic experiments?</td> <td><a href=https://cxl.com/ >CXL</a></td> <td>Startups</td> <td>Medium</td> <td>Strategy</td> </tr> <tr> <td>35</td> <td>How to select metrics for a new feature?</td> <td><a href=https://productschool.com/ >Product School</a></td> <td>Meta, Google</td> <td>Medium</td> <td>Metrics</td> </tr> <tr> <td>36</td> <td>What is Simpson's Paradox?</td> <td><a href=https://www.britannica.com/topic/Simpsons-paradox>Britannica</a></td> <td>Google, Amazon</td> <td>Medium</td> <td>Paradoxes</td> </tr> <tr> <td>37</td> <td>How to analyze ratio metrics (e.g., CTR)?</td> <td><a href=https://en.wikipedia.org/wiki/Delta_method>Deltamethod</a></td> <td>Google, Meta</td> <td>Hard</td> <td>Statistics, Delta Method</td> </tr> <tr> <td>38</td> <td>What is Bootstrapping? When to use it?</td> <td><a href=https://www.investopedia.com/terms/b/bootstrapping.asp>Investopedia</a></td> <td>Amazon, Netflix</td> <td>Medium</td> <td>Statistics</td> </tr> <tr> <td>39</td> <td>How to detect and handle Seasonality?</td> <td><a href=https://towardsdatascience.com/ >Towards Data Science</a></td> <td>Retail/E-comm</td> <td>Medium</td> <td>Time Series</td> </tr> <tr> <td>40</td> <td>What is Change Aversion?</td> <td><a href=https://design.google/library/ >Google UX</a></td> <td>Google, YouTube</td> <td>Medium</td> <td>UX</td> </tr> <tr> <td>41</td> <td>How to design an experiment for a search algorithm?</td> <td><a href=https://medium.com/airbnb-engineering>Airbnb Eng</a></td> <td>Google, Airbnb, Amazon</td> <td>Hard</td> <td>Search, Ranking</td> </tr> <tr> <td>42</td> <td>How to test pricing changes?</td> <td><a href=https://www.priceintelligently.com/ >PriceIntelligently</a></td> <td>Uber, Airbnb</td> <td>Hard</td> <td>Pricing, Strategy</td> </tr> <tr> <td>43</td> <td>What is interference between experiments?</td> <td><a href=https://www.microsoft.com/en-us/research/group/experimentation-platform-exp/ >Microsoft Exp</a></td> <td>Google, Meta, Microsoft</td> <td>Hard</td> <td>Platform</td> </tr> <tr> <td>44</td> <td>Explain Sequential Testing.</td> <td><a href=https://www.evanmiller.org/sequential-ab-testing.html>Evan Miller</a></td> <td>Optimizely, Netflix</td> <td>Hard</td> <td>Statistics</td> </tr> <tr> <td>45</td> <td>What is Variance Reduction?</td> <td><a href=https://research.facebook.com/ >Meta Research</a></td> <td>Meta, Microsoft, Booking</td> <td>Hard</td> <td>Optimization</td> </tr> <tr> <td>46</td> <td>How to handle attribution (First-touch vs Last-touch)?</td> <td><a href=https://analytics.google.com/ >Google Analytics</a></td> <td>Marketing Tech</td> <td>Medium</td> <td>Marketing</td> </tr> <tr> <td>47</td> <td>How to validate if randomization worked?</td> <td><a href=https://stats.stackexchange.com/ >Stats StackExchange</a></td> <td>Most Tech Companies</td> <td>Easy</td> <td>Validity</td> </tr> <tr> <td>48</td> <td>What is stratification?</td> <td><a href=https://en.wikipedia.org/wiki/Stratified_sampling>Wikipedia</a></td> <td>Most Tech Companies</td> <td>Medium</td> <td>Sampling</td> </tr> <tr> <td>49</td> <td>When should you NOT A/B test?</td> <td><a href=https://www.reforge.com/ >Reforge</a></td> <td>Product Roles</td> <td>Medium</td> <td>Strategy</td> </tr> <tr> <td>50</td> <td>How to estimate long-term impact from short-term tests?</td> <td><a href=https://netflixtechblog.com/ >Netflix TechBlog</a></td> <td>Netflix, Meta</td> <td>Hard</td> <td>Strategy, Proxy Metrics</td> </tr> <tr> <td>51</td> <td>What is Binomial Distribution?</td> <td><a href=https://www.khanacademy.org/ >Khan Academy</a></td> <td>Most Tech Companies</td> <td>Easy</td> <td>Statistics</td> </tr> <tr> <td>52</td> <td>What is Poisson Distribution?</td> <td><a href=https://www.khanacademy.org/ >Khan Academy</a></td> <td>Uber, Lyft (Rides)</td> <td>Medium</td> <td>Statistics</td> </tr> <tr> <td>53</td> <td>Difference between Correlation and Causation.</td> <td><a href=https://www.khanacademy.org/ >Khan Academy</a></td> <td>Most Tech Companies</td> <td>Easy</td> <td>Basics</td> </tr> <tr> <td>54</td> <td>What is a Confounding Variable?</td> <td><a href=https://www.scribbr.com/ >Scribbr</a></td> <td>Most Tech Companies</td> <td>Easy</td> <td>Causal Inference</td> </tr> <tr> <td>55</td> <td>Explain Regression Discontinuity Design (RDD).</td> <td><a href=https://en.wikipedia.org/wiki/Regression_discontinuity_design>Wikipedia</a></td> <td>Economics/Policy Roles</td> <td>Hard</td> <td>Causal Inference</td> </tr> <tr> <td>56</td> <td>Explain Difference-in-Differences (DiD).</td> <td><a href=https://en.wikipedia.org/wiki/Difference_in_differences>Wikipedia</a></td> <td>Uber, Airbnb</td> <td>Hard</td> <td>Causal Inference</td> </tr> <tr> <td>57</td> <td>What is Propensity Score Matching?</td> <td><a href=https://en.wikipedia.org/wiki/Propensity_score_matching>Wikipedia</a></td> <td>Meta, Netflix</td> <td>Hard</td> <td>Causal Inference</td> </tr> <tr> <td>58</td> <td>How to Handle Heterogeneous Treatment Effects?</td> <td><a href=https://github.com/uber/causalml>CausalML</a></td> <td>Uber, Meta</td> <td>Hard</td> <td>Causal ML</td> </tr> <tr> <td>59</td> <td>What is Interference in social networks?</td> <td><a href=https://research.facebook.com/ >Meta Research</a></td> <td>Meta, LinkedIn, Snap</td> <td>Hard</td> <td>Network Effects</td> </tr> <tr> <td>60</td> <td>Explain the concept of "Holdout Groups".</td> <td><a href=https://medium.com/airbnb-engineering>Airbnb Eng</a></td> <td>Amazon, Airbnb</td> <td>Medium</td> <td>Strategy</td> </tr> <tr> <td>61</td> <td>How to test infrastructure changes? (Canary Deployment)</td> <td><a href=https://sre.google/sre-book/canary-analysis/ >Google SRE</a></td> <td>Google, Netflix</td> <td>Medium</td> <td>DevOps/SRE</td> </tr> <tr> <td>62</td> <td>What is Client-side vs Server-side testing?</td> <td><a href=https://www.optimizely.com/ >Optimizely</a></td> <td>Full Stack Roles</td> <td>Medium</td> <td>Implementation</td> </tr> <tr> <td>63</td> <td>How to deal with flickering?</td> <td><a href=https://vwo.com/ >VWO</a></td> <td>Frontend Roles</td> <td>Medium</td> <td>Implementation</td> </tr> <tr> <td>64</td> <td>What is a Trigger selection in A/B testing?</td> <td><a href=https://www.microsoft.com/en-us/research/group/experimentation-platform-exp/ >Microsoft Exp</a></td> <td>Microsoft, Airbnb</td> <td>Hard</td> <td>Experimental Design</td> </tr> <tr> <td>65</td> <td>How to analyze user funnel drop-offs?</td> <td><a href=https://mixpanel.com/ >Mixpanel</a></td> <td>Product Analysts</td> <td>Medium</td> <td>Analytics</td> </tr> <tr> <td>66</td> <td>What is Geometric Distribution?</td> <td><a href=https://en.wikipedia.org/wiki/Geometric_distribution>Wikipedia</a></td> <td>Most Tech Companies</td> <td>Medium</td> <td>Statistics</td> </tr> <tr> <td>67</td> <td>Explain Inverse Propensity Weighting (IPW).</td> <td><a href=https://en.wikipedia.org/wiki/Inverse_probability_weighting>Wikipedia</a></td> <td>Causal Inference Roles</td> <td>Hard</td> <td>Causal Inference</td> </tr> <tr> <td>68</td> <td>How to calculate Standard Error of Mean (SEM)?</td> <td><a href=https://www.investopedia.com/terms/s/standard-error.asp>Investopedia</a></td> <td>Most Tech Companies</td> <td>Easy</td> <td>Statistics</td> </tr> <tr> <td>69</td> <td>What is Statistical Significance vs Practical Significance?</td> <td><a href=https://towardsdatascience.com/ >Towards Data Science</a></td> <td>Google, Meta</td> <td>Medium</td> <td>Strategy</td> </tr> <tr> <td>70</td> <td>How to handle cookies and tracking prevention (ITP)?</td> <td><a href=https://webkit.org/blog/ >WebKit</a></td> <td>AdTech, Marketing</td> <td>Hard</td> <td>Privacy</td> </tr> <tr> <td>71</td> <td><strong>[HARD]</strong> Explain the Delta Method for ratio metrics.</td> <td><a href=https://en.wikipedia.org/wiki/Delta_method>Deltamethod</a></td> <td>Google, Meta, Uber</td> <td>Hard</td> <td>Statistics</td> </tr> <tr> <td>72</td> <td><strong>[HARD]</strong> How does Switchback testing solve interference?</td> <td><a href=https://doordash.engineering/ >DoorDash Eng</a></td> <td>DoorDash, Uber</td> <td>Hard</td> <td>Experimental Design</td> </tr> <tr> <td>73</td> <td><strong>[HARD]</strong> Derive the sample size formula.</td> <td><a href=https://stats.stackexchange.com/ >Stats Exchange</a></td> <td>Google, HFT Firms</td> <td>Hard</td> <td>Math</td> </tr> <tr> <td>74</td> <td><strong>[HARD]</strong> How to implement CUPED in Python/SQL?</td> <td><a href=https://booking.ai/ >Booking.com</a></td> <td>Booking, Microsoft</td> <td>Hard</td> <td>Optimization</td> </tr> <tr> <td>75</td> <td><strong>[HARD]</strong> Explain Sequential Probability Ratio Test (SPRT).</td> <td><a href=https://en.wikipedia.org/wiki/Sequential_probability_ratio_test>Wikipedia</a></td> <td>Optimizely, Netflix</td> <td>Hard</td> <td>Statistics</td> </tr> <tr> <td>76</td> <td><strong>[HARD]</strong> How to estimate Network Effects (Cluster-Based)?</td> <td><a href=https://economics.mit.edu/ >MIT Paper</a></td> <td>Meta, LinkedIn</td> <td>Hard</td> <td>Network Effects</td> </tr> <tr> <td>77</td> <td><strong>[HARD]</strong> Design an experiment for a 3-sided marketplace.</td> <td><a href=https://eng.uber.com/ >Uber Eng</a></td> <td>Uber, DoorDash</td> <td>Hard</td> <td>Marketplace</td> </tr> <tr> <td>78</td> <td><strong>[HARD]</strong> How to correct for multiple comparisons (FDR vs FWER)?</td> <td><a href=https://en.wikipedia.org/wiki/False_discovery_rate>Wikipedia</a></td> <td>Pharma, BioTech, Tech</td> <td>Hard</td> <td>Statistics</td> </tr> <tr> <td>79</td> <td><strong>[HARD]</strong> Explain Instrumental Variables (IV).</td> <td><a href=https://en.wikipedia.org/wiki/Instrumental_variable>Wikipedia</a></td> <td>Economics, Uber</td> <td>Hard</td> <td>Causal Inference</td> </tr> <tr> <td>80</td> <td><strong>[HARD]</strong> How to build an Experimentation Platform?</td> <td><a href=https://www.microsoft.com/en-us/research/group/experimentation-platform-exp/ >Microsoft Exp</a></td> <td>Microsoft, Netflix, Airbnb</td> <td>Hard</td> <td>System Design</td> </tr> <tr> <td>81</td> <td><strong>[HARD]</strong> How to handle user identity resolution across devices?</td> <td><a href=https://segment.com/ >Segment</a></td> <td>Meta, Google</td> <td>Hard</td> <td>Data Engineering</td> </tr> <tr> <td>82</td> <td><strong>[HARD]</strong> What is "Carryover Effect" in Switchback tests?</td> <td><a href=https://doordash.engineering/ >DoorDash Eng</a></td> <td>DoorDash, Uber</td> <td>Hard</td> <td>Pitfalls</td> </tr> <tr> <td>83</td> <td><strong>[HARD]</strong> Explain "Washout Period".</td> <td><a href=https://en.wikipedia.org/wiki/Washout_period>Clinical Trials</a></td> <td>DoorDash, Uber</td> <td>Hard</td> <td>Experimental Design</td> </tr> <tr> <td>84</td> <td><strong>[HARD]</strong> How to test Ranking algorithms (Interleaving)?</td> <td><a href=https://netflixtechblog.com/ >Netflix TechBlog</a></td> <td>Netflix, Google, Airbnb</td> <td>Hard</td> <td>Search/Ranking</td> </tr> <tr> <td>85</td> <td><strong>[HARD]</strong> Explain Always-Valid Inference.</td> <td><a href=https://www.optimizely.com/ >Optimizely</a></td> <td>Optimizely, Netflix</td> <td>Hard</td> <td>Statistics</td> </tr> <tr> <td>86</td> <td><strong>[HARD]</strong> How to measure cannibalization?</td> <td><a href=https://hbr.org/ >Harvard Business Review</a></td> <td>Retail, E-comm</td> <td>Hard</td> <td>Strategy</td> </tr> <tr> <td>87</td> <td><strong>[HARD]</strong> Explain Thompson Sampling Implementation.</td> <td><a href=https://towardsdatascience.com/ >TDS</a></td> <td>Amazon, Netflix</td> <td>Hard</td> <td>Bandits</td> </tr> <tr> <td>88</td> <td><strong>[HARD]</strong> How to detect Heterogeneous Treatment Effects (Causal Forest)?</td> <td><a href=https://arxiv.org/abs/1510.04342>Wager &amp; Athey</a></td> <td>Uber, Meta</td> <td>Hard</td> <td>Causal ML</td> </tr> <tr> <td>89</td> <td><strong>[HARD]</strong> How to handle "dilution" in experiment metrics?</td> <td><a href=https://www.reforge.com/ >Reforge</a></td> <td>Product Roles</td> <td>Hard</td> <td>Metrics</td> </tr> <tr> <td>90</td> <td><strong>[HARD]</strong> Explain Synthetic Control Method.</td> <td><a href=https://en.wikipedia.org/wiki/Synthetic_control_method>Wikipedia</a></td> <td>Uber (City-level tests)</td> <td>Hard</td> <td>Causal Inference</td> </tr> <tr> <td>91</td> <td><strong>[HARD]</strong> How to optimize for Long-term Customer Value (LTV)?</td> <td><a href=https://github.com/fit-marketing/thetaclv>ThetaCLV</a></td> <td>Subscription roles</td> <td>Hard</td> <td>Metrics</td> </tr> <tr> <td>92</td> <td><strong>[HARD]</strong> Explain "Winner's Curse" in A/B testing.</td> <td><a href=https://medium.com/airbnb-engineering>Airbnb Eng</a></td> <td>Airbnb, Booking</td> <td>Hard</td> <td>Bias</td> </tr> <tr> <td>93</td> <td><strong>[HARD]</strong> How to handle heavy-tailed metric distributions?</td> <td><a href=https://towardsdatascience.com/ >TDS</a></td> <td>HFT, Fintech</td> <td>Hard</td> <td>Statistics</td> </tr> <tr> <td>94</td> <td><strong>[HARD]</strong> How to implement Stratified Sampling in SQL?</td> <td><a href=https://stackoverflow.com/ >Stack Overflow</a></td> <td>Data Eng</td> <td>Hard</td> <td>Sampling</td> </tr> <tr> <td>95</td> <td><strong>[HARD]</strong> Explain "Regression to the Mean".</td> <td><a href=https://en.wikipedia.org/wiki/Regression_toward_the_mean>Wikipedia</a></td> <td>Most Tech Companies</td> <td>Hard</td> <td>Statistics</td> </tr> <tr> <td>96</td> <td><strong>[HARD]</strong> How to budget "Error Rate" across the company?</td> <td><a href=https://www.microsoft.com/en-us/research/group/experimentation-platform-exp/ >Microsoft Exp</a></td> <td>Microsoft, Google</td> <td>Hard</td> <td>Strategy</td> </tr> <tr> <td>97</td> <td><strong>[HARD]</strong> How to detect bot traffic in experiments?</td> <td><a href=https://analytics.google.com/ >Google Analytics</a></td> <td>Security, Fraud</td> <td>Hard</td> <td>Data Quality</td> </tr> <tr> <td>98</td> <td><strong>[HARD]</strong> Explain "Interaction Effects" in Factorial Designs.</td> <td><a href=https://en.wikipedia.org/wiki/Factorial_experiment>Wikipedia</a></td> <td>Meta, Google</td> <td>Hard</td> <td>Statistics</td> </tr> <tr> <td>99</td> <td><strong>[HARD]</strong> How to use Surrogate Metrics?</td> <td><a href=https://netflixtechblog.com/ >Netflix TechBlog</a></td> <td>Netflix</td> <td>Hard</td> <td>Metrics</td> </tr> <tr> <td>100</td> <td><strong>[HARD]</strong> How to implement A/B testing in a Microservices architecture?</td> <td><a href=https://www.split.io/ >Split.io</a></td> <td>Netflix, Uber</td> <td>Hard</td> <td>Engineering</td> </tr> </tbody> </table> <hr> <h2 id=code-examples>Code Examples</h2> <h3 id=1-power-analysis-and-sample-size-python>1. Power Analysis and Sample Size (Python)</h3> <p><strong>Difficulty:</strong> üü¢ Easy | <strong>Tags:</strong> <code>Code Example</code> | <strong>Asked by:</strong> Code Pattern</p> <details class=success> <summary>View Code Example</summary> <p>Calculating the required sample size before starting an experiment.</p> <div class=highlight><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>statsmodels.stats.power</span><span class=w> </span><span class=kn>import</span> <span class=n>TTestIndPower</span>
<span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>

<span class=c1># Parameters</span>
<span class=n>effect_size</span> <span class=o>=</span> <span class=mf>0.1</span>  <span class=c1># Cohen&#39;s d (Standardized difference)</span>
<span class=n>alpha</span> <span class=o>=</span> <span class=mf>0.05</span>       <span class=c1># Significance level (5%)</span>
<span class=n>power</span> <span class=o>=</span> <span class=mf>0.8</span>        <span class=c1># Power (80%)</span>

<span class=n>analysis</span> <span class=o>=</span> <span class=n>TTestIndPower</span><span class=p>()</span>
<span class=n>sample_size</span> <span class=o>=</span> <span class=n>analysis</span><span class=o>.</span><span class=n>solve_power</span><span class=p>(</span><span class=n>effect_size</span><span class=o>=</span><span class=n>effect_size</span><span class=p>,</span> <span class=n>power</span><span class=o>=</span><span class=n>power</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=n>alpha</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Required sample size per group: </span><span class=si>{</span><span class=nb>int</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>ceil</span><span class=p>(</span><span class=n>sample_size</span><span class=p>))</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</code></pre></div> </details> <h3 id=2-bayesian-ab-test-beta-binomial>2. Bayesian A/B Test (Beta-Binomial)</h3> <p><strong>Difficulty:</strong> üü¢ Easy | <strong>Tags:</strong> <code>Code Example</code> | <strong>Asked by:</strong> Code Pattern</p> <details class=success> <summary>View Code Example</summary> <p>Updating beliefs about conversion rates.</p> <div class=highlight><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>scipy.stats</span><span class=w> </span><span class=kn>import</span> <span class=n>beta</span>

<span class=c1># Prior: Uniform distribution (Beta(1,1))</span>
<span class=n>alpha_prior</span> <span class=o>=</span> <span class=mi>1</span>
<span class=n>beta_prior</span> <span class=o>=</span> <span class=mi>1</span>

<span class=c1># Data: Group A</span>
<span class=n>conversions_A</span> <span class=o>=</span> <span class=mi>120</span>
<span class=n>failures_A</span> <span class=o>=</span> <span class=mi>880</span>

<span class=c1># Data: Group B</span>
<span class=n>conversions_B</span> <span class=o>=</span> <span class=mi>140</span>
<span class=n>failures_B</span> <span class=o>=</span> <span class=mi>860</span>

<span class=c1># Posterior</span>
<span class=n>posterior_A</span> <span class=o>=</span> <span class=n>beta</span><span class=p>(</span><span class=n>alpha_prior</span> <span class=o>+</span> <span class=n>conversions_A</span><span class=p>,</span> <span class=n>beta_prior</span> <span class=o>+</span> <span class=n>failures_A</span><span class=p>)</span>
<span class=n>posterior_B</span> <span class=o>=</span> <span class=n>beta</span><span class=p>(</span><span class=n>alpha_prior</span> <span class=o>+</span> <span class=n>conversions_B</span><span class=p>,</span> <span class=n>beta_prior</span> <span class=o>+</span> <span class=n>failures_B</span><span class=p>)</span>

<span class=c1># Probability B &gt; A (Approximate via simulation)</span>
<span class=n>samples</span> <span class=o>=</span> <span class=mi>100000</span>
<span class=n>prob_b_better</span> <span class=o>=</span> <span class=p>(</span><span class=n>posterior_B</span><span class=o>.</span><span class=n>rvs</span><span class=p>(</span><span class=n>samples</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>posterior_A</span><span class=o>.</span><span class=n>rvs</span><span class=p>(</span><span class=n>samples</span><span class=p>))</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Probability B is better than A: </span><span class=si>{</span><span class=n>prob_b_better</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</code></pre></div> </details> <h3 id=3-bootstrap-confidence-interval>3. Bootstrap Confidence Interval</h3> <p><strong>Difficulty:</strong> üü¢ Easy | <strong>Tags:</strong> <code>Code Example</code> | <strong>Asked by:</strong> Code Pattern</p> <details class=success> <summary>View Code Example</summary> <p>Calculating CI for non-normal metrics (e.g., Revenue per User).</p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>

<span class=n>data_control</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>lognormal</span><span class=p>(</span><span class=n>mean</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>sigma</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=mi>1000</span><span class=p>)</span>
<span class=n>data_variant</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>lognormal</span><span class=p>(</span><span class=n>mean</span><span class=o>=</span><span class=mf>2.1</span><span class=p>,</span> <span class=n>sigma</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=mi>1000</span><span class=p>)</span>

<span class=k>def</span><span class=w> </span><span class=nf>bootstrap_mean_diff</span><span class=p>(</span><span class=n>data1</span><span class=p>,</span> <span class=n>data2</span><span class=p>,</span> <span class=n>n_bootstrap</span><span class=o>=</span><span class=mi>1000</span><span class=p>):</span>
    <span class=n>diffs</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_bootstrap</span><span class=p>):</span>
        <span class=c1># Sample with replacement</span>
        <span class=n>sample1</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>data1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>data1</span><span class=p>),</span> <span class=n>replace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
        <span class=n>sample2</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>data2</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>data2</span><span class=p>),</span> <span class=n>replace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
        <span class=n>diffs</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>sample2</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>-</span> <span class=n>sample1</span><span class=o>.</span><span class=n>mean</span><span class=p>())</span>
    <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>diffs</span><span class=p>,</span> <span class=p>[</span><span class=mf>2.5</span><span class=p>,</span> <span class=mf>97.5</span><span class=p>])</span>

<span class=n>ci</span> <span class=o>=</span> <span class=n>bootstrap_mean_diff</span><span class=p>(</span><span class=n>data_control</span><span class=p>,</span> <span class=n>data_variant</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;95% CI for difference: </span><span class=si>{</span><span class=n>ci</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</code></pre></div> </details> <hr> <h2 id=questions-asked-in-google-interview>Questions asked in Google interview</h2> <ul> <li>Explain the difference between Type I and Type II errors.</li> <li>How do you design an experiment to test a change in the Search Ranking algorithm?</li> <li>How to handle multiple metrics in an experiment? (Overall Evaluation Criterion).</li> <li>Explain the trade-off between sample size and experiment duration.</li> <li>Deriving the variance of the difference between two means.</li> <li>How to detect if your randomization algorithm is broken?</li> <li>Explain how you would test a feature with strong network effects.</li> <li>How to measure the long-term impact of a UI change?</li> <li>What metric would you use for a "User Happiness" experiment?</li> <li>Explain the concept of "Regression to the Mean" in the context of A/B testing.</li> </ul> <h2 id=questions-asked-in-meta-facebook-interview>Questions asked in Meta (Facebook) interview</h2> <ul> <li>How to measure network effects in a social network experiment?</li> <li>Explain Cluster-based randomization. Why use it?</li> <li>How to handle "Novelty Effect" when launching a new feature?</li> <li>Explain CUPED (Controlled-experiment Using Pre-Experiment Data).</li> <li>How to design an experiment for the News Feed ranking?</li> <li>What are the potential bounds of network interference?</li> <li>How to detect if an experiment has a Sample Ratio Mismatch (SRM)?</li> <li>Explain the difference between Average Treatment Effect (ATE) and Conditional ATE (CATE).</li> <li>How to optimize for long-term user retention?</li> <li>Design a test to measure the impact of ads on user engagement.</li> </ul> <h2 id=questions-asked-in-netflix-interview>Questions asked in Netflix interview</h2> <ul> <li>How to A/B test a new recommendation algorithm?</li> <li>Explain "Interleaving" in ranking experiments.</li> <li>How to choose between "member-level" vs "profile-level" assignment?</li> <li>How to estimate the causal impact of a TV show launch on subscriptions? (Quasi-experiment).</li> <li>Explain the concept of "Proxy Metrics".</li> <li>How to handle outlier users (e.g., bots, heavy users) in analysis?</li> <li>Explain "Switchback" testing infrastructure.</li> <li>How to balance "Exploration" vs "Exploitation" (Bandits)?</li> <li>Design a test for artwork personalization (thumbnails).</li> <li>How to measure the "Incremental Reach" of a marketing campaign?</li> </ul> <h2 id=questions-asked-in-uberlyft-interview-marketplace>Questions asked in Uber/Lyft interview (Marketplace)</h2> <ul> <li>How to test changes in a two-sided marketplace (Rider vs Driver)?</li> <li>Explain "Switchback" designs for marketplace experiments.</li> <li>How to handle "Spillover" or "Cannibalization" effects?</li> <li>Explain "Difference-in-Differences" method.</li> <li>How to measure the impact of surge pricing changes?</li> <li>Explain "Synthetic Control" methods for city-level tests.</li> <li>How to calculate "Marketplace Liquidity" metrics?</li> <li>Design an experiment to reduce driver cancellations.</li> <li>How to test a new matching algorithm?</li> <li>Explain Interference in a geo-spatial context.</li> </ul> <hr> <h2 id=additional-resources>Additional Resources</h2> <ul> <li><a href=https://www.microsoft.com/en-us/research/group/experimentation-platform-exp/ >Microsoft Experimentation Platform (Exp)</a> - Best technical papers.</li> <li><a href=https://netflixtechblog.com/tagged/experimentation>Netflix Tech Blog - Experimentation</a> - Real-world case studies.</li> <li><a href=https://matheusfacure.github.io/python-causality-handbook/ >Causal Inference for the Brave and True</a> - Python handbook.</li> <li><a href=https://www.amazon.com/Trustworthy-Online-Controlled-Experiments-Practical/dp/1108724264>Trustworthy Online Controlled Experiments (Book)</a> - The "Bible" of A/B testing (Kohavi).</li> <li><a href=https://eng.uber.com/category/articles/data/ >Uber Engineering - Data</a> - Marketplace testing concepts.</li> </ul> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2020 - <script>document.write(/\d{4}/.exec(Date())[0])</script> ‚Ä¢ <strong>Kuldeep Singh Sidhu</strong> ‚Ä¢ <u><a href=https://choosealicense.com/licenses/agpl-3.0/ target=‚Äù_blank‚Äù>License</a></u> ‚Ä¢ <u><a href=/privacy>Privacy Policy</a></u> ‚Ä¢ <u><a href=/contact>Contact</a></u> ‚Ä¢ </div> </div> <div class=md-social> <a href=https://github.com/singhsidhukuldeep/ target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path d="M8 0c4.42 0 8 3.58 8 8a8.01 8.01 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27s-1.36.09-2 .27c-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8"/></svg> </a> <a href=https://linkedin.com/in/singhsidhukuldeep target=_blank rel=noopener title=linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5m282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg> </a> <a href=https://twitter.com/kuldeep_s_s target=_blank rel=noopener title=twitter.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8l164.9-188.5L26.8 48h145.6l100.5 132.9zm-24.8 373.8h39.1L151.1 88h-42z"/></svg> </a> <a href=https://stackoverflow.com/u/7182350/ target=_blank rel=noopener title=stackoverflow.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 384 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M290.7 311 95 269.7 86.8 309l195.7 41zm51-87L188.2 95.7l-25.5 30.8 153.5 128.3zm-31.2 39.7L129.2 179l-16.7 36.5L293.7 300zM262 32l-32 24 119.3 160.3 32-24zm20.5 328h-200v39.7h200zm39.7 80H42.7V320h-40v160h359.5V320h-40z"/></svg> </a> <a href=https://huggingface.co/singhsidhukuldeep target=_blank rel=noopener title=huggingface.co class=md-social__link> <svg width=500 height=463 viewbox="0 0 500 463" fill=none xmlns=http://www.w3.org/2000/svg> <path fill=white d="M496.592 369.699C500.563 381.093 499.61 393.227 494.315 403.778C490.503 411.48 485.05 417.441 478.379 422.769C470.331 429.099 460.324 434.48 448.253 439.65C433.852 445.77 416.274 451.52 408.226 453.63C387.63 458.958 367.829 462.334 347.762 462.493C319.066 462.756 294.34 456.004 276.762 438.753C267.656 439.861 258.443 440.494 249.178 440.494C240.389 440.494 231.706 439.967 223.076 438.912C205.445 456.057 180.825 462.756 152.234 462.493C132.168 462.334 112.366 458.958 91.7177 453.63C83.7229 451.52 66.145 445.77 51.7439 439.65C39.6723 434.48 29.6656 429.099 21.6708 422.769C14.9467 417.441 9.49334 411.48 5.68127 403.778C0.439661 393.227 -0.566304 381.093 3.45755 369.699C-0.248631 360.994 -1.20165 351.024 1.71035 339.998C3.03399 334.987 5.20476 330.344 7.95792 326.229C7.37552 324.067 6.89901 321.851 6.58134 319.424C4.56941 304.97 9.59923 291.781 19.0765 281.547C23.7357 276.43 28.7655 272.895 34.0071 270.627C30.1421 254.273 28.1302 237.445 28.1302 220.247C28.1302 98.5969 127.085 0 249.178 0C291.111 0 330.343 11.6058 363.805 31.8633C369.84 35.5561 375.77 39.5126 381.436 43.7329C384.242 45.8431 387.048 48.006 389.748 50.2744C392.501 52.49 395.201 54.8112 397.796 57.1851C405.632 64.3069 412.991 71.9562 419.715 80.133C421.992 82.8235 424.163 85.6194 426.28 88.4681C430.569 94.1128 434.54 99.9685 438.193 106.035C443.752 115.109 448.623 124.604 452.859 134.469C455.665 141.064 458.101 147.816 460.271 154.727C463.501 165.067 465.99 175.723 467.684 186.696C468.213 190.336 468.69 194.028 469.06 197.721C469.802 205.107 470.225 212.598 470.225 220.247C470.225 237.234 468.213 253.904 464.454 269.994C470.278 272.262 475.784 275.955 480.92 281.547C490.397 291.781 495.427 305.022 493.415 319.477C493.098 321.851 492.621 324.067 492.039 326.229C494.792 330.344 496.963 334.987 498.286 339.998C501.198 351.024 500.245 360.994 496.592 369.699Z"/> <path fill=black d="M433.839 221.75C433.839 120.838 351.531 39.0323 250 39.0323C148.469 39.0323 66.1613 120.838 66.1613 221.75C66.1613 322.662 148.469 404.468 250 404.468C351.531 404.468 433.839 322.662 433.839 221.75ZM45 221.75C45 109.222 136.782 18 250 18C363.218 18 455 109.222 455 221.75C455 334.278 363.218 425.5 250 425.5C136.782 425.5 45 334.278 45 221.75Z"/> <path fill=white d="M250 405.5C352.173 405.5 435 323.232 435 221.75C435 120.268 352.173 38 250 38C147.827 38 65 120.268 65 221.75C65 323.232 147.827 405.5 250 405.5Z"/> <path fill=white d="M202.198 404.174C216.789 383.118 215.755 367.316 195.735 347.627C175.715 327.943 164.062 299.145 164.062 299.145C164.062 299.145 159.709 282.419 149.794 283.958C139.88 285.497 132.6 310.492 153.368 325.783C174.135 341.069 149.232 351.456 141.242 337.099C133.252 322.741 111.435 285.831 100.121 278.772C88.8117 271.713 80.8483 275.668 83.5151 290.218C86.182 304.769 133.48 340.036 128.878 347.668C124.276 355.296 108.058 338.7 108.058 338.7C108.058 338.7 57.3079 293.255 46.2587 305.097C35.2096 316.94 54.641 326.863 82.3328 343.359C110.03 359.85 112.177 364.206 108.248 370.446C104.314 376.685 43.1836 325.971 37.4417 347.47C31.705 368.969 99.8291 375.209 95.6247 390.051C91.4203 404.899 47.6372 361.958 38.6823 378.689C29.7221 395.425 100.465 415.088 101.038 415.234C123.889 421.067 181.924 433.426 202.198 404.174Z"/> <path fill=black d="M90.9935 255C82.4744 255 74.8603 258.477 69.551 264.784C66.2675 268.69 62.8367 274.986 62.5578 284.414C58.985 283.394 55.5489 282.824 52.3391 282.824C44.183 282.824 36.8163 285.93 31.6069 291.573C24.9137 298.815 21.9407 307.715 23.2351 316.62C23.8508 320.861 25.2768 324.663 27.4079 328.182C22.9142 331.795 19.6044 336.826 18.0047 342.876C16.7524 347.619 15.4685 357.497 22.1722 367.673C21.746 368.337 21.3461 369.027 20.9725 369.733C16.9418 377.336 16.684 385.927 20.2411 393.928C25.6346 406.054 39.0368 415.608 65.0625 425.863C81.2536 432.242 96.0661 436.321 96.1976 436.357C117.603 441.874 136.962 444.677 153.721 444.677C184.525 444.677 206.578 435.301 219.27 416.811C239.697 387.036 236.776 359.803 210.346 333.552C195.717 319.026 185.993 297.607 183.967 292.906C179.884 278.986 169.086 263.513 151.138 263.513H151.133C149.622 263.513 148.096 263.633 146.592 263.869C138.73 265.097 131.858 269.595 126.949 276.361C121.65 269.814 116.504 264.606 111.847 261.667C104.827 257.243 97.813 255 90.9935 255ZM90.9935 275.917C93.6771 275.917 96.9553 277.051 100.57 279.331C111.794 286.406 133.452 323.403 141.382 337.793C144.039 342.614 148.581 344.654 152.669 344.654C160.783 344.654 167.118 336.638 153.411 326.451C132.8 311.124 140.03 286.072 149.87 284.529C150.301 284.461 150.727 284.43 151.138 284.43C160.083 284.43 164.03 299.751 164.03 299.751C164.03 299.751 175.595 328.616 195.465 348.346C215.334 368.08 216.36 383.919 201.879 405.024C192.002 419.415 173.096 421.292 153.721 421.292C133.626 421.292 112.99 417.772 101.445 414.796C100.877 414.65 30.7019 396.255 39.5946 379.48C41.089 376.661 43.5516 375.532 46.6509 375.532C59.1744 375.532 81.9535 394.054 91.746 394.054C93.935 394.054 95.5662 392.371 96.1976 390.112C100.555 374.522 32.6646 369.738 38.3633 348.189C39.3683 344.377 42.094 342.829 45.9248 342.834C62.4737 342.834 99.6021 371.756 107.385 371.756C107.979 371.756 108.405 371.584 108.637 371.218C112.536 364.964 110.74 359.872 83.257 343.343C55.7738 326.808 36.1428 317.588 47.114 305.718C48.3768 304.347 50.1659 303.741 52.3391 303.741C69.0248 303.746 108.447 339.398 108.447 339.398C108.447 339.398 119.087 350.395 125.523 350.395C127.001 350.395 128.259 349.815 129.111 348.382C133.673 340.737 86.7366 305.388 84.0898 290.804C82.2955 280.921 85.3474 275.917 90.9935 275.917Z"/> <path fill=white d="M296.9 404.174C282.31 383.118 283.343 367.316 303.363 347.627C323.383 327.943 335.037 299.145 335.037 299.145C335.037 299.145 339.39 282.419 349.304 283.958C359.219 285.497 366.498 310.492 345.731 325.783C324.963 341.069 349.866 351.456 357.856 337.099C365.846 322.741 387.663 285.831 398.978 278.772C410.287 271.713 418.25 275.668 415.583 290.218C412.916 304.769 365.618 340.036 370.22 347.668C374.822 355.296 391.041 338.7 391.041 338.7C391.041 338.7 441.791 293.255 452.84 305.097C463.889 316.94 444.457 326.863 416.766 343.359C389.068 359.85 386.921 364.206 390.85 370.446C394.784 376.685 455.915 325.971 461.657 347.47C467.393 368.969 399.269 375.209 403.474 390.051C407.678 404.899 451.461 361.958 460.416 378.689C469.376 395.425 398.633 415.088 398.06 415.234C375.209 421.067 317.175 433.426 296.9 404.174Z"/> <path fill=black d="M408.105 255C416.624 255 424.238 258.477 429.547 264.784C432.831 268.69 436.262 274.986 436.541 284.414C440.113 283.394 443.549 282.824 446.759 282.824C454.915 282.824 462.282 285.93 467.491 291.573C474.185 298.815 477.158 307.715 475.863 316.62C475.248 320.861 473.822 324.663 471.69 328.182C476.184 331.795 479.494 336.826 481.094 342.876C482.346 347.619 483.63 357.497 476.926 367.673C477.352 368.337 477.752 369.027 478.126 369.733C482.157 377.336 482.414 385.927 478.857 393.928C473.464 406.054 460.062 415.608 434.036 425.863C417.845 432.242 403.032 436.321 402.901 436.357C381.495 441.874 362.136 444.677 345.377 444.677C314.573 444.677 292.52 435.301 279.829 416.811C259.402 387.036 262.322 359.803 288.753 333.552C303.381 319.026 313.105 297.607 315.131 292.906C319.214 278.986 330.012 263.513 347.961 263.513H347.966C349.476 263.513 351.002 263.633 352.507 263.869C360.368 265.097 367.24 269.595 372.15 276.361C377.449 269.814 382.595 264.606 387.252 261.667C394.271 257.243 401.285 255 408.105 255ZM408.105 275.917C405.421 275.917 402.143 277.051 398.528 279.331C387.304 286.406 365.646 323.403 357.716 337.793C355.059 342.614 350.518 344.654 346.429 344.654C338.315 344.654 331.98 336.638 345.687 326.451C366.299 311.124 359.069 286.072 349.229 284.529C348.797 284.461 348.371 284.43 347.961 284.43C339.015 284.43 335.069 299.751 335.069 299.751C335.069 299.751 323.503 328.616 303.634 348.346C283.764 368.08 282.738 383.919 297.219 405.024C307.096 419.415 326.002 421.292 345.377 421.292C365.472 421.292 386.108 417.772 397.653 414.796C398.221 414.65 468.397 396.255 459.504 379.48C458.009 376.661 455.547 375.532 452.447 375.532C439.924 375.532 417.145 394.054 407.352 394.054C405.163 394.054 403.532 392.371 402.901 390.112C398.543 374.522 466.434 369.738 460.735 348.189C459.73 344.377 457.004 342.829 453.174 342.834C436.625 342.834 399.496 371.756 391.714 371.756C391.119 371.756 390.693 371.584 390.461 371.218C386.562 364.964 388.358 359.872 415.841 343.343C443.325 326.808 462.956 317.588 451.984 305.718C450.722 304.347 448.932 303.741 446.759 303.741C430.074 303.746 390.651 339.398 390.651 339.398C390.651 339.398 380.011 350.395 373.576 350.395C372.097 350.395 370.84 349.815 369.987 348.382C365.425 340.737 412.362 305.388 415.009 290.804C416.803 280.921 413.751 275.917 408.105 275.917Z"/> <path fill=#0E1116 d="M319.277 228.901C319.277 205.236 288.585 241.304 250.637 241.465C212.692 241.306 182 205.238 182 228.901C182 244.591 189.507 270.109 209.669 285.591C213.681 271.787 235.726 260.729 238.877 262.317C243.364 264.578 243.112 270.844 250.637 276.365C258.163 270.844 257.911 264.58 262.398 262.317C265.551 260.729 287.594 271.787 291.605 285.591C311.767 270.109 319.275 244.591 319.275 228.903L319.277 228.901Z"/> <path fill=#FF323D d="M262.4 262.315C257.913 264.576 258.165 270.842 250.639 276.363C243.114 270.842 243.366 264.578 238.879 262.315C235.726 260.727 213.683 271.785 209.672 285.589C219.866 293.417 233.297 298.678 250.627 298.806C250.631 298.806 250.635 298.806 250.641 298.806C250.646 298.806 250.65 298.806 250.656 298.806C267.986 298.68 281.417 293.417 291.611 285.589C287.6 271.785 265.555 260.727 262.404 262.315H262.4Z"/> <path fill=black d="M373 196C382.389 196 390 188.389 390 179C390 169.611 382.389 162 373 162C363.611 162 356 169.611 356 179C356 188.389 363.611 196 373 196Z"/> <path fill=black d="M128 196C137.389 196 145 188.389 145 179C145 169.611 137.389 162 128 162C118.611 162 111 169.611 111 179C111 188.389 118.611 196 128 196Z"/> <path fill=#0E1116 d="M313.06 171.596C319.796 173.968 322.476 187.779 329.281 184.171C342.167 177.337 347.06 161.377 340.208 148.524C333.356 135.671 317.354 130.792 304.467 137.626C291.58 144.46 286.688 160.419 293.54 173.272C296.774 179.339 307.039 169.475 313.06 171.596Z"/> <path fill=#0E1116 d="M188.554 171.596C181.818 173.968 179.138 187.779 172.334 184.171C159.447 177.337 154.555 161.377 161.407 148.524C168.259 135.671 184.26 130.792 197.147 137.626C210.034 144.46 214.926 160.419 208.074 173.272C204.84 179.339 194.575 169.475 188.554 171.596Z"/> </svg> </a> <a href=http://kuldeepsinghsidhu.com target=_blank rel=noopener title=kuldeepsinghsidhu.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0M5.78 8.75a9.64 9.64 0 0 0 1.363 4.177q.383.64.857 1.215c.245-.296.551-.705.857-1.215A9.64 9.64 0 0 0 10.22 8.75Zm4.44-1.5a9.64 9.64 0 0 0-1.363-4.177c-.307-.51-.612-.919-.857-1.215a10 10 0 0 0-.857 1.215A9.64 9.64 0 0 0 5.78 7.25Zm-5.944 1.5H1.543a6.51 6.51 0 0 0 4.666 5.5q-.184-.271-.352-.552c-.715-1.192-1.437-2.874-1.581-4.948m-2.733-1.5h2.733c.144-2.074.866-3.756 1.58-4.948q.18-.295.353-.552a6.51 6.51 0 0 0-4.666 5.5m10.181 1.5c-.144 2.074-.866 3.756-1.58 4.948q-.18.296-.353.552a6.51 6.51 0 0 0 4.666-5.5Zm2.733-1.5a6.51 6.51 0 0 0-4.666-5.5q.184.272.353.552c.714 1.192 1.436 2.874 1.58 4.948Z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <script id=__config type=application/json>{"base": "../..", "features": ["content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "search.highlight", "search.share", "search.suggest", "content.tooltips", "navigation.instant.progress", "navigation.path", "navigation.top", "toc.follow"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.60a45f97.min.js></script> <script src=../../javascripts/mathjax.js></script> <script src=https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js></script> <script src=../../javascripts/xfile.js></script> <script id=init-glightbox>const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body> </html>